<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1691571664234" as="style"/><link rel="stylesheet" href="styles.css?v=1691571664234"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://kenschutte.com/python-swap-ints/">Swap_8_and_9: A simple import can modify the Python interpreter</a> <span class="domain">(<a href="https://kenschutte.com">kenschutte.com</a>)</span></div><div class="subtext"><span>ks2048</span> | <span>31 comments</span></div><br/><div><div id="37058717" class="c"><input type="checkbox" id="c-37058717" checked=""/><div class="controls bullet"><span class="by">skulk</span><span>|</span><a href="#37058849">next</a><span>|</span><label class="collapse" for="c-37058717">[-]</label><label class="expand" for="c-37058717">[8 more]</label></div><br/><div class="children"><div class="content">Related: one of my favorite StackExchange questions: &quot;Write a program that makes 2+2=5&quot;<p><a href="https:&#x2F;&#x2F;codegolf.stackexchange.com&#x2F;questions&#x2F;28786&#x2F;write-a-program-that-makes-2-2-5" rel="nofollow noreferrer">https:&#x2F;&#x2F;codegolf.stackexchange.com&#x2F;questions&#x2F;28786&#x2F;write-a-p...</a><p>Really shows you the skeletons hiding in some languages. My favorite is Haskell, which will happily do what you tell it to.</div><br/><div id="37058856" class="c"><input type="checkbox" id="c-37058856" checked=""/><div class="controls bullet"><span class="by">fbdab103</span><span>|</span><a href="#37058717">parent</a><span>|</span><a href="#37059756">next</a><span>|</span><label class="collapse" for="c-37058856">[-]</label><label class="expand" for="c-37058856">[1 more]</label></div><br/><div class="children"><div class="content">I legit burst out laughing at the C solution (<a href="https:&#x2F;&#x2F;codegolf.stackexchange.com&#x2F;a&#x2F;28889" rel="nofollow noreferrer">https:&#x2F;&#x2F;codegolf.stackexchange.com&#x2F;a&#x2F;28889</a>). Definitely got me.</div><br/></div></div><div id="37059756" class="c"><input type="checkbox" id="c-37059756" checked=""/><div class="controls bullet"><span class="by">lloeki</span><span>|</span><a href="#37058717">parent</a><span>|</span><a href="#37058856">prev</a><span>|</span><a href="#37059490">next</a><span>|</span><label class="collapse" for="c-37059756">[-]</label><label class="expand" for="c-37059756">[1 more]</label></div><br/><div class="children"><div class="content">The Ruby versions are a bit underwhelming, this is not 2+2=5 but much more underhanded:<p><a href="https:&#x2F;&#x2F;youtube.com&#x2F;watch?v=F3feRCr6S64">https:&#x2F;&#x2F;youtube.com&#x2F;watch?v=F3feRCr6S64</a><p>(recommend watching it by doing the four &quot;tests&quot; before going to the reveal)</div><br/></div></div><div id="37059490" class="c"><input type="checkbox" id="c-37059490" checked=""/><div class="controls bullet"><span class="by">codeflo</span><span>|</span><a href="#37058717">parent</a><span>|</span><a href="#37059756">prev</a><span>|</span><a href="#37059928">next</a><span>|</span><label class="collapse" for="c-37059490">[-]</label><label class="expand" for="c-37059490">[1 more]</label></div><br/><div class="children"><div class="content">The Haskell one is not that spectacular if you understand that operators are just functions in that language:<p><pre><code>    λ&gt; let 2+2=5 in 2+2
    5
</code></pre>
This simply defines a new local function that happens to be called &quot;+&quot;. It&#x27;s no different than something like this in JavaScript:<p><pre><code>   let Math = { sqrt: (x) =&gt; 42 };
   console.log(Math.sqrt(16));</code></pre></div><br/></div></div><div id="37059928" class="c"><input type="checkbox" id="c-37059928" checked=""/><div class="controls bullet"><span class="by">jacketing</span><span>|</span><a href="#37058717">parent</a><span>|</span><a href="#37059490">prev</a><span>|</span><a href="#37060067">next</a><span>|</span><label class="collapse" for="c-37059928">[-]</label><label class="expand" for="c-37059928">[2 more]</label></div><br/><div class="children"><div class="content">Forth is probably cheating considering it has no restrictions when naming symbols.<p><pre><code>  : 4 5 ;
  2 2 + .</code></pre></div><br/><div id="37060125" class="c"><input type="checkbox" id="c-37060125" checked=""/><div class="controls bullet"><span class="by">jstanley</span><span>|</span><a href="#37058717">root</a><span>|</span><a href="#37059928">parent</a><span>|</span><a href="#37060067">next</a><span>|</span><label class="collapse" for="c-37060125">[-]</label><label class="expand" for="c-37060125">[1 more]</label></div><br/><div class="children"><div class="content">Did you try this? This won&#x27;t work.<p>What you did will make <i>inputting</i> a 4 yield a 5, but it won&#x27;t change the behaviour of outputting a 4. (And it will only turn an input 4 into a 5 if your interpreter checks for words before checking for numbers which is not universally the case).</div><br/></div></div></div></div><div id="37060067" class="c"><input type="checkbox" id="c-37060067" checked=""/><div class="controls bullet"><span class="by">m6g6a</span><span>|</span><a href="#37058717">parent</a><span>|</span><a href="#37059928">prev</a><span>|</span><a href="#37058790">next</a><span>|</span><label class="collapse" for="c-37060067">[-]</label><label class="expand" for="c-37060067">[1 more]</label></div><br/><div class="children"><div class="content">this is how javascript works</div><br/></div></div></div></div><div id="37058849" class="c"><input type="checkbox" id="c-37058849" checked=""/><div class="controls bullet"><span class="by">skitter</span><span>|</span><a href="#37058717">prev</a><span>|</span><a href="#37059570">next</a><span>|</span><label class="collapse" for="c-37058849">[-]</label><label class="expand" for="c-37058849">[2 more]</label></div><br/><div class="children"><div class="content">You don&#x27;t even need C:<p><pre><code>    ctypes.c_int.from_address(id(8)+24).value = 9</code></pre></div><br/><div id="37059333" class="c"><input type="checkbox" id="c-37059333" checked=""/><div class="controls bullet"><span class="by">jwilk</span><span>|</span><a href="#37058849">parent</a><span>|</span><a href="#37059570">next</a><span>|</span><label class="collapse" for="c-37059333">[-]</label><label class="expand" for="c-37059333">[1 more]</label></div><br/><div class="children"><div class="content">That works only on 64-bit systems. You need something like this instead of 24:<p><pre><code>    ctypes.sizeof(ctypes.c_long) * 3</code></pre></div><br/></div></div></div></div><div id="37059570" class="c"><input type="checkbox" id="c-37059570" checked=""/><div class="controls bullet"><span class="by">albertzeyer</span><span>|</span><a href="#37058849">prev</a><span>|</span><a href="#37058687">next</a><span>|</span><label class="collapse" for="c-37059570">[-]</label><label class="expand" for="c-37059570">[1 more]</label></div><br/><div class="children"><div class="content">Is there really anything unexpected here? I would have thought that it is obvious that when importing some library, that library will execute code already at import time. And that you can do strange things, esp when messing with the underlying C structures, should also be clear.<p>Even in C itself, you can do the same in shared libraries. It&#x27;s a very important functionality that the library can run some init code when it is being loaded. And you can do all kinds of strange things, modifying some random memory.</div><br/></div></div><div id="37058687" class="c"><input type="checkbox" id="c-37058687" checked=""/><div class="controls bullet"><span class="by">rtpg</span><span>|</span><a href="#37059570">prev</a><span>|</span><a href="#37058743">next</a><span>|</span><label class="collapse" for="c-37058687">[-]</label><label class="expand" for="c-37058687">[1 more]</label></div><br/><div class="children"><div class="content">The CPython source is really a bit of a joy to look through. The lowest level stuff is really tough, but generally it&#x27;s all relatively straightforward.<p>Though with the specializing compiler work, some stuff is... less obvious. But I still generally find it straightforward when I want to know some detail about how the language works.</div><br/></div></div><div id="37058743" class="c"><input type="checkbox" id="c-37058743" checked=""/><div class="controls bullet"><span class="by">ignite</span><span>|</span><a href="#37058687">prev</a><span>|</span><a href="#37059489">next</a><span>|</span><label class="collapse" for="c-37058743">[-]</label><label class="expand" for="c-37058743">[1 more]</label></div><br/><div class="children"><div class="content">Funny how things come around again and again.<p>Fortran had basically the same bug, fifty years ago. <a href="https:&#x2F;&#x2F;softwareengineering.stackexchange.com&#x2F;a&#x2F;254921" rel="nofollow noreferrer">https:&#x2F;&#x2F;softwareengineering.stackexchange.com&#x2F;a&#x2F;254921</a></div><br/></div></div><div id="37059489" class="c"><input type="checkbox" id="c-37059489" checked=""/><div class="controls bullet"><span class="by">noelwelsh</span><span>|</span><a href="#37058743">prev</a><span>|</span><a href="#37059163">next</a><span>|</span><label class="collapse" for="c-37059489">[-]</label><label class="expand" for="c-37059489">[3 more]</label></div><br/><div class="children"><div class="content">And this is why optimizing Python code is really hard. When at runtime you can change almost any aspect of the language it&#x27;s virtually impossible to give a semantics for Python code beyond &quot;run it and find out&quot;.</div><br/><div id="37059889" class="c"><input type="checkbox" id="c-37059889" checked=""/><div class="controls bullet"><span class="by">stuaxo</span><span>|</span><a href="#37059489">parent</a><span>|</span><a href="#37059965">next</a><span>|</span><label class="collapse" for="c-37059889">[-]</label><label class="expand" for="c-37059889">[1 more]</label></div><br/><div class="children"><div class="content">Ok, though most of the time this isn&#x27;t the kind of thing that changes.</div><br/></div></div><div id="37059965" class="c"><input type="checkbox" id="c-37059965" checked=""/><div class="controls bullet"><span class="by">eesmith</span><span>|</span><a href="#37059489">parent</a><span>|</span><a href="#37059889">prev</a><span>|</span><a href="#37059163">next</a><span>|</span><label class="collapse" for="c-37059965">[-]</label><label class="expand" for="c-37059965">[1 more]</label></div><br/><div class="children"><div class="content">While optimizing Python code is indeed really hard, this is not a good example of why.<p>It uses implementation-specific details which are outside of the scope of anything to do with Python semantics.<p>It&#x27;s roughly equivalent to:<p><pre><code>  #include &lt;stdio.h&gt;

  int nine = 9;

  int main(void) {
    printf(&quot;nine = %d\n&quot;, nine);
    return 0;
  }

  &#x2F;* in a library *&#x2F;
  __attribute__((constructor))
  static void sneaky(void) {
    int *n = (int *) &amp;nine;
    *n = 8;
  }
</code></pre>
Your hyperbole simply isn&#x27;t true, as demonstrated by the many static code analysis tools for Python. They can&#x27;t handle all cases, certainly, but they demonstrate it&#x27;s mostly possible to give semantics for Python code without running it.</div><br/></div></div></div></div><div id="37059163" class="c"><input type="checkbox" id="c-37059163" checked=""/><div class="controls bullet"><span class="by">maxnoe</span><span>|</span><a href="#37059489">prev</a><span>|</span><a href="#37058719">next</a><span>|</span><label class="collapse" for="c-37059163">[-]</label><label class="expand" for="c-37059163">[1 more]</label></div><br/><div class="children"><div class="content">Side note: distutils is deprecated and will be removed in 3.12.<p>In this case, setuptools is a drop in replacement.</div><br/></div></div><div id="37058719" class="c"><input type="checkbox" id="c-37058719" checked=""/><div class="controls bullet"><span class="by">kstrauser</span><span>|</span><a href="#37059163">prev</a><span>|</span><a href="#37059461">next</a><span>|</span><label class="collapse" for="c-37058719">[-]</label><label class="expand" for="c-37058719">[4 more]</label></div><br/><div class="children"><div class="content">That’s clever, but illustrates something not widely appreciated:<p>When you import a module, Python executes it. For instance, `def` isn’t syntax that says “hey compiler, this is a function!” It’s a statement that’s executed at runtime to define a function. You can put any code you want at the top level of a module and it’ll get executed when the Python interpreter gets to that line.</div><br/><div id="37059057" class="c"><input type="checkbox" id="c-37059057" checked=""/><div class="controls bullet"><span class="by">sigg3</span><span>|</span><a href="#37058719">parent</a><span>|</span><a href="#37059461">next</a><span>|</span><label class="collapse" for="c-37059057">[-]</label><label class="expand" for="c-37059057">[3 more]</label></div><br/><div class="children"><div class="content">IMO Python imports behave like the bash source command.<p>This is why people use the `if __name__ == &quot;__main__&quot;` so the majority of people will address it in all their scripts even if they don&#x27;t know the reason why.<p>It&#x27;s a feature not a bug IMO. You can use importing a .py file as a singleton hack. You can also use `refresh` to re-load a module, to clear it of any runtime overrides.</div><br/><div id="37059273" class="c"><input type="checkbox" id="c-37059273" checked=""/><div class="controls bullet"><span class="by">lordmauve</span><span>|</span><a href="#37058719">root</a><span>|</span><a href="#37059057">parent</a><span>|</span><a href="#37059205">next</a><span>|</span><label class="collapse" for="c-37059273">[-]</label><label class="expand" for="c-37059273">[1 more]</label></div><br/><div class="children"><div class="content">Python imports are much more principled than sourcing bash though. They are executed in a new namespace, and subsequent imports reference that namespace directly instead of re-evaluating the code.<p>C extensions don&#x27;t significantly change matters because the module is still constructed by procedural C code.</div><br/></div></div><div id="37059205" class="c"><input type="checkbox" id="c-37059205" checked=""/><div class="controls bullet"><span class="by">filmor</span><span>|</span><a href="#37058719">root</a><span>|</span><a href="#37059057">parent</a><span>|</span><a href="#37059273">prev</a><span>|</span><a href="#37059461">next</a><span>|</span><label class="collapse" for="c-37059205">[-]</label><label class="expand" for="c-37059205">[1 more]</label></div><br/><div class="children"><div class="content">Python inports collect the locals in the &quot;module script&quot; and store them in a module object, which is then made available to the module that ran `import`. That module object is cached, so reimporting the module another time will not run the code again.<p>`source` is much more primitive.</div><br/></div></div></div></div></div></div><div id="37058948" class="c"><input type="checkbox" id="c-37058948" checked=""/><div class="controls bullet"><span class="by">dado3212</span><span>|</span><a href="#37059449">prev</a><span>|</span><a href="#37058623">next</a><span>|</span><label class="collapse" for="c-37058948">[-]</label><label class="expand" for="c-37058948">[1 more]</label></div><br/><div class="children"><div class="content">This reminds me of one of my internet white whales. It&#x27;s very similar to this, but it goes through a ton of different ways that one `import malevolent` or something alone those lines and completely change how normal Python works. Mentioning it here in case anyone remembers it!</div><br/></div></div><div id="37058623" class="c"><input type="checkbox" id="c-37058623" checked=""/><div class="controls bullet"><span class="by">RandallBrown</span><span>|</span><a href="#37058948">prev</a><span>|</span><a href="#37059131">next</a><span>|</span><label class="collapse" for="c-37058623">[-]</label><label class="expand" for="c-37058623">[3 more]</label></div><br/><div class="children"><div class="content">Would this affect other Python interpreters or just CPython?</div><br/><div id="37058686" class="c"><input type="checkbox" id="c-37058686" checked=""/><div class="controls bullet"><span class="by">knome</span><span>|</span><a href="#37058623">parent</a><span>|</span><a href="#37058679">next</a><span>|</span><label class="collapse" for="c-37058686">[-]</label><label class="expand" for="c-37058686">[1 more]</label></div><br/><div class="children"><div class="content">cpython caches the small integers, and this is just grabbing a reference to 8 and 9 and then altering the value of the integer held in each cached reference.<p>The author could have skipped the c library and used the ctypes module to munge the bits.<p>There&#x27;s no guarantee that any other version of python would use the same caching, same structure layout and certain not be able to link with the same c library.<p>So, yeah, it&#x27;s specific.<p>A fun little adventure into how things work for the author, though.</div><br/></div></div><div id="37058679" class="c"><input type="checkbox" id="c-37058679" checked=""/><div class="controls bullet"><span class="by">laurencerowe</span><span>|</span><a href="#37058623">parent</a><span>|</span><a href="#37058686">prev</a><span>|</span><a href="#37059131">next</a><span>|</span><label class="collapse" for="c-37058679">[-]</label><label class="expand" for="c-37058679">[1 more]</label></div><br/><div class="children"><div class="content">This seems to be a C extension so will likely only work with CPython, but since Python is so dynamic you can do all sorts of weird things just using plain Python.</div><br/></div></div></div></div><div id="37059131" class="c"><input type="checkbox" id="c-37059131" checked=""/><div class="controls bullet"><span class="by">rep_movsd</span><span>|</span><a href="#37058623">prev</a><span>|</span><a href="#37058842">next</a><span>|</span><label class="collapse" for="c-37059131">[-]</label><label class="expand" for="c-37059131">[2 more]</label></div><br/><div class="children"><div class="content">Why is that array not const in the Cpython code?</div><br/><div id="37060220" class="c"><input type="checkbox" id="c-37060220" checked=""/><div class="controls bullet"><span class="by">aflag</span><span>|</span><a href="#37059131">parent</a><span>|</span><a href="#37058842">next</a><span>|</span><label class="collapse" for="c-37060220">[-]</label><label class="expand" for="c-37060220">[1 more]</label></div><br/><div class="children"><div class="content">That wouldn&#x27;t make a difference in this case, would it? I suppose it would mean that the code would be UB, but in practice it&#x27;d just work the same.</div><br/></div></div></div></div></div></div></div></div></div></body></html>