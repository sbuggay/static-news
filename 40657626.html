<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718442057583" as="style"/><link rel="stylesheet" href="styles.css?v=1718442057583"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://smallcultfollowing.com/babysteps/blog/2024/06/02/the-borrow-checker-within/">The borrow checker within</a> <span class="domain">(<a href="https://smallcultfollowing.com">smallcultfollowing.com</a>)</span></div><div class="subtext"><span>yurivish</span> | <span>10 comments</span></div><br/><div><div id="40685583" class="c"><input type="checkbox" id="c-40685583" checked=""/><div class="controls bullet"><span class="by">Animats</span><span>|</span><a href="#40688016">next</a><span>|</span><label class="collapse" for="c-40685583">[-]</label><label class="expand" for="c-40685583">[3 more]</label></div><br/><div class="children"><div class="content">Good to see this.<p><i>&quot;There is another theme running through here: moving the borrow checker analysis out from the compiler’s mind and into types that can be expressed. Right now, all types always represent fully initialized, unborrowed values. There is no way to express a type that captures the state of being in the midst of iterating over something or having moved one or two fields but not all of them. These changes address that gap.&quot;</i><p>I have some misgivings about trying to do everything with types. That leads to having to perform complex, hard to understand operations on types, as you add and remove restrictions. Keeping borrowing orthogonal from types may be clearer. Not sure about this, though.<p>I&#x27;d like to see back references addressed, so structs can have references to their owners.
General concept: when possible, do statically what Rc, Weak, and .borrow() can do for backlinks at run time. Such static analysis seems possible for non-mutable references.
Mutable is going to be tough, though. It&#x27;s a lot like compile-time single-lock deadlock detection, where you try to check that the same lock is never locked twice in nested contexts.</div><br/><div id="40686662" class="c"><input type="checkbox" id="c-40686662" checked=""/><div class="controls bullet"><span class="by">gpm</span><span>|</span><a href="#40685583">parent</a><span>|</span><a href="#40688016">next</a><span>|</span><label class="collapse" for="c-40686662">[-]</label><label class="expand" for="c-40686662">[2 more]</label></div><br/><div class="children"><div class="content">Immutable back references seem limiting... because how are you inserting things if you have a reference saying the thing you are inserting it into can&#x27;t mutate.<p>If you&#x27;re willing to use locks or something for interior immutability though... I think it should already be possible. It works in a toy example: <a href="https:&#x2F;&#x2F;play.rust-lang.org&#x2F;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=faed8b1f5298ccf0f9a9a8f86bbbc6e1" rel="nofollow">https:&#x2F;&#x2F;play.rust-lang.org&#x2F;?version=stable&amp;mode=debug&amp;editio...</a></div><br/><div id="40686961" class="c"><input type="checkbox" id="c-40686961" checked=""/><div class="controls bullet"><span class="by">Animats</span><span>|</span><a href="#40685583">root</a><span>|</span><a href="#40686662">parent</a><span>|</span><a href="#40688016">next</a><span>|</span><label class="collapse" for="c-40686961">[-]</label><label class="expand" for="c-40686961">[1 more]</label></div><br/><div class="children"><div class="content">Right. You can also do that with Rc and borrow.<p>When nothing in the call tree is using the parent link, it should be OK to add children. That&#x27;s potentially checkable at compile time.</div><br/></div></div></div></div></div></div><div id="40688016" class="c"><input type="checkbox" id="c-40688016" checked=""/><div class="controls bullet"><span class="by">superb_dev</span><span>|</span><a href="#40685583">prev</a><span>|</span><a href="#40686110">next</a><span>|</span><label class="collapse" for="c-40688016">[-]</label><label class="expand" for="c-40688016">[2 more]</label></div><br/><div class="children"><div class="content">I wanted to share a technique I saw recently related to a post linked within this post: <a href="https:&#x2F;&#x2F;smallcultfollowing.com&#x2F;babysteps&#x2F;blog&#x2F;2015&#x2F;04&#x2F;06&#x2F;modeling-graphs-in-rust-using-vector-indices&#x2F;" rel="nofollow">https:&#x2F;&#x2F;smallcultfollowing.com&#x2F;babysteps&#x2F;blog&#x2F;2015&#x2F;04&#x2F;06&#x2F;mod...</a><p>&gt; The primary disadvantage comes about if you try to remove things from the graph. The problem then is that you must make a choice: either you reuse the node&#x2F;edge indices, perhaps by keeping a free list, or else you leave a placeholder.<p>There’s another option, called generational indices! I discovered this from the “generational_arena” crate: <a href="https:&#x2F;&#x2F;docs.rs&#x2F;generational-arena&#x2F;latest&#x2F;generational_arena&#x2F;" rel="nofollow">https:&#x2F;&#x2F;docs.rs&#x2F;generational-arena&#x2F;latest&#x2F;generational_arena...</a></div><br/><div id="40688362" class="c"><input type="checkbox" id="c-40688362" checked=""/><div class="controls bullet"><span class="by">alexisread</span><span>|</span><a href="#40688016">parent</a><span>|</span><a href="#40686110">next</a><span>|</span><label class="collapse" for="c-40688362">[-]</label><label class="expand" for="c-40688362">[1 more]</label></div><br/><div class="children"><div class="content">This looks the same as in Vale? I like this technique, and Vale tries to go further with index elision to remove the memory and checking overhead.
<a href="https:&#x2F;&#x2F;verdagon.dev&#x2F;grimoire&#x2F;grimoire" rel="nofollow">https:&#x2F;&#x2F;verdagon.dev&#x2F;grimoire&#x2F;grimoire</a></div><br/></div></div></div></div><div id="40686110" class="c"><input type="checkbox" id="c-40686110" checked=""/><div class="controls bullet"><span class="by">tmpfs</span><span>|</span><a href="#40688016">prev</a><span>|</span><a href="#40685504">next</a><span>|</span><label class="collapse" for="c-40686110">[-]</label><label class="expand" for="c-40686110">[1 more]</label></div><br/><div class="children"><div class="content">These are some really good suggestions.<p>I think a &quot;syntax for lifetimes on places&quot; (2) is really neat and would make lifetimes much easier to reason about, by removing the indirection and being explicit about where the borrow is from in the declaration makes the intention much clearer.<p>But my personal favorite is the point about &quot;internal references&quot; as I struggled with this a couple of times. I think this would be an excellent improvement. In the end I used ouroborous [1] to achieve this but having it built in to the language would be excellent.<p>[1] <a href="https:&#x2F;&#x2F;docs.rs&#x2F;ouroboros&#x2F;latest&#x2F;ouroboros&#x2F;" rel="nofollow">https:&#x2F;&#x2F;docs.rs&#x2F;ouroboros&#x2F;latest&#x2F;ouroboros&#x2F;</a></div><br/></div></div><div id="40685504" class="c"><input type="checkbox" id="c-40685504" checked=""/><div class="controls bullet"><span class="by">yuvadam</span><span>|</span><a href="#40686110">prev</a><span>|</span><a href="#40685747">next</a><span>|</span><label class="collapse" for="c-40685504">[-]</label><label class="expand" for="c-40685504">[1 more]</label></div><br/><div class="children"><div class="content">I really enjoyed this post, resonates with many small experiences I had learning the various patterns that do and don&#x27;t work in Rust.<p>Also blows my mind how crazy complex these language design topics are.</div><br/></div></div><div id="40685747" class="c"><input type="checkbox" id="c-40685747" checked=""/><div class="controls bullet"><span class="by">Georgelemental</span><span>|</span><a href="#40685504">prev</a><span>|</span><a href="#40687480">next</a><span>|</span><label class="collapse" for="c-40685747">[-]</label><label class="expand" for="c-40685747">[1 more]</label></div><br/><div class="children"><div class="content">Previously: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40553643">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40553643</a></div><br/></div></div><div id="40687480" class="c"><input type="checkbox" id="c-40687480" checked=""/><div class="controls bullet"><span class="by">aabhay</span><span>|</span><a href="#40685747">prev</a><span>|</span><label class="collapse" for="c-40687480">[-]</label><label class="expand" for="c-40687480">[1 more]</label></div><br/><div class="children"><div class="content">It would be cool to annotate the lifetime using this syntax instead:<p>-&gt; &amp;map’s mut V<p>The apostrophe here matches the syntax of lifetimes roughly and to me makes it EXTREMELY clear whats going on.</div><br/></div></div></div></div></div></div></div></body></html>