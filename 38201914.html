<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1699520478082" as="style"/><link rel="stylesheet" href="styles.css?v=1699520478082"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://ratfactor.com/cards/asm-data-in-text">i386 Assembly Language trick for storing data in .text</a> <span class="domain">(<a href="https://ratfactor.com">ratfactor.com</a>)</span></div><div class="subtext"><span>ingve</span> | <span>14 comments</span></div><br/><div><div id="38202097" class="c"><input type="checkbox" id="c-38202097" checked=""/><div class="controls bullet"><span class="by">majke</span><span>|</span><a href="#38202228">next</a><span>|</span><label class="collapse" for="c-38202097">[-]</label><label class="expand" for="c-38202097">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, in i386 syntax there is no way to address EIP directly. poping EIP from call is a common trick.<p>In newer processors there exists a cache for return addresses Return Stack Buffer (RSB).<p>But there is a penalty for doing call and never doing ret.<p>From Intel&#x27;s Optimization Reference Manual:[2]<p>&quot;The return address stack mechanism augments the static and dynamic predictors to optimize specifically for calls and returns. It holds 16 entries, which is large enough to cover the call depth of most programs. If there is a chain of more than 16 nested calls and more than 16 returns in rapid succession, performance may degrade.<p>[...] To enable the use of the return stack mechanism, calls and returns must be matched in pairs. If this is done, the likelihood of exceeding the stack depth in a manner that will impact performance is very low.<p>This trick is also what I understand retpolines are about:<p>Citing kernel doc<p>The kernel can protect itself against consuming poisoned branch target buffer entries by using return trampolines (also known as &quot;retpoline&quot;) for all indirect branches. Return trampolines trap speculative execution paths to prevent jumping to gadget code during speculative execution. x86 CPUs with Enhanced Indirect Branch Restricted Speculation (Enhanced IBRS) available in hardware should use the feature to mitigate Spectre variant 2 instead of retpoline. Enhanced IBRS is more efficient than retpoline.<p>retbleed <a href="https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;901834&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;901834&#x2F;</a><p>[2] <a href="https:&#x2F;&#x2F;discourse.llvm.org&#x2F;t&#x2F;is-pic-code-defeating-the-branch-predictor&#x2F;18177" rel="nofollow noreferrer">https:&#x2F;&#x2F;discourse.llvm.org&#x2F;t&#x2F;is-pic-code-defeating-the-branc...</a></div><br/></div></div><div id="38202228" class="c"><input type="checkbox" id="c-38202228" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#38202097">prev</a><span>|</span><a href="#38202211">next</a><span>|</span><label class="collapse" for="c-38202228">[-]</label><label class="expand" for="c-38202228">[2 more]</label></div><br/><div class="children"><div class="content">A similar &quot;trick&quot; was used on some 8-bit home computers for passing (optionally variable-length) data to operating system calls.<p>For instance on the KC85&#x2F;2..4 operating system (CAOS) the equivalent of &quot;puts()&quot; expects the &quot;syscall index&quot; and zero-terminated text to print after the call instruction, e.g.:<p><pre><code>    CALL 0F003H    ; call into generic &quot;syscall&quot; entry
    DEFB 23H       ; &quot;syscall&quot; identifier
    DEFM &#x27;HELLO WORLD!&#x27;
    DEFW 0D0AH     ; newline
    DEFB 00        ; end of text
    NOP            ; execution continues here
</code></pre>
The syscall dispatcher would pop the return address from the stack and that way discover the data. Before the syscall returns, a modified return address which points to the first byte after the data is pushed back on the stack.<p>Only downside of this approach was that disassemblers would get terribly confused, unless they had specific knowledge about this CAOS peculiarity.</div><br/><div id="38202282" class="c"><input type="checkbox" id="c-38202282" checked=""/><div class="controls bullet"><span class="by">warpspin</span><span>|</span><a href="#38202228">parent</a><span>|</span><a href="#38202211">next</a><span>|</span><label class="collapse" for="c-38202282">[-]</label><label class="expand" for="c-38202282">[1 more]</label></div><br/><div class="children"><div class="content">Yes. C64 GEOS also used this a lot. They used to call it „inline calls“:<p><a href="https:&#x2F;&#x2F;archive.org&#x2F;details&#x2F;The_Official_GEOS_Programmers_Reference_Guide&#x2F;page&#x2F;n37&#x2F;mode&#x2F;2up" rel="nofollow noreferrer">https:&#x2F;&#x2F;archive.org&#x2F;details&#x2F;The_Official_GEOS_Programmers_Re...</a></div><br/></div></div></div></div><div id="38202211" class="c"><input type="checkbox" id="c-38202211" checked=""/><div class="controls bullet"><span class="by">qweqwe14</span><span>|</span><a href="#38202228">prev</a><span>|</span><a href="#38202238">next</a><span>|</span><label class="collapse" for="c-38202211">[-]</label><label class="expand" for="c-38202211">[1 more]</label></div><br/><div class="children"><div class="content">This trick isn&#x27;t i386-specific. In general, you can merge .data, .rodata etc into one section with a linker script and it will just work, pretty useful for saving a few bytes.<p>Also see sstrip for ELF files and this legendary writeup <a href="https:&#x2F;&#x2F;www.muppetlabs.com&#x2F;~breadbox&#x2F;software&#x2F;tiny&#x2F;teensy.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.muppetlabs.com&#x2F;~breadbox&#x2F;software&#x2F;tiny&#x2F;teensy.ht...</a></div><br/></div></div><div id="38202238" class="c"><input type="checkbox" id="c-38202238" checked=""/><div class="controls bullet"><span class="by">BruceEel</span><span>|</span><a href="#38202211">prev</a><span>|</span><a href="#38202137">next</a><span>|</span><label class="collapse" for="c-38202238">[-]</label><label class="expand" for="c-38202238">[1 more]</label></div><br/><div class="children"><div class="content">Well yes, as said here, it&#x27;s more of a linker thing and not so much a language or assembly thing. On Windows you could do the below to have a single, executable, readable and writable section. Not sure whether it still works anno 2023.<p>It&#x27;s generally considered a bad idea from a security standpoint<p><pre><code>     #pragma comment(linker,&quot;&#x2F;MERGE:.data=.text &#x2F;MERGE:.rdata=.text &#x2F;MERGE:.flat=.text  &#x2F;SECTION:.text,EWR &quot;)</code></pre></div><br/></div></div><div id="38202137" class="c"><input type="checkbox" id="c-38202137" checked=""/><div class="controls bullet"><span class="by">messe</span><span>|</span><a href="#38202238">prev</a><span>|</span><a href="#38202174">next</a><span>|</span><label class="collapse" for="c-38202137">[-]</label><label class="expand" for="c-38202137">[2 more]</label></div><br/><div class="children"><div class="content">I love using a variant on that trick in real mode code:<p><pre><code>    print:
        pop si
    .loop:
        lodsb
        jz .end
        mov ah, 0x0E
        xor bh, bh
        int 10h
        jmp .loop
    .end:
        push si
        ret
</code></pre>
I’m writing this from memory, so there may be an off by one error in the above code.<p>It’s used like this, with a null terminated string, rather than a hardcoded length:<p><pre><code>    call print
    db &quot;hello, world&quot;, 0
</code></pre>
This can even be transformed into something like<p><pre><code>    puts &quot;hello, world&quot;
</code></pre>
with the aid of NASM macros. I can’t recall where I saw this trick originally. Maybe some FreeDOS or GRUB code.</div><br/><div id="38202166" class="c"><input type="checkbox" id="c-38202166" checked=""/><div class="controls bullet"><span class="by">stevekemp</span><span>|</span><a href="#38202137">parent</a><span>|</span><a href="#38202174">next</a><span>|</span><label class="collapse" for="c-38202166">[-]</label><label class="expand" for="c-38202166">[1 more]</label></div><br/><div class="children"><div class="content">If first saw this in virus-code from the 80s, where you&#x27;d have code to get the current location:<p><pre><code>       call next
     next:
       pop ax
</code></pre>
I&#x27;ve used the same approach for printing &quot;inline&quot; strings myself, though in my case I tend to be working with CP&#x2F;M and there the string are terminated with &quot;$&quot;.</div><br/></div></div></div></div><div id="38202174" class="c"><input type="checkbox" id="c-38202174" checked=""/><div class="controls bullet"><span class="by">irdc</span><span>|</span><a href="#38202137">prev</a><span>|</span><a href="#38202124">next</a><span>|</span><label class="collapse" for="c-38202174">[-]</label><label class="expand" for="c-38202174">[2 more]</label></div><br/><div class="children"><div class="content">Tricks like these are going to become less common with execute-only mapping of .text slowly proliferating through the industry (iOS, OpenBSD).<p>Though i386 is unlikely to ever become execute-only.</div><br/><div id="38202583" class="c"><input type="checkbox" id="c-38202583" checked=""/><div class="controls bullet"><span class="by">H8crilA</span><span>|</span><a href="#38202174">parent</a><span>|</span><a href="#38202124">next</a><span>|</span><label class="collapse" for="c-38202583">[-]</label><label class="expand" for="c-38202583">[1 more]</label></div><br/><div class="children"><div class="content">Is that a security measure? What would execute-only prevent?</div><br/></div></div></div></div><div id="38202124" class="c"><input type="checkbox" id="c-38202124" checked=""/><div class="controls bullet"><span class="by">nynyny7</span><span>|</span><a href="#38202174">prev</a><span>|</span><a href="#38202160">next</a><span>|</span><label class="collapse" for="c-38202124">[-]</label><label class="expand" for="c-38202124">[3 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t get the purpose, at least of his minimal example. The author says he wants to make his code position-independent, i.e., so that it can be executed from everywhere in memory (without relocation). But that is defeated by the...<p>mov edx, print<p>... in the example.</div><br/><div id="38202297" class="c"><input type="checkbox" id="c-38202297" checked=""/><div class="controls bullet"><span class="by">0x0</span><span>|</span><a href="#38202124">parent</a><span>|</span><a href="#38202217">next</a><span>|</span><label class="collapse" for="c-38202297">[-]</label><label class="expand" for="c-38202297">[1 more]</label></div><br/><div class="children"><div class="content">They should have put labels in front of and after the string bytes, then most assemblers would evaluate &quot;(labelafter - labelbefore)&quot; to a constant integer giving the length as needed. No need for a runtime sub instruction either, then.</div><br/></div></div><div id="38202217" class="c"><input type="checkbox" id="c-38202217" checked=""/><div class="controls bullet"><span class="by">yenz0r</span><span>|</span><a href="#38202124">parent</a><span>|</span><a href="#38202297">prev</a><span>|</span><a href="#38202160">next</a><span>|</span><label class="collapse" for="c-38202217">[-]</label><label class="expand" for="c-38202217">[1 more]</label></div><br/><div class="children"><div class="content">Yeah the example wont work, but since it&#x27;s only used for getting the length of the string its an easy to fix to instead use pascal&#x2F;counted strings with a length prefix byte.</div><br/></div></div></div></div></div></div></div></div></div></body></html>