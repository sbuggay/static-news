<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1689325260011" as="style"/><link rel="stylesheet" href="styles.css?v=1689325260011"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://ahgamut.github.io/2023/07/13/patching-gcc-cosmo/">Patching GCC to build Actually Portable Executables</a>Â <span class="domain">(<a href="https://ahgamut.github.io">ahgamut.github.io</a>)</span></div><div class="subtext"><span>latchkey</span> | <span>67 comments</span></div><br/><div><div id="36717049" class="c"><input type="checkbox" id="c-36717049" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717074">next</a><span>|</span><label class="collapse" for="c-36717049">[-]</label><label class="expand" for="c-36717049">[13 more]</label></div><br/><div class="children"><div class="content">I wrote this post: the title should be &quot;Patching GCC to build Actually Portable Executables&quot;, because it refers to Cosmopolitan Libc and jart&#x27;s Actually Portable Executable format.<p>With my gcc patch, you can now build software like vim, emacs, ninja, bash, git, gcc etc with Cosmopolitan Libc, via their usual autotools&#x2F;cmake-style build system. The built executables should run on Linux, FreeBSD, MacOS, OpenBSD, NetBSD, and also Windows (although I haven&#x27;t tested Windows yet.)<p>Here&#x27;s a list of software I got to build with this technique: <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;superconfigure">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;superconfigure</a><p>The superconfigure script is just a wrapper around the usual configure script used to build your software, supplying flags like --enable-static.<p>If you want to build gcc using Cosmopolitan Libc -- try out this repo: <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;musl-cross-make&#x2F;tree&#x2F;gccbuild">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;musl-cross-make&#x2F;tree&#x2F;gccbuild</a></div><br/><div id="36717531" class="c"><input type="checkbox" id="c-36717531" checked=""/><div class="controls bullet"><span class="by">endgame</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36721197">next</a><span>|</span><label class="collapse" for="c-36717531">[-]</label><label class="expand" for="c-36717531">[2 more]</label></div><br/><div class="children"><div class="content">Will this patch of yours make it into GCC upstream? APE executables and cosmopolitan libc are incredibly cool tech, and it&#x27;d be great if they were easier to use.</div><br/><div id="36720442" class="c"><input type="checkbox" id="c-36720442" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36717531">parent</a><span>|</span><a href="#36721197">next</a><span>|</span><label class="collapse" for="c-36720442">[-]</label><label class="expand" for="c-36720442">[1 more]</label></div><br/><div class="children"><div class="content">Reading the GCC source code was fun and educational, and I&#x27;d love to find out if this could patch make it into GCC. Haven&#x27;t discussed it with any of the GCC developers yet.<p>In the meantime, the Cosmopolitan Libc monorepo contains binaries of gcc-11 and binutils that have been built with my patch, you can use those for now :)</div><br/></div></div></div></div><div id="36721197" class="c"><input type="checkbox" id="c-36721197" checked=""/><div class="controls bullet"><span class="by">blueflow</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36717531">prev</a><span>|</span><a href="#36720482">next</a><span>|</span><label class="collapse" for="c-36721197">[-]</label><label class="expand" for="c-36721197">[1 more]</label></div><br/><div class="children"><div class="content">I recently saw that you got banned from lobste.rs for being a sockpuppet from jart and just now i realized that you are an actual, different person.<p>[unconstructive complaint about lobste.rs moderation skipped]<p>I hope HN treats you better.</div><br/></div></div><div id="36720482" class="c"><input type="checkbox" id="c-36720482" checked=""/><div class="controls bullet"><span class="by">mgaunard</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36721197">prev</a><span>|</span><a href="#36719147">next</a><span>|</span><label class="collapse" for="c-36720482">[-]</label><label class="expand" for="c-36720482">[3 more]</label></div><br/><div class="children"><div class="content">Building is not such a big achievement, what&#x27;s more interesting is to know whether it actually works?<p>As in, was there extensive testing to prove there are no regressions compared to the glibc version?</div><br/><div id="36720571" class="c"><input type="checkbox" id="c-36720571" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36720482">parent</a><span>|</span><a href="#36719147">next</a><span>|</span><label class="collapse" for="c-36720571">[-]</label><label class="expand" for="c-36720571">[2 more]</label></div><br/><div class="children"><div class="content">Right now I use the gcc, git, vim, and ninja APE binaries on my local system for daily work, and so far I have seen no visible regressions.<p>I agree with you though -- an extensive testing setup will reveal more things for improvement, be it in my patch or in the libc itself. At the moment I only have direct access to Debian 11&#x2F;Fedora 35&#x2F;FreeBSD 13, but I expect we will soon find a nice way to run tests across the different operating systems automatically. One of my ideas was to setup a separate drive or folder with all the executables, accessible from different operating systems&#x2F;VMs, and then run the tests from each. What do you think?</div><br/><div id="36721119" class="c"><input type="checkbox" id="c-36721119" checked=""/><div class="controls bullet"><span class="by">gdprrrr</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36720571">parent</a><span>|</span><a href="#36719147">next</a><span>|</span><label class="collapse" for="c-36721119">[-]</label><label class="expand" for="c-36721119">[1 more]</label></div><br/><div class="children"><div class="content">I think github actions has windows images</div><br/></div></div></div></div></div></div><div id="36719147" class="c"><input type="checkbox" id="c-36719147" checked=""/><div class="controls bullet"><span class="by">foresto</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36720482">prev</a><span>|</span><a href="#36717438">next</a><span>|</span><label class="collapse" for="c-36719147">[-]</label><label class="expand" for="c-36719147">[2 more]</label></div><br/><div class="children"><div class="content">Nice! Do you foresee any problems with using this behind a transpiled language like Nim?</div><br/><div id="36720408" class="c"><input type="checkbox" id="c-36720408" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36719147">parent</a><span>|</span><a href="#36717438">next</a><span>|</span><label class="collapse" for="c-36720408">[-]</label><label class="expand" for="c-36720408">[1 more]</label></div><br/><div class="children"><div class="content">I haven&#x27;t used Nim much, but I remember a repo on Github had setup a build script for compiling Nim with Cosmopolitan Libc. <a href="https:&#x2F;&#x2F;github.com&#x2F;Yardanico&#x2F;cosmonim">https:&#x2F;&#x2F;github.com&#x2F;Yardanico&#x2F;cosmonim</a><p>This gcc patch makes such build scripts simpler, because you will need to change less of your code -- let me know how it works!</div><br/></div></div></div></div><div id="36717438" class="c"><input type="checkbox" id="c-36717438" checked=""/><div class="controls bullet"><span class="by">ChickeNES</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36719147">prev</a><span>|</span><a href="#36717705">next</a><span>|</span><label class="collapse" for="c-36717438">[-]</label><label class="expand" for="c-36717438">[2 more]</label></div><br/><div class="children"><div class="content">Have you attempted to build busybox?</div><br/><div id="36717520" class="c"><input type="checkbox" id="c-36717520" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36717438">parent</a><span>|</span><a href="#36717705">next</a><span>|</span><label class="collapse" for="c-36717520">[-]</label><label class="expand" for="c-36717520">[1 more]</label></div><br/><div class="children"><div class="content">Yes, I have gotten busybox to build successfully, but at present it&#x27;s not as nice as bash or vim. I expect someone will write a better build script soon enough. Maybe it will be you!<p>The default build parameters in busybox make a lot of OS-related assumptions, so I&#x27;d recommend you use make menuconfig instead of make depconfig. in the TUI, you can disable all console and networking utilities, linux modprobe utilities, some linux system utilities, free, uptime, etc. Start with a minimal config and then slowly add things.<p>In terms of source code changes: modify `u_signal_names.c` to use a switch statement instead of the amazing &quot;use SIGHUP as an array index&quot; method it follows, use int32_t instead of the &quot;smallint&quot; type that busybox seems to prefer, and IIRC there&#x27;s an enum in there somewhere that should be rewritten as a #define.<p>That should get you pretty close to a successful build.</div><br/></div></div></div></div><div id="36717705" class="c"><input type="checkbox" id="c-36717705" checked=""/><div class="controls bullet"><span class="by">cratermoon</span><span>|</span><a href="#36717049">parent</a><span>|</span><a href="#36717438">prev</a><span>|</span><a href="#36717074">next</a><span>|</span><label class="collapse" for="c-36717705">[-]</label><label class="expand" for="c-36717705">[2 more]</label></div><br/><div class="children"><div class="content">Could this be done for Rust? rustup target add cosmo maybe?</div><br/><div id="36717720" class="c"><input type="checkbox" id="c-36717720" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717049">root</a><span>|</span><a href="#36717705">parent</a><span>|</span><a href="#36717074">next</a><span>|</span><label class="collapse" for="c-36717720">[-]</label><label class="expand" for="c-36717720">[1 more]</label></div><br/><div class="children"><div class="content">I did that last year :) <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;rust-ape-example">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;rust-ape-example</a><p>Also got ripgrep to work: <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;ripgrep&#x2F;tree&#x2F;cosmopolitan">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;ripgrep&#x2F;tree&#x2F;cosmopolitan</a><p>Might need to update the build scripts a little to handle the latest updates in Rust and Cosmo (we&#x27;ll need gcc-11 now), but I expect to get Rust working again soon enough.</div><br/></div></div></div></div></div></div><div id="36717074" class="c"><input type="checkbox" id="c-36717074" checked=""/><div class="controls bullet"><span class="by">develatio</span><span>|</span><a href="#36717049">prev</a><span>|</span><a href="#36719677">next</a><span>|</span><label class="collapse" for="c-36717074">[-]</label><label class="expand" for="c-36717074">[1 more]</label></div><br/><div class="children"><div class="content">There is a ticket in Go&#x27;s repo about this: <a href="https:&#x2F;&#x2F;github.com&#x2F;golang&#x2F;go&#x2F;issues&#x2F;51900">https:&#x2F;&#x2F;github.com&#x2F;golang&#x2F;go&#x2F;issues&#x2F;51900</a></div><br/></div></div><div id="36719677" class="c"><input type="checkbox" id="c-36719677" checked=""/><div class="controls bullet"><span class="by">ylyn</span><span>|</span><a href="#36717074">prev</a><span>|</span><a href="#36715329">next</a><span>|</span><label class="collapse" for="c-36719677">[-]</label><label class="expand" for="c-36719677">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t see why you are so surprised by code that indexes using SIGxxx. The signal numbers are well-defined and known to be mostly consecutive and start from 1.</div><br/></div></div><div id="36715329" class="c"><input type="checkbox" id="c-36715329" checked=""/><div class="controls bullet"><span class="by">1vuio0pswjnm7</span><span>|</span><a href="#36719677">prev</a><span>|</span><a href="#36716504">next</a><span>|</span><label class="collapse" for="c-36715329">[-]</label><label class="expand" for="c-36715329">[2 more]</label></div><br/><div class="children"><div class="content">&quot;But I&#x27;ve spent a good chunk of time removing obvious counterexamples, and a lot of popular software builds seamlessly.&quot;<p>Publishing a list of software that will successfully compile might be helpful.  Perhaps this already exists.</div><br/><div id="36717058" class="c"><input type="checkbox" id="c-36717058" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36715329">parent</a><span>|</span><a href="#36716504">next</a><span>|</span><label class="collapse" for="c-36717058">[-]</label><label class="expand" for="c-36717058">[1 more]</label></div><br/><div class="children"><div class="content">You can build software like vim, emacs, ninja, bash, git, gcc etc -- here&#x27;s a list of software I got to build with this technique: <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;superconfigure">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;superconfigure</a><p>The superconfigure script is just a wrapper around the usual configure script used to build your software, supplying flags like --enable-static.</div><br/></div></div></div></div><div id="36716504" class="c"><input type="checkbox" id="c-36716504" checked=""/><div class="controls bullet"><span class="by">dataangel</span><span>|</span><a href="#36715329">prev</a><span>|</span><a href="#36720466">next</a><span>|</span><label class="collapse" for="c-36716504">[-]</label><label class="expand" for="c-36716504">[20 more]</label></div><br/><div class="children"><div class="content">Is there any practical purpose for APE? Like who is shipping single executables that need to run on N OSes?</div><br/><div id="36720109" class="c"><input type="checkbox" id="c-36720109" checked=""/><div class="controls bullet"><span class="by">tstack</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36719881">next</a><span>|</span><label class="collapse" for="c-36720109">[-]</label><label class="expand" for="c-36720109">[1 more]</label></div><br/><div class="children"><div class="content">I use an APE executable as an agent for communicating with remote hosts in the Logfile Navigator (<a href="https:&#x2F;&#x2F;lnav.org" rel="nofollow noreferrer">https:&#x2F;&#x2F;lnav.org</a>).  While lnav itself is not built as an APE, the agent built into itself is.  That agent is transferred to the remote when the user wants to read logs on that host.  This way, there is no extra step to determine the type of OS or building in multiple versions of the executable.  Here&#x27;s a short blog post on the subject:<p><a href="https:&#x2F;&#x2F;lnav.org&#x2F;2021&#x2F;05&#x2F;03&#x2F;tailing-remote-files.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;lnav.org&#x2F;2021&#x2F;05&#x2F;03&#x2F;tailing-remote-files.html</a></div><br/></div></div><div id="36719881" class="c"><input type="checkbox" id="c-36719881" checked=""/><div class="controls bullet"><span class="by">corysama</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36720109">prev</a><span>|</span><a href="#36718781">next</a><span>|</span><label class="collapse" for="c-36719881">[-]</label><label class="expand" for="c-36719881">[5 more]</label></div><br/><div class="children"><div class="content">Java&#x2F;Closure&#x2F;Kotlin programmers. .Net programmers. JS, Python, Ruby, Erlang, every VM-based language programmers. Statically-compiled programs are under the hood of everything, but at the application level in the minority.<p>APE is a big âWho needs a VM if an AOT compiled language as low level as C can compile once and run universally?â</div><br/><div id="36720165" class="c"><input type="checkbox" id="c-36720165" checked=""/><div class="controls bullet"><span class="by">up2isomorphism</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36719881">parent</a><span>|</span><a href="#36720266">next</a><span>|</span><label class="collapse" for="c-36720165">[-]</label><label class="expand" for="c-36720165">[1 more]</label></div><br/><div class="children"><div class="content">Portability is not the reason you see VMs everywhere.</div><br/></div></div><div id="36720266" class="c"><input type="checkbox" id="c-36720266" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36719881">parent</a><span>|</span><a href="#36720165">prev</a><span>|</span><a href="#36718781">next</a><span>|</span><label class="collapse" for="c-36720266">[-]</label><label class="expand" for="c-36720266">[3 more]</label></div><br/><div class="children"><div class="content">If libc is the only leaf dependency.</div><br/><div id="36720374" class="c"><input type="checkbox" id="c-36720374" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36720266">parent</a><span>|</span><a href="#36718781">next</a><span>|</span><label class="collapse" for="c-36720374">[-]</label><label class="expand" for="c-36720374">[2 more]</label></div><br/><div class="children"><div class="content">Which is true for a lot of useful tools that run in a terminal (for many coders this is pretty much everything except an IDE and a browser).</div><br/><div id="36720921" class="c"><input type="checkbox" id="c-36720921" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36720374">parent</a><span>|</span><a href="#36718781">next</a><span>|</span><label class="collapse" for="c-36720921">[-]</label><label class="expand" for="c-36720921">[1 more]</label></div><br/><div class="children"><div class="content">If their world is ISO C and nothing else, quite a boring one actually.<p>Not even a bit of colour, as terminal escape sequences assume a POSIX host environment, and will throw up gibberish if not.</div><br/></div></div></div></div></div></div></div></div><div id="36718781" class="c"><input type="checkbox" id="c-36718781" checked=""/><div class="controls bullet"><span class="by">lmm</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36719881">prev</a><span>|</span><a href="#36721152">next</a><span>|</span><label class="collapse" for="c-36718781">[-]</label><label class="expand" for="c-36718781">[1 more]</label></div><br/><div class="children"><div class="content">I can imagine it making it slightly easier to distribute executables from e.g. maven repositories (where having multiple artifacts for the same id&#x2F;version combination is cumbersome). I think PyPI might have a similar issue?<p>Also cross-compiling is painful; a lot of small OSS projects that don&#x27;t have a build farm with all of the different BSDs etc. to hand simply don&#x27;t ship binaries for those. Even e.g. kubectl has a binary for Linux but not for any of the BSDs (unless you count OSX). So this seems like an easy win for those.</div><br/></div></div><div id="36721152" class="c"><input type="checkbox" id="c-36721152" checked=""/><div class="controls bullet"><span class="by">efrecon</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36718781">prev</a><span>|</span><a href="#36716614">next</a><span>|</span><label class="collapse" for="c-36721152">[-]</label><label class="expand" for="c-36721152">[1 more]</label></div><br/><div class="children"><div class="content">In vscode extensions that rely on an external binary to do most of the job?</div><br/></div></div><div id="36716614" class="c"><input type="checkbox" id="c-36716614" checked=""/><div class="controls bullet"><span class="by">Timon3</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36721152">prev</a><span>|</span><a href="#36720342">next</a><span>|</span><label class="collapse" for="c-36716614">[-]</label><label class="expand" for="c-36716614">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;m trying to release future side projects that way. I even build a Redbean executable for any client-only SPAs. The idea of this stuff <i>just working</i> on so many systems is amazing.</div><br/><div id="36717166" class="c"><input type="checkbox" id="c-36717166" checked=""/><div class="controls bullet"><span class="by">nicoburns</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36716614">parent</a><span>|</span><a href="#36720342">next</a><span>|</span><label class="collapse" for="c-36717166">[-]</label><label class="expand" for="c-36717166">[2 more]</label></div><br/><div class="children"><div class="content">Problem with this is that self-modifying code will likely trip security blocks on most platforms, which is probably more annoying for users than having to download separate executables.</div><br/><div id="36719438" class="c"><input type="checkbox" id="c-36719438" checked=""/><div class="controls bullet"><span class="by">ElectricalUnion</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36717166">parent</a><span>|</span><a href="#36720342">next</a><span>|</span><label class="collapse" for="c-36719438">[-]</label><label class="expand" for="c-36719438">[1 more]</label></div><br/><div class="children"><div class="content">If the person needs to run with &quot;security blocks&quot; up, it&#x27;s statistically unlikely that the same person can randomly download the specific and potentially outdated version of a dependency you need for the code to run in the first place.</div><br/></div></div></div></div></div></div><div id="36720342" class="c"><input type="checkbox" id="c-36720342" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36716614">prev</a><span>|</span><a href="#36716878">next</a><span>|</span><label class="collapse" for="c-36720342">[-]</label><label class="expand" for="c-36720342">[1 more]</label></div><br/><div class="children"><div class="content">I have a shader compiler which would benefit from a platform agnostic, ready-to-run executable format.<p>It&#x27;s too big to be build ad-hoc on the user&#x27;s machine (contains various big 3rd party C++ dependencies, and takes between 2 and 20 minutes to build, depending on the hardware).<p>Needs to run on macOS x86-64+ARM, Linux x86-64 (ARM would be nice too of course), and Windows x86-64.<p>I&#x27;m currently looking into WASM, but that needs an installed WASI runtime.</div><br/></div></div><div id="36716878" class="c"><input type="checkbox" id="c-36716878" checked=""/><div class="controls bullet"><span class="by">jcelerier</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36720342">prev</a><span>|</span><a href="#36716627">next</a><span>|</span><label class="collapse" for="c-36716878">[-]</label><label class="expand" for="c-36716878">[3 more]</label></div><br/><div class="children"><div class="content">i&#x27;ve been asked this hundreds of times in my life, by customers, bosses, etc...</div><br/><div id="36717874" class="c"><input type="checkbox" id="c-36717874" checked=""/><div class="controls bullet"><span class="by">mhh__</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36716878">parent</a><span>|</span><a href="#36716627">next</a><span>|</span><label class="collapse" for="c-36717874">[-]</label><label class="expand" for="c-36717874">[2 more]</label></div><br/><div class="children"><div class="content">But they don&#x27;t know or care the difference between the code being in the same binary or not</div><br/><div id="36719448" class="c"><input type="checkbox" id="c-36719448" checked=""/><div class="controls bullet"><span class="by">ElectricalUnion</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36717874">parent</a><span>|</span><a href="#36716627">next</a><span>|</span><label class="collapse" for="c-36719448">[-]</label><label class="expand" for="c-36719448">[1 more]</label></div><br/><div class="children"><div class="content">But they know and care that &quot;it doesn&#x27;t run&quot; even if they don&#x27;t know how and why.</div><br/></div></div></div></div></div></div><div id="36716627" class="c"><input type="checkbox" id="c-36716627" checked=""/><div class="controls bullet"><span class="by">jjnoakes</span><span>|</span><a href="#36716504">parent</a><span>|</span><a href="#36716878">prev</a><span>|</span><a href="#36720466">next</a><span>|</span><label class="collapse" for="c-36716627">[-]</label><label class="expand" for="c-36716627">[4 more]</label></div><br/><div class="children"><div class="content">Storing executables on file systems shared across operating systems or architectures gets a lot easier if you don&#x27;t have to have special paths for each os+arch combination.</div><br/><div id="36716970" class="c"><input type="checkbox" id="c-36716970" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36716627">parent</a><span>|</span><a href="#36720466">next</a><span>|</span><label class="collapse" for="c-36716970">[-]</label><label class="expand" for="c-36716970">[3 more]</label></div><br/><div class="children"><div class="content">Doesnât the executable get overwritten after first invocation?</div><br/><div id="36719447" class="c"><input type="checkbox" id="c-36719447" checked=""/><div class="controls bullet"><span class="by">ElectricalUnion</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36716970">parent</a><span>|</span><a href="#36718990">next</a><span>|</span><label class="collapse" for="c-36719447">[-]</label><label class="expand" for="c-36719447">[1 more]</label></div><br/><div class="children"><div class="content">Only if you specifically run it with the `--assimilate` flag.</div><br/></div></div><div id="36718990" class="c"><input type="checkbox" id="c-36718990" checked=""/><div class="controls bullet"><span class="by">jjnoakes</span><span>|</span><a href="#36716504">root</a><span>|</span><a href="#36716970">parent</a><span>|</span><a href="#36719447">prev</a><span>|</span><a href="#36720466">next</a><span>|</span><label class="collapse" for="c-36718990">[-]</label><label class="expand" for="c-36718990">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think so.</div><br/></div></div></div></div></div></div></div></div><div id="36720466" class="c"><input type="checkbox" id="c-36720466" checked=""/><div class="controls bullet"><span class="by">mgaunard</span><span>|</span><a href="#36716504">prev</a><span>|</span><a href="#36715396">next</a><span>|</span><label class="collapse" for="c-36720466">[-]</label><label class="expand" for="c-36720466">[2 more]</label></div><br/><div class="children"><div class="content">If errno is such a big problem, what&#x27;s the hope in even running the C++ standard library and its std::error_code...<p>No way to use magic macros there.</div><br/><div id="36720719" class="c"><input type="checkbox" id="c-36720719" checked=""/><div class="controls bullet"><span class="by">foota</span><span>|</span><a href="#36720466">parent</a><span>|</span><a href="#36715396">next</a><span>|</span><label class="collapse" for="c-36720719">[-]</label><label class="expand" for="c-36720719">[1 more]</label></div><br/><div class="children"><div class="content">The issue _was_ the magic macros, I believe. Normally, the macros expand to a constant, but now they don&#x27;t, which breaks some things. std::error_code doesn&#x27;t have the same issue, since it&#x27;s not a constant?</div><br/></div></div></div></div><div id="36715396" class="c"><input type="checkbox" id="c-36715396" checked=""/><div class="controls bullet"><span class="by">KerrAvon</span><span>|</span><a href="#36720466">prev</a><span>|</span><a href="#36715880">next</a><span>|</span><label class="collapse" for="c-36715396">[-]</label><label class="expand" for="c-36715396">[4 more]</label></div><br/><div class="children"><div class="content">The switch-to-if thing is pretty inelegant. It seems like you could fix this by mapping to a platform-neutral set of constants, so you could dereference the runtime symbol with a function -- `switch(CosmoMappErrno(EINVAL))` and `case COSMO_EINVAL:` and so avoid turning the code into goto mush.</div><br/><div id="36716999" class="c"><input type="checkbox" id="c-36716999" checked=""/><div class="controls bullet"><span class="by">jsmith45</span><span>|</span><a href="#36715396">parent</a><span>|</span><a href="#36717099">next</a><span>|</span><label class="collapse" for="c-36716999">[-]</label><label class="expand" for="c-36716999">[1 more]</label></div><br/><div class="children"><div class="content">But that won&#x27;t help with compiling unmodified code. Nobody should worry about gotos being created inside the compiler. It is doing that all over the place anyway.<p>Unless of course you mean that the compiler should be recognizing switches like this, and instead of rewriting them to if trees, it should be rewriting them to switches, changing the labels to use special cosmo specific constants for each of the values, and wraping the input value to the switch with a call to a function that maps the current runtimes platform&#x27;s values for these over to corresponding cosmo specific constants  (and letting other values pass though unchanged).<p>That... actually might be a simpler compiler transformation to implement. There would be complexity in needing to recognize which of the multiple sets of of constants are being used, and applying the right call or calls to the switch input to map them. It also require complexity on the library side though (creating these ). Not sure if the author would want to implement it, given they have a working implementation of the other transformation.<p>Lastly such a mapping approach would have risks of inappropriately mapping, or trickiness like having to invert the input before mapping for code that does the negative errno value thing.</div><br/></div></div><div id="36717099" class="c"><input type="checkbox" id="c-36717099" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36715396">parent</a><span>|</span><a href="#36716999">prev</a><span>|</span><a href="#36716654">next</a><span>|</span><label class="collapse" for="c-36717099">[-]</label><label class="expand" for="c-36717099">[1 more]</label></div><br/><div class="children"><div class="content">Dereferencing the runtime symbol with a function sounds interesting! If you can show me an example of where it works, I&#x27;d be happy to try it out. I like the if-else-goto arrangement because it fit in perfectly with the other parts of gcc -- if you look at my patch[1], you will find that I had to change very little of gcc&#x27;s existing code to add this capability.<p>[1]: <a href="https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;gcc&#x2F;tree&#x2F;portcosmo-11.2">https:&#x2F;&#x2F;github.com&#x2F;ahgamut&#x2F;gcc&#x2F;tree&#x2F;portcosmo-11.2</a></div><br/></div></div><div id="36716654" class="c"><input type="checkbox" id="c-36716654" checked=""/><div class="controls bullet"><span class="by">outworlder</span><span>|</span><a href="#36715396">parent</a><span>|</span><a href="#36717099">prev</a><span>|</span><a href="#36715880">next</a><span>|</span><label class="collapse" for="c-36716654">[-]</label><label class="expand" for="c-36716654">[1 more]</label></div><br/><div class="children"><div class="content">Do we even care if the replacement is done automatically?</div><br/></div></div></div></div><div id="36715880" class="c"><input type="checkbox" id="c-36715880" checked=""/><div class="controls bullet"><span class="by">appleflaxen</span><span>|</span><a href="#36715396">prev</a><span>|</span><a href="#36716310">next</a><span>|</span><label class="collapse" for="c-36715880">[-]</label><label class="expand" for="c-36715880">[1 more]</label></div><br/><div class="children"><div class="content">This is incredible cool.</div><br/></div></div><div id="36716310" class="c"><input type="checkbox" id="c-36716310" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#36715880">prev</a><span>|</span><a href="#36717615">next</a><span>|</span><label class="collapse" for="c-36716310">[-]</label><label class="expand" for="c-36716310">[9 more]</label></div><br/><div class="children"><div class="content">In case the author sees this:<p>&gt; Of course, my patch isnât perfect. It canât handle some anonymous structs, enums, const ints, or amazing things like using SIGILL as an array index [...]<p>Is &quot;SIGILL&quot; a typo?</div><br/><div id="36717562" class="c"><input type="checkbox" id="c-36717562" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36716310">parent</a><span>|</span><a href="#36716358">next</a><span>|</span><label class="collapse" for="c-36717562">[-]</label><label class="expand" for="c-36717562">[2 more]</label></div><br/><div class="children"><div class="content">SIGILL is for &quot;illegal instruction&quot;, according to <a href="https:&#x2F;&#x2F;man7.org&#x2F;linux&#x2F;man-pages&#x2F;man7&#x2F;signal.7.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;man7.org&#x2F;linux&#x2F;man-pages&#x2F;man7&#x2F;signal.7.html</a><p>I too thought it was a typo when I caused it to occur while building BLIS, but then I found out it was because I had added some AVX thing to the config that my local computer did not have.</div><br/><div id="36720409" class="c"><input type="checkbox" id="c-36720409" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#36716310">root</a><span>|</span><a href="#36717562">parent</a><span>|</span><a href="#36716358">next</a><span>|</span><label class="collapse" for="c-36720409">[-]</label><label class="expand" for="c-36720409">[1 more]</label></div><br/><div class="children"><div class="content">Some compilers (like gcc) emit an &#x27;ud&#x27; instruction (<a href="https:&#x2F;&#x2F;www.felixcloutier.com&#x2F;x86&#x2F;ud" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.felixcloutier.com&#x2F;x86&#x2F;ud</a>) in some situations where the compiler detects undefined behaviour. IIRC this instruction triggers SIGILL on Linux.</div><br/></div></div></div></div><div id="36716358" class="c"><input type="checkbox" id="c-36716358" checked=""/><div class="controls bullet"><span class="by">inglor_cz</span><span>|</span><a href="#36716310">parent</a><span>|</span><a href="#36717562">prev</a><span>|</span><a href="#36717644">next</a><span>|</span><label class="collapse" for="c-36716358">[-]</label><label class="expand" for="c-36716358">[4 more]</label></div><br/><div class="children"><div class="content">The SIGILL signal is raised when an attempt is made to execute an invalid, privileged, or ill-formed instruction. SIGILL is usually caused by a program error that overlays code with data or by a call to a function that is not linked into the program load module.<p>[0] <a href="https:&#x2F;&#x2F;support.sas.com&#x2F;documentation&#x2F;onlinedoc&#x2F;ccompiler&#x2F;doc700&#x2F;html&#x2F;lr1&#x2F;z2005346.htm" rel="nofollow noreferrer">https:&#x2F;&#x2F;support.sas.com&#x2F;documentation&#x2F;onlinedoc&#x2F;ccompiler&#x2F;do...</a></div><br/><div id="36716591" class="c"><input type="checkbox" id="c-36716591" checked=""/><div class="controls bullet"><span class="by">spacechild1</span><span>|</span><a href="#36716310">root</a><span>|</span><a href="#36716358">parent</a><span>|</span><a href="#36716527">next</a><span>|</span><label class="collapse" for="c-36716591">[-]</label><label class="expand" for="c-36716591">[2 more]</label></div><br/><div class="children"><div class="content">Another common cause is trying to execute instructions that the CPU doesn&#x27;t support, e.g. trying to run AVX2 code on a machine that only supports SSE4.</div><br/><div id="36716767" class="c"><input type="checkbox" id="c-36716767" checked=""/><div class="controls bullet"><span class="by">inglor_cz</span><span>|</span><a href="#36716310">root</a><span>|</span><a href="#36716591">parent</a><span>|</span><a href="#36716527">next</a><span>|</span><label class="collapse" for="c-36716767">[-]</label><label class="expand" for="c-36716767">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, the only situation when I saw SIGILL &quot;live&quot; was my attempt to run some AES instructions on an emulator that didn&#x27;t support them.</div><br/></div></div></div></div><div id="36716527" class="c"><input type="checkbox" id="c-36716527" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#36716310">root</a><span>|</span><a href="#36716358">parent</a><span>|</span><a href="#36716591">prev</a><span>|</span><a href="#36717644">next</a><span>|</span><label class="collapse" for="c-36716527">[-]</label><label class="expand" for="c-36716527">[1 more]</label></div><br/><div class="children"><div class="content">Thanks, didn&#x27;t know that was an actual signal!</div><br/></div></div></div></div><div id="36717644" class="c"><input type="checkbox" id="c-36717644" checked=""/><div class="controls bullet"><span class="by">cratermoon</span><span>|</span><a href="#36716310">parent</a><span>|</span><a href="#36716358">prev</a><span>|</span><a href="#36716326">next</a><span>|</span><label class="collapse" for="c-36717644">[-]</label><label class="expand" for="c-36717644">[1 more]</label></div><br/><div class="children"><div class="content">An array of, say, strings, or functions, indexed according to IPC signal numbers. So array[SIGHUP] would be the same as array[2] so SIGILL would be array[4], or the 5th element of the array.</div><br/></div></div></div></div><div id="36717615" class="c"><input type="checkbox" id="c-36717615" checked=""/><div class="controls bullet"><span class="by">cratermoon</span><span>|</span><a href="#36716310">prev</a><span>|</span><a href="#36715674">next</a><span>|</span><label class="collapse" for="c-36717615">[-]</label><label class="expand" for="c-36717615">[4 more]</label></div><br/><div class="children"><div class="content">In case anyone is confused. &quot;Actually Portable Executables&quot; <a href="https:&#x2F;&#x2F;justine.lol&#x2F;ape.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;justine.lol&#x2F;ape.html</a></div><br/><div id="36717637" class="c"><input type="checkbox" id="c-36717637" checked=""/><div class="controls bullet"><span class="by">ahgamut</span><span>|</span><a href="#36717615">parent</a><span>|</span><a href="#36715674">next</a><span>|</span><label class="collapse" for="c-36717637">[-]</label><label class="expand" for="c-36717637">[3 more]</label></div><br/><div class="children"><div class="content">I added a comment mentioning this, but it hasn&#x27;t changed yet. I expect it will change soon. Perhaps I can ping @dang from here?</div><br/><div id="36720496" class="c"><input type="checkbox" id="c-36720496" checked=""/><div class="controls bullet"><span class="by">jwilk</span><span>|</span><a href="#36717615">root</a><span>|</span><a href="#36717637">parent</a><span>|</span><a href="#36717672">next</a><span>|</span><label class="collapse" for="c-36720496">[-]</label><label class="expand" for="c-36720496">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36526450">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36526450</a><p>&gt; <i>The only way to get reliable message delivery is to email hn@ycombinator.com.</i></div><br/></div></div><div id="36717672" class="c"><input type="checkbox" id="c-36717672" checked=""/><div class="controls bullet"><span class="by">cratermoon</span><span>|</span><a href="#36717615">root</a><span>|</span><a href="#36717637">parent</a><span>|</span><a href="#36720496">prev</a><span>|</span><a href="#36715674">next</a><span>|</span><label class="collapse" for="c-36717672">[-]</label><label class="expand" for="c-36717672">[1 more]</label></div><br/><div class="children"><div class="content">Justine&#x27;s post did a great job teaching me the details of leveraging the various executable formats to make it possible.</div><br/></div></div></div></div></div></div><div id="36715674" class="c"><input type="checkbox" id="c-36715674" checked=""/><div class="controls bullet"><span class="by">charonn0</span><span>|</span><a href="#36717615">prev</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36715674">[-]</label><label class="expand" for="c-36715674">[8 more]</label></div><br/><div class="children"><div class="content">N.B.: &quot;Portable Executable&quot; or &quot;PE&quot; is also the name of the Windows executable format.</div><br/><div id="36715781" class="c"><input type="checkbox" id="c-36715781" checked=""/><div class="controls bullet"><span class="by">epcoa</span><span>|</span><a href="#36715674">parent</a><span>|</span><a href="#36716908">next</a><span>|</span><label class="collapse" for="c-36715781">[-]</label><label class="expand" for="c-36715781">[1 more]</label></div><br/><div class="children"><div class="content">Looks like they changed the story headline to Actually Portable Executables (which is the original âcorrectâ name). Other than an audio format relatively few use I suppose APE isnât the most clashy file format name.</div><br/></div></div><div id="36716908" class="c"><input type="checkbox" id="c-36716908" checked=""/><div class="controls bullet"><span class="by">1vuio0pswjnm7</span><span>|</span><a href="#36715674">parent</a><span>|</span><a href="#36715781">prev</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36716908">[-]</label><label class="expand" for="c-36716908">[6 more]</label></div><br/><div class="children"><div class="content">It seems that the term &quot;portable&quot; in PE refers to portability to different hardware whereas the same term used in APE refers to portability to different operating systems.</div><br/><div id="36717036" class="c"><input type="checkbox" id="c-36717036" checked=""/><div class="controls bullet"><span class="by">throwaway8356</span><span>|</span><a href="#36715674">root</a><span>|</span><a href="#36716908">parent</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36717036">[-]</label><label class="expand" for="c-36717036">[5 more]</label></div><br/><div class="children"><div class="content">Portable is a generic term. The PE format is the same for x86 and ARM64 and other architectures.<p><a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;debug&#x2F;pe-format" rel="nofollow noreferrer">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;debug&#x2F;pe-for...</a><p>&gt; The name &quot;Portable Executable&quot; refers to the fact that the format is not architecture specific<p><a href="https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;Portable_Executable" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;Portable_Executable</a><p>&gt; On Windows NT operating systems, PE currently supports the x86-32, x86-64 (AMD64&#x2F;Intel 64), IA-64, ARM and ARM64 instruction set architectures (ISAs). Prior to Windows 2000, Windows NT (and thus PE) supported the MIPS, Alpha, and PowerPC ISAs. Because PE is used on Windows CE, it continues to support several variants of the MIPS, ARM (including Thumb), and SuperH ISAs.<p>In my opinion it qualifies as portable</div><br/><div id="36717293" class="c"><input type="checkbox" id="c-36717293" checked=""/><div class="controls bullet"><span class="by">skissane</span><span>|</span><a href="#36715674">root</a><span>|</span><a href="#36717036">parent</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36717293">[-]</label><label class="expand" for="c-36717293">[4 more]</label></div><br/><div class="children"><div class="content">It is portable in comparison to its main predecessor NE which was x86 only<p>It also is used by more than just Windows - EFI uses it too. There is no reason in principle why some non-Windows OS couldnât use it as the native executable format.</div><br/><div id="36717709" class="c"><input type="checkbox" id="c-36717709" checked=""/><div class="controls bullet"><span class="by">xvilka</span><span>|</span><a href="#36715674">root</a><span>|</span><a href="#36717293">parent</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36717709">[-]</label><label class="expand" for="c-36717709">[3 more]</label></div><br/><div class="children"><div class="content">&gt; more than just Windows - EFI uses it too.<p>And it was a mistake lobbied by Microsoft. UEFI should have used smaller format like TE everywhere. There&#x27;s no reason for files without imports and other similar needs from the loader to have the complexity of PE. At first it hindered toolchain support at non-Windows operating systems which was probably the real intention.</div><br/><div id="36719888" class="c"><input type="checkbox" id="c-36719888" checked=""/><div class="controls bullet"><span class="by">KingLancelot</span><span>|</span><a href="#36715674">root</a><span>|</span><a href="#36717709">parent</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36719888">[-]</label><label class="expand" for="c-36719888">[2 more]</label></div><br/><div class="children"><div class="content">What is TE?</div><br/><div id="36720904" class="c"><input type="checkbox" id="c-36720904" checked=""/><div class="controls bullet"><span class="by">skissane</span><span>|</span><a href="#36715674">root</a><span>|</span><a href="#36719888">parent</a><span>|</span><a href="#36716582">next</a><span>|</span><label class="collapse" for="c-36720904">[-]</label><label class="expand" for="c-36720904">[1 more]</label></div><br/><div class="children"><div class="content">TE (Terse Executable) is a simplified version of PE defined in some of the UEFI specs. To quote [0]:<p>&gt; The Terse Executable (TE) image format was created as a mechanism to reduce the overhead of the PE&#x2F;COFF headers in PE32&#x2F;PE32+ images, resulting in a corresponding reduction of image sizes for executables running in the PI Architecture environment. Reducing image size provides an opportunity for use of a smaller system flash part.<p>&gt; TE images, both drivers and applications, are created as PE32 (or PE32+) executables. PE32 is a generic executable image format that is intended to support multiple target systems, processors, and operating systems. As a result, the headers in the image contain information that is not necessarily applicable to all target systems. In an effort to reduce image size, a new executable image header (TE) was created that includes only those fields from the PE&#x2F;COFF headers required for execution under the PI Architecture. Since this header contains the information required for execution of the image, it can replace the PE&#x2F;COFF headers from the original image. This specification defines the TE header, the fields in the header, and how they are used in the PI Architectureâs execution environment.<p>Given it is a modified version of PE, I think it still counts as a member of the PE family of executable formats. It isn&#x27;t something with a different heritage, such as ELF. Although ELF and PE are ultimately cousins â AT&amp;T invented COFF, and then they invented ELF as a successor to COFF to fix its flaws; other vendors, such as IBM, SGI and DEC, decided to extend COFF to remedy those flaws instead of adopting ELF; and then Microsoft took AT&amp;T COFF and made their own modifications to it to produce PE.<p>[0] <a href="https:&#x2F;&#x2F;uefi.org&#x2F;sites&#x2F;default&#x2F;files&#x2F;resources&#x2F;PI_Spec_1_7_A_final_May1.pdf" rel="nofollow noreferrer">https:&#x2F;&#x2F;uefi.org&#x2F;sites&#x2F;default&#x2F;files&#x2F;resources&#x2F;PI_Spec_1_7_A...</a> PDF page 269</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>