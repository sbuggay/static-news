<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1721984466086" as="style"/><link rel="stylesheet" href="styles.css?v=1721984466086"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="http://blog.asleson.org/2024/07/24/bcachefs-an-introduction/exploration/">Bcachefs, an Introduction/Exploration</a> <span class="domain">(<a href="http://blog.asleson.org">blog.asleson.org</a>)</span></div><div class="subtext"><span>marbu</span> | <span>30 comments</span></div><br/><div><div id="41076923" class="c"><input type="checkbox" id="c-41076923" checked=""/><div class="controls bullet"><span class="by">ajb</span><span>|</span><a href="#41076935">next</a><span>|</span><label class="collapse" for="c-41076923">[-]</label><label class="expand" for="c-41076923">[1 more]</label></div><br/><div class="children"><div class="content">Bcachefs was merged into the kernel only months ago, and had an immediate flurry of bug fixes due to the additional testing this brought. (It was in development for some years before that out of tree). That&#x27;s the level of maturity that it is at. I think there&#x27;s a hope that it will become more trustworthy than btrfs due to the developers success with bcache.</div><br/></div></div><div id="41076935" class="c"><input type="checkbox" id="c-41076935" checked=""/><div class="controls bullet"><span class="by">jiripospisil</span><span>|</span><a href="#41076923">prev</a><span>|</span><a href="#41076682">next</a><span>|</span><label class="collapse" for="c-41076935">[-]</label><label class="expand" for="c-41076935">[1 more]</label></div><br/><div class="children"><div class="content">&gt; btrfs Encryption Y<p>btrfs doesn&#x27;t have a built-in encryption.<p>&gt; ZFS Encryption Y<p>I cannot find the discussion right now but I remember reading that they were considering a warning when enabling encryption because it was not really stable and people were running into crashes.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;openzfs&#x2F;zfs&#x2F;issues?q=is%3Aissue+label%3A%22Component%3A+Encryption%22+is%3Aopen+label%3A%22Type%3A+Defect%22">https:&#x2F;&#x2F;github.com&#x2F;openzfs&#x2F;zfs&#x2F;issues?q=is%3Aissue+label%3A%...</a></div><br/></div></div><div id="41076682" class="c"><input type="checkbox" id="c-41076682" checked=""/><div class="controls bullet"><span class="by">ysleepy</span><span>|</span><a href="#41076935">prev</a><span>|</span><a href="#41076622">next</a><span>|</span><label class="collapse" for="c-41076682">[-]</label><label class="expand" for="c-41076682">[4 more]</label></div><br/><div class="children"><div class="content">I wonder why ZFS is marked as not having de-dupe (deduplication).<p>AFAIK ZFS has had deduplication support for a very long time (2009) and now even does opportunistic block cloning with much less overhead.</div><br/><div id="41076977" class="c"><input type="checkbox" id="c-41076977" checked=""/><div class="controls bullet"><span class="by">ksec</span><span>|</span><a href="#41076682">parent</a><span>|</span><a href="#41076729">next</a><span>|</span><label class="collapse" for="c-41076977">[-]</label><label class="expand" for="c-41076977">[1 more]</label></div><br/><div class="children"><div class="content">Yes I sort of skip-read a lot of it after that.</div><br/></div></div><div id="41076729" class="c"><input type="checkbox" id="c-41076729" checked=""/><div class="controls bullet"><span class="by">adrian_b</span><span>|</span><a href="#41076682">parent</a><span>|</span><a href="#41076977">prev</a><span>|</span><a href="#41076622">next</a><span>|</span><label class="collapse" for="c-41076729">[-]</label><label class="expand" for="c-41076729">[2 more]</label></div><br/><div class="children"><div class="content">Also XFS has deduplication now, already for some time, at least one year or two.</div><br/><div id="41076922" class="c"><input type="checkbox" id="c-41076922" checked=""/><div class="controls bullet"><span class="by">BlackLotus89</span><span>|</span><a href="#41076682">root</a><span>|</span><a href="#41076729">parent</a><span>|</span><a href="#41076622">next</a><span>|</span><label class="collapse" for="c-41076922">[-]</label><label class="expand" for="c-41076922">[1 more]</label></div><br/><div class="children"><div class="content">btrfs has deduplication as well.<p>In theory full file deduplication exists in every filesystem that has cow&#x2F;reflink support</div><br/></div></div></div></div></div></div><div id="41076622" class="c"><input type="checkbox" id="c-41076622" checked=""/><div class="controls bullet"><span class="by">LeoPanthera</span><span>|</span><a href="#41076682">prev</a><span>|</span><a href="#41076856">next</a><span>|</span><label class="collapse" for="c-41076622">[-]</label><label class="expand" for="c-41076622">[16 more]</label></div><br/><div class="children"><div class="content">The &quot;why not btrfs&quot; line boils down to &quot;it took a long time to be stable&quot;.<p>That&#x27;s a weird argument. Even if it&#x27;s true, it is now stable, and has been for a long time. btrfs has long been my default, and I&#x27;d be wary of switching to something newer just because someone was mad that development took a long time.</div><br/><div id="41076660" class="c"><input type="checkbox" id="c-41076660" checked=""/><div class="controls bullet"><span class="by">eptcyka</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076877">next</a><span>|</span><label class="collapse" for="c-41076660">[-]</label><label class="expand" for="c-41076660">[4 more]</label></div><br/><div class="children"><div class="content">In 2019, btrfs ate all my data after a power cut. Btrfs peeps said it sounded like my SSD was at fault. Well, ZFS is still chugging along on that drive. I am not surprised btrfs took ages to stabilize, and it will take ages again before I rely on it. I’ve had previous btrfs incidents too. I think the argument against btrfs is that it was not good enough when btrfs devs told people to use it in production for ages.</div><br/><div id="41076696" class="c"><input type="checkbox" id="c-41076696" checked=""/><div class="controls bullet"><span class="by">greenavocado</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076660">parent</a><span>|</span><a href="#41076860">next</a><span>|</span><label class="collapse" for="c-41076696">[-]</label><label class="expand" for="c-41076696">[1 more]</label></div><br/><div class="children"><div class="content">Btrfs never actually stabilized it&#x27;s still garbage compared to ZFS</div><br/></div></div><div id="41076860" class="c"><input type="checkbox" id="c-41076860" checked=""/><div class="controls bullet"><span class="by">GrayShade</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076660">parent</a><span>|</span><a href="#41076696">prev</a><span>|</span><a href="#41076877">next</a><span>|</span><label class="collapse" for="c-41076860">[-]</label><label class="expand" for="c-41076860">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, in the last year and a half, I&#x27;ve had three btrfs file systems crash on me with the dreaded &quot;parent transid verify failed&quot;. Two times it was out of the blue, third time was just after it filled up.<p>The people on IRC tend to default to &quot;unless you&#x27;re using an enterprise drive, it&#x27;s probably buggy and doesn&#x27;t respect write barriers&quot;, which shouldn&#x27;t have mattered because there was no system crash involved.<p>Yes, I did test my RAM, I know it&#x27;s fine. For comparison, I&#x27;ve (unintentionally) ran a ZFS system with bad RAM for years and it only manifested as an occasional checksum error.</div><br/><div id="41076933" class="c"><input type="checkbox" id="c-41076933" checked=""/><div class="controls bullet"><span class="by">iforgotpassword</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076860">parent</a><span>|</span><a href="#41076877">next</a><span>|</span><label class="collapse" for="c-41076933">[-]</label><label class="expand" for="c-41076933">[1 more]</label></div><br/><div class="children"><div class="content">&gt; For comparison, I&#x27;ve (unintentionally) ran a ZFS system with bad RAM for years and it only manifested as an occasional checksum error.<p>Be careful though. If whatever data was to be written got corrupted early enough, ie before ZFS got to see it, it happily wrote corrupted data to disk with matching checksum and you&#x27;re none the wiser. But yes, it didn&#x27;t blow up the entire Filesystem unlike btrfs likes to do.</div><br/></div></div></div></div></div></div><div id="41076877" class="c"><input type="checkbox" id="c-41076877" checked=""/><div class="controls bullet"><span class="by">GrayShade</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076660">prev</a><span>|</span><a href="#41076674">next</a><span>|</span><label class="collapse" for="c-41076877">[-]</label><label class="expand" for="c-41076877">[1 more]</label></div><br/><div class="children"><div class="content">One interesting titbit I&#x27;ve only recently found out is that btrfs can&#x27;t really serve reads from different drives in RAID1, it picks a drive based on the process id.<p>ZFS does something smarter here, it keeps track of the queue length for each drive in a mirror, and picks the one with the lowest number of pending requests.</div><br/></div></div><div id="41076674" class="c"><input type="checkbox" id="c-41076674" checked=""/><div class="controls bullet"><span class="by">bheadmaster</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076877">prev</a><span>|</span><a href="#41076829">next</a><span>|</span><label class="collapse" for="c-41076674">[-]</label><label class="expand" for="c-41076674">[4 more]</label></div><br/><div class="children"><div class="content">Development taking long usually means that the model itself is too complicated to be done right in a reasonable time, which indicates that the &quot;stable&quot; implementation could still be buggy, but only if you stray away from the common path. It&#x27;s hard to feel comfortable using such a software in a fundamental role such a file system.</div><br/><div id="41076920" class="c"><input type="checkbox" id="c-41076920" checked=""/><div class="controls bullet"><span class="by">humanfromearth9</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076674">parent</a><span>|</span><a href="#41076751">next</a><span>|</span><label class="collapse" for="c-41076920">[-]</label><label class="expand" for="c-41076920">[1 more]</label></div><br/><div class="children"><div class="content">I think it&#x27;s not quite so simple.
The problem of organising storage is at least complex, on a scale of &quot;simple complicated complex chaotic&quot;. The inherent complexity might be impossible to reduce to something simple or even just complicated, except _maybe_ with layering (à la LVM2), each layer tackling one issue independently of the others. But then it&#x27;s probably at the cost of performance and other efficiency. Each layer should work such that it does not interfere too much with the performance of other layers. Not easy.<p>Given the rather cheap price of durable storage these days, I would favour rock solid, high quality code for storing my data, at the expense of some optimisations. Then again, I still like RAID, instantaneous snapshots, COW, encryption, xattr, resizable partitions, CRC... It&#x27;s it possible to have all this with acceptable performance and simple code bricks combined and layered on top of each other?</div><br/></div></div><div id="41076751" class="c"><input type="checkbox" id="c-41076751" checked=""/><div class="controls bullet"><span class="by">7e</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076674">parent</a><span>|</span><a href="#41076920">prev</a><span>|</span><a href="#41076829">next</a><span>|</span><label class="collapse" for="c-41076751">[-]</label><label class="expand" for="c-41076751">[2 more]</label></div><br/><div class="children"><div class="content">In this case I think it’s the case that bcachefs has only a very small set of developers working in it.</div><br/><div id="41076983" class="c"><input type="checkbox" id="c-41076983" checked=""/><div class="controls bullet"><span class="by">jeltz</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076751">parent</a><span>|</span><a href="#41076829">next</a><span>|</span><label class="collapse" for="c-41076983">[-]</label><label class="expand" for="c-41076983">[1 more]</label></div><br/><div class="children"><div class="content">But that was not the case for btrfs.</div><br/></div></div></div></div></div></div><div id="41076829" class="c"><input type="checkbox" id="c-41076829" checked=""/><div class="controls bullet"><span class="by">rubenbe</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076674">prev</a><span>|</span><a href="#41076646">next</a><span>|</span><label class="collapse" for="c-41076829">[-]</label><label class="expand" for="c-41076829">[2 more]</label></div><br/><div class="children"><div class="content">For me the killer feature of btrfs is &quot;RAID 1 with different sized disks&quot;.
For a small and cheap setup, this is perfect since a broken disk can be replaced with a bigger one and immediately (part of) the extra new disk space can be used. Other filesystems seem to only increase the size once all disks have been replaced with a bigger capacity one (last time I checked this was still the case for ZFS)</div><br/><div id="41076944" class="c"><input type="checkbox" id="c-41076944" checked=""/><div class="controls bullet"><span class="by">jiripospisil</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076829">parent</a><span>|</span><a href="#41076646">next</a><span>|</span><label class="collapse" for="c-41076944">[-]</label><label class="expand" for="c-41076944">[1 more]</label></div><br/><div class="children"><div class="content">Exactly. Provisioning a completely different set of disks when running out of capacity might be fine for a company but not for home office.</div><br/></div></div></div></div><div id="41076646" class="c"><input type="checkbox" id="c-41076646" checked=""/><div class="controls bullet"><span class="by">vbezhenar</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076829">prev</a><span>|</span><a href="#41076906">next</a><span>|</span><label class="collapse" for="c-41076646">[-]</label><label class="expand" for="c-41076646">[3 more]</label></div><br/><div class="children"><div class="content">Btrfs lost its credibility and many people would never trust it.</div><br/><div id="41076916" class="c"><input type="checkbox" id="c-41076916" checked=""/><div class="controls bullet"><span class="by">BSDobelix</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076646">parent</a><span>|</span><a href="#41076686">next</a><span>|</span><label class="collapse" for="c-41076916">[-]</label><label class="expand" for="c-41076916">[1 more]</label></div><br/><div class="children"><div class="content">So a year ago i tried to repeat my old trick damaging btrfs (as a user NOT root). Fill the volume with dd if=&#x2F;dev&#x2F;urandom of=.&#x2F;file bs=2M &amp;&amp; sync &amp;&amp; rm .&#x2F;file then reboot the machine and yes it still works, it&#x27;s not booting anymore, bravo.<p>BTW: Even SLES SuseLinux Enterprise says use XFS for data btrfs just for the OS i wonder why</div><br/></div></div><div id="41076686" class="c"><input type="checkbox" id="c-41076686" checked=""/><div class="controls bullet"><span class="by">greenavocado</span><span>|</span><a href="#41076622">root</a><span>|</span><a href="#41076646">parent</a><span>|</span><a href="#41076916">prev</a><span>|</span><a href="#41076906">next</a><span>|</span><label class="collapse" for="c-41076686">[-]</label><label class="expand" for="c-41076686">[1 more]</label></div><br/><div class="children"><div class="content">As little as one year ago I experienced damage on a lightly used btrfs root partition on my laptop. Never again. I use ext4 root and ZFS for &#x2F;home for snapshots and transparent compression now, all on top of LVM</div><br/></div></div></div></div><div id="41076906" class="c"><input type="checkbox" id="c-41076906" checked=""/><div class="controls bullet"><span class="by">_flux</span><span>|</span><a href="#41076622">parent</a><span>|</span><a href="#41076646">prev</a><span>|</span><a href="#41076856">next</a><span>|</span><label class="collapse" for="c-41076906">[-]</label><label class="expand" for="c-41076906">[1 more]</label></div><br/><div class="children"><div class="content">My personal grievances with btrfs are multifaceted.<p>- I never agreed with the btrfs default of root raid 1 system not booting up if a device is missing. I think the point of raid1 is to minimize downtime when losing a device and if you lose the other device before returning it to good state, that&#x27;s 100% on you.<p>- Poor management tools compared to md (though bcachefs might be in the same boat). Some tools are poorly thought, e.g. there is a tool for defragmentation, but it undoes sharing (so dedupped files get expanded).<p>- If a drive in raid1 drops but then later comes back, btrfs is still quite happy.<p>- Need of using btrfs balance, and in a certain way as well: <a href="https:&#x2F;&#x2F;github.com&#x2F;kdave&#x2F;btrfsmaintenance&#x2F;blob&#x2F;master&#x2F;btrfs-balance.sh">https:&#x2F;&#x2F;github.com&#x2F;kdave&#x2F;btrfsmaintenance&#x2F;blob&#x2F;master&#x2F;btrfs-...</a> .<p>- At least it used to be difficult to recover when your filesystem becomes full. Helps if you have it on LVM volume with extra space.<p>- Snapshotting or having a clone of a btrfs volume is dangerous (due to the uuid-based volume participant scanning)<p>- I believe raid5&#x2F;6 is <i>still</i> experimental?<p>- I&#x27;ve lost a filesystem to btrfs raid10 (but my backups are good).<p>- I have also rendered my bcachefs in a state where I could no longer write to the filesystem, but I was still able to read it. So I&#x27;m inclined to keep using bcachefs for the time being.<p>Overall I just have the impression that btrfs was complicated and ended up in a design dead-end, making improvements from hard to difficult, and I <i>hope</i> that bcachefs has made different base designs, making future improvements easier.<p>Yes, the number of developers for bcachefs is smaller, but frankly as long as it&#x27;s possible for a project to advance with a single developer, it is going to be the most effective way to go—at the same time I hope this situation improves in the future.</div><br/></div></div></div></div><div id="41076856" class="c"><input type="checkbox" id="c-41076856" checked=""/><div class="controls bullet"><span class="by">guenthert</span><span>|</span><a href="#41076622">prev</a><span>|</span><a href="#41076718">next</a><span>|</span><label class="collapse" for="c-41076856">[-]</label><label class="expand" for="c-41076856">[2 more]</label></div><br/><div class="children"><div class="content">Hmmh, under &quot;Why bcachefs?&quot; we find<p>- Stability
but also<p>- Constant refactorings<p>and later<p>&quot;Disclaimer, my personal data is stored on ZFS&quot;<p>A bit troubling, I find<p>&quot;RAID0 behavior is default when using multiple disks&quot;
never have I ever had the need for RAID0 or have I seen a customer using it.  I think it was at one time popular with gamers before SSDs became popular and cheap.<p>&quot;RAID 5&#x2F;6 (experimental)<p><pre><code>    This is referred to as erasure coding and is listed as “DO NOT USE YET”, &quot;</code></pre>
Well, you got to start somewhere, but a comparison with btrfs and ZFS seems premature.</div><br/><div id="41076893" class="c"><input type="checkbox" id="c-41076893" checked=""/><div class="controls bullet"><span class="by">GrayShade</span><span>|</span><a href="#41076856">parent</a><span>|</span><a href="#41076718">next</a><span>|</span><label class="collapse" for="c-41076893">[-]</label><label class="expand" for="c-41076893">[1 more]</label></div><br/><div class="children"><div class="content">Does it? From the btrfs docs:<p>&gt; The RAID56 feature provides striping and parity over several devices, same as the traditional RAID5&#x2F;6. There are some implementation and design deficiencies that make it unreliable for some corner cases and the feature should not be used in production, only for evaluation or testing. The power failure safety for metadata with RAID56 is not 100%.</div><br/></div></div></div></div><div id="41076718" class="c"><input type="checkbox" id="c-41076718" checked=""/><div class="controls bullet"><span class="by">xxmarkuski</span><span>|</span><a href="#41076856">prev</a><span>|</span><a href="#41076901">next</a><span>|</span><label class="collapse" for="c-41076718">[-]</label><label class="expand" for="c-41076718">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m running bcache, with lvm&#x2F;luks and xfs on top, since &gt;5 years on my desktop and it has been stable and partition manipulations, like resizes, worked without problems, albeit the tooling is not so well supported.<p>I bought new a new ssd and hdd for my desktop this year and looked into running bcachefs because it offers caching as well as native encryption and cow. I also determined that it is not production ready yet for my use case, my file system is the last thing I want to beta tester of. Investigated using bcache again, but opted to use lvm caching, as it offers better tooling and saves on one layer of block devices (with luks and btrfs on top). Performance is great and partition manipulations also worked flawless.<p>Hopefully bcachefs gains more traction and will be ready for production use, as it combines several useful features. My current setup still feels like making compromises.</div><br/></div></div><div id="41076901" class="c"><input type="checkbox" id="c-41076901" checked=""/><div class="controls bullet"><span class="by">Liftyee</span><span>|</span><a href="#41076718">prev</a><span>|</span><a href="#41076789">next</a><span>|</span><label class="collapse" for="c-41076901">[-]</label><label class="expand" for="c-41076901">[1 more]</label></div><br/><div class="children"><div class="content">An interesting analysis. I can&#x27;t stop my brain from parsing the title as &quot;B C A Chefs&quot;.</div><br/></div></div><div id="41076789" class="c"><input type="checkbox" id="c-41076789" checked=""/><div class="controls bullet"><span class="by">NKosmatos</span><span>|</span><a href="#41076901">prev</a><span>|</span><label class="collapse" for="c-41076789">[-]</label><label class="expand" for="c-41076789">[3 more]</label></div><br/><div class="children"><div class="content">Mandatory xkcd comic: <a href="https:&#x2F;&#x2F;xkcd.com&#x2F;927" rel="nofollow">https:&#x2F;&#x2F;xkcd.com&#x2F;927</a> 
(replace &quot;standards&quot; with &quot;FS&quot;)</div><br/><div id="41076918" class="c"><input type="checkbox" id="c-41076918" checked=""/><div class="controls bullet"><span class="by">_flux</span><span>|</span><a href="#41076789">parent</a><span>|</span><a href="#41076868">next</a><span>|</span><label class="collapse" for="c-41076918">[-]</label><label class="expand" for="c-41076918">[1 more]</label></div><br/><div class="children"><div class="content">The key difference is that we don&#x27;t need to agree on a certain FS, whereas the reason for standards is interoperability.<p>I have both bcachefs and ext4 filesystems on the same machine, for different uses.</div><br/></div></div><div id="41076868" class="c"><input type="checkbox" id="c-41076868" checked=""/><div class="controls bullet"><span class="by">tjoff</span><span>|</span><a href="#41076789">parent</a><span>|</span><a href="#41076918">prev</a><span>|</span><label class="collapse" for="c-41076868">[-]</label><label class="expand" for="c-41076868">[1 more]</label></div><br/><div class="children"><div class="content">Situation is different though, we have very few modern filesystems and have desperately needed some diversion and competition in this area. I&#x27;ve been waiting decades for something like bcachefs, thought it would be btrfs but that turned into a disappointment - for my needs.</div><br/></div></div></div></div></div></div></div></div></div></body></html>