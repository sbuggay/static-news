<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1711530068056" as="style"/><link rel="stylesheet" href="styles.css?v=1711530068056"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PrometheusAutomatingDNSChecks">How I would automate monitoring DNS queries in basic Prometheus</a>Â <span class="domain">(<a href="https://utcc.utoronto.ca">utcc.utoronto.ca</a>)</span></div><div class="subtext"><span>zdw</span> | <span>4 comments</span></div><br/><div><div id="39836595" class="c"><input type="checkbox" id="c-39836595" checked=""/><div class="controls bullet"><span class="by">jarofgreen</span><span>|</span><a href="#39836473">next</a><span>|</span><label class="collapse" for="c-39836595">[-]</label><label class="expand" for="c-39836595">[1 more]</label></div><br/><div class="children"><div class="content">Interesting. Our contribution to monitoring DNS is to make sure our HTTP uptime checker runs over both ipv4 AND ipv6 as separate checks. That way if we mess up our AAAA record but not our A record (or vice versa) we still get a fail. I&#x27;ve looked at some commercial SAAS uptime checkers and no-one seems to offer this as a feature - have I missed one that does?<p>The way to do this in Prometheus is to use the following settings on the blackbox module:<p><pre><code>    [ preferred_ip_protocol: &lt;string&gt; | default = &quot;ip6&quot; ]
    [ ip_protocol_fallback: &lt;boolean&gt; | default = true ]
</code></pre>
<a href="https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;blackbox_exporter&#x2F;blob&#x2F;master&#x2F;CONFIGURATION.md">https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;blackbox_exporter&#x2F;blob&#x2F;master&#x2F;...</a><p>So you need 2 modules, one for each ip version. As for automating setting these up, we deploy our Prometheus server with salt so we can use Jinja templating in all our Prometheus config files. That really cuts down on repeating boiler plate code.<p>This is also interesting for other reasons; in host downtime situations you can sometime see   they will drop one type of traffic and not the other.</div><br/></div></div><div id="39836473" class="c"><input type="checkbox" id="c-39836473" checked=""/><div class="controls bullet"><span class="by">denysvitali</span><span>|</span><a href="#39836595">prev</a><span>|</span><a href="#39836837">next</a><span>|</span><label class="collapse" for="c-39836473">[-]</label><label class="expand" for="c-39836473">[1 more]</label></div><br/><div class="children"><div class="content">I thought this was about monitoring all of the outgoing DNS queries.<p>If you&#x27;re interested in that, CoreDNS has a Prometheus exporter that lets you see how many requests you&#x27;ve made through it. You can therefore use CoreDNS as a &quot;proxy&quot; DNS to log all of your DNS queries.<p>In my case, I modified the CoreDNS code to also include the request in the exported metrics - with this you can see all of your DNS requests (over time) and see if there was something odd.</div><br/></div></div><div id="39836837" class="c"><input type="checkbox" id="c-39836837" checked=""/><div class="controls bullet"><span class="by">traceroute66</span><span>|</span><a href="#39836473">prev</a><span>|</span><label class="collapse" for="c-39836837">[-]</label><label class="expand" for="c-39836837">[1 more]</label></div><br/><div class="children"><div class="content">There is some good stuff on the utoronto blog.  But they also have stuff that is re-inventing the wheel in a worse manner. This is one of them.<p>TL;DR: Correct answer: install dnsdist infront of your DNS servers.<p>Then you get stats and query monitoring galore, with DNS  fault-tolerant load-balancing to boot.</div><br/></div></div></div></div></div></div></div></body></html>