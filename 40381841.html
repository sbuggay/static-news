<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1715936463905" as="style"/><link rel="stylesheet" href="styles.css?v=1715936463905"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://snai.pe/posts/c-smart-pointers">Smart Pointers in (GNU) C</a> <span class="domain">(<a href="https://snai.pe">snai.pe</a>)</span></div><div class="subtext"><span>indigoabstract</span> | <span>13 comments</span></div><br/><div><div id="40387090" class="c"><input type="checkbox" id="c-40387090" checked=""/><div class="controls bullet"><span class="by">sp1rit</span><span>|</span><a href="#40385844">next</a><span>|</span><label class="collapse" for="c-40387090">[-]</label><label class="expand" for="c-40387090">[1 more]</label></div><br/><div class="children"><div class="content">GLib also provides macros that use autocleanup.[0]<p>Using a bunch of macro magic, they allow you to write `g_autoptr(GPtrArray) arr = ...` to automatically unref arr when the scipe exits.
One footgun that autocleanup has and C++ smart pointers don&#x27;t is, that the cleanup function isn&#x27;t called on reassignment, so reassigning on a autoptr causes the previous value to leak.<p>[0]:<a href="https:&#x2F;&#x2F;docs.gtk.org&#x2F;glib&#x2F;auto-cleanup.html" rel="nofollow">https:&#x2F;&#x2F;docs.gtk.org&#x2F;glib&#x2F;auto-cleanup.html</a></div><br/></div></div><div id="40385844" class="c"><input type="checkbox" id="c-40385844" checked=""/><div class="controls bullet"><span class="by">naasking</span><span>|</span><a href="#40387090">prev</a><span>|</span><a href="#40386247">next</a><span>|</span><label class="collapse" for="c-40385844">[-]</label><label class="expand" for="c-40385844">[2 more]</label></div><br/><div class="children"><div class="content">&gt; This sucks, but if we make the assumption that no destruction shall happen during an async context, it’s kind of fine (Oh boy, this will definitely make people jump out of their seat). On a side note, I have yet to see a proper solution to that, and I would like to avoid having double pointed types to solve the issue – if anyone has an idea, feel free to send me a message or send a pull request on the github repository.<p>An async context marks pointers to destroy rather than destroy them immediately (defer destruction by unqueueing them), and a dedicated thread periodically wakes and processes the queue of marked objects. It must should be processed on another thread because the object is by definition no longer reachable from the original thread since it&#x27;s marked for destruction.</div><br/><div id="40386235" class="c"><input type="checkbox" id="c-40386235" checked=""/><div class="controls bullet"><span class="by">Spivak</span><span>|</span><a href="#40385844">parent</a><span>|</span><a href="#40386247">next</a><span>|</span><label class="collapse" for="c-40386235">[-]</label><label class="expand" for="c-40386235">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m assuming the OP is doing this specifically to avoid implementing a GC so I&#x27;m not sure this approach would be satisfactory, but it would work.</div><br/></div></div></div></div><div id="40386247" class="c"><input type="checkbox" id="c-40386247" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#40385844">prev</a><span>|</span><a href="#40385608">next</a><span>|</span><label class="collapse" for="c-40386247">[-]</label><label class="expand" for="c-40386247">[3 more]</label></div><br/><div class="children"><div class="content">Basically a wrapper for &quot;__attribute__(cleanup)&quot;<p>GCC took the best C++ feature (destructors) and added it into C.  Not sure about compatibility with other C compilers.</div><br/><div id="40386917" class="c"><input type="checkbox" id="c-40386917" checked=""/><div class="controls bullet"><span class="by">indigoabstract</span><span>|</span><a href="#40386247">parent</a><span>|</span><a href="#40386863">next</a><span>|</span><label class="collapse" for="c-40386917">[-]</label><label class="expand" for="c-40386917">[1 more]</label></div><br/><div class="children"><div class="content">Apparently only Clang so far.<p><a href="https:&#x2F;&#x2F;clang.llvm.org&#x2F;docs&#x2F;AttributeReference.html#cleanup" rel="nofollow">https:&#x2F;&#x2F;clang.llvm.org&#x2F;docs&#x2F;AttributeReference.html#cleanup</a></div><br/></div></div><div id="40386863" class="c"><input type="checkbox" id="c-40386863" checked=""/><div class="controls bullet"><span class="by">loeg</span><span>|</span><a href="#40386247">parent</a><span>|</span><a href="#40386917">prev</a><span>|</span><a href="#40385608">next</a><span>|</span><label class="collapse" for="c-40386863">[-]</label><label class="expand" for="c-40386863">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m fairly certain Clang also implements it.</div><br/></div></div></div></div><div id="40385608" class="c"><input type="checkbox" id="c-40385608" checked=""/><div class="controls bullet"><span class="by">variadix</span><span>|</span><a href="#40386247">prev</a><span>|</span><a href="#40383228">next</a><span>|</span><label class="collapse" for="c-40385608">[-]</label><label class="expand" for="c-40385608">[1 more]</label></div><br/><div class="children"><div class="content">Worth noting that the metadata structure can be done more efficiently with a flexible array member, but it requires alignment to alignof(max_align_t) to obey the ABI. The structure will consume the same amount of memory (16 bytes on x86-64) but you avoid a dereference and you have an extra pointer worth of space to use for whatever.</div><br/></div></div><div id="40383228" class="c"><input type="checkbox" id="c-40383228" checked=""/><div class="controls bullet"><span class="by">loeg</span><span>|</span><a href="#40385608">prev</a><span>|</span><a href="#40382883">next</a><span>|</span><label class="collapse" for="c-40383228">[-]</label><label class="expand" for="c-40383228">[1 more]</label></div><br/><div class="children"><div class="content">(2015) or earlier</div><br/></div></div><div id="40382883" class="c"><input type="checkbox" id="c-40382883" checked=""/><div class="controls bullet"><span class="by">cozzyd</span><span>|</span><a href="#40383228">prev</a><span>|</span><a href="#40382220">next</a><span>|</span><label class="collapse" for="c-40382883">[-]</label><label class="expand" for="c-40382883">[3 more]</label></div><br/><div class="children"><div class="content">it&#x27;s great when the ratio of cmake to C is close to 3...</div><br/><div id="40387561" class="c"><input type="checkbox" id="c-40387561" checked=""/><div class="controls bullet"><span class="by">sph</span><span>|</span><a href="#40382883">parent</a><span>|</span><a href="#40382220">next</a><span>|</span><label class="collapse" for="c-40387561">[-]</label><label class="expand" for="c-40387561">[2 more]</label></div><br/><div class="children"><div class="content">Why do some people hate Make so much to use an abomination like CMake? It has terrible syntax, terrible semantics, and you need to run Make anyway. I do not get it.<p>If it was noticeably better, I&#x27;d understand. Probably because it looks nice in the tutorial with apparently simple syntax, but then on real projects it devolves into a hundred lines of abstraction nonsense over environment variables and spawning programs.</div><br/><div id="40387713" class="c"><input type="checkbox" id="c-40387713" checked=""/><div class="controls bullet"><span class="by">ReleaseCandidat</span><span>|</span><a href="#40382883">root</a><span>|</span><a href="#40387561">parent</a><span>|</span><a href="#40382220">next</a><span>|</span><label class="collapse" for="c-40387713">[-]</label><label class="expand" for="c-40387713">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Why do some people hate Make so much to use an abomination like CMake?<p>Because Make doesn&#x27;t work either. This holds for Make too:<p>&gt; Probably because it looks nice in the tutorial with apparently simple syntax, but then on real projects it devolves into a hundred lines of abstraction nonsense over environment variables and spawning programs.<p>The real solution is of course using neither (and neither Automake). Pick one (that works for more than C, C++ and Fortran at best) build system and use that. I&#x27;ve choosen Buck 2 <a href="https:&#x2F;&#x2F;buck2.build&#x2F;" rel="nofollow">https:&#x2F;&#x2F;buck2.build&#x2F;</a><p><a href="https:&#x2F;&#x2F;github.com&#x2F;Release-Candidate&#x2F;Cxx-Buck2-vcpkg-Examples">https:&#x2F;&#x2F;github.com&#x2F;Release-Candidate&#x2F;Cxx-Buck2-vcpkg-Example...</a>
<a href="https:&#x2F;&#x2F;github.com&#x2F;Release-Candidate&#x2F;Cxx-Buck2-Conan-Examples">https:&#x2F;&#x2F;github.com&#x2F;Release-Candidate&#x2F;Cxx-Buck2-Conan-Example...</a></div><br/></div></div></div></div></div></div><div id="40382220" class="c"><input type="checkbox" id="c-40382220" checked=""/><div class="controls bullet"><span class="by">GGerome</span><span>|</span><a href="#40382883">prev</a><span>|</span><label class="collapse" for="c-40382220">[-]</label><label class="expand" for="c-40382220">[1 more]</label></div><br/><div class="children"><div class="content">It is time to reply to the issues that were posted since these years...</div><br/></div></div></div></div></div></div></div></body></html>