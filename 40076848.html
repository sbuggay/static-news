<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1713517254413" as="style"/><link rel="stylesheet" href="styles.css?v=1713517254413"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/facebookexperimental/hermit">Hermit is a hermetic and reproducible sandbox for running programs</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>PaulHoule</span> | <span>16 comments</span></div><br/><div><div id="40080345" class="c"><input type="checkbox" id="c-40080345" checked=""/><div class="controls bullet"><span class="by">an-unknown</span><span>|</span><a href="#40077576">next</a><span>|</span><label class="collapse" for="c-40080345">[-]</label><label class="expand" for="c-40080345">[2 more]</label></div><br/><div class="children"><div class="content">It seems like this tool does not create a fully deterministic nor reproducible environment. Hermit seems to only intercept and modify syscalls, but this is not the only source of non-determinism and randomness. For example, the layout of environment variables in memory also causes non-determinism, caused by the content of the environment variables as well as their order in memory. CPU instructions like RDTSC, RDRAND, RDSEED and similar also introduce randomness. It seems like Hermit ignores some these sources of randomness, but I can&#x27;t test it, because it doesn&#x27;t build on a current Arch system with the Rust toolchain from the repo.<p>At least it seems Hermit masks RDRAND and RDSEED via CPUID, but not every program is written to support ancient architectures which didn&#x27;t support these instructions and therefore not every program tests availability via CPUID.<p>In addition, even if all of this was deterministic, CPU flags set by various instructions with &quot;undefined&quot; flags according to the CPU manual can slightly differ between different microarchitectures. A &quot;normal&quot; program should not be influenced by this, but it is still a source of non-reproducibility. This might be relevant for certain rare compiler bugs.</div><br/><div id="40084648" class="c"><input type="checkbox" id="c-40084648" checked=""/><div class="controls bullet"><span class="by">planede</span><span>|</span><a href="#40080345">parent</a><span>|</span><a href="#40077576">next</a><span>|</span><label class="collapse" for="c-40084648">[-]</label><label class="expand" for="c-40084648">[1 more]</label></div><br/><div class="children"><div class="content">Sure, it can&#x27;t be fully deterministic. There is no easy way to work around relative timing of threads. Even if you pin everything on a single CPU, you need to be somehow deterministic about preempting and scheduling.</div><br/></div></div></div></div><div id="40077576" class="c"><input type="checkbox" id="c-40077576" checked=""/><div class="controls bullet"><span class="by">eatonphil</span><span>|</span><a href="#40080345">prev</a><span>|</span><a href="#40077131">next</a><span>|</span><label class="collapse" for="c-40077576">[-]</label><label class="expand" for="c-40077576">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a really interesting project but it hasn&#x27;t worked for non-trivial programs for me. I tried to use it on my Raft implementation. Hermit crashed with obscure (to me) error messages.<p>Others have commented on here before, it admittedly doesn&#x27;t seem to be actively maintained.<p>&gt; Just to let you know we’re not actively working on Hermit in the team<p><a href="https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;hermit&#x2F;issues&#x2F;34#issuecomment-1949510810">https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;hermit&#x2F;issues&#x2F;34#iss...</a></div><br/><div id="40079957" class="c"><input type="checkbox" id="c-40079957" checked=""/><div class="controls bullet"><span class="by">flurie</span><span>|</span><a href="#40077576">parent</a><span>|</span><a href="#40077131">next</a><span>|</span><label class="collapse" for="c-40079957">[-]</label><label class="expand" for="c-40079957">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s been my experience as well. It lacks support for certain clone(2) flags like CLONE_VFORK[1], which limits the set of non-trivial programs it can run, and since running non-trivial programs is most of the point, I haven&#x27;t revisited it since it was first announced.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;hermit&#x2F;blob&#x2F;bd3153b4bd311831b33571d523228b2d16ff039a&#x2F;detcore&#x2F;src&#x2F;syscalls&#x2F;threads.rs#L67">https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;hermit&#x2F;blob&#x2F;bd3153b4...</a></div><br/></div></div></div></div><div id="40077131" class="c"><input type="checkbox" id="c-40077131" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#40077576">prev</a><span>|</span><a href="#40080210">next</a><span>|</span><label class="collapse" for="c-40077131">[-]</label><label class="expand" for="c-40077131">[5 more]</label></div><br/><div class="children"><div class="content">I&#x27;m curious what the performance impact is like; I assume there has to be some slow down because of the interception of system calls?</div><br/><div id="40077433" class="c"><input type="checkbox" id="c-40077433" checked=""/><div class="controls bullet"><span class="by">hiatus</span><span>|</span><a href="#40077131">parent</a><span>|</span><a href="#40077479">next</a><span>|</span><label class="collapse" for="c-40077433">[-]</label><label class="expand" for="c-40077433">[2 more]</label></div><br/><div class="children"><div class="content">It uses Reverie under the hood, which itself relies on ptrace (at least for the current, sole implementation).<p>&gt; Since ptrace adds significant overhead when the guest has a syscall-heavy workload, Reverie will add similarly-significant overhead. The slowdown depends on how many syscalls are being performed and are intercepted by the tool.<p>&gt; The primary way you can improve performance with the current implementation is to implement the subscriptions callback, specifying a minimal set of syscalls that are actually required by your tool.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;reverie">https:&#x2F;&#x2F;github.com&#x2F;facebookexperimental&#x2F;reverie</a></div><br/><div id="40078501" class="c"><input type="checkbox" id="c-40078501" checked=""/><div class="controls bullet"><span class="by">mananaysiempre</span><span>|</span><a href="#40077131">root</a><span>|</span><a href="#40077433">parent</a><span>|</span><a href="#40077479">next</a><span>|</span><label class="collapse" for="c-40078501">[-]</label><label class="expand" for="c-40078501">[1 more]</label></div><br/><div class="children"><div class="content">Tangent: running old OSes (with no virtio support) under QEMU on Linux has the peculiar property that I&#x2F;O-heavy portions such as installation can run faster under TCG (JIT) than under KVM (hardware virtualization), presumably due to all the trapping. It’s a toss-up when those also include CPU-heavy parts (decompression).</div><br/></div></div></div></div><div id="40077479" class="c"><input type="checkbox" id="c-40077479" checked=""/><div class="controls bullet"><span class="by">TillE</span><span>|</span><a href="#40077131">parent</a><span>|</span><a href="#40077433">prev</a><span>|</span><a href="#40080210">next</a><span>|</span><label class="collapse" for="c-40077479">[-]</label><label class="expand" for="c-40077479">[2 more]</label></div><br/><div class="children"><div class="content">&gt; all thread executions are serialized so that there is effectively only one CPU<p>This definitely isn&#x27;t intended for general-purpose sandboxing. It&#x27;s an interesting tool for analysis and debugging.</div><br/><div id="40077627" class="c"><input type="checkbox" id="c-40077627" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#40077131">root</a><span>|</span><a href="#40077479">parent</a><span>|</span><a href="#40080210">next</a><span>|</span><label class="collapse" for="c-40077627">[-]</label><label class="expand" for="c-40077627">[1 more]</label></div><br/><div class="children"><div class="content">Ah, I had missed that it effectively forces you to one CPU. Although I already would not use it for anything but testing account of it intentionally on unrandomizing things - I suspect, for instance, that it&#x27;s unsafe to run any sort of cryptography that would create keys under this.</div><br/></div></div></div></div></div></div><div id="40080210" class="c"><input type="checkbox" id="c-40080210" checked=""/><div class="controls bullet"><span class="by">nicoty</span><span>|</span><a href="#40077131">prev</a><span>|</span><a href="#40081609">next</a><span>|</span><label class="collapse" for="c-40080210">[-]</label><label class="expand" for="c-40080210">[3 more]</label></div><br/><div class="children"><div class="content">It sounds similar to that antithesis testing service that was on front page recently as well. That also claimed to be able to run programs deterministically as well. I wonder if the two projects are related at all.</div><br/><div id="40080272" class="c"><input type="checkbox" id="c-40080272" checked=""/><div class="controls bullet"><span class="by">wwilson</span><span>|</span><a href="#40080210">parent</a><span>|</span><a href="#40081488">next</a><span>|</span><label class="collapse" for="c-40080272">[-]</label><label class="expand" for="c-40080272">[1 more]</label></div><br/><div class="children"><div class="content">Our projects have some features in common, but are pretty much unrelated. Hermit is a deterministic userland, whereas we enforce reproducibility at the hypervisor level and with the right device drivers can support any OS.<p>The most interesting part of Antithesis (to me) isn’t even the perfect reproducibility, but the autonomous state space exploration that finds the bugs in the first place. AFAIK Hermit doesn’t do that, though you might be able to get somewhere by running your program plus a conventional fuzzer under Hermit together?<p>Disclosure: I am one of the co-founders of Antithesis.</div><br/></div></div><div id="40081488" class="c"><input type="checkbox" id="c-40081488" checked=""/><div class="controls bullet"><span class="by">password4321</span><span>|</span><a href="#40080210">parent</a><span>|</span><a href="#40080272">prev</a><span>|</span><a href="#40081609">next</a><span>|</span><label class="collapse" for="c-40081488">[-]</label><label class="expand" for="c-40081488">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40068187">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40068187</a></div><br/></div></div></div></div><div id="40081609" class="c"><input type="checkbox" id="c-40081609" checked=""/><div class="controls bullet"><span class="by">tony-allan</span><span>|</span><a href="#40080210">prev</a><span>|</span><a href="#40078346">next</a><span>|</span><label class="collapse" for="c-40081609">[-]</label><label class="expand" for="c-40081609">[1 more]</label></div><br/><div class="children"><div class="content">&quot;Hermit is no longer under active development within Meta and is in maintenance mode. There is a long tail of unsupported system calls that may cause your program to fail while running under Hermit. Unfortunately, we (the team behind this project) don&#x27;t have the resources to triage issues, fix major bugs, or add features at this point in time.&quot;</div><br/></div></div><div id="40078346" class="c"><input type="checkbox" id="c-40078346" checked=""/><div class="controls bullet"><span class="by">debacle</span><span>|</span><a href="#40081609">prev</a><span>|</span><label class="collapse" for="c-40078346">[-]</label><label class="expand" for="c-40078346">[2 more]</label></div><br/><div class="children"><div class="content">What&#x27;s the difference between this and a container?</div><br/><div id="40078962" class="c"><input type="checkbox" id="c-40078962" checked=""/><div class="controls bullet"><span class="by">quadrature</span><span>|</span><a href="#40078346">parent</a><span>|</span><label class="collapse" for="c-40078962">[-]</label><label class="expand" for="c-40078962">[1 more]</label></div><br/><div class="children"><div class="content">Hermit executes your program deterministically. This means that it accounts for sources of non-determinism like thread scheduling. The idea is that you will be able to investigate executions in a fully reproducible manner.</div><br/></div></div></div></div></div></div></div></div></div></body></html>