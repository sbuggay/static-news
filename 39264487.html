<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1707210060341" as="style"/><link rel="stylesheet" href="styles.css?v=1707210060341"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.peerdb.io/reducing-bigquery-costs-by-260x">Reducing BigQuery Costs</a> <span class="domain">(<a href="https://blog.peerdb.io">blog.peerdb.io</a>)</span></div><div class="subtext"><span>cauchyk</span> | <span>25 comments</span></div><br/><div><div id="39268892" class="c"><input type="checkbox" id="c-39268892" checked=""/><div class="controls bullet"><span class="by">stairlane</span><span>|</span><a href="#39269587">next</a><span>|</span><label class="collapse" for="c-39268892">[-]</label><label class="expand" for="c-39268892">[13 more]</label></div><br/><div class="children"><div class="content">We&#x27;ve recently been struggling with BigQuery and various other GCP services (i.e. CloudRun and Pub sub) as it feels like utilizing these services can feel like a minefield of gotcha&#x27;s. With their documentation, and limits&#x2F;quotas being spread all over the place. It&#x27;s given us more problems than solutions thus far; albeit that could very well be our fault.<p>Has anybody else had this experience? Or are we just doing it wrong?<p>This is not intended to be a rant, just curious.</div><br/><div id="39269144" class="c"><input type="checkbox" id="c-39269144" checked=""/><div class="controls bullet"><span class="by">caffeinated_me</span><span>|</span><a href="#39268892">parent</a><span>|</span><a href="#39269438">next</a><span>|</span><label class="collapse" for="c-39269144">[-]</label><label class="expand" for="c-39269144">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve generally found something similar- lots of gotchas, but also some very useful products.<p>The best way I&#x27;ve found to approach it is to treat GCP as something that has to be evaluated at an individual service level. It&#x27;s great if you&#x27;re on one of their expected workflows&#x2F;golden paths, and you can get lucky with a good fit if you aren&#x27;t, but they seem to have a lot of unspoken assumptions and limits baked in that might or might not align with your use case.<p>Disclaimer: My use cases are pretty unusual from talking to our account rep, so this might be over-fitting to weird data.</div><br/></div></div><div id="39269438" class="c"><input type="checkbox" id="c-39269438" checked=""/><div class="controls bullet"><span class="by">boredemployee</span><span>|</span><a href="#39268892">parent</a><span>|</span><a href="#39269144">prev</a><span>|</span><a href="#39269585">next</a><span>|</span><label class="collapse" for="c-39269438">[-]</label><label class="expand" for="c-39269438">[7 more]</label></div><br/><div class="children"><div class="content">At the beginning of my career, I incurred some hundreds of dollars in losses with BigQuery and Google Cloud Function. The problem with these services is that they are easy and intuitive enough for a beginner to use, but a nightmare to maintain.</div><br/><div id="39272170" class="c"><input type="checkbox" id="c-39272170" checked=""/><div class="controls bullet"><span class="by">hilti</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269438">parent</a><span>|</span><a href="#39271007">next</a><span>|</span><label class="collapse" for="c-39272170">[-]</label><label class="expand" for="c-39272170">[1 more]</label></div><br/><div class="children"><div class="content">I‘ve had almost the same experience. First I was super impressed how easy it is to get data into BigQuery and retrieve it using their IDE.<p>But really soon I noticed the slow startup … simple queries took too long (1.2 sec vs milliseconds in a traditional database)<p>Then I learned a lot about BigQuery views. That helped a little.<p>At some point I simply wanted to export data. New Google tools needed to be learned: Cloud Storage, Data Flow.<p>After 18 months of using BigQuery on roughly 850 million rows, I switched back to a traditional database.</div><br/></div></div><div id="39271007" class="c"><input type="checkbox" id="c-39271007" checked=""/><div class="controls bullet"><span class="by">dharmab</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269438">parent</a><span>|</span><a href="#39272170">prev</a><span>|</span><a href="#39269650">next</a><span>|</span><label class="collapse" for="c-39271007">[-]</label><label class="expand" for="c-39271007">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m glad you learned that lesson for less than $1k. I think everyone who&#x27;s ever worked with large amounts of data in BigQuery has a story like that, and sometimes the number is six or seven digits.</div><br/><div id="39272086" class="c"><input type="checkbox" id="c-39272086" checked=""/><div class="controls bullet"><span class="by">fifilura</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39271007">parent</a><span>|</span><a href="#39269650">next</a><span>|</span><label class="collapse" for="c-39272086">[-]</label><label class="expand" for="c-39272086">[1 more]</label></div><br/><div class="children"><div class="content">Most of the time, it feels a little bit embarrassing, but the cost is just a very small part of your regular salary and overall operating cost. If your boss hits you with this, they don&#x27;t have the correct perspective and priorities.<p>My record is $20k and it raised some eyebrows. But it was not really a mistake, just a sub-optimal backfill.<p>The data was filling a need for making appropriate business decisions, and compared to all the money lost by business developers making investments on a hunch, this was a very small bump in the road.</div><br/></div></div></div></div><div id="39269650" class="c"><input type="checkbox" id="c-39269650" checked=""/><div class="controls bullet"><span class="by">winrid</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269438">parent</a><span>|</span><a href="#39271007">prev</a><span>|</span><a href="#39269585">next</a><span>|</span><label class="collapse" for="c-39269650">[-]</label><label class="expand" for="c-39269650">[3 more]</label></div><br/><div class="children"><div class="content">That&#x27;s nothing. Wait until you incur $150k of Lambda costs in a day!</div><br/><div id="39269719" class="c"><input type="checkbox" id="c-39269719" checked=""/><div class="controls bullet"><span class="by">boredemployee</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269650">parent</a><span>|</span><a href="#39269585">next</a><span>|</span><label class="collapse" for="c-39269719">[-]</label><label class="expand" for="c-39269719">[2 more]</label></div><br/><div class="children"><div class="content">Did it happen to you? sorry to hear!</div><br/><div id="39270222" class="c"><input type="checkbox" id="c-39270222" checked=""/><div class="controls bullet"><span class="by">winrid</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269719">parent</a><span>|</span><a href="#39269585">next</a><span>|</span><label class="collapse" for="c-39270222">[-]</label><label class="expand" for="c-39270222">[1 more]</label></div><br/><div class="children"><div class="content">Project ended up saving 10x that per year, so wasn&#x27;t a huge deal. Quickly rewrote it to run as a traditional server, though.</div><br/></div></div></div></div></div></div></div></div><div id="39269585" class="c"><input type="checkbox" id="c-39269585" checked=""/><div class="controls bullet"><span class="by">rdli</span><span>|</span><a href="#39268892">parent</a><span>|</span><a href="#39269438">prev</a><span>|</span><a href="#39271000">next</a><span>|</span><label class="collapse" for="c-39269585">[-]</label><label class="expand" for="c-39269585">[2 more]</label></div><br/><div class="children"><div class="content">I agree that some GCP services are better than others.<p>I’ve never used Pub&#x2F;Sub or Cloud Run, but have been quite happy with BigQuery and GKE.</div><br/><div id="39271428" class="c"><input type="checkbox" id="c-39271428" checked=""/><div class="controls bullet"><span class="by">SOLAR_FIELDS</span><span>|</span><a href="#39268892">root</a><span>|</span><a href="#39269585">parent</a><span>|</span><a href="#39271000">next</a><span>|</span><label class="collapse" for="c-39271428">[-]</label><label class="expand" for="c-39271428">[1 more]</label></div><br/><div class="children"><div class="content">BigQuery has more footguns than GKE in my experience, but that’s perhaps because I have a lot more experience with GKE and know how to avoid those footguns. To me at least it’s understandable enough to say More Nodes is More Money but completely non-straightforward to say that this query I wrote is going to scan the data in a new and expensive way. Am I doing it wrong?</div><br/></div></div></div></div><div id="39271000" class="c"><input type="checkbox" id="c-39271000" checked=""/><div class="controls bullet"><span class="by">dharmab</span><span>|</span><a href="#39268892">parent</a><span>|</span><a href="#39269585">prev</a><span>|</span><a href="#39270693">next</a><span>|</span><label class="collapse" for="c-39271000">[-]</label><label class="expand" for="c-39271000">[1 more]</label></div><br/><div class="children"><div class="content">Yes, I&#x27;ve found that you need to scrutinize the documentation, quotas, SKUs and billing statements quite closely, and you need to test everything before you run production at scale. I&#x27;ve seen unexpected billing due to an operation or resource using a different SKU than expected which didn&#x27;t qualify for an account&#x27;s discount, for example.</div><br/></div></div><div id="39270693" class="c"><input type="checkbox" id="c-39270693" checked=""/><div class="controls bullet"><span class="by">nikau</span><span>|</span><a href="#39268892">parent</a><span>|</span><a href="#39271000">prev</a><span>|</span><a href="#39269587">next</a><span>|</span><label class="collapse" for="c-39270693">[-]</label><label class="expand" for="c-39270693">[1 more]</label></div><br/><div class="children"><div class="content">Yes, try and find the pause button for a push pub sub for example...</div><br/></div></div></div></div><div id="39269587" class="c"><input type="checkbox" id="c-39269587" checked=""/><div class="controls bullet"><span class="by">coreyp_1</span><span>|</span><a href="#39268892">prev</a><span>|</span><a href="#39270461">next</a><span>|</span><label class="collapse" for="c-39269587">[-]</label><label class="expand" for="c-39269587">[6 more]</label></div><br/><div class="children"><div class="content">Rule #1. BQ is not a standard database.  If you use it like one, it will cost a fortune.<p>Rule #2. BQ is amazing for being able to churn through and analyze massive amounts of data, and can very well be the best option in some use cases.<p>Rule #3. Letting &quot;just anyone&quot; run queries is as dangerous as casually handing a credit card to your drug-addicted cousin.  Just wait until you get the bill!<p>Rule #4: Partition and cluster your data wisely.  You don&#x27;t have indexes.<p>Rule #5: Duplicate data.  Throw all of the normal forms out the window.  Storage is cheap, computation is expensive.<p>Rule #6: BQ is not meant to be used like MySQL.  It&#x27;s &quot;spin up&quot; time is too slow, but you would be hard-pressed to beat its performance on truly large data sets.<p>My perspective: One of our customers has a database growing by 17 gigs a day.  <i>One</i> of them.  There&#x27;s several on the same scale.  Yes, it&#x27;s necessary.  Another instance: One of our customers spent $8k in one month because limits were not properly placed on the account and we didn&#x27;t catch it until the bill came.  We monitor better now.  A different instance: We had a dev trying to optimize a query, and they spent $250 in queries to get the cost down from $50&#x2F;query to $15&#x2F;query.  Most of the time, though, our queries are only pennies.<p>Now that I&#x27;ve written all of this out, I feel like I need to record a video about it.  There&#x27;s not a lot of BQ info aside from the marketing fluff put out by &quot;teh Google&quot;.</div><br/><div id="39269636" class="c"><input type="checkbox" id="c-39269636" checked=""/><div class="controls bullet"><span class="by">saisrirampur</span><span>|</span><a href="#39269587">parent</a><span>|</span><a href="#39269805">next</a><span>|</span><label class="collapse" for="c-39269636">[-]</label><label class="expand" for="c-39269636">[3 more]</label></div><br/><div class="children"><div class="content">OP here. 100% agreed on your analysis. Thanks for chiming in. Coming from the Postgres world, this was very counter intuitive for me. I am still not convinced if a database should charge 1000s of $s due to lack of an index (cluster).  It could either create the index automatically or explicitly (on the face) warn the user that this can be expensive or else slow.</div><br/><div id="39270482" class="c"><input type="checkbox" id="c-39270482" checked=""/><div class="controls bullet"><span class="by">ethbr1</span><span>|</span><a href="#39269587">root</a><span>|</span><a href="#39269636">parent</a><span>|</span><a href="#39269704">next</a><span>|</span><label class="collapse" for="c-39270482">[-]</label><label class="expand" for="c-39270482">[1 more]</label></div><br/><div class="children"><div class="content">BigQuery seems to suffer from being overly internal Googly.<p>A bizarre conversation I witnessed between the BigQuery team and my company at the time (a major customer):<p>Company: &quot;We need to be able to see our consumption and a breakdown of our bill&quot;<p>BQ team: &quot;Oh, yeah. We can see how that would be useful. We should probably build that...&quot;<p>Like, this was a GA product without any thought given to self-serve billing visibility.<p>I realize billing is usually the last thing bolted on, but I&#x27;d expect some basics to be in place <i>before</i> the product ships.</div><br/></div></div><div id="39269704" class="c"><input type="checkbox" id="c-39269704" checked=""/><div class="controls bullet"><span class="by">tobad357</span><span>|</span><a href="#39269587">root</a><span>|</span><a href="#39269636">parent</a><span>|</span><a href="#39270482">prev</a><span>|</span><a href="#39269805">next</a><span>|</span><label class="collapse" for="c-39269704">[-]</label><label class="expand" for="c-39269704">[1 more]</label></div><br/><div class="children"><div class="content">We use BQ quite extensively there are a number of billing tuning options which are not that well documented.<p>1. for some it will make sense to move to pricing based on CPU time per query vs billing on scanned TB of data. This can be done through the commits in UI.<p>2. there is option to have storage billed on logical or physical bytes. If you have data with a lot of duplication (enums, customer ids etc) then physical billing can be a lot better option. Last I looked this was only available through CLI setting in dataset and you may need to ask Google to include you in their beta. 
We lowered our billing with 30% for storage.<p>I try to keep an eye on GCP release notes to find things like the physical vs logical billing.</div><br/></div></div></div></div><div id="39269805" class="c"><input type="checkbox" id="c-39269805" checked=""/><div class="controls bullet"><span class="by">ckdarby</span><span>|</span><a href="#39269587">parent</a><span>|</span><a href="#39269636">prev</a><span>|</span><a href="#39270947">next</a><span>|</span><label class="collapse" for="c-39269805">[-]</label><label class="expand" for="c-39269805">[1 more]</label></div><br/><div class="children"><div class="content">Use BQ to crunch the larger set into a smaller subset that you need and ram that into PG&#x2F;MySQL.<p>Used this to power a +$30M revenue affiliate platform tracking.</div><br/></div></div></div></div><div id="39270461" class="c"><input type="checkbox" id="c-39270461" checked=""/><div class="controls bullet"><span class="by">jojobas</span><span>|</span><a href="#39269587">prev</a><span>|</span><a href="#39270481">next</a><span>|</span><label class="collapse" for="c-39270461">[-]</label><label class="expand" for="c-39270461">[2 more]</label></div><br/><div class="children"><div class="content">So far the best solution I&#x27;ve seen to save on BigQuery costs is to deploy your own ClickHouse.<p>It has its own gotchas and quirks, but cost-wise it&#x27;s not even comparable.</div><br/><div id="39270735" class="c"><input type="checkbox" id="c-39270735" checked=""/><div class="controls bullet"><span class="by">tbragin</span><span>|</span><a href="#39270461">parent</a><span>|</span><a href="#39270481">next</a><span>|</span><label class="collapse" for="c-39270735">[-]</label><label class="expand" for="c-39270735">[1 more]</label></div><br/><div class="children"><div class="content">Disclaimer: I work at ClickHouse<p>Thank you! Glad it helped you.<p>ClickHouse is in particular well-optimized to take on real-time analytical workloads from BigQuery - both functionally and from a cost perspective.<p>For anyone wanting to try it yourself, there guide to follow when syncing or migrating workloads from BigQuery to ClickHouse, with some benchmarks and back-of-the-envelope cost comparisons:
<a href="https:&#x2F;&#x2F;clickhouse.com&#x2F;blog&#x2F;clickhouse-bigquery-migrating-data-for-realtime-queries" rel="nofollow">https:&#x2F;&#x2F;clickhouse.com&#x2F;blog&#x2F;clickhouse-bigquery-migrating-da...</a></div><br/></div></div></div></div><div id="39270481" class="c"><input type="checkbox" id="c-39270481" checked=""/><div class="controls bullet"><span class="by">garciasn</span><span>|</span><a href="#39270461">prev</a><span>|</span><label class="collapse" for="c-39270481">[-]</label><label class="expand" for="c-39270481">[3 more]</label></div><br/><div class="children"><div class="content">BQ works better and costs less with clustered and partitioned tables.<p>Who would have thought?!</div><br/><div id="39270558" class="c"><input type="checkbox" id="c-39270558" checked=""/><div class="controls bullet"><span class="by">nine_k</span><span>|</span><a href="#39270481">parent</a><span>|</span><label class="collapse" for="c-39270558">[-]</label><label class="expand" for="c-39270558">[2 more]</label></div><br/><div class="children"><div class="content">&quot;Any recent graduate can come up with an architecture better than the current one. What takes a senior engineer is to transition to a better architecture while the business is continuing to operate.&quot;</div><br/><div id="39270979" class="c"><input type="checkbox" id="c-39270979" checked=""/><div class="controls bullet"><span class="by">klodolph</span><span>|</span><a href="#39270481">root</a><span>|</span><a href="#39270558">parent</a><span>|</span><label class="collapse" for="c-39270979">[-]</label><label class="expand" for="c-39270979">[1 more]</label></div><br/><div class="children"><div class="content">And it takes a staff engineer to know which system to refactor.</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>