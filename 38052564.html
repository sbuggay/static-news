<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1698570054597" as="style"/><link rel="stylesheet" href="styles.css?v=1698570054597"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/sbcl/sbcl/blob/master/doc/internals-notes/arena-allocation.txt">Arena Allocation in SBCL</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>tmtvl</span> | <span>27 comments</span></div><br/><div><div id="38056109" class="c"><input type="checkbox" id="c-38056109" checked=""/><div class="controls bullet"><span class="by">benreesman</span><span>|</span><a href="#38054756">next</a><span>|</span><label class="collapse" for="c-38056109">[-]</label><label class="expand" for="c-38056109">[2 more]</label></div><br/><div class="children"><div class="content">Oh man, we’ve needed a rock-solid arena model in C++ forever. There’s stuff but it really needs compiler support to be clean.<p>Jai just seems to be going from strength to strength with arena-by-default.<p>The key insight is that a modern malloc isn’t terribly different from a modern GC: people seem to vastly overstate the difference IMHO.<p>Arenas are like a bumping nursery but better. I hope we keep seeing more of this.</div><br/><div id="38056499" class="c"><input type="checkbox" id="c-38056499" checked=""/><div class="controls bullet"><span class="by">alexvitkov</span><span>|</span><a href="#38056109">parent</a><span>|</span><a href="#38054756">next</a><span>|</span><label class="collapse" for="c-38056499">[-]</label><label class="expand" for="c-38056499">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t see why a language would need special support for arenas, unless it is GCed. It&#x27;s a simpler alloction model than malloc, and C++ doesn&#x27;t really have builtin support for malloc either, it just calls free() in a bunch of destructors in the STL.</div><br/></div></div></div></div><div id="38054756" class="c"><input type="checkbox" id="c-38054756" checked=""/><div class="controls bullet"><span class="by">r113500</span><span>|</span><a href="#38056109">prev</a><span>|</span><a href="#38054585">next</a><span>|</span><label class="collapse" for="c-38054756">[-]</label><label class="expand" for="c-38054756">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve been meaning to look into it, so these are mostly notes, that others might find useful,<p>arenas are x86_64 only, not sure how involved are ports, but there&#x27;s at least a VOP, that as of right now exists only on x86_64. (the build obviously fails on other systems)<p>I&#x27;m trying it on m1, so I can build with<p><pre><code>    arch -arch x86_64 sh make.sh --with-system-tlabs
</code></pre>
and then run with<p><pre><code>    arch -arch x86_64 sh run-sbcl.sh
</code></pre>
it&#x27;s pretty raw, so for example allocating object larger than arena results in ldb. there&#x27;s a lot of sample code in tests&#x2F;arena.impure.lisp<p>and the simplest possible test code just to see what&#x27;s up,<p><pre><code>    (gc :full t)
    (room)
    ;;;    7,084,208 bytes for  36,307 simple-vector objects
    (progn (make-array 10000000) (values))
    (room)
    ;;    86,991,136 bytes for  36,080 simple-vector objects
    (gc :full t)  
    ;;     6,847,824 bytes for  35,865 simple-vector objects
    (use-package :sb-vm)
    (defvar a (new-arena 100000000))
    (with-arena (a) (make-array 10000000) (values))
    (room)
    ;;     7,050,080 bytes for  36,233 simple-vector objects
</code></pre>
well, so at least we know the array is put somewhere. finally one calls (destroy-arena a), but you can still access the data, so presumably there&#x27;s no checking involved, and being undisciplined about retaining arena pointers will create all kinds of interesting bugs.<p>neat!</div><br/></div></div><div id="38054585" class="c"><input type="checkbox" id="c-38054585" checked=""/><div class="controls bullet"><span class="by">pfdietz</span><span>|</span><a href="#38054756">prev</a><span>|</span><a href="#38053890">next</a><span>|</span><label class="collapse" for="c-38054585">[-]</label><label class="expand" for="c-38054585">[6 more]</label></div><br/><div class="children"><div class="content">I&#x27;m guessing this is something they&#x27;re finding useful at Google?  Since Dougk is at Google.</div><br/><div id="38054663" class="c"><input type="checkbox" id="c-38054663" checked=""/><div class="controls bullet"><span class="by">PessimalDecimal</span><span>|</span><a href="#38054585">parent</a><span>|</span><a href="#38054640">next</a><span>|</span><label class="collapse" for="c-38054663">[-]</label><label class="expand" for="c-38054663">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, it&#x27;s even an option in the proto IDL to generate C++ code that uses arena allocation. So this is probably for protos, in particular.<p>I believe ITA Software&#x27;s QPX (which now forms a major part of Google Flights&#x27; backend) uses CL.</div><br/><div id="38056114" class="c"><input type="checkbox" id="c-38056114" checked=""/><div class="controls bullet"><span class="by">jzelinskie</span><span>|</span><a href="#38054585">root</a><span>|</span><a href="#38054663">parent</a><span>|</span><a href="#38054640">next</a><span>|</span><label class="collapse" for="c-38056114">[-]</label><label class="expand" for="c-38056114">[1 more]</label></div><br/><div class="children"><div class="content">The heavy usage of arenas for protobuf RPC allocations at Google is also I think the reason why they were experimented with in Go</div><br/></div></div></div></div><div id="38054640" class="c"><input type="checkbox" id="c-38054640" checked=""/><div class="controls bullet"><span class="by">oh_sigh</span><span>|</span><a href="#38054585">parent</a><span>|</span><a href="#38054663">prev</a><span>|</span><a href="#38053890">next</a><span>|</span><label class="collapse" for="c-38054640">[-]</label><label class="expand" for="c-38054640">[3 more]</label></div><br/><div class="children"><div class="content">Does Google use SBCL or lisp in general? News to me. I thought maybe they were just porting the arena paradigm from c++ to sbcl</div><br/><div id="38054685" class="c"><input type="checkbox" id="c-38054685" checked=""/><div class="controls bullet"><span class="by">Jtsummers</span><span>|</span><a href="#38054585">root</a><span>|</span><a href="#38054640">parent</a><span>|</span><a href="#38054696">next</a><span>|</span><label class="collapse" for="c-38054685">[-]</label><label class="expand" for="c-38054685">[1 more]</label></div><br/><div class="children"><div class="content">Google Flights came about, in particular, from the acquisition of ITA Software which was a Common Lisp shop. Much of that system is, reportedly, still in Common Lisp.</div><br/></div></div><div id="38054696" class="c"><input type="checkbox" id="c-38054696" checked=""/><div class="controls bullet"><span class="by">pfdietz</span><span>|</span><a href="#38054585">root</a><span>|</span><a href="#38054640">parent</a><span>|</span><a href="#38054685">prev</a><span>|</span><a href="#38053890">next</a><span>|</span><label class="collapse" for="c-38054696">[-]</label><label class="expand" for="c-38054696">[1 more]</label></div><br/><div class="children"><div class="content">Dougk is one of the SBCL maintainers.  I think they inherited its use from ITA Software.</div><br/></div></div></div></div></div></div><div id="38053890" class="c"><input type="checkbox" id="c-38053890" checked=""/><div class="controls bullet"><span class="by">pbohun</span><span>|</span><a href="#38054585">prev</a><span>|</span><a href="#38053649">next</a><span>|</span><label class="collapse" for="c-38053890">[-]</label><label class="expand" for="c-38053890">[2 more]</label></div><br/><div class="children"><div class="content">Are arenas internal to sbcl only or do user programs have access? The current sbcl manual (v2.3.9) doesn&#x27;t mention arenas.</div><br/><div id="38054231" class="c"><input type="checkbox" id="c-38054231" checked=""/><div class="controls bullet"><span class="by">actuallyalys</span><span>|</span><a href="#38053890">parent</a><span>|</span><a href="#38053649">next</a><span>|</span><label class="collapse" for="c-38054231">[-]</label><label class="expand" for="c-38054231">[1 more]</label></div><br/><div class="children"><div class="content">Based on the commit message [0], and the references to &quot;user code&quot; in this document, my guess is that user programs have or will have access, but it&#x27;s not finalized enough to be documented.<p>That being said, I suppose if you&#x27;re developing an internal API for a compiler&#x2F;interpreter, your &quot;users&quot; could be other parts of the project rather than language users.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;sbcl&#x2F;sbcl&#x2F;commit&#x2F;7f65522a16d857e41aa61cd0ebb0dbf026769745">https:&#x2F;&#x2F;github.com&#x2F;sbcl&#x2F;sbcl&#x2F;commit&#x2F;7f65522a16d857e41aa61cd0...</a></div><br/></div></div></div></div><div id="38053649" class="c"><input type="checkbox" id="c-38053649" checked=""/><div class="controls bullet"><span class="by">stormbeard</span><span>|</span><a href="#38053890">prev</a><span>|</span><label class="collapse" for="c-38053649">[-]</label><label class="expand" for="c-38053649">[15 more]</label></div><br/><div class="children"><div class="content">There&#x27;s not much context here that explains why this is noteworthy. Arena allocation by itself isn&#x27;t anything to write home about- is anyone able to explain why this is special?</div><br/><div id="38053777" class="c"><input type="checkbox" id="c-38053777" checked=""/><div class="controls bullet"><span class="by">carbocation</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38054113">next</a><span>|</span><label class="collapse" for="c-38053777">[-]</label><label class="expand" for="c-38053777">[1 more]</label></div><br/><div class="children"><div class="content">The standard that you&#x27;re describing is not really the standard that most HN&#x27;ers hold submissions to. The guidelines[1] suggest the following:<p>&gt; <i>On-Topic: Anything that good hackers would find interesting. That includes more than hacking and startups. If you had to reduce it to a sentence, the answer might be: anything that gratifies one&#x27;s intellectual curiosity.</i><p>1 = <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;newsguidelines.html">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;newsguidelines.html</a></div><br/></div></div><div id="38054113" class="c"><input type="checkbox" id="c-38054113" checked=""/><div class="controls bullet"><span class="by">0x69420</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38053777">prev</a><span>|</span><a href="#38053914">next</a><span>|</span><label class="collapse" for="c-38054113">[-]</label><label class="expand" for="c-38054113">[2 more]</label></div><br/><div class="children"><div class="content">someone might find a boots-on-the-ground, in-context treatment of arena allocation particularly interesting, moreso than just reading about it in the abstract on wikipedia<p>someone might have never heard of anything of the sort<p>someone might be interested to see lispers present a use case where they care about reaching down to the finer points of memory allocation in a language that typically benefits from being above that; see also the wealth of info on the garbage collector in the ocaml documentation<p>the number of users on this website who might get some sort of kick out of this link is nonzero which is the generally agreed-upon criterion for being worth posting</div><br/><div id="38054490" class="c"><input type="checkbox" id="c-38054490" checked=""/><div class="controls bullet"><span class="by">JHonaker</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054113">parent</a><span>|</span><a href="#38053914">next</a><span>|</span><label class="collapse" for="c-38054490">[-]</label><label class="expand" for="c-38054490">[1 more]</label></div><br/><div class="children"><div class="content">Based on the number of posts I’ve seen about arena allocators on here the last month or so, I’d say the audience is much higher than nonzero.</div><br/></div></div></div></div><div id="38053914" class="c"><input type="checkbox" id="c-38053914" checked=""/><div class="controls bullet"><span class="by">sshine</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38054113">prev</a><span>|</span><a href="#38054269">next</a><span>|</span><label class="collapse" for="c-38053914">[-]</label><label class="expand" for="c-38053914">[2 more]</label></div><br/><div class="children"><div class="content">Region-based allocation by itself is definitely something to write about.<p><a href="https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;Region-based_memory_management" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;Region-based_memory_manageme...</a><p>The SBCL implementation is a very self-documented example, which is helpful if you wish to make arena-based allocation available in your language.</div><br/><div id="38055160" class="c"><input type="checkbox" id="c-38055160" checked=""/><div class="controls bullet"><span class="by">mananaysiempre</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38053914">parent</a><span>|</span><a href="#38054269">next</a><span>|</span><label class="collapse" for="c-38055160">[-]</label><label class="expand" for="c-38055160">[1 more]</label></div><br/><div class="children"><div class="content">That Wikipedia article is confusing to me, because I’m really used to “region” being used to refer to type-system-level allocation tracking, Tofte&amp;Talpin style (even if the T&amp;T hope of inferring everything didn’t really work out, and the Rust tradition decided to rename the concept to “lifetimes”). “Arena” seems to be a more common term for a purely runtime construct.</div><br/></div></div></div></div><div id="38054269" class="c"><input type="checkbox" id="c-38054269" checked=""/><div class="controls bullet"><span class="by">BaculumMeumEst</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38053914">prev</a><span>|</span><a href="#38054144">next</a><span>|</span><label class="collapse" for="c-38054269">[-]</label><label class="expand" for="c-38054269">[2 more]</label></div><br/><div class="children"><div class="content">i&#x27;m not sure how it&#x27;s going to work in CL application code, but if you can re-use fixed memory and avoid runtime allocation with it like you can in C, it seems like it would be really nice for lisp game development, where avoiding GC pauses can be unintuitive or annoying</div><br/><div id="38054565" class="c"><input type="checkbox" id="c-38054565" checked=""/><div class="controls bullet"><span class="by">p_l</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054269">parent</a><span>|</span><a href="#38054144">next</a><span>|</span><label class="collapse" for="c-38054565">[-]</label><label class="expand" for="c-38054565">[1 more]</label></div><br/><div class="children"><div class="content">re-using memory is old trick in Common Lisp application code.<p>This is more &quot;create a separate arena where we can allocate a ton of stuff and then drop it without actually going through collector&quot;.<p>In fact, this is very similar to features provided in at least Symbolics Genera, which provided developer-created arenas as well.</div><br/></div></div></div></div><div id="38054144" class="c"><input type="checkbox" id="c-38054144" checked=""/><div class="controls bullet"><span class="by">neonroku</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38054269">prev</a><span>|</span><a href="#38053840">next</a><span>|</span><label class="collapse" for="c-38054144">[-]</label><label class="expand" for="c-38054144">[1 more]</label></div><br/><div class="children"><div class="content">there have been other posts related to Arena based allocation on hn recently and I was grateful because it wasn’t something I was aware of. I found this interesting - I see this post is part of a trend.</div><br/></div></div><div id="38054052" class="c"><input type="checkbox" id="c-38054052" checked=""/><div class="controls bullet"><span class="by">Hydraulix989</span><span>|</span><a href="#38053649">parent</a><span>|</span><a href="#38053840">prev</a><span>|</span><label class="collapse" for="c-38054052">[-]</label><label class="expand" for="c-38054052">[5 more]</label></div><br/><div class="children"><div class="content">Right, how is this top of HN? Something is off, as there is nothing newsworthy about this. If I submitted to HN a random documentation page from LWN or Linux kernel, it would surely not be #1.</div><br/><div id="38054273" class="c"><input type="checkbox" id="c-38054273" checked=""/><div class="controls bullet"><span class="by">mumblemumble</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054052">parent</a><span>|</span><a href="#38056783">next</a><span>|</span><label class="collapse" for="c-38054273">[-]</label><label class="expand" for="c-38054273">[2 more]</label></div><br/><div class="children"><div class="content">There&#x27;s nothing edifying about yucking other people&#x27;s yums. If many others are upvoting something, and you don&#x27;t see why it&#x27;s interesting, maybe it&#x27;s OK for the situation to be as simple as that: it&#x27;s interesting to others even though it isn&#x27;t interesting to you.<p>Also, there is absolutely no requirement that HN submissions all qualify as newsworthy. As others have pointed out in this thread, the gist of what&#x27;s considered appropriate is quite simple and broad: &quot;Anything that good hackers would find interesting.&quot;</div><br/><div id="38054761" class="c"><input type="checkbox" id="c-38054761" checked=""/><div class="controls bullet"><span class="by">smegsicle</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054273">parent</a><span>|</span><a href="#38056783">next</a><span>|</span><label class="collapse" for="c-38054761">[-]</label><label class="expand" for="c-38054761">[1 more]</label></div><br/><div class="children"><div class="content">&gt; yucking other people&#x27;s yums<p>that is gross please do not refer to sbcl memory management features as &#x27;yums&#x27;</div><br/></div></div></div></div><div id="38056783" class="c"><input type="checkbox" id="c-38056783" checked=""/><div class="controls bullet"><span class="by">varjag</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054052">parent</a><span>|</span><a href="#38054273">prev</a><span>|</span><a href="#38054319">next</a><span>|</span><label class="collapse" for="c-38056783">[-]</label><label class="expand" for="c-38056783">[1 more]</label></div><br/><div class="children"><div class="content">LWN write-ups on fairly niche subjects are regularly featured on HN front page.</div><br/></div></div><div id="38054319" class="c"><input type="checkbox" id="c-38054319" checked=""/><div class="controls bullet"><span class="by">spacechild1</span><span>|</span><a href="#38053649">root</a><span>|</span><a href="#38054052">parent</a><span>|</span><a href="#38056783">prev</a><span>|</span><label class="collapse" for="c-38054319">[-]</label><label class="expand" for="c-38054319">[1 more]</label></div><br/><div class="children"><div class="content">&gt; as there is nothing newsworthy about this<p>Since when do HN submission have to be &quot;newsworthy&quot;? People regularly post old articles.<p>&gt; If I submitted to HN a random documentation page from LWN or Linux kernel, it would surely not be #1.<p>If that page is particularly interesting and you&#x27;re lucky, why not?</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>