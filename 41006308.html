<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1721466050736" as="style"/><link rel="stylesheet" href="styles.css?v=1721466050736"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://marcan.st/2017/12/debugging-an-evil-go-runtime-bug/">Debugging an evil Go runtime bug: From heat guns to kernel compiler flags (2017)</a> <span class="domain">(<a href="https://marcan.st">marcan.st</a>)</span></div><div class="subtext"><span>goranmoomin</span> | <span>38 comments</span></div><br/><div><div id="41014762" class="c"><input type="checkbox" id="c-41014762" checked=""/><div class="controls bullet"><span class="by">Terr_</span><span>|</span><a href="#41014530">next</a><span>|</span><label class="collapse" for="c-41014762">[-]</label><label class="expand" for="c-41014762">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Over the course of 22 kernel builds, I managed to simplify the config so much that the kernel had no networking support, no filesystems, no block device core, and didn’t even support PCI (still works fine on a VM though!).<p>Flashbacks to a job where I was asked to figure out why a newer kernel was crashing. This was a very frustrating time, because I had (have) basically zero real C&#x2F;C++  experience but I&#x27;d helped out with Bitbake recipes and everyone else was busy or moved to other projects.<p>To cut a multiweek tale of dozens of recompilations short: The kernel was fine. The headless custom hardware was fine. The problem was a  hypervisor misconfiguration,  overwriting part of the kernel address space. All of our kernels have been corrupt, but this was the first one where the layout meant it mattered.<p>A month of frustration, two characters to fix, the highest ratio I&#x27;ve encountered so far.</div><br/></div></div><div id="41014530" class="c"><input type="checkbox" id="c-41014530" checked=""/><div class="controls bullet"><span class="by">umvi</span><span>|</span><a href="#41014762">prev</a><span>|</span><a href="#41007761">next</a><span>|</span><label class="collapse" for="c-41014530">[-]</label><label class="expand" for="c-41014530">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m pretty confident in my computer abilities, but when I read stuff like this I feel like I have no skills at all compared to this guy. Like I&#x27;m still a high school athlete and he&#x27;s an Olympian (also he was only 26 when he wrote the article).</div><br/></div></div><div id="41007761" class="c"><input type="checkbox" id="c-41007761" checked=""/><div class="controls bullet"><span class="by">mseepgood</span><span>|</span><a href="#41014530">prev</a><span>|</span><a href="#41012323">next</a><span>|</span><label class="collapse" for="c-41007761">[-]</label><label class="expand" for="c-41007761">[2 more]</label></div><br/><div class="children"><div class="content">(2017)
Previous discussion: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=15845118">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=15845118</a></div><br/><div id="41014353" class="c"><input type="checkbox" id="c-41014353" checked=""/><div class="controls bullet"><span class="by">rollulus</span><span>|</span><a href="#41007761">parent</a><span>|</span><a href="#41012323">next</a><span>|</span><label class="collapse" for="c-41014353">[-]</label><label class="expand" for="c-41014353">[1 more]</label></div><br/><div class="children"><div class="content">Ah, I remember 2017’s HN where the mere word “Go” in the title made posts skyrocket to 498 points. In 2024 the title should’ve contained “Rust” for the same outcome. Quite curious what will be required in 2031.</div><br/></div></div></div></div><div id="41012323" class="c"><input type="checkbox" id="c-41012323" checked=""/><div class="controls bullet"><span class="by">ncruces</span><span>|</span><a href="#41007761">prev</a><span>|</span><a href="#41010411">next</a><span>|</span><label class="collapse" for="c-41012323">[-]</label><label class="expand" for="c-41012323">[1 more]</label></div><br/><div class="children"><div class="content">Related (for the hash based bisecting):
<a href="https:&#x2F;&#x2F;research.swtch.com&#x2F;bisect" rel="nofollow">https:&#x2F;&#x2F;research.swtch.com&#x2F;bisect</a></div><br/></div></div><div id="41010411" class="c"><input type="checkbox" id="c-41010411" checked=""/><div class="controls bullet"><span class="by">wolf550e</span><span>|</span><a href="#41012323">prev</a><span>|</span><a href="#41008620">next</a><span>|</span><label class="collapse" for="c-41010411">[-]</label><label class="expand" for="c-41010411">[1 more]</label></div><br/><div class="children"><div class="content">You can follow Hector Martin @marcan at <a href="https:&#x2F;&#x2F;social.treehouse.systems&#x2F;@marcan&#x2F;" rel="nofollow">https:&#x2F;&#x2F;social.treehouse.systems&#x2F;@marcan&#x2F;</a><p>He works on Asahi Linux, a Linux port to arm64 Apple hardware.</div><br/></div></div><div id="41008620" class="c"><input type="checkbox" id="c-41008620" checked=""/><div class="controls bullet"><span class="by">BobbyJo</span><span>|</span><a href="#41010411">prev</a><span>|</span><a href="#41010546">next</a><span>|</span><label class="collapse" for="c-41008620">[-]</label><label class="expand" for="c-41008620">[22 more]</label></div><br/><div class="children"><div class="content">This is honestly wild. 99% of devs would have found a work around and moved on. Going so far as to create a multi-kernel test bench to narrow down the source of the instability is a level of dedication I have not personally seen, and I respect it.</div><br/><div id="41011013" class="c"><input type="checkbox" id="c-41011013" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#41008620">parent</a><span>|</span><a href="#41009990">next</a><span>|</span><label class="collapse" for="c-41011013">[-]</label><label class="expand" for="c-41011013">[1 more]</label></div><br/><div class="children"><div class="content">Problems like this tend to come back and haunt you though. Sure, you can set max threads to 1 and move on with what you&#x27;re doing for a while... but a lot of people run Go so they can have a lot more than 1 thread.<p>I&#x27;ve run into some of these where it&#x27;s a lot more rare to hit, and so then it&#x27;s reasonable to not do the thing that hurts, but watch out for it in the future. Sometimes you get lucky and it magically fixes itself forever; sometimes the weird case that you only hit with internal traffic ends up getting hit by public tratfic a lot.<p>Crashes like this where a wild write breaks something at a distance are always a PITA to debug (especially here, where the wild write is harmless if there&#x27;s no data race)</div><br/></div></div><div id="41009990" class="c"><input type="checkbox" id="c-41009990" checked=""/><div class="controls bullet"><span class="by">abbbi</span><span>|</span><a href="#41008620">parent</a><span>|</span><a href="#41011013">prev</a><span>|</span><a href="#41009274">next</a><span>|</span><label class="collapse" for="c-41009990">[-]</label><label class="expand" for="c-41009990">[1 more]</label></div><br/><div class="children"><div class="content">Marcan is an beast, this guy really loves to go down the rabbit holes.</div><br/></div></div><div id="41009274" class="c"><input type="checkbox" id="c-41009274" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#41008620">parent</a><span>|</span><a href="#41009990">prev</a><span>|</span><a href="#41010546">next</a><span>|</span><label class="collapse" for="c-41009274">[-]</label><label class="expand" for="c-41009274">[19 more]</label></div><br/><div class="children"><div class="content">By the same token, you might be the first person I have ever seen give respect to the 1x developer. I respect that. We could no doubt all learn a thing or two from the 1x developer that doesn&#x27;t rush through everything with quick solutions.</div><br/><div id="41010015" class="c"><input type="checkbox" id="c-41010015" checked=""/><div class="controls bullet"><span class="by">sanbor</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41009274">parent</a><span>|</span><a href="#41014339">next</a><span>|</span><label class="collapse" for="c-41010015">[-]</label><label class="expand" for="c-41010015">[14 more]</label></div><br/><div class="children"><div class="content">If you check the issue[1] he reported the crash on November 7th and reported the issue is related to gcc and the kernel on November 8th. At least he was very quick going through the rabbit hole.<p>[1]: <a href="https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;issues&#x2F;730">https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;issues&#x2F;730</a></div><br/><div id="41010176" class="c"><input type="checkbox" id="c-41010176" checked=""/><div class="controls bullet"><span class="by">BobbyJo</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010015">parent</a><span>|</span><a href="#41010104">next</a><span>|</span><label class="collapse" for="c-41010176">[-]</label><label class="expand" for="c-41010176">[1 more]</label></div><br/><div class="children"><div class="content">From the outside looking in, that&#x27;s mind blowing.</div><br/></div></div><div id="41010104" class="c"><input type="checkbox" id="c-41010104" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010015">parent</a><span>|</span><a href="#41010176">prev</a><span>|</span><a href="#41014339">next</a><span>|</span><label class="collapse" for="c-41010104">[-]</label><label class="expand" for="c-41010104">[12 more]</label></div><br/><div class="children"><div class="content">Seems about right. As a lowly developer with 10x tendencies, I&#x27;m not sure I have ever spent more than an hour solving a problem. I&#x27;ll just apply the quick hack that addresses the immediate concern and move on. Frankly, I don&#x27;t have the attention span to dive in like this guy has. Which, mathematically, means that a 1x developer will take around 10 hours to get to the same place (no doubt with a better solution, as demonstrated here), which is approximately in line with your findings.<p>Respect to the talent that can pull off 1x greatness. Something for us weak 10x developers to strive towards.</div><br/><div id="41010772" class="c"><input type="checkbox" id="c-41010772" checked=""/><div class="controls bullet"><span class="by">gouggoug</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010104">parent</a><span>|</span><a href="#41010380">next</a><span>|</span><label class="collapse" for="c-41010772">[-]</label><label class="expand" for="c-41010772">[9 more]</label></div><br/><div class="children"><div class="content">&gt; means that a 1x developer will take around 10 hours to get to the same place<p>A &quot;workaround&quot; isn&#x27;t an adequate substitute for actual the understanding and fixing of the root cause of a bug.<p>What you think is a 10x developer is, in fact, a short-term 10x developer, medium-term 1x developer, long-term -10x developer. Their work while seemingly great at first is just accrued debt with an incredibly high interest rate. But they&#x27;re rarely the ones fixing it.<p>Now, like everything, a balance needs to be struck between spending hours fixing a bug _the right way_, or, finding a temporary workaround. The real 10x developer is incredibly good at finding this balance.</div><br/><div id="41010898" class="c"><input type="checkbox" id="c-41010898" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010772">parent</a><span>|</span><a href="#41010380">next</a><span>|</span><label class="collapse" for="c-41010898">[-]</label><label class="expand" for="c-41010898">[8 more]</label></div><br/><div class="children"><div class="content"><i>&gt; A &quot;workaround&quot; isn&#x27;t an adequate substitute for actual the understanding and fixing of the root cause of a bug.</i><p>Right, hence why we recognize that a 10x developer is a weaker developer. Was there something that implied that a weak developer is a substitute for a talented developer for you to say this, or are you just pulling words out of thin air?</div><br/><div id="41013310" class="c"><input type="checkbox" id="c-41013310" checked=""/><div class="controls bullet"><span class="by">kragen</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010898">parent</a><span>|</span><a href="#41011738">next</a><span>|</span><label class="collapse" for="c-41013310">[-]</label><label class="expand" for="c-41013310">[4 more]</label></div><br/><div class="children"><div class="content">&#x27;a weaker developer&#x27; is the opposite of the standard definition of &#x27;a 10x developer&#x27;.  if you are going to use phrases to mean the opposite of their conventional meaning you should warn people so they can avoid arguing with you on the assumption that you&#x27;re using them to mean what everyone else uses them to mean</div><br/><div id="41013927" class="c"><input type="checkbox" id="c-41013927" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41013310">parent</a><span>|</span><a href="#41011738">next</a><span>|</span><label class="collapse" for="c-41013927">[-]</label><label class="expand" for="c-41013927">[3 more]</label></div><br/><div class="children"><div class="content">Why should I do that? An &quot;argument&quot; about nothing is hilarious.</div><br/><div id="41014310" class="c"><input type="checkbox" id="c-41014310" checked=""/><div class="controls bullet"><span class="by">samatman</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41013927">parent</a><span>|</span><a href="#41011738">next</a><span>|</span><label class="collapse" for="c-41014310">[-]</label><label class="expand" for="c-41014310">[2 more]</label></div><br/><div class="children"><div class="content">&gt; <i>Why should I do that?</i><p>Because what you chose to do instead is exceptionally obnoxious behavior, which degrades the quality of discourse on this site.</div><br/><div id="41015104" class="c"><input type="checkbox" id="c-41015104" checked=""/><div class="controls bullet"><span class="by">kragen</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41014310">parent</a><span>|</span><a href="#41011738">next</a><span>|</span><label class="collapse" for="c-41015104">[-]</label><label class="expand" for="c-41015104">[1 more]</label></div><br/><div class="children"><div class="content">agreed, thanks</div><br/></div></div></div></div></div></div></div></div><div id="41011738" class="c"><input type="checkbox" id="c-41011738" checked=""/><div class="controls bullet"><span class="by">gouggoug</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010898">parent</a><span>|</span><a href="#41013310">prev</a><span>|</span><a href="#41010380">next</a><span>|</span><label class="collapse" for="c-41011738">[-]</label><label class="expand" for="c-41011738">[3 more]</label></div><br/><div class="children"><div class="content">Merely arguing about your _definition_ of 10x engineer and 1x engineer.<p>Your original comment at the top of the thread implies the engineer who wrote the blog post is a 1x engineer because they spent so much time finding and fixing this bug.</div><br/><div id="41012261" class="c"><input type="checkbox" id="c-41012261" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41011738">parent</a><span>|</span><a href="#41010380">next</a><span>|</span><label class="collapse" for="c-41012261">[-]</label><label class="expand" for="c-41012261">[2 more]</label></div><br/><div class="children"><div class="content">Yes, and as the comment before it asserts, most engineers would never take that kind of time. They&#x27;d bang out some workaround as quickly as possible and move on with life.<p>But my original comment at the top also praised the value of the 1x engineer; noting that the rest of us could learn a thing or two from them. There is no denying that 1x developers are the better developers.<p>The question remains outstanding: Where did you pick up the suggestion that the quick fix is a suitable replacement for the talented engineers who can fully understand a problem that prompted the rebuttal?</div><br/><div id="41013161" class="c"><input type="checkbox" id="c-41013161" checked=""/><div class="controls bullet"><span class="by">gouggoug</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41012261">parent</a><span>|</span><a href="#41010380">next</a><span>|</span><label class="collapse" for="c-41013161">[-]</label><label class="expand" for="c-41013161">[1 more]</label></div><br/><div class="children"><div class="content">Guess I misinterpreted your comment ¯\_(ツ)_&#x2F;¯, relax.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="41010380" class="c"><input type="checkbox" id="c-41010380" checked=""/><div class="controls bullet"><span class="by">prerok</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010104">parent</a><span>|</span><a href="#41010772">prev</a><span>|</span><a href="#41010572">next</a><span>|</span><label class="collapse" for="c-41010380">[-]</label><label class="expand" for="c-41010380">[1 more]</label></div><br/><div class="children"><div class="content">Emm, 10x developer is a myth. The real 10x developer is the one that creates such an infrastructure&#x2F;libraries&#x2F;culture that enables 10 other engineers to move fast. The 10x developer is not the person that is 10x faster than other developers on the code base simply because they can hold the spaghetti code they wrote in their head.</div><br/></div></div></div></div></div></div><div id="41014339" class="c"><input type="checkbox" id="c-41014339" checked=""/><div class="controls bullet"><span class="by">silisili</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41009274">parent</a><span>|</span><a href="#41010015">prev</a><span>|</span><a href="#41010602">next</a><span>|</span><label class="collapse" for="c-41014339">[-]</label><label class="expand" for="c-41014339">[1 more]</label></div><br/><div class="children"><div class="content">I believe the 10x developer thing is stupid, and based on perspective.  Watching someone work faster than you doesn&#x27;t mean they are doing better work, and on the other hand could mean perhaps you are maybe a 1&#x2F;10th developer.<p>That said, if a 10x developer does exist, Marcan is one of the few of them.  What a ridiculous statement.</div><br/></div></div><div id="41010602" class="c"><input type="checkbox" id="c-41010602" checked=""/><div class="controls bullet"><span class="by">eikenberry</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41009274">parent</a><span>|</span><a href="#41014339">prev</a><span>|</span><a href="#41010546">next</a><span>|</span><label class="collapse" for="c-41010602">[-]</label><label class="expand" for="c-41010602">[3 more]</label></div><br/><div class="children"><div class="content">Is the 10x thing really only about speed? I would say this guy is a perfect 10x example as he actually gets to the root cause of a difficult problem. When I think of 1x (or less) devs they are usually the type that don&#x27;t get things done because they can&#x27;t (without a lot of help), not because they are slow. I.E. overall technical chops, not just speed.</div><br/><div id="41012796" class="c"><input type="checkbox" id="c-41012796" checked=""/><div class="controls bullet"><span class="by">Dylan16807</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41010602">parent</a><span>|</span><a href="#41010546">next</a><span>|</span><label class="collapse" for="c-41012796">[-]</label><label class="expand" for="c-41012796">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Is the 10x thing really only about speed?<p>As long as they&#x27;re moderately competent, yes.  They need to know how to debug normal things, but they don&#x27;t need to handle every esoteric niche.  The thing that matters is ability to put out tons of productive code.<p>Often that means a speciality where they&#x27;re an expert, but it doesn&#x27;t have to mean that.<p>&gt; When I think of 1x (or less) devs they are usually the type that don&#x27;t get things done because they can&#x27;t (without a lot of help), not because they are slow. I.E. overall technical chops, not just speed.<p>It sounds like you&#x27;re taking &quot;1x&quot; as a dismissal.  Isn&#x27;t it supposed to be a pretty ordinary dev?</div><br/><div id="41013792" class="c"><input type="checkbox" id="c-41013792" checked=""/><div class="controls bullet"><span class="by">eikenberry</span><span>|</span><a href="#41008620">root</a><span>|</span><a href="#41012796">parent</a><span>|</span><a href="#41010546">next</a><span>|</span><label class="collapse" for="c-41013792">[-]</label><label class="expand" for="c-41013792">[1 more]</label></div><br/><div class="children"><div class="content">Yeah... didn&#x27;t mean the 1x as dismissively as it came off. Got to carried away with my point. My mistake.<p>But to my original point, I just don&#x27;t buy the 10X story as being <i>only</i> how fast you write code. I&#x27;ve known developers who designed and wrote such that much time was saved working with that code in the future. These people are, IMO, much more deserving of the 10x moniker as maintaining code is much more important that just cranking it out... with the only possible exception being early stage startup (but not really as they will be crippled in the next stage).</div><br/></div></div></div></div></div></div></div></div></div></div><div id="41010546" class="c"><input type="checkbox" id="c-41010546" checked=""/><div class="controls bullet"><span class="by">Thaxll</span><span>|</span><a href="#41008620">prev</a><span>|</span><a href="#41011567">next</a><span>|</span><label class="collapse" for="c-41010546">[-]</label><label class="expand" for="c-41010546">[2 more]</label></div><br/><div class="children"><div class="content">One thing I learned from that post back then is that you can instruct Grub to ignore some part of your physical memory. Really nice trick, not sure this is doable on Windows &#x2F; Mac?</div><br/><div id="41014130" class="c"><input type="checkbox" id="c-41014130" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#41010546">parent</a><span>|</span><a href="#41011567">next</a><span>|</span><label class="collapse" for="c-41014130">[-]</label><label class="expand" for="c-41014130">[1 more]</label></div><br/><div class="children"><div class="content">I was just looking at the bcdedit options earlier today, this is doable on Windows</div><br/></div></div></div></div><div id="41011567" class="c"><input type="checkbox" id="c-41011567" checked=""/><div class="controls bullet"><span class="by">Agingcoder</span><span>|</span><a href="#41010546">prev</a><span>|</span><a href="#41014249">next</a><span>|</span><label class="collapse" for="c-41011567">[-]</label><label class="expand" for="c-41011567">[1 more]</label></div><br/><div class="children"><div class="content">This is very elegant. I’ve had my share of nasty system bugs ( compilers and kernels ) , but the dedication and the speed with which he went through it is quite remarkable.<p>The explanations are also very clear. Thanks for posting.</div><br/></div></div><div id="41014249" class="c"><input type="checkbox" id="c-41014249" checked=""/><div class="controls bullet"><span class="by">fulafel</span><span>|</span><a href="#41011567">prev</a><span>|</span><a href="#41010163">next</a><span>|</span><label class="collapse" for="c-41014249">[-]</label><label class="expand" for="c-41014249">[1 more]</label></div><br/><div class="children"><div class="content">I guess Gentoo Hardened meant the difficulty level in this case.</div><br/></div></div><div id="41010163" class="c"><input type="checkbox" id="c-41010163" checked=""/><div class="controls bullet"><span class="by">im3w1l</span><span>|</span><a href="#41014249">prev</a><span>|</span><a href="#41012578">next</a><span>|</span><label class="collapse" for="c-41010163">[-]</label><label class="expand" for="c-41010163">[4 more]</label></div><br/><div class="children"><div class="content">I feel like I still didnt fully understand what&#x27;s going on here. Is the following correct? &quot;Threads hava a &#x27;canonical&#x27; stack that the OS auto-grows for you as you use more of it. But you can also create your own stack by putting any value you want in RSP. This is what the Go program did, and the vDSO, assuming it ran on an auto-growing stack, tried to probe it, which lead to corruption.&quot;</div><br/><div id="41010948" class="c"><input type="checkbox" id="c-41010948" checked=""/><div class="controls bullet"><span class="by">derefr</span><span>|</span><a href="#41010163">parent</a><span>|</span><a href="#41014604">next</a><span>|</span><label class="collapse" for="c-41010948">[-]</label><label class="expand" for="c-41010948">[1 more]</label></div><br/><div class="children"><div class="content">I believe that Golang, as a green-threaded runtime, is allocating a separate carrier thread for running syscalls on, so that a blocking syscall won’t block the green-threads. These syscall carrier threads are allocated with a distinct initial stack size + stack size limit than green-thread-scheduler carrier threads are, because it’s expected that syscalls will always just enter kernel code (which has its own stack.)<p>But vDSOs don’t enter the kernel. They just run as userland code; and so they depend on the userland allocated stack to be arbitrarily deep in a way that kernel calls don’t.<p>As shown in the article, Golang seems to have code specifically for dealing with vDSO-type pseudo-syscalls — but this is likely a specialization of the pre-existing syscall-carrier-thread allocation code, and so started off with a bad assumption about how much stack should be allocated for the created threads.<p>(I should also point out that the OS stack size specified in the ELF executable headers, only guarantees the stack size of the initial thread of a process created by exec(2). All further threads get their stacks allocated explicitly in userland code by libpthreads or the like calling malloc(2). Normally these abstractions just reuse the same config params from the executable (unless you override them, using e.g. pthreads_attr_setstacksize). But, as the article says, Golang implements its own support for things like this, and so can implement special thread-allocation strategies per carrier thread type.)</div><br/></div></div><div id="41014604" class="c"><input type="checkbox" id="c-41014604" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#41010163">parent</a><span>|</span><a href="#41010948">prev</a><span>|</span><a href="#41010988">next</a><span>|</span><label class="collapse" for="c-41014604">[-]</label><label class="expand" for="c-41014604">[1 more]</label></div><br/><div class="children"><div class="content">The problem is that the vDSO (which is compiled as part of the kernel but runs in userspace) does a stack probe for security reasons, trying to see if it will overrun the stack. It does this by checking if at least a page’s worth of data is accessible. If not, it will (typically) fault. However, Go programs use a stack size so small that they may have other data a page away, which means the problem may mess with that data and cause bad things to happen.</div><br/></div></div><div id="41010988" class="c"><input type="checkbox" id="c-41010988" checked=""/><div class="controls bullet"><span class="by">jeffbee</span><span>|</span><a href="#41010163">parent</a><span>|</span><a href="#41014604">prev</a><span>|</span><a href="#41012578">next</a><span>|</span><label class="collapse" for="c-41010988">[-]</label><label class="expand" for="c-41010988">[1 more]</label></div><br/><div class="children"><div class="content">Thread stacks in Linux are demand-paged: if you touch the next page then it magically exists, up to a limit. But the machine is not concerned with the convenient properties of this virtual memory area. To the CPU the register RSP is just an operand, expressed or implied, to some instructions.</div><br/></div></div></div></div></div></div></div></div></div></body></html>