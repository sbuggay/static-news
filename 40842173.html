<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1719824481844" as="style"/><link rel="stylesheet" href="styles.css?v=1719824481844"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://maskray.me/blog/2024-06-30-integrated-assembler-improvements-in-llvm-19">Integrated assembler improvements in LLVM 19</a>Â <span class="domain">(<a href="https://maskray.me">maskray.me</a>)</span></div><div class="subtext"><span>MaskRay</span> | <span>7 comments</span></div><br/><div><div id="40843316" class="c"><input type="checkbox" id="c-40843316" checked=""/><div class="controls bullet"><span class="by">aengelke</span><span>|</span><a href="#40843463">next</a><span>|</span><label class="collapse" for="c-40843316">[-]</label><label class="expand" for="c-40843316">[1 more]</label></div><br/><div class="children"><div class="content">Nice summary! Additional changes I have planned:<p>- Removing per-instruction timers, which add a measurable overhead even when disabled (<a href="https:&#x2F;&#x2F;github.com&#x2F;llvm&#x2F;llvm-project&#x2F;pull&#x2F;97046">https:&#x2F;&#x2F;github.com&#x2F;llvm&#x2F;llvm-project&#x2F;pull&#x2F;97046</a>)<p>- Splitting AsmPrinterHandler (used for unwind info) and DebugHandler (used also for per-instruction location information) to avoid two virtual function calls per instruction (<a href="https:&#x2F;&#x2F;github.com&#x2F;llvm&#x2F;llvm-project&#x2F;pull&#x2F;96785">https:&#x2F;&#x2F;github.com&#x2F;llvm&#x2F;llvm-project&#x2F;pull&#x2F;96785</a>)<p>- Remove several maps from ELFObjectWriter, including some std::map (changed locally, need to make PR)<p>- Faster section allocation, remove ELF &quot;mergeable section info&quot; hash maps (although this is called just ~40 times per object file, it is very measurable in JIT use cases when compiling many small objects) (planned)<p>- X86 encoding in general; this consumes quite some time and looks very inefficient -- having written my own x86 encoder, I&#x27;m confident that there&#x27;s a lot of improvement potential. (not started)<p>Some takeaways on a higher level -- most of these aren&#x27;t really surprising, but nonetheless are very frequent problems(&#x2F;patterns) in the LLVM code base:<p>- Maps&#x2F;hash maps&#x2F;sets are quite expensive when used frequently, and sometimes can be easily avoided, e.g., with a vector or, for pointer keys, a pointer dereference<p>- Virtual functions(&#x2F;abstraction) calls comes at a cost, especially when done frequently<p>- raw_svector_ostream is slow, because writes are virtual function calls and don&#x27;t get inlined (I previously replaced raw_svector_ostream with a SmallVector&amp;: <a href="https:&#x2F;&#x2F;reviews.llvm.org&#x2F;D145792" rel="nofollow">https:&#x2F;&#x2F;reviews.llvm.org&#x2F;D145792</a>)<p>- Frequent heap allocations are costly, especially with glibc&#x27;s malloc<p>- Many small inefficiencies add up (=&gt; many small improvements do, too)</div><br/></div></div><div id="40843463" class="c"><input type="checkbox" id="c-40843463" checked=""/><div class="controls bullet"><span class="by">brcmthrowaway</span><span>|</span><a href="#40843316">prev</a><span>|</span><a href="#40842992">next</a><span>|</span><label class="collapse" for="c-40843463">[-]</label><label class="expand" for="c-40843463">[3 more]</label></div><br/><div class="children"><div class="content">Any AI enhancements?</div><br/><div id="40843612" class="c"><input type="checkbox" id="c-40843612" checked=""/><div class="controls bullet"><span class="by">superb_dev</span><span>|</span><a href="#40843463">parent</a><span>|</span><a href="#40843496">next</a><span>|</span><label class="collapse" for="c-40843612">[-]</label><label class="expand" for="c-40843612">[1 more]</label></div><br/><div class="children"><div class="content">Finally, LLVM can hallucinate brand new instruction sets</div><br/></div></div><div id="40843496" class="c"><input type="checkbox" id="c-40843496" checked=""/><div class="controls bullet"><span class="by">Smaug123</span><span>|</span><a href="#40843463">parent</a><span>|</span><a href="#40843612">prev</a><span>|</span><a href="#40842992">next</a><span>|</span><label class="collapse" for="c-40843496">[-]</label><label class="expand" for="c-40843496">[1 more]</label></div><br/><div class="children"><div class="content">Did you have anything in mind? I must say, &quot;we added LLMs to LLVM&quot; is a scenario that fills me with horror.</div><br/></div></div></div></div><div id="40842992" class="c"><input type="checkbox" id="c-40842992" checked=""/><div class="controls bullet"><span class="by">matrix_overload</span><span>|</span><a href="#40843463">prev</a><span>|</span><label class="collapse" for="c-40842992">[-]</label><label class="expand" for="c-40842992">[2 more]</label></div><br/><div class="children"><div class="content">TLDR: building projects with Clang is now about 4% faster due to optimizations in the way it internally handles assembly.</div><br/><div id="40843196" class="c"><input type="checkbox" id="c-40843196" checked=""/><div class="controls bullet"><span class="by">JonChesterfield</span><span>|</span><a href="#40842992">parent</a><span>|</span><label class="collapse" for="c-40843196">[-]</label><label class="expand" for="c-40843196">[1 more]</label></div><br/><div class="children"><div class="content">Perhaps more important, someone is going through MC and simplifying it. Decent chance that&#x27;s a net reduction in bugs as well.</div><br/></div></div></div></div></div></div></div></div></div></body></html>