<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1717578075940" as="style"/><link rel="stylesheet" href="styles.css?v=1717578075940"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://domm.plix.at/perl/2024_06_chopping_utf8.html">How to chop off bytes of an UTF-8 string to fit into a small slot and look nice</a> <span class="domain">(<a href="https://domm.plix.at">domm.plix.at</a>)</span></div><div class="subtext"><span>domm</span> | <span>13 comments</span></div><br/><div><div id="40581738" class="c"><input type="checkbox" id="c-40581738" checked=""/><div class="controls bullet"><span class="by">re</span><span>|</span><a href="#40582661">next</a><span>|</span><label class="collapse" for="c-40581738">[-]</label><label class="expand" for="c-40581738">[6 more]</label></div><br/><div class="children"><div class="content">Further reading:<p>* <a href="https:&#x2F;&#x2F;hoytech.github.io&#x2F;truncate-presentation&#x2F;" rel="nofollow">https:&#x2F;&#x2F;hoytech.github.io&#x2F;truncate-presentation&#x2F;</a> &#x2F; <a href="https:&#x2F;&#x2F;metacpan.org&#x2F;pod&#x2F;Unicode::Truncate" rel="nofollow">https:&#x2F;&#x2F;metacpan.org&#x2F;pod&#x2F;Unicode::Truncate</a><p>* <a href="https:&#x2F;&#x2F;unicode.org&#x2F;reports&#x2F;tr29&#x2F;#Grapheme_Cluster_Boundaries" rel="nofollow">https:&#x2F;&#x2F;unicode.org&#x2F;reports&#x2F;tr29&#x2F;#Grapheme_Cluster_Boundarie...</a><p>Truncating at codepoint boundaries at least avoids generating invalid (non-UTF-8) strings, but can still result in confusing or incorrect displays for human readers, so for best results the truncation algorithm should take extended grapheme clusters into account, which are probably the closest thing that Unicode has to what most people think of as &quot;characters&quot;.</div><br/><div id="40581800" class="c"><input type="checkbox" id="c-40581800" checked=""/><div class="controls bullet"><span class="by">iforgotpassword</span><span>|</span><a href="#40581738">parent</a><span>|</span><a href="#40582289">next</a><span>|</span><label class="collapse" for="c-40581800">[-]</label><label class="expand" for="c-40581800">[4 more]</label></div><br/><div class="children"><div class="content">To avoid this and a bunch of other confusion, when accepting user input I recommend normalizing it to the composed form before writing to a DB or file. While unicode-aware tools and software should handle either form just fine, you probably want to avoid that there&#x27;s something in the pipeline somewhere that treats the decomposed and composed form of the same string as different.</div><br/><div id="40582811" class="c"><input type="checkbox" id="c-40582811" checked=""/><div class="controls bullet"><span class="by">magicalhippo</span><span>|</span><a href="#40581738">root</a><span>|</span><a href="#40581800">parent</a><span>|</span><a href="#40581911">next</a><span>|</span><label class="collapse" for="c-40582811">[-]</label><label class="expand" for="c-40582811">[1 more]</label></div><br/><div class="children"><div class="content">How does that affect filenames?<p>IIRC the lower levels of Windows will happily work with filenames that are not valid Unicode strings, for example if you use the kernel API rather than Win32.<p>But what about Win32? If you create a file before normalization and then open it using the normalized  form, will it open the same file or return file not found?<p>What about other systems? For example AWS&#x27; S3 allows UTF-8 keys, with no mention of normalization[1].<p>On the phone so can&#x27;t try myself right now.<p>Anyway for general text I agree, but for identifiers, filenames and such I prefer to treat them as opaquely as possible.<p>[1]: <a href="https:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AmazonS3&#x2F;latest&#x2F;userguide&#x2F;object-keys.html" rel="nofollow">https:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AmazonS3&#x2F;latest&#x2F;userguide&#x2F;object...</a></div><br/></div></div><div id="40581911" class="c"><input type="checkbox" id="c-40581911" checked=""/><div class="controls bullet"><span class="by">arp242</span><span>|</span><a href="#40581738">root</a><span>|</span><a href="#40581800">parent</a><span>|</span><a href="#40582811">prev</a><span>|</span><a href="#40582289">next</a><span>|</span><label class="collapse" for="c-40581911">[-]</label><label class="expand" for="c-40581911">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s good advice to normalise to pre-composed form, but that doesn&#x27;t solve the problem the previous poster mentioned as not everything exists as a composed form. That said: <i>most</i> things do have a composed form, so you can probably get away with it – right up to when you can&#x27;t.</div><br/><div id="40582219" class="c"><input type="checkbox" id="c-40582219" checked=""/><div class="controls bullet"><span class="by">quink</span><span>|</span><a href="#40581738">root</a><span>|</span><a href="#40581911">parent</a><span>|</span><a href="#40582289">next</a><span>|</span><label class="collapse" for="c-40582219">[-]</label><label class="expand" for="c-40582219">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, working an a library system our path was to compose everything (taking into account of course that the octet sizes specified in the directory may or may not actually be accurate depending on whatever system produced the record) and around the same time deprecate any pretense we had of supporting MARC-8.</div><br/></div></div></div></div></div></div><div id="40582289" class="c"><input type="checkbox" id="c-40582289" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#40581738">parent</a><span>|</span><a href="#40581800">prev</a><span>|</span><a href="#40582661">next</a><span>|</span><label class="collapse" for="c-40582289">[-]</label><label class="expand" for="c-40582289">[1 more]</label></div><br/><div class="children"><div class="content">For actual best results you’d probably want to truncate at the word or syllable boundary, and it should likely be language specific.</div><br/></div></div></div></div><div id="40582661" class="c"><input type="checkbox" id="c-40582661" checked=""/><div class="controls bullet"><span class="by">LeonidasXIV</span><span>|</span><a href="#40581738">prev</a><span>|</span><a href="#40582028">next</a><span>|</span><label class="collapse" for="c-40582661">[-]</label><label class="expand" for="c-40582661">[1 more]</label></div><br/><div class="children"><div class="content">This will probably fail if the thing being chopped off is a composed emoji, like the flag emoji (where it can chop off the second letter of the ISO code and just leave a bewildering to the user but completely valid first letter) or the ZWJ sequence emojis which will leave a color or half a family or other shenanigans, depending where it cuts.</div><br/></div></div><div id="40582028" class="c"><input type="checkbox" id="c-40582028" checked=""/><div class="controls bullet"><span class="by">electroly</span><span>|</span><a href="#40582661">prev</a><span>|</span><a href="#40581724">next</a><span>|</span><label class="collapse" for="c-40582028">[-]</label><label class="expand" for="c-40582028">[1 more]</label></div><br/><div class="children"><div class="content">Don&#x27;t do this. Use a language (like C#) or library (like libunistring) that can do grapheme cluster segmentation. In .NET it&#x27;s StringInfo.GetTextElementEnumerator(). In libunistring it&#x27;s u8_grapheme_breaks(). In ICU4C it&#x27;s icu::BreakIterator::createCharacterInstance(). In Ruby it&#x27;s each_grapheme_cluster(). Other ecosystems with rich Unicode support should have similar functionality.</div><br/></div></div><div id="40581724" class="c"><input type="checkbox" id="c-40581724" checked=""/><div class="controls bullet"><span class="by">pianohacker</span><span>|</span><a href="#40582028">prev</a><span>|</span><a href="#40581895">next</a><span>|</span><label class="collapse" for="c-40581724">[-]</label><label class="expand" for="c-40581724">[2 more]</label></div><br/><div class="children"><div class="content">I cut my programmer teeth on Koha years and years ago. Still one of the warmest open-source communities I&#x27;ve ever been involved in, especially to a shy teenager with a lot of opinions.<p>Great to see new faces in the community, sad to see the sheer insanity of MARC21 still causing chaos. MARCXML is gonna make it obsolete Any Day Now!</div><br/><div id="40582208" class="c"><input type="checkbox" id="c-40582208" checked=""/><div class="controls bullet"><span class="by">quink</span><span>|</span><a href="#40581724">parent</a><span>|</span><a href="#40581895">next</a><span>|</span><label class="collapse" for="c-40582208">[-]</label><label class="expand" for="c-40582208">[1 more]</label></div><br/><div class="children"><div class="content">MARCXML is just a new format to encode what&#x27;s the vast majority of the MARC 21 standard (or for that matter any other MARC variety).<p>BIBFRAME is gonna make it obsolete Any Day Now!<p>(&quot;any day now&quot; in this sector means that librarians have been talking about it for two decades and in about two decades something might actually happen)</div><br/></div></div></div></div><div id="40581895" class="c"><input type="checkbox" id="c-40581895" checked=""/><div class="controls bullet"><span class="by">gpvos</span><span>|</span><a href="#40581724">prev</a><span>|</span><a href="#40582368">next</a><span>|</span><label class="collapse" for="c-40581895">[-]</label><label class="expand" for="c-40581895">[1 more]</label></div><br/><div class="children"><div class="content">Better use grapheme clusters than Unicode characters. After all, you don&#x27;t want to chop the diaeresis off an ë.</div><br/></div></div><div id="40582368" class="c"><input type="checkbox" id="c-40582368" checked=""/><div class="controls bullet"><span class="by">hoten</span><span>|</span><a href="#40581895">prev</a><span>|</span><label class="collapse" for="c-40582368">[-]</label><label class="expand" for="c-40582368">[1 more]</label></div><br/><div class="children"><div class="content">I wrote a JavaScript version of this using Intl: <a href="https:&#x2F;&#x2F;github.com&#x2F;GoogleChrome&#x2F;lighthouse&#x2F;blob&#x2F;9baac0ae9da71e88b0974cc960e5b93308eb81f0&#x2F;shared&#x2F;util.js#L175">https:&#x2F;&#x2F;github.com&#x2F;GoogleChrome&#x2F;lighthouse&#x2F;blob&#x2F;9baac0ae9da7...</a></div><br/></div></div></div></div></div></div></div></body></html>