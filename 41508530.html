<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1726131657750" as="style"/><link rel="stylesheet" href="styles.css?v=1726131657750"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://crzphil.github.io/posts/ssh-obfuscation-bypass/">OpenSSH Keystroke Obfuscation Bypass</a> <span class="domain">(<a href="https://crzphil.github.io">crzphil.github.io</a>)</span></div><div class="subtext"><span>pabs3</span> | <span>23 comments</span></div><br/><div><div id="41513691" class="c"><input type="checkbox" id="c-41513691" checked=""/><div class="controls bullet"><span class="by">qhwudbebd</span><span>|</span><a href="#41515521">next</a><span>|</span><label class="collapse" for="c-41513691">[-]</label><label class="expand" for="c-41513691">[3 more]</label></div><br/><div class="children"><div class="content">This was present in versions 9.5 - 9.7 of OpenSSH and fixed in 9.8p1 released at the beginning of July. Philippos (along with others) is credited for reporting it in the release notes:<p><pre><code>  https:&#x2F;&#x2F;www.openssh.com&#x2F;releasenotes.html#9.8p1</code></pre></div><br/><div id="41516594" class="c"><input type="checkbox" id="c-41516594" checked=""/><div class="controls bullet"><span class="by">palisade</span><span>|</span><a href="#41513691">parent</a><span>|</span><a href="#41515521">next</a><span>|</span><label class="collapse" for="c-41516594">[-]</label><label class="expand" for="c-41516594">[2 more]</label></div><br/><div class="children"><div class="content">Worth noting too, that other linux systems using 8.9, e.g. ubuntu are 8.9p1 and have the patch applied but to an older version so they&#x27;re also safe. Just in case anyone was worried about that.</div><br/><div id="41518691" class="c"><input type="checkbox" id="c-41518691" checked=""/><div class="controls bullet"><span class="by">0x0</span><span>|</span><a href="#41513691">root</a><span>|</span><a href="#41516594">parent</a><span>|</span><a href="#41515521">next</a><span>|</span><label class="collapse" for="c-41518691">[-]</label><label class="expand" for="c-41518691">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;d be very surprised if ubuntu has backported the keystroke obfuscation feature (which was introduced in 9.5) to 8.9.<p>When the feature is missing, you&#x27;re not safe from keystroke interception at all, which is what this bug is all about, so any 8.9 version would be actually considered &quot;unsafe&quot; until the whole feature is backported, which seems unlikely to happen?</div><br/></div></div></div></div></div></div><div id="41515521" class="c"><input type="checkbox" id="c-41515521" checked=""/><div class="controls bullet"><span class="by">jonmon6691</span><span>|</span><a href="#41513691">prev</a><span>|</span><a href="#41511976">next</a><span>|</span><label class="collapse" for="c-41515521">[-]</label><label class="expand" for="c-41515521">[2 more]</label></div><br/><div class="children"><div class="content">Most people would consider streaming music to be a negligible amount of bandwidth. Seems to me like SSH in a &quot;high security mode&quot; could just send X Kbps of bi-directional pad at a layer directly above encryption but below application. Then just use that channel for all the normal SSH traffic. You could either treat this as a bandwidth limited channel or do some slow time-constant ramping up and down at the risk of leaking information about file downloads or large command outputs.</div><br/><div id="41516522" class="c"><input type="checkbox" id="c-41516522" checked=""/><div class="controls bullet"><span class="by">advael</span><span>|</span><a href="#41515521">parent</a><span>|</span><a href="#41511976">next</a><span>|</span><label class="collapse" for="c-41516522">[-]</label><label class="expand" for="c-41516522">[1 more]</label></div><br/><div class="children"><div class="content">This seems like a reasonable solution to me, and I often stream music through my ssh sessions via port forwards so I may well already be getting the benefit in some places</div><br/></div></div></div></div><div id="41511976" class="c"><input type="checkbox" id="c-41511976" checked=""/><div class="controls bullet"><span class="by">thadt</span><span>|</span><a href="#41515521">prev</a><span>|</span><a href="#41512075">next</a><span>|</span><label class="collapse" for="c-41511976">[-]</label><label class="expand" for="c-41511976">[5 more]</label></div><br/><div class="children"><div class="content">Good work. But - this is an implementation bug right? If the underlying stream of packets gives you a distinguisher (in this case, slightly larger packets), then this attack works. So adjusting the chaff and payload packet sizes to some fixed capacity restores obfuscation, if I&#x27;m understanding this correctly. And response packets - those also have to be managed to prevent leakage.</div><br/><div id="41512061" class="c"><input type="checkbox" id="c-41512061" checked=""/><div class="controls bullet"><span class="by">KyleSanderson</span><span>|</span><a href="#41511976">parent</a><span>|</span><a href="#41512075">next</a><span>|</span><label class="collapse" for="c-41512061">[-]</label><label class="expand" for="c-41512061">[4 more]</label></div><br/><div class="children"><div class="content">The implementation is just wrong from what&#x27;s been presented. basic jitter (20-100ms), and a dynamic payload size are what&#x27;s actually missing here. The question now becomes though how interactive should your session be. Timing the connection latency might help to an extent, but this is about mitm and you don&#x27;t necessarily know where your adversary is (first hop, or towards the end). Batching keystrokes would also help here.</div><br/><div id="41513339" class="c"><input type="checkbox" id="c-41513339" checked=""/><div class="controls bullet"><span class="by">tialaramex</span><span>|</span><a href="#41511976">root</a><span>|</span><a href="#41512061">parent</a><span>|</span><a href="#41512075">next</a><span>|</span><label class="collapse" for="c-41513339">[-]</label><label class="expand" for="c-41513339">[3 more]</label></div><br/><div class="children"><div class="content">Basically there are two &quot;modes&quot; in normal mode OpenSSH is content to idle with no packets moving except any requested keepalives. In &quot;chaff mode&quot; currently they try to send a chaff packet every time they can to disguise your keypresses, but they forgot keystrokes will just get bundled into the existing chaff packet, growing it, so it stands out as special.<p>All they need to do is retain the &quot;chaff mode&quot; but when they have a keystroke ready to be sent they should suppress the chaff that would otherwise go in the same packet.<p>No need for &quot;basic jitter&quot; or &quot;dynamic payload size&quot; that I can see, with this change the packets are indistinguishable in terms of size or (encrypted) content, and they have no more or less jitter than would be normal for the network they&#x27;re traversing.<p>[Various small edits to clarify]</div><br/><div id="41516028" class="c"><input type="checkbox" id="c-41516028" checked=""/><div class="controls bullet"><span class="by">aidenn0</span><span>|</span><a href="#41511976">root</a><span>|</span><a href="#41513339">parent</a><span>|</span><a href="#41512075">next</a><span>|</span><label class="collapse" for="c-41516028">[-]</label><label class="expand" for="c-41516028">[2 more]</label></div><br/><div class="children"><div class="content">They will also need to increase the minimum size of a non-chaff keystroke to be the size of the largest keystroke that they wish to keep confidential; 3 bytes is a minimum for the basic control characters (e.g. arrow keys which are ESC &#x27;[&#x27; X where X depends on the arrow direction).<p>I did find it interesting that the return keystroke was of a differing size to other characters; on unix systems it should just send a ^J.</div><br/><div id="41517652" class="c"><input type="checkbox" id="c-41517652" checked=""/><div class="controls bullet"><span class="by">ec109685</span><span>|</span><a href="#41511976">root</a><span>|</span><a href="#41516028">parent</a><span>|</span><a href="#41512075">next</a><span>|</span><label class="collapse" for="c-41517652">[-]</label><label class="expand" for="c-41517652">[1 more]</label></div><br/><div class="children"><div class="content">Can’t they just send large control characters as three separate key presses?</div><br/></div></div></div></div></div></div></div></div></div></div><div id="41512075" class="c"><input type="checkbox" id="c-41512075" checked=""/><div class="controls bullet"><span class="by">SoftTalker</span><span>|</span><a href="#41511976">prev</a><span>|</span><a href="#41515320">next</a><span>|</span><label class="collapse" for="c-41512075">[-]</label><label class="expand" for="c-41512075">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m not an expert in this area at all but I recall reading that trying to hide a signal in random noise doesn&#x27;t really work, as you can still find the signal with statistical analysis or looking for distingishing characteristics that are not obscured. That was my first thought when I read about this new feature in OpenSSH, and it seems to have proven correct.<p>Edit: wanted to add that I recognize that the people working on OpenSSH know a lot more about this than I do, and I had assumed they wouldn&#x27;t bother implementing this if it wasn&#x27;t a good idea, so willing to accept that &quot;proven correct&quot; may be an overstatement or even flat-out wrong.</div><br/><div id="41512281" class="c"><input type="checkbox" id="c-41512281" checked=""/><div class="controls bullet"><span class="by">milliams</span><span>|</span><a href="#41512075">parent</a><span>|</span><a href="#41515320">next</a><span>|</span><label class="collapse" for="c-41512281">[-]</label><label class="expand" for="c-41512281">[1 more]</label></div><br/><div class="children"><div class="content">The advantage that OpenSSH have here is that they don&#x27;t have to just hide the signal using noise, they can actually change the signal to look like the noise (or vice versa). For example they are making the signal packets some at a regular interval (since the &quot;signal&quot; being discussed is the timings). That alone would not hide the number of keypresses, but adding the chaff should do so.<p>In this case, as said above, it seems like there&#x27;s an implementation issue with actually doing those obfuscations, allowing the signal to be identified.</div><br/></div></div></div></div><div id="41515320" class="c"><input type="checkbox" id="c-41515320" checked=""/><div class="controls bullet"><span class="by">mrguyorama</span><span>|</span><a href="#41512075">prev</a><span>|</span><a href="#41514343">next</a><span>|</span><label class="collapse" for="c-41515320">[-]</label><label class="expand" for="c-41515320">[3 more]</label></div><br/><div class="children"><div class="content">Regardless of what the &quot;cause&quot; of this is (ie bug or bad design), it&#x27;s obvious nobody even took a look at this after it was coded up and merged in. The larger packets and double server ACKs are very clearly obviously giving the game away. This feature just doesn&#x27;t even come close to what it supposedly does, was it even shipped as a feature or something that wasn&#x27;t yet done?<p>Not exactly encouraging, to see a system so integral to security seemingly shipping code without even a minor test of intended function.</div><br/><div id="41515362" class="c"><input type="checkbox" id="c-41515362" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#41515320">parent</a><span>|</span><a href="#41514343">next</a><span>|</span><label class="collapse" for="c-41515362">[-]</label><label class="expand" for="c-41515362">[2 more]</label></div><br/><div class="children"><div class="content">I think it&#x27;s worth asking how important the feature is in the grand scheme of things. But what about the CIA timing my keystrokes is more of a nerd forum thing than an actual attack vector you read about in intrusion post mortems.</div><br/><div id="41518321" class="c"><input type="checkbox" id="c-41518321" checked=""/><div class="controls bullet"><span class="by">talkin</span><span>|</span><a href="#41515320">root</a><span>|</span><a href="#41515362">parent</a><span>|</span><a href="#41514343">next</a><span>|</span><label class="collapse" for="c-41518321">[-]</label><label class="expand" for="c-41518321">[1 more]</label></div><br/><div class="children"><div class="content">Well, or it is important, and then you add the countermeasures. These countermeasures are quite easy to mess up, so doing the validation (on an ongoing basis!) MUST be part of the deal.<p>Or if you think it’s not important enough to do those assertions in CI, then it might be better to just reject the obfuscation attempts.<p>There’s no middleground: doing the implementation without checks, means you added complexity, you dont know if security improved (or worsened!), and the the release note might come down to a false sense of security.</div><br/></div></div></div></div></div></div><div id="41514343" class="c"><input type="checkbox" id="c-41514343" checked=""/><div class="controls bullet"><span class="by">hi-v-rocknroll</span><span>|</span><a href="#41515320">prev</a><span>|</span><a href="#41513768">next</a><span>|</span><label class="collapse" for="c-41514343">[-]</label><label class="expand" for="c-41514343">[3 more]</label></div><br/><div class="children"><div class="content">Perhaps instead shooting off individual keypresses with some random chaff packets, it would be wiser to have constant interval, constant low data rate, (say 8 KBps) data rate trickling packets through and let the other side throw away pick out the needles from the haystack of no ops. Good luck finding a side-channel in that.</div><br/><div id="41515689" class="c"><input type="checkbox" id="c-41515689" checked=""/><div class="controls bullet"><span class="by">pshc</span><span>|</span><a href="#41514343">parent</a><span>|</span><a href="#41513768">next</a><span>|</span><label class="collapse" for="c-41515689">[-]</label><label class="expand" for="c-41515689">[2 more]</label></div><br/><div class="children"><div class="content">Sounds good until (for example) you find out the SSH client library wasn&#x27;t queueing up packets ahead of time, but instead building them at send time, and a chaff packet takes less time to build than a real packet... so many ways to get side-channeled.</div><br/><div id="41518315" class="c"><input type="checkbox" id="c-41518315" checked=""/><div class="controls bullet"><span class="by">bubblesnort</span><span>|</span><a href="#41514343">root</a><span>|</span><a href="#41515689">parent</a><span>|</span><a href="#41513768">next</a><span>|</span><label class="collapse" for="c-41518315">[-]</label><label class="expand" for="c-41518315">[1 more]</label></div><br/><div class="children"><div class="content">Crypto requires a good source of random entropy. I suppose if you want more traffic for obscurity, you&#x27;ll also have to find more random bits. Without enough entropy, you&#x27;d sacrifice security for obscurity. Just my ¢2, ymmv, etc</div><br/></div></div></div></div></div></div><div id="41513768" class="c"><input type="checkbox" id="c-41513768" checked=""/><div class="controls bullet"><span class="by">keyboardcaper</span><span>|</span><a href="#41514343">prev</a><span>|</span><a href="#41513965">next</a><span>|</span><label class="collapse" for="c-41513768">[-]</label><label class="expand" for="c-41513768">[1 more]</label></div><br/><div class="children"><div class="content">There is a market for keyboards which obscure keypress timings.</div><br/></div></div><div id="41513965" class="c"><input type="checkbox" id="c-41513965" checked=""/><div class="controls bullet"><span class="by">gunapologist99</span><span>|</span><a href="#41513768">prev</a><span>|</span><label class="collapse" for="c-41513965">[-]</label><label class="expand" for="c-41513965">[3 more]</label></div><br/><div class="children"><div class="content">Yet another reason to switch to SSH keys instead of passwords wherever possible. Simple and bulletproof, with a minimum of footguns.<p>EDIT: @tedunangst is right, wouldn&#x27;t have helped. Even so, switch to keys!</div><br/><div id="41514036" class="c"><input type="checkbox" id="c-41514036" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#41513965">parent</a><span>|</span><label class="collapse" for="c-41514036">[-]</label><label class="expand" for="c-41514036">[2 more]</label></div><br/><div class="children"><div class="content">Does nothing here.</div><br/></div></div></div></div></div></div></div></div></div></body></html>