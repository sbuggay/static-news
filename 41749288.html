<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1728291677326" as="style"/><link rel="stylesheet" href="styles.css?v=1728291677326"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://til.simonwillison.net/sqlite/compile-sqlite3-rsync">Compiling and running sqlite3-rsync from a branch</a> <span class="domain">(<a href="https://til.simonwillison.net">til.simonwillison.net</a>)</span></div><div class="subtext"><span>tosh</span> | <span>16 comments</span></div><br/><div><div id="41759218" class="c"><input type="checkbox" id="c-41759218" checked=""/><div class="controls bullet"><span class="by">isoprophlex</span><span>|</span><a href="#41760082">next</a><span>|</span><label class="collapse" for="c-41759218">[-]</label><label class="expand" for="c-41759218">[5 more]</label></div><br/><div class="children"><div class="content">&gt; It took me quite a few iterations to get to this recipe for compiling the tool itself<p>Hehe, I really feel this remark, having recently built a sqlite3 binary with Lua support[*]<p>The LLMs were no help here, either. Which is maybe a good thing for our collective future employment.<p>That said, I found the quality of the documentation and legibility of the sqlite source code to be absolutely fantastic. When you work with the code, you can almost feel the programming enlightenment rub off on you.<p>[*] why, for heavens&#x27; sake? so you can decouple your business logic from the database and test it a bit outside the DB,  whilst still keeping the data all in one place without sending it over the wire. It lets you SELECT lua(&#x27;some lua code that operates on your sqlite data&#x27;) FROM some-table;, so you can put gnarly nested conditionals or whatever into Lua, build some comprehensive testing around that, and execute it on your data as if everything was a single, plain old SQL statement.</div><br/><div id="41759908" class="c"><input type="checkbox" id="c-41759908" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41759218">parent</a><span>|</span><a href="#41761578">next</a><span>|</span><label class="collapse" for="c-41759908">[-]</label><label class="expand" for="c-41759908">[3 more]</label></div><br/><div class="children"><div class="content">I got a little bit of assistance from Claude in figuring this out, but it pointed me in the right direction more than actually giving me the right sequence of commands. Claude got me as far as:<p><pre><code>    gcc -o sqldiff sqldiff.c ..&#x2F;sqlite3.c -I.. -ldl -lpthread
</code></pre>
Which was enough for me to figure out I needed to get the sqlite3.c amalgamation to build and then run gcc in the tool&#x2F; directory. I landed on this after a bit more poking:<p><pre><code>    gcc -o sqlite3-rsync sqlite3-rsync.c ..&#x2F;sqlite3.c -DSQLITE_ENABLE_DBPAGE_VTAB
</code></pre>
I did have a much more useful interaction with an LLM later on: I was curious about the protocol used over SSH, so I copied the whole of this 1800 line C file:<p><a href="https:&#x2F;&#x2F;github.com&#x2F;sqlite&#x2F;sqlite&#x2F;blob&#x2F;sqlite3-rsync&#x2F;tool&#x2F;sqlite3-rsync.c">https:&#x2F;&#x2F;github.com&#x2F;sqlite&#x2F;sqlite&#x2F;blob&#x2F;sqlite3-rsync&#x2F;tool&#x2F;sql...</a><p>And pasted it into OpenAI o1-preview with the prompt &quot;Explain the protocol over SSH part of this&quot; - and got back a genuinely excellent high-level explanation of how that worked: <a href="https:&#x2F;&#x2F;chatgpt.com&#x2F;share&#x2F;6701450c-bc9c-8006-8c9e-468ab6f67e4b" rel="nofollow">https:&#x2F;&#x2F;chatgpt.com&#x2F;share&#x2F;6701450c-bc9c-8006-8c9e-468ab6f67e...</a></div><br/><div id="41760223" class="c"><input type="checkbox" id="c-41760223" checked=""/><div class="controls bullet"><span class="by">someone13</span><span>|</span><a href="#41759218">root</a><span>|</span><a href="#41759908">parent</a><span>|</span><a href="#41761578">next</a><span>|</span><label class="collapse" for="c-41760223">[-]</label><label class="expand" for="c-41760223">[2 more]</label></div><br/><div class="children"><div class="content">That share link 404s for me, FWIW. I’d be interested in seeing it!</div><br/><div id="41760278" class="c"><input type="checkbox" id="c-41760278" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41759218">root</a><span>|</span><a href="#41760223">parent</a><span>|</span><a href="#41761578">next</a><span>|</span><label class="collapse" for="c-41760278">[-]</label><label class="expand" for="c-41760278">[1 more]</label></div><br/><div class="children"><div class="content">Weird - <a href="https:&#x2F;&#x2F;chatgpt.com&#x2F;share&#x2F;6701450c-bc9c-8006-8c9e-468ab6f67e4b" rel="nofollow">https:&#x2F;&#x2F;chatgpt.com&#x2F;share&#x2F;6701450c-bc9c-8006-8c9e-468ab6f67e...</a> is working for me in a Chrome Incognito window.<p>Here&#x27;s a copy of the Markdown answer it gave me: <a href="https:&#x2F;&#x2F;gist.github.com&#x2F;simonw&#x2F;ffbf90e0602df04c2f6b387de42acba4" rel="nofollow">https:&#x2F;&#x2F;gist.github.com&#x2F;simonw&#x2F;ffbf90e0602df04c2f6b387de42ac...</a></div><br/></div></div></div></div></div></div><div id="41761578" class="c"><input type="checkbox" id="c-41761578" checked=""/><div class="controls bullet"><span class="by">infogulch</span><span>|</span><a href="#41759218">parent</a><span>|</span><a href="#41759908">prev</a><span>|</span><a href="#41760082">next</a><span>|</span><label class="collapse" for="c-41761578">[-]</label><label class="expand" for="c-41761578">[1 more]</label></div><br/><div class="children"><div class="content">Lua as the language for SQLite procedures just sounds right for some reason. Did you try integrating at that level, or is it limited to expression-level evaluation?</div><br/></div></div></div></div><div id="41760082" class="c"><input type="checkbox" id="c-41760082" checked=""/><div class="controls bullet"><span class="by">gary_0</span><span>|</span><a href="#41759218">prev</a><span>|</span><a href="#41760028">next</a><span>|</span><label class="collapse" for="c-41760082">[-]</label><label class="expand" for="c-41760082">[6 more]</label></div><br/><div class="children"><div class="content">sqlite3-rsync is in the makefile. I got sqlite-rsync to build by just checking out the main branch and going:<p><pre><code>    .&#x2F;configure
    make sqlite3-rsync
</code></pre>
I think the rsync branch has been merged?<p>I&#x27;m really excited for this new tool; I&#x27;m hoping to use it for nightly backups of a webapp I&#x27;m building that uses sqlite exclusively. Although I&#x27;m hesitant to rely on sqlite-rsync right away because it&#x27;s so new.</div><br/><div id="41760911" class="c"><input type="checkbox" id="c-41760911" checked=""/><div class="controls bullet"><span class="by">pkhuong</span><span>|</span><a href="#41760082">parent</a><span>|</span><a href="#41760232">next</a><span>|</span><label class="collapse" for="c-41760911">[-]</label><label class="expand" for="c-41760911">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I&#x27;m hesitant to rely on sqlite-rsync right away because it&#x27;s so new.<p>If you want something less new that only needs an S3-compatible endpoint, there&#x27;s <a href="https:&#x2F;&#x2F;gist.github.com&#x2F;pkhuong&#x2F;555be66f5e573a2d56186d658fd80881" rel="nofollow">https:&#x2F;&#x2F;gist.github.com&#x2F;pkhuong&#x2F;555be66f5e573a2d56186d658fd8...</a></div><br/></div></div><div id="41760232" class="c"><input type="checkbox" id="c-41760232" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41760082">parent</a><span>|</span><a href="#41760911">prev</a><span>|</span><a href="#41760319">next</a><span>|</span><label class="collapse" for="c-41760232">[-]</label><label class="expand" for="c-41760232">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for that! I just updated my TIL to promote this recipe instead - I didn&#x27;t realize it was A) in the Makefile and B) merged into the main branch.</div><br/></div></div><div id="41760319" class="c"><input type="checkbox" id="c-41760319" checked=""/><div class="controls bullet"><span class="by">ralferoo</span><span>|</span><a href="#41760082">parent</a><span>|</span><a href="#41760232">prev</a><span>|</span><a href="#41760028">next</a><span>|</span><label class="collapse" for="c-41760319">[-]</label><label class="expand" for="c-41760319">[3 more]</label></div><br/><div class="children"><div class="content">&gt; I&#x27;m hoping to use it for nightly backups of a webapp I&#x27;m building that uses sqlite exclusively<p>The easiest recipe for this is to use<p><pre><code>    sqlite3 $SRC &quot;vacuum into &#x27;$DEST&#x27;&quot;
</code></pre>
$DEST must not already exist, personally I prefer to put the timestamp into the filename and keep the last n copies.</div><br/><div id="41760401" class="c"><input type="checkbox" id="c-41760401" checked=""/><div class="controls bullet"><span class="by">gary_0</span><span>|</span><a href="#41760082">root</a><span>|</span><a href="#41760319">parent</a><span>|</span><a href="#41760028">next</a><span>|</span><label class="collapse" for="c-41760401">[-]</label><label class="expand" for="c-41760401">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m aware of the existing backup methods, but AFAIK they don&#x27;t do a delta of only the changed pages (unless I use separate software), and &quot;vacuum into&quot; doesn&#x27;t work over SSH.<p>I have no need to store a backup on the same physical server. Also, the backup server will keep snapshots, and with sqlite3-rsync I can just update a previous snapshot with the changed pages rather than redundantly transferring the whole database over every time.</div><br/><div id="41760505" class="c"><input type="checkbox" id="c-41760505" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41760082">root</a><span>|</span><a href="#41760401">parent</a><span>|</span><a href="#41760028">next</a><span>|</span><label class="collapse" for="c-41760505">[-]</label><label class="expand" for="c-41760505">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, the unique benefit of sqlite-rsync looks to be efficiently backing up medium to large databases that don’t change enormously (so deltas are worthwhile) over an SSH connection. I particularly like that you don’t need double the disk space to create the temporary backup copy before downloading it.</div><br/></div></div></div></div></div></div></div></div><div id="41760028" class="c"><input type="checkbox" id="c-41760028" checked=""/><div class="controls bullet"><span class="by">tosh</span><span>|</span><a href="#41760082">prev</a><span>|</span><label class="collapse" for="c-41760028">[-]</label><label class="expand" for="c-41760028">[4 more]</label></div><br/><div class="children"><div class="content">I wonder how this compares to litestream and other existing sqlite replication strategies.</div><br/><div id="41760364" class="c"><input type="checkbox" id="c-41760364" checked=""/><div class="controls bullet"><span class="by">ralferoo</span><span>|</span><a href="#41760028">parent</a><span>|</span><a href="#41760299">next</a><span>|</span><label class="collapse" for="c-41760364">[-]</label><label class="expand" for="c-41760364">[2 more]</label></div><br/><div class="children"><div class="content">I had a quick scan through the source and it gets the hash of each page on both sides and sends the page if it&#x27;s different (so conceptually very similar to rsync). I don&#x27;t think the cache is indexed anywhere normally, so that&#x27;d imply it needs to do a full read of the database on both sides, so it&#x27;ll be slow and probably trash your disk cache on a large database.<p>In theory, it should be able to use the WAL file directly if it copies the WAL checksums, but that information would get lost every time the WAL is flushed and the data is moved into the main db file.<p>Litestream knows exactly which pages have been written via the fuse fs, so it doesn&#x27;t need to do all that work for unchanged pages.</div><br/><div id="41760395" class="c"><input type="checkbox" id="c-41760395" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41760028">root</a><span>|</span><a href="#41760364">parent</a><span>|</span><a href="#41760299">next</a><span>|</span><label class="collapse" for="c-41760395">[-]</label><label class="expand" for="c-41760395">[1 more]</label></div><br/><div class="children"><div class="content">Ugh, yeah that&#x27;s a good point: it looks like each time you run sqlite-rsync it calculates a hash for every database page on both the source and the replica side of things - that&#x27;s a lot of disk access and CPU, way more than you would want to run on an every-ten-seconds basis.</div><br/></div></div></div></div><div id="41760299" class="c"><input type="checkbox" id="c-41760299" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#41760028">parent</a><span>|</span><a href="#41760364">prev</a><span>|</span><label class="collapse" for="c-41760299">[-]</label><label class="expand" for="c-41760299">[1 more]</label></div><br/><div class="children"><div class="content">I guess this is probably fast enough that you could run it on a schedule every 10 seconds or so (at least for databases measured in GBs, not TBs) to keep a warm copy updated elsewhere. [UPDATE: maybe not, it has to hash everything, see comment here <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=41749288#41760395">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=41749288#41760395</a>]<p>Litestream gives you a backup in S3 within less than a second of data being committed though, plus since it records the full WAL archive you get point-in-time recovery for previous timestamps too.</div><br/></div></div></div></div></div></div></div></div></div></body></html>