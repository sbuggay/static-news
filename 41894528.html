<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1729501267894" as="style"/><link rel="stylesheet" href="styles.css?v=1729501267894"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.moertel.com/posts/2024-08-23-sampling-with-sql.html">Sampling with SQL</a> <span class="domain">(<a href="https://blog.moertel.com">blog.moertel.com</a>)</span></div><div class="subtext"><span>thunderbong</span> | <span>14 comments</span></div><br/><div><div id="41900725" class="c"><input type="checkbox" id="c-41900725" checked=""/><div class="controls bullet"><span class="by">rhymer</span><span>|</span><a href="#41899091">next</a><span>|</span><label class="collapse" for="c-41900725">[-]</label><label class="expand" for="c-41900725">[1 more]</label></div><br/><div class="children"><div class="content">Be careful, the weight of Algorithm A by Efraimidis and Spirakis cannot be interpreted as the inclusion probability, and thus cannot be used in survey sampling to construct the Horvitz–Thompson estimator.<p>See &quot;Remarks on some misconceptions about unequal probability sampling without replacement&quot; by Yves Tillé.<p>Quoted from Tillé&#x27;s conclusion: &quot;There is a multitude of correct and fast method of sampling... there is no reason to use an incorrect method like weighted random sampling where we do not control the inclusion probabilities&quot;<p>It&#x27;s not clear to me how easy it is to implement the &quot;multitude of corect and fast methods&quot; in SQL, though. Would love to see some reference implementation.</div><br/></div></div><div id="41899091" class="c"><input type="checkbox" id="c-41899091" checked=""/><div class="controls bullet"><span class="by">tmoertel</span><span>|</span><a href="#41900725">prev</a><span>|</span><a href="#41899847">next</a><span>|</span><label class="collapse" for="c-41899091">[-]</label><label class="expand" for="c-41899091">[1 more]</label></div><br/><div class="children"><div class="content">Hey! I&#x27;m tickled to see this on HN. I&#x27;m the author. If you have any questions, just ask. I&#x27;ll do my best to answer them here.</div><br/></div></div><div id="41899847" class="c"><input type="checkbox" id="c-41899847" checked=""/><div class="controls bullet"><span class="by">natmaka</span><span>|</span><a href="#41899091">prev</a><span>|</span><a href="#41899108">next</a><span>|</span><label class="collapse" for="c-41899847">[-]</label><label class="expand" for="c-41899847">[1 more]</label></div><br/><div class="children"><div class="content">If you need to &quot;extract a small, sample dataset from a larger PostgreSQL database while maintaining referential integrity&quot; check <a href="https:&#x2F;&#x2F;github.com&#x2F;mla&#x2F;pg_sample">https:&#x2F;&#x2F;github.com&#x2F;mla&#x2F;pg_sample</a></div><br/></div></div><div id="41899108" class="c"><input type="checkbox" id="c-41899108" checked=""/><div class="controls bullet"><span class="by">emmelaich</span><span>|</span><a href="#41899847">prev</a><span>|</span><label class="collapse" for="c-41899108">[-]</label><label class="expand" for="c-41899108">[10 more]</label></div><br/><div class="children"><div class="content">Is there something in the SQL standard that says functions are guaranteed to executed more than once?<p>I swear that once I used something like random() and it was only executed once, making it useless for the task at hand.  I had to use some trick to ensure it was executed for each row.<p>I may have used it in the `select` part.  Dialect was Oracle&#x27;s, from memory.<p>related: <a href="https:&#x2F;&#x2F;xkcd.com&#x2F;221&#x2F;" rel="nofollow">https:&#x2F;&#x2F;xkcd.com&#x2F;221&#x2F;</a></div><br/><div id="41899381" class="c"><input type="checkbox" id="c-41899381" checked=""/><div class="controls bullet"><span class="by">yen223</span><span>|</span><a href="#41899108">parent</a><span>|</span><a href="#41901762">next</a><span>|</span><label class="collapse" for="c-41899381">[-]</label><label class="expand" for="c-41899381">[1 more]</label></div><br/><div class="children"><div class="content">Postgres makes a distinction between IMMUTABLE, STABLE, and VOLATILE functions, with volatile functions being functions that - with the same arguments - can produce different results even within the same statement. Therefore VOLATILE functions will always be executed once per call.<p>I&#x27;m not sure if this is part of the ANSI SQL standard.</div><br/></div></div><div id="41901762" class="c"><input type="checkbox" id="c-41901762" checked=""/><div class="controls bullet"><span class="by">magicalhippo</span><span>|</span><a href="#41899108">parent</a><span>|</span><a href="#41899381">prev</a><span>|</span><a href="#41899141">next</a><span>|</span><label class="collapse" for="c-41901762">[-]</label><label class="expand" for="c-41901762">[1 more]</label></div><br/><div class="children"><div class="content">Conversely, today() and friends might be evaluated per row and not per row, to the mild surprise of some of us.<p>Just reinforced my belief of not assuming you know what the DB server is doing, verify!</div><br/></div></div><div id="41899141" class="c"><input type="checkbox" id="c-41899141" checked=""/><div class="controls bullet"><span class="by">hobs</span><span>|</span><a href="#41899108">parent</a><span>|</span><a href="#41901762">prev</a><span>|</span><a href="#41900027">next</a><span>|</span><label class="collapse" for="c-41899141">[-]</label><label class="expand" for="c-41899141">[6 more]</label></div><br/><div class="children"><div class="content">It depends on the function and the SQL implementation, you can see in this simulator that where rand() &gt; rand() evaluates row by row in MySQL but once in SQL Server, so its easy to get this stuff messed up even if the code is &quot;equivalent&quot; its really not.<p><a href="https:&#x2F;&#x2F;onecompiler.com&#x2F;mysql&#x2F;42vq8s23b" rel="nofollow">https:&#x2F;&#x2F;onecompiler.com&#x2F;mysql&#x2F;42vq8s23b</a>
<a href="https:&#x2F;&#x2F;onecompiler.com&#x2F;sqlserver&#x2F;42vq8tz24" rel="nofollow">https:&#x2F;&#x2F;onecompiler.com&#x2F;sqlserver&#x2F;42vq8tz24</a></div><br/><div id="41899285" class="c"><input type="checkbox" id="c-41899285" checked=""/><div class="controls bullet"><span class="by">emmelaich</span><span>|</span><a href="#41899108">root</a><span>|</span><a href="#41899141">parent</a><span>|</span><a href="#41900027">next</a><span>|</span><label class="collapse" for="c-41899285">[-]</label><label class="expand" for="c-41899285">[5 more]</label></div><br/><div class="children"><div class="content">Thanks, that&#x27;s a bit upsetting :-)</div><br/><div id="41899389" class="c"><input type="checkbox" id="c-41899389" checked=""/><div class="controls bullet"><span class="by">tmoertel</span><span>|</span><a href="#41899108">root</a><span>|</span><a href="#41899285">parent</a><span>|</span><a href="#41899741">next</a><span>|</span><label class="collapse" for="c-41899389">[-]</label><label class="expand" for="c-41899389">[3 more]</label></div><br/><div class="children"><div class="content">Indeed.<p>On systems with unfortunate evaluation semantics for `RAND`, you can generate fresh random values for each row by creating a function for that purpose and calling it on the primary key of each row. I provide one example in the article at:<p><a href="https:&#x2F;&#x2F;blog.moertel.com&#x2F;posts&#x2F;2024-08-23-sampling-with-sql.html#adding-determinism" rel="nofollow">https:&#x2F;&#x2F;blog.moertel.com&#x2F;posts&#x2F;2024-08-23-sampling-with-sql....</a><p>I&#x27;ll include a copy here because it&#x27;s short. It&#x27;s for DuckDB and was created to let us generate a controllable number of fresh random values for each row:<p><pre><code>    -- Returns a pseudorandom fp64 number in the range [0, 1). The number
    -- is determined by the given `key`, `seed` string, and integer `index`.
    CREATE MACRO pseudorandom_uniform(key, seed, index)
    AS (
      (HASH(key || seed || index) &gt;&gt; 11) * POW(2.0, -53)
    );</code></pre></div><br/><div id="41899564" class="c"><input type="checkbox" id="c-41899564" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#41899108">root</a><span>|</span><a href="#41899389">parent</a><span>|</span><a href="#41899741">next</a><span>|</span><label class="collapse" for="c-41899564">[-]</label><label class="expand" for="c-41899564">[2 more]</label></div><br/><div class="children"><div class="content">`HASH` looks like a slow function ... does something like `rand() + rowid &amp; 0` or `((rand() * p53 + rowid) % p53) &#x2F; p53`  work?</div><br/><div id="41899938" class="c"><input type="checkbox" id="c-41899938" checked=""/><div class="controls bullet"><span class="by">tmoertel</span><span>|</span><a href="#41899108">root</a><span>|</span><a href="#41899564">parent</a><span>|</span><a href="#41899741">next</a><span>|</span><label class="collapse" for="c-41899938">[-]</label><label class="expand" for="c-41899938">[1 more]</label></div><br/><div class="children"><div class="content">Generally, table scans dominate the cost of sampling, so evaluating a &quot;slow&quot; function once per row doesn&#x27;t matter. What does matter is whether you can push filtering expressions down into the scans to eliminate I&#x2F;O and decoding work early. Some systems have trouble pushing down RAND efficiency, which can make alternatives like the deterministic function I shared advantageous.</div><br/></div></div></div></div></div></div><div id="41899741" class="c"><input type="checkbox" id="c-41899741" checked=""/><div class="controls bullet"><span class="by">hobs</span><span>|</span><a href="#41899108">root</a><span>|</span><a href="#41899285">parent</a><span>|</span><a href="#41899389">prev</a><span>|</span><a href="#41900027">next</a><span>|</span><label class="collapse" for="c-41899741">[-]</label><label class="expand" for="c-41899741">[1 more]</label></div><br/><div class="children"><div class="content">Had a good laugh, this is the normal response to difference in SQL implementations in my experience.</div><br/></div></div></div></div></div></div><div id="41900027" class="c"><input type="checkbox" id="c-41900027" checked=""/><div class="controls bullet"><span class="by">paulddraper</span><span>|</span><a href="#41899108">parent</a><span>|</span><a href="#41899141">prev</a><span>|</span><label class="collapse" for="c-41900027">[-]</label><label class="expand" for="c-41900027">[1 more]</label></div><br/><div class="children"><div class="content">No.</div><br/></div></div></div></div></div></div></div></div></div></body></html>