<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1705914075868" as="style"/><link rel="stylesheet" href="styles.css?v=1705914075868"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://adrianco.medium.com/what-adrian-did-next-part-2-sun-microsystems-c1a512c8284">What Adrian Did Next – Part 2 – Sun Microsystems (2022)</a> <span class="domain">(<a href="https://adrianco.medium.com">adrianco.medium.com</a>)</span></div><div class="subtext"><span>wallflower</span> | <span>21 comments</span></div><br/><div><div id="39083625" class="c"><input type="checkbox" id="c-39083625" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39085055">next</a><span>|</span><label class="collapse" for="c-39083625">[-]</label><label class="expand" for="c-39083625">[11 more]</label></div><br/><div class="children"><div class="content">&gt; One day we were chatting in a group meeting and he said he was working on a TPC-C benchmark that was spending too much time in the SCSI disk driver, so he wrote a 10-line awk script running against kernel memory to look at the SPARC machine code execution path and find which branches were being predicted wrong, then wrote another awk script to flip the branch prediction bits in memory and it showed a significant speedup.<p>SPARC exposed read <i>and write</i> access to branch prediction!? That&#x27;s... fascinating. Here I thought branch prediction was always a completely opaque thing that the CPU did internally and <i>maybe</i> if you were lucky it might let the program be able to know that it was happening after the fact. Hm... I wonder if it&#x27;s easier to perform Spectre type attacks if you can just ask the CPU about that kind of behavior? No need to do timing attacks if the CPU will just tell you</div><br/><div id="39083982" class="c"><input type="checkbox" id="c-39083982" checked=""/><div class="controls bullet"><span class="by">bri3d</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39086440">next</a><span>|</span><label class="collapse" for="c-39083982">[-]</label><label class="expand" for="c-39083982">[1 more]</label></div><br/><div class="children"><div class="content">SPARC had instructions (BP, Branch with Prediction) which hinted the branch predictor whether the branch was likely or unlikely. Presumably this script just edited the opcodes in memory to avoid needing to figure out how to change the generated code from the compiler, recompile, and replace the kernel.</div><br/></div></div><div id="39086440" class="c"><input type="checkbox" id="c-39086440" checked=""/><div class="controls bullet"><span class="by">adrianco</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39083982">prev</a><span>|</span><a href="#39083906">next</a><span>|</span><label class="collapse" for="c-39086440">[-]</label><label class="expand" for="c-39086440">[1 more]</label></div><br/><div class="children"><div class="content">These were simpler RISC implementations in those days, the compiler optimizer stage was in charge of deciding whether to set the branch bit or not, and the prefetch would do what the bit said, and stall if it got it wrong.</div><br/></div></div><div id="39083906" class="c"><input type="checkbox" id="c-39083906" checked=""/><div class="controls bullet"><span class="by">gumby</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39086440">prev</a><span>|</span><a href="#39083758">next</a><span>|</span><label class="collapse" for="c-39083906">[-]</label><label class="expand" for="c-39083906">[1 more]</label></div><br/><div class="children"><div class="content">IIRC you specified the likely path in assembly code, but not all SPARCs had those opcodes.  They were some sort of extention.  By default they had simple fixed prediction (branch would not be taken, backwards branch would be taken etc).<p>Some of the pentium series also had settable branch prediction bias flags.</div><br/></div></div><div id="39083758" class="c"><input type="checkbox" id="c-39083758" checked=""/><div class="controls bullet"><span class="by">Thorrez</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39083906">prev</a><span>|</span><a href="#39084048">next</a><span>|</span><label class="collapse" for="c-39083758">[-]</label><label class="expand" for="c-39083758">[5 more]</label></div><br/><div class="children"><div class="content">I would assume you have to be root to do this branch predictor stuff. If you&#x27;re root, why do you need Spectre? If you&#x27;re attacking some trusted execution thing, then I assume you wouldn&#x27;t be able to do the branch predictor stuff.</div><br/><div id="39083874" class="c"><input type="checkbox" id="c-39083874" checked=""/><div class="controls bullet"><span class="by">hackmiester</span><span>|</span><a href="#39083625">root</a><span>|</span><a href="#39083758">parent</a><span>|</span><a href="#39084048">next</a><span>|</span><label class="collapse" for="c-39083874">[-]</label><label class="expand" for="c-39083874">[4 more]</label></div><br/><div class="children"><div class="content">Because you might be root in one VM or container, and you are trying to access another VM or container.</div><br/><div id="39084073" class="c"><input type="checkbox" id="c-39084073" checked=""/><div class="controls bullet"><span class="by">Thorrez</span><span>|</span><a href="#39083625">root</a><span>|</span><a href="#39083874">parent</a><span>|</span><a href="#39084048">next</a><span>|</span><label class="collapse" for="c-39084073">[-]</label><label class="expand" for="c-39084073">[3 more]</label></div><br/><div class="children"><div class="content">Oh, interesting. I wonder if the hypervisor would be able to prevent the VM from using those features of the CPU.</div><br/><div id="39086861" class="c"><input type="checkbox" id="c-39086861" checked=""/><div class="controls bullet"><span class="by">1oooqooq</span><span>|</span><a href="#39083625">root</a><span>|</span><a href="#39084073">parent</a><span>|</span><a href="#39084048">next</a><span>|</span><label class="collapse" for="c-39086861">[-]</label><label class="expand" for="c-39086861">[2 more]</label></div><br/><div class="children"><div class="content">it usually does not. reason why you run security analysts of untrusted code first in a qemu without virtualization.</div><br/><div id="39087244" class="c"><input type="checkbox" id="c-39087244" checked=""/><div class="controls bullet"><span class="by">kramerger</span><span>|</span><a href="#39083625">root</a><span>|</span><a href="#39086861">parent</a><span>|</span><a href="#39084048">next</a><span>|</span><label class="collapse" for="c-39087244">[-]</label><label class="expand" for="c-39087244">[1 more]</label></div><br/><div class="children"><div class="content">While your hypervisor may not implement it, ARM allows you to configure this kind of operations.<p>See for example<p><a href="https:&#x2F;&#x2F;developer.arm.com&#x2F;documentation&#x2F;ddi0595&#x2F;2020-12&#x2F;AArch64-Registers&#x2F;HDFGWTR-EL2--Hypervisor-Debug-Fine-Grained-Write-Trap-Register?lang=en" rel="nofollow">https:&#x2F;&#x2F;developer.arm.com&#x2F;documentation&#x2F;ddi0595&#x2F;2020-12&#x2F;AArc...</a></div><br/></div></div></div></div></div></div></div></div></div></div><div id="39084048" class="c"><input type="checkbox" id="c-39084048" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39083758">prev</a><span>|</span><a href="#39084034">next</a><span>|</span><label class="collapse" for="c-39084048">[-]</label><label class="expand" for="c-39084048">[1 more]</label></div><br/><div class="children"><div class="content">Most processors have hint instructions that let you tell it which branch you think will be likely.</div><br/></div></div><div id="39084034" class="c"><input type="checkbox" id="c-39084034" checked=""/><div class="controls bullet"><span class="by">hindsightbias</span><span>|</span><a href="#39083625">parent</a><span>|</span><a href="#39084048">prev</a><span>|</span><a href="#39085055">next</a><span>|</span><label class="collapse" for="c-39084034">[-]</label><label class="expand" for="c-39084034">[1 more]</label></div><br/><div class="children"><div class="content">It would seem more likely to be a scsi&#x2F;kex timing issue and there are direct hacks into that when you have a loose dev&#x2F;kmem philsophy.<p>If you are&#x2F;can directly hack the pipeline, Adrian better have included that script in the bmark publish. Probably not, because then directors would be calling him at 2am because XYZ corps workload was slow and “could we have your nop script?”</div><br/></div></div></div></div><div id="39085055" class="c"><input type="checkbox" id="c-39085055" checked=""/><div class="controls bullet"><span class="by">crackez</span><span>|</span><a href="#39083625">prev</a><span>|</span><a href="#39087426">next</a><span>|</span><label class="collapse" for="c-39085055">[-]</label><label class="expand" for="c-39085055">[1 more]</label></div><br/><div class="children"><div class="content">We used to have a piece of Java software called Scout - it did a lot of small memory allocations... Led to runtime of multiple days for some datasets. I was reading the book Solaris Internals. The edition I had was updated for the ultrasparc 3&#x27;s, and I was reading that section that talked about memory pages and the new support for huge pages, eg 4GB pages. We switched on 4GB pages and the week long runs of Scout went to only a few hours. That performance gain was real money and time.<p>That was an interesting trip down memory lane.</div><br/></div></div><div id="39087426" class="c"><input type="checkbox" id="c-39087426" checked=""/><div class="controls bullet"><span class="by">jeffrallen</span><span>|</span><a href="#39085055">prev</a><span>|</span><a href="#39085919">next</a><span>|</span><label class="collapse" for="c-39087426">[-]</label><label class="expand" for="c-39087426">[1 more]</label></div><br/><div class="children"><div class="content">To young engineers reading this, note that his early sales experience taught him how to deliver value to customers, not just checkins to git. If someone tries to promote you into sales engineer and you shy away because of wearing a tie or whatever, you are losing out on a huge opportunity to improve your engineering career.</div><br/></div></div><div id="39085919" class="c"><input type="checkbox" id="c-39085919" checked=""/><div class="controls bullet"><span class="by">avg_dev</span><span>|</span><a href="#39087426">prev</a><span>|</span><a href="#39084320">next</a><span>|</span><label class="collapse" for="c-39085919">[-]</label><label class="expand" for="c-39085919">[2 more]</label></div><br/><div class="children"><div class="content">i didn&#x27;t know what i was expecting when i started to read this but it wasn&#x27;t that. i didn&#x27;t know the author before the article but i thought it was really an amazing read. i think it speaks very well to the power of collaboration and a congenial and healthy work environment.<p>as another commenter mentioned the thing about the branch prediction bit flipping in awk was quite something. the SE Toolkit to monitor kernel perf, which could run for <i>years</i> without issue - was something cool too. the guy who found and fixed a kernel bug offering the biggest performance win in Solaris 8 in the course of writing the first book in a series called Solaris Internals - wow. the description of &quot;the can of worms project&quot; in which they run workloads that look like what customers might use, things that that go beyond typical eng team benchmarks, and the meltdown prevention and heading off of customer issues, it&#x27;s a great concept from my personal point of view. i appreciated the touching on other more human subjects like the capacity planning DB pricing calculator for customers and the bizdev, relationship, and product design points.<p>i started off being jealous of what the guy was saying but i was so blown away by everything that i had forgotten that feeling by the end of the article. it was replaced with awe.</div><br/><div id="39086459" class="c"><input type="checkbox" id="c-39086459" checked=""/><div class="controls bullet"><span class="by">adrianco</span><span>|</span><a href="#39085919">parent</a><span>|</span><a href="#39084320">next</a><span>|</span><label class="collapse" for="c-39086459">[-]</label><label class="expand" for="c-39086459">[1 more]</label></div><br/><div class="children"><div class="content">Thanks! That’s cool. I’m glad I found time to write down what I remembered and the names of many of the people I met along the way. I have notes but haven’t had time to tell the story of the Netflix years yet…</div><br/></div></div></div></div><div id="39084320" class="c"><input type="checkbox" id="c-39084320" checked=""/><div class="controls bullet"><span class="by">bear8642</span><span>|</span><a href="#39085919">prev</a><span>|</span><a href="#39083397">next</a><span>|</span><label class="collapse" for="c-39084320">[-]</label><label class="expand" for="c-39084320">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20240121212049&#x2F;https:&#x2F;&#x2F;adrianco.medium.com&#x2F;what-adrian-did-next-part-2-sun-microsystems-c1a512c8284" rel="nofollow">https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20240121212049&#x2F;https:&#x2F;&#x2F;adrianco....</a></div><br/></div></div><div id="39083397" class="c"><input type="checkbox" id="c-39083397" checked=""/><div class="controls bullet"><span class="by">ChrisArchitect</span><span>|</span><a href="#39084320">prev</a><span>|</span><a href="#39087177">next</a><span>|</span><label class="collapse" for="c-39083397">[-]</label><label class="expand" for="c-39083397">[3 more]</label></div><br/><div class="children"><div class="content">(2022)</div><br/><div id="39084203" class="c"><input type="checkbox" id="c-39084203" checked=""/><div class="controls bullet"><span class="by">gjvc</span><span>|</span><a href="#39083397">parent</a><span>|</span><a href="#39087177">next</a><span>|</span><label class="collapse" for="c-39084203">[-]</label><label class="expand" for="c-39084203">[2 more]</label></div><br/><div class="children"><div class="content">don&#x27;t bother; the date is on the page</div><br/><div id="39084780" class="c"><input type="checkbox" id="c-39084780" checked=""/><div class="controls bullet"><span class="by">smcin</span><span>|</span><a href="#39083397">root</a><span>|</span><a href="#39084203">parent</a><span>|</span><a href="#39087177">next</a><span>|</span><label class="collapse" for="c-39084780">[-]</label><label class="expand" for="c-39084780">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s helpful to all us readers to note the article is 2 years old.</div><br/></div></div></div></div></div></div><div id="39087177" class="c"><input type="checkbox" id="c-39087177" checked=""/><div class="controls bullet"><span class="by">smackeyacky</span><span>|</span><a href="#39083397">prev</a><span>|</span><label class="collapse" for="c-39087177">[-]</label><label class="expand" for="c-39087177">[1 more]</label></div><br/><div class="children"><div class="content">A fun reminder that Sun charged what they damn pleased for hardware and wasted the money on a party culture and a lot of make-work jobs for their pampered staff.  This is why Linux won.</div><br/></div></div></div></div></div></div></div></body></html>