<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1694250058644" as="style"/><link rel="stylesheet" href="styles.css?v=1694250058644"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">Using LD_PRELOAD to cheat, inject features and investigate programs</a>Â <span class="domain">(<a href="https://rafalcieslak.wordpress.com">rafalcieslak.wordpress.com</a>)</span></div><div class="subtext"><span>icyfox</span> | <span>81 comments</span></div><br/><div><div id="37442676" class="c"><input type="checkbox" id="c-37442676" checked=""/><div class="controls bullet"><span class="by">alex_smart</span><span>|</span><a href="#37440698">next</a><span>|</span><label class="collapse" for="c-37442676">[-]</label><label class="expand" for="c-37442676">[2 more]</label></div><br/><div class="children"><div class="content">This reminds me of the first internship I did. It was at an AI based anamoly detection startup. Their pipeline for the biggest client used to run in just under 3 hours, most of which was apparently spent extracting meaningful information from sensor data from a proprietary binary format using a shared library provided by the client. Ran it under perf and found that most of the time was spent calculating a bunch of sines and cosines. Used the LD_PRELOAD trick to log the sine and cosine calls and turns out that we were just calculating the sines and cosines of the same set of angles over and over again literally thousands of times. Wrote a wrapper to cache the values of sines and cosines in a table and return the cached value if it is already calculated and brought the running time of the pipeline to under 15 minutes. Which meant that the data science team could run their experiments and iterate on their model much faster and cheaper. Fun times.</div><br/><div id="37442973" class="c"><input type="checkbox" id="c-37442973" checked=""/><div class="controls bullet"><span class="by">ditsuke</span><span>|</span><a href="#37442676">parent</a><span>|</span><a href="#37440698">next</a><span>|</span><label class="collapse" for="c-37442973">[-]</label><label class="expand" for="c-37442973">[1 more]</label></div><br/><div class="children"><div class="content">Wow, that sounds like a fun place to work at!</div><br/></div></div></div></div><div id="37440698" class="c"><input type="checkbox" id="c-37440698" checked=""/><div class="controls bullet"><span class="by">ben0x539</span><span>|</span><a href="#37442676">prev</a><span>|</span><a href="#37442721">next</a><span>|</span><label class="collapse" for="c-37440698">[-]</label><label class="expand" for="c-37440698">[1 more]</label></div><br/><div class="children"><div class="content">On unixy systems, they put a restriction into Nethack to limit the game&#x27;s &quot;wizard mode&quot; (the fuck-around mode where you can&#x27;t die and just create all kinds of stuff out of thin air, etc) to the <i>unix user</i> with the username &quot;wizard&quot;: <a href="https:&#x2F;&#x2F;nethackwiki.com&#x2F;wiki&#x2F;Wizard_mode#Unix" rel="nofollow noreferrer">https:&#x2F;&#x2F;nethackwiki.com&#x2F;wiki&#x2F;Wizard_mode#Unix</a><p>The wiki describes a bunch of ways around this, but they all seemed kinda finicky and annoying, so instead I LD_PRELOADed a shim that made getpwent(3) or whatever it used always return &quot;wizard&quot; as the user name.</div><br/></div></div><div id="37442721" class="c"><input type="checkbox" id="c-37442721" checked=""/><div class="controls bullet"><span class="by">Slartie</span><span>|</span><a href="#37440698">prev</a><span>|</span><a href="#37439851">next</a><span>|</span><label class="collapse" for="c-37442721">[-]</label><label class="expand" for="c-37442721">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve implemented some sort of &quot;poor man&#x27;s Docker&quot; using LD_PRELOAD, back then in 2011 when Docker wasn&#x27;t a thing. It works by overriding getaddrinfo (IIRC) and capturing name lookups of &quot;localhost&quot;, which are then answered by an IP address that&#x27;s taken from an env variable. The intended use is the parallelization of automated testing of a distributed system: by creating lots of loopback devices with individual IPs and assigning those to test processes (via the LD_PRELOAD hack), I could suddenly test as many instances of the software system next to each other as I wanted, on the same machine (the test machine was some beefy dual-socket server with lots of CPU cores and RAM). Each instance (which consists of clients and several processes that provide server services, thus they&#x27;re by default configured to bind themselves to specific ports on localhost, as it is common for dev and test purposes) would then be able to route its traffic over its own loopback device, and I was spared of having to somehow untangle the server ports of all the different services just in order to be able to parallelize them on a single machine and of the configuration hell that would have come with this. It helped that processes by default inherit the env variables from their parents that spawned them - that made it a lot easier to propagate the preload path and the env variable containing the loopback IP to use. I just had to provide it to the top-most process, basically.<p>Today, one would use Docker for this exact purpose, putting each test run into its own container (or even multiple containers).</div><br/></div></div><div id="37439851" class="c"><input type="checkbox" id="c-37439851" checked=""/><div class="controls bullet"><span class="by">chatmasta</span><span>|</span><a href="#37442721">prev</a><span>|</span><a href="#37439753">next</a><span>|</span><label class="collapse" for="c-37439851">[-]</label><label class="expand" for="c-37439851">[9 more]</label></div><br/><div class="children"><div class="content">Fun fact: proxychains uses LD_PRELOAD [0] to hook the necessary syscalls [1] for setting up a &quot;proxy environment&quot; for the wrapped program, e.g. `connect`, `gethostbyname`, `gethostbyaddr`, etc. (Note this also implies that it could be leaky in some cases when applied to a program that uses alternative syscalls to make an external connection, or a program that is not dynamically linked. I would not recommend depending on proxychains for any sort of opsec, even though it&#x27;s often recommended as such a tool.)<p>[0] <a href="https:&#x2F;&#x2F;github.com&#x2F;haad&#x2F;proxychains&#x2F;blob&#x2F;master&#x2F;src&#x2F;proxychains#L37">https:&#x2F;&#x2F;github.com&#x2F;haad&#x2F;proxychains&#x2F;blob&#x2F;master&#x2F;src&#x2F;proxycha...</a><p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;haad&#x2F;proxychains&#x2F;blob&#x2F;master&#x2F;src&#x2F;libproxychains.c">https:&#x2F;&#x2F;github.com&#x2F;haad&#x2F;proxychains&#x2F;blob&#x2F;master&#x2F;src&#x2F;libproxy...</a></div><br/><div id="37440039" class="c"><input type="checkbox" id="c-37440039" checked=""/><div class="controls bullet"><span class="by">mamikk</span><span>|</span><a href="#37439851">parent</a><span>|</span><a href="#37440560">next</a><span>|</span><label class="collapse" for="c-37440039">[-]</label><label class="expand" for="c-37440039">[4 more]</label></div><br/><div class="children"><div class="content">There are a lot of small utilities which are built upon LD_PRELOAD, for example.<p>- fakeroot: Gives the running program the impression that it is running as root, often used for example for building debian packages. This will let the build script create a directory tree which it believes is owned by root and then when
 that directory tree is packed by tar, tar will also see root as the owner and the .tar-archive will have root as the user&#x2F;group for the files in the final debian package.<p>- faketime: Gives the running program the impression that it is running at some specific time. Usefull for testing code during specific events like leap-years, etc.<p>- eatmydata: Will ignore all fsync() and related system calls which ensures files are written to permanent storage. I have used this once for running a database during a testsuite, and databases are much faster when they do not have to wait for the data to reach permanent storage.</div><br/><div id="37440749" class="c"><input type="checkbox" id="c-37440749" checked=""/><div class="controls bullet"><span class="by">sltkr</span><span>|</span><a href="#37439851">root</a><span>|</span><a href="#37440039">parent</a><span>|</span><a href="#37440091">next</a><span>|</span><label class="collapse" for="c-37440749">[-]</label><label class="expand" for="c-37440749">[1 more]</label></div><br/><div class="children"><div class="content">My favorite tool that (ab)uses LD_PRELOAD to do something useful is `stdbuf`: <a href="https:&#x2F;&#x2F;linux.die.net&#x2F;man&#x2F;1&#x2F;stdbuf" rel="nofollow noreferrer">https:&#x2F;&#x2F;linux.die.net&#x2F;man&#x2F;1&#x2F;stdbuf</a><p>The implementation is completely bonkers. The tool sets some environmental variables, then spawns a child process with LD_PRELOAD set to load a library (libstdbuf.so) which has a some initialization code that runs when the library is loaded, and that based on the environmental variables, calls setvbuf() from inside the child process to override the buffering behavior.</div><br/></div></div><div id="37440091" class="c"><input type="checkbox" id="c-37440091" checked=""/><div class="controls bullet"><span class="by">a-dub</span><span>|</span><a href="#37439851">root</a><span>|</span><a href="#37440039">parent</a><span>|</span><a href="#37440749">prev</a><span>|</span><a href="#37440555">next</a><span>|</span><label class="collapse" for="c-37440091">[-]</label><label class="expand" for="c-37440091">[1 more]</label></div><br/><div class="children"><div class="content">tsocks: route all network traffic through a socks gateway with elegant per-process controls.  (i guess a proxychains ancestor?)</div><br/></div></div><div id="37440555" class="c"><input type="checkbox" id="c-37440555" checked=""/><div class="controls bullet"><span class="by">snarg</span><span>|</span><a href="#37439851">root</a><span>|</span><a href="#37440039">parent</a><span>|</span><a href="#37440091">prev</a><span>|</span><a href="#37440560">next</a><span>|</span><label class="collapse" for="c-37440555">[-]</label><label class="expand" for="c-37440555">[1 more]</label></div><br/><div class="children"><div class="content">libnaw uses it to wrap and authenticate connect() and accept() calls.<p>frida uses it to wrap and inject... anything.<p>These programs have all been around for quite a long time.  I think libnaw has been around since early 2000s at least.</div><br/></div></div></div></div><div id="37440560" class="c"><input type="checkbox" id="c-37440560" checked=""/><div class="controls bullet"><span class="by">Denvercoder9</span><span>|</span><a href="#37439851">parent</a><span>|</span><a href="#37440039">prev</a><span>|</span><a href="#37439946">next</a><span>|</span><label class="collapse" for="c-37440560">[-]</label><label class="expand" for="c-37440560">[3 more]</label></div><br/><div class="children"><div class="content">&gt; proxychains uses LD_PRELOAD [0] to hook the necessary syscalls [1]<p>Technically, it uses LD_PRELOAD to hook the necessary <i>libc</i> functions. As, at least on x86-64, a syscall is just a CPU instruction like any other, you can&#x27;t hook into it through LD_PRELOAD or any other tricks that don&#x27;t involve the kernel (apart from rewriting the program before you execute it). That&#x27;s also why it doesn&#x27;t work on e.g. Go programs, as they don&#x27;t use libc.</div><br/><div id="37440977" class="c"><input type="checkbox" id="c-37440977" checked=""/><div class="controls bullet"><span class="by">jcranmer</span><span>|</span><a href="#37439851">root</a><span>|</span><a href="#37440560">parent</a><span>|</span><a href="#37439946">next</a><span>|</span><label class="collapse" for="c-37440977">[-]</label><label class="expand" for="c-37440977">[2 more]</label></div><br/><div class="children"><div class="content">&gt; As, at least on x86-64, a syscall is just a CPU instruction like any other, you can&#x27;t hook into it through LD_PRELOAD or any other tricks that don&#x27;t involve the kernel (apart from rewriting the program before you execute it).<p>On most Unix systems, you can use ptrace to intercept system calls from another process. This is how tools like rr or strace work.</div><br/><div id="37442312" class="c"><input type="checkbox" id="c-37442312" checked=""/><div class="controls bullet"><span class="by">westurner</span><span>|</span><a href="#37439851">root</a><span>|</span><a href="#37440977">parent</a><span>|</span><a href="#37439946">next</a><span>|</span><label class="collapse" for="c-37442312">[-]</label><label class="expand" for="c-37442312">[1 more]</label></div><br/><div class="children"><div class="content">Ptrace is one of a number of ways to hook syscalls without LD_PRELOAD.<p>The gVisor docs list 3 ways: KVM, systrap, ptrace
<a href="https:&#x2F;&#x2F;gvisor.dev&#x2F;docs&#x2F;architecture_guide&#x2F;platforms&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;gvisor.dev&#x2F;docs&#x2F;architecture_guide&#x2F;platforms&#x2F;</a> :<p>&gt; systrap: <i>The systrap platform relies seccompâs SECCOMP_RET_TRAP feature in order to intercept system calls. This makes the kernel send SIGSYS to the triggering thread, which hands over control to gVisor to handle the system call. For more details, please see the systrap README file.</i><p>&gt; <i>systrap replaced ptrace as the default gVisor platform in mid-2023. If you depend on ptrace, and systrap doesnât fulfill your needs, please voice your feedback.</i><p>&gt; ptrace: <i>The ptrace platform uses PTRACE_SYSEMU to execute user code without allowing it to execute host system calls. This platform can run anywhere that ptrace works (even VMs without nested virtualization), which is ubiquitous.</i><p>&gt; <i>Unfortunately, the ptrace platform has high context switch overhead, so system call-heavy applications may pay a performance penalty. For this reason, systrap is almost always the better choice.</i><p>The Falco docs list 3 syscall event drivers: Kernel module, Classic eBPF probe, and Modern eBPF probe: 
<a href="https:&#x2F;&#x2F;falco.org&#x2F;docs&#x2F;event-sources&#x2F;kernel&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;falco.org&#x2F;docs&#x2F;event-sources&#x2F;kernel&#x2F;</a><p>Dynamic linker &gt; Systems using ELF: 
<a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Dynamic_linker#Systems_using_ELF" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Dynamic_linker#Systems_using_E...</a></div><br/></div></div></div></div></div></div><div id="37439946" class="c"><input type="checkbox" id="c-37439946" checked=""/><div class="controls bullet"><span class="by">autumn-antlers</span><span>|</span><a href="#37439851">parent</a><span>|</span><a href="#37440560">prev</a><span>|</span><a href="#37439753">next</a><span>|</span><label class="collapse" for="c-37439946">[-]</label><label class="expand" for="c-37439946">[1 more]</label></div><br/><div class="children"><div class="content">The tup[1] build system also uses ldpreload injection as an aspect of its (additionally(?) FUSE-based) dependency-specification enforcement.<p>1: <a href="https:&#x2F;&#x2F;github.com&#x2F;gittup&#x2F;tup&#x2F;blob&#x2F;master&#x2F;src&#x2F;ldpreload&#x2F;ldpreload.c">https:&#x2F;&#x2F;github.com&#x2F;gittup&#x2F;tup&#x2F;blob&#x2F;master&#x2F;src&#x2F;ldpreload&#x2F;ldpr...</a></div><br/></div></div></div></div><div id="37439753" class="c"><input type="checkbox" id="c-37439753" checked=""/><div class="controls bullet"><span class="by">ghotli</span><span>|</span><a href="#37439851">prev</a><span>|</span><a href="#37439842">next</a><span>|</span><label class="collapse" for="c-37439753">[-]</label><label class="expand" for="c-37439753">[27 more]</label></div><br/><div class="children"><div class="content">Worth mentioning that statically linked binaries prevent this attack vector. I won&#x27;t weigh in on dynamic vs static in general but if you&#x27;re shipping something you don&#x27;t want fiddled with then maybe dynamic linking isn&#x27;t what you&#x27;re looking for.<p>My favorite nasty hack along these lines was to inject a new implementation of gethostname via LD_PRELOAD as the simplest path to prevent a CI server from surfacing a hostname in a place it shouldn&#x27;t be.</div><br/><div id="37441270" class="c"><input type="checkbox" id="c-37441270" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37439753">parent</a><span>|</span><a href="#37440252">next</a><span>|</span><label class="collapse" for="c-37441270">[-]</label><label class="expand" for="c-37441270">[5 more]</label></div><br/><div class="children"><div class="content">This is not an attack vector and not something programs should try to protect against. If attackers have control to the point that they can run a program with LD_PRELOAD, they&#x27;ve already won.</div><br/><div id="37442340" class="c"><input type="checkbox" id="c-37442340" checked=""/><div class="controls bullet"><span class="by">yonatan8070</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37441270">parent</a><span>|</span><a href="#37441303">next</a><span>|</span><label class="collapse" for="c-37442340">[-]</label><label class="expand" for="c-37442340">[3 more]</label></div><br/><div class="children"><div class="content">There are cases where developers need to protect software from a local user with root access, like DRM related software, games that want to defend against pirates, etc.</div><br/><div id="37442500" class="c"><input type="checkbox" id="c-37442500" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37442340">parent</a><span>|</span><a href="#37442398">next</a><span>|</span><label class="collapse" for="c-37442500">[-]</label><label class="expand" for="c-37442500">[1 more]</label></div><br/><div class="children"><div class="content">Those use cases are inherently evil, and the rest of us should go out of our way to make them impossible, or at least as difficult as possible. A local user with root access should always have full control over everything, regardless of the wishes of any hardware manufacturers or software developers.</div><br/></div></div><div id="37442398" class="c"><input type="checkbox" id="c-37442398" checked=""/><div class="controls bullet"><span class="by">ronsor</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37442340">parent</a><span>|</span><a href="#37442500">prev</a><span>|</span><a href="#37441303">next</a><span>|</span><label class="collapse" for="c-37442398">[-]</label><label class="expand" for="c-37442398">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s more of a <i>want</i> than a need.</div><br/></div></div></div></div><div id="37441303" class="c"><input type="checkbox" id="c-37441303" checked=""/><div class="controls bullet"><span class="by">ghotli</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37441270">parent</a><span>|</span><a href="#37442340">prev</a><span>|</span><a href="#37440252">next</a><span>|</span><label class="collapse" for="c-37441303">[-]</label><label class="expand" for="c-37441303">[1 more]</label></div><br/><div class="children"><div class="content">Won on that node, agreed. I suppose I meant the &#x27;investigate programs&#x27; part of the title and if that aids in garnering info for attacking something it interacts with.<p>But of course it&#x27;s all splitting hairs. A sufficiently dedicated &#x2F; motivated &#x2F; funded person can investigate even the most hardened static position independent binary. Dynamic linking with LD_PRELOAD is like propping the front door open in comparison.</div><br/></div></div></div></div><div id="37440252" class="c"><input type="checkbox" id="c-37440252" checked=""/><div class="controls bullet"><span class="by">vhcr</span><span>|</span><a href="#37439753">parent</a><span>|</span><a href="#37441270">prev</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37440252">[-]</label><label class="expand" for="c-37440252">[12 more]</label></div><br/><div class="children"><div class="content">If you&#x27;re shipping something you don&#x27;t want fiddled with, don&#x27;t ship it, because it&#x27;s an impossible task.</div><br/><div id="37442534" class="c"><input type="checkbox" id="c-37442534" checked=""/><div class="controls bullet"><span class="by">SkyPuncher</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440252">parent</a><span>|</span><a href="#37440405">next</a><span>|</span><label class="collapse" for="c-37442534">[-]</label><label class="expand" for="c-37442534">[3 more]</label></div><br/><div class="children"><div class="content">I guess the entire world of online multiplayer games becomes hacker haven.</div><br/><div id="37443410" class="c"><input type="checkbox" id="c-37443410" checked=""/><div class="controls bullet"><span class="by">themoonisachees</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37442534">parent</a><span>|</span><a href="#37443452">next</a><span>|</span><label class="collapse" for="c-37443410">[-]</label><label class="expand" for="c-37443410">[1 more]</label></div><br/><div class="children"><div class="content">Well, it is. Most popular online games have a large amount of cheaters.</div><br/></div></div><div id="37443452" class="c"><input type="checkbox" id="c-37443452" checked=""/><div class="controls bullet"><span class="by">KeplerBoy</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37442534">parent</a><span>|</span><a href="#37443410">prev</a><span>|</span><a href="#37440405">next</a><span>|</span><label class="collapse" for="c-37443452">[-]</label><label class="expand" for="c-37443452">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s a big selling point of cloud gaming.</div><br/></div></div></div></div><div id="37440405" class="c"><input type="checkbox" id="c-37440405" checked=""/><div class="controls bullet"><span class="by">ghotli</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440252">parent</a><span>|</span><a href="#37442534">prev</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37440405">[-]</label><label class="expand" for="c-37440405">[8 more]</label></div><br/><div class="children"><div class="content">Sure. We agree. Cat and mouse. Can you help me understand what value you&#x27;re adding to the discussion though? Low hanging fruit arguments based on semantics might be best suited elsewhere</div><br/><div id="37440768" class="c"><input type="checkbox" id="c-37440768" checked=""/><div class="controls bullet"><span class="by">ed_mercer</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440405">parent</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37440768">[-]</label><label class="expand" for="c-37440768">[7 more]</label></div><br/><div class="children"><div class="content">He&#x2F;she is mentioning that an obtained client can always be hacked, no matter what, and the reader of the original comment may not realize that.</div><br/><div id="37440794" class="c"><input type="checkbox" id="c-37440794" checked=""/><div class="controls bullet"><span class="by">sosodev</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440768">parent</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37440794">[-]</label><label class="expand" for="c-37440794">[6 more]</label></div><br/><div class="children"><div class="content">I think the vast majority of HN users would realize that. Is it important for the few that donât? Perhaps</div><br/><div id="37441709" class="c"><input type="checkbox" id="c-37441709" checked=""/><div class="controls bullet"><span class="by">GreymanTheGrey</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440794">parent</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37441709">[-]</label><label class="expand" for="c-37441709">[5 more]</label></div><br/><div class="children"><div class="content">The original commenter clearly didn&#x27;t understand it, since they asserted that &quot;statically linked libraries prevent this attack vector&quot;.<p>Which is unambiguously not the case, they merely slow it down by a small margin.</div><br/><div id="37442925" class="c"><input type="checkbox" id="c-37442925" checked=""/><div class="controls bullet"><span class="by">alex_smart</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37441709">parent</a><span>|</span><a href="#37442067">next</a><span>|</span><label class="collapse" for="c-37442925">[-]</label><label class="expand" for="c-37442925">[2 more]</label></div><br/><div class="children"><div class="content">&gt;Which is unambiguously not the case, they merely slow it down by a small margin.<p>When you are using shared libaries, it is fairly trivial to hook into the library calls and replace them with whatever you want. When you are using static libraries, the linker and optimizer could for example inline the machine code directly in the application code. What tools do you have to do similar tricks with statically compiled binaries?</div><br/><div id="37443458" class="c"><input type="checkbox" id="c-37443458" checked=""/><div class="controls bullet"><span class="by">KeplerBoy</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37442925">parent</a><span>|</span><a href="#37442067">next</a><span>|</span><label class="collapse" for="c-37443458">[-]</label><label class="expand" for="c-37443458">[1 more]</label></div><br/><div class="children"><div class="content">messing with executable binaries is undoubtedly harder but not impossible.</div><br/></div></div></div></div><div id="37442067" class="c"><input type="checkbox" id="c-37442067" checked=""/><div class="controls bullet"><span class="by">arp242</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37441709">parent</a><span>|</span><a href="#37442925">prev</a><span>|</span><a href="#37441849">next</a><span>|</span><label class="collapse" for="c-37442067">[-]</label><label class="expand" for="c-37442067">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a true statement; LD_PRELOAD cannot be used with statically linked binaries. You can &quot;fiddle&quot; in other ways, but not by using the LD_PRELOAD attack vector (although personally I wouldn&#x27;t call it an &quot;attack vector&quot;, although in some cases it could be where you can upload a malicious file and control the environment of another program somehow, or something along those lines).</div><br/></div></div><div id="37441849" class="c"><input type="checkbox" id="c-37441849" checked=""/><div class="controls bullet"><span class="by">LoganDark</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37441709">parent</a><span>|</span><a href="#37442067">prev</a><span>|</span><a href="#37441565">next</a><span>|</span><label class="collapse" for="c-37441849">[-]</label><label class="expand" for="c-37441849">[1 more]</label></div><br/><div class="children"><div class="content">LD_PRELOAD is the specific attack vector that is prevented by static linking. They made no claim that static linking prevents all forms of tampering.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="37441565" class="c"><input type="checkbox" id="c-37441565" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#37439753">parent</a><span>|</span><a href="#37440252">prev</a><span>|</span><a href="#37439802">next</a><span>|</span><label class="collapse" for="c-37441565">[-]</label><label class="expand" for="c-37441565">[1 more]</label></div><br/><div class="children"><div class="content"><i>to prevent a CI server from surfacing a hostname in a place it shouldn&#x27;t be</i><p>I had to deal with the same problem a few years ago, and used the exact same solution.</div><br/></div></div><div id="37439802" class="c"><input type="checkbox" id="c-37439802" checked=""/><div class="controls bullet"><span class="by">klysm</span><span>|</span><a href="#37439753">parent</a><span>|</span><a href="#37441565">prev</a><span>|</span><a href="#37439842">next</a><span>|</span><label class="collapse" for="c-37439802">[-]</label><label class="expand" for="c-37439802">[8 more]</label></div><br/><div class="children"><div class="content">I think this is a great entrypoint into the static&#x2F;dynamic argument and I&#x27;d love to argue with some people about it. I believe dynamic used to make sense but no longer does in the vast majority of cases. Static binaries have their costs, but are so much easier to reason about.</div><br/><div id="37440651" class="c"><input type="checkbox" id="c-37440651" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37439802">parent</a><span>|</span><a href="#37439913">next</a><span>|</span><label class="collapse" for="c-37440651">[-]</label><label class="expand" for="c-37440651">[1 more]</label></div><br/><div class="children"><div class="content">This is a really silly entrypoint into the static&#x2F;dynamic argument. Static linking does not protect anything here, only makes it harder for developers.</div><br/></div></div><div id="37439913" class="c"><input type="checkbox" id="c-37439913" checked=""/><div class="controls bullet"><span class="by">kreetx</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37439802">parent</a><span>|</span><a href="#37440651">prev</a><span>|</span><a href="#37439842">next</a><span>|</span><label class="collapse" for="c-37439913">[-]</label><label class="expand" for="c-37439913">[6 more]</label></div><br/><div class="children"><div class="content">If dynamic libraries are compatible to what they did (when you developed the program) then why waste disk and RAM?</div><br/><div id="37439943" class="c"><input type="checkbox" id="c-37439943" checked=""/><div class="controls bullet"><span class="by">aidenn0</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37439913">parent</a><span>|</span><a href="#37439842">next</a><span>|</span><label class="collapse" for="c-37439943">[-]</label><label class="expand" for="c-37439943">[5 more]</label></div><br/><div class="children"><div class="content">Because disk and RAM are cheap and that&#x27;s a <i>huge</i> &quot;If&quot;</div><br/><div id="37440986" class="c"><input type="checkbox" id="c-37440986" checked=""/><div class="controls bullet"><span class="by">jonhohle</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37439943">parent</a><span>|</span><a href="#37443174">next</a><span>|</span><label class="collapse" for="c-37440986">[-]</label><label class="expand" for="c-37440986">[2 more]</label></div><br/><div class="children"><div class="content">Thereâs also other security considerations. As an operator or builder, do you want to patch a library (say OpenSSL) to keep your system up to date or patch every binary. If changing a dependency requires rebuilding all consumers recursively, the thereâs not a huge benefit.</div><br/><div id="37441789" class="c"><input type="checkbox" id="c-37441789" checked=""/><div class="controls bullet"><span class="by">aidenn0</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37440986">parent</a><span>|</span><a href="#37443174">next</a><span>|</span><label class="collapse" for="c-37441789">[-]</label><label class="expand" for="c-37441789">[1 more]</label></div><br/><div class="children"><div class="content">I think in the specific case of security issues, more bugs have been fixed by upgrading dynamic dependencies than introduced. That&#x27;s just my gut feeling though, and I&#x27;d like to see data.</div><br/></div></div></div></div><div id="37443174" class="c"><input type="checkbox" id="c-37443174" checked=""/><div class="controls bullet"><span class="by">selfhoster11</span><span>|</span><a href="#37439753">root</a><span>|</span><a href="#37439943">parent</a><span>|</span><a href="#37440986">prev</a><span>|</span><a href="#37440846">next</a><span>|</span><label class="collapse" for="c-37443174">[-]</label><label class="expand" for="c-37443174">[1 more]</label></div><br/><div class="children"><div class="content">Only cheap if you&#x27;re running on huge servers. End user machines and edge compute are more constrained, so one needs to be more polite with resource use there.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="37439842" class="c"><input type="checkbox" id="c-37439842" checked=""/><div class="controls bullet"><span class="by">pedrovhb</span><span>|</span><a href="#37439753">prev</a><span>|</span><a href="#37443096">next</a><span>|</span><label class="collapse" for="c-37439842">[-]</label><label class="expand" for="c-37439842">[2 more]</label></div><br/><div class="children"><div class="content">A great framework for doing something along those lines is Frida (<a href="https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida">https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida</a>). Works on a bunch of stuff, including Android and iOS. Some global-ish certificate pinning bypasses work through Frida, by patching http libraries to not raise exceptions, accept system certificates, etc and just quietly hum along instead. Certificate unpinning in turn enables network MITM with mitmproxy, which makes it a lot quicker and easier to inspect, block, or modify network traffic.<p>Funnily enough, I&#x27;ve seen much stronger obfuscation from reverse engineering from my cheap Tuya IoT devices app than from my bank app.</div><br/><div id="37441862" class="c"><input type="checkbox" id="c-37441862" checked=""/><div class="controls bullet"><span class="by">LoganDark</span><span>|</span><a href="#37439842">parent</a><span>|</span><a href="#37443096">next</a><span>|</span><label class="collapse" for="c-37441862">[-]</label><label class="expand" for="c-37441862">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Funnily enough, I&#x27;ve seen much stronger obfuscation from reverse engineering from my cheap Tuya IoT devices app than from my bank app.<p>IMHO, if the client-side of an IoT service is obfuscated, I&#x27;d take that as a sign that they&#x27;re trying to hide some really insecure API endpoints.</div><br/></div></div></div></div><div id="37443096" class="c"><input type="checkbox" id="c-37443096" checked=""/><div class="controls bullet"><span class="by">anonymousDan</span><span>|</span><a href="#37439842">prev</a><span>|</span><a href="#37440961">next</a><span>|</span><label class="collapse" for="c-37443096">[-]</label><label class="expand" for="c-37443096">[1 more]</label></div><br/><div class="children"><div class="content">On a related note, I recently came across this ingenious high-performance technique for system call hooking: <a href="https:&#x2F;&#x2F;www.usenix.org&#x2F;conference&#x2F;atc23&#x2F;presentation&#x2F;yasukata" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.usenix.org&#x2F;conference&#x2F;atc23&#x2F;presentation&#x2F;yasukat...</a></div><br/></div></div><div id="37440961" class="c"><input type="checkbox" id="c-37440961" checked=""/><div class="controls bullet"><span class="by">coppsilgold</span><span>|</span><a href="#37443096">prev</a><span>|</span><a href="#37442952">next</a><span>|</span><label class="collapse" for="c-37440961">[-]</label><label class="expand" for="c-37440961">[2 more]</label></div><br/><div class="children"><div class="content">LD_PRELOAD relies on a naive target. A target can be crafted to bypass LD_PRELOAD - it can be as simple as statically linking the target. Also, dynamically linked targets are not guaranteed to be naive. The target can still directly issue syscalls that LD_PRELOAD was intended to interdict (by displacing a higher level function in a library).<p>ptrace or SECCOMP_RET_TRAP can be used to do syscall interception. But that would be somewhat complex in comparison to the ease of use of LD_PRELOAD.<p>gVisor[1] is a project which intercepts every syscall with the method above and services the syscall by itself (no passthrough) for the purpose of sandboxing.<p>You can also use eBPF to audit and meddle with syscalls.<p>[1] <a href="https:&#x2F;&#x2F;gvisor.dev&#x2F;blog&#x2F;2023&#x2F;04&#x2F;28&#x2F;systrap-release&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;gvisor.dev&#x2F;blog&#x2F;2023&#x2F;04&#x2F;28&#x2F;systrap-release&#x2F;</a></div><br/><div id="37441154" class="c"><input type="checkbox" id="c-37441154" checked=""/><div class="controls bullet"><span class="by">skitter</span><span>|</span><a href="#37440961">parent</a><span>|</span><a href="#37442952">next</a><span>|</span><label class="collapse" for="c-37441154">[-]</label><label class="expand" for="c-37441154">[1 more]</label></div><br/><div class="children"><div class="content">Similarly ldd â which is mentioned in the article â works by setting LD_TRACE_LOADED_OBJECTS, which then gets picked up by Linux&#x27;s dynamic linker, so any program that doesn&#x27;t use it can just do whatever instead.</div><br/></div></div></div></div><div id="37442952" class="c"><input type="checkbox" id="c-37442952" checked=""/><div class="controls bullet"><span class="by">H8crilA</span><span>|</span><a href="#37440961">prev</a><span>|</span><a href="#37441339">next</a><span>|</span><label class="collapse" for="c-37442952">[-]</label><label class="expand" for="c-37442952">[1 more]</label></div><br/><div class="children"><div class="content">Inspecting library calls has been automated in `ltrace`. It works like ptrace, but tracks all dynamic symbol calls instead of all syscalls. Making your own LD_PRELOAD takes more time. Though it is more flexible.<p>LD_PRELOAD can also be used to turn an executable binary into a library. You have to intercept __libc_start_main(), provide your own custom main(), then call whatever functions from the binary your heart desires. You may need to use raw function addresses taken from some IDA or other Ghidra, as the binary is not required to export symbols.</div><br/></div></div><div id="37441339" class="c"><input type="checkbox" id="c-37441339" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#37442952">prev</a><span>|</span><a href="#37440692">next</a><span>|</span><label class="collapse" for="c-37441339">[-]</label><label class="expand" for="c-37441339">[1 more]</label></div><br/><div class="children"><div class="content">Interesting blog post by Fangrui Song &quot;ELF interposition and -Bsymbolic&quot; [1] - talks about the real world cost of this feature that&#x27;s imposed by ELF. On one hand it enables incredible extensibility, OTOH codegen is obligated to be pessimistic about resolving symbols.<p>[1]<a href="https:&#x2F;&#x2F;maskray.me&#x2F;blog&#x2F;2021-05-16-elf-interposition-and-bsymbolic" rel="nofollow noreferrer">https:&#x2F;&#x2F;maskray.me&#x2F;blog&#x2F;2021-05-16-elf-interposition-and-bsy...</a></div><br/></div></div><div id="37440692" class="c"><input type="checkbox" id="c-37440692" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#37441339">prev</a><span>|</span><a href="#37443033">next</a><span>|</span><label class="collapse" for="c-37440692">[-]</label><label class="expand" for="c-37440692">[1 more]</label></div><br/><div class="children"><div class="content">On Windows, you can start a process suspended, then inject a DLL into it before the entry point even loads.  That DLL can basically do anything to override the behavior of the program.</div><br/></div></div><div id="37443033" class="c"><input type="checkbox" id="c-37443033" checked=""/><div class="controls bullet"><span class="by">egberts1</span><span>|</span><a href="#37440692">prev</a><span>|</span><a href="#37442070">next</a><span>|</span><label class="collapse" for="c-37443033">[-]</label><label class="expand" for="c-37443033">[1 more]</label></div><br/><div class="children"><div class="content">Use libmusl instead of libc, and LD_PRELOAD becomes no more; enough said.<p><a href="https:&#x2F;&#x2F;www.musl-libc.org&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.musl-libc.org&#x2F;</a></div><br/></div></div><div id="37442070" class="c"><input type="checkbox" id="c-37442070" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#37443033">prev</a><span>|</span><a href="#37440538">next</a><span>|</span><label class="collapse" for="c-37442070">[-]</label><label class="expand" for="c-37442070">[1 more]</label></div><br/><div class="children"><div class="content">Another use of LD_PRELOAD is to alter the shared object loading order. This is particularly useful for working around TLS shortage from shared objects [1].<p>[1] E.g. <a href="https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1722181" rel="nofollow noreferrer">https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1722181</a></div><br/></div></div><div id="37440538" class="c"><input type="checkbox" id="c-37440538" checked=""/><div class="controls bullet"><span class="by">alaxapta7</span><span>|</span><a href="#37442070">prev</a><span>|</span><a href="#37439660">next</a><span>|</span><label class="collapse" for="c-37440538">[-]</label><label class="expand" for="c-37440538">[1 more]</label></div><br/><div class="children"><div class="content">I used LD_PRELOAD for patching RCE vulnerability in PunkBuster[0]. They did patch the exploit, but that didn&#x27;t involve many of the older games they dropped support for. The AC itself isn&#x27;t effective or even operational for the most part in those, but it still serves as a reliable method of identifying players.<p>Even their server libraries are obfuscated, and hooking open() turned out to be just easier than trying to patch the binaries themselves.<p>[0] <a href="https:&#x2F;&#x2F;medium.com&#x2F;@prizmant&#x2F;hacking-punkbuster-e22e6cf2f36e" rel="nofollow noreferrer">https:&#x2F;&#x2F;medium.com&#x2F;@prizmant&#x2F;hacking-punkbuster-e22e6cf2f36e</a></div><br/></div></div><div id="37439660" class="c"><input type="checkbox" id="c-37439660" checked=""/><div class="controls bullet"><span class="by">ale42</span><span>|</span><a href="#37440538">prev</a><span>|</span><a href="#37440423">next</a><span>|</span><label class="collapse" for="c-37439660">[-]</label><label class="expand" for="c-37439660">[2 more]</label></div><br/><div class="children"><div class="content">This feature is used since ages by sudo to implement the noexec option, to prevent dynamically linked executables from executing further programs. At some point I took advantage of this (sudo allows specifying a custom .so file for the noexec function) to implement other restrictions in programs run by sudo (of course, there are always ways to go around them).</div><br/><div id="37440597" class="c"><input type="checkbox" id="c-37440597" checked=""/><div class="controls bullet"><span class="by">Denvercoder9</span><span>|</span><a href="#37439660">parent</a><span>|</span><a href="#37440423">next</a><span>|</span><label class="collapse" for="c-37440597">[-]</label><label class="expand" for="c-37440597">[1 more]</label></div><br/><div class="children"><div class="content">Nowadays sudo uses seccomp filtering for its noexec option, which is enforced by the kernel and does not allow the workarounds that userspace-based solutions (including LD_PRELOAD) have.</div><br/></div></div></div></div><div id="37440423" class="c"><input type="checkbox" id="c-37440423" checked=""/><div class="controls bullet"><span class="by">spc476</span><span>|</span><a href="#37439660">prev</a><span>|</span><a href="#37440570">next</a><span>|</span><label class="collapse" for="c-37440423">[-]</label><label class="expand" for="c-37440423">[1 more]</label></div><br/><div class="children"><div class="content">I used LD_PRELOAD to test system call failure code paths in a program (<a href="https:&#x2F;&#x2F;boston.conman.org&#x2F;2022&#x2F;12&#x2F;21.1" rel="nofollow noreferrer">https:&#x2F;&#x2F;boston.conman.org&#x2F;2022&#x2F;12&#x2F;21.1</a>) that would otherwise be difficult to test.</div><br/></div></div><div id="37440570" class="c"><input type="checkbox" id="c-37440570" checked=""/><div class="controls bullet"><span class="by">quags</span><span>|</span><a href="#37440423">prev</a><span>|</span><a href="#37439757">next</a><span>|</span><label class="collapse" for="c-37440570">[-]</label><label class="expand" for="c-37440570">[2 more]</label></div><br/><div class="children"><div class="content">The first security program I remember when I started playing with Linux around 99 was called libsafe which used ld preload to intercept calls on the fly to prevent buffer overflows.</div><br/><div id="37440669" class="c"><input type="checkbox" id="c-37440669" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#37440570">parent</a><span>|</span><a href="#37439757">next</a><span>|</span><label class="collapse" for="c-37440669">[-]</label><label class="expand" for="c-37440669">[1 more]</label></div><br/><div class="children"><div class="content">Windows has &quot;Application Verifier&quot; which can turn out-of-bounds writes that are past the end of memory into access violation exceptions.</div><br/></div></div></div></div><div id="37439757" class="c"><input type="checkbox" id="c-37439757" checked=""/><div class="controls bullet"><span class="by">zX41ZdbW</span><span>|</span><a href="#37440570">prev</a><span>|</span><a href="#37442164">next</a><span>|</span><label class="collapse" for="c-37439757">[-]</label><label class="expand" for="c-37439757">[19 more]</label></div><br/><div class="children"><div class="content">In ClickHouse, we forbid LD_PRELOAD and every similar variable: <a href="https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;blob&#x2F;master&#x2F;programs&#x2F;main.cpp#L336">https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;blob&#x2F;master&#x2F;program...</a><p>We also forbid dlopen - so even if some third-party library commits such an offense, it will be blocked: <a href="https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;blob&#x2F;master&#x2F;programs&#x2F;main.cpp#L410">https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;blob&#x2F;master&#x2F;program...</a></div><br/><div id="37440126" class="c"><input type="checkbox" id="c-37440126" checked=""/><div class="controls bullet"><span class="by">blibble</span><span>|</span><a href="#37439757">parent</a><span>|</span><a href="#37440026">next</a><span>|</span><label class="collapse" for="c-37440126">[-]</label><label class="expand" for="c-37440126">[1 more]</label></div><br/><div class="children"><div class="content">that&#x27;s not going to block anyone who understands anything about how the dynamic loader works<p><pre><code>   &#x2F;lib64&#x2F;ld-linux-x86-64.so.2 --preload myevil.so .&#x2F;your_program
</code></pre>
there we go, bypassed</div><br/></div></div><div id="37440026" class="c"><input type="checkbox" id="c-37440026" checked=""/><div class="controls bullet"><span class="by">bdowling</span><span>|</span><a href="#37439757">parent</a><span>|</span><a href="#37440126">prev</a><span>|</span><a href="#37439846">next</a><span>|</span><label class="collapse" for="c-37440026">[-]</label><label class="expand" for="c-37440026">[5 more]</label></div><br/><div class="children"><div class="content">Why can&#x27;t an attacker just link a new getenv() that pretends that LD_PRELOAD and other variables aren&#x27;t set?</div><br/><div id="37440298" class="c"><input type="checkbox" id="c-37440298" checked=""/><div class="controls bullet"><span class="by">zX41ZdbW</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440026">parent</a><span>|</span><a href="#37440263">next</a><span>|</span><label class="collapse" for="c-37440298">[-]</label><label class="expand" for="c-37440298">[2 more]</label></div><br/><div class="children"><div class="content">It is mostly to protect from unusual configurations rather than protecting from an attacker, e.g.,
<a href="https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;issues&#x2F;43933">https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;issues&#x2F;43933</a> and <a href="https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;issues&#x2F;10505">https:&#x2F;&#x2F;github.com&#x2F;ClickHouse&#x2F;ClickHouse&#x2F;issues&#x2F;10505</a></div><br/><div id="37441242" class="c"><input type="checkbox" id="c-37441242" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440298">parent</a><span>|</span><a href="#37440263">next</a><span>|</span><label class="collapse" for="c-37441242">[-]</label><label class="expand" for="c-37441242">[1 more]</label></div><br/><div class="children"><div class="content">It almost seems like it gives credence to self-inflicted problems by implementing changes like that.<p>The creativity of people to break things by misusing them is unbound. Fix your bugs, fix non-bugs that seem like &quot;foreseeable misuse&quot;. Don&#x27;t fix &quot;my users are in outer space&quot; non-bugs.</div><br/></div></div></div></div><div id="37440263" class="c"><input type="checkbox" id="c-37440263" checked=""/><div class="controls bullet"><span class="by">vhcr</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440026">parent</a><span>|</span><a href="#37440298">prev</a><span>|</span><a href="#37440103">next</a><span>|</span><label class="collapse" for="c-37440263">[-]</label><label class="expand" for="c-37440263">[1 more]</label></div><br/><div class="children"><div class="content">You could also modify the source code to remove the check, I&#x27;m guessing this is just for people that are accidentally setting LD_PRELOAD.</div><br/></div></div><div id="37440103" class="c"><input type="checkbox" id="c-37440103" checked=""/><div class="controls bullet"><span class="by">a-dub</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440026">parent</a><span>|</span><a href="#37440263">prev</a><span>|</span><a href="#37439846">next</a><span>|</span><label class="collapse" for="c-37440103">[-]</label><label class="expand" for="c-37440103">[1 more]</label></div><br/><div class="children"><div class="content">LOL</div><br/></div></div></div></div><div id="37439846" class="c"><input type="checkbox" id="c-37439846" checked=""/><div class="controls bullet"><span class="by">lgg</span><span>|</span><a href="#37439757">parent</a><span>|</span><a href="#37440026">prev</a><span>|</span><a href="#37439819">next</a><span>|</span><label class="collapse" for="c-37439846">[-]</label><label class="expand" for="c-37439846">[3 more]</label></div><br/><div class="children"><div class="content">This is awesome. macOS actually enables the same env var protections by default if your process is opted into the hardened runtime. You can do that by passing â-options=runtime to your codesign invocation.</div><br/><div id="37441292" class="c"><input type="checkbox" id="c-37441292" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37439846">parent</a><span>|</span><a href="#37439819">next</a><span>|</span><label class="collapse" for="c-37441292">[-]</label><label class="expand" for="c-37441292">[2 more]</label></div><br/><div class="children"><div class="content">What&#x27;s the easiest way to use those variables anyway on a binary that&#x27;s been compiled that way? Does it need SIP to be off?</div><br/><div id="37441914" class="c"><input type="checkbox" id="c-37441914" checked=""/><div class="controls bullet"><span class="by">LoganDark</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37441292">parent</a><span>|</span><a href="#37439819">next</a><span>|</span><label class="collapse" for="c-37441914">[-]</label><label class="expand" for="c-37441914">[1 more]</label></div><br/><div class="children"><div class="content">You could try completely unsigning the binary: <a href="https:&#x2F;&#x2F;reverseengineering.stackexchange.com&#x2F;a&#x2F;13623" rel="nofollow noreferrer">https:&#x2F;&#x2F;reverseengineering.stackexchange.com&#x2F;a&#x2F;13623</a><p>This won&#x27;t work for everything, and it probably does need SIP to be off (also make a backup!) but it might be a way to get something to work.</div><br/></div></div></div></div></div></div><div id="37439819" class="c"><input type="checkbox" id="c-37439819" checked=""/><div class="controls bullet"><span class="by">Racing0461</span><span>|</span><a href="#37439757">parent</a><span>|</span><a href="#37439846">prev</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37439819">[-]</label><label class="expand" for="c-37439819">[8 more]</label></div><br/><div class="children"><div class="content">I get the first one but not the second one. Since you are just redirecting dlopen, aren&#x27;t you just rewriting it for people that actually work on your codebase which then compiles?<p>It doesn&#x27;t actually block it from 3rd parties.</div><br/><div id="37440361" class="c"><input type="checkbox" id="c-37440361" checked=""/><div class="controls bullet"><span class="by">nemetroid</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37439819">parent</a><span>|</span><a href="#37440323">next</a><span>|</span><label class="collapse" for="c-37440361">[-]</label><label class="expand" for="c-37440361">[1 more]</label></div><br/><div class="children"><div class="content">If you link your executable to a library that references a symbol defined in your executable, that symbol will be added to the executable&#x27;s dynamic symbol table.</div><br/></div></div><div id="37440323" class="c"><input type="checkbox" id="c-37440323" checked=""/><div class="controls bullet"><span class="by">zX41ZdbW</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37439819">parent</a><span>|</span><a href="#37440361">prev</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37440323">[-]</label><label class="expand" for="c-37440323">[6 more]</label></div><br/><div class="children"><div class="content">It is the case when a library already uses dlopen in unusual code paths, but we want to make sure that code paths won&#x27;t work.<p>The examples are some authentication plugins.</div><br/><div id="37440370" class="c"><input type="checkbox" id="c-37440370" checked=""/><div class="controls bullet"><span class="by">blibble</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440323">parent</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37440370">[-]</label><label class="expand" for="c-37440370">[5 more]</label></div><br/><div class="children"><div class="content">all they have to do to beat your dlopen blocker is link against libdl statically<p>one extra argument to the linker when they compile their plugin</div><br/><div id="37441199" class="c"><input type="checkbox" id="c-37441199" checked=""/><div class="controls bullet"><span class="by">Racing0461</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37440370">parent</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37441199">[-]</label><label class="expand" for="c-37441199">[4 more]</label></div><br/><div class="children"><div class="content">I think p is just trying to prevent people from being shot in the foot as opposed to preventing malicious users ie hackers.</div><br/><div id="37441298" class="c"><input type="checkbox" id="c-37441298" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37441199">parent</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37441298">[-]</label><label class="expand" for="c-37441298">[3 more]</label></div><br/><div class="children"><div class="content">You&#x27;re not supposed to go to such lengths to stop people from shooting themselves in the foot, because when you do, you also stop people from doing clever things.</div><br/><div id="37441330" class="c"><input type="checkbox" id="c-37441330" checked=""/><div class="controls bullet"><span class="by">Racing0461</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37441298">parent</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37441330">[-]</label><label class="expand" for="c-37441330">[2 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t want my authentication library to do clever things.</div><br/><div id="37442507" class="c"><input type="checkbox" id="c-37442507" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37439757">root</a><span>|</span><a href="#37441330">parent</a><span>|</span><a href="#37440273">next</a><span>|</span><label class="collapse" for="c-37442507">[-]</label><label class="expand" for="c-37442507">[1 more]</label></div><br/><div class="children"><div class="content">Then you don&#x27;t have to make yours do so. But if other sysadmins disagree, they should be able to make theirs do so.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div id="37442164" class="c"><input type="checkbox" id="c-37442164" checked=""/><div class="controls bullet"><span class="by">grishka</span><span>|</span><a href="#37439757">prev</a><span>|</span><a href="#37442335">next</a><span>|</span><label class="collapse" for="c-37442164">[-]</label><label class="expand" for="c-37442164">[2 more]</label></div><br/><div class="children"><div class="content">The macOS equivalent is DYLD_INSERT_LIBRARIES. You can then use Objective C reflection from your library to patch someone else&#x27;s app by replacing method implementations for example.</div><br/><div id="37442807" class="c"><input type="checkbox" id="c-37442807" checked=""/><div class="controls bullet"><span class="by">lloeki</span><span>|</span><a href="#37442164">parent</a><span>|</span><a href="#37442335">next</a><span>|</span><label class="collapse" for="c-37442807">[-]</label><label class="expand" for="c-37442807">[1 more]</label></div><br/><div class="children"><div class="content">Note that darwin prevents dylib injection in certain scenarios.<p><a href="https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20161007013145&#x2F;http:&#x2F;&#x2F;pewpewthespells.com&#x2F;blog&#x2F;blocking_code_injection_on_ios_and_os_x.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20161007013145&#x2F;http:&#x2F;&#x2F;pewpewthes...</a><p>IIRC it has been further tightened since the above was written. DYLD_INTERPOSE is now a thing, DYLD_LIBRARY_PATH and DYLD_INSERT_LIBRARIES may be silently ignored and dropped from the env.<p><a href="https:&#x2F;&#x2F;apple.stackexchange.com&#x2F;questions&#x2F;421306&#x2F;exporting-dyld-insert-libraries-for-libgmalloc-not-working-on-big-sur" rel="nofollow noreferrer">https:&#x2F;&#x2F;apple.stackexchange.com&#x2F;questions&#x2F;421306&#x2F;exporting-d...</a></div><br/></div></div></div></div><div id="37442335" class="c"><input type="checkbox" id="c-37442335" checked=""/><div class="controls bullet"><span class="by">kristopolous</span><span>|</span><a href="#37442164">prev</a><span>|</span><a href="#37441001">next</a><span>|</span><label class="collapse" for="c-37442335">[-]</label><label class="expand" for="c-37442335">[1 more]</label></div><br/><div class="children"><div class="content">Used to use it all the time for debugging back in the day when I could write Linux apps in C professionally and not just build dumb webpages.</div><br/></div></div><div id="37441001" class="c"><input type="checkbox" id="c-37441001" checked=""/><div class="controls bullet"><span class="by">Cloudef</span><span>|</span><a href="#37442335">prev</a><span>|</span><a href="#37439703">next</a><span>|</span><label class="collapse" for="c-37441001">[-]</label><label class="expand" for="c-37441001">[1 more]</label></div><br/><div class="children"><div class="content">I used LD_PRELOAD to make things not crash on openpandora, and to make valid EGL context
<a href="https:&#x2F;&#x2F;gist.github.com&#x2F;Cloudef&#x2F;5788729" rel="nofollow noreferrer">https:&#x2F;&#x2F;gist.github.com&#x2F;Cloudef&#x2F;5788729</a></div><br/></div></div><div id="37439703" class="c"><input type="checkbox" id="c-37439703" checked=""/><div class="controls bullet"><span class="by">ranguna</span><span>|</span><a href="#37441001">prev</a><span>|</span><label class="collapse" for="c-37439703">[-]</label><label class="expand" for="c-37439703">[1 more]</label></div><br/><div class="children"><div class="content">Amazing explanation, I&#x27;ve seen this env var in loads of places and I never really understood what it did. Thanks for this!</div><br/></div></div></div></div></div></div></div></body></html>