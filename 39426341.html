<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1708333270017" as="style"/><link rel="stylesheet" href="styles.css?v=1708333270017"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://a.exozy.me/posts/floats-weird/">Floats Are Weird</a> <span class="domain">(<a href="https://a.exozy.me">a.exozy.me</a>)</span></div><div class="subtext"><span>soopurman</span> | <span>17 comments</span></div><br/><div><div id="39427499" class="c"><input type="checkbox" id="c-39427499" checked=""/><div class="controls bullet"><span class="by">gonzus</span><span>|</span><a href="#39427167">next</a><span>|</span><label class="collapse" for="c-39427499">[-]</label><label class="expand" for="c-39427499">[1 more]</label></div><br/><div class="children"><div class="content">I decided years ago that the next time I hear someone suggesting we use floats &#x2F; doubles to represent money amounts, I am going to punch them in the face.</div><br/></div></div><div id="39427167" class="c"><input type="checkbox" id="c-39427167" checked=""/><div class="controls bullet"><span class="by">an1sotropy</span><span>|</span><a href="#39427499">prev</a><span>|</span><a href="#39427156">next</a><span>|</span><label class="collapse" for="c-39427167">[-]</label><label class="expand" for="c-39427167">[2 more]</label></div><br/><div class="children"><div class="content">I guess &quot;floats are weird&quot; is a catchier title than &quot;numerical computing is an acquired skill based in part on understanding the various consequences of value representation density being inversely proportional to the absolute value&quot;.</div><br/><div id="39427414" class="c"><input type="checkbox" id="c-39427414" checked=""/><div class="controls bullet"><span class="by">stabbles</span><span>|</span><a href="#39427167">parent</a><span>|</span><a href="#39427156">next</a><span>|</span><label class="collapse" for="c-39427414">[-]</label><label class="expand" for="c-39427414">[1 more]</label></div><br/><div class="children"><div class="content">I think the title is alright. The curious thing is that both `f` and `g` have catastrophic cancellation, so you expect both to be inaccurate, but magically `g` recovers from it.<p>Alternative title: catastrophic cancellation cancels out</div><br/></div></div></div></div><div id="39427156" class="c"><input type="checkbox" id="c-39427156" checked=""/><div class="controls bullet"><span class="by">098799</span><span>|</span><a href="#39427167">prev</a><span>|</span><a href="#39427170">next</a><span>|</span><label class="collapse" for="c-39427156">[-]</label><label class="expand" for="c-39427156">[5 more]</label></div><br/><div class="children"><div class="content">Nothing weird about it. It should be obvious that subtracting two floats that are very close to each other results in a loss of numerical precision:<p>1.000000003456e0 - 1.000000002345e0 = 0.000000001111e0 = 1.111numericalnoise e-9<p>It&#x27;s exactly the same issue here. `math.exp(1e-15)` is `1.000000000000001`. If you subtract 1, you get 1 significant digit and numerical noise.</div><br/><div id="39427355" class="c"><input type="checkbox" id="c-39427355" checked=""/><div class="controls bullet"><span class="by">nneonneo</span><span>|</span><a href="#39427156">parent</a><span>|</span><a href="#39427337">next</a><span>|</span><label class="collapse" for="c-39427355">[-]</label><label class="expand" for="c-39427355">[1 more]</label></div><br/><div class="children"><div class="content">The weird thing here is that the only change is making the denominator ln(exp(x)) instead of x. Catastrophic cancellation is still happening in the numerator (it’s still exp(x)-1), and the denominator winds up being some really tiny number.<p>It’s just that, due to the quirks of the floating point calculations involved, the numerator and denominator wind up being nearly the <i>same</i> noisy approximation to x, whereas in the original calculation that wasn’t true.</div><br/></div></div><div id="39427337" class="c"><input type="checkbox" id="c-39427337" checked=""/><div class="controls bullet"><span class="by">kolinko</span><span>|</span><a href="#39427156">parent</a><span>|</span><a href="#39427355">prev</a><span>|</span><a href="#39427170">next</a><span>|</span><label class="collapse" for="c-39427337">[-]</label><label class="expand" for="c-39427337">[3 more]</label></div><br/><div class="children"><div class="content">That&#x27;s not what the post says if I understand correctly - the post explains why in certain situations the &quot;noise&quot; disappears, and in other cases it doesn&#x27;t.<p>See comparison between f and g functions.</div><br/><div id="39427406" class="c"><input type="checkbox" id="c-39427406" checked=""/><div class="controls bullet"><span class="by">098799</span><span>|</span><a href="#39427156">root</a><span>|</span><a href="#39427337">parent</a><span>|</span><a href="#39427170">next</a><span>|</span><label class="collapse" for="c-39427406">[-]</label><label class="expand" for="c-39427406">[2 more]</label></div><br/><div class="children"><div class="content">I see! yes, the magic is you can cancel the noise by repeating it twice:<p>```
In [1]: math.exp(1e-15)-1
Out[1]: 1.1102230246251565e-15<p>In [2]: math.log(math.exp(1e-15))
Out[2]: 1.110223024625156e-15
```<p>risky business though, I imagine it&#x27;s implementation dependent</div><br/><div id="39427436" class="c"><input type="checkbox" id="c-39427436" checked=""/><div class="controls bullet"><span class="by">Sharlin</span><span>|</span><a href="#39427156">root</a><span>|</span><a href="#39427406">parent</a><span>|</span><a href="#39427170">next</a><span>|</span><label class="collapse" for="c-39427436">[-]</label><label class="expand" for="c-39427436">[1 more]</label></div><br/><div class="children"><div class="content">It’s not (or shouldn’t be), it’s simply a result of math, as the article explains in length.</div><br/></div></div></div></div></div></div></div></div><div id="39427170" class="c"><input type="checkbox" id="c-39427170" checked=""/><div class="controls bullet"><span class="by">the-Black-Dread</span><span>|</span><a href="#39427156">prev</a><span>|</span><a href="#39427173">next</a><span>|</span><label class="collapse" for="c-39427170">[-]</label><label class="expand" for="c-39427170">[5 more]</label></div><br/><div class="children"><div class="content">Then what&#x27;s the best way to handle these cases? Are there any set of rules we should use while implementing the mathematical equations dealing with limits in floating points.</div><br/><div id="39427348" class="c"><input type="checkbox" id="c-39427348" checked=""/><div class="controls bullet"><span class="by">OscarCunningham</span><span>|</span><a href="#39427170">parent</a><span>|</span><a href="#39427485">next</a><span>|</span><label class="collapse" for="c-39427348">[-]</label><label class="expand" for="c-39427348">[1 more]</label></div><br/><div class="children"><div class="content">Floating point numbers have the highest precision when they&#x27;re near 0. So if you know a number is going to be near 1, like exp(x) when x is small, then it&#x27;s better to calculate the offset from 1 rather than the number itself. Programming languages make &#x27;expm1&#x27; available for this purpose, which computes exp(x)-1.</div><br/></div></div><div id="39427485" class="c"><input type="checkbox" id="c-39427485" checked=""/><div class="controls bullet"><span class="by">stabbles</span><span>|</span><a href="#39427170">parent</a><span>|</span><a href="#39427348">prev</a><span>|</span><a href="#39427197">next</a><span>|</span><label class="collapse" for="c-39427485">[-]</label><label class="expand" for="c-39427485">[1 more]</label></div><br/><div class="children"><div class="content">Basically<p>- don&#x27;t subtract almost equal numbers<p>- don&#x27;t add numbers of vastly different magnitudes</div><br/></div></div><div id="39427197" class="c"><input type="checkbox" id="c-39427197" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#39427170">parent</a><span>|</span><a href="#39427485">prev</a><span>|</span><a href="#39427173">next</a><span>|</span><label class="collapse" for="c-39427197">[-]</label><label class="expand" for="c-39427197">[2 more]</label></div><br/><div class="children"><div class="content">For a summation, add the smaller numbers first.  Smaller as in 0.0000000000053, not like -5172365126.</div><br/><div id="39427494" class="c"><input type="checkbox" id="c-39427494" checked=""/><div class="controls bullet"><span class="by">Dban1</span><span>|</span><a href="#39427170">root</a><span>|</span><a href="#39427197">parent</a><span>|</span><a href="#39427173">next</a><span>|</span><label class="collapse" for="c-39427494">[-]</label><label class="expand" for="c-39427494">[1 more]</label></div><br/><div class="children"><div class="content">how about small as in ²³⁷</div><br/></div></div></div></div></div></div><div id="39427173" class="c"><input type="checkbox" id="c-39427173" checked=""/><div class="controls bullet"><span class="by">eesmith</span><span>|</span><a href="#39427170">prev</a><span>|</span><a href="#39427075">next</a><span>|</span><label class="collapse" for="c-39427173">[-]</label><label class="expand" for="c-39427173">[2 more]</label></div><br/><div class="children"><div class="content">For this specific case, use Python&#x27;s expm1, see <a href="https:&#x2F;&#x2F;docs.python.org&#x2F;3&#x2F;library&#x2F;math.html#math.expm1" rel="nofollow">https:&#x2F;&#x2F;docs.python.org&#x2F;3&#x2F;library&#x2F;math.html#math.expm1</a> and history of expm1 at <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Exponential_function#expm1" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Exponential_function#expm1</a><p><pre><code>  def f(x):
    return math.expm1(x)&#x2F;x
</code></pre>
The expm1(x) means &quot;exp(x) minus 1&quot;.<p><pre><code>  &gt;&gt;&gt; f(1e-15)
  1.0000000000000007
</code></pre>
The technique described gives<p><pre><code>  1.0000000000000004
</code></pre>
which is 1 step smaller than the value computed via expm1():<p><pre><code>  &gt;&gt;&gt; math.nextafter(f(1e-15), 0)
  1.0000000000000004
</code></pre>
Both are within 1 ulp of the more precise value from WolframAlpha:<p><pre><code>  1.0000000000000005000000000000001666666666666667083333333333333416...</code></pre></div><br/><div id="39427471" class="c"><input type="checkbox" id="c-39427471" checked=""/><div class="controls bullet"><span class="by">Sharlin</span><span>|</span><a href="#39427173">parent</a><span>|</span><a href="#39427075">next</a><span>|</span><label class="collapse" for="c-39427471">[-]</label><label class="expand" for="c-39427471">[1 more]</label></div><br/><div class="children"><div class="content">To be precise, it’s <i>C’s</i> `expm1`. Like other things in math.h, it’s just adopted as is to most popular languages, even including PHP and JS.</div><br/></div></div></div></div><div id="39427075" class="c"><input type="checkbox" id="c-39427075" checked=""/><div class="controls bullet"><span class="by">user3939382</span><span>|</span><a href="#39427173">prev</a><span>|</span><label class="collapse" for="c-39427075">[-]</label><label class="expand" for="c-39427075">[1 more]</label></div><br/><div class="children"><div class="content">I’ve had weird float bugs that I didn’t have time for and fixed by operating on them as strings. Nowadays I’ve found pretty good libraries in common languages designed to handle the weird edges.</div><br/></div></div></div></div></div></div></div></body></html>