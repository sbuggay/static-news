<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1736499664085" as="style"/><link rel="stylesheet" href="styles.css?v=1736499664085"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.orange.tw/posts/2025-01-worstfit-unveiling-hidden-transformers-in-windows-ansi/">WorstFit: Unveiling Hidden Transformers in Windows ANSI</a> <span class="domain">(<a href="https://blog.orange.tw">blog.orange.tw</a>)</span></div><div class="subtext"><span>notmine1337</span> | <span>76 comments</span></div><br/><div><div id="42647790" class="c"><input type="checkbox" id="c-42647790" checked=""/><div class="controls bullet"><span class="by">vessenes</span><span>|</span><a href="#42647439">next</a><span>|</span><label class="collapse" for="c-42647790">[-]</label><label class="expand" for="c-42647790">[24 more]</label></div><br/><div class="children"><div class="content">This is a tough one. It’s systemic —- MS provides a “best fit” code mapping from wide Unicode to ASCII, which is a known, published, “vibes-based” mapper. This best fit parser is used a lottt of places, and I’m sure that it’s required for ongoing inclusion based on how MS views backward compatibility. It’s linked in by default everywhere, whether or not you know you included it.<p>The exploits largely revolved around either speccing an unusual code point that “vibes” into say a slash or a hyphen or quotes. These code points are typically evaluated one way (correct full Unicode evaluation) inside a modern programming language, but when passed to shell commands or other Win32 API things are vibes-downed. Crucially this happens <i>after</i> you check them, since it’s when you’ve passed control.<p>To quote the curl maintainer “curl is a victim” here — but who is the culprit? It seems certain that curl will be used to retrieve user supplied data automatically by a server in the future. When that server mangles user input in one way for validation and another when applied to system libraries, you’re going to have a problem.<p>It seems to me like maybe the solution is to provide an opt-out of “best fit” munging in the Win32 space, but I’m not a Windows guy, so I speculate. At least then open source providers could just add the opt out to best practices, and deal with the many terrible problems that things like a Unicode wide variant of “ or \ delivers to them.<p>And of course even if you do that, you’ll interact with officially shipped APIs and software that has <i>not</i> opted out.</div><br/><div id="42647998" class="c"><input type="checkbox" id="c-42647998" checked=""/><div class="controls bullet"><span class="by">wongarsu</span><span>|</span><a href="#42647790">parent</a><span>|</span><a href="#42653554">next</a><span>|</span><label class="collapse" for="c-42647998">[-]</label><label class="expand" for="c-42647998">[20 more]</label></div><br/><div class="children"><div class="content">The opt-out is to use the unicode windows APIs (the functions ending in &quot;w&quot; instead of &quot;a&quot;). This also magically fixes all issues with paths longer than 260 characters (if you add a &quot;\\?\&quot; prefix or set you manifest correctly), and has been available and recommended since Windows XP.<p>I&#x27;m not sure why the non-unicode APIs are still so commonly used. I can&#x27;t imagine it&#x27;s out of a desire to support Windows 98 or Window 2000.</div><br/><div id="42648792" class="c"><input type="checkbox" id="c-42648792" checked=""/><div class="controls bullet"><span class="by">comex</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42648479">next</a><span>|</span><label class="collapse" for="c-42648792">[-]</label><label class="expand" for="c-42648792">[3 more]</label></div><br/><div class="children"><div class="content">_Or_ set your application to use UTF-8 for the &quot;A&quot; APIs.  Apparently this is supported as of a Windows 10 update from 2019. [1]<p>[1] <a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;apps&#x2F;design&#x2F;globalizing&#x2F;use-utf8-code-page" rel="nofollow">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;apps&#x2F;design&#x2F;global...</a></div><br/><div id="42653532" class="c"><input type="checkbox" id="c-42653532" checked=""/><div class="controls bullet"><span class="by">kazinator</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42648792">parent</a><span>|</span><a href="#42651617">next</a><span>|</span><label class="collapse" for="c-42653532">[-]</label><label class="expand" for="c-42653532">[1 more]</label></div><br/><div class="children"><div class="content">Does that mean that in this UTF-8 mode, GetCommandLineA would, when the full-width double quote occurs in the command line, return the UTF-8 bytes for that double quote, rather than steamrolling it to an ASCII double quote with the WorstFit mapping?</div><br/></div></div><div id="42651617" class="c"><input type="checkbox" id="c-42651617" checked=""/><div class="controls bullet"><span class="by">asveikau</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42648792">parent</a><span>|</span><a href="#42653532">prev</a><span>|</span><a href="#42648479">next</a><span>|</span><label class="collapse" for="c-42651617">[-]</label><label class="expand" for="c-42651617">[1 more]</label></div><br/><div class="children"><div class="content">It should have been supported approximately 20 years earlier than that. I was coding against Win32 looong before 2019 and wondering for years why they wouldn&#x27;t let you.<p>An explanation I heard ~10 years prior is that doing so exposed bugs in CRT and nobody wanted to fix them.</div><br/></div></div></div></div><div id="42648479" class="c"><input type="checkbox" id="c-42648479" checked=""/><div class="controls bullet"><span class="by">Sharlin</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42648792">prev</a><span>|</span><a href="#42648237">next</a><span>|</span><label class="collapse" for="c-42648479">[-]</label><label class="expand" for="c-42648479">[10 more]</label></div><br/><div class="children"><div class="content">As mentioned elsewhere in this discussion, 99% of the time the cause is likely the use of standard C functions (or C++ `std::string`…) instead of MS&#x27;s nonstandard wide versions. Which of course is a ubiquitous practice in portable command-line software like curl.</div><br/><div id="42653799" class="c"><input type="checkbox" id="c-42653799" checked=""/><div class="controls bullet"><span class="by">smatija</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42648479">parent</a><span>|</span><a href="#42649823">next</a><span>|</span><label class="collapse" for="c-42653799">[-]</label><label class="expand" for="c-42653799">[1 more]</label></div><br/><div class="children"><div class="content">A lot of details is in linked curl hackerone: <a href="https:&#x2F;&#x2F;hackerone.com&#x2F;reports&#x2F;2550951" rel="nofollow">https:&#x2F;&#x2F;hackerone.com&#x2F;reports&#x2F;2550951</a></div><br/></div></div><div id="42649823" class="c"><input type="checkbox" id="c-42649823" checked=""/><div class="controls bullet"><span class="by">pishpash</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42648479">parent</a><span>|</span><a href="#42653799">prev</a><span>|</span><a href="#42648237">next</a><span>|</span><label class="collapse" for="c-42649823">[-]</label><label class="expand" for="c-42649823">[8 more]</label></div><br/><div class="children"><div class="content">So the culprit is still the software writer. They should have wrapped the C++ library for OS-specific behavior on Windows. Because they are publishing buggy software and calling it cross-platform.</div><br/><div id="42649896" class="c"><input type="checkbox" id="c-42649896" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42649823">parent</a><span>|</span><a href="#42651153">next</a><span>|</span><label class="collapse" for="c-42649896">[-]</label><label class="expand" for="c-42649896">[6 more]</label></div><br/><div class="children"><div class="content">curl first released in 1996, shortly after Windows 95 has born and runs on numerous Windows versions even today. So, how many different versions shall be maintained? Are you going to help one of these versions?<p>On top of that, how many new gotchas these “modern” Windows functions hide, and how many fix cycles are required to polish them to the required level?</div><br/><div id="42651508" class="c"><input type="checkbox" id="c-42651508" checked=""/><div class="controls bullet"><span class="by">thrdbndndn</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42649896">parent</a><span>|</span><a href="#42651153">next</a><span>|</span><label class="collapse" for="c-42651508">[-]</label><label class="expand" for="c-42651508">[5 more]</label></div><br/><div class="children"><div class="content">If we&#x27;re talking about curl specifically, I absolutely think they would (NOT &quot;should&quot;) fix&#x2F;workaround it if there are actually common problems caused by it.<p>Yes it would have required numerous fix cycles, but curl in my mind is such a polished product and they would have bit the bullet.</div><br/><div id="42653420" class="c"><input type="checkbox" id="c-42653420" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42651508">parent</a><span>|</span><a href="#42652360">next</a><span>|</span><label class="collapse" for="c-42653420">[-]</label><label class="expand" for="c-42653420">[1 more]</label></div><br/><div class="children"><div class="content">You&#x27;re right, if the problems created by this are big enough, the team will fix them without any fanfare and whining.<p>However, in neither case this is a shortcoming of curl. They&#x27;d be responding to a complicated problem caused by the platform they&#x27;re running on.</div><br/></div></div><div id="42652360" class="c"><input type="checkbox" id="c-42652360" checked=""/><div class="controls bullet"><span class="by">8n4vidtmkvmk</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42651508">parent</a><span>|</span><a href="#42653420">prev</a><span>|</span><a href="#42651153">next</a><span>|</span><label class="collapse" for="c-42652360">[-]</label><label class="expand" for="c-42652360">[3 more]</label></div><br/><div class="children"><div class="content">Why would&#x2F;should they? I&#x27;ve never paid for curl. Who even develops it? Sounds like a thankless job to fix obscure worstfit bugs.</div><br/><div id="42653293" class="c"><input type="checkbox" id="c-42653293" checked=""/><div class="controls bullet"><span class="by">thrdbndndn</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42652360">parent</a><span>|</span><a href="#42653449">next</a><span>|</span><label class="collapse" for="c-42653293">[-]</label><label class="expand" for="c-42653293">[1 more]</label></div><br/><div class="children"><div class="content">Why would they develop curl at all by your logic?<p>They fix bugs because they simply want their product to be better, if if I were to take a guess? Like, I&#x27;m sure curl&#x27;s contributors worked on OS-specific problems before, and it wouldn&#x27;t be the last.<p>&gt; to fix obscure worstfit bugs.<p>Again my premise is &quot;if there are actually common problems caused by it&quot;. This specific bug does sound like that, at least not for now.</div><br/></div></div><div id="42653449" class="c"><input type="checkbox" id="c-42653449" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42652360">parent</a><span>|</span><a href="#42653293">prev</a><span>|</span><a href="#42651153">next</a><span>|</span><label class="collapse" for="c-42653449">[-]</label><label class="expand" for="c-42653449">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Why would&#x2F;should they?<p>Because they care. That&#x27;s it.<p>&gt; I&#x27;ve never paid for curl.<p>I&#x27;m sure people who develop it doesn&#x27;t want money and fame, but they&#x27;re just doing what they like. However, curl has commercial support contracts if you need.<p>&gt; Who even develops it?<p>Daniel Stenberg et al. Daniel can be found at <a href="https:&#x2F;&#x2F;daniel.haxx.se" rel="nofollow">https:&#x2F;&#x2F;daniel.haxx.se</a>.<p>&gt; Sounds like a thankless job to fix obscure worstfit bugs.<p>It may look thankless, but it&#x27;s not. curl is critical infrastructure at this point. While <a href="https:&#x2F;&#x2F;xkcd.com&#x2F;2347&#x2F;" rel="nofollow">https:&#x2F;&#x2F;xkcd.com&#x2F;2347&#x2F;</a> applies squarely to cURL, it&#x27;s actually nice that the lead developer is making some money out of his endeavor.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="42648237" class="c"><input type="checkbox" id="c-42648237" checked=""/><div class="controls bullet"><span class="by">vessenes</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42648479">prev</a><span>|</span><a href="#42652847">next</a><span>|</span><label class="collapse" for="c-42648237">[-]</label><label class="expand" for="c-42648237">[1 more]</label></div><br/><div class="children"><div class="content">I think the issue is that native OS things like the windows command line, say, don’t always do this. Check the results of their ‘cd’ commands with Japanese Yen characters introduced. You can see that the path descriptor somehow has updated to a directory name with Yen (or a wide backslash) in it, while the file system underneath has munged, and put them into an actual directory. It’s precisely the problem that you can’t control the <i>rest</i> of the API surface to use W that is the source of the difficulties.</div><br/></div></div><div id="42652847" class="c"><input type="checkbox" id="c-42652847" checked=""/><div class="controls bullet"><span class="by">Thorrez</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42648237">prev</a><span>|</span><a href="#42649214">next</a><span>|</span><label class="collapse" for="c-42652847">[-]</label><label class="expand" for="c-42652847">[1 more]</label></div><br/><div class="children"><div class="content">&gt;I&#x27;m not sure why the non-unicode APIs are still so commonly used.<p>Even argv is affected on Windows. That&#x27;s part of the C and C++ standard, not really a Windows API. Telling all C&#x2F;C++ devs they need to stop using argv is kind of a tough ask.</div><br/></div></div><div id="42649214" class="c"><input type="checkbox" id="c-42649214" checked=""/><div class="controls bullet"><span class="by">cesarb</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42652847">prev</a><span>|</span><a href="#42651611">next</a><span>|</span><label class="collapse" for="c-42649214">[-]</label><label class="expand" for="c-42649214">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I&#x27;m not sure why the non-unicode APIs are still so commonly used. I can&#x27;t imagine it&#x27;s out of a desire to support Windows 98 or Window 2000.<p>Nowadays, it&#x27;s either for historical reasons (code written back when supporting Windows 9x was important, or even code migrated from Windows 3.x), or out of a desire to support non-Windows systems. Most operating systems use a byte-based multi-byte encoding (nowadays usually UTF-8) as their native encoding, instead of UTF-16.</div><br/></div></div><div id="42651611" class="c"><input type="checkbox" id="c-42651611" checked=""/><div class="controls bullet"><span class="by">asveikau</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42649214">prev</a><span>|</span><a href="#42652015">next</a><span>|</span><label class="collapse" for="c-42651611">[-]</label><label class="expand" for="c-42651611">[1 more]</label></div><br/><div class="children"><div class="content">I share your recommendations of always using PWSTR when using windows apis.<p>&gt; I&#x27;m not sure why the non-unicode APIs are still so commonly used<p>I think because the rest of the C world uses char* with utf-8, so that is what people are habituated to. Setting the ACP to CP_UTF8 would have solved a lot of problems, but I believe that&#x27;s only been supported for a short period of time, bafflingly.</div><br/></div></div><div id="42652015" class="c"><input type="checkbox" id="c-42652015" checked=""/><div class="controls bullet"><span class="by">ack_complete</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42651611">prev</a><span>|</span><a href="#42648671">next</a><span>|</span><label class="collapse" for="c-42652015">[-]</label><label class="expand" for="c-42652015">[1 more]</label></div><br/><div class="children"><div class="content">Using \\?\ has a downside: since it bypasses Win32&#x27;s path processing, it also prevents relative paths like d:test.txt from working. Kind of annoying on the command line with tools like 7z.exe.</div><br/></div></div><div id="42648671" class="c"><input type="checkbox" id="c-42648671" checked=""/><div class="controls bullet"><span class="by">p_ing</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42647998">parent</a><span>|</span><a href="#42652015">prev</a><span>|</span><a href="#42653554">next</a><span>|</span><label class="collapse" for="c-42648671">[-]</label><label class="expand" for="c-42648671">[1 more]</label></div><br/><div class="children"><div class="content">&gt; paths longer than 260 characters (if you add a &quot;\\?\&quot; prefix or set you manifest correctly)<p>A long ago released build of Windows 10 did this automatically so no need for adjustments anymore, 32k is the max....<p>...except for Office! It can&#x27;t handle long paths. But Office has always been hacky (the title bar, for example).</div><br/></div></div></div></div><div id="42653554" class="c"><input type="checkbox" id="c-42653554" checked=""/><div class="controls bullet"><span class="by">captainmuon</span><span>|</span><a href="#42647790">parent</a><span>|</span><a href="#42647998">prev</a><span>|</span><a href="#42651922">next</a><span>|</span><label class="collapse" for="c-42653554">[-]</label><label class="expand" for="c-42653554">[2 more]</label></div><br/><div class="children"><div class="content">Windows has a way of opting out of legacy behavior since Windows XP - manifest files. If you don&#x27;t include a manifest, even GetWindowsVersion will not return the current version IIRC. It should be not too hard to add an opt-out in there (and at some point make it default in Visual Studio).<p>I think what is also needed is some kind of linting - there is usually no need to call ANSI WinAPI functions in a modern application (unless you set the locale to UTF-8 and only use the 8-bit functions, but I don&#x27;t know how well that works). I <i>think</i> there are also a couple of settings and headers to include to make everything &quot;just work&quot; - meaning argv, printf and std::cout work with UTF-8, you get no strange conversions, and you just have functions to convert between UTF-8 and UTF-16 to use WinAPI. I&#x27;m pretty sure I have a Visual Studio project lying around somewhere where it works. But all those steps necessary need to be documented and put in one place by MS.</div><br/><div id="42653713" class="c"><input type="checkbox" id="c-42653713" checked=""/><div class="controls bullet"><span class="by">Arwill</span><span>|</span><a href="#42647790">root</a><span>|</span><a href="#42653554">parent</a><span>|</span><a href="#42651922">next</a><span>|</span><label class="collapse" for="c-42653713">[-]</label><label class="expand" for="c-42653713">[1 more]</label></div><br/><div class="children"><div class="content">Using UTF8 internally and converting strings for W API calls is a way to gain some performance.</div><br/></div></div></div></div><div id="42651922" class="c"><input type="checkbox" id="c-42651922" checked=""/><div class="controls bullet"><span class="by">UltraSane</span><span>|</span><a href="#42647790">parent</a><span>|</span><a href="#42653554">prev</a><span>|</span><a href="#42647439">next</a><span>|</span><label class="collapse" for="c-42651922">[-]</label><label class="expand" for="c-42651922">[1 more]</label></div><br/><div class="children"><div class="content">The loosey-goosey mapping of code points to characters has always bothered me about Unicode.</div><br/></div></div></div></div><div id="42647439" class="c"><input type="checkbox" id="c-42647439" checked=""/><div class="controls bullet"><span class="by">mmastrac</span><span>|</span><a href="#42647790">prev</a><span>|</span><a href="#42649314">next</a><span>|</span><label class="collapse" for="c-42647439">[-]</label><label class="expand" for="c-42647439">[1 more]</label></div><br/><div class="children"><div class="content">This is kind of unsurprising, but still new to me even as someone who did Windows development (and some Wine API hacking) for a decade around when this W&#x2F;A mess came about.<p>Windows is like the card game Munchkin, where a whole bunch of features can add up to a completely, unbelievably random over-powered exploit because of unintentional synergy between random bits.<p>I&#x27;m happy to see that they are converting the ANSI subsystem to UTF-8, which should, in theory, mitigate a lot of these problems.<p>I wonder if the Rust team is going to need YetAnotherFix to the process spawning API to fix this...</div><br/></div></div><div id="42649314" class="c"><input type="checkbox" id="c-42649314" checked=""/><div class="controls bullet"><span class="by">layer8</span><span>|</span><a href="#42647439">prev</a><span>|</span><a href="#42647800">next</a><span>|</span><label class="collapse" for="c-42649314">[-]</label><label class="expand" for="c-42649314">[4 more]</label></div><br/><div class="children"><div class="content">&gt; until Microsoft chooses to enable UTF-8 by default in all of their Windows editions.<p>I don’t know how likely this is. There are a lot of old applications that assume a particular code page, or assume 1 byte per character, that this would break. There are also more subtle variations of this, like applications assuming that converting from wide characters to ANSI can’t increase the number of bytes (and hence an existing buffer can be safely reused), which isn’t the case for UTF-8 (but for all, or almost all, existing code pages). It can open up new vulnerabilities.<p>It would probably cause much less breakage to remove the Best-Fit logic from the win32 xxxA APIs, and instead have all unmappable characters be replaced by a character without any common meta semantics, like “x”.</div><br/><div id="42650777" class="c"><input type="checkbox" id="c-42650777" checked=""/><div class="controls bullet"><span class="by">tambre</span><span>|</span><a href="#42649314">parent</a><span>|</span><a href="#42649502">next</a><span>|</span><label class="collapse" for="c-42650777">[-]</label><label class="expand" for="c-42650777">[1 more]</label></div><br/><div class="children"><div class="content">One example of such an application is Adobe After Effects [0]. Or at least used to be, I no longer use Windows.<p>[0] <a href="https:&#x2F;&#x2F;tambre.ee&#x2F;blog&#x2F;adobe_after_effects_windows_utf-8&#x2F;" rel="nofollow">https:&#x2F;&#x2F;tambre.ee&#x2F;blog&#x2F;adobe_after_effects_windows_utf-8&#x2F;</a></div><br/></div></div><div id="42649502" class="c"><input type="checkbox" id="c-42649502" checked=""/><div class="controls bullet"><span class="by">kgeist</span><span>|</span><a href="#42649314">parent</a><span>|</span><a href="#42650777">prev</a><span>|</span><a href="#42647800">next</a><span>|</span><label class="collapse" for="c-42649502">[-]</label><label class="expand" for="c-42649502">[2 more]</label></div><br/><div class="children"><div class="content">Maybe they can introduce OS API versions (if there&#x27;s no such thing yet) and require new (or updated) apps targetting new API versions&#x2F;newer SDKs to assume UTF8 by default? So everything below a certain API version is emulated legacy mode. Windows already has the concept of shims to emulate behavior of different Windows versions.</div><br/><div id="42649552" class="c"><input type="checkbox" id="c-42649552" checked=""/><div class="controls bullet"><span class="by">layer8</span><span>|</span><a href="#42649314">root</a><span>|</span><a href="#42649502">parent</a><span>|</span><a href="#42647800">next</a><span>|</span><label class="collapse" for="c-42649552">[-]</label><label class="expand" for="c-42649552">[1 more]</label></div><br/><div class="children"><div class="content">Apps can already opt-in to UTF-8 for the ANSI APIs (see <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42649122">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42649122</a>), or use the wide-character APIs.</div><br/></div></div></div></div></div></div><div id="42647800" class="c"><input type="checkbox" id="c-42647800" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#42649314">prev</a><span>|</span><a href="#42649122">next</a><span>|</span><label class="collapse" for="c-42647800">[-]</label><label class="expand" for="c-42647800">[14 more]</label></div><br/><div class="children"><div class="content">&gt; the only thing we can do is to encourage everyone, the users, organizations, and developers, to gradually phase out ANSI and promote the use of the Wide Character API,<p>This has been Microsoft&#x27;s official position since NT 3.5, if I remember correctly.<p>Sadly, one of the main hurdles is the way Microsoft&#x27;s own C&#x2F;C++ runtime library (msvcrt.dll) is implemented. Its non-standard &quot;wide&quot; functions like _wfopen(), _wgetenv(), etc. internally use W-functions from Win API. But the standard, &quot;narrow&quot; functions like fopen(), getenv(), etc., instead of using the &quot;wide&quot; versions and converting to-from Unicode themselves (and reporting conversion failures), simply use A-functions. Which, as you see, generally don&#x27;t report any Unicode conversion failures but instead try to gloss over them using best-fit approach.<p>And of course, nobody who ports software, written in C, to Windows wants to rewrite all of the uses of standard functions to use Microsoft&#x27;s non-portable functions because at this point, it becomes a full-blown rewrite.</div><br/><div id="42647989" class="c"><input type="checkbox" id="c-42647989" checked=""/><div class="controls bullet"><span class="by">terinjokes</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42648957">next</a><span>|</span><label class="collapse" for="c-42647989">[-]</label><label class="expand" for="c-42647989">[4 more]</label></div><br/><div class="children"><div class="content">The position I got reading documentation Microsoft has written in the last two years is the opposite: set activeCodePage in your application manifest to UTF-8 and only ever use the &quot;ANSI&quot; functions.</div><br/><div id="42648601" class="c"><input type="checkbox" id="c-42648601" checked=""/><div class="controls bullet"><span class="by">ziml77</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42647989">parent</a><span>|</span><a href="#42649223">next</a><span>|</span><label class="collapse" for="c-42648601">[-]</label><label class="expand" for="c-42648601">[2 more]</label></div><br/><div class="children"><div class="content">Yes that does seem to be the way going forward. Makes it a lot easier to write cross-platform code. Though library code still has to use the Wide Character APIs because it&#x27;s up to the application as a whole to opt into UTF-8. Also if you&#x27;re looking for maximal efficiency, the WChar APIs still make sense because it avoids the conversion of all the string inputs and outputs on every call.</div><br/><div id="42649799" class="c"><input type="checkbox" id="c-42649799" checked=""/><div class="controls bullet"><span class="by">terinjokes</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42648601">parent</a><span>|</span><a href="#42649223">next</a><span>|</span><label class="collapse" for="c-42649799">[-]</label><label class="expand" for="c-42649799">[1 more]</label></div><br/><div class="children"><div class="content">Many libraries I&#x27;ve encountered have defines available now to use the -A APIs; previously they were using -W APIs and converting to&#x2F;from UTF-8 internally.<p>As for my application, any wchar conversions being done by the runtime are a drop in the bucket compared to the actual compute.</div><br/></div></div></div></div><div id="42649223" class="c"><input type="checkbox" id="c-42649223" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42647989">parent</a><span>|</span><a href="#42648601">prev</a><span>|</span><a href="#42648957">next</a><span>|</span><label class="collapse" for="c-42649223">[-]</label><label class="expand" for="c-42649223">[1 more]</label></div><br/><div class="children"><div class="content">Ah, so they&#x27;ve finally given up? Interesting to hear. But I guess the app manifests <i>does</i> give them a way to move forward this way while maintaining the backward-compatible behaviour (for apps without this setting in their manifests).</div><br/></div></div></div></div><div id="42648957" class="c"><input type="checkbox" id="c-42648957" checked=""/><div class="controls bullet"><span class="by">dblohm7</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42647989">prev</a><span>|</span><a href="#42648790">next</a><span>|</span><label class="collapse" for="c-42648957">[-]</label><label class="expand" for="c-42648957">[2 more]</label></div><br/><div class="children"><div class="content">What really annoys me these days is that if you search for a Win32 API on Google, it will always come up with the -A variant, not the -W variant. I don&#x27;t know if they&#x27;ve got something weird in their robots.txt or what, but I find it bizarre that an API whose guidelines desire developers to use the -W variants in all greenfield code, instead returns the legacy APIs by default.</div><br/><div id="42652001" class="c"><input type="checkbox" id="c-42652001" checked=""/><div class="controls bullet"><span class="by">ack_complete</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42648957">parent</a><span>|</span><a href="#42648790">next</a><span>|</span><label class="collapse" for="c-42652001">[-]</label><label class="expand" for="c-42652001">[1 more]</label></div><br/><div class="children"><div class="content">They did a strange reorg of the API docs at one point. Not only does it now have functions split by A&#x2F;W (mostly unnecessarily), it also groups them by header file instead of feature reference, which is kind of annoying. It used to be just that the function doc would note at the bottom if A&#x2F;W variants were present and they were grouped under Functions in the feature&#x2F;subsystem area of the docs tree.</div><br/></div></div></div></div><div id="42648790" class="c"><input type="checkbox" id="c-42648790" checked=""/><div class="controls bullet"><span class="by">masfuerte</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42648957">prev</a><span>|</span><a href="#42647980">next</a><span>|</span><label class="collapse" for="c-42648790">[-]</label><label class="expand" for="c-42648790">[1 more]</label></div><br/><div class="children"><div class="content">In my portable code I #define standard functions like main and fopen to their wide equivalents when building on Windows.<p>This does mean I can&#x27;t just use char* and unadorned string literals, so I define a tchar type (which is char on Linux and wchar_t on Windows) and an _T() macro for string literals.<p>This mostly works without thinking about it.</div><br/></div></div><div id="42647980" class="c"><input type="checkbox" id="c-42647980" checked=""/><div class="controls bullet"><span class="by">delta_p_delta_x</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42648790">prev</a><span>|</span><a href="#42649272">next</a><span>|</span><label class="collapse" for="c-42647980">[-]</label><label class="expand" for="c-42647980">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Microsoft&#x27;s own C&#x2F;C++ runtime library (msvcrt.dll) is implemented<p>This has been superseded by the Universal C runtime (UCRT)[1] which is C99-compliant.</div><br/></div></div><div id="42649272" class="c"><input type="checkbox" id="c-42649272" checked=""/><div class="controls bullet"><span class="by">nialv7</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42647980">prev</a><span>|</span><a href="#42651051">next</a><span>|</span><label class="collapse" for="c-42649272">[-]</label><label class="expand" for="c-42649272">[4 more]</label></div><br/><div class="children"><div class="content">Windows really should provide an API that treats path names as just bytes, without any of these stupid encoding stuff. Could probably have done that when they introduced UNC paths.</div><br/><div id="42652902" class="c"><input type="checkbox" id="c-42652902" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42649272">parent</a><span>|</span><a href="#42649505">next</a><span>|</span><label class="collapse" for="c-42652902">[-]</label><label class="expand" for="c-42652902">[1 more]</label></div><br/><div class="children"><div class="content">Ever since Windows 95 Long File Names for FAT, filenames have been 16-bit characters in their on-disk format.  So passing &quot;bytes&quot; means that they need to become wide characters before the filesystem can act on them.  And case-sensitivity is still applied, stupidly enough, using locale-specific rules.  (Change your locale, and you change how case-insensitive filenames work!)<p>It is possible to request for a directory to contain case-sensitive files though, and the filesystem will respect that.  And if you use the NT Native API, you have no restrictions on filenames, except for the Backslash character.  You can even use filenames that Win32 doesn&#x27;t allow (name with a &quot;:&quot;, name with a null byte, file named &quot;con&quot; etc), and every Win32 program will break badly if it tries to access such a file.<p>It&#x27;s also possible to use unpaired surrogate characters (D800-DFFF without the matching second part) in a filename.  Now you have a file on the disk whose name can&#x27;t be represented in UTF-8, but the filename is still sitting happily in the filesystem.  So people invented &quot;WTF-8&quot; encoding to allow those characters to be represented.</div><br/></div></div><div id="42649505" class="c"><input type="checkbox" id="c-42649505" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42649272">parent</a><span>|</span><a href="#42652902">prev</a><span>|</span><a href="#42651051">next</a><span>|</span><label class="collapse" for="c-42649505">[-]</label><label class="expand" for="c-42649505">[2 more]</label></div><br/><div class="children"><div class="content">Windows does treat path names as just sequences of uint16_t (which is how NTFS stores them) if you use W-functions <i>and</i> prepend the paths with &quot;\\?\&quot;.</div><br/><div id="42651286" class="c"><input type="checkbox" id="c-42651286" checked=""/><div class="controls bullet"><span class="by">nialv7</span><span>|</span><a href="#42647800">root</a><span>|</span><a href="#42649505">parent</a><span>|</span><a href="#42651051">next</a><span>|</span><label class="collapse" for="c-42651286">[-]</label><label class="expand" for="c-42651286">[1 more]</label></div><br/><div class="children"><div class="content">oh, that&#x27;s interesting. do UNC paths not have to be valid UTF-16?</div><br/></div></div></div></div></div></div><div id="42651051" class="c"><input type="checkbox" id="c-42651051" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#42647800">parent</a><span>|</span><a href="#42649272">prev</a><span>|</span><a href="#42649122">next</a><span>|</span><label class="collapse" for="c-42651051">[-]</label><label class="expand" for="c-42651051">[1 more]</label></div><br/><div class="children"><div class="content">And of course making everything twice as big as it needs to be is also extremely repugnant.</div><br/></div></div></div></div><div id="42649122" class="c"><input type="checkbox" id="c-42649122" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#42647800">prev</a><span>|</span><a href="#42653388">next</a><span>|</span><label class="collapse" for="c-42649122">[-]</label><label class="expand" for="c-42649122">[1 more]</label></div><br/><div class="children"><div class="content">There are two ways to force the &quot;Ansi&quot; codepage to actually be UTF-8 for an application that you write (or an EXE that you patch).<p>One way is with a Manifest file, and works as of a particular build of Windows 10.  This can also be applied to any EXE after building it.  So if you want a program to gain UTF-8 support, you can hack it in.  Most useful for console-mode programs.<p>The other way is to use the hacks that &quot;App Locale&quot; type tools use.  One way involves undocumented function calls from NTDLL.   I&#x27;m not sure exactly which functions you need to call, but I think it might involve &quot;RtlInitNlsTables&quot; and &quot;RtlResetRtlTranslations&quot; (not actually sure).</div><br/></div></div><div id="42653388" class="c"><input type="checkbox" id="c-42653388" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#42649122">prev</a><span>|</span><a href="#42647842">next</a><span>|</span><label class="collapse" for="c-42653388">[-]</label><label class="expand" for="c-42653388">[1 more]</label></div><br/><div class="children"><div class="content">Oh, my, freaking, god. I knew Windows API provides that sort of best-fit conversions, but didn&#x27;t realize that it was a default behavior for several ANSI functions in my native code page (949 [1])! At this point they should be just banned like gets.<p>[1] Yes, I know there is a UTF-8 code page (65001). That was really unusable for a long time and still is suffering compatibility issues to this day.</div><br/></div></div><div id="42647842" class="c"><input type="checkbox" id="c-42647842" checked=""/><div class="controls bullet"><span class="by">segasaturn</span><span>|</span><a href="#42653388">prev</a><span>|</span><a href="#42649068">next</a><span>|</span><label class="collapse" for="c-42647842">[-]</label><label class="expand" for="c-42647842">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve been inadvertantly safe from this bug on my personal Windows computer for years thanks to having the UTF-8 mode set, as shown at the bottom of the article. I had it set due to some old, foreign games showing garbled nonsense text on my computer. Have not noticed any bugs or side effects despite it being labelled as &quot;Beta&quot;.</div><br/><div id="42649606" class="c"><input type="checkbox" id="c-42649606" checked=""/><div class="controls bullet"><span class="by">numpad0</span><span>|</span><a href="#42647842">parent</a><span>|</span><a href="#42651907">next</a><span>|</span><label class="collapse" for="c-42649606">[-]</label><label class="expand" for="c-42649606">[1 more]</label></div><br/><div class="children"><div class="content">Interesting, to me that checkbox have done nothing but crashing too many random apps. I guess whether it works depends on the user&#x27;s home codepage with it off.</div><br/></div></div><div id="42651907" class="c"><input type="checkbox" id="c-42651907" checked=""/><div class="controls bullet"><span class="by">UltraSane</span><span>|</span><a href="#42647842">parent</a><span>|</span><a href="#42649606">prev</a><span>|</span><a href="#42649068">next</a><span>|</span><label class="collapse" for="c-42651907">[-]</label><label class="expand" for="c-42651907">[1 more]</label></div><br/><div class="children"><div class="content">I just enabled the &quot;Beta: Use Unicode UTF-8 for worldwide language support&quot; option. Going to be interesting to see how many apps this breaks.</div><br/></div></div></div></div><div id="42649068" class="c"><input type="checkbox" id="c-42649068" checked=""/><div class="controls bullet"><span class="by">cesarb</span><span>|</span><a href="#42647842">prev</a><span>|</span><a href="#42653390">next</a><span>|</span><label class="collapse" for="c-42649068">[-]</label><label class="expand" for="c-42649068">[1 more]</label></div><br/><div class="children"><div class="content">&gt; However, resolving this problem isn’t that as simple as just replacing the main() with its wide-character counterpart. Since the function signature has been changed, maintainers would need to rewrite all variable definitions and argument parsing logics, converting everything from simple char * to wchar_t *. This process can be painful and error-prone.<p>You don&#x27;t need to convert everything from char * to wchar *. You can instead convert the wide characters you received to UTF-8 (or to something like Rust&#x27;s WTF-8, if you want to also allow invalid sequences like unpaired surrogates), and keep using &quot;char&quot; everywhere; of course, you have to take care to not mix ANSI or OEMCP strings with UTF-8 strings, which is easy if you simply use UTF-8 everywhere. This is the approach advocated by the classic <a href="https:&#x2F;&#x2F;utf8everywhere.org&#x2F;" rel="nofollow">https:&#x2F;&#x2F;utf8everywhere.org&#x2F;</a> site.</div><br/></div></div><div id="42653390" class="c"><input type="checkbox" id="c-42653390" checked=""/><div class="controls bullet"><span class="by">kazinator</span><span>|</span><a href="#42649068">prev</a><span>|</span><a href="#42649527">next</a><span>|</span><label class="collapse" for="c-42653390">[-]</label><label class="expand" for="c-42653390">[1 more]</label></div><br/><div class="children"><div class="content">HN, Help! Before I dive into this, does anyone know whether this affects the argument parsing in Cygwin, that prepares the arguments for a regular int main(int argc, char *argv)?<p>TXR Lisp uses wchar_t strings, and the &quot;W&quot; functions on Windows. So that&#x27;s well and good. But it does start with a regular C main, relying on the Cygwin run-time for that.<p>If that&#x27;s vulnerable, I will hack it to have its own argument parsing, using the wide char command line.<p>Maybe I should ask this on the Cygwin mailing list.</div><br/></div></div><div id="42649527" class="c"><input type="checkbox" id="c-42649527" checked=""/><div class="controls bullet"><span class="by">scoopr</span><span>|</span><a href="#42653390">prev</a><span>|</span><a href="#42647709">next</a><span>|</span><label class="collapse" for="c-42649527">[-]</label><label class="expand" for="c-42649527">[1 more]</label></div><br/><div class="children"><div class="content">I was wondering if the beta checkbox the same thing as setting the ActiveCodePage to UTF-8 in the manifest, but the docs[0] clarify that GDI doesn&#x27;t adhere to per-process codepage, but only a single global one, which is what the checkbox sets.<p>Bit of a shame that you can&#x27;t fully opt-in to be UTF-8 with the *A API, for your own apps. But I think for the issues highlighted in the post, I think it would still be a valid workaround&#x2F;defence-in-depth thing.<p>[0] <a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;apps&#x2F;design&#x2F;globalizing&#x2F;use-utf8-code-page" rel="nofollow">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;apps&#x2F;design&#x2F;global...</a></div><br/></div></div><div id="42647709" class="c"><input type="checkbox" id="c-42647709" checked=""/><div class="controls bullet"><span class="by">bangaladore</span><span>|</span><a href="#42649527">prev</a><span>|</span><a href="#42651915">next</a><span>|</span><label class="collapse" for="c-42647709">[-]</label><label class="expand" for="c-42647709">[5 more]</label></div><br/><div class="children"><div class="content">I tend to agree that this is not an issue with many of the applications that are mentioned in the post.<p>Fundamentally this boils down to essentially bugs in functions that are supposed to transform untrusted into trusted input like the example they gave:<p>`system(&quot;wget.exe -q &quot; . escapeshellarg($url));`<p>`escapeshellarg` is not producing a trusted output with some certain inputs.</div><br/><div id="42648430" class="c"><input type="checkbox" id="c-42648430" checked=""/><div class="controls bullet"><span class="by">blibble</span><span>|</span><a href="#42647709">parent</a><span>|</span><a href="#42651915">next</a><span>|</span><label class="collapse" for="c-42648430">[-]</label><label class="expand" for="c-42648430">[4 more]</label></div><br/><div class="children"><div class="content">the escaping rules for windows are so complicated (and can vary with configuration) such that it&#x27;s not possible to do it securely<p>vs. posix that just dumps the arguments directly into argv</div><br/><div id="42649271" class="c"><input type="checkbox" id="c-42649271" checked=""/><div class="controls bullet"><span class="by">hnlmorg</span><span>|</span><a href="#42647709">root</a><span>|</span><a href="#42648430">parent</a><span>|</span><a href="#42649526">next</a><span>|</span><label class="collapse" for="c-42649271">[-]</label><label class="expand" for="c-42649271">[1 more]</label></div><br/><div class="children"><div class="content">Windows doesn’t really have an ARGV though. It’s a user space abstraction for compatibility with POSIX.<p>Windows technically just works on the principle of an executable name + a single argument. And it does this for compatibility with DOS.<p>So you end up with this stupid escaping rules you’ve described so there are compatibility conventions at the kernel level with earlier implementations of Windows, which in turn maintained compatibility with MS-DOS. While providing a C abstraction that’s compatible with POSIX.<p>Which is just one of <i>many</i> reasons why it’s a nightmare to write cross platform shells that also target Windows.</div><br/></div></div><div id="42649526" class="c"><input type="checkbox" id="c-42649526" checked=""/><div class="controls bullet"><span class="by">bangaladore</span><span>|</span><a href="#42647709">root</a><span>|</span><a href="#42648430">parent</a><span>|</span><a href="#42649271">prev</a><span>|</span><a href="#42651915">next</a><span>|</span><label class="collapse" for="c-42649526">[-]</label><label class="expand" for="c-42649526">[2 more]</label></div><br/><div class="children"><div class="content">&gt; the escaping rules for windows are so complicated (and can vary with configuration) such that it&#x27;s not possible to do it securely<p>This is bold claim.<p>Is it not possible? Or not easy to do correctly?</div><br/><div id="42649722" class="c"><input type="checkbox" id="c-42649722" checked=""/><div class="controls bullet"><span class="by">blibble</span><span>|</span><a href="#42647709">root</a><span>|</span><a href="#42649526">parent</a><span>|</span><a href="#42651915">next</a><span>|</span><label class="collapse" for="c-42649722">[-]</label><label class="expand" for="c-42649722">[1 more]</label></div><br/><div class="children"><div class="content">all the kernel passes to executables is one long string<p>and then every program handles it in whatever way it feels is best<p>as examples: go&#x2F;java&#x2F;python all process arguments slightly differently<p>even microsoft&#x27;s libc changes handling between versions<p>given it&#x27;s not possible to know what parser a specific target program is going to use: it&#x27;s not possible to generically serialise an array safely</div><br/></div></div></div></div></div></div></div></div><div id="42651915" class="c"><input type="checkbox" id="c-42651915" checked=""/><div class="controls bullet"><span class="by">UltraSane</span><span>|</span><a href="#42647709">prev</a><span>|</span><a href="#42652683">next</a><span>|</span><label class="collapse" for="c-42651915">[-]</label><label class="expand" for="c-42651915">[1 more]</label></div><br/><div class="children"><div class="content">The loosey-goosey mapping of code points to characters has always bothered me about Unicode.<p>To guard against this nasty issue that is going to take years to fix you can enable global UTF-8 support by doing<p>Settings &gt; Time &amp; language &gt; Language &amp; region &gt; Administrative language settings &gt; Change system locale, and check Beta: Use Unicode UTF-8 for worldwide language support. Then reboot the PC for the change to take effect.</div><br/></div></div><div id="42652683" class="c"><input type="checkbox" id="c-42652683" checked=""/><div class="controls bullet"><span class="by">LudwigNagasena</span><span>|</span><a href="#42651915">prev</a><span>|</span><a href="#42649238">next</a><span>|</span><label class="collapse" for="c-42652683">[-]</label><label class="expand" for="c-42652683">[1 more]</label></div><br/><div class="children"><div class="content">What would even be the proper way to do `system(&quot;wget.exe -q &quot; . escapeshellarg($url))`? It’s ridiculous that plaintext IPC is still the primary interface for many tools.</div><br/></div></div><div id="42649238" class="c"><input type="checkbox" id="c-42649238" checked=""/><div class="controls bullet"><span class="by">layer8</span><span>|</span><a href="#42652683">prev</a><span>|</span><a href="#42650522">next</a><span>|</span><label class="collapse" for="c-42649238">[-]</label><label class="expand" for="c-42649238">[2 more]</label></div><br/><div class="children"><div class="content">&gt; And yes, Python’s subprocess module can’t prevent this.<p>A reasonably sane solution would be for it to reject command line arguments on Windows that contain non-ASCII characters or ASCII characters that aren’t portable across code pages (not all code pages are a superset of US-ASCII), by default, and to support an optional parameter to allow the full range, documenting the risk.</div><br/><div id="42653332" class="c"><input type="checkbox" id="c-42653332" checked=""/><div class="controls bullet"><span class="by">veltas</span><span>|</span><a href="#42649238">parent</a><span>|</span><a href="#42650522">next</a><span>|</span><label class="collapse" for="c-42653332">[-]</label><label class="expand" for="c-42653332">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s not sane at all, because then you can&#x27;t send e.g. Japanese arguments to tools that support wide chars or have UTF-8 codepage in their manifest.  And then there&#x27;s yet another difference between Python versions to trip you up.  And why should the default not allow internationalisation?  Doesn&#x27;t fit with the idea of Python 3.</div><br/></div></div></div></div><div id="42650522" class="c"><input type="checkbox" id="c-42650522" checked=""/><div class="controls bullet"><span class="by">lilyball</span><span>|</span><a href="#42649238">prev</a><span>|</span><a href="#42651065">next</a><span>|</span><label class="collapse" for="c-42650522">[-]</label><label class="expand" for="c-42650522">[2 more]</label></div><br/><div class="children"><div class="content">&gt; <i>Worse still, as the attack exploits behavior at the system level during the conversion process, no standard library in any programming language can fully stop our attack!</i><p>What happens if the standard library updates its shell escaping to also escape things like the Yen character and any other character that has a Best-Fit translation into a quote or backslash? Which is to say, what does Windows do for command-line splitting if it encounters a backslash-escaped nonspecial character in a quoted string? If it behaves like sh and the backslash simply disables special handling of the next character, then backslash-escaping any threat characters should work.</div><br/><div id="42653103" class="c"><input type="checkbox" id="c-42653103" checked=""/><div class="controls bullet"><span class="by">david2ndaccount</span><span>|</span><a href="#42650522">parent</a><span>|</span><a href="#42651065">next</a><span>|</span><label class="collapse" for="c-42653103">[-]</label><label class="expand" for="c-42653103">[1 more]</label></div><br/><div class="children"><div class="content">Backslash is a valid path character (you can use &#x2F; or \ as the path separator on windows) so if the backslash isn’t actually escaping anything it is left as-is.</div><br/></div></div></div></div><div id="42651065" class="c"><input type="checkbox" id="c-42651065" checked=""/><div class="controls bullet"><span class="by">nitwit005</span><span>|</span><a href="#42650522">prev</a><span>|</span><a href="#42651473">next</a><span>|</span><label class="collapse" for="c-42651065">[-]</label><label class="expand" for="c-42651065">[1 more]</label></div><br/><div class="children"><div class="content">There are presumably some similar .Net COM issues when communicating with unmanaged code, as there is an attribute for controlling this conversion: <a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;dotnet&#x2F;api&#x2F;system.runtime.interopservices.bestfitmappingattribute" rel="nofollow">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;dotnet&#x2F;api&#x2F;system.runtime....</a><p>It directly mentions: &quot;Setting BestFitMappingAttribute parameters in this manner provides an added measure of security.&quot;</div><br/></div></div><div id="42651473" class="c"><input type="checkbox" id="c-42651473" checked=""/><div class="controls bullet"><span class="by">rubatuga</span><span>|</span><a href="#42651065">prev</a><span>|</span><a href="#42651966">next</a><span>|</span><label class="collapse" for="c-42651473">[-]</label><label class="expand" for="c-42651473">[1 more]</label></div><br/><div class="children"><div class="content">From what I can tell the largest vulnerability is argument passing to executables in Windows. Essentially it is very difficult to safeguard it. I&#x27;ve seen some CLI programs use the &#x27;--&#x27; to signify user input at the end, maybe this would solve this for a single argument scenario. Overall, this is an excellent article and vulnerability discovery.</div><br/></div></div><div id="42651966" class="c"><input type="checkbox" id="c-42651966" checked=""/><div class="controls bullet"><span class="by">est</span><span>|</span><a href="#42651473">prev</a><span>|</span><a href="#42649703">next</a><span>|</span><label class="collapse" for="c-42651966">[-]</label><label class="expand" for="c-42651966">[1 more]</label></div><br/><div class="children"><div class="content">I remember typing some prefix character in notepad.exe then your hole txt became messed up. Funny unicode times.</div><br/></div></div><div id="42649703" class="c"><input type="checkbox" id="c-42649703" checked=""/><div class="controls bullet"><span class="by">ppp999</span><span>|</span><a href="#42651966">prev</a><span>|</span><a href="#42648439">next</a><span>|</span><label class="collapse" for="c-42649703">[-]</label><label class="expand" for="c-42649703">[1 more]</label></div><br/><div class="children"><div class="content">Character encoding has been such a mess for so long it&#x27;s crazy.</div><br/></div></div><div id="42648439" class="c"><input type="checkbox" id="c-42648439" checked=""/><div class="controls bullet"><span class="by">ok123456</span><span>|</span><a href="#42649703">prev</a><span>|</span><a href="#42647655">next</a><span>|</span><label class="collapse" for="c-42648439">[-]</label><label class="expand" for="c-42648439">[3 more]</label></div><br/><div class="children"><div class="content">Bush hid the facts</div><br/><div id="42649123" class="c"><input type="checkbox" id="c-42649123" checked=""/><div class="controls bullet"><span class="by">cesarb</span><span>|</span><a href="#42648439">parent</a><span>|</span><a href="#42648681">next</a><span>|</span><label class="collapse" for="c-42649123">[-]</label><label class="expand" for="c-42649123">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Bush hid the facts<p>For those who don&#x27;t know the reference: <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Bush_hid_the_facts" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Bush_hid_the_facts</a> it&#x27;s a vaguely related issue, in which a Windows component misinterprets a sequence of ASCII characters as a sequence of UTF-16 characters. Windows just seems full of these sorts of character-handling bugs, in part due to its long history as a descendant of the codepage-using MS-DOS and 16-bit Windows operating systems.</div><br/></div></div></div></div><div id="42647655" class="c"><input type="checkbox" id="c-42647655" checked=""/><div class="controls bullet"><span class="by">mouse_</span><span>|</span><a href="#42648439">prev</a><span>|</span><a href="#42647706">next</a><span>|</span><label class="collapse" for="c-42647655">[-]</label><label class="expand" for="c-42647655">[1 more]</label></div><br/><div class="children"><div class="content">Unicode on modern systems is absolutely terrifying. Anyone remember the black dot of death? <a href="https:&#x2F;&#x2F;mashable.com&#x2F;article&#x2F;black-dot-of-death-unicode-imessage-iphone-crash" rel="nofollow">https:&#x2F;&#x2F;mashable.com&#x2F;article&#x2F;black-dot-of-death-unicode-imes...</a></div><br/></div></div><div id="42647706" class="c"><input type="checkbox" id="c-42647706" checked=""/><div class="controls bullet"><span class="by">Randor</span><span>|</span><a href="#42647655">prev</a><span>|</span><a href="#42651694">next</a><span>|</span><label class="collapse" for="c-42647706">[-]</label><label class="expand" for="c-42647706">[1 more]</label></div><br/><div class="children"><div class="content">That was a long read. Just be happy that you never had to deal with Trigraphs.
<a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;cpp&#x2F;c-language&#x2F;trigraphs?view=msvc-170" rel="nofollow">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;cpp&#x2F;c-language&#x2F;trigraphs?v...</a></div><br/></div></div><div id="42651694" class="c"><input type="checkbox" id="c-42651694" checked=""/><div class="controls bullet"><span class="by">EdSharkey</span><span>|</span><a href="#42647706">prev</a><span>|</span><a href="#42650720">next</a><span>|</span><label class="collapse" for="c-42651694">[-]</label><label class="expand" for="c-42651694">[1 more]</label></div><br/><div class="children"><div class="content">Distributing native binaries is so dangerous!</div><br/></div></div><div id="42650720" class="c"><input type="checkbox" id="c-42650720" checked=""/><div class="controls bullet"><span class="by">tiahura</span><span>|</span><a href="#42651694">prev</a><span>|</span><label class="collapse" for="c-42650720">[-]</label><label class="expand" for="c-42650720">[3 more]</label></div><br/><div class="children"><div class="content">Imagine no Unicode, It’s easy if you try, No bytes that bloat our systems, No errors make us cry.
Imagine all the coders, Living life in ASCII…<p>Imagine no emojis, Just letters, plain and true, No accents to confuse us, No glyphs in Sanskrit too.
Imagine all the programs, Running clean and fast…<p>You may say I’m a dreamer, But I’m not the only one. I hope someday you’ll join us, And encoding wars will be done.</div><br/><div id="42653173" class="c"><input type="checkbox" id="c-42653173" checked=""/><div class="controls bullet"><span class="by">Ndymium</span><span>|</span><a href="#42650720">parent</a><span>|</span><label class="collapse" for="c-42653173">[-]</label><label class="expand" for="c-42653173">[2 more]</label></div><br/><div class="children"><div class="content">I can appreciate the funny lyrics, but in real life I appreciate being able to write in my own language on a computer. Or even a mix of my language <i>and</i> another non-English language!</div><br/><div id="42653688" class="c"><input type="checkbox" id="c-42653688" checked=""/><div class="controls bullet"><span class="by">lmm</span><span>|</span><a href="#42650720">root</a><span>|</span><a href="#42653173">parent</a><span>|</span><label class="collapse" for="c-42653688">[-]</label><label class="expand" for="c-42653688">[1 more]</label></div><br/><div class="children"><div class="content">&gt;  in real life I appreciate being able to write in my own language on a computer.<p>I do too, which is why I hate the &quot;unicode only for everything everywhere&quot; narrative that&#x27;s taken hold. My language can&#x27;t be written properly in Unicode, so support for traditional codepages and encodings is really important!</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>