<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1735376451365" as="style"/><link rel="stylesheet" href="styles.css?v=1735376451365"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://gildas-lormeau.github.io/Polyglot-HTML-ZIP-PNG/SUMMARY.html">How to Create HTML/ZIP/PNG Polyglot Files</a> <span class="domain">(<a href="https://gildas-lormeau.github.io">gildas-lormeau.github.io</a>)</span></div><div class="subtext"><span>gildas</span> | <span>21 comments</span></div><br/><div><div id="42527423" class="c"><input type="checkbox" id="c-42527423" checked=""/><div class="controls bullet"><span class="by">Retr0id</span><span>|</span><a href="#42527675">next</a><span>|</span><label class="collapse" for="c-42527423">[-]</label><label class="expand" for="c-42527423">[3 more]</label></div><br/><div class="children"><div class="content">&gt; a bug in “Archive Utility” on macOS prevents it from decompressing the resulting file<p>I looked into this in the past, it&#x27;s because they check for a &quot;PK&quot; header at the start of the file - which is of course not actually required. I assumed it was deliberate because it does exclude most &quot;weird&quot; ZIPs.<p>By the way, if you&#x27;re interested in this sort of file format wrangling, check out Ange Albertini&#x27;s talk tomorrow at 38c3: <a href="https:&#x2F;&#x2F;fahrplan.events.ccc.de&#x2F;congress&#x2F;2024&#x2F;fahrplan&#x2F;talk&#x2F;QS9AXX&#x2F;" rel="nofollow">https:&#x2F;&#x2F;fahrplan.events.ccc.de&#x2F;congress&#x2F;2024&#x2F;fahrplan&#x2F;talk&#x2F;Q...</a></div><br/><div id="42527695" class="c"><input type="checkbox" id="c-42527695" checked=""/><div class="controls bullet"><span class="by">Lammy</span><span>|</span><a href="#42527423">parent</a><span>|</span><a href="#42527675">next</a><span>|</span><label class="collapse" for="c-42527695">[-]</label><label class="expand" for="c-42527695">[2 more]</label></div><br/><div class="children"><div class="content">&gt; it&#x27;s because they check for a &quot;PK&quot; header at the start of the file<p>Lots of FOSS tooling will have a similar limitation due to the lack of support in the shared-mime-info spec for reading identifying features from the ends of files. Please vote&#x2F;comment on this issue to voice your support: <a href="https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;xdg&#x2F;shared-mime-info&#x2F;-&#x2F;issues&#x2F;147#note_1504442" rel="nofollow">https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;xdg&#x2F;shared-mime-info&#x2F;-&#x2F;issues...</a></div><br/></div></div></div></div><div id="42527675" class="c"><input type="checkbox" id="c-42527675" checked=""/><div class="controls bullet"><span class="by">gildas</span><span>|</span><a href="#42527423">prev</a><span>|</span><a href="#42529072">next</a><span>|</span><label class="collapse" for="c-42527675">[-]</label><label class="expand" for="c-42527675">[5 more]</label></div><br/><div class="children"><div class="content">Note that you can also take advantage of the fact that a ZIP can be password-protected and make your web page secret! For example <a href="https:&#x2F;&#x2F;gildas-lormeau.github.io&#x2F;private&#x2F;" rel="nofollow">https:&#x2F;&#x2F;gildas-lormeau.github.io&#x2F;private&#x2F;</a> (password: &quot;thisisapage&quot;).</div><br/><div id="42527874" class="c"><input type="checkbox" id="c-42527874" checked=""/><div class="controls bullet"><span class="by">jclarkcom</span><span>|</span><a href="#42527675">parent</a><span>|</span><a href="#42529072">next</a><span>|</span><label class="collapse" for="c-42527874">[-]</label><label class="expand" for="c-42527874">[4 more]</label></div><br/><div class="children"><div class="content">If you are loading external libraries like in this example your encrypted data is at risk.   It would be better to include the decryption code directly in the Js or embed Js zlib.</div><br/><div id="42527903" class="c"><input type="checkbox" id="c-42527903" checked=""/><div class="controls bullet"><span class="by">gildas</span><span>|</span><a href="#42527675">root</a><span>|</span><a href="#42527874">parent</a><span>|</span><a href="#42529108">next</a><span>|</span><label class="collapse" for="c-42527903">[-]</label><label class="expand" for="c-42527903">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s possible to define the Content Security Policy with a &lt;META&gt; tag in the &quot;bootstrap page&quot; and prevent this kind of security issue, e.g. &lt;META http-equiv=&quot;content-security-policy&quot; content=&quot;connect-src &#x27;self&#x27; data: blob:;&quot;&gt;</div><br/><div id="42528913" class="c"><input type="checkbox" id="c-42528913" checked=""/><div class="controls bullet"><span class="by">Thorrez</span><span>|</span><a href="#42527675">root</a><span>|</span><a href="#42527903">parent</a><span>|</span><a href="#42529108">next</a><span>|</span><label class="collapse" for="c-42528913">[-]</label><label class="expand" for="c-42528913">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think that will prevent data exfiltration. Malicious javascript could create e.g. an img element with the data to exfiltrate stored in a query parameter of the image URL.</div><br/></div></div></div></div><div id="42529108" class="c"><input type="checkbox" id="c-42529108" checked=""/><div class="controls bullet"><span class="by">nhinck3</span><span>|</span><a href="#42527675">root</a><span>|</span><a href="#42527874">parent</a><span>|</span><a href="#42527903">prev</a><span>|</span><a href="#42529072">next</a><span>|</span><label class="collapse" for="c-42529108">[-]</label><label class="expand" for="c-42529108">[1 more]</label></div><br/><div class="children"><div class="content">You can also use the SubtleCrypto API</div><br/></div></div></div></div></div></div><div id="42529072" class="c"><input type="checkbox" id="c-42529072" checked=""/><div class="controls bullet"><span class="by">porridgeraisin</span><span>|</span><a href="#42527675">prev</a><span>|</span><a href="#42529118">next</a><span>|</span><label class="collapse" for="c-42529072">[-]</label><label class="expand" for="c-42529072">[1 more]</label></div><br/><div class="children"><div class="content">&gt; However, there’s a problem: due to the same-origin policy, retrieving ZIP data directly with fetch(””) fails when the page is opened from the filesystem (except in Firefox).<p><pre><code>  chromium --allow-access-from-files</code></pre></div><br/></div></div><div id="42529118" class="c"><input type="checkbox" id="c-42529118" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#42529072">prev</a><span>|</span><a href="#42529101">next</a><span>|</span><label class="collapse" for="c-42529118">[-]</label><label class="expand" for="c-42529118">[1 more]</label></div><br/><div class="children"><div class="content">&gt; The bootstrap page is now encoded in windows-1252, which allows data to be read from the DOM with minimum degradation.<p>This is not always the case if the encoded content happens to have `--&gt;`, for example. A better approach would be the `&lt;plaintext&gt;` element which can never be closed.</div><br/></div></div><div id="42529101" class="c"><input type="checkbox" id="c-42529101" checked=""/><div class="controls bullet"><span class="by">nhinck3</span><span>|</span><a href="#42529118">prev</a><span>|</span><a href="#42527861">next</a><span>|</span><label class="collapse" for="c-42529101">[-]</label><label class="expand" for="c-42529101">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think need any external libraries to do this anymore with DecompressionStream.</div><br/></div></div><div id="42527861" class="c"><input type="checkbox" id="c-42527861" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#42529101">prev</a><span>|</span><a href="#42527689">next</a><span>|</span><label class="collapse" for="c-42527861">[-]</label><label class="expand" for="c-42527861">[2 more]</label></div><br/><div class="children"><div class="content">I think there&#x27;s probably a much more efficient way to pack the correction data than JSON.  For example, if you wanted to embed a 10MB video file in there, the correction data would be huge.<p>In the project there, correction data is used to recover bytes that have been changed into LF when they are actually CR or CRLF.<p>One idea is to store the correction data as binary, then read two bits every time you see a LF byte.  It&#x27;s either an actual LF, a CR, or a CRLF.  The downside is that binary data itself could need correction as well, and encoding nearly 1-bit data in 2 bits is still wasteful (but simple).  Packing five 3-state values into a byte is less wasteful and would eliminate forbidden symbols, but is still not optimal.</div><br/><div id="42527885" class="c"><input type="checkbox" id="c-42527885" checked=""/><div class="controls bullet"><span class="by">gildas</span><span>|</span><a href="#42527861">parent</a><span>|</span><a href="#42527689">next</a><span>|</span><label class="collapse" for="c-42527885">[-]</label><label class="expand" for="c-42527885">[1 more]</label></div><br/><div class="children"><div class="content">You&#x27;re right, SingleFile (which is capable of saving pages in this format) does a little better than the demo, but it can also be optimized. In fact, I chose the JSON format to keep things as simple and didactic as possible for the presentation. I think I need to use your suggestions to optimize this structure in SingleFile ;)</div><br/></div></div></div></div><div id="42527689" class="c"><input type="checkbox" id="c-42527689" checked=""/><div class="controls bullet"><span class="by">OkGoDoIt</span><span>|</span><a href="#42527861">prev</a><span>|</span><label class="collapse" for="c-42527689">[-]</label><label class="expand" for="c-42527689">[7 more]</label></div><br/><div class="children"><div class="content">I was hoping for an example PNG on the webpage to showcase that it actually works. I’m on my phone so I can’t do much with a downloaded zip file. But it would be cool to see that the PNG renders like a normal image on Safari mobile.</div><br/><div id="42527961" class="c"><input type="checkbox" id="c-42527961" checked=""/><div class="controls bullet"><span class="by">gildas</span><span>|</span><a href="#42527689">parent</a><span>|</span><a href="#42527732">next</a><span>|</span><label class="collapse" for="c-42527961">[-]</label><label class="expand" for="c-42527961">[1 more]</label></div><br/><div class="children"><div class="content">Note that if you&#x27;re on iOS, it&#x27;s possible that the HTML page doesn&#x27;t work at all because when it&#x27;s opened from the filesystem, it&#x27;s displayed by a viewer which doesn&#x27;t support JS instead of Safari.</div><br/></div></div><div id="42527732" class="c"><input type="checkbox" id="c-42527732" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#42527689">parent</a><span>|</span><a href="#42527961">prev</a><span>|</span><a href="#42527977">next</a><span>|</span><label class="collapse" for="c-42527732">[-]</label><label class="expand" for="c-42527732">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s the &quot;Rennes JS User Group&quot; image that you see in the middle of the HTML page.</div><br/></div></div><div id="42527977" class="c"><input type="checkbox" id="c-42527977" checked=""/><div class="controls bullet"><span class="by">a1o</span><span>|</span><a href="#42527689">parent</a><span>|</span><a href="#42527732">prev</a><span>|</span><label class="collapse" for="c-42527977">[-]</label><label class="expand" for="c-42527977">[4 more]</label></div><br/><div class="children"><div class="content">I am also on my phone and found it weird that wasn&#x27;t a single online demo</div><br/><div id="42528010" class="c"><input type="checkbox" id="c-42528010" checked=""/><div class="controls bullet"><span class="by">gildas</span><span>|</span><a href="#42527689">root</a><span>|</span><a href="#42527977">parent</a><span>|</span><label class="collapse" for="c-42528010">[-]</label><label class="expand" for="c-42528010">[3 more]</label></div><br/><div class="children"><div class="content">Here is the demo file (cf. the first paragraph and the end of the article): <a href="https:&#x2F;&#x2F;github.com&#x2F;gildas-lormeau&#x2F;Polyglot-HTML-ZIP-PNG&#x2F;raw&#x2F;main&#x2F;demo.png.zip.html">https:&#x2F;&#x2F;github.com&#x2F;gildas-lormeau&#x2F;Polyglot-HTML-ZIP-PNG&#x2F;raw&#x2F;...</a></div><br/><div id="42528391" class="c"><input type="checkbox" id="c-42528391" checked=""/><div class="controls bullet"><span class="by">gavindean90</span><span>|</span><a href="#42527689">root</a><span>|</span><a href="#42528010">parent</a><span>|</span><label class="collapse" for="c-42528391">[-]</label><label class="expand" for="c-42528391">[2 more]</label></div><br/><div class="children"><div class="content">A screenshot would help</div><br/><div id="42529085" class="c"><input type="checkbox" id="c-42529085" checked=""/><div class="controls bullet"><span class="by">edflsafoiewq</span><span>|</span><a href="#42527689">root</a><span>|</span><a href="#42528391">parent</a><span>|</span><label class="collapse" for="c-42529085">[-]</label><label class="expand" for="c-42529085">[1 more]</label></div><br/><div class="children"><div class="content">A screenshot of what? It just looks like a normal web page.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>