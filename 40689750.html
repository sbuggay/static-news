<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718528458055" as="style"/><link rel="stylesheet" href="styles.css?v=1718528458055"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.gistre.epita.fr/posts/benjamin.peter-2022-10-28-address_sanitizer_internals/">Address Sanitizer Internals</a> <span class="domain">(<a href="https://blog.gistre.epita.fr">blog.gistre.epita.fr</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>19 comments</span></div><br/><div><div id="40695665" class="c"><input type="checkbox" id="c-40695665" checked=""/><div class="controls bullet"><span class="by">shric</span><span>|</span><a href="#40690649">next</a><span>|</span><label class="collapse" for="c-40695665">[-]</label><label class="expand" for="c-40695665">[1 more]</label></div><br/><div class="children"><div class="content">&quot;For this article, you’ll need the following knowledge:<p>Basic C understanding (Memory, Stack, Heap, Syscall).&quot;<p>Obviously, since C doesn&#x27;t prescribe any kind of heap, stack or syscall behavior (or if they even exist), I assume the author meant something like &quot;Basic understanding of how C is often implemented on certain operating systems and hardware&quot;.</div><br/></div></div><div id="40690649" class="c"><input type="checkbox" id="c-40690649" checked=""/><div class="controls bullet"><span class="by">yosefk</span><span>|</span><a href="#40695665">prev</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40690649">[-]</label><label class="expand" for="c-40690649">[12 more]</label></div><br/><div class="children"><div class="content">One thing this explains is why ASan has false negatives. It&#x27;s a great tool, but the typical comment that it fully mitigates memory safety issues is just not true (even assuming your tests actually trigger the memory safety bugs, which unlike eg code coverage there&#x27;s no knowing if you achieved or not)</div><br/><div id="40690773" class="c"><input type="checkbox" id="c-40690773" checked=""/><div class="controls bullet"><span class="by">searealist</span><span>|</span><a href="#40690649">parent</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40690773">[-]</label><label class="expand" for="c-40690773">[11 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve never seen anyone claim that.</div><br/><div id="40691469" class="c"><input type="checkbox" id="c-40691469" checked=""/><div class="controls bullet"><span class="by">yosefk</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40690773">parent</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40691469">[-]</label><label class="expand" for="c-40691469">[10 more]</label></div><br/><div class="children"><div class="content">It comes up a lot in HN C++-related comment threads, for starters</div><br/><div id="40695583" class="c"><input type="checkbox" id="c-40695583" checked=""/><div class="controls bullet"><span class="by">adrian_b</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40691469">parent</a><span>|</span><a href="#40692290">next</a><span>|</span><label class="collapse" for="c-40695583">[-]</label><label class="expand" for="c-40695583">[1 more]</label></div><br/><div class="children"><div class="content">If it comes up, than that must be due to frequent confusions between ASAN and the many other completely different kinds of sanitizers, like the array bounds checker.<p>Unfortunately the documentation for the great number of sanitizers available in gcc and clang is both voluminous and incomplete.<p>For all of them their internals should have been very clearly documented, like in this article about ASAN.</div><br/></div></div><div id="40692290" class="c"><input type="checkbox" id="c-40692290" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40691469">parent</a><span>|</span><a href="#40695583">prev</a><span>|</span><a href="#40691959">next</a><span>|</span><label class="collapse" for="c-40692290">[-]</label><label class="expand" for="c-40692290">[4 more]</label></div><br/><div class="children"><div class="content">I frequently bring up ASan on HN. it&#x27;s a great way to mitigate C and C++&#x27;s shortcomings. But it&#x27;s not a panacea and unlikely to be described that way here without swift rebuttal.<p>C or C++ w&#x2F;o ASan and UBSan is like skydiving w&#x2F;o a parachute.</div><br/><div id="40693263" class="c"><input type="checkbox" id="c-40693263" checked=""/><div class="controls bullet"><span class="by">turndown</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40692290">parent</a><span>|</span><a href="#40691959">next</a><span>|</span><label class="collapse" for="c-40693263">[-]</label><label class="expand" for="c-40693263">[3 more]</label></div><br/><div class="children"><div class="content">I wouldn’t say they explicitly mention ASan, but in general you will see certain well known C++ developers&#x2F;community members insist that with a set of sanitizers you won’t have to worry about the kind of things safety focused programmers would like added to C++, all the time never mentioning false positives.</div><br/><div id="40695480" class="c"><input type="checkbox" id="c-40695480" checked=""/><div class="controls bullet"><span class="by">adrian_b</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40693263">parent</a><span>|</span><a href="#40691959">next</a><span>|</span><label class="collapse" for="c-40695480">[-]</label><label class="expand" for="c-40695480">[2 more]</label></div><br/><div class="children"><div class="content">ASAN is only a probabilistic sanitizer, but adding deterministic checks, like out-of-bounds checks or integer overflow checks, is the same in C&#x2F;C++ compiled with the appropriate options as what is done in any programming language where these checks are done by default.<p>In that case there are no false positives or negatives.</div><br/><div id="40695658" class="c"><input type="checkbox" id="c-40695658" checked=""/><div class="controls bullet"><span class="by">nneonneo</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40695480">parent</a><span>|</span><a href="#40691959">next</a><span>|</span><label class="collapse" for="c-40695658">[-]</label><label class="expand" for="c-40695658">[1 more]</label></div><br/><div class="children"><div class="content">Pray tell: what magic C&#x2F;C++ compiler options do I add to enable deterministic OOB checks that never produce any false positives or negatives?</div><br/></div></div></div></div></div></div></div></div><div id="40691959" class="c"><input type="checkbox" id="c-40691959" checked=""/><div class="controls bullet"><span class="by">searealist</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40691469">parent</a><span>|</span><a href="#40692290">prev</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40691959">[-]</label><label class="expand" for="c-40691959">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve never seen anyone claim that asan fully mitigates memory safety issues in C++. Perhaps you could link to one?</div><br/><div id="40692396" class="c"><input type="checkbox" id="c-40692396" checked=""/><div class="controls bullet"><span class="by">skobes</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40691959">parent</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40692396">[-]</label><label class="expand" for="c-40692396">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve never seen that particular claim either, but I did previously believe that asan would reliably detect an out-of-bounds write if and when it occurs.<p>So I learned something new from the OP (that this type of false negative is possible).</div><br/><div id="40695440" class="c"><input type="checkbox" id="c-40695440" checked=""/><div class="controls bullet"><span class="by">adrian_b</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40692396">parent</a><span>|</span><a href="#40694387">next</a><span>|</span><label class="collapse" for="c-40695440">[-]</label><label class="expand" for="c-40695440">[1 more]</label></div><br/><div class="children"><div class="content">ASAN, i.e. &quot;-fsanitize=address&quot; is a completely different and unrelated sanitizer than checking out-of-bounds accesses, like &quot;-fsanitize=bounds-strict&quot;.<p>Checking out-of-bounds accesses must detect any out-of-bounds access done at run time. It is done by comparing the pointers or indices used for access with the array bounds.<p>(At least for gcc: &quot;Initializers of variables with static storage are not instrumented.&quot;)<p>Out-of-bounds access checking and integer overflow detection should normally be enabled by default by any C&#x2F;C++ developer, excluding only those functions where it has been determined experimentally that disabling the checks improves measurably the performance and which have been verified very carefully to prove that such exceptions cannot occur.<p>Unfortunately, in gcc and clang there is a large number of compilation options related to sanitizers. Most of them should always be enabled, to remove all problems created by the laxity of the C&#x2F;C++ standards. Instead of listing on the command line the humongous number of such options, many of the most useful are included in &quot;-fsanitize=undefined&quot;, but the compiler documentation must be studied to see what else may need to be added. At least for release builds, &quot;-fsanitize-trap=all&quot; is usually also desirable.</div><br/></div></div><div id="40694387" class="c"><input type="checkbox" id="c-40694387" checked=""/><div class="controls bullet"><span class="by">searealist</span><span>|</span><a href="#40690649">root</a><span>|</span><a href="#40692396">parent</a><span>|</span><a href="#40695440">prev</a><span>|</span><a href="#40690373">next</a><span>|</span><label class="collapse" for="c-40694387">[-]</label><label class="expand" for="c-40694387">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, I&#x27;m just responding to the guy who is probably the most internet-famous C++ hater in the world. I guess he likes to make up stuff too. The article is good.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="40690373" class="c"><input type="checkbox" id="c-40690373" checked=""/><div class="controls bullet"><span class="by">xtqctz</span><span>|</span><a href="#40690649">prev</a><span>|</span><a href="#40691849">next</a><span>|</span><label class="collapse" for="c-40690373">[-]</label><label class="expand" for="c-40690373">[2 more]</label></div><br/><div class="children"><div class="content">This is great! I found these videos helpful, too: <a href="https:&#x2F;&#x2F;youtu.be&#x2F;Tl1uZ7FBwFQ" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;Tl1uZ7FBwFQ</a><p>Does anyone know of a good explanation of HWAddress Sanitizer internals?</div><br/><div id="40692957" class="c"><input type="checkbox" id="c-40692957" checked=""/><div class="controls bullet"><span class="by">barco</span><span>|</span><a href="#40690373">parent</a><span>|</span><a href="#40691849">next</a><span>|</span><label class="collapse" for="c-40692957">[-]</label><label class="expand" for="c-40692957">[1 more]</label></div><br/><div class="children"><div class="content">There are multiple versions of HWAsan.<p>One for ARMv8 with Top-Byte-Ignore: you can use the top byte of memory addresses to store a tag.<p>When you allocate memory you return  the &quot;tagged&quot; pointer and internally store &quot;this region has this tag&quot;.<p>When you dereference a pointer, you check that the tag matches what you expect in your internal data structure.<p>With memory tagging extensions you can do something similar but the checks are performed by the processor.</div><br/></div></div></div></div><div id="40691849" class="c"><input type="checkbox" id="c-40691849" checked=""/><div class="controls bullet"><span class="by">kccqzy</span><span>|</span><a href="#40690373">prev</a><span>|</span><a href="#40692905">next</a><span>|</span><label class="collapse" for="c-40691849">[-]</label><label class="expand" for="c-40691849">[1 more]</label></div><br/><div class="children"><div class="content">Who sanitizes the sanitizer? One of the most hilarious bugs I&#x27;ve previously seen is when someone found a memory out-of-bound access inside the run time support library of Asan.</div><br/></div></div><div id="40692905" class="c"><input type="checkbox" id="c-40692905" checked=""/><div class="controls bullet"><span class="by">ThouYS</span><span>|</span><a href="#40691849">prev</a><span>|</span><label class="collapse" for="c-40692905">[-]</label><label class="expand" for="c-40692905">[2 more]</label></div><br/><div class="children"><div class="content">sanitizers are a constant source of pain</div><br/><div id="40693315" class="c"><input type="checkbox" id="c-40693315" checked=""/><div class="controls bullet"><span class="by">kimixa</span><span>|</span><a href="#40692905">parent</a><span>|</span><label class="collapse" for="c-40693315">[-]</label><label class="expand" for="c-40693315">[1 more]</label></div><br/><div class="children"><div class="content">And just like pain, they show you where the (likely) problem is.<p>If you didn&#x27;t have pain you&#x27;d still get the same damage to the body, you just wouldn&#x27;t be aware.</div><br/></div></div></div></div></div></div></div></div></div></body></html>