<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1703062865710" as="style"/><link rel="stylesheet" href="styles.css?v=1703062865710"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://playfulprogramming.blogspot.com/2023/12/about-time.html">How to unit test code that depends on time</a> <span class="domain">(<a href="https://playfulprogramming.blogspot.com">playfulprogramming.blogspot.com</a>)</span></div><div class="subtext"><span>ingve</span> | <span>81 comments</span></div><br/><div><div id="38705710" class="c"><input type="checkbox" id="c-38705710" checked=""/><div class="controls bullet"><span class="by">pimlottc</span><span>|</span><a href="#38704899">next</a><span>|</span><label class="collapse" for="c-38705710">[-]</label><label class="expand" for="c-38705710">[3 more]</label></div><br/><div class="children"><div class="content">&gt; If you can live with the loss of precision from Approach 5, pass time stamps,<p>I was confused why a passed-in timestamp would have less granularity than the return value of gettime() (or whatever) directly. The issue isn’t a loss of &#x2F;precision&#x2F;, but a loss of &#x2F;accuracy&#x2F; due to added latency between observing the time outside the function and making the decision within the function.</div><br/><div id="38706503" class="c"><input type="checkbox" id="c-38706503" checked=""/><div class="controls bullet"><span class="by">ikari_pl</span><span>|</span><a href="#38705710">parent</a><span>|</span><a href="#38704899">next</a><span>|</span><label class="collapse" for="c-38706503">[-]</label><label class="expand" for="c-38706503">[2 more]</label></div><br/><div class="children"><div class="content">Interesting observation: my first language is Polish, and we&#x27;d use the same word for accuracy and precision (&quot;dokładność&quot;).</div><br/><div id="38706605" class="c"><input type="checkbox" id="c-38706605" checked=""/><div class="controls bullet"><span class="by">V-2</span><span>|</span><a href="#38705710">root</a><span>|</span><a href="#38706503">parent</a><span>|</span><a href="#38704899">next</a><span>|</span><label class="collapse" for="c-38706605">[-]</label><label class="expand" for="c-38706605">[1 more]</label></div><br/><div class="children"><div class="content">Really? Precision translates to (unsurprisingly) &quot;precyzja&quot;, and in the specific context of calculations and measurements, the distinction is well established, see eg.:<p>* <a href="https:&#x2F;&#x2F;centrumdruku3d.pl&#x2F;jak-zrozumiec-roznice-pomiedzy-dokladnoscia-precyzja-a-tolerancja&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;centrumdruku3d.pl&#x2F;jak-zrozumiec-roznice-pomiedzy-dok...</a><p>* <a href="https:&#x2F;&#x2F;automatykab2b.pl&#x2F;technika&#x2F;54301-dokladnosc-i-precyzja-kluczowe-w-systemach-pomiarowych-i-automatyki" rel="nofollow noreferrer">https:&#x2F;&#x2F;automatykab2b.pl&#x2F;technika&#x2F;54301-dokladnosc-i-precyzj...</a><p>* <a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;pl-pl&#x2F;office&#x2F;troubleshoot&#x2F;access&#x2F;floating-calculations-info" rel="nofollow noreferrer">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;pl-pl&#x2F;office&#x2F;troubleshoot&#x2F;access...</a><p>* <a href="https:&#x2F;&#x2F;pl.wikipedia.org&#x2F;wiki&#x2F;Dok%C5%82adno%C5%9B%C4%87_i_precyzja_metody_pomiaru" rel="nofollow noreferrer">https:&#x2F;&#x2F;pl.wikipedia.org&#x2F;wiki&#x2F;Dok%C5%82adno%C5%9B%C4%87_i_pr...</a><p>etc.</div><br/></div></div></div></div></div></div><div id="38704899" class="c"><input type="checkbox" id="c-38704899" checked=""/><div class="controls bullet"><span class="by">Xophmeister</span><span>|</span><a href="#38705710">prev</a><span>|</span><a href="#38706538">next</a><span>|</span><label class="collapse" for="c-38704899">[-]</label><label class="expand" for="c-38704899">[28 more]</label></div><br/><div class="children"><div class="content">Time is a dependency like any other, so use dependency inversion. (Which I think is advocated by TFA’s approaches 4 and 5.)<p>Define an interface for timers, which is injected into the object that depends on time. Use a wrapper implementation over the usual timer for the real code; and a simple implementation, which can be controlled parametrically, in the tests.</div><br/><div id="38704971" class="c"><input type="checkbox" id="c-38704971" checked=""/><div class="controls bullet"><span class="by">BoiledCabbage</span><span>|</span><a href="#38704899">parent</a><span>|</span><a href="#38705051">next</a><span>|</span><label class="collapse" for="c-38704971">[-]</label><label class="expand" for="c-38704971">[7 more]</label></div><br/><div class="children"><div class="content">Dependency injection of just the function you need is good, but is still the second best approach.<p>The best approach is separating the calling of the external dependency (getting the time) to it&#x27;s own function, and pass in the results of that call to your main function. Then test your main function. Ie approach 5. This eliminates the need for mocks and creates better factored code.</div><br/><div id="38705140" class="c"><input type="checkbox" id="c-38705140" checked=""/><div class="controls bullet"><span class="by">theamk</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38704971">parent</a><span>|</span><a href="#38705051">next</a><span>|</span><label class="collapse" for="c-38705140">[-]</label><label class="expand" for="c-38705140">[6 more]</label></div><br/><div class="children"><div class="content">That works until you have a function that implements timeout and so needs to query time multiple times per invocation.</div><br/><div id="38705506" class="c"><input type="checkbox" id="c-38705506" checked=""/><div class="controls bullet"><span class="by">BoiledCabbage</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705140">parent</a><span>|</span><a href="#38706285">next</a><span>|</span><label class="collapse" for="c-38705506">[-]</label><label class="expand" for="c-38705506">[1 more]</label></div><br/><div class="children"><div class="content">Agreed, so the preference order is 1. Pass in the data you need 2. Pass in a function that gives you the data you need 3a.&#x2F;3b. Pass in an object (or function like a factory) that gives you the function that gets you the data you need.</div><br/></div></div><div id="38705408" class="c"><input type="checkbox" id="c-38705408" checked=""/><div class="controls bullet"><span class="by">JimmyAustin</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705140">parent</a><span>|</span><a href="#38706285">prev</a><span>|</span><a href="#38705775">next</a><span>|</span><label class="collapse" for="c-38705408">[-]</label><label class="expand" for="c-38705408">[1 more]</label></div><br/><div class="children"><div class="content">The function you pass in can keep track of how many times it’s been called, and provide different values on each call.</div><br/></div></div><div id="38705775" class="c"><input type="checkbox" id="c-38705775" checked=""/><div class="controls bullet"><span class="by">LouisSayers</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705140">parent</a><span>|</span><a href="#38705408">prev</a><span>|</span><a href="#38705051">next</a><span>|</span><label class="collapse" for="c-38705775">[-]</label><label class="expand" for="c-38705775">[2 more]</label></div><br/><div class="children"><div class="content">You can extract the timeout functionality into its own structure then and mock it out during testing.<p>There&#x27;s usually a solution of some sort, it might just require a bit of rearranging and extraction of concerns.</div><br/><div id="38705880" class="c"><input type="checkbox" id="c-38705880" checked=""/><div class="controls bullet"><span class="by">aaomidi</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705775">parent</a><span>|</span><a href="#38705051">next</a><span>|</span><label class="collapse" for="c-38705880">[-]</label><label class="expand" for="c-38705880">[1 more]</label></div><br/><div class="children"><div class="content">That’s basically dependency injection</div><br/></div></div></div></div></div></div></div></div><div id="38705051" class="c"><input type="checkbox" id="c-38705051" checked=""/><div class="controls bullet"><span class="by">chii</span><span>|</span><a href="#38704899">parent</a><span>|</span><a href="#38704971">prev</a><span>|</span><a href="#38706252">next</a><span>|</span><label class="collapse" for="c-38705051">[-]</label><label class="expand" for="c-38705051">[14 more]</label></div><br/><div class="children"><div class="content">The unfortunate aspect is that this only works for code you control.<p>If you have code you need to run, but has no control over (such as a database library), then you will have issues.<p>For example, you want to test that an entry in a caching library is indeed expiring entries like you wanted. How do you change the library to consume a time interface, if that library doesn&#x27;t expose it to you?</div><br/><div id="38705207" class="c"><input type="checkbox" id="c-38705207" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705051">parent</a><span>|</span><a href="#38706351">next</a><span>|</span><label class="collapse" for="c-38705207">[-]</label><label class="expand" for="c-38705207">[9 more]</label></div><br/><div class="children"><div class="content">You don&#x27;t. Testing third-party code is beyond the purview of first-party tests.<p>If you have first-party code that is adjacent to a third-party library in a way that the library hinders testing of that first-party code, you would substitute a (minimal) implementation that you control in for the third-party library  while under test.<p>If the library is open source or similarly code accessible, you would fork it or coordinate control with its stakeholders to see the testing of it in that codebase (and refactor it as necessary to support that). This is where the library needs to ensure it does what the documentation claims. It is not the concern of your application.<p>Otherwise, if the code is truly beyond your reach, you just have to trust that the vendor&#x27;s claims are true. If you cannot establish that trust, use a different library that you can trust. Testing concerns are the least of your problems when you have no trust for the library you are using.</div><br/><div id="38705415" class="c"><input type="checkbox" id="c-38705415" checked=""/><div class="controls bullet"><span class="by">MaulingMonkey</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705207">parent</a><span>|</span><a href="#38706351">next</a><span>|</span><label class="collapse" for="c-38705415">[-]</label><label class="expand" for="c-38705415">[8 more]</label></div><br/><div class="children"><div class="content">&gt; You don&#x27;t. Testing third-party code is beyond the purview of first-party tests.<p>Testing third-party code is often well within the purview of first-party integration testing.  Aside from validating your code, and your understanding of the documentation, these sometimes incidentally catch third-party bugs.  Working around bugs until upstream fixes their code may also be within the purview of first-party code... and perhaps catching regressions even if they&#x27;ve supposedly been fixed.<p>&gt; Otherwise, if the code is truly beyond your reach, you just have to trust that the vendor&#x27;s claims are true. If you cannot establish that trust, use a different library that you can trust. Testing concerns are the least of your problems when you have no trust for the library you are using.<p>We unit test our code because we can&#x27;t even trust ourselves - nevermind our coworkers, nevermind third party vendors.  Granted, unit tests for third party libraries are often worth upstreaming, and you may trust upstream enough to delete your downstream copies of those unit tests once you do...</div><br/><div id="38706124" class="c"><input type="checkbox" id="c-38706124" checked=""/><div class="controls bullet"><span class="by">unscaled</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705415">parent</a><span>|</span><a href="#38705516">next</a><span>|</span><label class="collapse" for="c-38706124">[-]</label><label class="expand" for="c-38706124">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Testing third-party code is often well within the purview of first-party integration testing.<p>Yes, integration tests do tend to cover integration with third party libraries and even entire products (such as databases). But even in integration tests, the third party code is incidental.<p>For instance, when created integration tests for databases, it&#x27;s very common to use an embedded or in-memory DB such as SQLite or H2. You want to test integration with third-party modules when it is possible and &quot;cheap&quot;, but the highest priorities are testing first-party module integration and having tests than can run fast without requiring a full-fledged replica of our production environment.<p>If I come back to the GP statement &quot;this only works for code you control&quot;, they either meant that you can&#x27;t use this this techniques unit tests of third-party code or that you can&#x27;t use this technique in integration tests of third-party code. Either way, it doesn&#x27;t make sense. You cannot and should not unit test code you don&#x27;t own, and you&#x27;re not supposed use mocks (like a mocked clock) in integration tests.</div><br/><div id="38706594" class="c"><input type="checkbox" id="c-38706594" checked=""/><div class="controls bullet"><span class="by">MoreQARespect</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38706124">parent</a><span>|</span><a href="#38705516">next</a><span>|</span><label class="collapse" for="c-38706594">[-]</label><label class="expand" for="c-38706594">[1 more]</label></div><br/><div class="children"><div class="content">&gt;Yes, integration tests do tend to cover integration with third party libraries and even entire products (such as databases). But even in integration tests, the third party code is incidental.<p>It definitely shouldnt be. At least, not if you want your tests to tell you when upgrading a 3rd party dependency will break something.<p>&gt;For instance, when created integration tests for databases, it&#x27;s very common to use an embedded or in-memory DB<p>I worked on a project that did this once and they very quickly got blocked writing a test by the in memory database not supporting a feature postgres had.<p>Realism matters.<p>&gt;you&#x27;re not supposed use mocks (like a mocked clock)<p>What if I do?</div><br/></div></div></div></div><div id="38705516" class="c"><input type="checkbox" id="c-38705516" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705415">parent</a><span>|</span><a href="#38706124">prev</a><span>|</span><a href="#38706351">next</a><span>|</span><label class="collapse" for="c-38705516">[-]</label><label class="expand" for="c-38705516">[5 more]</label></div><br/><div class="children"><div class="content"><i>&gt; Testing third-party code is often well within the purview of first-party integration testing.</i><p>Not really. While you may end up testing third-party code incidentally in the process of you testing your first-party code, explicit tests directed at third-party code necessarily requires testing implementation details, and testing implementation details is how you get constantly breaking tests every time you try to change something and developers giving up on testing in frustration.<p>The value proposition of testing is that it documents the <i>user interface</i> in a way that is independent of implementation, allowing you to continue to iterate on the implementation while having assurances that, no matter what you do under the hood, the user experience does not deviate from what is documented.</div><br/><div id="38705546" class="c"><input type="checkbox" id="c-38705546" checked=""/><div class="controls bullet"><span class="by">dragonwriter</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705516">parent</a><span>|</span><a href="#38706317">next</a><span>|</span><label class="collapse" for="c-38705546">[-]</label><label class="expand" for="c-38705546">[2 more]</label></div><br/><div class="children"><div class="content">&gt; The value proposition of testing is that it documents [...]<p>No, the value proposition of testing is that it identifies incorrect system behavior before it manifests in live use. Documentation of anything is not the central value proposition of testing.</div><br/><div id="38705570" class="c"><input type="checkbox" id="c-38705570" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705546">parent</a><span>|</span><a href="#38706317">next</a><span>|</span><label class="collapse" for="c-38705570">[-]</label><label class="expand" for="c-38705570">[1 more]</label></div><br/><div class="children"><div class="content"><i>&gt; the value proposition of testing is that it identifies incorrect system behavior before it manifests in live use.</i><p>Incorrect with respect to the documentation, yes. That&#x27;s what I just said.<p>Tests are not intended to find undocumented incorrect behaviour. This is provable by taking it to the logical extreme of a codebase that is completely undocumented (no tests). When no tests run, no incorrect behaviour will be uncovered by it.<p>Only documented cases can reveal instances where the code does not conform to what is documented.</div><br/></div></div></div></div><div id="38706317" class="c"><input type="checkbox" id="c-38706317" checked=""/><div class="controls bullet"><span class="by">throwbadubadu</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705516">parent</a><span>|</span><a href="#38705546">prev</a><span>|</span><a href="#38706351">next</a><span>|</span><label class="collapse" for="c-38706317">[-]</label><label class="expand" for="c-38706317">[2 more]</label></div><br/><div class="children"><div class="content">Why cant you test third-party code the same as you ideally test first party, by the interface and spec, as black box? Did that, and most often then just happens implicitly anyway in integration testing? Because your code uses third-party as specced? Confused.</div><br/><div id="38706436" class="c"><input type="checkbox" id="c-38706436" checked=""/><div class="controls bullet"><span class="by">randomdata</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38706317">parent</a><span>|</span><a href="#38706351">next</a><span>|</span><label class="collapse" for="c-38706436">[-]</label><label class="expand" for="c-38706436">[1 more]</label></div><br/><div class="children"><div class="content">Third-party code hidden in a black box cannot be within the purview of your first-party tests. There is no way for those tests to know that the third-party code exists. It&#x27;s hidden away in a black box.<p>If a third-party library within the black box is executed during the execution of a test, you may incidentally discovery cases where the library produces something not conformant with your documentation, but that is in no way explicit.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="38706351" class="c"><input type="checkbox" id="c-38706351" checked=""/><div class="controls bullet"><span class="by">jcul</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705051">parent</a><span>|</span><a href="#38705207">prev</a><span>|</span><a href="#38705393">next</a><span>|</span><label class="collapse" for="c-38706351">[-]</label><label class="expand" for="c-38706351">[1 more]</label></div><br/><div class="children"><div class="content">I recently came across libfaketime. It intercepts time related system calls, so you can set a time of your choosing, starting from program startup.<p>$ faketime &#x27;last friday 5 pm&#x27; sh -c &quot;&#x2F;bin&#x2F;date; sleep 5; &#x2F;bin&#x2F;date&quot;
 Fri 15 Dec 2023 17:00:00 GMT
 Fri 15 Dec 2023 17:00:05 GMT</div><br/></div></div><div id="38705393" class="c"><input type="checkbox" id="c-38705393" checked=""/><div class="controls bullet"><span class="by">MaulingMonkey</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705051">parent</a><span>|</span><a href="#38706351">prev</a><span>|</span><a href="#38705136">next</a><span>|</span><label class="collapse" for="c-38705393">[-]</label><label class="expand" for="c-38705393">[1 more]</label></div><br/><div class="children"><div class="content">&gt; For example, you want to test that an entry in a caching library is indeed expiring entries like you wanted. How do you change the library to consume a time interface, if that library doesn&#x27;t expose it to you?<p>Intercepting&#x2F;hooking system APIs might be an option in some cases.  You might even be able to use something someone else wrote.  Some prior art for date&#x2F;time stuff specifically (which I haven&#x27;t used and thus can&#x27;t vouch for:)<p>• <a href="https:&#x2F;&#x2F;manpages.ubuntu.com&#x2F;manpages&#x2F;trusty&#x2F;man1&#x2F;datefudge.1.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;manpages.ubuntu.com&#x2F;manpages&#x2F;trusty&#x2F;man1&#x2F;datefudge.1...</a><p>• <a href="https:&#x2F;&#x2F;www.nirsoft.net&#x2F;utils&#x2F;run_as_date.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.nirsoft.net&#x2F;utils&#x2F;run_as_date.html</a><p>More dynamic &#x2F; finer grained hooking (e.g. perhaps targeting a single thread, within a function&#x27;s scope, because you&#x27;re not writing a command line tool that quickly exits) is likely to require a more manual touch.</div><br/></div></div><div id="38705136" class="c"><input type="checkbox" id="c-38705136" checked=""/><div class="controls bullet"><span class="by">theamk</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38705051">parent</a><span>|</span><a href="#38705393">prev</a><span>|</span><a href="#38706287">next</a><span>|</span><label class="collapse" for="c-38705136">[-]</label><label class="expand" for="c-38705136">[1 more]</label></div><br/><div class="children"><div class="content">In C++, you normally don&#x27;t -- there are low-level function hooking calls or ptrace api, but those are too complex to be used in unit tests.<p>The approaches I have seen used in practical projects is:<p>Ignore unit testing of time-related parts, rely on integration tests.<p>Have unit tests be super slow so that actual system clock can be used. Get occasional false positive failures when your build system scheduled unit tests in parallel with particularly complex compilation tasks.<p>Wrap everything in your own wrapper, providing &quot;production&quot; and &quot;testing&quot; version of  class, which &quot;production&quot; calling into the 3rd party library while &quot;testing&quot; calls into your implementation that uses debug time. This is non-trivial as &quot;testing&quot; implementation might be quite complex, but may be worth it for some common functionality like timers.</div><br/></div></div></div></div><div id="38706252" class="c"><input type="checkbox" id="c-38706252" checked=""/><div class="controls bullet"><span class="by">bluGill</span><span>|</span><a href="#38704899">parent</a><span>|</span><a href="#38705051">prev</a><span>|</span><a href="#38704922">next</a><span>|</span><label class="collapse" for="c-38706252">[-]</label><label class="expand" for="c-38706252">[1 more]</label></div><br/><div class="children"><div class="content">Then you get too many dependencies and the code is hard to work with because you in turn have too add so many dependencies. This is a hard problem in large programs.</div><br/></div></div><div id="38704922" class="c"><input type="checkbox" id="c-38704922" checked=""/><div class="controls bullet"><span class="by">calebio</span><span>|</span><a href="#38704899">parent</a><span>|</span><a href="#38706252">prev</a><span>|</span><a href="#38706304">next</a><span>|</span><label class="collapse" for="c-38704922">[-]</label><label class="expand" for="c-38704922">[1 more]</label></div><br/><div class="children"><div class="content">I agree. I first started doing this (instead of the often recommended global monkey patch) when I started programming in Go.<p>In our main application we pass in a function that returns `time.Now()`, and in tests we pass in a function that returns whatever time object we want.</div><br/></div></div><div id="38706304" class="c"><input type="checkbox" id="c-38706304" checked=""/><div class="controls bullet"><span class="by">noobermin</span><span>|</span><a href="#38704899">parent</a><span>|</span><a href="#38704922">prev</a><span>|</span><a href="#38706538">next</a><span>|</span><label class="collapse" for="c-38706304">[-]</label><label class="expand" for="c-38706304">[4 more]</label></div><br/><div class="children"><div class="content">While I generally don&#x27;t think tests are bad in general this is a wonderful example of the fundamental problem with software development. Essentially, you have a tool that was supposed to make development easier (tests) eventually change the code to become more complicated to make it easier to use that tool with, which makes development harder.</div><br/><div id="38706314" class="c"><input type="checkbox" id="c-38706314" checked=""/><div class="controls bullet"><span class="by">skrebbel</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38706304">parent</a><span>|</span><a href="#38706538">next</a><span>|</span><label class="collapse" for="c-38706314">[-]</label><label class="expand" for="c-38706314">[3 more]</label></div><br/><div class="children"><div class="content">Injecting a Clock or Timer is great not just for automated tests but also for debugging weird behavior. Theres really hardly any downsides.</div><br/><div id="38706461" class="c"><input type="checkbox" id="c-38706461" checked=""/><div class="controls bullet"><span class="by">bruce343434</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38706314">parent</a><span>|</span><a href="#38706538">next</a><span>|</span><label class="collapse" for="c-38706461">[-]</label><label class="expand" for="c-38706461">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m not sure how that would work. Can you give an example?</div><br/><div id="38706552" class="c"><input type="checkbox" id="c-38706552" checked=""/><div class="controls bullet"><span class="by">EdwardDiego</span><span>|</span><a href="#38704899">root</a><span>|</span><a href="#38706461">parent</a><span>|</span><a href="#38706538">next</a><span>|</span><label class="collapse" for="c-38706552">[-]</label><label class="expand" for="c-38706552">[1 more]</label></div><br/><div class="children"><div class="content">Have a look at this method on Java&#x27;s Instant class for an example.<p><a href="https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;time&#x2F;Instant.html#now-java.time.Clock-" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;time&#x2F;Instant....</a><p>Code under test creates Instant, so long as it uses the Clock you&#x27;ve passed in, you&#x27;ll control how it determines when now() is.<p>You&#x27;ve got several built-in testing clocks like this one[1], but can also implement your own.<p>[1]: <a href="https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;time&#x2F;Clock.html#fixed-java.time.Instant-java.time.ZoneId-" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;time&#x2F;Clock.ht...</a></div><br/></div></div></div></div></div></div></div></div></div></div><div id="38706538" class="c"><input type="checkbox" id="c-38706538" checked=""/><div class="controls bullet"><span class="by">otikik</span><span>|</span><a href="#38704899">prev</a><span>|</span><a href="#38705426">next</a><span>|</span><label class="collapse" for="c-38706538">[-]</label><label class="expand" for="c-38706538">[3 more]</label></div><br/><div class="children"><div class="content">Ok but what I’m really interested in is integration tests that depend on time.<p>Waiting for a set amount of time (i.e. literally calling to wait(5) in the test code) is slow and, even worse than that, flaky. If the test server is busy it might take it longer than 5 seconds to do what the test needs to happen.<p>The best approach I have found  so far is “pulling for the side effects” (i.e. if the test is awaiting the creation of a flobber object, keep pulling the list of flobber objects until a new one pops up). This is not always possible (the interface for pulling the flobber objects is not always available) and it is also inconsistent with multiple threads&#x2F;processes(one thread might have the new flobber and tell your test that everything is ok, but the next step in the test you happen to be served by a different thread which doesn’t have the new flobber yet).</div><br/><div id="38706589" class="c"><input type="checkbox" id="c-38706589" checked=""/><div class="controls bullet"><span class="by">groestl</span><span>|</span><a href="#38706538">parent</a><span>|</span><a href="#38706570">next</a><span>|</span><label class="collapse" for="c-38706589">[-]</label><label class="expand" for="c-38706589">[1 more]</label></div><br/><div class="children"><div class="content">A multi-tenant timeline (i.e. a tenant local clock) with a side channel for the testing harness to modify the time is what I found most practical when doing integration tests, and the test itself depends on time. (Edit: when testing Java servers)</div><br/></div></div><div id="38706570" class="c"><input type="checkbox" id="c-38706570" checked=""/><div class="controls bullet"><span class="by">MoreQARespect</span><span>|</span><a href="#38706538">parent</a><span>|</span><a href="#38706589">prev</a><span>|</span><a href="#38705426">next</a><span>|</span><label class="collapse" for="c-38706570">[-]</label><label class="expand" for="c-38706570">[1 more]</label></div><br/><div class="children"><div class="content">My approaches:<p>1. libfaketime<p>2. Make the test resilient to changing time<p>3. Dependency inject at an even higher level</div><br/></div></div></div></div><div id="38705426" class="c"><input type="checkbox" id="c-38705426" checked=""/><div class="controls bullet"><span class="by">dissident_coder</span><span>|</span><a href="#38706538">prev</a><span>|</span><a href="#38706597">next</a><span>|</span><label class="collapse" for="c-38705426">[-]</label><label class="expand" for="c-38705426">[1 more]</label></div><br/><div class="children"><div class="content">As a Ruby&#x2F;Rails developer, time mocking is awesome.  It&#x27;s built right into rails or you can use Timecop and it&#x27;s just as simple as adding:<p><pre><code>    around { |example| Timecop.freeze(&quot;2023-12-20T12:00:00Z&quot;.to_datetime) { ex.run } }
</code></pre>
or<p><pre><code>    around { |example| travel_to(&quot;2023-12-20T12:00:00Z&quot;.to_datetime) { ex.run } }
</code></pre>
as setup hooks to your tests and it stubs all of the relevant datetime helpers for you for each test case and properly restores everything between tests.</div><br/></div></div><div id="38706597" class="c"><input type="checkbox" id="c-38706597" checked=""/><div class="controls bullet"><span class="by">ivan_gammel</span><span>|</span><a href="#38705426">prev</a><span>|</span><a href="#38706444">next</a><span>|</span><label class="collapse" for="c-38706597">[-]</label><label class="expand" for="c-38706597">[1 more]</label></div><br/><div class="children"><div class="content">In modern Java it’s pretty common to inject an application-level clock object in all components depending on time. Writing an unit test becomes easy, because you have full control over what time is returned on each call.</div><br/></div></div><div id="38706444" class="c"><input type="checkbox" id="c-38706444" checked=""/><div class="controls bullet"><span class="by">theK</span><span>|</span><a href="#38706597">prev</a><span>|</span><a href="#38705938">next</a><span>|</span><label class="collapse" for="c-38706444">[-]</label><label class="expand" for="c-38706444">[1 more]</label></div><br/><div class="children"><div class="content">Im a bit surprised that this (very C++ biased) post gets such traction on hacker news.<p>Isn&#x27;t this a solved problem viz moving side effects like IO (getting the time) out of the logic parts and just unit&#x2F;property testing those? Am I missing something here?<p>EDIT: added last sentence</div><br/></div></div><div id="38705938" class="c"><input type="checkbox" id="c-38705938" checked=""/><div class="controls bullet"><span class="by">matsemann</span><span>|</span><a href="#38706444">prev</a><span>|</span><a href="#38706471">next</a><span>|</span><label class="collapse" for="c-38705938">[-]</label><label class="expand" for="c-38705938">[1 more]</label></div><br/><div class="children"><div class="content">I recently wrote some logic that&#x27;s supposed to run every minute, and look at the data from the last minute. Normally I would&#x27;ve ended up doing queries ala event_time BETWEEN now() and now() - 1m.<p>However, one constraint was that I needed to also run this on existing data. Which led to me instead passing in time. A small thing, but suddenly this logic beame so incredibly testable. I can call it 5 times with 5 different times and see that it behaves as expected, or simulate it over a whole day of test data. Even tweak the code a bit, delete the data it generates in prod, and re-run it with the new ruleset. So flexible.<p>Such a small thing, but without the additional constraint I probably wouldn&#x27;t have arrived at this design.</div><br/></div></div><div id="38706471" class="c"><input type="checkbox" id="c-38706471" checked=""/><div class="controls bullet"><span class="by">federiconafria</span><span>|</span><a href="#38705938">prev</a><span>|</span><a href="#38706371">next</a><span>|</span><label class="collapse" for="c-38706471">[-]</label><label class="expand" for="c-38706471">[1 more]</label></div><br/><div class="children"><div class="content">Also applicable to &quot;randomness&quot;<p><a href="https:&#x2F;&#x2F;youtube.com&#x2F;shorts&#x2F;G2uaZROAWx0?si=5ecJFGU0BfF5y4u7" rel="nofollow noreferrer">https:&#x2F;&#x2F;youtube.com&#x2F;shorts&#x2F;G2uaZROAWx0?si=5ecJFGU0BfF5y4u7</a></div><br/></div></div><div id="38706371" class="c"><input type="checkbox" id="c-38706371" checked=""/><div class="controls bullet"><span class="by">cloogshicer</span><span>|</span><a href="#38706471">prev</a><span>|</span><a href="#38706470">next</a><span>|</span><label class="collapse" for="c-38706371">[-]</label><label class="expand" for="c-38706371">[3 more]</label></div><br/><div class="children"><div class="content">A bit disappointed by the article. It&#x27;s more about how to test <i>any</i> external dependency using different injection techniques, not just time.<p>What I was hoping for was something like simulations or UIs&#x2F;games. Complex user interactions like &quot;Sarah clicked here, waited a few seconds, then clicked this, then waited for a network request to finish...&quot;</div><br/><div id="38706382" class="c"><input type="checkbox" id="c-38706382" checked=""/><div class="controls bullet"><span class="by">bogota</span><span>|</span><a href="#38706371">parent</a><span>|</span><a href="#38706470">next</a><span>|</span><label class="collapse" for="c-38706382">[-]</label><label class="expand" for="c-38706382">[2 more]</label></div><br/><div class="children"><div class="content">That sounds like integration tests if the network is involved</div><br/><div id="38706399" class="c"><input type="checkbox" id="c-38706399" checked=""/><div class="controls bullet"><span class="by">cloogshicer</span><span>|</span><a href="#38706371">root</a><span>|</span><a href="#38706382">parent</a><span>|</span><a href="#38706470">next</a><span>|</span><label class="collapse" for="c-38706399">[-]</label><label class="expand" for="c-38706399">[1 more]</label></div><br/><div class="children"><div class="content">Doesn&#x27;t have to be. Could also mock that part.</div><br/></div></div></div></div></div></div><div id="38706470" class="c"><input type="checkbox" id="c-38706470" checked=""/><div class="controls bullet"><span class="by">heax</span><span>|</span><a href="#38706371">prev</a><span>|</span><a href="#38705192">next</a><span>|</span><label class="collapse" for="c-38706470">[-]</label><label class="expand" for="c-38706470">[1 more]</label></div><br/><div class="children"><div class="content">Time in software is fascinating. 
If you say time - everyone thinks he understands it perfectly as we use it in our everyday. But it has so many pitfalls in the details.</div><br/></div></div><div id="38705192" class="c"><input type="checkbox" id="c-38705192" checked=""/><div class="controls bullet"><span class="by">loloquwowndueo</span><span>|</span><a href="#38706470">prev</a><span>|</span><a href="#38705640">next</a><span>|</span><label class="collapse" for="c-38705192">[-]</label><label class="expand" for="c-38705192">[5 more]</label></div><br/><div class="children"><div class="content">* in C++.<p>On Python, just use freezegun to inject controllable timestamps in response to calls to time methods.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;spulec&#x2F;freezegun">https:&#x2F;&#x2F;github.com&#x2F;spulec&#x2F;freezegun</a></div><br/><div id="38706435" class="c"><input type="checkbox" id="c-38706435" checked=""/><div class="controls bullet"><span class="by">boxed</span><span>|</span><a href="#38705192">parent</a><span>|</span><a href="#38705279">next</a><span>|</span><label class="collapse" for="c-38706435">[-]</label><label class="expand" for="c-38706435">[1 more]</label></div><br/><div class="children"><div class="content">Freezegun is pretty much unmaintained. You want time-machine <a href="https:&#x2F;&#x2F;github.com&#x2F;adamchainz&#x2F;time-machine">https:&#x2F;&#x2F;github.com&#x2F;adamchainz&#x2F;time-machine</a></div><br/></div></div><div id="38705279" class="c"><input type="checkbox" id="c-38705279" checked=""/><div class="controls bullet"><span class="by">pmontra</span><span>|</span><a href="#38705192">parent</a><span>|</span><a href="#38706435">prev</a><span>|</span><a href="#38705640">next</a><span>|</span><label class="collapse" for="c-38705279">[-]</label><label class="expand" for="c-38705279">[3 more]</label></div><br/><div class="children"><div class="content">The Ruby equivalent is Timecop<p><a href="https:&#x2F;&#x2F;github.com&#x2F;travisjeffery&#x2F;timecop">https:&#x2F;&#x2F;github.com&#x2F;travisjeffery&#x2F;timecop</a><p>Dynamic languages have the advantage to be able to rewrite the standard library classes at runtime.</div><br/><div id="38706453" class="c"><input type="checkbox" id="c-38706453" checked=""/><div class="controls bullet"><span class="by">sroussey</span><span>|</span><a href="#38705192">root</a><span>|</span><a href="#38705279">parent</a><span>|</span><a href="#38706518">next</a><span>|</span><label class="collapse" for="c-38706453">[-]</label><label class="expand" for="c-38706453">[1 more]</label></div><br/><div class="children"><div class="content">I used to change an objects class itself in runtime in JS by changing its __proto__ property.<p>I don’t think that works anymore, but at the time I could create plain value objects and later make them class instantiations (on a small system way back when, this was a nice speed up due to a now uncommon pattern of having data first and waiting for the classes to load).</div><br/></div></div><div id="38706518" class="c"><input type="checkbox" id="c-38706518" checked=""/><div class="controls bullet"><span class="by">Brybry</span><span>|</span><a href="#38705192">root</a><span>|</span><a href="#38705279">parent</a><span>|</span><a href="#38706453">prev</a><span>|</span><a href="#38705640">next</a><span>|</span><label class="collapse" for="c-38706518">[-]</label><label class="expand" for="c-38706518">[1 more]</label></div><br/><div class="children"><div class="content">Other languages can use LD_PRELOAD (or DLL injection on Windows) as long as the binary isn&#x27;t statically linked.<p>See other comments in the thread about libfaketime.</div><br/></div></div></div></div></div></div><div id="38705640" class="c"><input type="checkbox" id="c-38705640" checked=""/><div class="controls bullet"><span class="by">thrtythreeforty</span><span>|</span><a href="#38705192">prev</a><span>|</span><a href="#38706293">next</a><span>|</span><label class="collapse" for="c-38705640">[-]</label><label class="expand" for="c-38705640">[1 more]</label></div><br/><div class="children"><div class="content">I do not think Approach 2 is sound.  It proposes specialization of a template without needing to recompile the library source, implying that the specialization will be done only in a separate translation unit.<p>The standard §13.9.4 says:<p>&gt; If a template [...] is explicitly specialized, a declaration of that specialization shall be reachable from every use of that specialization that would cause an implicit instantiation to take place<p>What&#x27;s going to happen in practice is the compiler will instantiate and inline the unspecialized template in the library, and the program will silently not use the mock time. Or not, it&#x27;s entirely unconstrained.</div><br/></div></div><div id="38706293" class="c"><input type="checkbox" id="c-38706293" checked=""/><div class="controls bullet"><span class="by">zokier</span><span>|</span><a href="#38705640">prev</a><span>|</span><a href="#38706025">next</a><span>|</span><label class="collapse" for="c-38706293">[-]</label><label class="expand" for="c-38706293">[1 more]</label></div><br/><div class="children"><div class="content">While it would not be appropriate for unit testing, for more generally time related testing it annoys me greatly that while Linux has time namespaces, they only affect monotonic and boottime clocks, and not realtime clock. I understand that there are good reasons why that is the case, yet it is still something I&#x27;ve considered patching in myself</div><br/></div></div><div id="38706025" class="c"><input type="checkbox" id="c-38706025" checked=""/><div class="controls bullet"><span class="by">ianwong1999</span><span>|</span><a href="#38706293">prev</a><span>|</span><a href="#38704814">next</a><span>|</span><label class="collapse" for="c-38706025">[-]</label><label class="expand" for="c-38706025">[1 more]</label></div><br/><div class="children"><div class="content">The code example in approach 2 looks ill-formed though. If you change line 12 to auto to let compiler deduce the return type, you will see error message &quot;explicit specialization of &#x27;clock_impl&#x27; after instantiation&quot;.<p>ref: <a href="https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;36997351&#x2F;using-a-template-before-its-specialized" rel="nofollow noreferrer">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;36997351&#x2F;using-a-templat...</a><p>So not very sure how to elegantly inject our mock into the main code via the test section.</div><br/></div></div><div id="38704814" class="c"><input type="checkbox" id="c-38704814" checked=""/><div class="controls bullet"><span class="by">xmprt</span><span>|</span><a href="#38706025">prev</a><span>|</span><a href="#38704902">next</a><span>|</span><label class="collapse" for="c-38704814">[-]</label><label class="expand" for="c-38704814">[10 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a shame that the recommended solution is using a C++ trick of templates that doesn&#x27;t generalize well to other languages.</div><br/><div id="38704921" class="c"><input type="checkbox" id="c-38704921" checked=""/><div class="controls bullet"><span class="by">nostrademons</span><span>|</span><a href="#38704814">parent</a><span>|</span><a href="#38704845">next</a><span>|</span><label class="collapse" for="c-38704921">[-]</label><label class="expand" for="c-38704921">[1 more]</label></div><br/><div class="children"><div class="content">The issue doesn&#x27;t generalize across languages because they often have other mechanisms that are simpler.  In dynamic languages with modules like Javascript, Ruby, or Python, you can usually monkey-patch the system time methods to return what you want.  In Java and other JVM languages you&#x27;d use dependency injection and then inject a mock into the test.  Most other languages use some variant of Approach 1 or Approach 5.</div><br/></div></div><div id="38704845" class="c"><input type="checkbox" id="c-38704845" checked=""/><div class="controls bullet"><span class="by">jweir</span><span>|</span><a href="#38704814">parent</a><span>|</span><a href="#38704921">prev</a><span>|</span><a href="#38704917">next</a><span>|</span><label class="collapse" for="c-38704845">[-]</label><label class="expand" for="c-38704845">[6 more]</label></div><br/><div class="children"><div class="content">When possible pass the time as an argument and create pure functions or methods.<p>Reserve Time.now or its equavlent to jobs, controllers, or what not at the edge of your application.<p>Watch out when using NOW() in your db. Not that you shouldn’t but it might be surprising when you do.</div><br/><div id="38704952" class="c"><input type="checkbox" id="c-38704952" checked=""/><div class="controls bullet"><span class="by">zer00eyz</span><span>|</span><a href="#38704814">root</a><span>|</span><a href="#38704845">parent</a><span>|</span><a href="#38705240">next</a><span>|</span><label class="collapse" for="c-38704952">[-]</label><label class="expand" for="c-38704952">[4 more]</label></div><br/><div class="children"><div class="content">&gt;&gt; Watch out when using NOW() in your db.<p>Would you be so kind as to elaborate on this?<p>It was always my thought that NOW() was the more sensible approach as it would capture time in the execution order from a more centralized source (the db server).  Where having the origin of a transaction setting at time would get me when, on the origin server the query was initiated.</div><br/><div id="38705069" class="c"><input type="checkbox" id="c-38705069" checked=""/><div class="controls bullet"><span class="by">macintux</span><span>|</span><a href="#38704814">root</a><span>|</span><a href="#38704952">parent</a><span>|</span><a href="#38705219">next</a><span>|</span><label class="collapse" for="c-38705069">[-]</label><label class="expand" for="c-38705069">[2 more]</label></div><br/><div class="children"><div class="content">Not the person to whom you&#x27;re replying, but I suspect the problem isn&#x27;t that the database is using NOW(), but that your code being tested will be using an entirely different time.</div><br/><div id="38705248" class="c"><input type="checkbox" id="c-38705248" checked=""/><div class="controls bullet"><span class="by">jweir</span><span>|</span><a href="#38704814">root</a><span>|</span><a href="#38705069">parent</a><span>|</span><a href="#38705219">next</a><span>|</span><label class="collapse" for="c-38705248">[-]</label><label class="expand" for="c-38705248">[1 more]</label></div><br/><div class="children"><div class="content">Bingo.<p>There is nothing wrong with using NOW(), in of itself, and it maybe the best thing to do.<p>But it may lead to surprising results when say you have an application that has mocked out time for a specific time, but you get db results for the current time.  It introduces another clock into your system.<p>I have found most of the time we were using NOW() we could pass the time into the query and create a more understandable chain of code.</div><br/></div></div></div></div><div id="38705219" class="c"><input type="checkbox" id="c-38705219" checked=""/><div class="controls bullet"><span class="by">theamk</span><span>|</span><a href="#38704814">root</a><span>|</span><a href="#38704952">parent</a><span>|</span><a href="#38705069">prev</a><span>|</span><a href="#38705240">next</a><span>|</span><label class="collapse" for="c-38705219">[-]</label><label class="expand" for="c-38705219">[1 more]</label></div><br/><div class="children"><div class="content">You mostly want to be consistent. For example if you do a job scheduler which uses NOW() to create job, but a local clock to execute them, then any clock difference between machines will be causing hard-to-debug problems.</div><br/></div></div></div></div><div id="38705240" class="c"><input type="checkbox" id="c-38705240" checked=""/><div class="controls bullet"><span class="by">omeid2</span><span>|</span><a href="#38704814">root</a><span>|</span><a href="#38704845">parent</a><span>|</span><a href="#38704952">prev</a><span>|</span><a href="#38704917">next</a><span>|</span><label class="collapse" for="c-38705240">[-]</label><label class="expand" for="c-38705240">[1 more]</label></div><br/><div class="children"><div class="content">If you can&#x27;t test your code because you use `NOW()` or another form of automatic timestamping in your records, it is on your language or framework. You shouldn&#x27;t forgo such niceties for limitations imposed by your framework or language, demand better.</div><br/></div></div></div></div><div id="38704917" class="c"><input type="checkbox" id="c-38704917" checked=""/><div class="controls bullet"><span class="by">whynotmaybe</span><span>|</span><a href="#38704814">parent</a><span>|</span><a href="#38704845">prev</a><span>|</span><a href="#38704844">next</a><span>|</span><label class="collapse" for="c-38704917">[-]</label><label class="expand" for="c-38704917">[1 more]</label></div><br/><div class="children"><div class="content">We use a &quot;service&quot; class with an internal timer that returns &quot;.now()&quot; and that implements an interface. 
The .ctor initialize the service&#x27;s date with Datetime.now().<p>We use dependency injection wherever the service is required.<p>With this, we can manage 2 things<p>1. The service can go faster or slower than the real time by changing the timer&#x27;s interval so we can simulate time depend behaviour in the app while testing.<p>2. We can mock the service when testing with a simple counter that&#x27;s increased each time “.now()&quot; is called.</div><br/></div></div><div id="38704844" class="c"><input type="checkbox" id="c-38704844" checked=""/><div class="controls bullet"><span class="by">keithnz</span><span>|</span><a href="#38704814">parent</a><span>|</span><a href="#38704917">prev</a><span>|</span><a href="#38704902">next</a><span>|</span><label class="collapse" for="c-38704844">[-]</label><label class="expand" for="c-38704844">[1 more]</label></div><br/><div class="children"><div class="content">well, in the latest .NET 8, for any of the .NET languages there is<p><a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;dotnet&#x2F;core&#x2F;whats-new&#x2F;dotnet-8#time-abstraction" rel="nofollow noreferrer">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;dotnet&#x2F;core&#x2F;whats-new&#x2F;dotn...</a><p>Though most people were rolling their own version of it before this.</div><br/></div></div></div></div><div id="38704902" class="c"><input type="checkbox" id="c-38704902" checked=""/><div class="controls bullet"><span class="by">ForkMeOnTinder</span><span>|</span><a href="#38704814">prev</a><span>|</span><a href="#38704838">next</a><span>|</span><label class="collapse" for="c-38704902">[-]</label><label class="expand" for="c-38704902">[5 more]</label></div><br/><div class="children"><div class="content">The easiest way to do this (in my experience) is libfaketime.  I&#x27;m surprised not to see it mentioned.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;wolfcw&#x2F;libfaketime">https:&#x2F;&#x2F;github.com&#x2F;wolfcw&#x2F;libfaketime</a></div><br/><div id="38704929" class="c"><input type="checkbox" id="c-38704929" checked=""/><div class="controls bullet"><span class="by">irrational</span><span>|</span><a href="#38704902">parent</a><span>|</span><a href="#38705180">next</a><span>|</span><label class="collapse" for="c-38704929">[-]</label><label class="expand" for="c-38704929">[1 more]</label></div><br/><div class="children"><div class="content">Why the surprise? There is too much to know for anyone to know everything.</div><br/></div></div><div id="38705180" class="c"><input type="checkbox" id="c-38705180" checked=""/><div class="controls bullet"><span class="by">theamk</span><span>|</span><a href="#38704902">parent</a><span>|</span><a href="#38704929">prev</a><span>|</span><a href="#38704838">next</a><span>|</span><label class="collapse" for="c-38705180">[-]</label><label class="expand" for="c-38705180">[3 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think it&#x27;s that easy for the typical unit test though?<p>Most of the time usage need to advance time in controlled fashion. So you&#x27;ll need to create a shell wrapper that runs faketime with correct FAKETIME_TIMESTAMP_FILE value, hook it up to your build system, create C++ wrapper to write to this file... If you are controlling source code, adding a &quot;time&quot; argument might be easier to implement and easier to understand.</div><br/><div id="38706077" class="c"><input type="checkbox" id="c-38706077" checked=""/><div class="controls bullet"><span class="by">deivid</span><span>|</span><a href="#38704902">root</a><span>|</span><a href="#38705180">parent</a><span>|</span><a href="#38706535">next</a><span>|</span><label class="collapse" for="c-38706077">[-]</label><label class="expand" for="c-38706077">[1 more]</label></div><br/><div class="children"><div class="content">libfaketime&#x27;s awkward interface (control via timestamp files, needing LD_PRELOAD) is why I wrote an experimental library[0] which takes over the clock at the process level.<p>My library modifies the code for the time-related vDSO functions, which is incredibly sketchy yet effective. There are also Python bindings at [1].<p>[0]: <a href="https:&#x2F;&#x2F;github.com&#x2F;DavidVentura&#x2F;tpom">https:&#x2F;&#x2F;github.com&#x2F;DavidVentura&#x2F;tpom</a><p>[1]: <a href="https:&#x2F;&#x2F;github.com&#x2F;DavidVentura&#x2F;py-tpom">https:&#x2F;&#x2F;github.com&#x2F;DavidVentura&#x2F;py-tpom</a></div><br/></div></div><div id="38706535" class="c"><input type="checkbox" id="c-38706535" checked=""/><div class="controls bullet"><span class="by">Brybry</span><span>|</span><a href="#38704902">root</a><span>|</span><a href="#38705180">parent</a><span>|</span><a href="#38706077">prev</a><span>|</span><a href="#38704838">next</a><span>|</span><label class="collapse" for="c-38706535">[-]</label><label class="expand" for="c-38706535">[1 more]</label></div><br/><div class="children"><div class="content">Wouldn&#x27;t the FAKETIME environment variables be easy for typical unit testing?</div><br/></div></div></div></div></div></div><div id="38704838" class="c"><input type="checkbox" id="c-38704838" checked=""/><div class="controls bullet"><span class="by">squidsoup</span><span>|</span><a href="#38704902">prev</a><span>|</span><a href="#38706031">next</a><span>|</span><label class="collapse" for="c-38704838">[-]</label><label class="expand" for="c-38704838">[1 more]</label></div><br/><div class="children"><div class="content">This made me realise, that despite the many complaints I have about jest and the node ecosystem generally, we’re actually very lucky that it has so many convenient affordances like modern timers.</div><br/></div></div><div id="38706031" class="c"><input type="checkbox" id="c-38706031" checked=""/><div class="controls bullet"><span class="by">abaymado</span><span>|</span><a href="#38704838">prev</a><span>|</span><a href="#38705031">next</a><span>|</span><label class="collapse" for="c-38706031">[-]</label><label class="expand" for="c-38706031">[1 more]</label></div><br/><div class="children"><div class="content">Usually, when I come across an article like this, I tend to glance at it and skip it, since I don&#x27;t know C++. However, kudos to OpenAI; ChatCGPT shines in moments like this. The core knowledge of the article would have been bounded to C++ but, now you can just translate the article code with what you are comfortable with.</div><br/></div></div><div id="38705031" class="c"><input type="checkbox" id="c-38705031" checked=""/><div class="controls bullet"><span class="by">p1necone</span><span>|</span><a href="#38706031">prev</a><span>|</span><a href="#38706467">next</a><span>|</span><label class="collapse" for="c-38705031">[-]</label><label class="expand" for="c-38705031">[2 more]</label></div><br/><div class="children"><div class="content">Jest has pretty robust time mocking, it&#x27;s a breeze to do time related testing if you&#x27;re writing JS&#x2F;TS: <a href="https:&#x2F;&#x2F;jestjs.io&#x2F;docs&#x2F;jest-object#fake-timers" rel="nofollow noreferrer">https:&#x2F;&#x2F;jestjs.io&#x2F;docs&#x2F;jest-object#fake-timers</a></div><br/><div id="38705089" class="c"><input type="checkbox" id="c-38705089" checked=""/><div class="controls bullet"><span class="by">theamk</span><span>|</span><a href="#38705031">parent</a><span>|</span><a href="#38706467">next</a><span>|</span><label class="collapse" for="c-38705089">[-]</label><label class="expand" for="c-38705089">[1 more]</label></div><br/><div class="children"><div class="content">this blogpost is specific for C++ -- in most dynamic languages like Python or JS, the default approach is to redefine time functions from standard libraries.<p>This would correspond to option 3 in the blog post, except instead of clock factory you redefine individual methods.</div><br/></div></div></div></div><div id="38706467" class="c"><input type="checkbox" id="c-38706467" checked=""/><div class="controls bullet"><span class="by">bsder</span><span>|</span><a href="#38705031">prev</a><span>|</span><a href="#38705553">next</a><span>|</span><label class="collapse" for="c-38706467">[-]</label><label class="expand" for="c-38706467">[1 more]</label></div><br/><div class="children"><div class="content">Time is state.  State is passed in at the boundaries.  End of story.<p>Anything which relies on time coming in as an implicit variable as internal state is doomed to have legions of undebuggable problems.</div><br/></div></div><div id="38705553" class="c"><input type="checkbox" id="c-38705553" checked=""/><div class="controls bullet"><span class="by">mx_03</span><span>|</span><a href="#38706467">prev</a><span>|</span><a href="#38705653">next</a><span>|</span><label class="collapse" for="c-38705553">[-]</label><label class="expand" for="c-38705553">[4 more]</label></div><br/><div class="children"><div class="content">&gt;This is better. Now the only code that differs between a unit test build and a production build is what clock_factory::get_clock() returns.<p>So you are effectively testing code that will never see the light in Production. That&#x27;s called a Mock and some people hate mocks.<p>I have no problem against it taking for granted the actual lib has its own tests.</div><br/><div id="38706003" class="c"><input type="checkbox" id="c-38706003" checked=""/><div class="controls bullet"><span class="by">eitland</span><span>|</span><a href="#38705553">parent</a><span>|</span><a href="#38705653">next</a><span>|</span><label class="collapse" for="c-38706003">[-]</label><label class="expand" for="c-38706003">[3 more]</label></div><br/><div class="children"><div class="content">&gt; That&#x27;s called a Mock and some people hate mocks.<p>Don&#x27;t worry to much about them.<p>Mocks are perfectly OK.<p>It is like putting a mechanical device in a jig for a durability test or the exhaust extractors that mechanics use when they run engines inside the workshop.</div><br/><div id="38706231" class="c"><input type="checkbox" id="c-38706231" checked=""/><div class="controls bullet"><span class="by">bluGill</span><span>|</span><a href="#38705553">root</a><span>|</span><a href="#38706003">parent</a><span>|</span><a href="#38705653">next</a><span>|</span><label class="collapse" for="c-38706231">[-]</label><label class="expand" for="c-38706231">[2 more]</label></div><br/><div class="children"><div class="content">Mocks are okay, if they are used correctly. Often I see them over constraining code and then you cannot change it. If the code will not change delete the tests at they will never fail.</div><br/><div id="38706266" class="c"><input type="checkbox" id="c-38706266" checked=""/><div class="controls bullet"><span class="by">eitland</span><span>|</span><a href="#38705553">root</a><span>|</span><a href="#38706231">parent</a><span>|</span><a href="#38705653">next</a><span>|</span><label class="collapse" for="c-38706266">[-]</label><label class="expand" for="c-38706266">[1 more]</label></div><br/><div class="children"><div class="content">&gt; If the code will not change delete the tests at they will never fail.<p>Or, unless they are expensive, just keep them. The code doesn&#x27;t change so they won&#x27;t break.<p>But for the next maintainer they will tell them a lot. One particularly nice thing about some code I maintained recently was that it allowed me to run through different scenarios in my debugger even during my first days in that code base.<p>Also I don&#x27;t think I will ever again assume that some code that is in production will never change.</div><br/></div></div></div></div></div></div></div></div><div id="38705778" class="c"><input type="checkbox" id="c-38705778" checked=""/><div class="controls bullet"><span class="by">zubairq</span><span>|</span><a href="#38705653">prev</a><span>|</span><a href="#38705164">next</a><span>|</span><label class="collapse" for="c-38705778">[-]</label><label class="expand" for="c-38705778">[1 more]</label></div><br/><div class="children"><div class="content">Some useful tips I can use, thanks</div><br/></div></div><div id="38705164" class="c"><input type="checkbox" id="c-38705164" checked=""/><div class="controls bullet"><span class="by">jackblemming</span><span>|</span><a href="#38705778">prev</a><span>|</span><a href="#38704930">next</a><span>|</span><label class="collapse" for="c-38705164">[-]</label><label class="expand" for="c-38705164">[2 more]</label></div><br/><div class="children"><div class="content">Don’t do something silly like take a parameter called current_time. Instead, name it what it’s actually used for or doing. This could be send_emails_on or the like. Parameters should tell the reader what not why.</div><br/><div id="38706411" class="c"><input type="checkbox" id="c-38706411" checked=""/><div class="controls bullet"><span class="by">Sankozi</span><span>|</span><a href="#38705164">parent</a><span>|</span><a href="#38704930">next</a><span>|</span><label class="collapse" for="c-38706411">[-]</label><label class="expand" for="c-38706411">[1 more]</label></div><br/><div class="children"><div class="content">`send_emails_on` suggests strongly some scheduling capability. `current_time` says exactly what it is needed for.</div><br/></div></div></div></div></div></div></div></div></div></body></html>