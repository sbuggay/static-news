<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718010073828" as="style"/><link rel="stylesheet" href="styles.css?v=1718010073828"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://fobes.dev/general/2024/02/29/inline-assembly-dangers.html">Inline Assembly Dangers</a> <span class="domain">(<a href="https://fobes.dev">fobes.dev</a>)</span></div><div class="subtext"><span>fobes</span> | <span>19 comments</span></div><br/><div><div id="40630296" class="c"><input type="checkbox" id="c-40630296" checked=""/><div class="controls bullet"><span class="by">corysama</span><span>|</span><a href="#40631452">next</a><span>|</span><label class="collapse" for="c-40630296">[-]</label><label class="expand" for="c-40630296">[2 more]</label></div><br/><div class="children"><div class="content">One of my favorite bugs was due to inline assembly!<p>I once wrote a function that would crash only if you passed it the immediate value 4. Like `foo(4);` A variable containing 4 would not crash.<p>The function was calling the Intel assembly instruction to byte-swap an integer. These days there’s an intrinsic for that. But, this was long ago and was written for platforms that didn’t even support POSIX.<p>So, this function was serializing an integer to memory, byteswapping it in the process, and naturally advancing the destination pointer as well.<p>The bug was that I forgot to mark the input register as dirty when I set up the inline assembly.<p>An important thing to know about inline asm, and the reason it is so strongly discouraged these days, is that the compiler cannot see it. It’s a black box for the compiler with a limited set of manual hints — one of which I omitted. Therefore it really mucks up the compiler’s ability to pipeline instructions. And, that cancels out the performance benefits for short snippets of assembly.<p>Anyway… I didn’t mark the register as dirty. Therefore, the compiler was unaware that it had been modified.<p>So, if I called the function with a 4, it would run some black box inline assembly, write the value to memory, and then it needed to increment a pointer by the size of one integer. 4 bytes. How convenient! The compiler just saw that at compile time there was definitely a 4 in a certain register! And, the inline asm declaration didn’t declare that anything happened to that register, such as byteswapping it. So, let’s just use that “unmodified” register as a value to add to the pointer!<p>Advancing a pointer by a byteswapped 4 makes for a quite invalid pointer. And, technically it was the next call to the serialized that would crash when it tried to write another value to that pointer.</div><br/><div id="40631285" class="c"><input type="checkbox" id="c-40631285" checked=""/><div class="controls bullet"><span class="by">PhilipRoman</span><span>|</span><a href="#40630296">parent</a><span>|</span><a href="#40631452">next</a><span>|</span><label class="collapse" for="c-40631285">[-]</label><label class="expand" for="c-40631285">[1 more]</label></div><br/><div class="children"><div class="content">Sounds like this could be a nice extension to clang&#x2F;gcc sanitizers, adding checks that certain registers are unmodified across inline assembly calls.</div><br/></div></div></div></div><div id="40631452" class="c"><input type="checkbox" id="c-40631452" checked=""/><div class="controls bullet"><span class="by">flumpcakes</span><span>|</span><a href="#40630296">prev</a><span>|</span><a href="#40630612">next</a><span>|</span><label class="collapse" for="c-40631452">[-]</label><label class="expand" for="c-40631452">[1 more]</label></div><br/><div class="children"><div class="content">The real problem with inline assembly is that you really are flying blind and have to be an experienced enough to know what you&#x27;re doing. The compiler can&#x27;t help you much at all due to losing all type information.<p>Saying that, I think it&#x27;s a skill that we need to foster, at least for a few niches.</div><br/></div></div><div id="40630612" class="c"><input type="checkbox" id="c-40630612" checked=""/><div class="controls bullet"><span class="by">Grom_PE</span><span>|</span><a href="#40631452">prev</a><span>|</span><a href="#40630639">next</a><span>|</span><label class="collapse" for="c-40630612">[-]</label><label class="expand" for="c-40630612">[3 more]</label></div><br/><div class="children"><div class="content">Inline assembly was very pleasant to write in Turbo Pascal and Delphi.<p>In D language it looks okay too.<p>In GCC, inline assembly has insane syntax. Probably on purpose, to discourage writing it.</div><br/><div id="40631278" class="c"><input type="checkbox" id="c-40631278" checked=""/><div class="controls bullet"><span class="by">sim7c00</span><span>|</span><a href="#40630612">parent</a><span>|</span><a href="#40630651">next</a><span>|</span><label class="collapse" for="c-40631278">[-]</label><label class="expand" for="c-40631278">[1 more]</label></div><br/><div class="children"><div class="content">its not too bad syntax really.<p>asm(&#x27;asm code&#x27; : &#x27;outputs&#x27; : &#x27;inputs&#x27;)<p>you can even use labels in it etc. for in&#x2F;ouputs so it&#x27;s &#x27;easily readable&#x27;.<p>People just write it really lazy, don&#x27;t use proper formatting &#x2F; whitespace which makes it really difficult to read _other_peoples_inline_assembly.<p>I&#x27;d wager if you write it nicely with comments etc. it&#x27;s quite alright. with some macros it might be more beautiful but imho those are harder&#x2F;more annoying to interpret.<p><a href="https:&#x2F;&#x2F;pastebin.com&#x2F;S0x9hKJP" rel="nofollow">https:&#x2F;&#x2F;pastebin.com&#x2F;S0x9hKJP</a> &lt;-- this isn&#x27;t too bad is it? ignore that it has bugs xD</div><br/></div></div><div id="40630651" class="c"><input type="checkbox" id="c-40630651" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#40630612">parent</a><span>|</span><a href="#40631278">prev</a><span>|</span><a href="#40630639">next</a><span>|</span><label class="collapse" for="c-40630651">[-]</label><label class="expand" for="c-40630651">[1 more]</label></div><br/><div class="children"><div class="content">I never got the point of that weird syntax, I would rather reach out to a raw Assembly instead of dealing with such syntax.<p>To add to your list, most C and C++ compilers on the PC world as well.<p>Certain folks will mention it is because the compiler needs register usage info, yet PC compilers could and can, infer the usage as well, when parsing those asm blocks, or how intrisics are used (as alternative).</div><br/></div></div></div></div><div id="40630639" class="c"><input type="checkbox" id="c-40630639" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#40630612">prev</a><span>|</span><a href="#40630041">next</a><span>|</span><label class="collapse" for="c-40630639">[-]</label><label class="expand" for="c-40630639">[5 more]</label></div><br/><div class="children"><div class="content">And this is why inline Assembly done by GCC and clang sucks, and the inline Assembly done by most PC compilers, with first level support for opcodes, or instrisics is a great experience.</div><br/><div id="40630858" class="c"><input type="checkbox" id="c-40630858" checked=""/><div class="controls bullet"><span class="by">SassyBird</span><span>|</span><a href="#40630639">parent</a><span>|</span><a href="#40630041">next</a><span>|</span><label class="collapse" for="c-40630858">[-]</label><label class="expand" for="c-40630858">[4 more]</label></div><br/><div class="children"><div class="content">It seems that MSVC supports inline assembly only on 32-bit x86. For amd64 and ARM they moved entirely to intrinsics.</div><br/><div id="40630958" class="c"><input type="checkbox" id="c-40630958" checked=""/><div class="controls bullet"><span class="by">vnorilo</span><span>|</span><a href="#40630639">root</a><span>|</span><a href="#40630858">parent</a><span>|</span><a href="#40631201">next</a><span>|</span><label class="collapse" for="c-40630958">[-]</label><label class="expand" for="c-40630958">[2 more]</label></div><br/><div class="children"><div class="content">The more I&#x27;ve written code close to metal (mostly SIMD for signal processing), the more I&#x27;ve grown to prefer either intrinsics or separate translation unit for assembly.<p>If you want your code to intertwine with what the C compiler does, intrinsics are great.<p>If you don&#x27;t, .s is great.</div><br/><div id="40631197" class="c"><input type="checkbox" id="c-40631197" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#40630639">root</a><span>|</span><a href="#40630958">parent</a><span>|</span><a href="#40631201">next</a><span>|</span><label class="collapse" for="c-40631197">[-]</label><label class="expand" for="c-40631197">[1 more]</label></div><br/><div class="children"><div class="content">Exactly, this is the right approach.</div><br/></div></div></div></div><div id="40631201" class="c"><input type="checkbox" id="c-40631201" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#40630639">root</a><span>|</span><a href="#40630858">parent</a><span>|</span><a href="#40630958">prev</a><span>|</span><a href="#40630041">next</a><span>|</span><label class="collapse" for="c-40631201">[-]</label><label class="expand" for="c-40631201">[1 more]</label></div><br/><div class="children"><div class="content">Yes, Assembly programming concatenanting strings, is horrible.<p>Intrisics give the best of both worlds, without dealing with string based content.<p>Actually ESPOL&#x2F;NEWP from 1961 was one of the very first system programming languages with two key inovations, intrisics and unsafe code blocks.</div><br/></div></div></div></div></div></div><div id="40630041" class="c"><input type="checkbox" id="c-40630041" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#40630639">prev</a><span>|</span><a href="#40630068">next</a><span>|</span><label class="collapse" for="c-40630041">[-]</label><label class="expand" for="c-40630041">[2 more]</label></div><br/><div class="children"><div class="content">It always feels really tricky imo. Intrinsics are preferable if the functionality you need is at all possible with those.  But I&#x27;d be surprised if you could easily clear the BSS with those.<p>And who can remember what early clobbers is?  I always forget and have to look it up because it feels especially subtle.<p>It&#x27;d be neat if inline asm could use something like the triple quotes in other languages.  Maybe it&#x27;d be easier to format text like this.</div><br/><div id="40630707" class="c"><input type="checkbox" id="c-40630707" checked=""/><div class="controls bullet"><span class="by">saurik</span><span>|</span><a href="#40630041">parent</a><span>|</span><a href="#40630068">next</a><span>|</span><label class="collapse" for="c-40630707">[-]</label><label class="expand" for="c-40630707">[1 more]</label></div><br/><div class="children"><div class="content">In C++11 you can use R&quot;( raw&#x2F;multi-line strings for inline assembly.</div><br/></div></div></div></div><div id="40630068" class="c"><input type="checkbox" id="c-40630068" checked=""/><div class="controls bullet"><span class="by">nynx</span><span>|</span><a href="#40630041">prev</a><span>|</span><a href="#40630180">next</a><span>|</span><label class="collapse" for="c-40630068">[-]</label><label class="expand" for="c-40630068">[3 more]</label></div><br/><div class="children"><div class="content">Uh, why is this not a compile error? I’d expect the string to be concatonated, which would result in an invalid program.</div><br/><div id="40630089" class="c"><input type="checkbox" id="c-40630089" checked=""/><div class="controls bullet"><span class="by">dkersten</span><span>|</span><a href="#40630068">parent</a><span>|</span><a href="#40630080">next</a><span>|</span><label class="collapse" for="c-40630089">[-]</label><label class="expand" for="c-40630089">[1 more]</label></div><br/><div class="children"><div class="content">The strings are concatenated, it’s just that the first line was a comment, meaning the compiler&#x2F;assembler saw all the next lines as part of the first. Comments don’t cause compiler errors, so no error here…</div><br/></div></div><div id="40630080" class="c"><input type="checkbox" id="c-40630080" checked=""/><div class="controls bullet"><span class="by">LegionMammal978</span><span>|</span><a href="#40630068">parent</a><span>|</span><a href="#40630089">prev</a><span>|</span><a href="#40630180">next</a><span>|</span><label class="collapse" for="c-40630080">[-]</label><label class="expand" for="c-40630080">[1 more]</label></div><br/><div class="children"><div class="content">The first string is a comment, so all the strings after it just get appended to the comment text, until it finally hits the first newline. Quite an insidious mistake.</div><br/></div></div></div></div><div id="40630180" class="c"><input type="checkbox" id="c-40630180" checked=""/><div class="controls bullet"><span class="by">jijji</span><span>|</span><a href="#40630068">prev</a><span>|</span><label class="collapse" for="c-40630180">[-]</label><label class="expand" for="c-40630180">[2 more]</label></div><br/><div class="children"><div class="content">why not just use the standard library functions, instead of these esoteric __*() functions, which although they may exist are probably not the right ones to be using.... it looks like you&#x27;re trying to set the time zone and there&#x27;s methods to do that, which is not the one you&#x27;re referencing in your code...</div><br/><div id="40630614" class="c"><input type="checkbox" id="c-40630614" checked=""/><div class="controls bullet"><span class="by">exmadscientist</span><span>|</span><a href="#40630180">parent</a><span>|</span><label class="collapse" for="c-40630614">[-]</label><label class="expand" for="c-40630614">[1 more]</label></div><br/><div class="children"><div class="content">The standard library functions have to be provided by someone. In bare metal&#x2F;deep embedded work, that someone is YOU.<p>So anything is possible. Anything. Though if you&#x27;re unlucky enough to have untrustworthy hardware, or just not-yet-trustworthy hardware, that&#x27;s usually enough to keep the nasal demons at bay (even they fear malfunctioning hardware), which is one small mercy.</div><br/></div></div></div></div></div></div></div></div></div></body></html>