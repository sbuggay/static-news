<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718010073828" as="style"/><link rel="stylesheet" href="styles.css?v=1718010073828"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://abstractexpr.com/2024/06/08/finding-out-where-syscalls-are-called-from-stack-traces-with-strace/">Finding out where syscalls are called from: Stack traces with strace</a>Â <span class="domain">(<a href="https://abstractexpr.com">abstractexpr.com</a>)</span></div><div class="subtext"><span>aheck</span> | <span>11 comments</span></div><br/><div><div id="40629706" class="c"><input type="checkbox" id="c-40629706" checked=""/><div class="controls bullet"><span class="by">tanelpoder</span><span>|</span><a href="#40630751">next</a><span>|</span><label class="collapse" for="c-40629706">[-]</label><label class="expand" for="c-40629706">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s also strace -kk (--stack-trace=source), but when I just ran it on Ubuntu 24.04, got this error:<p><pre><code>  $ strace -kk pwd
  strace: Stack traces with source line information (-kk&#x2F;--stack-trace=source option) are not supported by this build of strace
</code></pre>
Also, there&#x27;s &quot;perf trace&quot; that has now gotten pretty good reporting the system call arguments and context (in older versions it didn&#x27;t report enough details of the system call arguments &amp; their contents).<p>As strace uses userspace ptrace(), it slows down the traced processes and may even cause failures due to mucking around with signalling, perf trace doesn&#x27;t have that problem as it uses kernel tracepoints.</div><br/></div></div><div id="40630751" class="c"><input type="checkbox" id="c-40630751" checked=""/><div class="controls bullet"><span class="by">hawski</span><span>|</span><a href="#40629706">prev</a><span>|</span><a href="#40627697">next</a><span>|</span><label class="collapse" for="c-40630751">[-]</label><label class="expand" for="c-40630751">[2 more]</label></div><br/><div class="children"><div class="content">I feel stupid, because I didn&#x27;t know strace can do this, I did it once with a gdb script:<p><a href="https:&#x2F;&#x2F;gist.github.com&#x2F;hadrianw&#x2F;5b8d33a4b353c49e7dbd6eb55f817901" rel="nofollow">https:&#x2F;&#x2F;gist.github.com&#x2F;hadrianw&#x2F;5b8d33a4b353c49e7dbd6eb55f8...</a><p>My learning: RTFM.</div><br/><div id="40631398" class="c"><input type="checkbox" id="c-40631398" checked=""/><div class="controls bullet"><span class="by">tanelpoder</span><span>|</span><a href="#40630751">parent</a><span>|</span><a href="#40627697">next</a><span>|</span><label class="collapse" for="c-40631398">[-]</label><label class="expand" for="c-40631398">[1 more]</label></div><br/><div class="children"><div class="content">Older versions of strace (like in RHEL 7) did not have such an option.</div><br/></div></div></div></div><div id="40627697" class="c"><input type="checkbox" id="c-40627697" checked=""/><div class="controls bullet"><span class="by">mshockwave</span><span>|</span><a href="#40630751">prev</a><span>|</span><a href="#40628258">next</a><span>|</span><label class="collapse" for="c-40627697">[-]</label><label class="expand" for="c-40627697">[1 more]</label></div><br/><div class="children"><div class="content">Today I definitely learned! I feel like we can just patch strace to read debug info (and use it in stack trace) when present.</div><br/></div></div><div id="40628258" class="c"><input type="checkbox" id="c-40628258" checked=""/><div class="controls bullet"><span class="by">fjfaase</span><span>|</span><a href="#40627697">prev</a><span>|</span><a href="#40628331">next</a><span>|</span><label class="collapse" for="c-40628258">[-]</label><label class="expand" for="c-40628258">[2 more]</label></div><br/><div class="children"><div class="content">strace is a rather powerfull tool if you want to find out what a certain executable is doing. Which files it is opening, reading and writing and also which other executables it is executing. I personally have not used the &#x27;--stack-trace&#x27; option yet.<p>Earlier this year, I have used it to analyze what happens during the initial steps of live-bootstrap [1] and produce a web page with all the information [2]. For this, I wrote a C program to parse and process the output of strace.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;fosslinux&#x2F;live-bootstrap">https:&#x2F;&#x2F;github.com&#x2F;fosslinux&#x2F;live-bootstrap</a><p>[2] <a href="https:&#x2F;&#x2F;fransfaase.github.io&#x2F;Emulator&#x2F;" rel="nofollow">https:&#x2F;&#x2F;fransfaase.github.io&#x2F;Emulator&#x2F;</a></div><br/><div id="40630338" class="c"><input type="checkbox" id="c-40630338" checked=""/><div class="controls bullet"><span class="by">ranger_danger</span><span>|</span><a href="#40628258">parent</a><span>|</span><a href="#40628331">next</a><span>|</span><label class="collapse" for="c-40630338">[-]</label><label class="expand" for="c-40630338">[1 more]</label></div><br/><div class="children"><div class="content">And if you want to do the same thing on a whole-system level, bpftrace is invaluable. With tools like opensnoop&#x2F;execsnoop&#x2F;etc. you can see all the files and processes being run and by what. There are network-level similar bpf tools also.</div><br/></div></div></div></div><div id="40628331" class="c"><input type="checkbox" id="c-40628331" checked=""/><div class="controls bullet"><span class="by">spcharc</span><span>|</span><a href="#40628258">prev</a><span>|</span><a href="#40619665">next</a><span>|</span><label class="collapse" for="c-40628331">[-]</label><label class="expand" for="c-40628331">[2 more]</label></div><br/><div class="children"><div class="content">It can be useful I think.<p>Trying this on my toy project. This is a single thread program so it cannot do syscall from multiple cores.<p>It is not very helpful without debug info:<p><pre><code>  nanosleep({tv_sec=1, tv_nsec=299127292}, NULL) = 0
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out() [0x80f1]
  write(1, &quot;g1() ===== end =====\n&quot;, 21g1() ===== end =====
  )  = 21
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out() [0x80f1]
  munmap(0x7a267b491000, 66580)           = 0
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out() [0x80ec]
  exit(0)                                 = ?
  +++ exited with 0 +++
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(+0x0) [0x80e7]
</code></pre>
With debug info added, the output looks much better:<p><pre><code>  nanosleep({tv_sec=1, tv_nsec=297422159}, NULL) = 0
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0x14a) [0x87a8]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(fd_manager::wait_event(timespec const*, timespec&amp;, epoll_event*, unsigned int)+0xbe) [0x5598]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(event_loop::execute_tasks()+0x56) [0x6a10]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(event_loop::main_loop()+0x5b) [0x6b19]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(main+0x184) [0x77c6]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0xc0) [0x871e]
  write(1, &quot;g1() ===== end =====\n&quot;, 21g1() ===== end =====
  )  = 21
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0x14f) [0x87ad]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(static_file_buffered_printer&lt;1u, 1012u&gt;::flush()+0x75) [0x5071]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(output_stream&lt;static_file_buffered_printer&lt;1u, 1012u&gt; &gt;::operator&lt;&lt;(Manip)+0x74) [0x3624]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(g1(event_loop*, uptr_t)+0x14c) [0x74bc]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0x12d) [0x878b]
  munmap(0x7b80db5fd000, 66580)           = 0
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0x14a) [0x87a8]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(main+0x1bd) [0x77ff]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0xc0) [0x871e]
  exit(0)                                 = ?
  +++ exited with 0 +++
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0x145) [0x87a3]
   &gt; &#x2F;home&#x2F;spcharc&#x2F;proj&#x2F;out(assert(bool, char const*)+0xc8) [0x8726]
</code></pre>
Interesting that every syscall is from assert(). My assert() is basically &quot;if (!cond) {print(msg); exit(1);}&quot;.<p>I guess it traced to some unrecognized area and stopped there.</div><br/><div id="40631407" class="c"><input type="checkbox" id="c-40631407" checked=""/><div class="controls bullet"><span class="by">rcxdude</span><span>|</span><a href="#40628331">parent</a><span>|</span><a href="#40619665">next</a><span>|</span><label class="collapse" for="c-40631407">[-]</label><label class="expand" for="c-40631407">[1 more]</label></div><br/><div class="children"><div class="content">Does your main have an assert(false) after the main loop? If so the return address could be set to the assert function as some kind of optimization.</div><br/></div></div></div></div><div id="40619665" class="c"><input type="checkbox" id="c-40619665" checked=""/><div class="controls bullet"><span class="by">aheck</span><span>|</span><a href="#40628331">prev</a><span>|</span><label class="collapse" for="c-40619665">[-]</label><label class="expand" for="c-40619665">[2 more]</label></div><br/><div class="children"><div class="content">One of the great strengths of strace as a debugging tool is that it shows you what a program is doing regardless of whether it was compiled with debug info or not. The downside of this is that you only see the programâs syscall. You can use this information to deduce what is happening in the program but you donât see from where in the program those syscalls originate...</div><br/><div id="40628091" class="c"><input type="checkbox" id="c-40628091" checked=""/><div class="controls bullet"><span class="by">thundergolfer</span><span>|</span><a href="#40619665">parent</a><span>|</span><label class="collapse" for="c-40628091">[-]</label><label class="expand" for="c-40628091">[1 more]</label></div><br/><div class="children"><div class="content">Why did you just quote the start of the article?</div><br/></div></div></div></div></div></div></div></div></div></body></html>