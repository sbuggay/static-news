<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1706605256471" as="style"/><link rel="stylesheet" href="styles.css?v=1706605256471"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://gms.tf/on-the-costs-of-syscalls.html">On the Costs of Syscalls (2021)</a> <span class="domain">(<a href="https://gms.tf">gms.tf</a>)</span></div><div class="subtext"><span>K0nserv</span> | <span>23 comments</span></div><br/><div><div id="39186938" class="c"><input type="checkbox" id="c-39186938" checked=""/><div class="controls bullet"><span class="by">flakes</span><span>|</span><a href="#39187328">next</a><span>|</span><label class="collapse" for="c-39186938">[-]</label><label class="expand" for="c-39186938">[1 more]</label></div><br/><div class="children"><div class="content">The best part of this thread was the link to the discussion on the removal of pid caching in `getpid` causing regressions in systemd <a href="https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1469670" rel="nofollow">https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1469670</a><p>I&#x27;ve been on a code-deleting rampage lately, killing off many minor features that add a lot of complexity for seemingly little gain. Glad I don&#x27;t have anyone interrogating me like this!</div><br/></div></div><div id="39187328" class="c"><input type="checkbox" id="c-39187328" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#39186938">prev</a><span>|</span><a href="#39186748">next</a><span>|</span><label class="collapse" for="c-39187328">[-]</label><label class="expand" for="c-39187328">[1 more]</label></div><br/><div class="children"><div class="content">While interesting to read, the title should be &quot;On the Costs of <i>Linux</i> Syscalls&quot;</div><br/></div></div><div id="39186748" class="c"><input type="checkbox" id="c-39186748" checked=""/><div class="controls bullet"><span class="by">snvzz</span><span>|</span><a href="#39187328">prev</a><span>|</span><a href="#39186495">next</a><span>|</span><label class="collapse" for="c-39186748">[-]</label><label class="expand" for="c-39186748">[1 more]</label></div><br/><div class="children"><div class="content">There are also RTOS-capable microkernels such as seL4[0], with few but extremely fast syscalls[1]. Note times are in cycles, not ns.<p>0. <a href="https:&#x2F;&#x2F;sel4.systems&#x2F;" rel="nofollow">https:&#x2F;&#x2F;sel4.systems&#x2F;</a><p>1. <a href="https:&#x2F;&#x2F;sel4.systems&#x2F;About&#x2F;Performance&#x2F;" rel="nofollow">https:&#x2F;&#x2F;sel4.systems&#x2F;About&#x2F;Performance&#x2F;</a></div><br/></div></div><div id="39186495" class="c"><input type="checkbox" id="c-39186495" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#39186748">prev</a><span>|</span><a href="#39186673">next</a><span>|</span><label class="collapse" for="c-39186495">[-]</label><label class="expand" for="c-39186495">[1 more]</label></div><br/><div class="children"><div class="content">I tested the performance of system calls on Windows 10 by repeatedly calling NtClose on an invalid handle.  A system call took around 1200 CPU cycles.</div><br/></div></div><div id="39186673" class="c"><input type="checkbox" id="c-39186673" checked=""/><div class="controls bullet"><span class="by">vvern</span><span>|</span><a href="#39186495">prev</a><span>|</span><a href="#39186915">next</a><span>|</span><label class="collapse" for="c-39186673">[-]</label><label class="expand" for="c-39186673">[4 more]</label></div><br/><div class="children"><div class="content">Any good resources&#x2F;deeper dives into the details of what actually happens on modern computers when making these syscalls on, say, linux? I might have a reasonable idea about what goes on when performing a mode switch or context switch, but I’d love to have a reference or a nice walkthrough.</div><br/><div id="39186866" class="c"><input type="checkbox" id="c-39186866" checked=""/><div class="controls bullet"><span class="by">mindwok</span><span>|</span><a href="#39186673">parent</a><span>|</span><a href="#39187109">next</a><span>|</span><label class="collapse" for="c-39186866">[-]</label><label class="expand" for="c-39186866">[1 more]</label></div><br/><div class="children"><div class="content">My introduction to this was the &#x27;Direct Execution&#x27; chapter of the book &#x27;Operating Systems: Three Easy Pieces&#x27;.<p>It&#x27;s a fantastic write up on not just how system calls work, but the motivation behind why operating systems even implement them in the first place. It&#x27;s not specifically about Linux, but the book is clearly heavily inspired by early *nix designs and it&#x27;s still applicable.<p>You can read it for free here: <a href="https:&#x2F;&#x2F;pages.cs.wisc.edu&#x2F;~remzi&#x2F;OSTEP&#x2F;cpu-mechanisms.pdf" rel="nofollow">https:&#x2F;&#x2F;pages.cs.wisc.edu&#x2F;~remzi&#x2F;OSTEP&#x2F;cpu-mechanisms.pdf</a></div><br/></div></div><div id="39187109" class="c"><input type="checkbox" id="c-39187109" checked=""/><div class="controls bullet"><span class="by">cyberax</span><span>|</span><a href="#39186673">parent</a><span>|</span><a href="#39186866">prev</a><span>|</span><a href="#39186840">next</a><span>|</span><label class="collapse" for="c-39187109">[-]</label><label class="expand" for="c-39187109">[1 more]</label></div><br/><div class="children"><div class="content">This one is pretty good: <a href="https:&#x2F;&#x2F;blog.packagecloud.io&#x2F;the-definitive-guide-to-linux-system-calls&#x2F;" rel="nofollow">https:&#x2F;&#x2F;blog.packagecloud.io&#x2F;the-definitive-guide-to-linux-s...</a></div><br/></div></div></div></div><div id="39186915" class="c"><input type="checkbox" id="c-39186915" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#39186673">prev</a><span>|</span><label class="collapse" for="c-39186915">[-]</label><label class="expand" for="c-39186915">[14 more]</label></div><br/><div class="children"><div class="content">Anyone know why getpid&#x2F;getuid still aren’t implemented as vdso?</div><br/><div id="39187852" class="c"><input type="checkbox" id="c-39187852" checked=""/><div class="controls bullet"><span class="by">the8472</span><span>|</span><a href="#39186915">parent</a><span>|</span><a href="#39187050">next</a><span>|</span><label class="collapse" for="c-39187852">[-]</label><label class="expand" for="c-39187852">[1 more]</label></div><br/><div class="children"><div class="content">linux can set the uid per thread, afaik the vdso page is shared across threads.</div><br/></div></div><div id="39187050" class="c"><input type="checkbox" id="c-39187050" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#39186915">parent</a><span>|</span><a href="#39187852">prev</a><span>|</span><a href="#39187207">next</a><span>|</span><label class="collapse" for="c-39187050">[-]</label><label class="expand" for="c-39187050">[6 more]</label></div><br/><div class="children"><div class="content">When are you ever calling getuid in a tight loop?</div><br/><div id="39187227" class="c"><input type="checkbox" id="c-39187227" checked=""/><div class="controls bullet"><span class="by">bitcharmer</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187050">parent</a><span>|</span><a href="#39187207">next</a><span>|</span><label class="collapse" for="c-39187227">[-]</label><label class="expand" for="c-39187227">[5 more]</label></div><br/><div class="children"><div class="content">GP&#x27;s question is perfectly valid. It doesn&#x27;t have to be called within a tight loop at all. It could be a latency sensitive routine for example. I can see at least a few real life applications where it would make sense to have the syscall vDSO&#x27;d.</div><br/><div id="39187253" class="c"><input type="checkbox" id="c-39187253" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187227">parent</a><span>|</span><a href="#39187207">next</a><span>|</span><label class="collapse" for="c-39187253">[-]</label><label class="expand" for="c-39187253">[4 more]</label></div><br/><div class="children"><div class="content">What&#x27;s one of them?</div><br/><div id="39187261" class="c"><input type="checkbox" id="c-39187261" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187253">parent</a><span>|</span><a href="#39187207">next</a><span>|</span><label class="collapse" for="c-39187261">[-]</label><label class="expand" for="c-39187261">[3 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1469670" rel="nofollow">https:&#x2F;&#x2F;bugzilla.redhat.com&#x2F;show_bug.cgi?id=1469670</a><p>I would appreciate if someone explained why it’s not a vdso rather than just repeating it’s not necessary like that’s a sufficient explanation.</div><br/><div id="39187336" class="c"><input type="checkbox" id="c-39187336" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187261">parent</a><span>|</span><a href="#39187350">next</a><span>|</span><label class="collapse" for="c-39187336">[-]</label><label class="expand" for="c-39187336">[1 more]</label></div><br/><div class="children"><div class="content">It’s not a VDSO because it was never added as one. “Not a VDSO” is the default, a VDSO is additional complexity and maintenance so you need to justify its addition &#x2F; existence, not its non-existence.<p>Also given <a href="https:&#x2F;&#x2F;ipfs.io&#x2F;ipfs&#x2F;QmdA5WkDNALetBn4iFeSepHjdLGJdxPBwZyY47ir1bZGAK&#x2F;comp&#x2F;linux&#x2F;getpid_caching.html" rel="nofollow">https:&#x2F;&#x2F;ipfs.io&#x2F;ipfs&#x2F;QmdA5WkDNALetBn4iFeSepHjdLGJdxPBwZyY47i...</a> while Linus may have changed tack in the decades since I would not expect much support from stating getpid is performance critical to you.</div><br/></div></div><div id="39187350" class="c"><input type="checkbox" id="c-39187350" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187261">parent</a><span>|</span><a href="#39187336">prev</a><span>|</span><a href="#39187207">next</a><span>|</span><label class="collapse" for="c-39187350">[-]</label><label class="expand" for="c-39187350">[1 more]</label></div><br/><div class="children"><div class="content">I think we&#x27;re just talking past each other. I&#x27;m asking why you&#x27;d want to vDSO getuid(), not getpid(). I can imagine cases where you&#x27;d repeatedly be calling getpid().</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39187207" class="c"><input type="checkbox" id="c-39187207" checked=""/><div class="controls bullet"><span class="by">dmitrygr</span><span>|</span><a href="#39186915">parent</a><span>|</span><a href="#39187050">prev</a><span>|</span><label class="collapse" for="c-39187207">[-]</label><label class="expand" for="c-39187207">[6 more]</label></div><br/><div class="children"><div class="content">VDSO is designed for things that should be fast and are called often. There is absolutely no reason to call those functions often.<p>The only time your PID would change from a previous value obtained from that very same function is in the child, after a call to fork(), which is itself so heavy, that it would dwarf your calls to getpid</div><br/><div id="39187258" class="c"><input type="checkbox" id="c-39187258" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187207">parent</a><span>|</span><label class="collapse" for="c-39187258">[-]</label><label class="expand" for="c-39187258">[5 more]</label></div><br/><div class="children"><div class="content">Is it a scarce resource? For what it’s worth when the caching was removed from glibc it caused a performance problem in libsystemd which had a tight loop to detect when a process was forked. So while this may be true in many cases, there’s clearly cases where it’s not and your answer doesn’t explain why getpid isn’t a vdso.</div><br/><div id="39187387" class="c"><input type="checkbox" id="c-39187387" checked=""/><div class="controls bullet"><span class="by">dmitrygr</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187258">parent</a><span>|</span><label class="collapse" for="c-39187387">[-]</label><label class="expand" for="c-39187387">[4 more]</label></div><br/><div class="children"><div class="content">Memory is always a scarce resource. However, a big you make the vdso, that amount of memory, multiplied by the number of processes is the amount wasted. In reality, it will be more, because of the required additional page tables to map it at an address range that is not commonly used.<p>Also, what sort of raving lunatic had a busy loop checking the current process PID? Who allowed such a person access to a compiler? That seems like the bigger problem.</div><br/><div id="39187686" class="c"><input type="checkbox" id="c-39187686" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187387">parent</a><span>|</span><a href="#39187464">next</a><span>|</span><label class="collapse" for="c-39187686">[-]</label><label class="expand" for="c-39187686">[1 more]</label></div><br/><div class="children"><div class="content">I would assume good faith on the part of systemd developers. Afaik they’re as talented as any other top tier group of developers.<p>Somehow I doubt the code for getpid as a vdso would meaningfully impact the amount of memory used on a running system nor would I expect any meaningful impact to the number of page table entries. Do you have any supporting evidence for your claim otherwise?</div><br/></div></div><div id="39187464" class="c"><input type="checkbox" id="c-39187464" checked=""/><div class="controls bullet"><span class="by">charcircuit</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187387">parent</a><span>|</span><a href="#39187686">prev</a><span>|</span><label class="collapse" for="c-39187464">[-]</label><label class="expand" for="c-39187464">[2 more]</label></div><br/><div class="children"><div class="content">&gt;multiplied by the number of processes<p>Why aren&#x27;t the pages shared like other dynamic libraries?</div><br/><div id="39187678" class="c"><input type="checkbox" id="c-39187678" checked=""/><div class="controls bullet"><span class="by">fweimer</span><span>|</span><a href="#39186915">root</a><span>|</span><a href="#39187464">parent</a><span>|</span><label class="collapse" for="c-39187678">[-]</label><label class="expand" for="c-39187678">[1 more]</label></div><br/><div class="children"><div class="content">If we put the PID into the vDSO, this data page can no longer be shared among different processes (at least not in the same container).<p>We could use the rseq area for PID and TID.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>