<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1720774863287" as="style"/><link rel="stylesheet" href="styles.css?v=1720774863287"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://healeycodes.com/making-python-less-random">Making Python Less Random</a> <span class="domain">(<a href="https://healeycodes.com">healeycodes.com</a>)</span></div><div class="subtext"><span>healeycodes</span> | <span>21 comments</span></div><br/><div><div id="40942888" class="c"><input type="checkbox" id="c-40942888" checked=""/><div class="controls bullet"><span class="by">fiddlerwoaroof</span><span>|</span><a href="#40942053">next</a><span>|</span><label class="collapse" for="c-40942888">[-]</label><label class="expand" for="c-40942888">[1 more]</label></div><br/><div class="children"><div class="content">Another way to do this that covers more sources of non-determinism would be to run your python code under Meta’s Hermit:  <a href="https:&#x2F;&#x2F;developers.facebook.com&#x2F;blog&#x2F;post&#x2F;2022&#x2F;11&#x2F;22&#x2F;hermit-deterministic-linux-testing&#x2F;" rel="nofollow">https:&#x2F;&#x2F;developers.facebook.com&#x2F;blog&#x2F;post&#x2F;2022&#x2F;11&#x2F;22&#x2F;hermit-...</a></div><br/></div></div><div id="40942053" class="c"><input type="checkbox" id="c-40942053" checked=""/><div class="controls bullet"><span class="by">Neywiny</span><span>|</span><a href="#40942888">prev</a><span>|</span><a href="#40943175">next</a><span>|</span><label class="collapse" for="c-40942053">[-]</label><label class="expand" for="c-40942053">[2 more]</label></div><br/><div class="children"><div class="content">Python randomness is something I&#x27;ve fought with for a few years. A while back (it&#x27;s on my GitHub, I can find it if any replies care) I had an issue with something about distributed monte carlo sims all ending up with the same seed or something. More recently I&#x27;ve had an issue that I wanted a large number of random bytes but generated the same across multiple programs. Thinking about it now I could have used an LFSR or similar, but I just seeded the random module and it went fine.<p>Editing to add that another thing that trips me to every few years is that the hash function isn&#x27;t repeatable between runs. Meaning if you run the program and record a hash of an object, then run it again, they&#x27;ll be different. This is good for more secure maps and stuff but not good for thinking you can store them to a file and use them later.</div><br/><div id="40942423" class="c"><input type="checkbox" id="c-40942423" checked=""/><div class="controls bullet"><span class="by">kstrauser</span><span>|</span><a href="#40942053">parent</a><span>|</span><a href="#40943175">next</a><span>|</span><label class="collapse" for="c-40942423">[-]</label><label class="expand" for="c-40942423">[1 more]</label></div><br/><div class="children"><div class="content">The hash bit is by design. See <a href="https:&#x2F;&#x2F;docs.python.org&#x2F;3&#x2F;using&#x2F;cmdline.html#envvar-PYTHONHASHSEED" rel="nofollow">https:&#x2F;&#x2F;docs.python.org&#x2F;3&#x2F;using&#x2F;cmdline.html#envvar-PYTHONHA...</a> and <a href="http:&#x2F;&#x2F;ocert.org&#x2F;advisories&#x2F;ocert-2011-003.html" rel="nofollow">http:&#x2F;&#x2F;ocert.org&#x2F;advisories&#x2F;ocert-2011-003.html</a> for more.</div><br/></div></div></div></div><div id="40943175" class="c"><input type="checkbox" id="c-40943175" checked=""/><div class="controls bullet"><span class="by">cozzyd</span><span>|</span><a href="#40942053">prev</a><span>|</span><a href="#40943113">next</a><span>|</span><label class="collapse" for="c-40943175">[-]</label><label class="expand" for="c-40943175">[1 more]</label></div><br/><div class="children"><div class="content">Rather than writing a program you can also just use gdb and do it interactively...</div><br/></div></div><div id="40943113" class="c"><input type="checkbox" id="c-40943113" checked=""/><div class="controls bullet"><span class="by">k_sze</span><span>|</span><a href="#40943175">prev</a><span>|</span><a href="#40942834">next</a><span>|</span><label class="collapse" for="c-40943113">[-]</label><label class="expand" for="c-40943113">[1 more]</label></div><br/><div class="children"><div class="content">Just me or the solution will work on anything that depends on the SYS_getrandom syscall?</div><br/></div></div><div id="40942834" class="c"><input type="checkbox" id="c-40942834" checked=""/><div class="controls bullet"><span class="by">mianos</span><span>|</span><a href="#40943113">prev</a><span>|</span><a href="#40942793">next</a><span>|</span><label class="collapse" for="c-40942834">[-]</label><label class="expand" for="c-40942834">[5 more]</label></div><br/><div class="children"><div class="content">This is utterly insane:<p><pre><code>   import os
   os.urandom = lambda n: b&#x27;\x00&#x27; * n
   import random
   random.randint = lambda a, b: a
</code></pre>
I love it!</div><br/><div id="40942894" class="c"><input type="checkbox" id="c-40942894" checked=""/><div class="controls bullet"><span class="by">FreakLegion</span><span>|</span><a href="#40942834">parent</a><span>|</span><a href="#40942793">next</a><span>|</span><label class="collapse" for="c-40942894">[-]</label><label class="expand" for="c-40942894">[4 more]</label></div><br/><div class="children"><div class="content">That&#x27;s monkey patching, and it actually would&#x27;ve worked fine. There isn&#x27;t enough context in the write-up to say for sure, but presumably he was just doing it too late, after the third-party library was already imported. At that point the third-party library has its own reference to the original function(s), so patching the reference(s) in the source module doesn&#x27;t do anything. If the source module had been patched first, though, it all would&#x27;ve worked out.</div><br/><div id="40943728" class="c"><input type="checkbox" id="c-40943728" checked=""/><div class="controls bullet"><span class="by">mianos</span><span>|</span><a href="#40942834">root</a><span>|</span><a href="#40942894">parent</a><span>|</span><a href="#40943196">next</a><span>|</span><label class="collapse" for="c-40943728">[-]</label><label class="expand" for="c-40943728">[1 more]</label></div><br/><div class="children"><div class="content">I think he was saying something else was calling it and that was busting other things. Gevent did some crazy antics to get the whole tcp interface patched up. <a href="https:&#x2F;&#x2F;www.gevent.org&#x2F;api&#x2F;gevent.monkey.html#gevent.monkey.patch_all" rel="nofollow">https:&#x2F;&#x2F;www.gevent.org&#x2F;api&#x2F;gevent.monkey.html#gevent.monkey....</a></div><br/></div></div><div id="40943196" class="c"><input type="checkbox" id="c-40943196" checked=""/><div class="controls bullet"><span class="by">jnwatson</span><span>|</span><a href="#40942834">root</a><span>|</span><a href="#40942894">parent</a><span>|</span><a href="#40943728">prev</a><span>|</span><a href="#40942793">next</a><span>|</span><label class="collapse" for="c-40943196">[-]</label><label class="expand" for="c-40943196">[2 more]</label></div><br/><div class="children"><div class="content">This assumes there are no calls to random functions from C extensions. Still, I would have started with the above.</div><br/><div id="40943351" class="c"><input type="checkbox" id="c-40943351" checked=""/><div class="controls bullet"><span class="by">FreakLegion</span><span>|</span><a href="#40942834">root</a><span>|</span><a href="#40943196">parent</a><span>|</span><a href="#40942793">next</a><span>|</span><label class="collapse" for="c-40943351">[-]</label><label class="expand" for="c-40943351">[1 more]</label></div><br/><div class="children"><div class="content">Less so that, since he says he knows the sources of randomness, but it does assume esoteric import methods aren&#x27;t used. If for some reason the third-party library is e.g. loading modules with importlib, all bets are off.</div><br/></div></div></div></div></div></div></div></div><div id="40942793" class="c"><input type="checkbox" id="c-40942793" checked=""/><div class="controls bullet"><span class="by">sltkr</span><span>|</span><a href="#40942834">prev</a><span>|</span><a href="#40942889">next</a><span>|</span><label class="collapse" for="c-40942793">[-]</label><label class="expand" for="c-40942793">[7 more]</label></div><br/><div class="children"><div class="content">I know people hate “enterprise”-type software design, but this is a typical case where Dependency Injection would have made the solution trivial without the need for any OS-specific hacks.<p>And while the article serves as a nice introduction to ptrace(), I think as a solution to the posted problem it&#x27;s strictly more complicated than just replacing the getrandom() implementation with LD_PRELOAD (which the author also mentions as an option). For reference, that can be done as follows:<p><pre><code>    % cat getrandom.c 
    
    #include &lt;string.h&gt;
    #include &lt;sys&#x2F;types.h&gt;
    
    ssize_t getrandom(void \*buf, size_t buflen, unsigned int flags) {
      memset(buf, 0, buflen);
      return buflen;
    }
    
    % cc getrandom.c -shared -o getrandom.so
    
    % LD_PRELOAD=.&#x2F;getrandom.so python3 -c &#x27;import os; print(os.urandom(8))&#x27;
    b&#x27;\x00\x00\x00\x00\x00\x00\x00\x00&#x27;
</code></pre>
Note that these solutions work slightly differently: ptrace() intercepts the getrandom() syscall, but LD_PRELOAD replaces the getrandom() implementation in libc.so (which normally invokes the getrandom() syscall on Linux).</div><br/><div id="40943001" class="c"><input type="checkbox" id="c-40943001" checked=""/><div class="controls bullet"><span class="by">grumpyprole</span><span>|</span><a href="#40942793">parent</a><span>|</span><a href="#40942878">next</a><span>|</span><label class="collapse" for="c-40943001">[-]</label><label class="expand" for="c-40943001">[1 more]</label></div><br/><div class="children"><div class="content">A better way to deal with this versus dependency injection frameworks is to allow the generator to be configurable and to be honest about where the seed is coming from. The random seed is an implicit input read from the runtime environment as a side effect. Future languages should treat side effects as first class and allow, for example, custom handlers to be installed to intecept or modify their behaviour.</div><br/></div></div><div id="40942878" class="c"><input type="checkbox" id="c-40942878" checked=""/><div class="controls bullet"><span class="by">xeyownt</span><span>|</span><a href="#40942793">parent</a><span>|</span><a href="#40943001">prev</a><span>|</span><a href="#40943130">next</a><span>|</span><label class="collapse" for="c-40942878">[-]</label><label class="expand" for="c-40942878">[3 more]</label></div><br/><div class="children"><div class="content">Can you elaborate on what is &quot;Dependency Injection&quot;? Is this different from the example you show here with LD_PRELOAD?</div><br/><div id="40942972" class="c"><input type="checkbox" id="c-40942972" checked=""/><div class="controls bullet"><span class="by">sltkr</span><span>|</span><a href="#40942793">root</a><span>|</span><a href="#40942878">parent</a><span>|</span><a href="#40943021">next</a><span>|</span><label class="collapse" for="c-40942972">[-]</label><label class="expand" for="c-40942972">[1 more]</label></div><br/><div class="children"><div class="content">The topic is too complex to do it justice in a Hacker News comment, especially since it&#x27;s one of those things that takes some time and practical experience for the concept to “click”.<p>A good starting point is this article (though it&#x27;s a little outdated): <a href="https:&#x2F;&#x2F;martinfowler.com&#x2F;articles&#x2F;injection.html" rel="nofollow">https:&#x2F;&#x2F;martinfowler.com&#x2F;articles&#x2F;injection.html</a><p>DI is not very common in Python, for a variety of reasons, but there apparently are DI frameworks, like: <a href="https:&#x2F;&#x2F;python-dependency-injector.ets-labs.org&#x2F;index.html" rel="nofollow">https:&#x2F;&#x2F;python-dependency-injector.ets-labs.org&#x2F;index.html</a></div><br/></div></div><div id="40943021" class="c"><input type="checkbox" id="c-40943021" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#40942793">root</a><span>|</span><a href="#40942878">parent</a><span>|</span><a href="#40942972">prev</a><span>|</span><a href="#40943130">next</a><span>|</span><label class="collapse" for="c-40943021">[-]</label><label class="expand" for="c-40943021">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve asked a similar question, along the lines &#x27;Can you explain Dependency Injection to me, assuming I already know Haskell?&#x27;<p>And the answer was basically along the lines of: it&#x27;s a fancy way to pass something like a function argument.</div><br/></div></div></div></div><div id="40943130" class="c"><input type="checkbox" id="c-40943130" checked=""/><div class="controls bullet"><span class="by">CafeRacer</span><span>|</span><a href="#40942793">parent</a><span>|</span><a href="#40942878">prev</a><span>|</span><a href="#40942818">next</a><span>|</span><label class="collapse" for="c-40943130">[-]</label><label class="expand" for="c-40943130">[1 more]</label></div><br/><div class="children"><div class="content">Came here after reading the article to tell this. Aside from monkey patching that would have been my go to.</div><br/></div></div></div></div><div id="40942889" class="c"><input type="checkbox" id="c-40942889" checked=""/><div class="controls bullet"><span class="by">xeyownt</span><span>|</span><a href="#40942793">prev</a><span>|</span><a href="#40942579">next</a><span>|</span><label class="collapse" for="c-40942889">[-]</label><label class="expand" for="c-40942889">[1 more]</label></div><br/><div class="children"><div class="content">Maybe it doesn&#x27;t fit completely the author needs but an even less intrusive way to control random is to seed it manually.</div><br/></div></div></div></div></div></div></div></body></html>