<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1722416514608" as="style"/><link rel="stylesheet" href="styles.css?v=1722416514608"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://eli.thegreenplace.net/2024/building-static-binaries-with-go-on-linux/">Building static binaries with Go on Linux</a> <span class="domain">(<a href="https://eli.thegreenplace.net">eli.thegreenplace.net</a>)</span></div><div class="subtext"><span>ingve</span> | <span>35 comments</span></div><br/><div><div id="41117094" class="c"><input type="checkbox" id="c-41117094" checked=""/><div class="controls bullet"><span class="by">daenney</span><span>|</span><a href="#41117222">next</a><span>|</span><label class="collapse" for="c-41117094">[-]</label><label class="expand" for="c-41117094">[1 more]</label></div><br/><div class="children"><div class="content">In the specific case of SQLite, you can use it through WASM now [1]. It uses the dependency and Cgo-free Wazero runtime.<p>Performance so far has been better than the modernc transpile and it’s probably sufficient for a lot of use cases.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;ncruces&#x2F;go-sqlite3">https:&#x2F;&#x2F;github.com&#x2F;ncruces&#x2F;go-sqlite3</a></div><br/></div></div><div id="41117222" class="c"><input type="checkbox" id="c-41117222" checked=""/><div class="controls bullet"><span class="by">acatton</span><span>|</span><a href="#41117094">prev</a><span>|</span><a href="#41115997">next</a><span>|</span><label class="collapse" for="c-41117222">[-]</label><label class="expand" for="c-41117222">[1 more]</label></div><br/><div class="children"><div class="content">The secret with sqlite is to use &quot;-tags sqlite_omit_load_extension&quot;, if you don&#x27;t use any extension. (which is 99% of the users)<p>This is explained in <a href="https:&#x2F;&#x2F;www.arp242.net&#x2F;static-go.html" rel="nofollow">https:&#x2F;&#x2F;www.arp242.net&#x2F;static-go.html</a></div><br/></div></div><div id="41115997" class="c"><input type="checkbox" id="c-41115997" checked=""/><div class="controls bullet"><span class="by">bradfitz</span><span>|</span><a href="#41117222">prev</a><span>|</span><a href="#41115960">next</a><span>|</span><label class="collapse" for="c-41115997">[-]</label><label class="expand" for="c-41115997">[6 more]</label></div><br/><div class="children"><div class="content">Careful. We (Tailscale) tried to use static Go binaries a year or two ago built with Zig (zig cc) and the SQLite performance was atrocious. It passed all our tests but it didn&#x27;t survive deploying to prod. It was a very quick (and uneventful) rollback at least.<p>(Needless to say, we have better load testing tooling now)<p>I forget the details, but something about the libc allocator used by SQLite-with-Zig-libc being ... not good.</div><br/><div id="41116010" class="c"><input type="checkbox" id="c-41116010" checked=""/><div class="controls bullet"><span class="by">eliben</span><span>|</span><a href="#41115997">parent</a><span>|</span><a href="#41116085">next</a><span>|</span><label class="collapse" for="c-41116010">[-]</label><label class="expand" for="c-41116010">[1 more]</label></div><br/><div class="children"><div class="content">I wonder if it&#x27;s Zig or musl that&#x27;s to blame; did you end up statically linking with musl using musl-gcc, or did you forego static linking entirely?</div><br/></div></div><div id="41116085" class="c"><input type="checkbox" id="c-41116085" checked=""/><div class="controls bullet"><span class="by">tuxxi</span><span>|</span><a href="#41115997">parent</a><span>|</span><a href="#41116010">prev</a><span>|</span><a href="#41116417">next</a><span>|</span><label class="collapse" for="c-41116085">[-]</label><label class="expand" for="c-41116085">[1 more]</label></div><br/><div class="children"><div class="content">I’ve experienced the same performance issues with cgo + a library compiled with zig cc. IIRC it seemed like an issue with the zig tooling not plumbing the optimization flags through the ancient autotools build system for our required dependency. After a while fiddling, we just rolled it back too.<p>I haven’t tried this in about a year, so maybe the tooling doesn’t have these issues now.</div><br/></div></div><div id="41116417" class="c"><input type="checkbox" id="c-41116417" checked=""/><div class="controls bullet"><span class="by">dylanh</span><span>|</span><a href="#41115997">parent</a><span>|</span><a href="#41116085">prev</a><span>|</span><a href="#41116272">next</a><span>|</span><label class="collapse" for="c-41116417">[-]</label><label class="expand" for="c-41116417">[2 more]</label></div><br/><div class="children"><div class="content">This sounds like the musl allocator.
Using mimalloc or jemalloc would probably fair a lot better.</div><br/><div id="41117101" class="c"><input type="checkbox" id="c-41117101" checked=""/><div class="controls bullet"><span class="by">tarruda</span><span>|</span><a href="#41115997">root</a><span>|</span><a href="#41116417">parent</a><span>|</span><a href="#41116272">next</a><span>|</span><label class="collapse" for="c-41117101">[-]</label><label class="expand" for="c-41117101">[1 more]</label></div><br/><div class="children"><div class="content">Is this a problem in distributions that use musl as the system libc (Alpine) ?</div><br/></div></div></div></div><div id="41116272" class="c"><input type="checkbox" id="c-41116272" checked=""/><div class="controls bullet"><span class="by">JackYoustra</span><span>|</span><a href="#41115997">parent</a><span>|</span><a href="#41116417">prev</a><span>|</span><a href="#41115960">next</a><span>|</span><label class="collapse" for="c-41116272">[-]</label><label class="expand" for="c-41116272">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve heard you can just swap out allocators pretty easily - did something prevent this? Or perhaps its not as straightforward as I&#x27;ve thought...</div><br/></div></div></div></div><div id="41115960" class="c"><input type="checkbox" id="c-41115960" checked=""/><div class="controls bullet"><span class="by">wwarner</span><span>|</span><a href="#41115997">prev</a><span>|</span><a href="#41116758">next</a><span>|</span><label class="collapse" for="c-41115960">[-]</label><label class="expand" for="c-41115960">[1 more]</label></div><br/><div class="children"><div class="content">There’s also Filippo Valsorda linking directly to Rust via .a files. <a href="https:&#x2F;&#x2F;words.filippo.io&#x2F;rustgo&#x2F;" rel="nofollow">https:&#x2F;&#x2F;words.filippo.io&#x2F;rustgo&#x2F;</a></div><br/></div></div><div id="41115883" class="c"><input type="checkbox" id="c-41115883" checked=""/><div class="controls bullet"><span class="by">sbstp</span><span>|</span><a href="#41116758">prev</a><span>|</span><a href="#41115669">next</a><span>|</span><label class="collapse" for="c-41115883">[-]</label><label class="expand" for="c-41115883">[19 more]</label></div><br/><div class="children"><div class="content">I feel like there&#x27;s a lot of potential between Go and Cosmopolitan libc. Go itself does not use libc much, as shown in the blog, but some great libraries like SQLite3 need it (unless you use <a href="https:&#x2F;&#x2F;pkg.go.dev&#x2F;modernc.org&#x2F;sqlite" rel="nofollow">https:&#x2F;&#x2F;pkg.go.dev&#x2F;modernc.org&#x2F;sqlite</a>).<p>The ability to build a single static binary that works on Linux, Mac and Windows using Go would be life changing for the internal tools I develop at work.</div><br/><div id="41115985" class="c"><input type="checkbox" id="c-41115985" checked=""/><div class="controls bullet"><span class="by">latchkey</span><span>|</span><a href="#41115883">parent</a><span>|</span><a href="#41116912">next</a><span>|</span><label class="collapse" for="c-41115985">[-]</label><label class="expand" for="c-41115985">[1 more]</label></div><br/><div class="children"><div class="content">&gt; <i>The ability to build a single static binary that works on Linux, Mac and Windows using Go would be life changing for the internal tools I develop at work.</i><p>Just curious, life changing in what way? Obviously, 1 is better than 3, but I&#x27;m wondering if there is some other interesting reason.</div><br/></div></div><div id="41116912" class="c"><input type="checkbox" id="c-41116912" checked=""/><div class="controls bullet"><span class="by">spease</span><span>|</span><a href="#41115883">parent</a><span>|</span><a href="#41115985">prev</a><span>|</span><a href="#41116378">next</a><span>|</span><label class="collapse" for="c-41116912">[-]</label><label class="expand" for="c-41116912">[2 more]</label></div><br/><div class="children"><div class="content">Hmmm…what about compiling to wasm, and&#x2F;or then converting the wasm to C?<p><a href="https:&#x2F;&#x2F;github.com&#x2F;wasm3&#x2F;wasm3&#x2F;releases&#x2F;tag&#x2F;v0.4.8">https:&#x2F;&#x2F;github.com&#x2F;wasm3&#x2F;wasm3&#x2F;releases&#x2F;tag&#x2F;v0.4.8</a><p><a href="https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;wabt&#x2F;tree&#x2F;main&#x2F;wasm2c">https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;wabt&#x2F;tree&#x2F;main&#x2F;wasm2c</a></div><br/><div id="41117104" class="c"><input type="checkbox" id="c-41117104" checked=""/><div class="controls bullet"><span class="by">daenney</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116912">parent</a><span>|</span><a href="#41116378">next</a><span>|</span><label class="collapse" for="c-41117104">[-]</label><label class="expand" for="c-41117104">[1 more]</label></div><br/><div class="children"><div class="content">Has been done and works pretty great: <a href="https:&#x2F;&#x2F;github.com&#x2F;ncruces&#x2F;go-sqlite3">https:&#x2F;&#x2F;github.com&#x2F;ncruces&#x2F;go-sqlite3</a>.<p>Though doesn’t convert the WASM to C, it runs the WASM in Wazero instead.</div><br/></div></div></div></div><div id="41116378" class="c"><input type="checkbox" id="c-41116378" checked=""/><div class="controls bullet"><span class="by">fsmv</span><span>|</span><a href="#41115883">parent</a><span>|</span><a href="#41116912">prev</a><span>|</span><a href="#41116153">next</a><span>|</span><label class="collapse" for="c-41116378">[-]</label><label class="expand" for="c-41116378">[3 more]</label></div><br/><div class="children"><div class="content">The same exact binary working isn&#x27;t going to happen without runtime performance penalties because the syscall numbers are different on different platforms. Also I believe on windows it&#x27;s not possible to avoid linking some system libraries to use windows.h stuff, there is no stable ABI.</div><br/><div id="41117363" class="c"><input type="checkbox" id="c-41117363" checked=""/><div class="controls bullet"><span class="by">actionfromafar</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116378">parent</a><span>|</span><a href="#41116746">next</a><span>|</span><label class="collapse" for="c-41117363">[-]</label><label class="expand" for="c-41117363">[1 more]</label></div><br/><div class="children"><div class="content">Though msvcrt.dll has a stable subset of functions available on all Windows versions.</div><br/></div></div><div id="41116746" class="c"><input type="checkbox" id="c-41116746" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116378">parent</a><span>|</span><a href="#41117363">prev</a><span>|</span><a href="#41116153">next</a><span>|</span><label class="collapse" for="c-41116746">[-]</label><label class="expand" for="c-41116746">[1 more]</label></div><br/><div class="children"><div class="content">Linux is the exception among modern OSes to have a stable syscall ABI, everyone else offers only the proper OS API as entry point into OS services.<p>Once upon at time, static linking was the only thing OSes were capable of, all of them moved away from that, and there is no turning back outside embedded bare metal deployments, just become some people are obsessed with static linking.</div><br/></div></div></div></div><div id="41116153" class="c"><input type="checkbox" id="c-41116153" checked=""/><div class="controls bullet"><span class="by">oguz-ismail</span><span>|</span><a href="#41115883">parent</a><span>|</span><a href="#41116378">prev</a><span>|</span><a href="#41115669">next</a><span>|</span><label class="collapse" for="c-41116153">[-]</label><label class="expand" for="c-41116153">[12 more]</label></div><br/><div class="children"><div class="content">I recall reading about new Macs with ARM chips not supporting static binaries. Is it not true?</div><br/><div id="41116506" class="c"><input type="checkbox" id="c-41116506" checked=""/><div class="controls bullet"><span class="by">cyberax</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116153">parent</a><span>|</span><a href="#41116363">next</a><span>|</span><label class="collapse" for="c-41116506">[-]</label><label class="expand" for="c-41116506">[1 more]</label></div><br/><div class="children"><div class="content">All Macs don&#x27;t support static binaries. That&#x27;s because the syscall interface on macOS is not stable, only libc is guaranteed to be stable.</div><br/></div></div><div id="41116363" class="c"><input type="checkbox" id="c-41116363" checked=""/><div class="controls bullet"><span class="by">zamadatix</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116153">parent</a><span>|</span><a href="#41116506">prev</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116363">[-]</label><label class="expand" for="c-41116363">[9 more]</label></div><br/><div class="children"><div class="content">That&#x27;s been Apple&#x27;s stance on full static linking MacOS in general, many years prior to the move to ARM e.g. <a href="https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;archive&#x2F;qa&#x2F;qa1118&#x2F;_index.html" rel="nofollow">https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;archive&#x2F;qa&#x2F;qa1118&#x2F;_index...</a><p>You&#x27;re welcome to ignore it of course, it&#x27;s just unofficial and a large pain.</div><br/><div id="41116514" class="c"><input type="checkbox" id="c-41116514" checked=""/><div class="controls bullet"><span class="by">oguz-ismail</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116363">parent</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116514">[-]</label><label class="expand" for="c-41116514">[8 more]</label></div><br/><div class="children"><div class="content">&gt;You&#x27;re welcome to ignore it of course<p>How do you mean? Like, is it possible to run such binaries on M1? If so I&#x27;d really like to know how</div><br/><div id="41116594" class="c"><input type="checkbox" id="c-41116594" checked=""/><div class="controls bullet"><span class="by">telotortium</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116514">parent</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116594">[-]</label><label class="expand" for="c-41116594">[7 more]</label></div><br/><div class="children"><div class="content">You can always disassemble libc and look for the system call numbers used by the syscall assembly instructions. It’s just that these numbers (and associated arguments and return values) are not stable and can and do change upon kernel updates (in which case libc will be updated to keep the libc interface stable). I believe Linux is the only major OS these days to guarantee binary compatibility of the syscall interface.</div><br/><div id="41116633" class="c"><input type="checkbox" id="c-41116633" checked=""/><div class="controls bullet"><span class="by">oguz-ismail</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116594">parent</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116633">[-]</label><label class="expand" for="c-41116633">[6 more]</label></div><br/><div class="children"><div class="content">I know this works on Macs with Intel chips. But the ones with ARM chips just won&#x27;t execute fully static binaries, and I&#x27;m wondering if there&#x27;s a workaround.</div><br/><div id="41116839" class="c"><input type="checkbox" id="c-41116839" checked=""/><div class="controls bullet"><span class="by">telotortium</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116633">parent</a><span>|</span><a href="#41116761">next</a><span>|</span><label class="collapse" for="c-41116839">[-]</label><label class="expand" for="c-41116839">[1 more]</label></div><br/><div class="children"><div class="content">I’m guessing not. According to man ld on macOS, the -static flag, to produce a fully static executable, is only used to build the kernel. I don’t believe fully-static executables were ever officially supported on macOS, although they would work.</div><br/></div></div><div id="41116761" class="c"><input type="checkbox" id="c-41116761" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116633">parent</a><span>|</span><a href="#41116839">prev</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116761">[-]</label><label class="expand" for="c-41116761">[4 more]</label></div><br/><div class="children"><div class="content">Nope.</div><br/><div id="41116856" class="c"><input type="checkbox" id="c-41116856" checked=""/><div class="controls bullet"><span class="by">oguz-ismail</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116761">parent</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116856">[-]</label><label class="expand" for="c-41116856">[3 more]</label></div><br/><div class="children"><div class="content">Thanks. That sucks</div><br/><div id="41116886" class="c"><input type="checkbox" id="c-41116886" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#41115883">root</a><span>|</span><a href="#41116856">parent</a><span>|</span><a href="#41117434">prev</a><span>|</span><a href="#41116159">next</a><span>|</span><label class="collapse" for="c-41116886">[-]</label><label class="expand" for="c-41116886">[1 more]</label></div><br/><div class="children"><div class="content">If you can convince Apple to change this code let me know: <a href="https:&#x2F;&#x2F;github.com&#x2F;apple-oss-distributions&#x2F;xnu&#x2F;blob&#x2F;94d3b452840153a99b38a3a9659680b2a006908e&#x2F;bsd&#x2F;kern&#x2F;mach_loader.c#L877">https:&#x2F;&#x2F;github.com&#x2F;apple-oss-distributions&#x2F;xnu&#x2F;blob&#x2F;94d3b452...</a></div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div id="41115669" class="c"><input type="checkbox" id="c-41115669" checked=""/><div class="controls bullet"><span class="by">SpecialistK</span><span>|</span><a href="#41115883">prev</a><span>|</span><label class="collapse" for="c-41115669">[-]</label><label class="expand" for="c-41115669">[5 more]</label></div><br/><div class="children"><div class="content">Very interesting and well described! If I were to have one nitpick, it would be the use of &quot;Unix&quot; when it&#x27;s more specific to Linux. Ex. &quot;The libc typically used on Unix systems is glibc&quot;
However I&#x27;m sure all of the concepts still apply on BSD, Solaris, etc.</div><br/><div id="41115724" class="c"><input type="checkbox" id="c-41115724" checked=""/><div class="controls bullet"><span class="by">Onavo</span><span>|</span><a href="#41115669">parent</a><span>|</span><label class="collapse" for="c-41115724">[-]</label><label class="expand" for="c-41115724">[4 more]</label></div><br/><div class="children"><div class="content">Go is also famous for bypassing libc and issuing syscalls directly on quite a few platforms.</div><br/><div id="41115742" class="c"><input type="checkbox" id="c-41115742" checked=""/><div class="controls bullet"><span class="by">galangalalgol</span><span>|</span><a href="#41115669">root</a><span>|</span><a href="#41115724">parent</a><span>|</span><label class="collapse" for="c-41115742">[-]</label><label class="expand" for="c-41115742">[3 more]</label></div><br/><div class="children"><div class="content">I thought I&#x27;d read they backed off of that and started using posix as an abstraction layer.</div><br/><div id="41115981" class="c"><input type="checkbox" id="c-41115981" checked=""/><div class="controls bullet"><span class="by">bradfitz</span><span>|</span><a href="#41115669">root</a><span>|</span><a href="#41115742">parent</a><span>|</span><label class="collapse" for="c-41115981">[-]</label><label class="expand" for="c-41115981">[2 more]</label></div><br/><div class="children"><div class="content">Go used to do raw syscalls on macOS but changed. Same with some BSDs.<p>Go always did ~libc on Windows (and Solaris) and still does.<p>Go still does raw syscalls on Linux, as that&#x27;s a stable ABI.</div><br/><div id="41116769" class="c"><input type="checkbox" id="c-41116769" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#41115669">root</a><span>|</span><a href="#41115981">parent</a><span>|</span><label class="collapse" for="c-41116769">[-]</label><label class="expand" for="c-41116769">[1 more]</label></div><br/><div class="children"><div class="content">libc is a UNIX concept, as the OS API surface, as described by POSIX.<p>On any other no-UNIX derived OS, it is the C compiler standard library, covering only the ISO C specifies.<p>All the remaining OS services are exposed by other libraries, which in Windows case, the bare minimum is user, kernel and gdi dlls for the Win32 personality.<p>Systems like IBM i, IBM z, ClearPath MCP, .... also have similar set of libraries, as do non-POSIX RTOS for embedded.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>