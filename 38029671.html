<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1698397274504" as="style"/><link rel="stylesheet" href="styles.css?v=1698397274504"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.citusdata.com/blog/2023/10/26/making-postgres-tick-new-features-in-pg-cron/">Making PostgreSQL tick: New features in pg_cron</a> <span class="domain">(<a href="https://www.citusdata.com">www.citusdata.com</a>)</span></div><div class="subtext"><span>thunderbong</span> | <span>18 comments</span></div><br/><div><div id="38033800" class="c"><input type="checkbox" id="c-38033800" checked=""/><div class="controls bullet"><span class="by">film42</span><span>|</span><a href="#38036098">next</a><span>|</span><label class="collapse" for="c-38033800">[-]</label><label class="expand" for="c-38033800">[15 more]</label></div><br/><div class="children"><div class="content">The ability to run a cron every few seconds is pretty cool and avoids those OS cron scripts that loop and sleep, so I&#x27;m glad that was added. Only downside to cron jobs running inside postgres is PL&#x2F;pgSQL. It&#x27;s never my first choice for scripting sql operations. I&#x27;d much rather use python, ruby, etc. I&#x27;m glad it exists when there&#x27;s no other option, but it&#x27;s kind of its own beast.<p>That said, I&#x27;m very happy to see more and more stuff coming from Citus. We&#x27;re looking to split a few growing databases and a bunch of folks are excited to try Citus again now that the enterprise features have been open sourced.</div><br/><div id="38035685" class="c"><input type="checkbox" id="c-38035685" checked=""/><div class="controls bullet"><span class="by">rubenfiszel</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38033908">next</a><span>|</span><label class="collapse" for="c-38035685">[-]</label><label class="expand" for="c-38035685">[1 more]</label></div><br/><div class="children"><div class="content">One way to use raw python&#x2F;javascript&#x2F;bash on top of a postgres scheduler is to run a single container of <a href="https:&#x2F;&#x2F;github.com&#x2F;windmill-labs&#x2F;windmill">https:&#x2F;&#x2F;github.com&#x2F;windmill-labs&#x2F;windmill</a>. It only requires a PG connection and does not require a pg extension.
It implements a scheduler that is implemented on top of PG and can run any of the aforementioned language in a very practical and observable interface.</div><br/></div></div><div id="38033908" class="c"><input type="checkbox" id="c-38033908" checked=""/><div class="controls bullet"><span class="by">throwaway44444d</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38035685">prev</a><span>|</span><a href="#38034200">next</a><span>|</span><label class="collapse" for="c-38033908">[-]</label><label class="expand" for="c-38033908">[5 more]</label></div><br/><div class="children"><div class="content">At the risk of sounding like a Golang&#x2F;inteface{} &quot;you&#x27;re using it wrong&quot; defender, most of the objection to PL&#x2F;pgSQL is because people don&#x27;t know what they are doing. They look at assignment, looping and manipulation and think this would be much easier in javascript or python. However they&#x27;ve usually embarked on the wrong route at this point, and if they knew how to do join on UPDATE, or use CTEs, or windowing they wouldn&#x27;t need a big ugly block of imperative code, 90% you see a FOR ... the whole block can be collapsed to a single more performant update&#x2F;upsert statement.  That said I still have 1000+ line pl&#x2F;pgsql functions and the language constructs could definitely be improved, just a little sugar please...</div><br/><div id="38034275" class="c"><input type="checkbox" id="c-38034275" checked=""/><div class="controls bullet"><span class="by">maxbond</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38033908">parent</a><span>|</span><a href="#38035570">next</a><span>|</span><label class="collapse" for="c-38034275">[-]</label><label class="expand" for="c-38034275">[3 more]</label></div><br/><div class="children"><div class="content">As a smell test, when writing a FOR loop in pgSQL, you might ask yourself, &quot;does the order of these rows matter?&quot; And &quot;do I need to see all of them?&quot; (rather than say, just the first or last). If the answer to either of these questions is no, you can probably rewrite it declaratively. You might be able to turn the entire function to PL&#x2F;SQL rather than PL&#x2F;pgSQL, at which point you might ask yourself if it&#x27;s better as a view instead of a function. (Similarly, if the answer to both of those questions is yes, you definitely cannot rewrite it declaratively, unless you figure out a different algorithm.)<p>If all of them matter but the order doesn&#x27;t, you might be able to use aggregations like sum.<p>If the order matters but you don&#x27;t need to see all of them, you might use aggregations like min and max.<p>You can refactor some of your logic into an aggregation function if your use cases isn&#x27;t in the standard library. Often helpful if you have some core business logic that contains lots of if statements, and so is easier to write imperatively.<p>But I also wish the language were more ergonomic.</div><br/><div id="38034409" class="c"><input type="checkbox" id="c-38034409" checked=""/><div class="controls bullet"><span class="by">nonethewiser</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38034275">parent</a><span>|</span><a href="#38035570">next</a><span>|</span><label class="collapse" for="c-38034409">[-]</label><label class="expand" for="c-38034409">[2 more]</label></div><br/><div class="children"><div class="content">Can someone explain the difference between declarative and imperative in this context? My understanding is SQL is declarative.<p>So is declarative something like “writing high level statements that postgres turns into more specific (imperative?) instructions”? And imperative being writing those specific “do this, then do this” yourself (although probably differently than how postgres does it under the hood).</div><br/><div id="38034433" class="c"><input type="checkbox" id="c-38034433" checked=""/><div class="controls bullet"><span class="by">maxbond</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38034409">parent</a><span>|</span><a href="#38035570">next</a><span>|</span><label class="collapse" for="c-38034433">[-]</label><label class="expand" for="c-38034433">[1 more]</label></div><br/><div class="children"><div class="content">SQL is declarative, but Postgres provides an alternative language for database-side programming called PgSQL[1]. PgSQL adds some imperative features, like FOR loops and variables, as a superset of SQL&#x27;s features.<p>So functions in the database can be written in this imperative language (or in SQL), and integrated into features like database triggers or called be clients (or, commonly, used to write pg_cron jobs).<p>And your understanding of the distinction between them is correct. Declarative describes what you want to do but not how you want to do it, and Postgres&#x27; query planner (or that any fully featured SQL database) will uses statistics it has recorded about your data and indexes you&#x27;ve created to optimize the execution of your query (decide how to do it). PgSQL can tell Postgres
 what to do and how, except in the places where you&#x27;re writing declarative SQL statements (since it&#x27;s a superset). Breaking things up into smaller units like that limits the scope the planner can optimize over, which may defeat or limit certain optimizations and you may end up with something less performant.<p>For some straightforward examples: if you write a min or max function with a FOR loop, you have written an O(n) implementation for something the query planner can sometimes do in O(1) using an index. If you write a sum function, you&#x27;ve written a sequential implementation of something the query planner may be able to parallelize.<p>[1] <a href="https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;plpgsql.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;plpgsql.html</a></div><br/></div></div></div></div></div></div><div id="38035570" class="c"><input type="checkbox" id="c-38035570" checked=""/><div class="controls bullet"><span class="by">BiteCode_dev</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38033908">parent</a><span>|</span><a href="#38034275">prev</a><span>|</span><a href="#38034200">next</a><span>|</span><label class="collapse" for="c-38035570">[-]</label><label class="expand" for="c-38035570">[1 more]</label></div><br/><div class="children"><div class="content">And you are so right you decided to use a throwaway account to make this point.</div><br/></div></div></div></div><div id="38034200" class="c"><input type="checkbox" id="c-38034200" checked=""/><div class="controls bullet"><span class="by">simonw</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38033908">prev</a><span>|</span><a href="#38034971">next</a><span>|</span><label class="collapse" for="c-38034200">[-]</label><label class="expand" for="c-38034200">[2 more]</label></div><br/><div class="children"><div class="content">PL&#x2F;pgSQL is a great example of the kind of DSL that I would have avoided in the past but I&#x27;m actually much happier to use today because GPT-4 can explain code to me and even write basic things that work which I can then improve on.</div><br/><div id="38035586" class="c"><input type="checkbox" id="c-38035586" checked=""/><div class="controls bullet"><span class="by">BiteCode_dev</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38034200">parent</a><span>|</span><a href="#38034971">next</a><span>|</span><label class="collapse" for="c-38035586">[-]</label><label class="expand" for="c-38035586">[1 more]</label></div><br/><div class="children"><div class="content">Yeah but it can&#x27;t __easily__ manipulate the file system, talk to the cache store, run bash commands, make an HTTP requests and so on.<p>Cron job are not just about db updates, and once you have one cron job in Python, having them scattered among several language is not ideal.</div><br/></div></div></div></div><div id="38034971" class="c"><input type="checkbox" id="c-38034971" checked=""/><div class="controls bullet"><span class="by">Alifatisk</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38034200">prev</a><span>|</span><a href="#38033881">next</a><span>|</span><label class="collapse" for="c-38034971">[-]</label><label class="expand" for="c-38034971">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I&#x27;d much rather use python, ruby, etc.<p>I think I’m with you on this one</div><br/></div></div><div id="38033881" class="c"><input type="checkbox" id="c-38033881" checked=""/><div class="controls bullet"><span class="by">qaq</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38034971">prev</a><span>|</span><a href="#38035120">next</a><span>|</span><label class="collapse" for="c-38033881">[-]</label><label class="expand" for="c-38033881">[3 more]</label></div><br/><div class="children"><div class="content">You can use PL&#x2F;Python no?</div><br/><div id="38035225" class="c"><input type="checkbox" id="c-38035225" checked=""/><div class="controls bullet"><span class="by">code_biologist</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38033881">parent</a><span>|</span><a href="#38035591">next</a><span>|</span><label class="collapse" for="c-38035225">[-]</label><label class="expand" for="c-38035225">[1 more]</label></div><br/><div class="children"><div class="content">I dunno about other hosted Postgres providers, but not on AWS RDS no, as the Python extension is untrusted. Looks like you can use plv8 via pg_tle (Trusted Language Extensions) [1] though.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;aws&#x2F;pg_tle">https:&#x2F;&#x2F;github.com&#x2F;aws&#x2F;pg_tle</a></div><br/></div></div><div id="38035591" class="c"><input type="checkbox" id="c-38035591" checked=""/><div class="controls bullet"><span class="by">BiteCode_dev</span><span>|</span><a href="#38033800">root</a><span>|</span><a href="#38033881">parent</a><span>|</span><a href="#38035225">prev</a><span>|</span><a href="#38035120">next</a><span>|</span><label class="collapse" for="c-38035591">[-]</label><label class="expand" for="c-38035591">[1 more]</label></div><br/><div class="children"><div class="content">Good luck using a venv, loading your libs, upgrading the extensions when needed, etc.</div><br/></div></div></div></div><div id="38035139" class="c"><input type="checkbox" id="c-38035139" checked=""/><div class="controls bullet"><span class="by">danr4</span><span>|</span><a href="#38033800">parent</a><span>|</span><a href="#38035120">prev</a><span>|</span><a href="#38036098">next</a><span>|</span><label class="collapse" for="c-38035139">[-]</label><label class="expand" for="c-38035139">[1 more]</label></div><br/><div class="children"><div class="content">plv8 can let your run JavaScript</div><br/></div></div></div></div><div id="38036098" class="c"><input type="checkbox" id="c-38036098" checked=""/><div class="controls bullet"><span class="by">SeriousM</span><span>|</span><a href="#38033800">prev</a><span>|</span><label class="collapse" for="c-38036098">[-]</label><label class="expand" for="c-38036098">[2 more]</label></div><br/><div class="children"><div class="content">Is that yet another way to place a backdoor in a infected system?</div><br/><div id="38036137" class="c"><input type="checkbox" id="c-38036137" checked=""/><div class="controls bullet"><span class="by">mslot</span><span>|</span><a href="#38036098">parent</a><span>|</span><label class="collapse" for="c-38036137">[-]</label><label class="expand" for="c-38036137">[1 more]</label></div><br/><div class="children"><div class="content">Fwiw, pg_cron jobs run as the database user that scheduled the job and the jobs table is not writable, nor can you see jobs created by other users unless you are the admin.<p>There is not much you can do with it that you could not via external infrastructure that connects to the database, except you don&#x27;t need to set up external infrastructure that connects to the database. (and simpler systems are generally more secure)</div><br/></div></div></div></div></div></div></div></div></div></body></html>