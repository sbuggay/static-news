<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1720774863287" as="style"/><link rel="stylesheet" href="styles.css?v=1720774863287"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://ochagavia.nl/blog/using-s3-as-a-container-registry/">Using S3 as a Container Registry</a> <span class="domain">(<a href="https://ochagavia.nl">ochagavia.nl</a>)</span></div><div class="subtext"><span>jandeboevrie</span> | <span>18 comments</span></div><br/><div><div id="40943847" class="c"><input type="checkbox" id="c-40943847" checked=""/><div class="controls bullet"><span class="by">stabbles</span><span>|</span><a href="#40943480">next</a><span>|</span><label class="collapse" for="c-40943847">[-]</label><label class="expand" for="c-40943847">[1 more]</label></div><br/><div class="children"><div class="content">The OCI Distribution Spec is not great.<p>&gt; According to the specification, a layer push must happen sequentially: even if you upload the layer in chunks, each chunk needs to finish uploading before you can move on to the next one.<p>As far as I&#x27;ve tested with DockerHub and GHCR, chunked upload is broken anyways, and clients upload each blob&#x2F;layer as a whole. The spec also promotes `Content-Range` value formats that do not match the RFC7233 format.<p>(That said, there&#x27;s parallelism on the level of blobs, just not per blob)<p>Another gripe of mine is that they missed the opportunity to standardize pagination of listing tags, because they accidentally deleted some text from the standard [1]. Now different registries roll their own.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;opencontainers&#x2F;distribution-spec&#x2F;issues&#x2F;461#issuecomment-1701554264">https:&#x2F;&#x2F;github.com&#x2F;opencontainers&#x2F;distribution-spec&#x2F;issues&#x2F;4...</a></div><br/></div></div><div id="40943480" class="c"><input type="checkbox" id="c-40943480" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943847">prev</a><span>|</span><a href="#40943621">next</a><span>|</span><label class="collapse" for="c-40943480">[-]</label><label class="expand" for="c-40943480">[6 more]</label></div><br/><div class="children"><div class="content">Hi HN, author here. If anyone knows why layer pushes need to be sequential in the OCI specification, please tell! Is it merely a historical accident, or is there some hidden rationale behind it?<p>Edit: to clarify, I&#x27;m talking about sequentially pushing a _single_ layer&#x27;s contents. You can, of course, push multiple layers in parallel.</div><br/><div id="40943762" class="c"><input type="checkbox" id="c-40943762" checked=""/><div class="controls bullet"><span class="by">IanCal</span><span>|</span><a href="#40943480">parent</a><span>|</span><a href="#40943523">next</a><span>|</span><label class="collapse" for="c-40943762">[-]</label><label class="expand" for="c-40943762">[4 more]</label></div><br/><div class="children"><div class="content">I can&#x27;t think of an obvious one, maybe load based?<p>~~I added parallel pushes to docker I think, unless I&#x27;m mixing up pulls &amp; pushes, it was a while ago.~~ My stuff was around parallelising the checks not the final pushes.<p>Edit - does a layer say which layer it goes &quot;on top&quot; of? If so perhaps that&#x27;s the reason, so the IDs of what&#x27;s being pointed to exist.</div><br/><div id="40943792" class="c"><input type="checkbox" id="c-40943792" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943480">root</a><span>|</span><a href="#40943762">parent</a><span>|</span><a href="#40943523">next</a><span>|</span><label class="collapse" for="c-40943792">[-]</label><label class="expand" for="c-40943792">[3 more]</label></div><br/><div class="children"><div class="content">Layers are fully independent of each other in the OCI spec (which makes them reusable). They are wired together through a separate manifest file that lists the layers of a specific image.<p>It&#x27;s a mystery... Here are the bits of the OCI spec about multipart pushes (<a href="https:&#x2F;&#x2F;github.com&#x2F;opencontainers&#x2F;distribution-spec&#x2F;blob&#x2F;58d034eaee033f6f29f482817745a9b0f8b0dea2&#x2F;spec.md#pushing-a-blob-in-chunks">https:&#x2F;&#x2F;github.com&#x2F;opencontainers&#x2F;distribution-spec&#x2F;blob&#x2F;58d...</a>). In short, you can only upload the next chunk after the previous one finishes, because you need to use information from the response&#x27;s headers.</div><br/><div id="40943807" class="c"><input type="checkbox" id="c-40943807" checked=""/><div class="controls bullet"><span class="by">IanCal</span><span>|</span><a href="#40943480">root</a><span>|</span><a href="#40943792">parent</a><span>|</span><a href="#40943523">next</a><span>|</span><label class="collapse" for="c-40943807">[-]</label><label class="expand" for="c-40943807">[2 more]</label></div><br/><div class="children"><div class="content">Ah thanks.<p>That&#x27;s chunks of a single layer though, not multiple layers right?</div><br/><div id="40943826" class="c"><input type="checkbox" id="c-40943826" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943480">root</a><span>|</span><a href="#40943807">parent</a><span>|</span><a href="#40943523">next</a><span>|</span><label class="collapse" for="c-40943826">[-]</label><label class="expand" for="c-40943826">[1 more]</label></div><br/><div class="children"><div class="content">Indeed, you are free to push multiple layers in parallel. But when you have a 1 GiB layer full of AI&#x2F;ML stuff you can feel the pain!<p>(I just updated my original comment to make clear I&#x27;m talking about single-layer pushes here)</div><br/></div></div></div></div></div></div></div></div><div id="40943523" class="c"><input type="checkbox" id="c-40943523" checked=""/><div class="controls bullet"><span class="by">rcarmo</span><span>|</span><a href="#40943480">parent</a><span>|</span><a href="#40943762">prev</a><span>|</span><a href="#40943621">next</a><span>|</span><label class="collapse" for="c-40943523">[-]</label><label class="expand" for="c-40943523">[1 more]</label></div><br/><div class="children"><div class="content">Never dealt with pushes, but it’s nice to see this — back when Docker was getting started I dumped an image behind nginx and pulled from that because there was no usable private registry container, so I enjoyed reading your article.</div><br/></div></div></div></div><div id="40943621" class="c"><input type="checkbox" id="c-40943621" checked=""/><div class="controls bullet"><span class="by">jaimehrubiks</span><span>|</span><a href="#40943480">prev</a><span>|</span><a href="#40943549">next</a><span>|</span><label class="collapse" for="c-40943621">[-]</label><label class="expand" for="c-40943621">[3 more]</label></div><br/><div class="children"><div class="content">I experience everyday the slowness of pushing big images (ai related tend to be big) to ECR on our cicd.</div><br/><div id="40943642" class="c"><input type="checkbox" id="c-40943642" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943621">parent</a><span>|</span><a href="#40943549">next</a><span>|</span><label class="collapse" for="c-40943642">[-]</label><label class="expand" for="c-40943642">[2 more]</label></div><br/><div class="children"><div class="content">I wonder whether the folks at Cloudflare could take the ideas from the blog post and create a high-performance serverless container registry based on R2. They could call it scrubs, for &quot;serverless container registry using blob storage&quot; :P</div><br/><div id="40943837" class="c"><input type="checkbox" id="c-40943837" checked=""/><div class="controls bullet"><span class="by">sshine</span><span>|</span><a href="#40943621">root</a><span>|</span><a href="#40943642">parent</a><span>|</span><a href="#40943549">next</a><span>|</span><label class="collapse" for="c-40943837">[-]</label><label class="expand" for="c-40943837">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=3QbOssRq0Gs" rel="nofollow">https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=3QbOssRq0Gs</a><p><pre><code>  [Chorus: Chilli &amp; T-Boz]
  No, I don&#x27;t want no scrub
  A scrub is a guy that can&#x27;t get no love from me
  Hangin&#x27; out the passenger side of his best friend&#x27;s ride
  Trying to holla at me
  I don&#x27;t want no scrub
  A scrub is a guy that can&#x27;t get no love from me
  Hangin&#x27; out the passenger side of his best friend&#x27;s ride
  Trying to holla at me</code></pre></div><br/></div></div></div></div></div></div><div id="40943549" class="c"><input type="checkbox" id="c-40943549" checked=""/><div class="controls bullet"><span class="by">cpa</span><span>|</span><a href="#40943621">prev</a><span>|</span><label class="collapse" for="c-40943549">[-]</label><label class="expand" for="c-40943549">[7 more]</label></div><br/><div class="children"><div class="content">Is there a good reason for not allowing parallel uploads in the spec?</div><br/><div id="40943574" class="c"><input type="checkbox" id="c-40943574" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943549">parent</a><span>|</span><a href="#40943575">next</a><span>|</span><label class="collapse" for="c-40943574">[-]</label><label class="expand" for="c-40943574">[1 more]</label></div><br/><div class="children"><div class="content">No idea... I asked the same question here (<a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40943480">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40943480</a>) and am hoping we&#x27;ll have a classic HN moment where someone who was involved in the design of the spec will chime in.</div><br/></div></div><div id="40943575" class="c"><input type="checkbox" id="c-40943575" checked=""/><div class="controls bullet"><span class="by">benterix</span><span>|</span><a href="#40943549">parent</a><span>|</span><a href="#40943574">prev</a><span>|</span><label class="collapse" for="c-40943575">[-]</label><label class="expand" for="c-40943575">[5 more]</label></div><br/><div class="children"><div class="content">I believe that even if there was one then, it&#x27;s probably no longer valid and it&#x27;s now just a performance limitation.</div><br/><div id="40943635" class="c"><input type="checkbox" id="c-40943635" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943549">root</a><span>|</span><a href="#40943575">parent</a><span>|</span><label class="collapse" for="c-40943635">[-]</label><label class="expand" for="c-40943635">[4 more]</label></div><br/><div class="children"><div class="content">Other than backwards-compatibility, I can imagine simplicity being a reason. For instance, sequential pushing makes it easier to calculate the sha256 hash of the layer as it&#x27;s being uploaded, without having to do it after-the-fact when the uploaded chunks are assembled.</div><br/><div id="40943669" class="c"><input type="checkbox" id="c-40943669" checked=""/><div class="controls bullet"><span class="by">catlifeonmars</span><span>|</span><a href="#40943549">root</a><span>|</span><a href="#40943635">parent</a><span>|</span><a href="#40943696">next</a><span>|</span><label class="collapse" for="c-40943669">[-]</label><label class="expand" for="c-40943669">[1 more]</label></div><br/><div class="children"><div class="content">That does not make any sense; as the network usually is a much bigger bottleneck than compute, even with disk reads. You’re paying quite a lot for “simplicity” if that were the case</div><br/></div></div><div id="40943696" class="c"><input type="checkbox" id="c-40943696" checked=""/><div class="controls bullet"><span class="by">jtmarmon</span><span>|</span><a href="#40943549">root</a><span>|</span><a href="#40943635">parent</a><span>|</span><a href="#40943669">prev</a><span>|</span><label class="collapse" for="c-40943696">[-]</label><label class="expand" for="c-40943696">[2 more]</label></div><br/><div class="children"><div class="content">I’m no expert on docker but I thought the hashes for each layer would already be computed if your image is built</div><br/><div id="40943711" class="c"><input type="checkbox" id="c-40943711" checked=""/><div class="controls bullet"><span class="by">wofo</span><span>|</span><a href="#40943549">root</a><span>|</span><a href="#40943696">parent</a><span>|</span><label class="collapse" for="c-40943711">[-]</label><label class="expand" for="c-40943711">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s true, but I&#x27;d assume the server would like to double-check that the hashes are valid (for robustness &#x2F; consistency)... That&#x27;s something my little experiment doesn&#x27;t do, obviously.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>