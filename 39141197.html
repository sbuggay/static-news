<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1706346051645" as="style"/><link rel="stylesheet" href="styles.css?v=1706346051645"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://veera.app/mesh_allocator.html">Understanding Mesh Allocator</a> <span class="domain">(<a href="https://veera.app">veera.app</a>)</span></div><div class="subtext"><span>signa11</span> | <span>10 comments</span></div><br/><div><div id="39152077" class="c"><input type="checkbox" id="c-39152077" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#39152087">next</a><span>|</span><label class="collapse" for="c-39152077">[-]</label><label class="expand" for="c-39152077">[5 more]</label></div><br/><div class="children"><div class="content">This is a cool technique, but it will cost you more TLB misses, which are pretty expensive. For most software, you can get it to run 10-20% faster just by reducing TLB misses by 99% using 2MB pages. I speculate that the reason this is not often done is that the feature is basically unusable on Windows.</div><br/><div id="39152402" class="c"><input type="checkbox" id="c-39152402" checked=""/><div class="controls bullet"><span class="by">emeryberger</span><span>|</span><a href="#39152077">parent</a><span>|</span><a href="#39152108">next</a><span>|</span><label class="collapse" for="c-39152402">[-]</label><label class="expand" for="c-39152402">[2 more]</label></div><br/><div class="children"><div class="content">Hi, Mesh co-author here. Mesh should not introduce any additional TLB pressure - the number of virtual pages remains the same, so the number of TLB entries does not change. It remaps existing virtual pages to the same physical page once they have been meshed. Using huge pages is an entirely different question, and one that would require novel techniques to adapt meshing to that setting.</div><br/><div id="39153011" class="c"><input type="checkbox" id="c-39153011" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#39152077">root</a><span>|</span><a href="#39152402">parent</a><span>|</span><a href="#39152108">next</a><span>|</span><label class="collapse" for="c-39153011">[-]</label><label class="expand" for="c-39153011">[1 more]</label></div><br/><div class="children"><div class="content">If for example you have some pages that are used for 64b objects, and you merge them to be backed by the same physical page, and then the user allocates more 64b objects such that a 2nd physical page of 64b objects must be allocated, they&#x27;re now using 3 virtual pages for their 2 physical pages worth of 64b objects. With an allocator that does not point multiple virtual pages at the same physical page, they could only be using 2 virtual pages for their 64b objects.<p>So more TLB entries are not required immediately when pages are merged, they are required later when more objects are allocated. It&#x27;s certainly possible that I&#x27;ve misunderstood and the pages are actually un-merged by Mesh at this point so that new allocations can be served from the existing 2 half-full virtual pages (which are now backed by 2 separate half-full physical pages).</div><br/></div></div></div></div><div id="39152108" class="c"><input type="checkbox" id="c-39152108" checked=""/><div class="controls bullet"><span class="by">CyberDildonics</span><span>|</span><a href="#39152077">parent</a><span>|</span><a href="#39152402">prev</a><span>|</span><a href="#39152087">next</a><span>|</span><label class="collapse" for="c-39152108">[-]</label><label class="expand" for="c-39152108">[2 more]</label></div><br/><div class="children"><div class="content">Can you go in to more detail about that? Are any larger pages usable on windows?</div><br/><div id="39152174" class="c"><input type="checkbox" id="c-39152174" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#39152077">root</a><span>|</span><a href="#39152108">parent</a><span>|</span><a href="#39152087">next</a><span>|</span><label class="collapse" for="c-39152174">[-]</label><label class="expand" for="c-39152174">[1 more]</label></div><br/><div class="children"><div class="content">Using 2MB or 1GB pages on Windows involves changing security settings, rebooting the machine, and immediately launching the app you care about as administrator. If you ever close it, you&#x27;ll need to reboot again, because Windows will not try to rearrange 4KB pages to create new contiguous aligned physical 2MB or 1GB regions to back future requests for huge pages.</div><br/></div></div></div></div></div></div><div id="39152087" class="c"><input type="checkbox" id="c-39152087" checked=""/><div class="controls bullet"><span class="by">nu11ptr</span><span>|</span><a href="#39152077">prev</a><span>|</span><a href="#39152801">next</a><span>|</span><label class="collapse" for="c-39152087">[-]</label><label class="expand" for="c-39152087">[3 more]</label></div><br/><div class="children"><div class="content">Interesting, but if it decreases performance...why do it? I would have hoped cache locality would have beat out the increase due to copying, but per the article it doesn&#x27;t sound like the case.</div><br/><div id="39152379" class="c"><input type="checkbox" id="c-39152379" checked=""/><div class="controls bullet"><span class="by">emeryberger</span><span>|</span><a href="#39152087">parent</a><span>|</span><a href="#39152187">next</a><span>|</span><label class="collapse" for="c-39152379">[-]</label><label class="expand" for="c-39152379">[1 more]</label></div><br/><div class="children"><div class="content">Hi, Mesh co-author here. The point of the work was to save memory by “virtual compaction”; we hoped to be able to do this while not degrading performance too much, since compaction typically is quite costly. Our empirical results found that Mesh saves memory by between 16% to 39%, while imposing very modest slowdowns, e.g. 1% for Firefox (see Section 6 of the paper - <a href="https:&#x2F;&#x2F;people.cs.umass.edu&#x2F;~mcgregor&#x2F;papers&#x2F;19-pldi.pdf" rel="nofollow">https:&#x2F;&#x2F;people.cs.umass.edu&#x2F;~mcgregor&#x2F;papers&#x2F;19-pldi.pdf</a>).</div><br/></div></div></div></div><div id="39152801" class="c"><input type="checkbox" id="c-39152801" checked=""/><div class="controls bullet"><span class="by">diimdeep</span><span>|</span><a href="#39152087">prev</a><span>|</span><label class="collapse" for="c-39152801">[-]</label><label class="expand" for="c-39152801">[1 more]</label></div><br/><div class="children"><div class="content">Any software in the wild using this allocator since invention more than 6 year ago? <a href="https:&#x2F;&#x2F;github.com&#x2F;bpowers&#x2F;redis&#x2F;tree&#x2F;mesh">https:&#x2F;&#x2F;github.com&#x2F;bpowers&#x2F;redis&#x2F;tree&#x2F;mesh</a></div><br/></div></div></div></div></div></div></div></body></html>