<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1709197271225" as="style"/><link rel="stylesheet" href="styles.css?v=1709197271225"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/SFBdragon/talc">Talc – A fast and flexible allocator for no_std and WebAssembly</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>excsn</span> | <span>23 comments</span></div><br/><div><div id="39545958" class="c"><input type="checkbox" id="c-39545958" checked=""/><div class="controls bullet"><span class="by">tekacs</span><span>|</span><a href="#39545724">next</a><span>|</span><label class="collapse" for="c-39545958">[-]</label><label class="expand" for="c-39545958">[5 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve been using this recently in WASM, in particular for the counters feature. It&#x27;s really great and it makes it super easy to track and follow the evolution of your app&#x27;s memory!<p>In my console, I have something akin to this:<p><pre><code>  TRACE client_wasm::plugins::allocation: Memory stats counters=Counters { allocation_count: 165454, total_allocation_count: 18756119, allocated_bytes: 34654828, total_allocated_bytes: 3185258585, available_bytes: 82802636, fragment_count: 5026, heap_count: 1, total_heap_count: 1, claimed_bytes: 118423552, total_claimed_bytes: 118423552 }
</code></pre>
I haven&#x27;t carefully benchmarked dlmalloc (Rust&#x27;s default WASM allocator, <a href="https:&#x2F;&#x2F;github.com&#x2F;alexcrichton&#x2F;dlmalloc-rs">https:&#x2F;&#x2F;github.com&#x2F;alexcrichton&#x2F;dlmalloc-rs</a>), but it&#x27;s nothing special (to my knowledge). The swap to Talc is pretty trivial and it&#x27;s clear that the author is paying attention to its performance.</div><br/><div id="39547351" class="c"><input type="checkbox" id="c-39547351" checked=""/><div class="controls bullet"><span class="by">sfbea</span><span>|</span><a href="#39545958">parent</a><span>|</span><a href="#39546998">next</a><span>|</span><label class="collapse" for="c-39547351">[-]</label><label class="expand" for="c-39547351">[1 more]</label></div><br/><div class="children"><div class="content">[Author of talc] Glad this feature is proving useful. Seeing this makes me think I should implement a better-looking Display implementation than the default Debug impl though. Something for the next update ^-^</div><br/></div></div><div id="39546998" class="c"><input type="checkbox" id="c-39546998" checked=""/><div class="controls bullet"><span class="by">josephg</span><span>|</span><a href="#39545958">parent</a><span>|</span><a href="#39547351">prev</a><span>|</span><a href="#39545724">next</a><span>|</span><label class="collapse" for="c-39546998">[-]</label><label class="expand" for="c-39546998">[3 more]</label></div><br/><div class="children"><div class="content">Thats a pretty big heap size for a wasm bundle! What are you doing in wasm that allocates so much and so often?</div><br/><div id="39547120" class="c"><input type="checkbox" id="c-39547120" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#39545958">root</a><span>|</span><a href="#39546998">parent</a><span>|</span><a href="#39545724">next</a><span>|</span><label class="collapse" for="c-39547120">[-]</label><label class="expand" for="c-39547120">[2 more]</label></div><br/><div class="children"><div class="content">34 MB? Doesn&#x27;t seem that big to me.</div><br/><div id="39547310" class="c"><input type="checkbox" id="c-39547310" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#39545958">root</a><span>|</span><a href="#39547120">parent</a><span>|</span><a href="#39545724">next</a><span>|</span><label class="collapse" for="c-39547310">[-]</label><label class="expand" for="c-39547310">[1 more]</label></div><br/><div class="children"><div class="content">At least I was also confused too because I was looking at total_allocated_bytes, but I guess that includes allocations that have been freed.</div><br/></div></div></div></div></div></div></div></div><div id="39545724" class="c"><input type="checkbox" id="c-39545724" checked=""/><div class="controls bullet"><span class="by">gleenn</span><span>|</span><a href="#39545958">prev</a><span>|</span><a href="#39546145">next</a><span>|</span><label class="collapse" for="c-39545724">[-]</label><label class="expand" for="c-39545724">[10 more]</label></div><br/><div class="children"><div class="content">As a guy who lives in the JVM most days and mostly ignores allocation optimizations, what are some examples of things that are actually newer features in such a project? Isn&#x27;t allocation a mostly solved problem? Is something about WebAssembly or no_std actually requiring different features?</div><br/><div id="39545791" class="c"><input type="checkbox" id="c-39545791" checked=""/><div class="controls bullet"><span class="by">AnyTimeTraveler</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39547272">next</a><span>|</span><label class="collapse" for="c-39545791">[-]</label><label class="expand" for="c-39545791">[3 more]</label></div><br/><div class="children"><div class="content">In a no_std Rust environment, there is no allocator. There is no heap. So an allocator is needed to use things like Vectors or Strings.<p>This is very common in embedded contexts, where you can take nothing for granted.</div><br/><div id="39547140" class="c"><input type="checkbox" id="c-39547140" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#39545724">root</a><span>|</span><a href="#39545791">parent</a><span>|</span><a href="#39547272">next</a><span>|</span><label class="collapse" for="c-39547140">[-]</label><label class="expand" for="c-39547140">[2 more]</label></div><br/><div class="children"><div class="content">What&#x27;s the point of using `no_std` if you&#x27;re just going to add an allocator anyway? You may as well just use `std` at that point no? (You can use `std` on embedded devices with a small amount of work.)</div><br/><div id="39547237" class="c"><input type="checkbox" id="c-39547237" checked=""/><div class="controls bullet"><span class="by">thargor90</span><span>|</span><a href="#39545724">root</a><span>|</span><a href="#39547140">parent</a><span>|</span><a href="#39547272">next</a><span>|</span><label class="collapse" for="c-39547237">[-]</label><label class="expand" for="c-39547237">[1 more]</label></div><br/><div class="children"><div class="content">To get std you need some kind of libc replacement. You don&#x27;t need that if you just want to use alloc.</div><br/></div></div></div></div></div></div><div id="39547272" class="c"><input type="checkbox" id="c-39547272" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39545791">prev</a><span>|</span><a href="#39547069">next</a><span>|</span><label class="collapse" for="c-39547272">[-]</label><label class="expand" for="c-39547272">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s only a solved problem if you can live with the downsides of automatic memory management. For instance, do you know exactly how much time your garbage collector spends with memory management and when exactly that time is spent, where objects are located in memory relative to each other, and how much time is wasted on cache misses when accessing those objects? If those questions are not important, then automatic memory management is good enough. For other applications those questions may be more important, and automatic memory management is then usually harder to optimise than coming up with specialised manual allocation strategies.</div><br/></div></div><div id="39547069" class="c"><input type="checkbox" id="c-39547069" checked=""/><div class="controls bullet"><span class="by">eknkc</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39547272">prev</a><span>|</span><a href="#39545799">next</a><span>|</span><label class="collapse" for="c-39547069">[-]</label><label class="expand" for="c-39547069">[1 more]</label></div><br/><div class="children"><div class="content">I am also living with GC (mostly .net and go) but recently took a look at Zig.<p>Zig having allocators totally opaque is interesting and you get to learn a lot if you dig deeper. Tons of different designs. Allocators on top of allocators. Tiny ones for small bundles. Non deallocating ones for one shot apps. Stuff you never care about in a GC environment.<p>I suggest checking it out if it interests you.</div><br/></div></div><div id="39545799" class="c"><input type="checkbox" id="c-39545799" checked=""/><div class="controls bullet"><span class="by">nicoburns</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39547069">prev</a><span>|</span><a href="#39545914">next</a><span>|</span><label class="collapse" for="c-39545799">[-]</label><label class="expand" for="c-39545799">[1 more]</label></div><br/><div class="children"><div class="content">Small binary size (and thus a simpler implementation) are the min things you want for wasm and embedded targets. For wasm this is because its being sent over the network, for embedded because the device may have low amounts of available ram and storage.<p>It&#x27;s also the case that such targets often can&#x27;t take advantage of the advanced features (like multithreading optimisations) that &quot;full fat&quot; allocator provide.</div><br/></div></div><div id="39545914" class="c"><input type="checkbox" id="c-39545914" checked=""/><div class="controls bullet"><span class="by">nu11ptr</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39545799">prev</a><span>|</span><a href="#39545867">next</a><span>|</span><label class="collapse" for="c-39545914">[-]</label><label class="expand" for="c-39545914">[1 more]</label></div><br/><div class="children"><div class="content">An allocator and deallocator go hand in hand. For the JVM, most of the GCs are compacting so they can use bump allocators. In that case, yes, it is a solved problem. However, it depends on the alloator&#x2F;deallocator pair and traditional malloc&#x2F;free implementations involve many trade offs, so allocation work continues.</div><br/></div></div><div id="39545867" class="c"><input type="checkbox" id="c-39545867" checked=""/><div class="controls bullet"><span class="by">felipellrocha</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39545914">prev</a><span>|</span><a href="#39545871">next</a><span>|</span><label class="collapse" for="c-39545867">[-]</label><label class="expand" for="c-39545867">[1 more]</label></div><br/><div class="children"><div class="content">I’d say it’s solved if you want a garbage collector. If you don’t, then there is plenty of room for innovation</div><br/></div></div><div id="39545871" class="c"><input type="checkbox" id="c-39545871" checked=""/><div class="controls bullet"><span class="by">danlugo92</span><span>|</span><a href="#39545724">parent</a><span>|</span><a href="#39545867">prev</a><span>|</span><a href="#39546145">next</a><span>|</span><label class="collapse" for="c-39545871">[-]</label><label class="expand" for="c-39545871">[1 more]</label></div><br/><div class="children"><div class="content">Domain-neme preferring system such as...:<p>(Waiting for Surname&#x2F;p2p to get a hold on this...)</div><br/></div></div></div></div><div id="39546145" class="c"><input type="checkbox" id="c-39546145" checked=""/><div class="controls bullet"><span class="by">speps</span><span>|</span><a href="#39545724">prev</a><span>|</span><a href="#39546101">next</a><span>|</span><label class="collapse" for="c-39546145">[-]</label><label class="expand" for="c-39546145">[2 more]</label></div><br/><div class="children"><div class="content">Added a new issue [1] to add TLSF to the benchmarks as it&#x27;s likely going to be faster in a single-threaded environment according to the rlsf crate [2].<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;SFBdragon&#x2F;talc&#x2F;issues&#x2F;26">https:&#x2F;&#x2F;github.com&#x2F;SFBdragon&#x2F;talc&#x2F;issues&#x2F;26</a>
[2] <a href="https:&#x2F;&#x2F;github.com&#x2F;yvt&#x2F;rlsf">https:&#x2F;&#x2F;github.com&#x2F;yvt&#x2F;rlsf</a></div><br/><div id="39547369" class="c"><input type="checkbox" id="c-39547369" checked=""/><div class="controls bullet"><span class="by">sfbea</span><span>|</span><a href="#39546145">parent</a><span>|</span><a href="#39546101">next</a><span>|</span><label class="collapse" for="c-39547369">[-]</label><label class="expand" for="c-39547369">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for opening the issue. The allocator looks pretty interesting. Happy to try add it to the benchmarks, although doing apples-to-apples tests with its limitations might not be possible without some changes.</div><br/></div></div></div></div><div id="39545881" class="c"><input type="checkbox" id="c-39545881" checked=""/><div class="controls bullet"><span class="by">danlugo92</span><span>|</span><a href="#39546071">prev</a><span>|</span><label class="collapse" for="c-39545881">[-]</label><label class="expand" for="c-39545881">[1 more]</label></div><br/><div class="children"><div class="content">Anyone interested in only at stownAnnor, let me know otherwise it&#x27;s already known&#x2F;known :wink (:wink)...)......</div><br/></div></div></div></div></div></div></div></body></html>