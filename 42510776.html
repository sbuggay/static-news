<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1735203655002" as="style"/><link rel="stylesheet" href="styles.css?v=1735203655002"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.os2museum.com/wp/i-thought-i-found-a-bug/">I Thought I Found a Bug</a>Â <span class="domain">(<a href="https://www.os2museum.com">www.os2museum.com</a>)</span></div><div class="subtext"><span>MBCook</span> | <span>16 comments</span></div><br/><div><div id="42512511" class="c"><input type="checkbox" id="c-42512511" checked=""/><div class="controls bullet"><span class="by">anonymousiam</span><span>|</span><a href="#42513369">next</a><span>|</span><label class="collapse" for="c-42512511">[-]</label><label class="expand" for="c-42512511">[3 more]</label></div><br/><div class="children"><div class="content">While reading this, I realized that I have a copy of the elusive usr&#x2F;group Standard that the author mentions.  I just pulled it off an image of my early DOS hard drive (before I migrated to Linux in 1991).  I should probably post it somewhere.<p># ls -altr<p>total 540<p>-rw-r--r--   1 root  root   22606 Apr 12  1990 NOTES<p>-rw-r--r--   1 root  root  172645 Apr 12  1990 LIB<p>-rw-r--r--   1 root  root  102349 Apr 12  1990 APP<p>-rw-r--r--   1 root  root  224037 Apr 12  1990 C</div><br/><div id="42512597" class="c"><input type="checkbox" id="c-42512597" checked=""/><div class="controls bullet"><span class="by">codetrotter</span><span>|</span><a href="#42512511">parent</a><span>|</span><a href="#42513005">next</a><span>|</span><label class="collapse" for="c-42512597">[-]</label><label class="expand" for="c-42512597">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I should probably post it somewhere.<p>Upload it to the Internet Archive! :D<p><a href="https:&#x2F;&#x2F;help.archive.org&#x2F;help&#x2F;uploading-a-basic-guide&#x2F;" rel="nofollow">https:&#x2F;&#x2F;help.archive.org&#x2F;help&#x2F;uploading-a-basic-guide&#x2F;</a></div><br/></div></div><div id="42513005" class="c"><input type="checkbox" id="c-42513005" checked=""/><div class="controls bullet"><span class="by">xelxebar</span><span>|</span><a href="#42512511">parent</a><span>|</span><a href="#42512597">prev</a><span>|</span><a href="#42513369">next</a><span>|</span><label class="collapse" for="c-42513005">[-]</label><label class="expand" for="c-42513005">[1 more]</label></div><br/><div class="children"><div class="content">&gt; before I migrated to Linux in 1991<p>What a mic drop. That must have been a fun ride from then until now! Would love to hear some of your battle stories.</div><br/></div></div></div></div><div id="42513369" class="c"><input type="checkbox" id="c-42513369" checked=""/><div class="controls bullet"><span class="by">cryptonector</span><span>|</span><a href="#42512511">prev</a><span>|</span><a href="#42513251">next</a><span>|</span><label class="collapse" for="c-42513369">[-]</label><label class="expand" for="c-42513369">[1 more]</label></div><br/><div class="children"><div class="content">In the stdio implementations that don&#x27;t support free intermixing of reads and writes the issue typically is that there is only one buffer for both reading and writing.  You have to reset the buffer in order to switch from reading to writing or vice-versa, else you will have a dirty, non-empty buffer that does not correspond.  The functions `fflush()`, `fseek()`, `rewind()`, and `fsetpos()` happen to clear the buffer, which is why you have to use them before switching from reading to writing or vice-versa!<p>Without an indicator in `struct FILE` of whether the last operation was a read or a write, the stdio implementation has no way to detect the problem and correct the situation by automatically flushing and resetting the buffer, say.  An alternative would be to have two buffers, naturally.  But you can see how a pre-update version could be trivially made to support update modes without adding a second buffer or automatic buffer flushing.  And that&#x27;s almost certainly what happened when update mode was added.  My guess is someone got bitten by that and then the maintainer decided to just document the problem rather than fix it, probably because by then fixing the problem was hard.</div><br/></div></div><div id="42513251" class="c"><input type="checkbox" id="c-42513251" checked=""/><div class="controls bullet"><span class="by">raldi</span><span>|</span><a href="#42513369">prev</a><span>|</span><a href="#42512332">next</a><span>|</span><label class="collapse" for="c-42513251">[-]</label><label class="expand" for="c-42513251">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m having trouble following whether the problem occurs with any append or only when it&#x27;s two consecutive commands like this.</div><br/></div></div><div id="42512332" class="c"><input type="checkbox" id="c-42512332" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#42513251">prev</a><span>|</span><a href="#42512680">next</a><span>|</span><label class="collapse" for="c-42512332">[-]</label><label class="expand" for="c-42512332">[3 more]</label></div><br/><div class="children"><div class="content">I was a bit disappointed that the article didn&#x27;t go into the system calls themselves, since AFAIK those have always supported interleaved reads and writes with no problems even on early Unices. E.g. POSIX has this:<p><a href="https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799&#x2F;functions&#x2F;write.html" rel="nofollow">https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799&#x2F;functions&#x2F;w...</a><p><i>After a write() to a regular file has successfully returned:<p>Any successful read() from each byte position in the file that was modified by that write shall return the data specified by the write() for that position until such byte positions are again modified.</i></div><br/><div id="42512778" class="c"><input type="checkbox" id="c-42512778" checked=""/><div class="controls bullet"><span class="by">PeterWhittaker</span><span>|</span><a href="#42512332">parent</a><span>|</span><a href="#42512985">next</a><span>|</span><label class="collapse" for="c-42512778">[-]</label><label class="expand" for="c-42512778">[1 more]</label></div><br/><div class="children"><div class="content">Perhaps because the article is specifically about the buffered f*() calls in stdio, and not the system calls?<p>Though, as I offer that thought, the divergence between C and the system calls is definitely curious.</div><br/></div></div><div id="42512985" class="c"><input type="checkbox" id="c-42512985" checked=""/><div class="controls bullet"><span class="by">mystified5016</span><span>|</span><a href="#42512332">parent</a><span>|</span><a href="#42512778">prev</a><span>|</span><a href="#42512680">next</a><span>|</span><label class="collapse" for="c-42512985">[-]</label><label class="expand" for="c-42512985">[1 more]</label></div><br/><div class="children"><div class="content">I get a real kick out of the different ways people pluralize Unixen. Unices is a good one</div><br/></div></div></div></div><div id="42512680" class="c"><input type="checkbox" id="c-42512680" checked=""/><div class="controls bullet"><span class="by">purplesyringa</span><span>|</span><a href="#42512332">prev</a><span>|</span><label class="collapse" for="c-42512680">[-]</label><label class="expand" for="c-42512680">[7 more]</label></div><br/><div class="children"><div class="content">I must be missing something.<p>The article lists three libcs (Open Watcom, Microsoft Visual C++ 6.0, IBM C&#x2F;C++ 3.6 for Windows) from the good old times. Does the emulator link to Open Watcom, i.e., does it emulate DOS on machines about as old as DOS itself? What&#x27;s the point here?</div><br/><div id="42513593" class="c"><input type="checkbox" id="c-42513593" checked=""/><div class="controls bullet"><span class="by">justin_</span><span>|</span><a href="#42512680">parent</a><span>|</span><a href="#42512723">next</a><span>|</span><label class="collapse" for="c-42513593">[-]</label><label class="expand" for="c-42513593">[1 more]</label></div><br/><div class="children"><div class="content">I believe it is a bug in the the emulator&#x27;s implementation of COMMAND.COM. Often, these DOS &quot;emulators&quot; re-implement the standard commands of DOS, including the shell[1]. This is in addition to emulating weird 16-bit environment stuff and the BIOS.<p>The bug can pop up in any C program using stdio that assumes it&#x27;s fine to do `fread` followed immediately by `fwrite`. The spec forbids this. To make matters more confusing, this behavior does _not_ seem to be in modern libc implementations. Or at least, it works on my machine. I bet modern implementations are able to be more sane about managing different buffers for reading and writing.<p>The original COMMAND.COM from MS-DOS probably did not have this problem, since at least in some versions it was written in assembly[2]. Even for a shell written in C, the fix is pretty easy: seek the file before switching between reading&#x2F;writing.<p>The title of this post is confusing, since it clearly _is_ a bug somewhere. But I think the author was excited about possibly finding a bug in libc:<p>&gt; Sitting down with a debugger, I could just see how the C run-time library (Open Watcom) could be fixed to avoid this problem.<p>[1] Here&#x27;s DOSBox, for example: <a href="https:&#x2F;&#x2F;github.com&#x2F;dosbox-staging&#x2F;dosbox-staging&#x2F;blob&#x2F;main&#x2F;src&#x2F;shell&#x2F;shell_cmds.cpp">https:&#x2F;&#x2F;github.com&#x2F;dosbox-staging&#x2F;dosbox-staging&#x2F;blob&#x2F;main&#x2F;s...</a><p>[2] MS-DOS 4.0: <a href="https:&#x2F;&#x2F;github.com&#x2F;microsoft&#x2F;MS-DOS&#x2F;tree&#x2F;main&#x2F;v4.0&#x2F;src&#x2F;CMD&#x2F;COMMAND">https:&#x2F;&#x2F;github.com&#x2F;microsoft&#x2F;MS-DOS&#x2F;tree&#x2F;main&#x2F;v4.0&#x2F;src&#x2F;CMD&#x2F;C...</a></div><br/></div></div><div id="42512723" class="c"><input type="checkbox" id="c-42512723" checked=""/><div class="controls bullet"><span class="by">AntiRush</span><span>|</span><a href="#42512680">parent</a><span>|</span><a href="#42513593">prev</a><span>|</span><label class="collapse" for="c-42512723">[-]</label><label class="expand" for="c-42512723">[5 more]</label></div><br/><div class="children"><div class="content">The article is about compiling and running a program inside the emulator. When the unexpected behavior occurred, the author assumed it was a bug in the emulator.</div><br/><div id="42513266" class="c"><input type="checkbox" id="c-42513266" checked=""/><div class="controls bullet"><span class="by">purplesyringa</span><span>|</span><a href="#42512680">root</a><span>|</span><a href="#42512723">parent</a><span>|</span><label class="collapse" for="c-42513266">[-]</label><label class="expand" for="c-42513266">[4 more]</label></div><br/><div class="children"><div class="content">So if it&#x27;s not a bug in the emulator, then it&#x27;s a bug in COMMAND.COM? I don&#x27;t think that&#x27;s the case, surely it couldn&#x27;t have been missed by Microsoft at the time. The article goes on to talk about fread&#x2F;fwrite calls, but COMMAND.COM was written in assembly, I&#x27;m pretty sure it didn&#x27;t link to any libc, and certainly not to Open Watcom -- why would MS use it instead of their own library?</div><br/><div id="42513460" class="c"><input type="checkbox" id="c-42513460" checked=""/><div class="controls bullet"><span class="by">grodriguez100</span><span>|</span><a href="#42512680">root</a><span>|</span><a href="#42513266">parent</a><span>|</span><label class="collapse" for="c-42513460">[-]</label><label class="expand" for="c-42513460">[3 more]</label></div><br/><div class="children"><div class="content">It is not a bug. The article explains that this is the expected behaviour.</div><br/><div id="42513526" class="c"><input type="checkbox" id="c-42513526" checked=""/><div class="controls bullet"><span class="by">purplesyringa</span><span>|</span><a href="#42512680">root</a><span>|</span><a href="#42513460">parent</a><span>|</span><label class="collapse" for="c-42513526">[-]</label><label class="expand" for="c-42513526">[2 more]</label></div><br/><div class="children"><div class="content">What is expected behavior? Surely `echo AB&gt; foo.txt; echo CD&gt;&gt; foo.txt` producing `ABBC` is either a bug in COMMAND.COM, the emulator, or something else? That can&#x27;t be correct.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>