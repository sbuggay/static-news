<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1731574862022" as="style"/><link rel="stylesheet" href="styles.css?v=1731574862022"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://netflixtechblog.com/netflixs-distributed-counter-abstraction-8d0c45eb66b2">Netflix&#x27;s Distributed Counter Abstraction</a> <span class="domain">(<a href="https://netflixtechblog.com">netflixtechblog.com</a>)</span></div><div class="subtext"><span>benocodes</span> | <span>60 comments</span></div><br/><div><div id="42132013" class="c"><input type="checkbox" id="c-42132013" checked=""/><div class="controls bullet"><span class="by">notfried</span><span>|</span><a href="#42130271">next</a><span>|</span><label class="collapse" for="c-42132013">[-]</label><label class="expand" for="c-42132013">[21 more]</label></div><br/><div class="children"><div class="content">Netflix Engineering is probably far ahead of any other competitor streaming service, but I wonder how much the ROI is on that effort and cost. As a user, I don’t see much difference in reliability between Netflix, Disney, HBO, Hulu, Peacock and Paramount+. They all error out every now and then. Maybe 5-10 years ago you needed to be much more sophisticated because of lower bandwidth and less mature tech. Ultimately, the only real difference that makes me go for one service over the other is the content.</div><br/><div id="42133480" class="c"><input type="checkbox" id="c-42133480" checked=""/><div class="controls bullet"><span class="by">Galaco</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42133610">next</a><span>|</span><label class="collapse" for="c-42133480">[-]</label><label class="expand" for="c-42133480">[4 more]</label></div><br/><div class="children"><div class="content">All the money they spend still fails at basic UX, creating a finely crafted, polished turd of engineering perfection. I don&#x27;t see the Netflix experience to be superior in any way to the other big services; they all have their own issues that engineering haven&#x27;t solved properly, most likely some different ones.<p>An example (in this case ONE PIECE on Netflix Japan region):
My Netflix language is set to English, but I am not in an English speaking country. And yet, all shows have an English description and title, as well as episode lists with descriptions also in English. And yet, the program itself is not in English, nor does it have English audio options or subtitles. And the UI does not indicate if there are English subtitles until I play an episode and open the subtitles menu. This is compounded to be even worse when there are so many shows that are only half subtitled (different rights holders I assume). 
Why does the UI lie to me by showing everything about the series&#x2F;movie in my native language except the actual content itself? This is really common in non-English speaking regions, and it looks like a basic engineering failure of looking up their global database content in MY language while ignoring whether the actual CONTENT is available in my language. I suppose this could be a UX issue, but it also looks like an engineering one to me. And aren&#x27;t those intertwined to some extent anyway?</div><br/><div id="42134130" class="c"><input type="checkbox" id="c-42134130" checked=""/><div class="controls bullet"><span class="by">flakeoil</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42133480">parent</a><span>|</span><a href="#42134281">next</a><span>|</span><label class="collapse" for="c-42134130">[-]</label><label class="expand" for="c-42134130">[2 more]</label></div><br/><div class="children"><div class="content">I agree with your example and that this functionality sucks. However it cannot be an engineering issue as it must be technically very easy to implement in a better way. It must be a product&#x2F;UX&#x2F;marketing kind of decision behind it or just plain ignorance.</div><br/><div id="42134327" class="c"><input type="checkbox" id="c-42134327" checked=""/><div class="controls bullet"><span class="by">zoover2020</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42134130">parent</a><span>|</span><a href="#42134281">next</a><span>|</span><label class="collapse" for="c-42134327">[-]</label><label class="expand" for="c-42134327">[1 more]</label></div><br/><div class="children"><div class="content">This. There&#x27;s no technical limitations behind offering an A-Z catalog experience, it&#x27;s all decided by that VP of user experience who wants to squeeze the most amount of screen &#x2F; device time out of each user<p>Am I really alone to notice that each year, our collective UX across consumer (SaaS) software gets worse?</div><br/></div></div></div></div><div id="42134281" class="c"><input type="checkbox" id="c-42134281" checked=""/><div class="controls bullet"><span class="by">aprilthird2021</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42133480">parent</a><span>|</span><a href="#42134130">prev</a><span>|</span><a href="#42133610">next</a><span>|</span><label class="collapse" for="c-42134281">[-]</label><label class="expand" for="c-42134281">[1 more]</label></div><br/><div class="children"><div class="content">Netflix has far better UI&#x2F;UX and features than it&#x27;s competitors. I&#x27;m sure your specific issue is a legit one, but Netflix as a whole is much better</div><br/></div></div></div></div><div id="42133610" class="c"><input type="checkbox" id="c-42133610" checked=""/><div class="controls bullet"><span class="by">com2kid</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42133480">prev</a><span>|</span><a href="#42132590">next</a><span>|</span><label class="collapse" for="c-42133610">[-]</label><label class="expand" for="c-42133610">[1 more]</label></div><br/><div class="children"><div class="content">I worked at HBO Max when it launched. Less than 300 engineers, backend services written in either Node or Go. Mostly plain REST calls between services, fancier stuff was only used when there was a performance bottleneck.<p>The engineering was very thoughtful and the internal tooling was really good.<p>One underappreciated aspect of simply engineered systems is that they are simple to think about, simple to scale up, and simple to debug when something goes wrong.</div><br/></div></div><div id="42132590" class="c"><input type="checkbox" id="c-42132590" checked=""/><div class="controls bullet"><span class="by">brundolf</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42133610">prev</a><span>|</span><a href="#42133202">next</a><span>|</span><label class="collapse" for="c-42132590">[-]</label><label class="expand" for="c-42132590">[7 more]</label></div><br/><div class="children"><div class="content">I notice their front-end engineering (and design). The app experience has always been noticeably better than every other streaming service, which matters to me<p>It&#x27;s also possible that savings on infrastructure costs, reduced engineering hours spent on debugging, etc give them a quiet competitive advantage<p>Most engineering is not visible to the end-user</div><br/><div id="42134164" class="c"><input type="checkbox" id="c-42134164" checked=""/><div class="controls bullet"><span class="by">mark_and_sweep</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42132590">parent</a><span>|</span><a href="#42132775">next</a><span>|</span><label class="collapse" for="c-42134164">[-]</label><label class="expand" for="c-42134164">[1 more]</label></div><br/><div class="children"><div class="content">Lately, the user experience has gotten much worse for Windows users: In July they removed the ability to download content for offline viewing. So everyone who wants to watch content while travelling, for example, has no other option but to use a competitor like Prime Video.<p>I would also like to point out that those &quot;savings on infrastructure costs&quot; seemingly do not benefit their users: They have repeatedly increased prices over the past few years.<p>I&#x27;m also unsure whether they are using their competitive advantage properly. Anecdotally, it used to be that almost everyone I knew was only streaming on Netflix. These days, the streaming services that people use seem much more diverse.</div><br/></div></div><div id="42132775" class="c"><input type="checkbox" id="c-42132775" checked=""/><div class="controls bullet"><span class="by">lofaszvanitt</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42132590">parent</a><span>|</span><a href="#42134164">prev</a><span>|</span><a href="#42133202">next</a><span>|</span><label class="collapse" for="c-42132775">[-]</label><label class="expand" for="c-42132775">[5 more]</label></div><br/><div class="children"><div class="content">Their front end is just plain garbage. It does everything besides helping discovery of content. And people look up to Netflix like it&#x27;s some miracle thing.</div><br/><div id="42134042" class="c"><input type="checkbox" id="c-42134042" checked=""/><div class="controls bullet"><span class="by">assimpleaspossi</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42132775">parent</a><span>|</span><a href="#42133281">next</a><span>|</span><label class="collapse" for="c-42134042">[-]</label><label class="expand" for="c-42134042">[1 more]</label></div><br/><div class="children"><div class="content">That you don&#x27;t like how you have to use the Netflix interface has nothing to do with how it&#x27;s engineered.</div><br/></div></div><div id="42133281" class="c"><input type="checkbox" id="c-42133281" checked=""/><div class="controls bullet"><span class="by">thereisnospork</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42132775">parent</a><span>|</span><a href="#42134042">prev</a><span>|</span><a href="#42133202">next</a><span>|</span><label class="collapse" for="c-42133281">[-]</label><label class="expand" for="c-42133281">[3 more]</label></div><br/><div class="children"><div class="content">It is well engineered and meticulously manicured garbage though. In your example, the harder it is to discover content the easier it is to realize there is nothing new to watch. (Hence the rotating thumbnails, for a trivial example)</div><br/><div id="42133647" class="c"><input type="checkbox" id="c-42133647" checked=""/><div class="controls bullet"><span class="by">alexander2002</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42133281">parent</a><span>|</span><a href="#42133727">next</a><span>|</span><label class="collapse" for="c-42133647">[-]</label><label class="expand" for="c-42133647">[1 more]</label></div><br/><div class="children"><div class="content">One thing I hate about netflix that category recommendation also include other category stuff like Trending&#x2F;Recently watched etc 
I just want to watch some classical movies so plz show me your whole catalog of such movies I don&#x27;t use netflix often so this issue is more prominent for me atleast since I am not used to the UI bloat</div><br/></div></div><div id="42133727" class="c"><input type="checkbox" id="c-42133727" checked=""/><div class="controls bullet"><span class="by">lofaszvanitt</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42133281">parent</a><span>|</span><a href="#42133647">prev</a><span>|</span><a href="#42133202">next</a><span>|</span><label class="collapse" for="c-42133727">[-]</label><label class="expand" for="c-42133727">[1 more]</label></div><br/><div class="children"><div class="content">There is always a lot of good things to watch, but you have to dance around the idiotic recommendation system to find the hidden pearls. I&#x27;m sure there are a lot of good, talented people working there, but for what, when the frontend team kneecaps their work with the abysmal user interface.<p>And the best part... you chat with the support and they try to force a how to use our webpage shit on you when you want to report an annoying UI issue. It&#x27;s really mind boggling how a congregation of idiots with their heads up their asses runs that place.</div><br/></div></div></div></div></div></div></div></div><div id="42133202" class="c"><input type="checkbox" id="c-42133202" checked=""/><div class="controls bullet"><span class="by">paxys</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42132590">prev</a><span>|</span><a href="#42132745">next</a><span>|</span><label class="collapse" for="c-42133202">[-]</label><label class="expand" for="c-42133202">[1 more]</label></div><br/><div class="children"><div class="content">All of the services you mention have large engineering&#x2F;ops teams and similar monitoring systems in place. Their is absolutely an ROI on spending on reliability.</div><br/></div></div><div id="42132745" class="c"><input type="checkbox" id="c-42132745" checked=""/><div class="controls bullet"><span class="by">dheerkt</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42133202">prev</a><span>|</span><a href="#42133667">next</a><span>|</span><label class="collapse" for="c-42132745">[-]</label><label class="expand" for="c-42132745">[1 more]</label></div><br/><div class="children"><div class="content">Not an expert by any means but streaming HQ video is pretty expensive (even more so for live content), seems like the only providers that can do so profitably are YouTube and Netflix. I&#x27;m sure a big reason for that is the engineering (esp. CDN)</div><br/></div></div><div id="42132456" class="c"><input type="checkbox" id="c-42132456" checked=""/><div class="controls bullet"><span class="by">TZubiri</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42133667">prev</a><span>|</span><a href="#42132593">next</a><span>|</span><label class="collapse" for="c-42132456">[-]</label><label class="expand" for="c-42132456">[2 more]</label></div><br/><div class="children"><div class="content">The value of netflix is probably not only on its technical prowess and app experience, but it seems they are pretty involved in content direction through metrics. ¹ ²<p>Sources:<p>[1] <a href="https:&#x2F;&#x2F;youtu.be&#x2F;xL58d1l-6tA" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;xL58d1l-6tA</a><p>[2] <a href="https:&#x2F;&#x2F;youtu.be&#x2F;uFpK_r-jEXg" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;uFpK_r-jEXg</a></div><br/><div id="42133420" class="c"><input type="checkbox" id="c-42133420" checked=""/><div class="controls bullet"><span class="by">rhplus</span><span>|</span><a href="#42132013">root</a><span>|</span><a href="#42132456">parent</a><span>|</span><a href="#42132593">next</a><span>|</span><label class="collapse" for="c-42133420">[-]</label><label class="expand" for="c-42133420">[1 more]</label></div><br/><div class="children"><div class="content">Jury’s out on their content direction. They cancel great shows before the first season has even had a chance to permeate. It’s clear they have little interest in long term artistic investments.</div><br/></div></div></div></div><div id="42132593" class="c"><input type="checkbox" id="c-42132593" checked=""/><div class="controls bullet"><span class="by">parhamn</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42132456">prev</a><span>|</span><a href="#42132257">next</a><span>|</span><label class="collapse" for="c-42132593">[-]</label><label class="expand" for="c-42132593">[1 more]</label></div><br/><div class="children"><div class="content">Although, I agree with the general point, I am thankful for the bit of extra work they do when I travel abroad. The quality and availability of Netflix is far superior (many don&#x27;t even work outside the US).</div><br/></div></div><div id="42132257" class="c"><input type="checkbox" id="c-42132257" checked=""/><div class="controls bullet"><span class="by">l33t7332273</span><span>|</span><a href="#42132013">parent</a><span>|</span><a href="#42132593">prev</a><span>|</span><a href="#42133062">next</a><span>|</span><label class="collapse" for="c-42132257">[-]</label><label class="expand" for="c-42132257">[1 more]</label></div><br/><div class="children"><div class="content">I’ve thought this for a while, and it’s sad because I want to reward good tech. I usually think about this while I’m waiting for paramount to load for the third time because picture in picture has gone black again when I tried to full screen .</div><br/></div></div></div></div><div id="42130271" class="c"><input type="checkbox" id="c-42130271" checked=""/><div class="controls bullet"><span class="by">millipede</span><span>|</span><a href="#42132013">prev</a><span>|</span><a href="#42134025">next</a><span>|</span><label class="collapse" for="c-42130271">[-]</label><label class="expand" for="c-42130271">[6 more]</label></div><br/><div class="children"><div class="content">&gt; EVCache<p>EVCache is a disaster.  The code base has no concept of a threading model.   The code is almost completely untested* too.  I was on call at least 2 time when EVcache blew up on us.  I tried root causing it and the code is a rats nest.   Avoid!<p>* <a href="https:&#x2F;&#x2F;github.com&#x2F;Netflix&#x2F;EVCache">https:&#x2F;&#x2F;github.com&#x2F;Netflix&#x2F;EVCache</a></div><br/><div id="42132417" class="c"><input type="checkbox" id="c-42132417" checked=""/><div class="controls bullet"><span class="by">jolynch</span><span>|</span><a href="#42130271">parent</a><span>|</span><a href="#42131426">next</a><span>|</span><label class="collapse" for="c-42132417">[-]</label><label class="expand" for="c-42132417">[3 more]</label></div><br/><div class="children"><div class="content">(I work at Netflix on these Datastores)<p>EVCache definitely has some sharp edges and can be hard to use, which is one of the reasons we are putting it behind these gRPC abstractions like this Counter one or e.g. KeyValue [1] which offer CompletableFuture APIs with clean async and blocking modalities. We are also starting to add proper async APIs to EVCache itself e.g. getAsync [2] which the abstractions are using under-the-hood.<p>At the same time, EVCache is the cheapest (by about 10x in our experiments) caching solution with global replication [3] and cache warming [4] we are aware of. Every time we&#x27;ve tried alternatives like Redis or managed services they either fail to scale (e.g. cannot leverage flash storage effectively [5]) or cost waaay too much at our scale.<p>I absolutely agree though EVCache is probably the wrong choice for most folks - most folks aren&#x27;t doing 100 million operations &#x2F; second with 4-region full-active replication and applications that expect p50 client-side latency &lt;500us. Similar I think to how most folks should probably start with PostgreSQL and not Cassandra.<p>[1] <a href="https:&#x2F;&#x2F;netflixtechblog.com&#x2F;introducing-netflixs-key-value-data-abstraction-layer-1ea8a0a11b30" rel="nofollow">https:&#x2F;&#x2F;netflixtechblog.com&#x2F;introducing-netflixs-key-value-d...</a><p>[2] <a href="https:&#x2F;&#x2F;github.com&#x2F;Netflix&#x2F;EVCache&#x2F;blob&#x2F;11b47ecb4e15234ca99c19eb35c38a934433e8fd&#x2F;evcache-core&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;netflix&#x2F;evcache&#x2F;EVCache.java#L500">https:&#x2F;&#x2F;github.com&#x2F;Netflix&#x2F;EVCache&#x2F;blob&#x2F;11b47ecb4e15234ca99c...</a><p>[3] <a href="https:&#x2F;&#x2F;www.infoq.com&#x2F;articles&#x2F;netflix-global-cache&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.infoq.com&#x2F;articles&#x2F;netflix-global-cache&#x2F;</a><p>[4] <a href="https:&#x2F;&#x2F;netflixtechblog.medium.com&#x2F;cache-warming-leveraging-ebs-for-moving-petabytes-of-data-adcf7a4a78c3" rel="nofollow">https:&#x2F;&#x2F;netflixtechblog.medium.com&#x2F;cache-warming-leveraging-...</a><p>[5] <a href="https:&#x2F;&#x2F;netflixtechblog.com&#x2F;evolution-of-application-data-caching-from-ram-to-ssd-a33d6fa7a690" rel="nofollow">https:&#x2F;&#x2F;netflixtechblog.com&#x2F;evolution-of-application-data-ca...</a></div><br/><div id="42132865" class="c"><input type="checkbox" id="c-42132865" checked=""/><div class="controls bullet"><span class="by">lksajdl3lfkjasl</span><span>|</span><a href="#42130271">root</a><span>|</span><a href="#42132417">parent</a><span>|</span><a href="#42131426">next</a><span>|</span><label class="collapse" for="c-42132865">[-]</label><label class="expand" for="c-42132865">[2 more]</label></div><br/><div class="children"><div class="content">Curious to how your getting &lt;500us latencies. Connection pooling, GRPC?</div><br/><div id="42133143" class="c"><input type="checkbox" id="c-42133143" checked=""/><div class="controls bullet"><span class="by">jolynch</span><span>|</span><a href="#42130271">root</a><span>|</span><a href="#42132865">parent</a><span>|</span><a href="#42131426">next</a><span>|</span><label class="collapse" for="c-42133143">[-]</label><label class="expand" for="c-42133143">[1 more]</label></div><br/><div class="children"><div class="content">Every zone has a copy, and clients always read their local zone copy (via pooled memcached connections) first and fallback only once to another zone on miss. Key is staying in zone and memcached protocol plus super fast server latencies. It&#x27;s been a little while since we measured, but memcached has a time to first byte of around 10us and then scales sublinearly with payload size [1]. Single zone latency is variable but generally between 150 and 250us roundtrip, cross AZ is terrible at up to a millisecond [2].<p>So you put 200us network with 30us response time and get about 250us average latency. Of course the P99 tail is closer to a millisecond and you have to do things like hedges to fight things like the hard coded eternity 200ms TCP packet retry timer ... But that&#x27;s a whole other can of worms to talk about.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;Netflix-Skunkworks&#x2F;service-capacity-modeling&#x2F;blob&#x2F;0b25d596aaa4ea1fb485927714d183dabc40f593&#x2F;service_capacity_modeling&#x2F;models&#x2F;org&#x2F;netflix&#x2F;evcache.py#L53">https:&#x2F;&#x2F;github.com&#x2F;Netflix-Skunkworks&#x2F;service-capacity-model...</a><p>[2] <a href="https:&#x2F;&#x2F;jolynch.github.io&#x2F;pdf&#x2F;wlllb-apachecon-2022.pdf" rel="nofollow">https:&#x2F;&#x2F;jolynch.github.io&#x2F;pdf&#x2F;wlllb-apachecon-2022.pdf</a></div><br/></div></div></div></div></div></div><div id="42131426" class="c"><input type="checkbox" id="c-42131426" checked=""/><div class="controls bullet"><span class="by">jedberg</span><span>|</span><a href="#42130271">parent</a><span>|</span><a href="#42132417">prev</a><span>|</span><a href="#42131398">next</a><span>|</span><label class="collapse" for="c-42131426">[-]</label><label class="expand" for="c-42131426">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m surprised it&#x27;s still there!  It was built over a decade ago when I was still there.  At the time there were no other good solutions.<p>But Momento exists now.  It solves every problem EVCache was supposed to solve.<p>There are other options too.  They should retire it by now.</div><br/></div></div><div id="42131398" class="c"><input type="checkbox" id="c-42131398" checked=""/><div class="controls bullet"><span class="by">Alupis</span><span>|</span><a href="#42130271">parent</a><span>|</span><a href="#42131426">prev</a><span>|</span><a href="#42134025">next</a><span>|</span><label class="collapse" for="c-42131398">[-]</label><label class="expand" for="c-42131398">[1 more]</label></div><br/><div class="children"><div class="content">Can you elaborate?<p>From the looks of it, each module has plenty of tests - and the codebase is written in a spring&#x2F;boot style, making it fairly intuitive to navigate.</div><br/></div></div></div></div><div id="42134025" class="c"><input type="checkbox" id="c-42134025" checked=""/><div class="controls bullet"><span class="by">fire_lake</span><span>|</span><a href="#42130271">prev</a><span>|</span><a href="#42134145">next</a><span>|</span><label class="collapse" for="c-42134025">[-]</label><label class="expand" for="c-42134025">[2 more]</label></div><br/><div class="children"><div class="content">I think the design could have been simpler with Kafka (which they touched on briefly):<p>- Write counter changes to a Kafka topic with many partitions. The partition key is derived from the counter name.<p>- Use Kafka connect to push all counter events to S3 for audit and analysis.<p>- Write a Kafka consumer that reads events in batches and updates a persistent store with the current count.<p>- Pick a good Kafka message lifetime to ensure that topic size is kept under control, but data is not lost.<p>This gives us:<p>- Fast reads (count is precomputed, but potentially stale)<p>- Fast writes (Kafka)<p>- Correctness (every counter is assigned exactly one consumer)<p>- Durability (all state is in Kafka or the persistent store)<p>- Scalable storage and compute requirements over time<p>If I were to <i>really</i> go crazy with this, I would shard each counter further and use CRDTs to compute the total across all shards.</div><br/><div id="42134250" class="c"><input type="checkbox" id="c-42134250" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42134025">parent</a><span>|</span><a href="#42134145">next</a><span>|</span><label class="collapse" for="c-42134250">[-]</label><label class="expand" for="c-42134250">[1 more]</label></div><br/><div class="children"><div class="content">Yes, this is one of the approaches mentioned in the article and is indeed a valid approach. One thing to keep in mind is that we are already operating the TimeSeries service for a lot of other high ROI use cases within Netflix. There already exists a lot of automation to self-provision, configure, deploy and scale TimeSeries. There already exists automation to move data from Cassandra to S3&#x2F;Iceberg. We somewhat get all that for free. The Counter service is really just the Rollup layer on top of it. The Rollup operational nuances are just to give it that extra edge when it comes to accuracy and reliability.</div><br/></div></div></div></div><div id="42134145" class="c"><input type="checkbox" id="c-42134145" checked=""/><div class="controls bullet"><span class="by">bob1029</span><span>|</span><a href="#42134025">prev</a><span>|</span><a href="#42129481">next</a><span>|</span><label class="collapse" for="c-42134145">[-]</label><label class="expand" for="c-42134145">[1 more]</label></div><br/><div class="children"><div class="content">This seems a bit overcooked to me.<p>I suspect if I were to recursively ask &quot;why?&quot;, we may eventually wind up at some triviality (to the actual business&#x2F;customer) that could have easily gone another way and obviated the need for this abstraction in the first place.<p>Just thinking about the raw information, I don&#x27;t see how the average streaming media consumer produces more than a few hundred kb of useful data per month. I get that the <i>delivery</i> of the content is hard, but I dont see why we need to torture ourselves over the gathering of basic statistics.</div><br/></div></div><div id="42129481" class="c"><input type="checkbox" id="c-42129481" checked=""/><div class="controls bullet"><span class="by">mannyv</span><span>|</span><a href="#42134145">prev</a><span>|</span><a href="#42130124">next</a><span>|</span><label class="collapse" for="c-42129481">[-]</label><label class="expand" for="c-42129481">[3 more]</label></div><br/><div class="children"><div class="content">I wonder how they&#x27;re going to go about purging all the counters that end up unused once the employee and&#x2F;or team leaves?<p>I can see someone setting up a huge number of counters then leaving...and in a hundred years their counters are taking up TB of space and thousands of requests-per-second.</div><br/><div id="42129815" class="c"><input type="checkbox" id="c-42129815" checked=""/><div class="controls bullet"><span class="by">singron</span><span>|</span><a href="#42129481">parent</a><span>|</span><a href="#42130124">next</a><span>|</span><label class="collapse" for="c-42129815">[-]</label><label class="expand" for="c-42129815">[2 more]</label></div><br/><div class="children"><div class="content">There is a retention policy, so the raw events aren&#x27;t kept very long. The rollups probably compress really well in their time series database, which I&#x27;m guessing also has a retention policy.<p>If you have high cardinality metrics, it can still be really painful, although I think you will feel the pain initially and it won&#x27;t take years. Usually these systems have a way to inspect what metrics or counters are using the most resources and then they can be reduced or purged from time to time.</div><br/><div id="42130951" class="c"><input type="checkbox" id="c-42130951" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42129481">root</a><span>|</span><a href="#42129815">parent</a><span>|</span><a href="#42130124">next</a><span>|</span><label class="collapse" for="c-42130951">[-]</label><label class="expand" for="c-42130951">[1 more]</label></div><br/><div class="children"><div class="content">Yes, once the events are aggregated (and optionally moved to a cost-effective storage for audits), we don&#x27;t need them anymore in the primary storage. You can check the retention section in the article. The rollups themselves can have TTL if the users wish to set that on a namespace. Although doing that, they have to be fine with certain timing issues on when the rollups expire and new events are aggregated. We also have automation to truncate&#x2F;delete namespaces.</div><br/></div></div></div></div></div></div><div id="42130124" class="c"><input type="checkbox" id="c-42130124" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#42129481">prev</a><span>|</span><a href="#42130909">next</a><span>|</span><label class="collapse" for="c-42130124">[-]</label><label class="expand" for="c-42130124">[10 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a bit weird to not compare this to HyperLogLog &amp; similar techniques that are designed to solve exactly this problem but much more cheaply (at least as far as I understand).</div><br/><div id="42133479" class="c"><input type="checkbox" id="c-42133479" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42130124">parent</a><span>|</span><a href="#42130205">next</a><span>|</span><label class="collapse" for="c-42133479">[-]</label><label class="expand" for="c-42133479">[1 more]</label></div><br/><div class="children"><div class="content">Added a note on why we chose EvCache for the &quot;Best-Effort&quot; use-case instead of probabilistic data structures like HLL&#x2F;CMS. Appreciate the discussion.</div><br/></div></div><div id="42130205" class="c"><input type="checkbox" id="c-42130205" checked=""/><div class="controls bullet"><span class="by">zug_zug</span><span>|</span><a href="#42130124">parent</a><span>|</span><a href="#42133479">prev</a><span>|</span><a href="#42132250">next</a><span>|</span><label class="collapse" for="c-42130205">[-]</label><label class="expand" for="c-42130205">[4 more]</label></div><br/><div class="children"><div class="content">I came here to write the same thing. Getting an estimate accurate for at least 5 digits on all netflix video watches worldwide can all be done with intelligent sampling (like hyperloglog) and likely one macbook air as the backend. And aside from the compute save the complexity and implementation time would be much lower too.</div><br/><div id="42130915" class="c"><input type="checkbox" id="c-42130915" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42130205">parent</a><span>|</span><a href="#42132250">next</a><span>|</span><label class="collapse" for="c-42130915">[-]</label><label class="expand" for="c-42130915">[3 more]</label></div><br/><div class="children"><div class="content">Fwiw, we didn&#x27;t mention any probabilistic data structures because they don&#x27;t satisfy some of the basic requirements we had for the Best-Effort counter. HyperLogLog is designed for cardinality estimation, not for incrementing or decrementing specific counts (which in our case could be any arbitrary +ve&#x2F;-ve number per key). AFAIK, both Count-Min Sketch and HyperLogLog do not support clearing counts for specific keys. I believe Count-Min Sketch cannot support decrement as well. The core EvCache solution for the Best-Effort counter is like 5 lines of code. And EvCache can handle millions of operations&#x2F;second relatively cheaply.</div><br/><div id="42131964" class="c"><input type="checkbox" id="c-42131964" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42130915">parent</a><span>|</span><a href="#42132250">next</a><span>|</span><label class="collapse" for="c-42131964">[-]</label><label class="expand" for="c-42131964">[2 more]</label></div><br/><div class="children"><div class="content">Including this in the blog would have been helpful although I don’t think the decrement explanation is unsolvable - just have a second field for decrements that is incremented when you want to decrement &amp; then the final result is a sum of the two.</div><br/><div id="42132067" class="c"><input type="checkbox" id="c-42132067" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42131964">parent</a><span>|</span><a href="#42132250">next</a><span>|</span><label class="collapse" for="c-42132067">[-]</label><label class="expand" for="c-42132067">[1 more]</label></div><br/><div class="children"><div class="content">True. You could do decrements that way. We trimmed this article as the post is already quite long. But considering the multiple threads on this, we might add a few lines. There is also something to be said on operating data stores that support HLL or similar probabilistic data structures. Our goal is to build taller on what we already operate and deploy (like EvCache)</div><br/></div></div></div></div></div></div></div></div><div id="42132250" class="c"><input type="checkbox" id="c-42132250" checked=""/><div class="controls bullet"><span class="by">willcipriano</span><span>|</span><a href="#42130124">parent</a><span>|</span><a href="#42130205">prev</a><span>|</span><a href="#42130909">next</a><span>|</span><label class="collapse" for="c-42132250">[-]</label><label class="expand" for="c-42132250">[4 more]</label></div><br/><div class="children"><div class="content">Can you do a distributed HyperLogLog? Wouldn&#x27;t you have to have a single instance of it somewhere?</div><br/><div id="42132621" class="c"><input type="checkbox" id="c-42132621" checked=""/><div class="controls bullet"><span class="by">adgjlsfhk1</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42132250">parent</a><span>|</span><a href="#42130909">next</a><span>|</span><label class="collapse" for="c-42132621">[-]</label><label class="expand" for="c-42132621">[3 more]</label></div><br/><div class="children"><div class="content">hyperloglog distributes perfectly. Each node keeps track of the &quot;best&quot; hash, and then to query the global maximum, you just ask each node for their value.</div><br/><div id="42132862" class="c"><input type="checkbox" id="c-42132862" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42132621">parent</a><span>|</span><a href="#42130909">next</a><span>|</span><label class="collapse" for="c-42132862">[-]</label><label class="expand" for="c-42132862">[2 more]</label></div><br/><div class="children"><div class="content">Querying each instance can lead to availability and latency challenges. Moreover, HLL is not suited for tasks like increments&#x2F;decrements, TTLs on counts, and clearing of counts. Count-Min Sketch could work if we&#x27;re willing to forgo certain requirements like TTLs, but relying solely on in-memory data structures on every instance isn&#x27;t ideal (think about instance crashes, restarts, new code deployments etc.) Instead, using data stores that support HLL or Count-Min Sketch, like Redis, would offer better reliability. That said, we prefer to build on top of data stores we already operate. Also, the &quot;Best-Effort&quot; counter is literally 5 lines of code for EvCache. The bulk of the post focuses on &quot;Eventually Consistent Accurate&quot; counters, along with a way to track which systems sent the increments, which probabilistic counting is not ideal for.</div><br/><div id="42132917" class="c"><input type="checkbox" id="c-42132917" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42130124">root</a><span>|</span><a href="#42132862">parent</a><span>|</span><a href="#42130909">next</a><span>|</span><label class="collapse" for="c-42132917">[-]</label><label class="expand" for="c-42132917">[1 more]</label></div><br/><div class="children"><div class="content">Just to add, we are also trying to support idempotency wherever possible to enable safe hedging and retries. This is mentioned a bunch in the article on Accurate counters. So take that into consideration.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="42130909" class="c"><input type="checkbox" id="c-42130909" checked=""/><div class="controls bullet"><span class="by">dopamean</span><span>|</span><a href="#42130124">prev</a><span>|</span><a href="#42133657">next</a><span>|</span><label class="collapse" for="c-42130909">[-]</label><label class="expand" for="c-42130909">[4 more]</label></div><br/><div class="children"><div class="content">Why would netflix put their blog on medium?</div><br/><div id="42133552" class="c"><input type="checkbox" id="c-42133552" checked=""/><div class="controls bullet"><span class="by">lmm</span><span>|</span><a href="#42130909">parent</a><span>|</span><a href="#42131434">next</a><span>|</span><label class="collapse" for="c-42133552">[-]</label><label class="expand" for="c-42133552">[1 more]</label></div><br/><div class="children"><div class="content">Because it&#x27;s the least bad way to do a blog when you want to focus on the content.</div><br/></div></div><div id="42131434" class="c"><input type="checkbox" id="c-42131434" checked=""/><div class="controls bullet"><span class="by">jedberg</span><span>|</span><a href="#42130909">parent</a><span>|</span><a href="#42133552">prev</a><span>|</span><a href="#42133657">next</a><span>|</span><label class="collapse" for="c-42131434">[-]</label><label class="expand" for="c-42131434">[2 more]</label></div><br/><div class="children"><div class="content">Better distribution.  More people will read it there.</div><br/><div id="42133183" class="c"><input type="checkbox" id="c-42133183" checked=""/><div class="controls bullet"><span class="by">paxys</span><span>|</span><a href="#42130909">root</a><span>|</span><a href="#42131434">parent</a><span>|</span><a href="#42133657">next</a><span>|</span><label class="collapse" for="c-42133183">[-]</label><label class="expand" for="c-42133183">[1 more]</label></div><br/><div class="children"><div class="content">That was probably true 5 years ago, but today a large chunk of readers are going to be driven away by the intrusive popups and auth walls.</div><br/></div></div></div></div></div></div><div id="42133657" class="c"><input type="checkbox" id="c-42133657" checked=""/><div class="controls bullet"><span class="by">est</span><span>|</span><a href="#42130909">prev</a><span>|</span><a href="#42131539">next</a><span>|</span><label class="collapse" for="c-42133657">[-]</label><label class="expand" for="c-42133657">[1 more]</label></div><br/><div class="children"><div class="content">if anyone want a non-distributed but still very powerful counter service, I&#x27;d recommend Telegraf from Grafana or <a href="https:&#x2F;&#x2F;vector.dev&#x2F;" rel="nofollow">https:&#x2F;&#x2F;vector.dev&#x2F;</a></div><br/></div></div><div id="42131539" class="c"><input type="checkbox" id="c-42131539" checked=""/><div class="controls bullet"><span class="by">leakyabstxns</span><span>|</span><a href="#42133657">prev</a><span>|</span><a href="#42129973">next</a><span>|</span><label class="collapse" for="c-42131539">[-]</label><label class="expand" for="c-42131539">[3 more]</label></div><br/><div class="children"><div class="content">Given the complexity of the system, I&#x27;m curious to know how many people maintain this service</div><br/><div id="42131618" class="c"><input type="checkbox" id="c-42131618" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42131539">parent</a><span>|</span><a href="#42129973">next</a><span>|</span><label class="collapse" for="c-42131618">[-]</label><label class="expand" for="c-42131618">[2 more]</label></div><br/><div class="children"><div class="content">5 people (who also maintain a lot of other services like the linked TimeSeries service). The self-service to create new namespaces is pretty much autonomous (see attached link in the article on &quot;Provisioning&quot;). The stateless layer auto-scales up and down based on attached CPU&#x2F;Network-based scaling policies. The exports to audit stores can be scheduled at a cadence. The only intervention is when we have to scale the storage layer (although parts of it also automated using the same Provisioning workflow). I guess the other intervention is when we decide to change the configs (like number of queues) and trigger a re-deploy. But thats about it. So far, we have spent a very small percentage of our support budget for this.</div><br/></div></div></div></div><div id="42129973" class="c"><input type="checkbox" id="c-42129973" checked=""/><div class="controls bullet"><span class="by">ilrwbwrkhv</span><span>|</span><a href="#42131539">prev</a><span>|</span><label class="collapse" for="c-42129973">[-]</label><label class="expand" for="c-42129973">[8 more]</label></div><br/><div class="children"><div class="content">Looks a bit overengineered due to Netflix&#x27;s own microservices nonsense.<p>I would be more interested in how a higher traffic video company like Pornhub handles things like this.</div><br/><div id="42130564" class="c"><input type="checkbox" id="c-42130564" checked=""/><div class="controls bullet"><span class="by">Alupis</span><span>|</span><a href="#42129973">parent</a><span>|</span><a href="#42130455">next</a><span>|</span><label class="collapse" for="c-42130564">[-]</label><label class="expand" for="c-42130564">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Netflix&#x27;s own microservices nonsense<p>How many times has Netflix been entirely down over the years?<p>Seems it&#x27;s not &quot;nonesense&quot;.</div><br/></div></div><div id="42130455" class="c"><input type="checkbox" id="c-42130455" checked=""/><div class="controls bullet"><span class="by">philjohn</span><span>|</span><a href="#42129973">parent</a><span>|</span><a href="#42130564">prev</a><span>|</span><a href="#42130027">next</a><span>|</span><label class="collapse" for="c-42130455">[-]</label><label class="expand" for="c-42130455">[2 more]</label></div><br/><div class="children"><div class="content">Have you worked with distributed counters before? It&#x27;s a hard problem to solve. Typical tradeoffs are lower cardinality for exact counters.<p>The queue solution is pretty elegant.</div><br/><div id="42131234" class="c"><input type="checkbox" id="c-42131234" checked=""/><div class="controls bullet"><span class="by">ElevenLathe</span><span>|</span><a href="#42129973">root</a><span>|</span><a href="#42130455">parent</a><span>|</span><a href="#42130027">next</a><span>|</span><label class="collapse" for="c-42131234">[-]</label><label class="expand" for="c-42131234">[1 more]</label></div><br/><div class="children"><div class="content">The queuing reminds me of old &quot;tote board&quot; technology. I can&#x27;t find a reference easily but these were machines used to automatically figure and display parimutuel payouts at horse tracks. One particular kind of them would have the cashiers&#x27; terminals emit ball bearings on a track back at the central (digital but electromechanical) counter for each betting pool. This arrangement allowed the cashiers to sell as fast as they liked without jamming the works, and then allowed the calculation&#x2F;display of odds to be &quot;eventually consistent&quot;.</div><br/></div></div></div></div><div id="42130027" class="c"><input type="checkbox" id="c-42130027" checked=""/><div class="controls bullet"><span class="by">oreoftw</span><span>|</span><a href="#42129973">parent</a><span>|</span><a href="#42130455">prev</a><span>|</span><label class="collapse" for="c-42130027">[-]</label><label class="expand" for="c-42130027">[4 more]</label></div><br/><div class="children"><div class="content">How would you design it to support mentioned use cases?</div><br/><div id="42130241" class="c"><input type="checkbox" id="c-42130241" checked=""/><div class="controls bullet"><span class="by">klaussilveira</span><span>|</span><a href="#42129973">root</a><span>|</span><a href="#42130027">parent</a><span>|</span><label class="collapse" for="c-42130241">[-]</label><label class="expand" for="c-42130241">[3 more]</label></div><br/><div class="children"><div class="content">HyperLogLog and PostgreSQL: <a href="https:&#x2F;&#x2F;github.com&#x2F;citusdata&#x2F;postgresql-hll">https:&#x2F;&#x2F;github.com&#x2F;citusdata&#x2F;postgresql-hll</a><p>Or even simpler, Roaring Bitmaps: <a href="https:&#x2F;&#x2F;pncnmnp.github.io&#x2F;blogs&#x2F;roaring-bitmaps.html" rel="nofollow">https:&#x2F;&#x2F;pncnmnp.github.io&#x2F;blogs&#x2F;roaring-bitmaps.html</a><p><a href="https:&#x2F;&#x2F;blog.quastor.org&#x2F;p&#x2F;grab-rate-limiting" rel="nofollow">https:&#x2F;&#x2F;blog.quastor.org&#x2F;p&#x2F;grab-rate-limiting</a><p><a href="https:&#x2F;&#x2F;github.com&#x2F;RoaringBitmap&#x2F;CRoaring">https:&#x2F;&#x2F;github.com&#x2F;RoaringBitmap&#x2F;CRoaring</a></div><br/><div id="42130466" class="c"><input type="checkbox" id="c-42130466" checked=""/><div class="controls bullet"><span class="by">philjohn</span><span>|</span><a href="#42129973">root</a><span>|</span><a href="#42130241">parent</a><span>|</span><label class="collapse" for="c-42130466">[-]</label><label class="expand" for="c-42130466">[2 more]</label></div><br/><div class="children"><div class="content">HyperLogLog doesn&#x27;t support exact counters though, does it? That seems to be one of the core requirements of the queue-based solution.</div><br/><div id="42131068" class="c"><input type="checkbox" id="c-42131068" checked=""/><div class="controls bullet"><span class="by">rshrin</span><span>|</span><a href="#42129973">root</a><span>|</span><a href="#42130466">parent</a><span>|</span><label class="collapse" for="c-42131068">[-]</label><label class="expand" for="c-42131068">[1 more]</label></div><br/><div class="children"><div class="content">HyperLogLog (or even Count-Min Sketch) will not support some of the requirements of even the Best-Effort counter (clearing counts for specific keys, decrementing counts by any arbitrary number, having a TTL on counts etc.). For Accurate counters, we are trying to solve for multi-region read&#x2F;write availability at low single-digit millisecond latency at cheap costs, using the infrastructure we already operate and deploy. There are also other requirements such as tracking the provenance of increments, which play a part.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>