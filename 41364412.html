<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1724749263960" as="style"/><link rel="stylesheet" href="styles.css?v=1724749263960"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://rustdate.over-yonder.net/">FreeBSD-rustdate, a reimplementation of FreeBSD-update</a>Â <span class="domain">(<a href="https://rustdate.over-yonder.net">rustdate.over-yonder.net</a>)</span></div><div class="subtext"><span>ggm</span> | <span>9 comments</span></div><br/><div><div id="41364860" class="c"><input type="checkbox" id="c-41364860" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#41365089">next</a><span>|</span><label class="collapse" for="c-41364860">[-]</label><label class="expand" for="c-41364860">[2 more]</label></div><br/><div class="children"><div class="content">Thank you, thank you. I haven&#x27;t reviewed this, and I may or may not use it, but wow was freebsd-update from 13.0 to 14.0 slow, especially since I run my freebsd systems off spinning drives, and most of them have src.<p>I did some looking at freebsd-update, and it&#x27;s quite the shell script, which makes it daunting to consider changing. All the forking and whatever doesn&#x27;t seem great; using data structures should be a lot simpler!<p>But my systems running freebsd-update spend an awful lot of time on I&#x2F;O, and not so much time on cpu, as I recall. I think the general flow for a replaced file is gunzip to the update dir, then install to the destination. This means all the files are written twice, and I thought there was a third write that I can&#x27;t remember at the moment. Install doesn&#x27;t have an option to decompress, but it&#x27;d be super handy if it did --- then you could write the file only once to the destination directory and move it into place.<p>I&#x27;m never a fan of quite as many files in a directory as freebsd-update gets up to either. Given that everything is already named by hashes, it&#x27;s not too hard to have 16 or 256 directories named 0-f or 00-ff that get a slice of the files. Large directories have gotten better over time, but they&#x27;re still slow.<p>There&#x27;s some ability to exploit the embarassing parallelism available too, but that&#x27;s hard in a complex shell script, so some other environment makes sense. I didn&#x27;t look, but hopefully that&#x27;s a knob in rustdate ... Sometimes you&#x27;d want it and other times one thing at a time is better, even when it&#x27;s slow.<p>One feature I know update can do that I want to look at more but haven&#x27;t had time is the zfs boot environment stuff --- seems like with the right arguments you could do the update on an inactive environment and reboot to switch, instead of the default way which does the install on the live environment but you could reboot to switch back. I&#x27;d be much more patient if the live environment continued working and I could reboot at my convenience once the process finished. Especially if I might be able to run pkg upgrade in the boot environment before the reboot. If rustdate supports that too, that&#x27;d be neat.</div><br/><div id="41365613" class="c"><input type="checkbox" id="c-41365613" checked=""/><div class="controls bullet"><span class="by">deaddodo</span><span>|</span><a href="#41364860">parent</a><span>|</span><a href="#41365089">next</a><span>|</span><label class="collapse" for="c-41365613">[-]</label><label class="expand" for="c-41365613">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I did some looking at freebsd-update, and it&#x27;s quite the shell script, which makes it daunting to consider changing. All the forking and whatever doesn&#x27;t seem great; using data structures should be a lot simpler!<p>It doesn&#x27;t look too crazy:<p><a href="https:&#x2F;&#x2F;github.com&#x2F;freebsd&#x2F;freebsd-src&#x2F;blob&#x2F;main&#x2F;usr.sbin&#x2F;freebsd-update&#x2F;freebsd-update.sh">https:&#x2F;&#x2F;github.com&#x2F;freebsd&#x2F;freebsd-src&#x2F;blob&#x2F;main&#x2F;usr.sbin&#x2F;fr...</a><p>It&#x27;s fairly well broken down, and pretty well organized. I think the most difficult part is that so much of it relies on shell nice-isms that are a pain to re-implement in something like C (although, I guess you could just call fetch and the like directly via &#x27;exec&#x27; or &#x27;system&#x27;; rather than using their libraries to manage things directly).</div><br/></div></div></div></div><div id="41365089" class="c"><input type="checkbox" id="c-41365089" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#41364860">prev</a><span>|</span><label class="collapse" for="c-41365089">[-]</label><label class="expand" for="c-41365089">[6 more]</label></div><br/><div class="children"><div class="content">Would you mind mirroring to a repo, with a license, so others might view?</div><br/><div id="41365271" class="c"><input type="checkbox" id="c-41365271" checked=""/><div class="controls bullet"><span class="by">jeroenhd</span><span>|</span><a href="#41365089">parent</a><span>|</span><a href="#41365494">next</a><span>|</span><label class="collapse" for="c-41365271">[-]</label><label class="expand" for="c-41365271">[1 more]</label></div><br/><div class="children"><div class="content">The license:<p>---<p>Copyright 2024 Matthew D. Fuller  &lt;fullermd@over-yonder.net&gt;<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:<p>1. Redistributions of source code must retain the above copyright notice,
   this list of conditions and the following disclaimer.<p>2. Redistributions in binary form must reproduce the above copyright
   notice, this list of conditions and the following disclaimer in the
   documentation and&#x2F;or other materials provided with the distribution.<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS
IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<p>---</div><br/></div></div><div id="41365494" class="c"><input type="checkbox" id="c-41365494" checked=""/><div class="controls bullet"><span class="by">erk__</span><span>|</span><a href="#41365089">parent</a><span>|</span><a href="#41365271">prev</a><span>|</span><a href="#41365129">next</a><span>|</span><label class="collapse" for="c-41365494">[-]</label><label class="expand" for="c-41365494">[1 more]</label></div><br/><div class="children"><div class="content">It is on Launchpad here: <a href="https:&#x2F;&#x2F;launchpad.net&#x2F;freebsd-rustdate" rel="nofollow">https:&#x2F;&#x2F;launchpad.net&#x2F;freebsd-rustdate</a></div><br/></div></div><div id="41365129" class="c"><input type="checkbox" id="c-41365129" checked=""/><div class="controls bullet"><span class="by">stackghost</span><span>|</span><a href="#41365089">parent</a><span>|</span><a href="#41365494">prev</a><span>|</span><label class="collapse" for="c-41365129">[-]</label><label class="expand" for="c-41365129">[3 more]</label></div><br/><div class="children"><div class="content">The source tarball, on the downloads page, contains a license.</div><br/><div id="41365172" class="c"><input type="checkbox" id="c-41365172" checked=""/><div class="controls bullet"><span class="by">ThePowerOfFuet</span><span>|</span><a href="#41365089">root</a><span>|</span><a href="#41365129">parent</a><span>|</span><label class="collapse" for="c-41365172">[-]</label><label class="expand" for="c-41365172">[2 more]</label></div><br/><div class="children"><div class="content">Shouldn&#x27;t have to download and unpack a tarball to see how it&#x27;s licensed.</div><br/><div id="41365341" class="c"><input type="checkbox" id="c-41365341" checked=""/><div class="controls bullet"><span class="by">stackghost</span><span>|</span><a href="#41365089">root</a><span>|</span><a href="#41365172">parent</a><span>|</span><label class="collapse" for="c-41365341">[-]</label><label class="expand" for="c-41365341">[1 more]</label></div><br/><div class="children"><div class="content">This seems like a real &quot;beggars being choosers&quot; situation.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>