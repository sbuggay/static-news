<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1719046861062" as="style"/><link rel="stylesheet" href="styles.css?v=1719046861062"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://lwn.net/Articles/978010/">Memory sealing for the GNU C Library</a> <span class="domain">(<a href="https://lwn.net">lwn.net</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>11 comments</span></div><br/><div><div id="40756949" class="c"><input type="checkbox" id="c-40756949" checked=""/><div class="controls bullet"><span class="by">CGamesPlay</span><span>|</span><a href="#40757313">next</a><span>|</span><label class="collapse" for="c-40756949">[-]</label><label class="expand" for="c-40756949">[3 more]</label></div><br/><div class="children"><div class="content">I was struggling to figure out how this could even be exploited. Following a trail of links led to &lt;<a href="https:&#x2F;&#x2F;v8.dev&#x2F;blog&#x2F;control-flow-integrity#corrupted-syscall-arguments" rel="nofollow">https:&#x2F;&#x2F;v8.dev&#x2F;blog&#x2F;control-flow-integrity#corrupted-syscall...</a>&gt;, which motivated the API. It gives the example that &quot;if a thread calls munmap on a corrupted pointer, the attacker could unmap read-only pages and a consecutive mmap call can reuse this address, effectively adding write permissions to the page.&quot;<p>So, a hypotetical attack would involve 1) Corrupt a pointer passed to munmap, such that it points to some believed-executable part of the code (e.g. the MPEG decompression library code, or something like that). 2) Cause a future `mmap` to reuse that page with writable permissions, and in particular have the returned page be one that is eventually destined for being marked executable (e.g. the caller should be the JIT compiler). 3) Modify the writable page to control code you want at a known address (e.g. by having the JIT emit code you want, or by having another vulnerability that writes to this address). 4) Have the target page marked executable (e.g. by finishing the JIT compilation). 5) Finally, call the executable page (e.g. attempt to decompress an MPEG file).<p>In the absence of already having arbitrary code execution (which would make the whole process moot), this whole thing requires a JIT compiler (since it has to already contain a call to `mprotect` that sets a page executable), and either the JIT compiler has a bug or a separate thread performs step 3.<p>Are there any example of this kind of attack actually happening? Is there a simpler attack I&#x27;m not seeing?</div><br/><div id="40757305" class="c"><input type="checkbox" id="c-40757305" checked=""/><div class="controls bullet"><span class="by">htthbjk</span><span>|</span><a href="#40756949">parent</a><span>|</span><a href="#40757313">next</a><span>|</span><label class="collapse" for="c-40757305">[-]</label><label class="expand" for="c-40757305">[2 more]</label></div><br/><div class="children"><div class="content">Sometimes you do get arbitrary code execution, but you are in a Chrome sandbox.<p>One use of mseal is for defense in depth, where you try making it as hard as possible to un-sandbox the sandbox.</div><br/><div id="40757441" class="c"><input type="checkbox" id="c-40757441" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#40756949">root</a><span>|</span><a href="#40757305">parent</a><span>|</span><a href="#40757313">next</a><span>|</span><label class="collapse" for="c-40757441">[-]</label><label class="expand" for="c-40757441">[1 more]</label></div><br/><div class="children"><div class="content">mseal is not designed to protect against sandbox escapes</div><br/></div></div></div></div></div></div><div id="40757313" class="c"><input type="checkbox" id="c-40757313" checked=""/><div class="controls bullet"><span class="by">snickerbockers</span><span>|</span><a href="#40756949">prev</a><span>|</span><a href="#40756799">next</a><span>|</span><label class="collapse" for="c-40757313">[-]</label><label class="expand" for="c-40757313">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;m a little confused, can&#x27;t you already clear the page&#x27;s write flag with mprotect?  i feel like I must missing some important detail because iiuc mseal doesn&#x27;t bring anything new to the table.</div><br/><div id="40757385" class="c"><input type="checkbox" id="c-40757385" checked=""/><div class="controls bullet"><span class="by">winternewt</span><span>|</span><a href="#40757313">parent</a><span>|</span><a href="#40757403">next</a><span>|</span><label class="collapse" for="c-40757385">[-]</label><label class="expand" for="c-40757385">[1 more]</label></div><br/><div class="children"><div class="content">The detail is that mprotect also lets you add the writable flag back. With mseal the kernel will refuse future changes to the protection flags.</div><br/></div></div><div id="40757403" class="c"><input type="checkbox" id="c-40757403" checked=""/><div class="controls bullet"><span class="by">superb_dev</span><span>|</span><a href="#40757313">parent</a><span>|</span><a href="#40757385">prev</a><span>|</span><a href="#40757412">next</a><span>|</span><label class="collapse" for="c-40757403">[-]</label><label class="expand" for="c-40757403">[1 more]</label></div><br/><div class="children"><div class="content">I believe the difference is that ‘mseal’ goes further than preventing any writes to memory, it also prevents the address space itself from changing. For example: if some file had been ‘mmap’ed in before the call to ‘mseal’, it can’t then be unmapped</div><br/></div></div><div id="40757412" class="c"><input type="checkbox" id="c-40757412" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#40757313">parent</a><span>|</span><a href="#40757403">prev</a><span>|</span><a href="#40756799">next</a><span>|</span><label class="collapse" for="c-40757412">[-]</label><label class="expand" for="c-40757412">[1 more]</label></div><br/><div class="children"><div class="content">mseal prevents you from doing that in reverse.</div><br/></div></div></div></div><div id="40756799" class="c"><input type="checkbox" id="c-40756799" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#40757313">prev</a><span>|</span><label class="collapse" for="c-40756799">[-]</label><label class="expand" for="c-40756799">[3 more]</label></div><br/><div class="children"><div class="content">I’m curious if a msealed region can have breakpoints placed in it.</div><br/><div id="40757431" class="c"><input type="checkbox" id="c-40757431" checked=""/><div class="controls bullet"><span class="by">ilammy</span><span>|</span><a href="#40756799">parent</a><span>|</span><a href="#40757331">next</a><span>|</span><label class="collapse" for="c-40757431">[-]</label><label class="expand" for="c-40757431">[1 more]</label></div><br/><div class="children"><div class="content">Yes, breakpoints will still work. Debuggers generally use POKETEXT to write breakpoints, which ignores any write protection on pages. mseal does not affect this use case.</div><br/></div></div><div id="40757331" class="c"><input type="checkbox" id="c-40757331" checked=""/><div class="controls bullet"><span class="by">snickerbockers</span><span>|</span><a href="#40756799">parent</a><span>|</span><a href="#40757431">prev</a><span>|</span><label class="collapse" for="c-40757331">[-]</label><label class="expand" for="c-40757331">[1 more]</label></div><br/><div class="children"><div class="content">that&#x27;s an interesting point.  i know at the kernel level gdb supports hardware breaks that don&#x27;t need to add in the trap instruction but I&#x27;m not sure if those are available to user-mode processes.</div><br/></div></div></div></div></div></div></div></div></div></body></html>