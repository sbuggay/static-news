<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1698310857959" as="style"/><link rel="stylesheet" href="styles.css?v=1698310857959"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts">Oh-Auth – Abusing OAuth to take over millions of accounts</a> <span class="domain">(<a href="https://salt.security">salt.security</a>)</span></div><div class="subtext"><span>skilled</span> | <span>22 comments</span></div><br/><div><div id="38023270" class="c"><input type="checkbox" id="c-38023270" checked=""/><div class="controls bullet"><span class="by">davedx</span><span>|</span><a href="#38022233">next</a><span>|</span><label class="collapse" for="c-38023270">[-]</label><label class="expand" for="c-38023270">[1 more]</label></div><br/><div class="children"><div class="content">Another issue with OAuth is the assumption that the browser part of the flow (where the real user enters their username and password on the issuer website) is actually done by a real user. When I was trying to automate EV charging, I looked at quite a few OAuth implementations and many of them were doing things like storing the user&#x27;s credentials (including their password) then doing the entire OAuth flow with browser automation. I imagine this was the tip of the iceberg.<p>These days with a lot of non-standards-compliant OAuth implementations behind me, my conclusion is a lot of it is a giant waste of time, and it often adds completely pointless complexity for many of the cases it&#x27;s used for. And as shown in the article, all the complexity often adds exploit vectors.<p>For 90% of API use cases just issue a revokable Bearer Token and be done with it. You are not an app platform!!!<p>[Qualifier: the EV API&#x27;s I experimented with <i>were</i> a good use-case for OAuth, as they were user-first, based on mobile apps authenticated with user&#x2F;password credentials. But I&#x27;ve worked with a lot of third party vendor API&#x27;s where it was purely server-to-server access, but for some reason wrapped in OAuth... because... architects and compliance something something]</div><br/></div></div><div id="38022233" class="c"><input type="checkbox" id="c-38022233" checked=""/><div class="controls bullet"><span class="by">TazeTSchnitzel</span><span>|</span><a href="#38023270">prev</a><span>|</span><a href="#38022959">next</a><span>|</span><label class="collapse" for="c-38022233">[-]</label><label class="expand" for="c-38022233">[10 more]</label></div><br/><div class="children"><div class="content">&gt; Vidio, an online streaming platform with 100 million monthly active users, the researchers found that when logging into the site through Facebook, the site did not verify the token — which the website developers and not OAuth must do. Because of this, an attacker could manipulate the API calls to insert an access token generated for a different application, the researchers found.<p>How does this work? I thought the token was an opaque hex string and only had meaning when sent back to the original server?</div><br/><div id="38022536" class="c"><input type="checkbox" id="c-38022536" checked=""/><div class="controls bullet"><span class="by">caseysoftware</span><span>|</span><a href="#38022233">parent</a><span>|</span><a href="#38022493">next</a><span>|</span><label class="collapse" for="c-38022536">[-]</label><label class="expand" for="c-38022536">[4 more]</label></div><br/><div class="children"><div class="content">The token <i>can</i> be a opaque string but doesn&#x27;t have to be. Often, it&#x27;s a JWT which can be decoded, validated, and used locally without a trip to the auth server.<p>It looks like Vidio, etc validated the signature of the JWT properly but didn&#x27;t check the &quot;aud&quot; or audience claim, which defines who should use it. Therefore, it was a valid token, it was for the target user, but the token itself wasn&#x27;t for Vidio.<p>It&#x27;s the equivalent of buying a ticket for a United Airlines flight, going to the airport, and United letting you get on ANY flight because you have a valid ticket.<p><i>Background: I helped build the Okta OAuth product (not related to the breaches) and I&#x27;m the author of the top OAuth&#x2F;OIDC course on linkedIn.</i></div><br/><div id="38022672" class="c"><input type="checkbox" id="c-38022672" checked=""/><div class="controls bullet"><span class="by">withinboredom</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022536">parent</a><span>|</span><a href="#38022923">next</a><span>|</span><label class="collapse" for="c-38022672">[-]</label><label class="expand" for="c-38022672">[1 more]</label></div><br/><div class="children"><div class="content">Heh, this is exactly how I got on the wrong flight once (the gate changed and I didn’t realize it), the machine didn’t tell the person I was getting on the wrong flight and the attendant didn’t notice.<p>The only reason I discovered I was on the flight is because someone else had a ticket for my seat. The security people were very curious how I did it. But now you can’t do that any more.</div><br/></div></div><div id="38022923" class="c"><input type="checkbox" id="c-38022923" checked=""/><div class="controls bullet"><span class="by">magicalhippo</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022536">parent</a><span>|</span><a href="#38022672">prev</a><span>|</span><a href="#38022493">next</a><span>|</span><label class="collapse" for="c-38022923">[-]</label><label class="expand" for="c-38022923">[2 more]</label></div><br/><div class="children"><div class="content">Not just aud, but also issuer and you should check it was signed by a proper certificate no?<p><a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;entra&#x2F;identity-platform&#x2F;access-tokens#validate-tokens" rel="nofollow noreferrer">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;entra&#x2F;identity-platform&#x2F;ac...</a></div><br/><div id="38022966" class="c"><input type="checkbox" id="c-38022966" checked=""/><div class="controls bullet"><span class="by">vladvasiliu</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022923">parent</a><span>|</span><a href="#38022493">next</a><span>|</span><label class="collapse" for="c-38022966">[-]</label><label class="expand" for="c-38022966">[1 more]</label></div><br/><div class="children"><div class="content">Indeed.<p>In my case, I was initially confused by the fact that in most examples (specifically for Azure AD, which is what I&#x27;ve used), they give you an access token <i>for another app</i>, here MS Graph API. It specifically says you&#x27;re not supposed to read that access token, so you can&#x27;t validate it. You should use the ID token instead (which can be validated), but in the default configuration, the ID token doesn&#x27;t carry much information, so you need to call the `userinfo` endpoint with said opaque access token.</div><br/></div></div></div></div></div></div><div id="38022493" class="c"><input type="checkbox" id="c-38022493" checked=""/><div class="controls bullet"><span class="by">tommiegannert</span><span>|</span><a href="#38022233">parent</a><span>|</span><a href="#38022536">prev</a><span>|</span><a href="#38022387">next</a><span>|</span><label class="collapse" for="c-38022493">[-]</label><label class="expand" for="c-38022493">[3 more]</label></div><br/><div class="children"><div class="content">The original article [1] explains it much further:<p>&gt; As you read previously, according to the Facebook documentation, when Vidio.com receives the access token from the user, Vidio should verify that the access token was generated to its App ID (92356) by calling the <a href="https:&#x2F;&#x2F;graph.facebook.com&#x2F;debug_token" rel="nofollow noreferrer">https:&#x2F;&#x2F;graph.facebook.com&#x2F;debug_token</a> API.<p>Confirming what vladvasiliu said.<p>1. <a href="https:&#x2F;&#x2F;salt.security&#x2F;blog&#x2F;oh-auth-abusing-oauth-to-take-over-millions-of-accounts" rel="nofollow noreferrer">https:&#x2F;&#x2F;salt.security&#x2F;blog&#x2F;oh-auth-abusing-oauth-to-take-ove...</a></div><br/><div id="38022867" class="c"><input type="checkbox" id="c-38022867" checked=""/><div class="controls bullet"><span class="by">arcastroe</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022493">parent</a><span>|</span><a href="#38022387">next</a><span>|</span><label class="collapse" for="c-38022867">[-]</label><label class="expand" for="c-38022867">[2 more]</label></div><br/><div class="children"><div class="content">Gitea serves as an OIDC provider:<p>* <a href="https:&#x2F;&#x2F;docs.gitea.com&#x2F;next&#x2F;development&#x2F;oauth2-provider" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.gitea.com&#x2F;next&#x2F;development&#x2F;oauth2-provider</a><p>However, I don&#x27;t see an equivalent API in gitea to the &quot;debug_token&quot; api.<p>If I&#x27;m developing an application that allows &quot;Login with Gitea&quot;, how do I make sure my application is not vulnerable?</div><br/><div id="38022934" class="c"><input type="checkbox" id="c-38022934" checked=""/><div class="controls bullet"><span class="by">vladvasiliu</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022867">parent</a><span>|</span><a href="#38022387">next</a><span>|</span><label class="collapse" for="c-38022934">[-]</label><label class="expand" for="c-38022934">[1 more]</label></div><br/><div class="children"><div class="content">See caseysoftware&#x27;s reply: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=38022536">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=38022536</a><p>The access token usually has an `aud` field that says for whom it is.<p>I&#x27;m not familiar with Gitea&#x27;s implementation, but reading your link, it would seem that it acts as an oauth2 provider so that 3rd parties can access <i>Gitea</i>, not some other random app.<p>&gt; Gitea supports acting as an OAuth2 provider to <i>allow third party applications to access its resources</i> with the user&#x27;s consent.</div><br/></div></div></div></div></div></div><div id="38022387" class="c"><input type="checkbox" id="c-38022387" checked=""/><div class="controls bullet"><span class="by">vladvasiliu</span><span>|</span><a href="#38022233">parent</a><span>|</span><a href="#38022493">prev</a><span>|</span><a href="#38022959">next</a><span>|</span><label class="collapse" for="c-38022387">[-]</label><label class="expand" for="c-38022387">[2 more]</label></div><br/><div class="children"><div class="content">IIRC, the user woud get an access token <i>from</i> Facebook <i>for</i> the target site, e.g. Vidio. Vidio then has to make sure that not only is the token actually signed by Facebook, but also that Vidio is the token&#x27;s audience. The token shouldn&#x27;t be opaque to Vidio.<p>I&#x27;m in no way an authority on OAuth, but I think the &quot;opaque token&quot; you&#x27;re talking about is in the situation when Vidio would want to access Facebook on the user&#x27;s behalf: they would get an access token <i>for</i> Facebook. The token can be opaque to Vidio.</div><br/><div id="38022443" class="c"><input type="checkbox" id="c-38022443" checked=""/><div class="controls bullet"><span class="by">Incipient</span><span>|</span><a href="#38022233">root</a><span>|</span><a href="#38022387">parent</a><span>|</span><a href="#38022959">next</a><span>|</span><label class="collapse" for="c-38022443">[-]</label><label class="expand" for="c-38022443">[1 more]</label></div><br/><div class="children"><div class="content">Not being a full expert on it either, that flow is roughly right. Vidio does have to validate it. The entire pkce flow is bloody painful to implement, and it&#x27;s actually quite hard to do it perfectly, and easy to accidentally skip a part of it and have it seemingly work ok.</div><br/></div></div></div></div></div></div><div id="38022959" class="c"><input type="checkbox" id="c-38022959" checked=""/><div class="controls bullet"><span class="by">3abiton</span><span>|</span><a href="#38022233">prev</a><span>|</span><a href="#38021626">next</a><span>|</span><label class="collapse" for="c-38022959">[-]</label><label class="expand" for="c-38022959">[1 more]</label></div><br/><div class="children"><div class="content">But this seems to require access to a different oauth token already, ie the victim could have had their tokens from other websites leaked.</div><br/></div></div><div id="38021626" class="c"><input type="checkbox" id="c-38021626" checked=""/><div class="controls bullet"><span class="by">Spivak</span><span>|</span><a href="#38022959">prev</a><span>|</span><a href="#38022259">next</a><span>|</span><label class="collapse" for="c-38021626">[-]</label><label class="expand" for="c-38021626">[3 more]</label></div><br/><div class="children"><div class="content">What am I missing here? How do you mess this up? Like you redirect to the OAuth provider with a url that has your client_id and ask for a postback and you get it with a code, you use that code <i>plus your app&#x27;s client_id&#x2F;secret</i> to get user-creds and then query some API to figure out who just authed. The code is
tied to your client_id&#x2F;secret. You have to implicitly verify the code you got just to figure out who logged in.</div><br/><div id="38023009" class="c"><input type="checkbox" id="c-38023009" checked=""/><div class="controls bullet"><span class="by">jorams</span><span>|</span><a href="#38021626">parent</a><span>|</span><a href="#38022592">next</a><span>|</span><label class="collapse" for="c-38023009">[-]</label><label class="expand" for="c-38023009">[1 more]</label></div><br/><div class="children"><div class="content">What you describe is the explicit grant flow and the exchange of the code for an access token automatically protects against this vulnerability. The bugs here are in the implicit grant flow where the redirect doesn&#x27;t include an opaque code but an actual access token. There the application is responsible for validating that the token is for that application, but there&#x27;s nothing that <i>requires</i> it to do that.</div><br/></div></div><div id="38022592" class="c"><input type="checkbox" id="c-38022592" checked=""/><div class="controls bullet"><span class="by">michaeljx</span><span>|</span><a href="#38021626">parent</a><span>|</span><a href="#38023009">prev</a><span>|</span><a href="#38022259">next</a><span>|</span><label class="collapse" for="c-38022592">[-]</label><label class="expand" for="c-38022592">[1 more]</label></div><br/><div class="children"><div class="content">An attacker could call the post back with a code generated for another client_id. When you use the code to query who logged in, Facebook will still respond, even if the code was not generated for your client_id</div><br/></div></div></div></div><div id="38022259" class="c"><input type="checkbox" id="c-38022259" checked=""/><div class="controls bullet"><span class="by">duttonw</span><span>|</span><a href="#38021626">prev</a><span>|</span><a href="#38022559">next</a><span>|</span><label class="collapse" for="c-38022259">[-]</label><label class="expand" for="c-38022259">[5 more]</label></div><br/><div class="children"><div class="content">something something jwt token for implicit flow OAuth I&#x27;d guess.</div><br/><div id="38022449" class="c"><input type="checkbox" id="c-38022449" checked=""/><div class="controls bullet"><span class="by">Incipient</span><span>|</span><a href="#38022259">parent</a><span>|</span><a href="#38022559">next</a><span>|</span><label class="collapse" for="c-38022449">[-]</label><label class="expand" for="c-38022449">[4 more]</label></div><br/><div class="children"><div class="content">Should be pkce now. I think implicit flow is entirely dead? But could be wrong.</div><br/><div id="38023286" class="c"><input type="checkbox" id="c-38023286" checked=""/><div class="controls bullet"><span class="by">tansan</span><span>|</span><a href="#38022259">root</a><span>|</span><a href="#38022449">parent</a><span>|</span><a href="#38022485">next</a><span>|</span><label class="collapse" for="c-38023286">[-]</label><label class="expand" for="c-38023286">[1 more]</label></div><br/><div class="children"><div class="content">PKCE should only be necessary if you&#x27;re using app linking or have some client app in-between. If you completely trust the server than implicit is fine.</div><br/></div></div><div id="38022485" class="c"><input type="checkbox" id="c-38022485" checked=""/><div class="controls bullet"><span class="by">duttonw</span><span>|</span><a href="#38022259">root</a><span>|</span><a href="#38022449">parent</a><span>|</span><a href="#38023286">prev</a><span>|</span><a href="#38022468">next</a><span>|</span><label class="collapse" for="c-38022485">[-]</label><label class="expand" for="c-38022485">[1 more]</label></div><br/><div class="children"><div class="content">Another option is pkce spa, if they did not do &#x27;auth&#x27; checks that the jwt token was indeed signed by auth0 or similar, a carefully crafted js alteration would let you take control of the front end. Then you could give it a incorrectly signed token with all the correct details for another user. Usually they would only use the email for matching which makes things even more trivial.<p>You would hope they verified the signing of the jwt token on the backend, but seems thats too difficult for many dev&#x27;s.</div><br/></div></div><div id="38022468" class="c"><input type="checkbox" id="c-38022468" checked=""/><div class="controls bullet"><span class="by">duttonw</span><span>|</span><a href="#38022259">root</a><span>|</span><a href="#38022449">parent</a><span>|</span><a href="#38022485">prev</a><span>|</span><a href="#38022559">next</a><span>|</span><label class="collapse" for="c-38022468">[-]</label><label class="expand" for="c-38022468">[1 more]</label></div><br/><div class="children"><div class="content">it should be but auth0 was not forcing it to be off, just highly suggesting to turn off that &#x27;feature&#x27; unsure now.</div><br/></div></div></div></div></div></div><div id="38022559" class="c"><input type="checkbox" id="c-38022559" checked=""/><div class="controls bullet"><span class="by">geraldhh</span><span>|</span><a href="#38022259">prev</a><span>|</span><label class="collapse" for="c-38022559">[-]</label><label class="expand" for="c-38022559">[1 more]</label></div><br/><div class="children"><div class="content">finally the &quot;login as facebook&quot; feature everybody has been waiting for</div><br/></div></div></div></div></div></div></div></body></html>