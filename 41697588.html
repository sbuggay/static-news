<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1727946065570" as="style"/><link rel="stylesheet" href="styles.css?v=1727946065570"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://duriansoftware.com/joe/type-erased-generic-functions-for-c:-a-modest-non-proposal">Type-erased generic functions for C: A modest non-proposal</a> <span class="domain">(<a href="https://duriansoftware.com">duriansoftware.com</a>)</span></div><div class="subtext"><span>thunderbong</span> | <span>10 comments</span></div><br/><div><div id="41728564" class="c"><input type="checkbox" id="c-41728564" checked=""/><div class="controls bullet"><span class="by">t43562</span><span>|</span><a href="#41728594">next</a><span>|</span><label class="collapse" for="c-41728564">[-]</label><label class="expand" for="c-41728564">[1 more]</label></div><br/><div class="children"><div class="content">For new code you can use any language but we do have a lot of C code out there so it would be nice to have some ways to modernize it in, say 10 years, when those modernizations have made it out to every conceivable platform that runs the software.<p>e.g. GNU make could do very much with some better abstractions (not sure about this one specifically) and yet one cannot use such things until the last VMS user of gmake has got that feature in their C compiler.<p>IMO that probably means the most effective way to modernise C programs might be to transpile the modernisations to e.g. C89.  That could be done on any device and the result, one hopes, would work on all the systems out there which might not have the modern compiler on them.</div><br/></div></div><div id="41728594" class="c"><input type="checkbox" id="c-41728594" checked=""/><div class="controls bullet"><span class="by">xiphias2</span><span>|</span><a href="#41728564">prev</a><span>|</span><a href="#41728481">next</a><span>|</span><label class="collapse" for="c-41728594">[-]</label><label class="expand" for="c-41728594">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a cool idea, simple, I like it much more than the _Var and _Type stuff, but I&#x27;m not sure if it&#x27;s 100% backwards compatible:<p>If I pass (int<i>) and (void </i>) at different places, they will convert to void *, but won&#x27;t be accepted in the new code.<p>Still, it would be great to have an implementation where it can be an optional error, and see what it finds.</div><br/></div></div><div id="41728481" class="c"><input type="checkbox" id="c-41728481" checked=""/><div class="controls bullet"><span class="by">ww520</span><span>|</span><a href="#41728594">prev</a><span>|</span><a href="#41728187">next</a><span>|</span><label class="collapse" for="c-41728481">[-]</label><label class="expand" for="c-41728481">[1 more]</label></div><br/><div class="children"><div class="content">Zig’s comptime has wonderful support for generic. It’s very powerful and intuitive to use. May be can borrow some ideas from it?</div><br/></div></div><div id="41728187" class="c"><input type="checkbox" id="c-41728187" checked=""/><div class="controls bullet"><span class="by">choeger</span><span>|</span><a href="#41728481">prev</a><span>|</span><a href="#41728016">next</a><span>|</span><label class="collapse" for="c-41728187">[-]</label><label class="expand" for="c-41728187">[1 more]</label></div><br/><div class="children"><div class="content">I really don&#x27;t see what the problem with the runtime metadata is? In the example, the size of T is also an argument? So why not pass a pointer to the whole set of type information there?</div><br/></div></div><div id="41728016" class="c"><input type="checkbox" id="c-41728016" checked=""/><div class="controls bullet"><span class="by">rwmj</span><span>|</span><a href="#41728187">prev</a><span>|</span><a href="#41728357">next</a><span>|</span><label class="collapse" for="c-41728016">[-]</label><label class="expand" for="c-41728016">[2 more]</label></div><br/><div class="children"><div class="content">Meh, you just need more macros ...<p><a href="https:&#x2F;&#x2F;gitlab.com&#x2F;nbdkit&#x2F;nbdkit&#x2F;-&#x2F;blob&#x2F;296b9dd041fdbcbaa73119db1ff58c5e115cc9b8&#x2F;common&#x2F;utils&#x2F;vector.h#L112" rel="nofollow">https:&#x2F;&#x2F;gitlab.com&#x2F;nbdkit&#x2F;nbdkit&#x2F;-&#x2F;blob&#x2F;296b9dd041fdbcbaa731...</a></div><br/><div id="41728664" class="c"><input type="checkbox" id="c-41728664" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#41728016">parent</a><span>|</span><a href="#41728357">next</a><span>|</span><label class="collapse" for="c-41728664">[-]</label><label class="expand" for="c-41728664">[1 more]</label></div><br/><div class="children"><div class="content">&lt;300 lines? Peanuts! ;D<p><a href="https:&#x2F;&#x2F;github.com&#x2F;FRRouting&#x2F;frr&#x2F;blob&#x2F;master&#x2F;lib&#x2F;typesafe.h">https:&#x2F;&#x2F;github.com&#x2F;FRRouting&#x2F;frr&#x2F;blob&#x2F;master&#x2F;lib&#x2F;typesafe.h</a><p><a href="https:&#x2F;&#x2F;docs.frrouting.org&#x2F;projects&#x2F;dev-guide&#x2F;en&#x2F;latest&#x2F;lists.html" rel="nofollow">https:&#x2F;&#x2F;docs.frrouting.org&#x2F;projects&#x2F;dev-guide&#x2F;en&#x2F;latest&#x2F;list...</a></div><br/></div></div></div></div><div id="41728357" class="c"><input type="checkbox" id="c-41728357" checked=""/><div class="controls bullet"><span class="by">anacrolix</span><span>|</span><a href="#41728016">prev</a><span>|</span><label class="collapse" for="c-41728357">[-]</label><label class="expand" for="c-41728357">[3 more]</label></div><br/><div class="children"><div class="content">Just use Zig?</div><br/><div id="41728577" class="c"><input type="checkbox" id="c-41728577" checked=""/><div class="controls bullet"><span class="by">pfg_</span><span>|</span><a href="#41728357">parent</a><span>|</span><label class="collapse" for="c-41728577">[-]</label><label class="expand" for="c-41728577">[2 more]</label></div><br/><div class="children"><div class="content">This proposal is different than how zig handles generic functions because it only emits one symbol and function body for each function.<p>In zig, genericMax([]i32) would emit seperate code to genericMax([]i16). This proposal has both of those functions backed by the same symbol and machine code but it requires a bunch of extra arguments, virtual function calls, and manualy offsetting indices into arrays. You could use zig to do the same with some effort.</div><br/><div id="41728708" class="c"><input type="checkbox" id="c-41728708" checked=""/><div class="controls bullet"><span class="by">pfg_</span><span>|</span><a href="#41728357">root</a><span>|</span><a href="#41728577">parent</a><span>|</span><label class="collapse" for="c-41728708">[-]</label><label class="expand" for="c-41728708">[1 more]</label></div><br/><div class="children"><div class="content"><p><pre><code>    fn genericReduceTypeErased(
        size: usize,
        total: [*]u8,
        list: []const u8,
        reducer: *const fn(total: [*]u8, current: [*]const u8) callconv(.C) void,
    ) void {
        for(0..@divExact(list.len, size)) |i| {
            const itm = &amp;list[i \* size];
            reducer(total, @ptrCast(itm));
        }
    }

    inline fn genericReduce(
        comptime T: type,
        total: *T,
        list: []const T,
        reducer: *const fn(total: *T, current: *const T) callconv(.C) void,
    ) void {
        genericReduceTypeErased( @sizeOf(T), @ptrCast(total), std.mem.sliceAsBytes(list), @ptrCast(reducer) );
    }
</code></pre>
The proposal is basically syntax sugar for making a typed version of the first function in C</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>