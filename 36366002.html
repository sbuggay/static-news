<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1686992467816" as="style"/><link rel="stylesheet" href="styles.css?v=1686992467816"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://lwn.net/SubscriberLink/934692/5046d466490d9220/">Merging bcachefs</a>Â <span class="domain">(<a href="https://lwn.net">lwn.net</a>)</span></div><div class="subtext"><span>rascul</span> | <span>32 comments</span></div><br/><div><div id="36367118" class="c"><input type="checkbox" id="c-36367118" checked=""/><div class="controls bullet"><span class="by">slabity</span><span>|</span><a href="#36367230">next</a><span>|</span><label class="collapse" for="c-36367118">[-]</label><label class="expand" for="c-36367118">[5 more]</label></div><br/><div class="children"><div class="content">&gt; Brauner said that he thinks bcachefs is in &quot;excellent shape to be upstreamed&quot;, but he is concerned with the number of filesystems in the kernel; he is glad to see that there are efforts to remove some of them. Changes that impact all of the filesystems in the tree &quot;get painful very very fast&quot; and, in some cases, there is no one available to review the changes. He would like the acceptance process to be more conservative; accepting NTFS&#x2F;NTFS3 was &quot;a huge mistake&quot;, for example.<p>As someone not familiar with the filesystem related parts of the kernel, it&#x27;s quite surprising to hear this. It sounds like filesystems are a lot more integrated (or at least less modular) than other kernel subsystems.<p>Anyone else who found this surprising, I recommend reading this other LWN article that is referenced as well: <a href="https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;886708&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;886708&#x2F;</a><p>However, that mostly discusses issues caused by having 32-bit data structures, and how they will cause issues in 2038 when it&#x27;s no longer able to handle the timestamps required. Specifically for ext3, NTFS, and ReiserFS.<p>But other than that issue, I don&#x27;t really understand why it&#x27;s difficult to simply rip out support for a specific filesystem. Compared to something like a driver for a PCIe or USB device, what makes filesystems so much more integrated and difficult to remove?</div><br/><div id="36367982" class="c"><input type="checkbox" id="c-36367982" checked=""/><div class="controls bullet"><span class="by">cesarb</span><span>|</span><a href="#36367118">parent</a><span>|</span><a href="#36367248">next</a><span>|</span><label class="collapse" for="c-36367982">[-]</label><label class="expand" for="c-36367982">[1 more]</label></div><br/><div class="children"><div class="content">&gt; As someone not familiar with the filesystem related parts of the kernel, it&#x27;s quite surprising to hear this. It sounds like filesystems are a lot more integrated (or at least less modular) than other kernel subsystems.<p>AFAIK, on Linux filesystems are closely coupled with the memory management subsystem and the directory and inode caches. It&#x27;s part of the reason why filesystem access on Linux is so fast.<p>&gt; But other than that issue, I don&#x27;t really understand why it&#x27;s difficult to simply rip out support for a specific filesystem. Compared to something like a driver for a PCIe or USB device, what makes filesystems so much more integrated and difficult to remove?<p>It&#x27;s not that unusual for users to have a partition containing a filesystem (sometimes, but not always, on an external drive) surviving unchanged through several migrations to newer Linux distributions and&#x2F;or hardware. Compared to something like a PCIe or USB device, filesystems have a longer life.</div><br/></div></div><div id="36367248" class="c"><input type="checkbox" id="c-36367248" checked=""/><div class="controls bullet"><span class="by">wmf</span><span>|</span><a href="#36367118">parent</a><span>|</span><a href="#36367982">prev</a><span>|</span><a href="#36367237">next</a><span>|</span><label class="collapse" for="c-36367248">[-]</label><label class="expand" for="c-36367248">[2 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know that it&#x27;s technically difficult, but Linux hates breaking backward compatibility. If they remove a filesystem, some users won&#x27;t be able to mount their filesystems any more. But Linux doesn&#x27;t want to have unmaintained code either, so they only accept a filesystem if it&#x27;s going to be maintained for the next 10-20 years.</div><br/><div id="36368494" class="c"><input type="checkbox" id="c-36368494" checked=""/><div class="controls bullet"><span class="by">Tuna-Fish</span><span>|</span><a href="#36367118">root</a><span>|</span><a href="#36367248">parent</a><span>|</span><a href="#36367237">next</a><span>|</span><label class="collapse" for="c-36368494">[-]</label><label class="expand" for="c-36368494">[1 more]</label></div><br/><div class="children"><div class="content">The only &quot;easy path&quot; is if there exists a working fuse implementation of the same filesystem. Then there is a good fallback path for the users who still need support.</div><br/></div></div></div></div><div id="36367237" class="c"><input type="checkbox" id="c-36367237" checked=""/><div class="controls bullet"><span class="by">djbusby</span><span>|</span><a href="#36367118">parent</a><span>|</span><a href="#36367248">prev</a><span>|</span><a href="#36367230">next</a><span>|</span><label class="collapse" for="c-36367237">[-]</label><label class="expand" for="c-36367237">[1 more]</label></div><br/><div class="children"><div class="content">Hard to maintain because all this code has to handle common thing (file, directory, etc) in unique way. A big mapping mess.<p>Hard to remove because someone, somewhere uses it and Linux doesn&#x27;t like to break things for the user.</div><br/></div></div></div></div><div id="36367230" class="c"><input type="checkbox" id="c-36367230" checked=""/><div class="controls bullet"><span class="by">throwaway888abc</span><span>|</span><a href="#36367118">prev</a><span>|</span><a href="#36368178">next</a><span>|</span><label class="collapse" for="c-36367230">[-]</label><label class="expand" for="c-36367230">[2 more]</label></div><br/><div class="children"><div class="content">Side note:<p>First mention of bcachefs here on HN (13years ago) and now it&#x27;s gets merged into kernel.<p>What an awesome achievement!<p><a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=1720077">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=1720077</a></div><br/><div id="36368058" class="c"><input type="checkbox" id="c-36368058" checked=""/><div class="controls bullet"><span class="by">kzrdude</span><span>|</span><a href="#36367230">parent</a><span>|</span><a href="#36368178">next</a><span>|</span><label class="collapse" for="c-36368058">[-]</label><label class="expand" for="c-36368058">[1 more]</label></div><br/><div class="children"><div class="content">We can&#x27;t take it for granted yet that it will be merged</div><br/></div></div></div></div><div id="36368178" class="c"><input type="checkbox" id="c-36368178" checked=""/><div class="controls bullet"><span class="by">kzrdude</span><span>|</span><a href="#36367230">prev</a><span>|</span><a href="#36367556">next</a><span>|</span><label class="collapse" for="c-36368178">[-]</label><label class="expand" for="c-36368178">[2 more]</label></div><br/><div class="children"><div class="content">Some ~30 preparatory bcachefs patches have been posted for review for a month or so now, there was some discussion, but mostly negative discussion.<p>Does anyone know how this actually works, is it going well for that patchset, is it getting closer to being merged?</div><br/><div id="36368519" class="c"><input type="checkbox" id="c-36368519" checked=""/><div class="controls bullet"><span class="by">Tuna-Fish</span><span>|</span><a href="#36368178">parent</a><span>|</span><a href="#36367556">next</a><span>|</span><label class="collapse" for="c-36368519">[-]</label><label class="expand" for="c-36368519">[1 more]</label></div><br/><div class="children"><div class="content">This is normal. The positive things don&#x27;t need to be talked about.<p>It is extremely unlikely that bcachefs will be merged as-is. This is true for anything of it&#x27;s size. (These days... There have been large subsystems in the past that were merged in unacceptable state with the promise that eventually they will be fixed. They usually weren&#x27;t. Which is why the bar is so high now.)  But this just means that there will need to be debate and work to hammer it into a shape that is acceptable for the kernel. This can be a long process, but I don&#x27;t think there is anything fundamentally wrong in bcachefs that would exclude it.</div><br/></div></div></div></div><div id="36367556" class="c"><input type="checkbox" id="c-36367556" checked=""/><div class="controls bullet"><span class="by">toastal</span><span>|</span><a href="#36368178">prev</a><span>|</span><a href="#36366894">next</a><span>|</span><label class="collapse" for="c-36367556">[-]</label><label class="expand" for="c-36367556">[12 more]</label></div><br/><div class="children"><div class="content">How long til it would be recommended to move from ZFS to BcacheFS on Linux?</div><br/><div id="36367588" class="c"><input type="checkbox" id="c-36367588" checked=""/><div class="controls bullet"><span class="by">p-e-w</span><span>|</span><a href="#36367556">parent</a><span>|</span><a href="#36367736">next</a><span>|</span><label class="collapse" for="c-36367588">[-]</label><label class="expand" for="c-36367588">[10 more]</label></div><br/><div class="children"><div class="content">10+ years, considering how Btrfs has played out.<p>Btrfs was merged in 2009, but didn&#x27;t gain wide acceptance until quite recently. Among the biggest distros, only Fedora uses it as default, and RHEL has actually dropped support. Even today, you can still find people claiming that they lost data because of it, though whether they are telling the truth I cannot say.</div><br/><div id="36367666" class="c"><input type="checkbox" id="c-36367666" checked=""/><div class="controls bullet"><span class="by">ThatPlayer</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367588">parent</a><span>|</span><a href="#36367808">next</a><span>|</span><label class="collapse" for="c-36367666">[-]</label><label class="expand" for="c-36367666">[5 more]</label></div><br/><div class="children"><div class="content">I believe openSUSE uses Btrfs.<p>I haven&#x27;t lost data on it, but my 8 drive Btrfs RAID6 filesystem locked up read-only on me, which wasn&#x27;t fun. Switched to ZFS after that.</div><br/><div id="36367895" class="c"><input type="checkbox" id="c-36367895" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367666">parent</a><span>|</span><a href="#36368166">next</a><span>|</span><label class="collapse" for="c-36367895">[-]</label><label class="expand" for="c-36367895">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, OpenSUSE does BTRFS although they also support XFS. I ran tumbleweed for a while and managed to lose a root filesystem twice, although that was a few years ago and appeared to be triggered by running out of space, as the home filesystem on the same box, also BTRFS, survived both times.</div><br/></div></div><div id="36368166" class="c"><input type="checkbox" id="c-36368166" checked=""/><div class="controls bullet"><span class="by">hashworks</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367666">parent</a><span>|</span><a href="#36367895">prev</a><span>|</span><a href="#36367808">next</a><span>|</span><label class="collapse" for="c-36368166">[-]</label><label class="expand" for="c-36368166">[3 more]</label></div><br/><div class="children"><div class="content">RAID5&#x2F;6 is still quite beta in btrfs. mdadm+btrfs is the way to go here.</div><br/><div id="36368357" class="c"><input type="checkbox" id="c-36368357" checked=""/><div class="controls bullet"><span class="by">mkup</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36368166">parent</a><span>|</span><a href="#36367808">next</a><span>|</span><label class="collapse" for="c-36368357">[-]</label><label class="expand" for="c-36368357">[2 more]</label></div><br/><div class="children"><div class="content">Actually any RAID is beta in btrfs, but configurations with one storage device (e.g. firmware of Turris Omnia) do quite well on prod.</div><br/><div id="36368425" class="c"><input type="checkbox" id="c-36368425" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36368357">parent</a><span>|</span><a href="#36367808">next</a><span>|</span><label class="collapse" for="c-36368425">[-]</label><label class="expand" for="c-36368425">[1 more]</label></div><br/><div class="children"><div class="content">No, it&#x27;s not beta. You can check the status here <a href="https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;Status.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;Status.html</a><p>Only raid5&#x2F;6 has known issues.</div><br/></div></div></div></div></div></div></div></div><div id="36367808" class="c"><input type="checkbox" id="c-36367808" checked=""/><div class="controls bullet"><span class="by">hkwerf</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367588">parent</a><span>|</span><a href="#36367666">prev</a><span>|</span><a href="#36368423">next</a><span>|</span><label class="collapse" for="c-36367808">[-]</label><label class="expand" for="c-36367808">[2 more]</label></div><br/><div class="children"><div class="content">It is quite understandable that something as critical when it comes to file storage takes a while to be adopted and being tested on less important data first. I&#x27;d say this reflects positively on IT.<p>A nice (and lone) data point regarding btrfs, though: My dentist told me that he was storing patient data using btrfs last year. :)</div><br/><div id="36368009" class="c"><input type="checkbox" id="c-36368009" checked=""/><div class="controls bullet"><span class="by">lnx01</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367808">parent</a><span>|</span><a href="#36368423">next</a><span>|</span><label class="collapse" for="c-36368009">[-]</label><label class="expand" for="c-36368009">[1 more]</label></div><br/><div class="children"><div class="content">I can&#x27;t help but wonder how that conversation happened:  Ya so we&#x27;re going to root canal your molar, ah and by the way patient data is on btrfs which is only slightly worse...</div><br/></div></div></div></div><div id="36368423" class="c"><input type="checkbox" id="c-36368423" checked=""/><div class="controls bullet"><span class="by">LeoPanthera</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367588">parent</a><span>|</span><a href="#36367808">prev</a><span>|</span><a href="#36367928">next</a><span>|</span><label class="collapse" for="c-36368423">[-]</label><label class="expand" for="c-36368423">[1 more]</label></div><br/><div class="children"><div class="content">openSUSE also uses it as the default, as do Synology NAS appliances.</div><br/></div></div><div id="36367928" class="c"><input type="checkbox" id="c-36367928" checked=""/><div class="controls bullet"><span class="by">pixel3234</span><span>|</span><a href="#36367556">root</a><span>|</span><a href="#36367588">parent</a><span>|</span><a href="#36368423">prev</a><span>|</span><a href="#36367736">next</a><span>|</span><label class="collapse" for="c-36367928">[-]</label><label class="expand" for="c-36367928">[1 more]</label></div><br/><div class="children"><div class="content">Btrfs is significantly more complex and very different case. Bcachefs is designed by single guy with different motivation.<p>Main problem with Bcachefs is its in unknown state. There was no major testing done on that. When some company (like Oracle or Suse) puts it through automated stress test matrix, it may do exceptionally well or completely fail.</div><br/></div></div></div></div><div id="36367736" class="c"><input type="checkbox" id="c-36367736" checked=""/><div class="controls bullet"><span class="by">predictabl3</span><span>|</span><a href="#36367556">parent</a><span>|</span><a href="#36367588">prev</a><span>|</span><a href="#36366894">next</a><span>|</span><label class="collapse" for="c-36367736">[-]</label><label class="expand" for="c-36367736">[1 more]</label></div><br/><div class="children"><div class="content">I keep wondering this too, but at the same time, alebit with bugs, I have a ZFS pool mountable under Linux and Windows, so I have decided to not hold my breath at all. Not to mention zrepl, etc.</div><br/></div></div></div></div><div id="36366894" class="c"><input type="checkbox" id="c-36366894" checked=""/><div class="controls bullet"><span class="by">marcodiego</span><span>|</span><a href="#36367556">prev</a><span>|</span><label class="collapse" for="c-36366894">[-]</label><label class="expand" for="c-36366894">[10 more]</label></div><br/><div class="children"><div class="content">What I really would like: ext4 with snapshots and transparent compression where it may improve performance.</div><br/><div id="36367264" class="c"><input type="checkbox" id="c-36367264" checked=""/><div class="controls bullet"><span class="by">wmf</span><span>|</span><a href="#36366894">parent</a><span>|</span><a href="#36366981">next</a><span>|</span><label class="collapse" for="c-36367264">[-]</label><label class="expand" for="c-36367264">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s kludgey to graft snapshots and compression onto a classic in-place filesystem, so you&#x27;d probably end up with something slower and more complex than ZFS&#x2F;btrfs&#x2F;bcachefs. I remember tux2&#x2F;tux3 was touting its simplicity but I don&#x27;t know what happened.</div><br/><div id="36368419" class="c"><input type="checkbox" id="c-36368419" checked=""/><div class="controls bullet"><span class="by">5e92cb50239222b</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367264">parent</a><span>|</span><a href="#36366981">next</a><span>|</span><label class="collapse" for="c-36368419">[-]</label><label class="expand" for="c-36368419">[1 more]</label></div><br/><div class="children"><div class="content">Dave Chinner somehow managed to put reflinks on top of XFS, although it&#x27;s not nearly the same as full filesystem snapshots. I believe there was discussion about implementing proper snapshots, but XFS is very conservatively developed, so that may be many years in the future, if it ever happens.</div><br/></div></div></div></div><div id="36366981" class="c"><input type="checkbox" id="c-36366981" checked=""/><div class="controls bullet"><span class="by">arjvik</span><span>|</span><a href="#36366894">parent</a><span>|</span><a href="#36367264">prev</a><span>|</span><label class="collapse" for="c-36366981">[-]</label><label class="expand" for="c-36366981">[7 more]</label></div><br/><div class="children"><div class="content">so essentially btrfs&#x2F;bcachefs without the focus on being used for RAID?</div><br/><div id="36367028" class="c"><input type="checkbox" id="c-36367028" checked=""/><div class="controls bullet"><span class="by">j16sdiz</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36366981">parent</a><span>|</span><label class="collapse" for="c-36367028">[-]</label><label class="expand" for="c-36367028">[6 more]</label></div><br/><div class="children"><div class="content">btrfs don&#x27;t allow nodatacow with snapshots .<p>I know how these two features have some conflicts, but it meant we can&#x27;t have database workload with decent performance on btrfs. -- brtfs snapshot just can&#x27;t scale, the cow have too high performance hit.<p>ZFS handles snapshots with database workload just fine.</div><br/><div id="36367130" class="c"><input type="checkbox" id="c-36367130" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367028">parent</a><span>|</span><a href="#36367086">next</a><span>|</span><label class="collapse" for="c-36367130">[-]</label><label class="expand" for="c-36367130">[1 more]</label></div><br/><div class="children"><div class="content">ZFS is cow, so if it works for your load, cow doesn&#x27;t seem to be the problem?<p>If you&#x27;re willing to switch OSes, FreeBSD UFS is a more traditional filesystem, with optional snapshots (modifications to files in a snapshot have to be cow, of course)</div><br/></div></div><div id="36367086" class="c"><input type="checkbox" id="c-36367086" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367028">parent</a><span>|</span><a href="#36367130">prev</a><span>|</span><label class="collapse" for="c-36367086">[-]</label><label class="expand" for="c-36367086">[4 more]</label></div><br/><div class="children"><div class="content">Have you got any recent snapshot benchmark available? I can find only one ancient one.<p>&gt; btrfs don&#x27;t allow nodatacow with snapshots<p>What&#x27;s the use case for a snapshot at that point? Isn&#x27;t it the same as making a copy of the files?<p>I&#x27;m not even sure what would this look like... CoW is what enables snapshots. Without CoW you can&#x27;t get a consistent copy anymore.</div><br/><div id="36367956" class="c"><input type="checkbox" id="c-36367956" checked=""/><div class="controls bullet"><span class="by">derefr</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367086">parent</a><span>|</span><a href="#36367608">next</a><span>|</span><label class="collapse" for="c-36367956">[-]</label><label class="expand" for="c-36367956">[2 more]</label></div><br/><div class="children"><div class="content">&gt; What&#x27;s the use case for a snapshot at that point? Isn&#x27;t it the same as making a copy of the files?<p>As you say, it&#x27;s a <i>consistent</i> copy. cp(1) won&#x27;t give you that.</div><br/><div id="36368210" class="c"><input type="checkbox" id="c-36368210" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367956">parent</a><span>|</span><a href="#36367608">next</a><span>|</span><label class="collapse" for="c-36368210">[-]</label><label class="expand" for="c-36368210">[1 more]</label></div><br/><div class="children"><div class="content">So I guess you&#x27;d have to temporarily turn on CoW, take a snapshot, make sure all the files are fully duplicated, turn off CoW to achieve that. Since you can&#x27;t flip the setting at runtime right now, that feature seems quite far away.</div><br/></div></div></div></div><div id="36367608" class="c"><input type="checkbox" id="c-36367608" checked=""/><div class="controls bullet"><span class="by">lmz</span><span>|</span><a href="#36366894">root</a><span>|</span><a href="#36367086">parent</a><span>|</span><a href="#36367956">prev</a><span>|</span><label class="collapse" for="c-36367608">[-]</label><label class="expand" for="c-36367608">[1 more]</label></div><br/><div class="children"><div class="content">I guess it would look like LVM snapshots? CoW only when a snapshot is present.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>