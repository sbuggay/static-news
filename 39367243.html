<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1708074052207" as="style"/><link rel="stylesheet" href="styles.css?v=1708074052207"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.corsix.org/content/elf-eh-frame">Linux/ELF .eh_frame from the bottom up</a>Â <span class="domain">(<a href="https://www.corsix.org">www.corsix.org</a>)</span></div><div class="subtext"><span>ingve</span> | <span>9 comments</span></div><br/><div><div id="39393425" class="c"><input type="checkbox" id="c-39393425" checked=""/><div class="controls bullet"><span class="by">debatem1</span><span>|</span><a href="#39392995">next</a><span>|</span><label class="collapse" for="c-39393425">[-]</label><label class="expand" for="c-39393425">[3 more]</label></div><br/><div class="children"><div class="content">Wow.<p>I had to figure all of this out a few years ago and would have really benefitted from the author&#x27;s clear, precise take.<p>This is going into the onboarding docs for my team tomorrow morning.</div><br/><div id="39393961" class="c"><input type="checkbox" id="c-39393961" checked=""/><div class="controls bullet"><span class="by">badrabbit</span><span>|</span><a href="#39393425">parent</a><span>|</span><a href="#39392995">next</a><span>|</span><label class="collapse" for="c-39393961">[-]</label><label class="expand" for="c-39393961">[2 more]</label></div><br/><div class="children"><div class="content">May I ask what sort of work&#x2F;code your team works on? Sounds wild&#x2F;interesting.</div><br/><div id="39394634" class="c"><input type="checkbox" id="c-39394634" checked=""/><div class="controls bullet"><span class="by">debatem1</span><span>|</span><a href="#39393425">root</a><span>|</span><a href="#39393961">parent</a><span>|</span><a href="#39392995">next</a><span>|</span><label class="collapse" for="c-39394634">[-]</label><label class="expand" for="c-39394634">[1 more]</label></div><br/><div class="children"><div class="content">Distributed tracing x security. It is pretty wild for sure.</div><br/></div></div></div></div></div></div><div id="39392995" class="c"><input type="checkbox" id="c-39392995" checked=""/><div class="controls bullet"><span class="by">rockwotj</span><span>|</span><a href="#39393425">prev</a><span>|</span><a href="#39393954">next</a><span>|</span><label class="collapse" for="c-39392995">[-]</label><label class="expand" for="c-39392995">[1 more]</label></div><br/><div class="children"><div class="content">As I have been learning about stack unwinding and how it works, I really feel like this is quite the wizardary that is amazing it all works.</div><br/></div></div><div id="39393954" class="c"><input type="checkbox" id="c-39393954" checked=""/><div class="controls bullet"><span class="by">badrabbit</span><span>|</span><a href="#39392995">prev</a><span>|</span><label class="collapse" for="c-39393954">[-]</label><label class="expand" for="c-39393954">[4 more]</label></div><br/><div class="children"><div class="content">&gt; In most cases, if a function modifies a non-volatile register, it&#x27;ll save it to somewhere on the stack before modifying it. Upon function return, it&#x27;ll re-load the value from said stack slot<p>Dumb question: is this a linux specific calling convention thing (I know prologue&#x2F;epilogue don&#x27;t mess with random registers, so i&#x27;m a bit confused)? Why shouldn&#x27;t the caller save all the registers it needs instead of relying on the good behavior of the callee?<p>When I call certain syscalls (Linux&#x2F;x64), if I have data in certain registers, the kernel does not preserve and restore the data but it garbles it up. Is there documentation&#x2F;convention somewhere describing which registers are considered volatile by the ABI or do people find out the hard way normally?</div><br/><div id="39394181" class="c"><input type="checkbox" id="c-39394181" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#39393954">parent</a><span>|</span><a href="#39394147">next</a><span>|</span><label class="collapse" for="c-39394181">[-]</label><label class="expand" for="c-39394181">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Why shouldn&#x27;t the caller save all the registers it needs instead of relying on the good behavior of the callee?<p>You&#x27;ve got to rely on good behavior of the callee in general anyway. Calling conventions are part of the ABI and the caller and callee already need to agree on parameter passing (except for void(void) functions, which usually aren&#x27;t much fun).<p>Picking which registers are callee saved and which are caller saved is roughly an optimization problem. Compilers don&#x27;t have enough information to know what registers the callee (and its callees) actually use, so the caller can&#x27;t save only the registers it has used that will definitely be trashed. Caller saving registers that the callee doesn&#x27;t touch wastes code size, stack space, cpu time, and memory&#x2F;cache bandwidth; same for callee saving registers the caller didn&#x27;t need to be saved. So somebody puts together a convention that says these registers are super handy and most functions will want to use them --- those will be caller saved if necessesary. The other registers are deemed to be less likely to be used, callees will save them before using, just in case.<p>Syscalls may often have a different calling convention than library calls, because the needs are different.<p>There&#x27;s some docs on syscall ABIs for Linux, but I didn&#x27;t find one for x86, here&#x27;s the docs for PPC though: <a href="https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;v6.2&#x2F;powerpc&#x2F;syscall64-abi.html" rel="nofollow">https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;v6.2&#x2F;powerpc&#x2F;syscall64-abi.h...</a></div><br/></div></div><div id="39394147" class="c"><input type="checkbox" id="c-39394147" checked=""/><div class="controls bullet"><span class="by">js2</span><span>|</span><a href="#39393954">parent</a><span>|</span><a href="#39394181">prev</a><span>|</span><a href="#39394410">next</a><span>|</span><label class="collapse" for="c-39394147">[-]</label><label class="expand" for="c-39394147">[1 more]</label></div><br/><div class="children"><div class="content">On x86-64: r12, r13, r14, r15, rbx, rsp, rbp are callee-saved. See:<p><a href="https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;18024672&#x2F;what-registers-are-preserved-through-a-linux-x86-64-function-call" rel="nofollow">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;18024672&#x2F;what-registers-...</a><p>&gt; Why shouldn&#x27;t the caller save all the registers it needs instead of relying on the good behavior of the callee?<p>The cost to save a register is non-zero so it&#x27;s helpful to have some registers the caller doesn&#x27;t have to preserve and that don&#x27;t need to be saved by the callee if it won&#x27;t be using them.<p><a href="https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;65864046&#x2F;why-make-some-registers-caller-saved-and-others-callee-saved-why-not-make-the-c" rel="nofollow">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;65864046&#x2F;why-make-some-r...</a></div><br/></div></div><div id="39394410" class="c"><input type="checkbox" id="c-39394410" checked=""/><div class="controls bullet"><span class="by">mike_hock</span><span>|</span><a href="#39393954">parent</a><span>|</span><a href="#39394147">prev</a><span>|</span><label class="collapse" for="c-39394410">[-]</label><label class="expand" for="c-39394410">[1 more]</label></div><br/><div class="children"><div class="content">Linux uses the sysv calling convention. I believe these are the official or semi-official documents for x86 64-bit and 32-bit, respectively:<p><a href="https:&#x2F;&#x2F;gitlab.com&#x2F;x86-psABIs&#x2F;x86-64-ABI" rel="nofollow">https:&#x2F;&#x2F;gitlab.com&#x2F;x86-psABIs&#x2F;x86-64-ABI</a> (Table 3.4 in section 3.2.3 lists which registers may be clobbered and which must be saved)
<a href="https:&#x2F;&#x2F;gitlab.com&#x2F;x86-psABIs&#x2F;i386-ABI" rel="nofollow">https:&#x2F;&#x2F;gitlab.com&#x2F;x86-psABIs&#x2F;i386-ABI</a><p>I&#x27;d be very surprised if Windows didn&#x27;t have both caller-save and callee-save registers.</div><br/></div></div></div></div></div></div></div></div></div></body></html>