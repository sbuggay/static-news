<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1715850055887" as="style"/><link rel="stylesheet" href="styles.css?v=1715850055887"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://jepsen.io/analyses/datomic-pro-1.0.7075">Jepsen: Datomic Pro 1.0.7075</a> <span class="domain">(<a href="https://jepsen.io">jepsen.io</a>)</span></div><div class="subtext"><span>aphyr</span> | <span>55 comments</span></div><br/><div><div id="40376390" class="c"><input type="checkbox" id="c-40376390" checked=""/><div class="controls bullet"><span class="by">jwr</span><span>|</span><a href="#40371963">next</a><span>|</span><label class="collapse" for="c-40376390">[-]</label><label class="expand" for="c-40376390">[1 more]</label></div><br/><div class="children"><div class="content">This is a fantastic detailed report about a really good database. I&#x27;m also really happy to see the documentation being clarified and updated.<p>As a side note: I so wish Apple would pay for a Jepsen analysis of FoundationDB. I know Aphyr said that &quot;their tests are likely better&quot;, but if indeed Jepsen caught no problems in FoundationDB, it would be a strong data point for another really good database.</div><br/></div></div><div id="40371963" class="c"><input type="checkbox" id="c-40371963" checked=""/><div class="controls bullet"><span class="by">adrianco</span><span>|</span><a href="#40376390">prev</a><span>|</span><a href="#40374667">next</a><span>|</span><label class="collapse" for="c-40371963">[-]</label><label class="expand" for="c-40371963">[15 more]</label></div><br/><div class="children"><div class="content">I was a fly on the wall as this work was being done and it was super interesting to see the discussions. I was also surprised that Jepsen didn’t find critical bugs. Clarifying the docs and unusual (intentional) behaviors was a very useful outcome. It was a very worthwhile confidence building exercise given that we’re running a bank on Datomic…</div><br/><div id="40372953" class="c"><input type="checkbox" id="c-40372953" checked=""/><div class="controls bullet"><span class="by">belter</span><span>|</span><a href="#40371963">parent</a><span>|</span><a href="#40373438">next</a><span>|</span><label class="collapse" for="c-40372953">[-]</label><label class="expand" for="c-40372953">[8 more]</label></div><br/><div class="children"><div class="content">&gt; I was also surprised that Jepsen didn’t find critical bugs.<p>From the report...&quot;...we can prove the presence of bugs, but not their absence...&quot;</div><br/><div id="40374191" class="c"><input type="checkbox" id="c-40374191" checked=""/><div class="controls bullet"><span class="by">jupp0r</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40372953">parent</a><span>|</span><a href="#40373236">next</a><span>|</span><label class="collapse" for="c-40374191">[-]</label><label class="expand" for="c-40374191">[2 more]</label></div><br/><div class="children"><div class="content">In practical terms, if you are a database and Jepsen doesn&#x27;t find any bugs, that&#x27;s as much assurance as you are going to get in 2024 short of formal verification.</div><br/><div id="40375070" class="c"><input type="checkbox" id="c-40375070" checked=""/><div class="controls bullet"><span class="by">pests</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40374191">parent</a><span>|</span><a href="#40373236">next</a><span>|</span><label class="collapse" for="c-40375070">[-]</label><label class="expand" for="c-40375070">[1 more]</label></div><br/><div class="children"><div class="content">The work antithesis has been doing here has me really excited as well.</div><br/></div></div></div></div><div id="40373236" class="c"><input type="checkbox" id="c-40373236" checked=""/><div class="controls bullet"><span class="by">vasco</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40372953">parent</a><span>|</span><a href="#40374191">prev</a><span>|</span><a href="#40373850">next</a><span>|</span><label class="collapse" for="c-40373236">[-]</label><label class="expand" for="c-40373236">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s consistent with the usual definition of &quot;finding&quot; anything.</div><br/></div></div><div id="40373850" class="c"><input type="checkbox" id="c-40373850" checked=""/><div class="controls bullet"><span class="by">cdchn</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40372953">parent</a><span>|</span><a href="#40373236">prev</a><span>|</span><a href="#40373438">next</a><span>|</span><label class="collapse" for="c-40373850">[-]</label><label class="expand" for="c-40373850">[4 more]</label></div><br/><div class="children"><div class="content">&quot;Absence of evidence is not evidence of absence.&quot;</div><br/><div id="40374447" class="c"><input type="checkbox" id="c-40374447" checked=""/><div class="controls bullet"><span class="by">kelseyfrog</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40373850">parent</a><span>|</span><a href="#40374260">next</a><span>|</span><label class="collapse" for="c-40374447">[-]</label><label class="expand" for="c-40374447">[1 more]</label></div><br/><div class="children"><div class="content">Thank you. I&#x27;ve updated my initial guess of p(critical bugs | did not find critical bugs) from 0.5 to 0.82 given my estimate of likelihood and base rates.</div><br/></div></div><div id="40374260" class="c"><input type="checkbox" id="c-40374260" checked=""/><div class="controls bullet"><span class="by">andreareina</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40373850">parent</a><span>|</span><a href="#40374447">prev</a><span>|</span><a href="#40373438">next</a><span>|</span><label class="collapse" for="c-40374260">[-]</label><label class="expand" for="c-40374260">[2 more]</label></div><br/><div class="children"><div class="content">If you&#x27;ve looked, it is. The more and the better you look, the better evidence it is.</div><br/><div id="40374456" class="c"><input type="checkbox" id="c-40374456" checked=""/><div class="controls bullet"><span class="by">kelseyfrog</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40374260">parent</a><span>|</span><a href="#40373438">next</a><span>|</span><label class="collapse" for="c-40374456">[-]</label><label class="expand" for="c-40374456">[1 more]</label></div><br/><div class="children"><div class="content">If you run it through bayes theorem, it adjusts the posterior very little.</div><br/></div></div></div></div></div></div></div></div><div id="40373438" class="c"><input type="checkbox" id="c-40373438" checked=""/><div class="controls bullet"><span class="by">killingtime74</span><span>|</span><a href="#40371963">parent</a><span>|</span><a href="#40372953">prev</a><span>|</span><a href="#40374667">next</a><span>|</span><label class="collapse" for="c-40373438">[-]</label><label class="expand" for="c-40373438">[6 more]</label></div><br/><div class="children"><div class="content">Did you not do this work yourself before you started running the bank on it?</div><br/><div id="40373858" class="c"><input type="checkbox" id="c-40373858" checked=""/><div class="controls bullet"><span class="by">cdchn</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40373438">parent</a><span>|</span><a href="#40374667">next</a><span>|</span><label class="collapse" for="c-40373858">[-]</label><label class="expand" for="c-40373858">[5 more]</label></div><br/><div class="children"><div class="content">I doubt any organization that isn&#x27;t directly putting lives on the line are testing database technology as thoroughly and competently as Jepsen.  Banks jobs are to be banks, not be Jepsen.</div><br/><div id="40374872" class="c"><input type="checkbox" id="c-40374872" checked=""/><div class="controls bullet"><span class="by">killingtime74</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40373858">parent</a><span>|</span><a href="#40374667">next</a><span>|</span><label class="collapse" for="c-40374872">[-]</label><label class="expand" for="c-40374872">[4 more]</label></div><br/><div class="children"><div class="content">I would have thought they would be more rigorous, since mistakes for them could threaten the very viability of the business? Which is why I assume most are still on mainframes. (Never worked at a bank)</div><br/><div id="40375292" class="c"><input type="checkbox" id="c-40375292" checked=""/><div class="controls bullet"><span class="by">harperlee</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40374872">parent</a><span>|</span><a href="#40375828">next</a><span>|</span><label class="collapse" for="c-40375292">[-]</label><label class="expand" for="c-40375292">[1 more]</label></div><br/><div class="children"><div class="content">Banks exist since a long time before computers existed, and thus have ways to detect and correct errors that are not purely technological (such as double entry bookkeeping, backups, supporting documentation, different processes). So a bank can survive a db doing nasty things on a low enough frequency such that is not detected beforehand, so they don’t need to “prove in coq” that everything is correct.</div><br/></div></div><div id="40375828" class="c"><input type="checkbox" id="c-40375828" checked=""/><div class="controls bullet"><span class="by">cdchn</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40374872">parent</a><span>|</span><a href="#40375292">prev</a><span>|</span><a href="#40375355">next</a><span>|</span><label class="collapse" for="c-40375828">[-]</label><label class="expand" for="c-40375828">[1 more]</label></div><br/><div class="children"><div class="content">Mistakes don&#x27;t threaten them that much.  When Equifax (admittedly not a bank) can make massive negligent fuckups and still be a going concern there isn&#x27;t much heat there.  Most fuckups a bank make can be unwound.</div><br/></div></div><div id="40375355" class="c"><input type="checkbox" id="c-40375355" checked=""/><div class="controls bullet"><span class="by">Foobar8568</span><span>|</span><a href="#40371963">root</a><span>|</span><a href="#40374872">parent</a><span>|</span><a href="#40375828">prev</a><span>|</span><a href="#40374667">next</a><span>|</span><label class="collapse" for="c-40375355">[-]</label><label class="expand" for="c-40375355">[1 more]</label></div><br/><div class="children"><div class="content">Anyone who has worked in a bank and is glad of its solutions is either a fool, clueless or politician.<p>Banks have to answer to regulation and they do by doing the bare minimum they can get away with.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="40374667" class="c"><input type="checkbox" id="c-40374667" checked=""/><div class="controls bullet"><span class="by">poidos</span><span>|</span><a href="#40371963">prev</a><span>|</span><a href="#40371420">next</a><span>|</span><label class="collapse" for="c-40374667">[-]</label><label class="expand" for="c-40374667">[2 more]</label></div><br/><div class="children"><div class="content">Really nice work as always. I love reading these to learn more about these systems, for little tidbits of writing Clojure programs, and for the writing style. Thanks for what you do!</div><br/><div id="40375584" class="c"><input type="checkbox" id="c-40375584" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40374667">parent</a><span>|</span><a href="#40371420">next</a><span>|</span><label class="collapse" for="c-40375584">[-]</label><label class="expand" for="c-40375584">[1 more]</label></div><br/><div class="children"><div class="content">Thank you!</div><br/></div></div></div></div><div id="40371420" class="c"><input type="checkbox" id="c-40371420" checked=""/><div class="controls bullet"><span class="by">koito17</span><span>|</span><a href="#40374667">prev</a><span>|</span><a href="#40371013">next</a><span>|</span><label class="collapse" for="c-40371420">[-]</label><label class="expand" for="c-40371420">[4 more]</label></div><br/><div class="children"><div class="content">This is the first time I try reading a Jepsen report in-depth, but I really like the clear description of Datomic&#x27;s intra-transaction behavior. I didn&#x27;t realize how little I understood the difference between Datomic&#x27;s transactions and those of SQL databases.<p>One thing that stands out to me is this paragraph<p><pre><code>  Datomic used to refer to the data structure passed to d&#x2F;transact as a “transaction”, and to its elements as “statements” or “operations”. Going forward, Datomic intends to refer to this structure as a “transaction request”, and to its elements as “data”.
</code></pre>
What does this mean for d&#x2F;transact-async and related functionality from the datomic.api namespace? I haven&#x27;t used Datomic in nearly a year. A lot seems to have changed.</div><br/><div id="40372705" class="c"><input type="checkbox" id="c-40372705" checked=""/><div class="controls bullet"><span class="by">stuarthalloway</span><span>|</span><a href="#40371420">parent</a><span>|</span><a href="#40371013">next</a><span>|</span><label class="collapse" for="c-40372705">[-]</label><label class="expand" for="c-40372705">[3 more]</label></div><br/><div class="children"><div class="content">Datomic software needed no changes as a result of Jepsen testing. All functionality in datomic.api is unchanged.</div><br/><div id="40374021" class="c"><input type="checkbox" id="c-40374021" checked=""/><div class="controls bullet"><span class="by">klysm</span><span>|</span><a href="#40371420">root</a><span>|</span><a href="#40372705">parent</a><span>|</span><a href="#40371013">next</a><span>|</span><label class="collapse" for="c-40374021">[-]</label><label class="expand" for="c-40374021">[2 more]</label></div><br/><div class="children"><div class="content">Congrats, that is a rare outcome!</div><br/><div id="40375591" class="c"><input type="checkbox" id="c-40375591" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40371420">root</a><span>|</span><a href="#40374021">parent</a><span>|</span><a href="#40371013">next</a><span>|</span><label class="collapse" for="c-40375591">[-]</label><label class="expand" for="c-40375591">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, I think this is next to Zookeeper as one of the most positive Jepsen reports. :-)</div><br/></div></div></div></div></div></div></div></div><div id="40371013" class="c"><input type="checkbox" id="c-40371013" checked=""/><div class="controls bullet"><span class="by">amgreg</span><span>|</span><a href="#40371420">prev</a><span>|</span><a href="#40374805">next</a><span>|</span><label class="collapse" for="c-40371013">[-]</label><label class="expand" for="c-40371013">[18 more]</label></div><br/><div class="children"><div class="content">It struck me that Jepsen has identified clear situations leading to invariant violations but Datomic’s approach seems to have been purely to clarify their documentation.  Does this essentially mean the Datomic team accepts that the violations will happen, but don’t care?<p>From the article:<p>&gt; From Datomic’s point of view, the grant workload’s invariant violation is a matter of user error. Transaction functions do not execute atomically in sequence. Checking that a precondition holds in a transaction function is unsafe when some other operation in the transaction could invalidate that precondition!</div><br/><div id="40371918" class="c"><input type="checkbox" id="c-40371918" checked=""/><div class="controls bullet"><span class="by">stuarthalloway</span><span>|</span><a href="#40371013">parent</a><span>|</span><a href="#40371545">next</a><span>|</span><label class="collapse" for="c-40371918">[-]</label><label class="expand" for="c-40371918">[9 more]</label></div><br/><div class="children"><div class="content">As Jepsen confirmed, Datomic’s mechanisms for enforcing invariants work as designed. What does this mean practically for users? Consider the following transactional pseudo-data:<p>[<p>[Stu favorite-number 41]<p>;; maybe more stuff<p>[Stu favorite-number 42]<p>]<p>An operational reading of this data would be that early in the transaction I liked 41, and that later in the transaction I liked 42. Observers after the end of the transaction would hopefully see only that I liked 42, and we would have to worry about the conditions under which observers might see that 41.<p>This operational reading of intra-transaction semantics is typical of many databases, but it presumes the existence of multiple time points inside a transaction, which Datomic neither has nor wants — we quite like not worrying about what happened “in the middle of” a transaction. All facts in a transaction take place at the same point in time, so in Datomic this transaction states that I started liking both numbers simultaneously.<p>If you incorrectly read Datomic transactions as composed of multiple operations, you can of course find all kinds of “invariant anomalies”. Conversely, you can find “invariant anomalies” in SQL by incorrectly imposing Datomic’s model on SQL transactions. Such potential misreadings emphasize the need for good documentation. To that end, we have worked with Jepsen to enhance our documentation [1], tightening up casual language in the hopes of preventing misconceptions. We also added a tech note [2] addressing this particular misconception directly.<p>[1] <a href="https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transactions.html#transaction-execution" rel="nofollow">https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transactions.html#tran...</a><p>[2] <a href="https:&#x2F;&#x2F;docs.datomic.com&#x2F;tech-notes&#x2F;comparison-with-updating-transactions.html" rel="nofollow">https:&#x2F;&#x2F;docs.datomic.com&#x2F;tech-notes&#x2F;comparison-with-updating...</a></div><br/><div id="40372080" class="c"><input type="checkbox" id="c-40372080" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40371918">parent</a><span>|</span><a href="#40372407">next</a><span>|</span><label class="collapse" for="c-40372080">[-]</label><label class="expand" for="c-40372080">[4 more]</label></div><br/><div class="children"><div class="content">To build on this, Datomic includes a pre-commit conflict check that would prevent this particular example from committing at all: it detects that there are two incompatible assertions for the same entity&#x2F;attribute pair, and rejects the transaction. We think this conflict check likely prevents many users from actually hitting this issue in production.<p>The issue we discuss in the report only occurs when the transaction expands to non-conflicting datoms--for instance:<p>[Stu favorite-number 41]<p>[Stu hates-all-numbers-and-has-no-favorite true]<p>These entity&#x2F;attribute pairs are disjoint, so the conflict checker allows the transaction to commit, producing a record which is in a logically inconsistent state!<p>On the documentation front--Datomic users could be forgiven for thinking of the elements of transactions as &quot;operations&quot;, since Datomic&#x27;s docs called them both &quot;operations&quot; and &quot;statements&quot;. ;-)</div><br/><div id="40372598" class="c"><input type="checkbox" id="c-40372598" checked=""/><div class="controls bullet"><span class="by">stuarthalloway</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40372080">parent</a><span>|</span><a href="#40372809">next</a><span>|</span><label class="collapse" for="c-40372598">[-]</label><label class="expand" for="c-40372598">[2 more]</label></div><br/><div class="children"><div class="content">Mea culpa on the docs, mea culpa. Better now [1].<p>In order for user code to impose invariants over the entire transaction, it must have access to the entire transaction. Entity predicates have such access (they are passed the after db, which includes the pending transaction and all other transactions to boot). Transaction functions are unsuitable, as they have access only to the before db. [2]<p>Use entity predicates for arbitrary functional validations of the entire transaction.<p>[1] <a href="https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transactions.html#transaction-execution" rel="nofollow">https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transactions.html#tran...</a><p>[2] <a href="https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transaction-functions.html#when-to-use" rel="nofollow">https:&#x2F;&#x2F;docs.datomic.com&#x2F;transactions&#x2F;transaction-functions....</a></div><br/><div id="40373637" class="c"><input type="checkbox" id="c-40373637" checked=""/><div class="controls bullet"><span class="by">lgrapenthin</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40372598">parent</a><span>|</span><a href="#40372809">next</a><span>|</span><label class="collapse" for="c-40373637">[-]</label><label class="expand" for="c-40373637">[1 more]</label></div><br/><div class="children"><div class="content">Somewhat unrelated ad docs: It appears that &quot;Query&quot; opens a deadlink</div><br/></div></div></div></div><div id="40372809" class="c"><input type="checkbox" id="c-40372809" checked=""/><div class="controls bullet"><span class="by">Voultapher</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40372080">parent</a><span>|</span><a href="#40372598">prev</a><span>|</span><a href="#40372407">next</a><span>|</span><label class="collapse" for="c-40372809">[-]</label><label class="expand" for="c-40372809">[1 more]</label></div><br/><div class="children"><div class="content">The man the myth the legend himself. I haven&#x27;t ceased to be awed by how often the relevant person shows up in the HN comment section.<p>Loved your talks.</div><br/></div></div></div></div><div id="40372407" class="c"><input type="checkbox" id="c-40372407" checked=""/><div class="controls bullet"><span class="by">puredanger</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40371918">parent</a><span>|</span><a href="#40372080">prev</a><span>|</span><a href="#40371545">next</a><span>|</span><label class="collapse" for="c-40372407">[-]</label><label class="expand" for="c-40372407">[4 more]</label></div><br/><div class="children"><div class="content">Datomic transactions are not “operations to perform”, they are a set of novel facts to incorporate at a point in time.<p>Just like a git commit describes a set of modifications, do you or should you want to care about which order or how the adds, updates, and deletes occur in a single git commit? OMG no, that sounds awful.<p>The really unusual thing is that developers expect intra-transaction ordering to be a thing they accept from any other database. OMG, that sounds awful, how do you live like that.</div><br/><div id="40373059" class="c"><input type="checkbox" id="c-40373059" checked=""/><div class="controls bullet"><span class="by">voganmother42</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40372407">parent</a><span>|</span><a href="#40373878">next</a><span>|</span><label class="collapse" for="c-40373059">[-]</label><label class="expand" for="c-40373059">[1 more]</label></div><br/><div class="children"><div class="content">Nested transactions or savepoints also exist in other systems</div><br/></div></div><div id="40373878" class="c"><input type="checkbox" id="c-40373878" checked=""/><div class="controls bullet"><span class="by">cdchn</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40372407">parent</a><span>|</span><a href="#40373059">prev</a><span>|</span><a href="#40371545">next</a><span>|</span><label class="collapse" for="c-40373878">[-]</label><label class="expand" for="c-40373878">[2 more]</label></div><br/><div class="children"><div class="content">Do developers not expect intra-transaction ordering from within a transaction?</div><br/><div id="40374267" class="c"><input type="checkbox" id="c-40374267" checked=""/><div class="controls bullet"><span class="by">kccqzy</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40373878">parent</a><span>|</span><a href="#40371545">next</a><span>|</span><label class="collapse" for="c-40374267">[-]</label><label class="expand" for="c-40374267">[1 more]</label></div><br/><div class="children"><div class="content">It depends on the previous experience of said developers, and such expectation varies widely.</div><br/></div></div></div></div></div></div></div></div><div id="40371545" class="c"><input type="checkbox" id="c-40371545" checked=""/><div class="controls bullet"><span class="by">SoftTalker</span><span>|</span><a href="#40371013">parent</a><span>|</span><a href="#40371918">prev</a><span>|</span><a href="#40371198">next</a><span>|</span><label class="collapse" for="c-40371545">[-]</label><label class="expand" for="c-40371545">[1 more]</label></div><br/><div class="children"><div class="content">Sounds similar to the need to know that in some relational databases, you need to SELECT ... FOR UPDATE if you intend to perform an update that depends on the values you just selected.</div><br/></div></div><div id="40371198" class="c"><input type="checkbox" id="c-40371198" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40371013">parent</a><span>|</span><a href="#40371545">prev</a><span>|</span><a href="#40375386">next</a><span>|</span><label class="collapse" for="c-40371198">[-]</label><label class="expand" for="c-40371198">[5 more]</label></div><br/><div class="children"><div class="content">Yeah, this basically boils down to &quot;a potential pitfall, but consistent with documentation, and working as designed&quot;. Whether this actually matters depends on whether users are writing transaction functions which are <i>intended</i> to preserve some invariant, but would only do so if executed sequentially, rather than concurrently.<p>Datomic&#x27;s position (and Datomic, please chime in here!) is that users simply do not write transaction functions like this very often. This is defensible: the docs did explicitly state that transaction functions observe the start-of-transaction state, not one another! On the other hand, there was also language in the docs that suggested transaction functions could be used to preserve invariants: &quot;[txn fns] can atomically analyze and transform database values. You can use them to ensure atomic read-modify-update processing, and integrity constraints...&quot;. That language, combined with the fact that basically every other Serializable DB uses sequential intra-transaction semantics, is why I devoted so much attention to this issue in the report.<p>It&#x27;s a complex question and I don&#x27;t have a clear-cut answer! I&#x27;d love to hear what the general DB community and Datomic users in particular make of these semantics.</div><br/><div id="40371300" class="c"><input type="checkbox" id="c-40371300" checked=""/><div class="controls bullet"><span class="by">nickpeterson</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40371198">parent</a><span>|</span><a href="#40373311">next</a><span>|</span><label class="collapse" for="c-40371300">[-]</label><label class="expand" for="c-40371300">[2 more]</label></div><br/><div class="children"><div class="content">I feel like “enough rope to shoot yourself” is kind of baked into any high power, low ceremony tool.</div><br/><div id="40372322" class="c"><input type="checkbox" id="c-40372322" checked=""/><div class="controls bullet"><span class="by">stuarthalloway</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40371300">parent</a><span>|</span><a href="#40373311">next</a><span>|</span><label class="collapse" for="c-40372322">[-]</label><label class="expand" for="c-40372322">[1 more]</label></div><br/><div class="children"><div class="content">As a proponent of just such tools I would say also that &quot;enough rope to shoot(?) yourself&quot; is inherent in tools powerful enough to get anything done, and is not a tradeoff encountered only when reaching for high power or low ceremony.</div><br/></div></div></div></div><div id="40373311" class="c"><input type="checkbox" id="c-40373311" checked=""/><div class="controls bullet"><span class="by">refset</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40371198">parent</a><span>|</span><a href="#40371300">prev</a><span>|</span><a href="#40375386">next</a><span>|</span><label class="collapse" for="c-40373311">[-]</label><label class="expand" for="c-40373311">[2 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know whether it was intentional or not, but IIRC DataScript opted for sequential intra-transaction semantics instead.</div><br/><div id="40374278" class="c"><input type="checkbox" id="c-40374278" checked=""/><div class="controls bullet"><span class="by">huahaiy</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40373311">parent</a><span>|</span><a href="#40375386">next</a><span>|</span><label class="collapse" for="c-40374278">[-]</label><label class="expand" for="c-40374278">[1 more]</label></div><br/><div class="children"><div class="content">Correct. I don&#x27;t know about DataScript&#x27;s intention, but it is intentional for Datalevin, as we have tests for sequential intra-transaction semantics.</div><br/></div></div></div></div></div></div><div id="40375386" class="c"><input type="checkbox" id="c-40375386" checked=""/><div class="controls bullet"><span class="by">aaroniba</span><span>|</span><a href="#40371013">parent</a><span>|</span><a href="#40371198">prev</a><span>|</span><a href="#40374805">next</a><span>|</span><label class="collapse" for="c-40375386">[-]</label><label class="expand" for="c-40375386">[2 more]</label></div><br/><div class="children"><div class="content">I think the article answers your question at the end of section 3.1:<p>&gt; &quot;This behavior may be surprising, but it is generally consistent with Datomic’s documentation. Nubank does not intend to alter this behavior, and we do not consider it a bug.&quot;<p>When you say, &quot;situations leading to invariant violations&quot; -- that sounds like some kind of bug in Datomic, which this is not.  One just has to understand how datomic processes transactions, and code accordingly.<p>I am unaffiliated with Nubank, but in my experience using Datomic as a general-purpose database, I have not encountered a situation where this was a problem.</div><br/><div id="40375610" class="c"><input type="checkbox" id="c-40375610" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40371013">root</a><span>|</span><a href="#40375386">parent</a><span>|</span><a href="#40374805">next</a><span>|</span><label class="collapse" for="c-40375610">[-]</label><label class="expand" for="c-40375610">[1 more]</label></div><br/><div class="children"><div class="content">This is good to hear! Nubank has also argued that in their extensive use of Datomic, this kind of issue doesn&#x27;t really show up. They suggest custom transaction functions are infrequently written, not often composed, and don&#x27;t usually perform the kind of precondition validation that would lead to this sort of mistake.</div><br/></div></div></div></div></div></div><div id="40374805" class="c"><input type="checkbox" id="c-40374805" checked=""/><div class="controls bullet"><span class="by">amluto</span><span>|</span><a href="#40371013">prev</a><span>|</span><a href="#40375759">next</a><span>|</span><label class="collapse" for="c-40374805">[-]</label><label class="expand" for="c-40374805">[7 more]</label></div><br/><div class="children"><div class="content">I wonder if Datomic’s model has room for something like an “extra-strict” transaction.  Such a transaction would operate exactly like an ordinary transaction except that it would also check that no transaction element reads a value or predicate that is modified by a different element. This would be a bit like saying that each element would work like an independent transaction, submitted concurrently, in a more conventional serializable database (with predicate locking!), except that the transaction only commits if <i>all</i> the elements would commit successfully.<p>This would have some runtime cost and would limit the set of things one could accomplish in a transaction.  But it would remove a footgun, and maybe this would be a good tradeoff for some users, especially if it could be disabled on a per-transaction basis.</div><br/><div id="40374969" class="c"><input type="checkbox" id="c-40374969" checked=""/><div class="controls bullet"><span class="by">lgrapenthin</span><span>|</span><a href="#40374805">parent</a><span>|</span><a href="#40374893">next</a><span>|</span><label class="collapse" for="c-40374969">[-]</label><label class="expand" for="c-40374969">[5 more]</label></div><br/><div class="children"><div class="content">I wouldn&#x27;t use it.  The footgun is imaginary.  I use Datomic for ten years and I can assure you that I never stepped on it.  As a Datomic user you see transactions as clean small diffs, not as complicated multi step processes.  This is actually much more pleasant to work with.</div><br/><div id="40375647" class="c"><input type="checkbox" id="c-40375647" checked=""/><div class="controls bullet"><span class="by">aphyr</span><span>|</span><a href="#40374805">root</a><span>|</span><a href="#40374969">parent</a><span>|</span><a href="#40375077">next</a><span>|</span><label class="collapse" for="c-40375647">[-]</label><label class="expand" for="c-40375647">[1 more]</label></div><br/><div class="children"><div class="content">This is also good to hear! I&#x27;m not sure whether I&#x27;d call it a &quot;footgun&quot; per se--that&#x27;s really an empirical question about how Datomic&#x27;s users understand its model. I can say that as someone with some database experience and a few weeks of reading the Datomic docs, this issue actually &quot;broke&quot; several of the tests I wrote for Datomic. It was especially tricky because the transactions <i>mostly</i> worked as expected, but would occasionally &quot;lose updates&quot; or cause updates intended for one entity to wind up assigned to another.<p>Things looked fine in my manual testing, but when I ran the full test suite Elle kept catching what looked like serious Serializability violations. Took me quite a while to figure out I was holding the database wrong!</div><br/></div></div><div id="40375077" class="c"><input type="checkbox" id="c-40375077" checked=""/><div class="controls bullet"><span class="by">amluto</span><span>|</span><a href="#40374805">root</a><span>|</span><a href="#40374969">parent</a><span>|</span><a href="#40375647">prev</a><span>|</span><a href="#40374893">next</a><span>|</span><label class="collapse" for="c-40375077">[-]</label><label class="expand" for="c-40375077">[3 more]</label></div><br/><div class="children"><div class="content">Now I’m curious: what’s a useful example of a Datomic transaction that reads a value in multiple of its elements <i>and</i> modifies it?</div><br/><div id="40375671" class="c"><input type="checkbox" id="c-40375671" checked=""/><div class="controls bullet"><span class="by">hlship</span><span>|</span><a href="#40374805">root</a><span>|</span><a href="#40375077">parent</a><span>|</span><a href="#40375315">next</a><span>|</span><label class="collapse" for="c-40375671">[-]</label><label class="expand" for="c-40375671">[1 more]</label></div><br/><div class="children"><div class="content">In traditional databases, only the database engine has a scalable view of the data - that’s why you send SQL to it and stream back the response data set. With Datomic, the peer has the same level of read access as the transactor; it’s like the database comes to you.<p>In this read and update scenario, the peer will, at its leisure, read existing data and put together update data; some careful use of compare and set, or a custom transaction function, can ensure that the database has not changed between read and writes in such a way that the update is improper, when that is even a possibility - a rarity.<p>At scale, you want to minimize the amount of work the transactor must perform, since it so aggressively single threaded. Off loading work to the peer is amazingly effective.</div><br/></div></div><div id="40375315" class="c"><input type="checkbox" id="c-40375315" checked=""/><div class="controls bullet"><span class="by">lgrapenthin</span><span>|</span><a href="#40374805">root</a><span>|</span><a href="#40375077">parent</a><span>|</span><a href="#40375671">prev</a><span>|</span><a href="#40374893">next</a><span>|</span><label class="collapse" for="c-40375315">[-]</label><label class="expand" for="c-40375315">[1 more]</label></div><br/><div class="children"><div class="content">You could include two transaction functions that constrain a transaction to different properties about the same fact and then alter that fact.  I don&#x27;t know of a practical usecase or that I ever encountered that, it would be extremely rare IME.</div><br/></div></div></div></div></div></div></div></div><div id="40375759" class="c"><input type="checkbox" id="c-40375759" checked=""/><div class="controls bullet"><span class="by">luc4sdreyer</span><span>|</span><a href="#40374805">prev</a><span>|</span><a href="#40372016">next</a><span>|</span><label class="collapse" for="c-40375759">[-]</label><label class="expand" for="c-40375759">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m a bit worried that most of the links on <a href="https:&#x2F;&#x2F;www.datomic.com&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.datomic.com&#x2F;</a> are broken.</div><br/></div></div><div id="40372016" class="c"><input type="checkbox" id="c-40372016" checked=""/><div class="controls bullet"><span class="by">thom</span><span>|</span><a href="#40375759">prev</a><span>|</span><a href="#40372694">next</a><span>|</span><label class="collapse" for="c-40372016">[-]</label><label class="expand" for="c-40372016">[2 more]</label></div><br/><div class="children"><div class="content">I’ve not really spent much time with Datomic in anger because it’s super weird, but is any of this surprising? Datomic transactions are basically just batches and I always thought it was single threaded so obviously it doesn’t have a lot of race conditions. It’s slow and safe by design.</div><br/><div id="40376101" class="c"><input type="checkbox" id="c-40376101" checked=""/><div class="controls bullet"><span class="by">rtpg</span><span>|</span><a href="#40372016">parent</a><span>|</span><a href="#40372694">next</a><span>|</span><label class="collapse" for="c-40376101">[-]</label><label class="expand" for="c-40376101">[1 more]</label></div><br/><div class="children"><div class="content">Well the example of &quot;incrementing x twice in the same transaction leads to x+1, not x+2&quot; seems pretty important! I imagine you gotta be quite careful!</div><br/></div></div></div></div><div id="40371625" class="c"><input type="checkbox" id="c-40371625" checked=""/><div class="controls bullet"><span class="by">CrazyPyroLinux</span><span>|</span><a href="#40372694">prev</a><span>|</span><a href="#40371312">next</a><span>|</span><label class="collapse" for="c-40371625">[-]</label><label class="expand" for="c-40371625">[1 more]</label></div><br/><div class="children"><div class="content">aphyr had given some conference talks on previous analyses (available on youtube) that are informative and entertaining</div><br/></div></div><div id="40371262" class="c"><input type="checkbox" id="c-40371262" checked=""/><div class="controls bullet"><span class="by">baq</span><span>|</span><a href="#40371312">prev</a><span>|</span><label class="collapse" for="c-40371262">[-]</label><label class="expand" for="c-40371262">[1 more]</label></div><br/><div class="children"><div class="content">aphyr you bastard I&#x27;ve got work to do today.</div><br/></div></div></div></div></div></div></div></body></html>