<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1722157261556" as="style"/><link rel="stylesheet" href="styles.css?v=1722157261556"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.davidv.dev/posts/pcie-driver-dma/">Learning about PCI-e: Driver and DMA</a>Â <span class="domain">(<a href="https://blog.davidv.dev">blog.davidv.dev</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>17 comments</span></div><br/><div><div id="41086981" class="c"><input type="checkbox" id="c-41086981" checked=""/><div class="controls bullet"><span class="by">deivid</span><span>|</span><a href="#41088306">next</a><span>|</span><label class="collapse" for="c-41086981">[-]</label><label class="expand" for="c-41086981">[14 more]</label></div><br/><div class="children"><div class="content">The end goal in this series is to use an FPGA to build a display adapter, I&#x27;ve gotten a Tang Mega 138k [0] to start the process but there is not a lot of documentation, so it is taking a while<p>If you got recommendations for other (cheap) FPGA boards with PCI-e hard IP, do let me know.<p>[0]: <a href="https:&#x2F;&#x2F;wiki.sipeed.com&#x2F;hardware&#x2F;en&#x2F;tang&#x2F;tang-mega-138k&#x2F;mega-138k-pro.html" rel="nofollow">https:&#x2F;&#x2F;wiki.sipeed.com&#x2F;hardware&#x2F;en&#x2F;tang&#x2F;tang-mega-138k&#x2F;mega...</a></div><br/><div id="41087390" class="c"><input type="checkbox" id="c-41087390" checked=""/><div class="controls bullet"><span class="by">kvemkon</span><span>|</span><a href="#41086981">parent</a><span>|</span><a href="#41089192">next</a><span>|</span><label class="collapse" for="c-41087390">[-]</label><label class="expand" for="c-41087390">[4 more]</label></div><br/><div class="children"><div class="content">Now I&#x27;m recalling, there are also cheap ready PCIe FPGA based products but for video recording:<p>- Spartan 6 <a href="https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs&#x2F;W-DLK-29" rel="nofollow">https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs...</a><p>- Artix <a href="https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs&#x2F;W-DLK-35" rel="nofollow">https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs...</a><p>- Artix <a href="https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs&#x2F;W-DLK-38" rel="nofollow">https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs...</a><p>- Artix <a href="https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs&#x2F;W-DLK-39" rel="nofollow">https:&#x2F;&#x2F;www.blackmagicdesign.com&#x2F;products&#x2F;decklink&#x2F;techspecs...</a></div><br/><div id="41088690" class="c"><input type="checkbox" id="c-41088690" checked=""/><div class="controls bullet"><span class="by">KeplerBoy</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41087390">parent</a><span>|</span><a href="#41089192">next</a><span>|</span><label class="collapse" for="c-41088690">[-]</label><label class="expand" for="c-41088690">[3 more]</label></div><br/><div class="children"><div class="content">These seem to be ready made products opposed to devkits. Can the FPGAs be easily reprogrammed?</div><br/><div id="41088871" class="c"><input type="checkbox" id="c-41088871" checked=""/><div class="controls bullet"><span class="by">tadfisher</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41088690">parent</a><span>|</span><a href="#41091068">next</a><span>|</span><label class="collapse" for="c-41088871">[-]</label><label class="expand" for="c-41088871">[1 more]</label></div><br/><div class="children"><div class="content">FPGAs usually need their bitstream (analogous to firmware) loaded after power-on, so either there is a flash chip on the device that contains it, or it is loaded over the PCI bus from the host machine via a software driver. Either way you&#x27;ll likely need to reverse-engineer and modify the firmware and host-side device driver. There are often better choices, such as dev boards, to play around with FPGAs.</div><br/></div></div><div id="41091068" class="c"><input type="checkbox" id="c-41091068" checked=""/><div class="controls bullet"><span class="by">Joel_Mckay</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41088690">parent</a><span>|</span><a href="#41088871">prev</a><span>|</span><a href="#41089192">next</a><span>|</span><label class="collapse" for="c-41091068">[-]</label><label class="expand" for="c-41091068">[1 more]</label></div><br/><div class="children"><div class="content">In general, the SRAM based units have a asic boot loader that may often be reconfigured with external pin logic.  i.e. the chip configuration may be pulled from internal flash memory, sdcard, and external spi flash.   Most designs I see place external spi flash chips next to the fpga, and the JTAG header in some convenient location.<p>While some modern high-performance fpga chips may have internal flash and an asic cpu...  the configuration can generally still be updated with relative ease.<p>Notably, there are some exceptions where some chips may have fuses blown to lock it down, or were substituted with a One Time Programmable chip variant in production.<p>All that aside, the IP license to make it work will likely be unavailable for free, and high-speed&#x2F;lvds layout is a black art requiring some pricey equipment to get clean performance.<p>One is often better off getting an overpriced  xilinx PCIe development kit from a vendor, as most of the basic IP issues are solved... and one may focus on your core application.<p>Reverse engineering high-speed boards are way more work than most folks could imagine.<p>Best regards, =3</div><br/></div></div></div></div></div></div><div id="41089192" class="c"><input type="checkbox" id="c-41089192" checked=""/><div class="controls bullet"><span class="by">15155</span><span>|</span><a href="#41086981">parent</a><span>|</span><a href="#41087390">prev</a><span>|</span><a href="#41087275">next</a><span>|</span><label class="collapse" for="c-41089192">[-]</label><label class="expand" for="c-41089192">[4 more]</label></div><br/><div class="children"><div class="content">I would definitely use Xilinx over anything else here - Vivado isn&#x27;t &quot;great&quot; by any pro-SWE&#x27;s standard of tooling, but is absolutely best-in-class for FPGA development and implementation.<p>The Xilinx PCIe device path is pretty well-trodden.</div><br/><div id="41089221" class="c"><input type="checkbox" id="c-41089221" checked=""/><div class="controls bullet"><span class="by">deivid</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41089192">parent</a><span>|</span><a href="#41087275">next</a><span>|</span><label class="collapse" for="c-41089221">[-]</label><label class="expand" for="c-41089221">[3 more]</label></div><br/><div class="children"><div class="content">Any dev kit you can buy in the low hundreds? I thought the UltraScale was in the low _thousands_</div><br/><div id="41091781" class="c"><input type="checkbox" id="c-41091781" checked=""/><div class="controls bullet"><span class="by">adrian_b</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41089221">parent</a><span>|</span><a href="#41090228">next</a><span>|</span><label class="collapse" for="c-41091781">[-]</label><label class="expand" for="c-41091781">[1 more]</label></div><br/><div class="children"><div class="content">For making a product with UltraScale+, you do not need a dev kit.<p>You may use e.g. the KRIA K24 SOM ($250) or the KRIA K26 SOM ($325) (the sizes of the FPGAs differ for these variants).<p>For designing a product with these SOMs, you can buy a few cheap development boards (the development boards including a SOM are cheaper than the SOM bought separately, so obviously they cannot be bought in big quantities) like the Kria KD240 Drives Starter Kit or the Kria KV260 Vision AI Starter Kit or the Kria KR260 Robotics Starter Kit.<p>You may buy these SOMs as single units at higher prices or as hundreds at discounted prices at many distributors.<p>These SOMs include 2 GB or 4 GB DRAM memory, QSPI or eMMC flash memory and some interfaces, like USB 3, Ethernet, PCIe Gen2 x4, transceivers suitable for HDMI 2.0 and DisplayPort 1.4 etc. and the FPGAs include quadruple Cortex-A53 + double Cortex-R5 cores, which can initialize the FPGA or reconfigure it remotely whenever desired and which can run a Linux OS. The FPGA also includes a Video Codec Unit, but that is limited to an aggregated resolution of 4kp60 (i.e. either a single 4k stream or up to 32 lower resolution streams), and also a Mali GPU and a (slow) DisplayPort controller that can be used as the video output for the operating system run on the Arm cores.</div><br/></div></div><div id="41090228" class="c"><input type="checkbox" id="c-41090228" checked=""/><div class="controls bullet"><span class="by">15155</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41089221">parent</a><span>|</span><a href="#41091781">prev</a><span>|</span><a href="#41087275">next</a><span>|</span><label class="collapse" for="c-41090228">[-]</label><label class="expand" for="c-41090228">[1 more]</label></div><br/><div class="children"><div class="content">Do you need UltraScale(+)? The Tang Mega 138k has way fewer LUTs than most US+ chips, it&#x27;s a completely different class of FPGA.<p>You can purchase a SQRL FK33 (VU33P on PCIE cards) for $250 used in the Dream escrow Discord. Here&#x27;s one on eBay for $400 (a little steep) - this is the cheapest you will get into UltraScale+: <a href="https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;387229340513" rel="nofollow">https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;387229340513</a> This is also the <i>cheapest</i> way to obtain 8GB of HBM, which you will want for a GPU eventually.<p>For $1000ish, you can get a C1100 (VU35P, 2x the area of VU33P, 8GB HBM) - <a href="https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;186414684753" rel="nofollow">https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;186414684753</a> - these do not require a Vivado license.<p>For $600-1300 you can get VCU1525 (VU9P - no HBM) boards used: <a href="https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;326206486963" rel="nofollow">https:&#x2F;&#x2F;www.ebay.com&#x2F;itm&#x2F;326206486963</a><p>For new stuff, you could get 7 Series Kintex devboards from China: <a href="https:&#x2F;&#x2F;www.aliexpress.us&#x2F;item&#x2F;3256805175295035.html" rel="nofollow">https:&#x2F;&#x2F;www.aliexpress.us&#x2F;item&#x2F;3256805175295035.html</a></div><br/></div></div></div></div></div></div><div id="41087275" class="c"><input type="checkbox" id="c-41087275" checked=""/><div class="controls bullet"><span class="by">kvemkon</span><span>|</span><a href="#41086981">parent</a><span>|</span><a href="#41089192">prev</a><span>|</span><a href="#41088306">next</a><span>|</span><label class="collapse" for="c-41087275">[-]</label><label class="expand" for="c-41087275">[5 more]</label></div><br/><div class="children"><div class="content">Screamer PCIe Squirrel for 159 Euro (w&#x2F;o tax) using Xilinx Artix XC7A35T (according photo). But it has only one high-speed external interface: USB 3.1 Gen 1.<p><a href="https:&#x2F;&#x2F;shop.lambdaconcept.com&#x2F;home&#x2F;50-screamer-pcie-squirrel.html" rel="nofollow">https:&#x2F;&#x2F;shop.lambdaconcept.com&#x2F;home&#x2F;50-screamer-pcie-squirre...</a><p>Litefury, Xilinx Artix FPGA kit in &quot;NVMe SSD&quot; form factor (2280 Key M) for 102 Euro using Xilinx XC7A100T. It has only few external high-speed LVDS I&#x2F;O.<p><a href="https:&#x2F;&#x2F;rhsresearch.com&#x2F;collections&#x2F;rhs-public&#x2F;products&#x2F;litefury" rel="nofollow">https:&#x2F;&#x2F;rhsresearch.com&#x2F;collections&#x2F;rhs-public&#x2F;products&#x2F;lite...</a></div><br/><div id="41088531" class="c"><input type="checkbox" id="c-41088531" checked=""/><div class="controls bullet"><span class="by">mng2</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41087275">parent</a><span>|</span><a href="#41087506">next</a><span>|</span><label class="collapse" for="c-41088531">[-]</label><label class="expand" for="c-41088531">[1 more]</label></div><br/><div class="children"><div class="content">The Litefury&#x2F;Nitefury&#x2F;Acorn design has enough I&#x2F;O for an HDMI output. I&#x27;ve designed a little board with a buffer:<p><a href="https:&#x2F;&#x2F;github.com&#x2F;mng2&#x2F;AcornHDMI">https:&#x2F;&#x2F;github.com&#x2F;mng2&#x2F;AcornHDMI</a><p>Even with the fastest speed grade Artix, 1080p output is technically out of spec, but it seems to work OK.<p>As you might guess I had&#x2F;have my own ambitions of making a video card. The software side has been a source of dread for me, but with OP&#x27;s tutorials I may have enough guidance to get back to it.</div><br/></div></div><div id="41087506" class="c"><input type="checkbox" id="c-41087506" checked=""/><div class="controls bullet"><span class="by">deivid</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41087275">parent</a><span>|</span><a href="#41088531">prev</a><span>|</span><a href="#41088306">next</a><span>|</span><label class="collapse" for="c-41087506">[-]</label><label class="expand" for="c-41087506">[3 more]</label></div><br/><div class="children"><div class="content">The screamer looks interesting, using Displayport Alt mode could work!</div><br/><div id="41087641" class="c"><input type="checkbox" id="c-41087641" checked=""/><div class="controls bullet"><span class="by">nereye</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41087506">parent</a><span>|</span><a href="#41087695">next</a><span>|</span><label class="collapse" for="c-41087641">[-]</label><label class="expand" for="c-41087641">[1 more]</label></div><br/><div class="children"><div class="content">The ULX4M boards are not available yet but seem to support both PCIe as well as digital video:<p><a href="https:&#x2F;&#x2F;kitspace.org&#x2F;boards&#x2F;github.com&#x2F;intergalaktik&#x2F;ulx4m&#x2F;" rel="nofollow">https:&#x2F;&#x2F;kitspace.org&#x2F;boards&#x2F;github.com&#x2F;intergalaktik&#x2F;ulx4m&#x2F;</a><p>Done by the same team who did the ULX3S.</div><br/></div></div><div id="41087695" class="c"><input type="checkbox" id="c-41087695" checked=""/><div class="controls bullet"><span class="by">namibj</span><span>|</span><a href="#41086981">root</a><span>|</span><a href="#41087506">parent</a><span>|</span><a href="#41087641">prev</a><span>|</span><a href="#41088306">next</a><span>|</span><label class="collapse" for="c-41087695">[-]</label><label class="expand" for="c-41087695">[1 more]</label></div><br/><div class="children"><div class="content">Actually not, it&#x27;s wired via a FT601.
However, that&#x27;s not saying it can&#x27;t be useful.<p>E.g. you could make it behave like a UVC-type USB3 webcam for the video output.</div><br/></div></div></div></div></div></div></div></div><div id="41088306" class="c"><input type="checkbox" id="c-41088306" checked=""/><div class="controls bullet"><span class="by">loeg</span><span>|</span><a href="#41086981">prev</a><span>|</span><a href="#41089462">next</a><span>|</span><label class="collapse" for="c-41088306">[-]</label><label class="expand" for="c-41088306">[1 more]</label></div><br/><div class="children"><div class="content">This seems like a great intro to Linux PCIe device drivers.  I&#x27;ve never worked with Linux device drivers but have worked with multiple PCIe drivers on a different operating system years ago, and the concepts look very familiar.  Love to see more of this type of content in the world.</div><br/></div></div><div id="41089462" class="c"><input type="checkbox" id="c-41089462" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#41088306">prev</a><span>|</span><label class="collapse" for="c-41089462">[-]</label><label class="expand" for="c-41089462">[1 more]</label></div><br/><div class="children"><div class="content">I really, really like the way these articles flow, with just enough code to illustrate their point, and a gradual build. This is good stuff. I have never in my life wanted to make a new PCI device, but now I kind of do, which is like the acid test for good technical writing, right?</div><br/></div></div></div></div></div></div></div></body></html>