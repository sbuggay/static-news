<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1695805265369" as="style"/><link rel="stylesheet" href="styles.css?v=1695805265369"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.timdbg.com/posts/writing-a-debugger-from-scratch-part-5/">Writing a debugger from scratch: Breakpoints</a> <span class="domain">(<a href="https://www.timdbg.com">www.timdbg.com</a>)</span></div><div class="subtext"><span>ingve</span> | <span>12 comments</span></div><br/><div><div id="37671554" class="c"><input type="checkbox" id="c-37671554" checked=""/><div class="controls bullet"><span class="by">danparsonson</span><span>|</span><a href="#37671398">next</a><span>|</span><label class="collapse" for="c-37671554">[-]</label><label class="expand" for="c-37671554">[6 more]</label></div><br/><div class="children"><div class="content">Great article, thanks - one question I couldn&#x27;t see answered there is, what do you do when you want to set more than four breakpoints at once?</div><br/><div id="37671672" class="c"><input type="checkbox" id="c-37671672" checked=""/><div class="controls bullet"><span class="by">ithkuil</span><span>|</span><a href="#37671554">parent</a><span>|</span><a href="#37671645">next</a><span>|</span><label class="collapse" for="c-37671672">[-]</label><label class="expand" for="c-37671672">[4 more]</label></div><br/><div class="children"><div class="content">You use software breakpoints.<p>Basically you overwrite the instruction you want to break at with a breakpoint instruction (e.g. int 3 on x86). This will cause the process to trap and the OS will then let the debugger process know about out somehow, e.g. via the SIGTRAP signal on Unix.<p>The debugger then replaces the int 3 opcode (which is a single byte conveniently) with the first byte of the original instruction so that the execution can continue.</div><br/><div id="37671833" class="c"><input type="checkbox" id="c-37671833" checked=""/><div class="controls bullet"><span class="by">hinoki</span><span>|</span><a href="#37671554">root</a><span>|</span><a href="#37671672">parent</a><span>|</span><a href="#37671645">next</a><span>|</span><label class="collapse" for="c-37671833">[-]</label><label class="expand" for="c-37671833">[3 more]</label></div><br/><div class="children"><div class="content">If you revert the int 3 to the original instruction’s byte, when do you put it back? The breakpoint could still be active.<p>In a trivial example, the breaking instruction could be a jump to itself, which you’d expect to immediately break into the debugger again.<p>I thought the debugger had to emulate the instruction instead, but it’s not like I’ve ever implemented one…</div><br/><div id="37671909" class="c"><input type="checkbox" id="c-37671909" checked=""/><div class="controls bullet"><span class="by">ithkuil</span><span>|</span><a href="#37671554">root</a><span>|</span><a href="#37671833">parent</a><span>|</span><a href="#37671941">next</a><span>|</span><label class="collapse" for="c-37671909">[-]</label><label class="expand" for="c-37671909">[1 more]</label></div><br/><div class="children"><div class="content">Emulation is an option, rotating hardware debug registers is another option, detecting self-jumps is another option.<p>I really only implemented a debugger for the esp8266 and it was just good enough for me and my team to get our job done so it didn&#x27;t handle many edge cases like that</div><br/></div></div><div id="37671941" class="c"><input type="checkbox" id="c-37671941" checked=""/><div class="controls bullet"><span class="by">i_don_t_know</span><span>|</span><a href="#37671554">root</a><span>|</span><a href="#37671833">parent</a><span>|</span><a href="#37671909">prev</a><span>|</span><a href="#37671645">next</a><span>|</span><label class="collapse" for="c-37671941">[-]</label><label class="expand" for="c-37671941">[1 more]</label></div><br/><div class="children"><div class="content">I believe when you resume the debugger, you can tell the process&#x2F;thread to single-step over one instruction. So it&#x27;s something like this:<p>1. Overwrite instruction with int 3.<p>2. When you hit the breakpoint, restore the original instruction.<p>3. Single-step over the original instruction by changing the thread&#x27;s EFlags (Intel).<p>4. Restore the breakpoint with int 3.<p>5. Resume normally.</div><br/></div></div></div></div></div></div><div id="37671645" class="c"><input type="checkbox" id="c-37671645" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#37671554">parent</a><span>|</span><a href="#37671672">prev</a><span>|</span><a href="#37671398">next</a><span>|</span><label class="collapse" for="c-37671645">[-]</label><label class="expand" for="c-37671645">[1 more]</label></div><br/><div class="children"><div class="content">Use software breakpoints (which are mentioned but not described, the short story for those is you overwrite the address you care about with an illegal instruction and execution traps when it encounters that code, and then you undo it to continue).</div><br/></div></div></div></div><div id="37671398" class="c"><input type="checkbox" id="c-37671398" checked=""/><div class="controls bullet"><span class="by">zubairq</span><span>|</span><a href="#37671554">prev</a><span>|</span><label class="collapse" for="c-37671398">[-]</label><label class="expand" for="c-37671398">[5 more]</label></div><br/><div class="children"><div class="content">Really nice read. Does anyone know any other good articles or videos about how to write a debugger?</div><br/><div id="37671850" class="c"><input type="checkbox" id="c-37671850" checked=""/><div class="controls bullet"><span class="by">Modified3019</span><span>|</span><a href="#37671398">parent</a><span>|</span><a href="#37671670">next</a><span>|</span><label class="collapse" for="c-37671850">[-]</label><label class="expand" for="c-37671850">[1 more]</label></div><br/><div class="children"><div class="content">Not what you asked for, but if that&#x27;s your interest you&#x27;ll probably appreciate <a href="https:&#x2F;&#x2F;justine.lol&#x2F;blinkenlights&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;justine.lol&#x2F;blinkenlights&#x2F;</a></div><br/></div></div><div id="37671670" class="c"><input type="checkbox" id="c-37671670" checked=""/><div class="controls bullet"><span class="by">emmanueloga_</span><span>|</span><a href="#37671398">parent</a><span>|</span><a href="#37671850">prev</a><span>|</span><a href="#37671764">next</a><span>|</span><label class="collapse" for="c-37671670">[-]</label><label class="expand" for="c-37671670">[1 more]</label></div><br/><div class="children"><div class="content">I was asking this myself this while reading the book &quot;Crafting Interpreters&quot;. I posted a few resources I found on an issue about implementing debuggers [1] -- although honestly I still haven&#x27;t gotten down to read all of them (or to implement a debugger! :-&#x2F;).<p>--<p>1: <a href="https:&#x2F;&#x2F;github.com&#x2F;munificent&#x2F;craftinginterpreters&#x2F;issues&#x2F;922">https:&#x2F;&#x2F;github.com&#x2F;munificent&#x2F;craftinginterpreters&#x2F;issues&#x2F;92...</a></div><br/></div></div><div id="37671764" class="c"><input type="checkbox" id="c-37671764" checked=""/><div class="controls bullet"><span class="by">mrazomor</span><span>|</span><a href="#37671398">parent</a><span>|</span><a href="#37671670">prev</a><span>|</span><a href="#37671778">next</a><span>|</span><label class="collapse" for="c-37671764">[-]</label><label class="expand" for="c-37671764">[1 more]</label></div><br/><div class="children"><div class="content">I really liked <a href="https:&#x2F;&#x2F;blog.tartanllama.xyz&#x2F;writing-a-linux-debugger-setup&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;blog.tartanllama.xyz&#x2F;writing-a-linux-debugger-setup&#x2F;</a><p>I learned a lot.</div><br/></div></div><div id="37671778" class="c"><input type="checkbox" id="c-37671778" checked=""/><div class="controls bullet"><span class="by">wila</span><span>|</span><a href="#37671398">parent</a><span>|</span><a href="#37671764">prev</a><span>|</span><label class="collapse" for="c-37671778">[-]</label><label class="expand" for="c-37671778">[1 more]</label></div><br/><div class="children"><div class="content">How about a book?<p>I like &quot;Advanced Windows Debugging&quot; by Mario Hewardt and Daniel Pravat.</div><br/></div></div></div></div></div></div></div></div></div></body></html>