<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1709974863926" as="style"/><link rel="stylesheet" href="styles.css?v=1709974863926"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.differential.dev">Differential: Type safe RPC that feels like local functions</a> <span class="domain">(<a href="https://www.differential.dev">www.differential.dev</a>)</span></div><div class="subtext"><span>interpol_p</span> | <span>23 comments</span></div><br/><div><div id="39650423" class="c"><input type="checkbox" id="c-39650423" checked=""/><div class="controls bullet"><span class="by">JonChesterfield</span><span>|</span><a href="#39650110">next</a><span>|</span><label class="collapse" for="c-39650423">[-]</label><label class="expand" for="c-39650423">[1 more]</label></div><br/><div class="children"><div class="content">This might be an interesting project. &quot;Type safe RPC&quot; is not a great description to lead with as remote procedure calls have a large amount of negative associations that have little to nothing to do with static type systems.<p>I <i>think</i> it&#x27;s a distributed language runtime where you write functions in typescript and the runtime deals with passing data between machines.<p>The website is quite good at presenting the system as a nice thing that does nice things and you should like it and it&#x27;s all very nice. It does a very poor job of convincing me that it works properly. I&#x27;d want to know how the scheduler works and how it handles mutable state in the presence of network partitions.<p>Also just found a caveat which amounts to they&#x27;ve got the implementation wrong:<p>&gt; Arguments must be JSON serializable. This means that you can pass strings, numbers, booleans, arrays, objects, and null. You cannot pass functions, promises, or other non-serializable objects</div><br/></div></div><div id="39650110" class="c"><input type="checkbox" id="c-39650110" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#39650423">prev</a><span>|</span><a href="#39650166">next</a><span>|</span><label class="collapse" for="c-39650110">[-]</label><label class="expand" for="c-39650110">[1 more]</label></div><br/><div class="children"><div class="content">Usually type safety isn&#x27;t the issue, rather pretending the network doesn&#x27;t exist.<p>RPC, even if running on the same machine, is distributed systems land.</div><br/></div></div><div id="39650166" class="c"><input type="checkbox" id="c-39650166" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#39650110">prev</a><span>|</span><a href="#39650324">next</a><span>|</span><label class="collapse" for="c-39650166">[-]</label><label class="expand" for="c-39650166">[2 more]</label></div><br/><div class="children"><div class="content">If it &quot;feels like local functions&quot;, how do you handle errors from the RPC layer &#x2F; network?</div><br/><div id="39650396" class="c"><input type="checkbox" id="c-39650396" checked=""/><div class="controls bullet"><span class="by">JonChesterfield</span><span>|</span><a href="#39650166">parent</a><span>|</span><a href="#39650324">next</a><span>|</span><label class="collapse" for="c-39650396">[-]</label><label class="expand" for="c-39650396">[1 more]</label></div><br/><div class="children"><div class="content">This really should be addressed in the docs and I can&#x27;t find it either. There&#x27;s some stuff about retrying functions that failed sometime later which seems very different to local functions and very like not-local functions.</div><br/></div></div></div></div><div id="39650324" class="c"><input type="checkbox" id="c-39650324" checked=""/><div class="controls bullet"><span class="by">bugbuddy</span><span>|</span><a href="#39650166">prev</a><span>|</span><a href="#39649566">next</a><span>|</span><label class="collapse" for="c-39650324">[-]</label><label class="expand" for="c-39650324">[1 more]</label></div><br/><div class="children"><div class="content">The key word here is “feels.” I would not trust feelings when it comes to software systems’ reliability.</div><br/></div></div><div id="39649566" class="c"><input type="checkbox" id="c-39649566" checked=""/><div class="controls bullet"><span class="by">CipherThrowaway</span><span>|</span><a href="#39650324">prev</a><span>|</span><a href="#39650101">next</a><span>|</span><label class="collapse" for="c-39649566">[-]</label><label class="expand" for="c-39649566">[9 more]</label></div><br/><div class="children"><div class="content">How does the idempotency work? I don&#x27;t understand how functions can be made idempotent without changing or instrumenting their implementation for end-to-end idempotency.</div><br/><div id="39649614" class="c"><input type="checkbox" id="c-39649614" checked=""/><div class="controls bullet"><span class="by">scarmig</span><span>|</span><a href="#39649566">parent</a><span>|</span><a href="#39649821">next</a><span>|</span><label class="collapse" for="c-39649614">[-]</label><label class="expand" for="c-39649614">[6 more]</label></div><br/><div class="children"><div class="content">You could have some side channel with an identifier for the RPC. If the server receives duplicates of one RPC, it ignores the extras.<p>It would require some client support, though. Alternatively, if the RPCs have the same arguments, the framework could choose to ignore seemingly identical ones, though that has its own issues.</div><br/><div id="39649675" class="c"><input type="checkbox" id="c-39649675" checked=""/><div class="controls bullet"><span class="by">CipherThrowaway</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649614">parent</a><span>|</span><a href="#39649829">next</a><span>|</span><label class="collapse" for="c-39649675">[-]</label><label class="expand" for="c-39649675">[4 more]</label></div><br/><div class="children"><div class="content">Neither method works.<p>If the framework records the occurrence of the call before the effect of the function, you achieve at-most-once semantics. If it records the call after the effect, you get at-least-once.<p>The framework might perform its idempotency bookkeeping within the same transaction boundary as the function&#x27;s side-effects, but this means the function implementation is no longer a black-box. E.g. you can no longer perform arbitrary side-effects while preserving the idempotency guarantees of the framework.</div><br/><div id="39649815" class="c"><input type="checkbox" id="c-39649815" checked=""/><div class="controls bullet"><span class="by">jitl</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649675">parent</a><span>|</span><a href="#39649829">next</a><span>|</span><label class="collapse" for="c-39649815">[-]</label><label class="expand" for="c-39649815">[3 more]</label></div><br/><div class="children"><div class="content">It’s at-least-once. From <a href="https:&#x2F;&#x2F;docs.differential.dev&#x2F;advanced&#x2F;compute-recovery&#x2F;" rel="nofollow">https:&#x2F;&#x2F;docs.differential.dev&#x2F;advanced&#x2F;compute-recovery&#x2F;</a><p>&gt; If a machine fails to send any heartbeats within an interval (default 90 seconds):<p>&gt; It is marked as unhealthy, and Differential will not send any new requests to it.<p>&gt; The functions in progress are marked as failed, and Differential will retry them on a healthy worker.<p>I would guess that “idempotent” functions in the system also take a lease out on the idempotency key. Perhaps they release the lease on failure since they can observe errors thrown, and they commit the key as consumed after success. ¯\_(ツ)_&#x2F;¯ the docs are not clear on these semantics!</div><br/><div id="39649853" class="c"><input type="checkbox" id="c-39649853" checked=""/><div class="controls bullet"><span class="by">Salgat</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649815">parent</a><span>|</span><a href="#39649829">next</a><span>|</span><label class="collapse" for="c-39649853">[-]</label><label class="expand" for="c-39649853">[2 more]</label></div><br/><div class="children"><div class="content">That&#x27;s how we handle idempotency. It&#x27;s basically a mutex on the idempotency key with a timeout (in our case using redis with redlock since it&#x27;s a distributed system). Once the command finishes, the key is marked as handled and the lock is released. At that point any future or queued requests with the same key immediately return.</div><br/><div id="39649932" class="c"><input type="checkbox" id="c-39649932" checked=""/><div class="controls bullet"><span class="by">CipherThrowaway</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649853">parent</a><span>|</span><a href="#39649829">next</a><span>|</span><label class="collapse" for="c-39649932">[-]</label><label class="expand" for="c-39649932">[1 more]</label></div><br/><div class="children"><div class="content">It sounds to me like there are scenarios where calls to, and certainly effects of, &quot;idempotent&quot; functions can take place twice.<p>I haven&#x27;t looked at Redlock for a while, but I&#x27;m assuming you&#x27;re all across the historical objections to it from distributed systems researchers: <a href="https:&#x2F;&#x2F;martin.kleppmann.com&#x2F;2016&#x2F;02&#x2F;08&#x2F;how-to-do-distributed-locking.html" rel="nofollow">https:&#x2F;&#x2F;martin.kleppmann.com&#x2F;2016&#x2F;02&#x2F;08&#x2F;how-to-do-distribute...</a></div><br/></div></div></div></div></div></div></div></div><div id="39649829" class="c"><input type="checkbox" id="c-39649829" checked=""/><div class="controls bullet"><span class="by">reissbaker</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649614">parent</a><span>|</span><a href="#39649675">prev</a><span>|</span><a href="#39649821">next</a><span>|</span><label class="collapse" for="c-39649829">[-]</label><label class="expand" for="c-39649829">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, this is what it looks like in the docs; you choose an &quot;idempotency key&quot;: <a href="https:&#x2F;&#x2F;docs.differential.dev&#x2F;advanced&#x2F;idempotency&#x2F;" rel="nofollow">https:&#x2F;&#x2F;docs.differential.dev&#x2F;advanced&#x2F;idempotency&#x2F;</a></div><br/></div></div></div></div><div id="39649821" class="c"><input type="checkbox" id="c-39649821" checked=""/><div class="controls bullet"><span class="by">asplake</span><span>|</span><a href="#39649566">parent</a><span>|</span><a href="#39649614">prev</a><span>|</span><a href="#39650101">next</a><span>|</span><label class="collapse" for="c-39649821">[-]</label><label class="expand" for="c-39649821">[2 more]</label></div><br/><div class="children"><div class="content">&quot;Just decorate your idempotent operations&quot; – implies to me that the idempotency of your functions is your responsibility.</div><br/><div id="39649919" class="c"><input type="checkbox" id="c-39649919" checked=""/><div class="controls bullet"><span class="by">CipherThrowaway</span><span>|</span><a href="#39649566">root</a><span>|</span><a href="#39649821">parent</a><span>|</span><a href="#39650101">next</a><span>|</span><label class="collapse" for="c-39649919">[-]</label><label class="expand" for="c-39649919">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s one way of reading it - although I find it&#x27;s at odds with the heading &quot;Idempotency in one line of code.&quot;<p>If it&#x27;s the case that the idempotency wrapper is only for operations that are already idempotent, it makes me wonder that the docs couldn&#x27;t do a better job of communicating the purpose and function. Decorate your idempotent operations.. to make them more idempotent?</div><br/></div></div></div></div></div></div><div id="39650101" class="c"><input type="checkbox" id="c-39650101" checked=""/><div class="controls bullet"><span class="by">nextaccountic</span><span>|</span><a href="#39649566">prev</a><span>|</span><a href="#39650227">next</a><span>|</span><label class="collapse" for="c-39650101">[-]</label><label class="expand" for="c-39650101">[3 more]</label></div><br/><div class="children"><div class="content">Is this just like trpc? <a href="https:&#x2F;&#x2F;trpc.io&#x2F;" rel="nofollow">https:&#x2F;&#x2F;trpc.io&#x2F;</a><p>Or like rspc (in Rust) <a href="https:&#x2F;&#x2F;www.rspc.dev&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.rspc.dev&#x2F;</a></div><br/><div id="39650164" class="c"><input type="checkbox" id="c-39650164" checked=""/><div class="controls bullet"><span class="by">benatkin</span><span>|</span><a href="#39650101">parent</a><span>|</span><a href="#39650155">next</a><span>|</span><label class="collapse" for="c-39650164">[-]</label><label class="expand" for="c-39650164">[1 more]</label></div><br/><div class="children"><div class="content">I think they’re probably paying more attention to gRPC and GraphQL. They have a cloud offering whereas trpc seems to have a smaller scope and prioritize supporting every client and server.</div><br/></div></div><div id="39650155" class="c"><input type="checkbox" id="c-39650155" checked=""/><div class="controls bullet"><span class="by">kszyh</span><span>|</span><a href="#39650101">parent</a><span>|</span><a href="#39650164">prev</a><span>|</span><a href="#39650227">next</a><span>|</span><label class="collapse" for="c-39650155">[-]</label><label class="expand" for="c-39650155">[1 more]</label></div><br/><div class="children"><div class="content">If I understand the idea correctly, differential is for backend only (microservices architectures). There is nothing about browser support in the docs.</div><br/></div></div></div></div><div id="39650227" class="c"><input type="checkbox" id="c-39650227" checked=""/><div class="controls bullet"><span class="by">moltar</span><span>|</span><a href="#39650101">prev</a><span>|</span><a href="#39650209">next</a><span>|</span><label class="collapse" for="c-39650227">[-]</label><label class="expand" for="c-39650227">[1 more]</label></div><br/><div class="children"><div class="content">How would this work in a serverless scenario where handler side runs in a Lambda for example?<p>It seems a bit of a chicken and egg in this case.<p>A service needs to register itself with a control plane. But for the service to start it needs to get a request (via lambda invocation).</div><br/></div></div><div id="39650209" class="c"><input type="checkbox" id="c-39650209" checked=""/><div class="controls bullet"><span class="by">EdSchouten</span><span>|</span><a href="#39650227">prev</a><span>|</span><a href="#39649586">next</a><span>|</span><label class="collapse" for="c-39650209">[-]</label><label class="expand" for="c-39650209">[1 more]</label></div><br/><div class="children"><div class="content">The downside of an approach like this is that it limits you to a single programming language on both the frontend and backend. This is exactly the reason RPC frameworks like gRPC use an IDL.</div><br/></div></div><div id="39649586" class="c"><input type="checkbox" id="c-39649586" checked=""/><div class="controls bullet"><span class="by">jahewson</span><span>|</span><a href="#39650209">prev</a><span>|</span><a href="#39649655">next</a><span>|</span><label class="collapse" for="c-39649586">[-]</label><label class="expand" for="c-39649586">[2 more]</label></div><br/><div class="children"><div class="content">Ok… but how does it work? Too much magic.</div><br/></div></div><div id="39649655" class="c"><input type="checkbox" id="c-39649655" checked=""/><div class="controls bullet"><span class="by">mblode</span><span>|</span><a href="#39649586">prev</a><span>|</span><label class="collapse" for="c-39649655">[-]</label><label class="expand" for="c-39649655">[1 more]</label></div><br/><div class="children"><div class="content">Huge congratulations on the launch!</div><br/></div></div></div></div></div></div></div></body></html>