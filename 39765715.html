<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1711011676935" as="style"/><link rel="stylesheet" href="styles.css?v=1711011676935"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://tavianator.com/2024/btrfs_bug.html">Bug hunting in Btrfs</a> <span class="domain">(<a href="https://tavianator.com">tavianator.com</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>176 comments</span></div><br/><div><div id="39772323" class="c"><input type="checkbox" id="c-39772323" checked=""/><div class="controls bullet"><span class="by">JonChesterfield</span><span>|</span><a href="#39766978">next</a><span>|</span><label class="collapse" for="c-39772323">[-]</label><label class="expand" for="c-39772323">[3 more]</label></div><br/><div class="children"><div class="content">The visualisation of the data race in this post is superb. Worth reading just for that.<p>Handrolled concurrency using atomic integers in C. Without the proof system or state machine model to support it. Seems likely that&#x27;s not going to be their only race condition.</div><br/><div id="39772539" class="c"><input type="checkbox" id="c-39772539" checked=""/><div class="controls bullet"><span class="by">re</span><span>|</span><a href="#39772323">parent</a><span>|</span><a href="#39766978">next</a><span>|</span><label class="collapse" for="c-39772539">[-]</label><label class="expand" for="c-39772539">[2 more]</label></div><br/><div class="children"><div class="content">The animations also stood out to me. I took a look at the source to see if they used a library or were written completely by hand and was surprised to see that they were entirely CSS-based, no JavaScript required (although the &quot;metadata&quot; overwrite animation is glitched if you disable JS, for some reason not immediately apparent to me).</div><br/><div id="39774447" class="c"><input type="checkbox" id="c-39774447" checked=""/><div class="controls bullet"><span class="by">bhaney</span><span>|</span><a href="#39772323">root</a><span>|</span><a href="#39772539">parent</a><span>|</span><a href="#39766978">next</a><span>|</span><label class="collapse" for="c-39774447">[-]</label><label class="expand" for="c-39774447">[1 more]</label></div><br/><div class="children"><div class="content">&gt; for some reason not immediately apparent to me<p>The CSS that sets the background of the code elements (so they properly cover up the ones under them) is attached to the hljs class, which is added to those elements by highlight.js.<p>No JS &gt; no classname added &gt; no background style &gt; jank</div><br/></div></div></div></div></div></div><div id="39766978" class="c"><input type="checkbox" id="c-39766978" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39772323">prev</a><span>|</span><a href="#39767016">next</a><span>|</span><label class="collapse" for="c-39766978">[-]</label><label class="expand" for="c-39766978">[40 more]</label></div><br/><div class="children"><div class="content">One btrfs bug which is 100% reproducible:<p>* Start with an ext3 filesystem 70% full.<p>* Convert to btrfs using btrfs-convert.<p>* Delete the ext3_saved snapshot of the original filesystem as recommended by the convert utility.<p>* Enable compression (-o compress) and defrag the filesystem as recommended by the man page for how to compress all existing data.<p>It fails with out of disk space, leaving a filesystem which isn&#x27;t repairable - deleting files will not free any space.<p>The fact such a bug seems to have existed for years, with such a basic following of the man pages for a common use case (migration to btrfs to make use of its compression abilities to get more free space), tells me that it isn&#x27;t yet ready for primetime.</div><br/><div id="39767498" class="c"><input type="checkbox" id="c-39767498" checked=""/><div class="controls bullet"><span class="by">orev</span><span>|</span><a href="#39766978">parent</a><span>|</span><a href="#39767891">next</a><span>|</span><label class="collapse" for="c-39767498">[-]</label><label class="expand" for="c-39767498">[14 more]</label></div><br/><div class="children"><div class="content">As a Linux user since kernel 0.96, I have never once considered doing an in-place migration to a new file system. That seems like a crazy thing to try to do, and I would hope it’s only done as a last resort and with all data fully backed up before trying it.<p>I would agree that if this is presented in the documentation as something it supports, then it should work as expected. If it doesn’t work, then a pull request to remove it from the docs might be the best course of action.</div><br/><div id="39767707" class="c"><input type="checkbox" id="c-39767707" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767498">parent</a><span>|</span><a href="#39769611">next</a><span>|</span><label class="collapse" for="c-39767707">[-]</label><label class="expand" for="c-39767707">[2 more]</label></div><br/><div class="children"><div class="content">The design of the convert utility is pretty good - the convert is effectively atomic - at any point during conversion, if you kill power midway, the disk is either a valid ext4 filesystem, or a valid btrfs filesystem.</div><br/><div id="39774486" class="c"><input type="checkbox" id="c-39774486" checked=""/><div class="controls bullet"><span class="by">jorvi</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767707">parent</a><span>|</span><a href="#39769611">next</a><span>|</span><label class="collapse" for="c-39774486">[-]</label><label class="expand" for="c-39774486">[1 more]</label></div><br/><div class="children"><div class="content">It is atomic, but at least for me it left both types of checks that BTRFS can do with unrecoverable errors for a few blocks.<p>All in all not too terrible and I just accepted the bogus data as good by resetting (?) the checksums for those blocks. But acting as if it’s just a terminal command and Bob’s your uncle.. that’s just wrong.</div><br/></div></div></div></div><div id="39769611" class="c"><input type="checkbox" id="c-39769611" checked=""/><div class="controls bullet"><span class="by">thfuran</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767498">parent</a><span>|</span><a href="#39767707">prev</a><span>|</span><a href="#39767552">next</a><span>|</span><label class="collapse" for="c-39769611">[-]</label><label class="expand" for="c-39769611">[9 more]</label></div><br/><div class="children"><div class="content">&gt;That seems like a crazy thing to try to do<p>It seems like a reasonable thing to want to do. Would you never update an installed application or the kernel to get new features or fixes? I don&#x27;t really think there&#x27;s much fundamental difference. If what you mean is &quot;it seems likely to fail catastrophically&quot;, well that seems like an indication that either the converter or the target filesystem isn&#x27;t in a good state.</div><br/><div id="39772359" class="c"><input type="checkbox" id="c-39772359" checked=""/><div class="controls bullet"><span class="by">orev</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39769611">parent</a><span>|</span><a href="#39771352">next</a><span>|</span><label class="collapse" for="c-39772359">[-]</label><label class="expand" for="c-39772359">[2 more]</label></div><br/><div class="children"><div class="content">Live migration of a file system is like replacing the foundation of your house while still living in it. It’s not the same thing as updating apps which would be more like redecorating a room. Sure it’s possible, but it’s very risky and a lot more work than simply doing a full backup and restore.</div><br/><div id="39775171" class="c"><input type="checkbox" id="c-39775171" checked=""/><div class="controls bullet"><span class="by">tredre3</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39772359">parent</a><span>|</span><a href="#39771352">next</a><span>|</span><label class="collapse" for="c-39775171">[-]</label><label class="expand" for="c-39775171">[1 more]</label></div><br/><div class="children"><div class="content">What&#x27;s a full backup and restore in your analogy? Building a new house? Moving the house to a safe place, replace the foundation, bring the house back?</div><br/></div></div></div></div><div id="39771352" class="c"><input type="checkbox" id="c-39771352" checked=""/><div class="controls bullet"><span class="by">bartvk</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39769611">parent</a><span>|</span><a href="#39772359">prev</a><span>|</span><a href="#39771373">next</a><span>|</span><label class="collapse" for="c-39771352">[-]</label><label class="expand" for="c-39771352">[2 more]</label></div><br/><div class="children"><div class="content">&gt; It seems like a reasonable thing to want to do<p>This was actually a routine thing to do, under iOS and macOS, with the transition from HFS to APFS.</div><br/><div id="39772436" class="c"><input type="checkbox" id="c-39772436" checked=""/><div class="controls bullet"><span class="by">thijsvandien</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39771352">parent</a><span>|</span><a href="#39771373">next</a><span>|</span><label class="collapse" for="c-39772436">[-]</label><label class="expand" for="c-39772436">[1 more]</label></div><br/><div class="children"><div class="content">Don&#x27;t forget about FAT32 to NTFS long before that.</div><br/></div></div></div></div><div id="39771373" class="c"><input type="checkbox" id="c-39771373" checked=""/><div class="controls bullet"><span class="by">KronisLV</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39769611">parent</a><span>|</span><a href="#39771352">prev</a><span>|</span><a href="#39770929">next</a><span>|</span><label class="collapse" for="c-39771373">[-]</label><label class="expand" for="c-39771373">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Would you never update an installed application or the kernel to get new features or fixes?<p>Honestly, if that was an <i>option</i> without the certainty of getting pwned due to some RCE down the road, then yes, there are cases where I absolutely wouldn&#x27;t want to update some software and just have it chugging away for years in its present functional state.</div><br/><div id="39772376" class="c"><input type="checkbox" id="c-39772376" checked=""/><div class="controls bullet"><span class="by">thfuran</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39771373">parent</a><span>|</span><a href="#39770929">next</a><span>|</span><label class="collapse" for="c-39772376">[-]</label><label class="expand" for="c-39772376">[1 more]</label></div><br/><div class="children"><div class="content">And there are no cases where you actually want a new feature?</div><br/></div></div></div></div><div id="39771808" class="c"><input type="checkbox" id="c-39771808" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39769611">parent</a><span>|</span><a href="#39770929">prev</a><span>|</span><a href="#39767552">next</a><span>|</span><label class="collapse" for="c-39771808">[-]</label><label class="expand" for="c-39771808">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s a world of difference between a version update and completely switching software. Enabling new features on an existing ext4 file system is something I would expect to be perfectly safe. In-place converting an ext4 file system into btrfs... in an ideal world that would work, of course, but it sounds vastly more tricky even in the best case.</div><br/></div></div></div></div><div id="39767552" class="c"><input type="checkbox" id="c-39767552" checked=""/><div class="controls bullet"><span class="by">tuyiown</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767498">parent</a><span>|</span><a href="#39769611">prev</a><span>|</span><a href="#39767891">next</a><span>|</span><label class="collapse" for="c-39767552">[-]</label><label class="expand" for="c-39767552">[2 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know if you talk only about linux or you meant your comment as a generalization, but have you heard of in place APFS migration from HFS+ ?</div><br/><div id="39767661" class="c"><input type="checkbox" id="c-39767661" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767552">parent</a><span>|</span><a href="#39767891">next</a><span>|</span><label class="collapse" for="c-39767661">[-]</label><label class="expand" for="c-39767661">[1 more]</label></div><br/><div class="children"><div class="content">Similarly Microsoft offered FAT32 to NTFS in-place migration, and it did the required checks <i>before starting</i> to ensure it completes successfully. It was more than 20 years ago IIRC.</div><br/></div></div></div></div></div></div><div id="39767891" class="c"><input type="checkbox" id="c-39767891" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39766978">parent</a><span>|</span><a href="#39767498">prev</a><span>|</span><a href="#39767313">next</a><span>|</span><label class="collapse" for="c-39767891">[-]</label><label class="expand" for="c-39767891">[14 more]</label></div><br/><div class="children"><div class="content">It&#x27;s open source: if things don&#x27;t get fixed, it&#x27;s because no user cares enough to fix it. I&#x27;m certainty not wasting my time on that, nobody uses ext3 anymore!<p>You are as empowered to fix this as anybody else, if it presents a real problem for you.</div><br/><div id="39770432" class="c"><input type="checkbox" id="c-39770432" checked=""/><div class="controls bullet"><span class="by">romanows</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767891">parent</a><span>|</span><a href="#39767951">next</a><span>|</span><label class="collapse" for="c-39770432">[-]</label><label class="expand" for="c-39770432">[1 more]</label></div><br/><div class="children"><div class="content">I think the parent comment&#x27;s fix is to not use btrfs and warn others about how risky they estimate it is.</div><br/></div></div><div id="39767951" class="c"><input type="checkbox" id="c-39767951" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767891">parent</a><span>|</span><a href="#39770432">prev</a><span>|</span><a href="#39769812">next</a><span>|</span><label class="collapse" for="c-39767951">[-]</label><label class="expand" for="c-39767951">[8 more]</label></div><br/><div class="children"><div class="content">You can reliably change ext3 with ext4 in the GP&#x27;s comment. It&#x27;s not an extX problem, it&#x27;s an BTRFS problem.<p>If nobody cares that much, maybe deprecate the tool, then?<p>Also, just because it&#x27;s Open Source (TM) doesn&#x27;t mean developers will accept any patch regardless of its quality. Like everything, FOSS is 85% people, 15% code.<p>&gt; You are as empowered to fix this as anybody else, if it presents a real problem for you.<p>I have reported many bugs in Open Source software. If I had the time to study code and author a fix, I&#x27;d submit the patch itself, which I was able to do, a couple of times.</div><br/><div id="39768025" class="c"><input type="checkbox" id="c-39768025" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767951">parent</a><span>|</span><a href="#39771960">next</a><span>|</span><label class="collapse" for="c-39768025">[-]</label><label class="expand" for="c-39768025">[5 more]</label></div><br/><div class="children"><div class="content">&gt; If nobody cares that much, maybe deprecate the tool, then?<p>If you think that&#x27;s the right thing to do, you&#x27;re as free as anybody else to send documentation patches. I doubt anybody would argue with you here, but who knows :)<p>&gt; Also, just because it&#x27;s Open Source (TM) doesn&#x27;t mean developers will accept any patch regardless of its quality.<p>Of course not. If you want to make a difference, you have to put in the work. It&#x27;s worth it IMHO.</div><br/><div id="39768074" class="c"><input type="checkbox" id="c-39768074" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39768025">parent</a><span>|</span><a href="#39771960">next</a><span>|</span><label class="collapse" for="c-39768074">[-]</label><label class="expand" for="c-39768074">[4 more]</label></div><br/><div class="children"><div class="content">&gt; If you think that&#x27;s the right thing to do, you&#x27;re as free as anybody else to send documentation patches :)<p>That won&#x27;t do anything. Instead I can start a small commotion by sending a small request (to the mailing lists) to deprecate the tool, which I don&#x27;t want to do. Because I&#x27;m busy. :)<p>Also, I don&#x27;t like commotions, and prefer civilized discussions.<p>&gt; Of course not. If you want to make a difference, you have to put in the work. It&#x27;s worth it IMHO.<p>Of course. This is what I do. For example, I have a one liner in Debian Installer. I had a big patch in GDM, but after coordinating with the developers, they decided to not merge the fix + new feature, for example.</div><br/><div id="39768129" class="c"><input type="checkbox" id="c-39768129" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39768074">parent</a><span>|</span><a href="#39771960">next</a><span>|</span><label class="collapse" for="c-39768129">[-]</label><label class="expand" for="c-39768129">[3 more]</label></div><br/><div class="children"><div class="content">&gt; For example, I have a one liner in Debian Installer. I had a big patch in GDM, but after coordinating with the developers, they decided to not merge the fix + new feature, for example<p>Surely you were given some justification as to why they didn&#x27;t want to merge it? I realize sometimes these things are intractable, but in my experience that&#x27;s rare... usually things can iterate towards a mutually agreeable solution.</div><br/><div id="39768391" class="c"><input type="checkbox" id="c-39768391" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39768129">parent</a><span>|</span><a href="#39771960">next</a><span>|</span><label class="collapse" for="c-39768391">[-]</label><label class="expand" for="c-39768391">[2 more]</label></div><br/><div class="children"><div class="content">The sad part is they didn’t.<p>GTK has (or had) a sliding infoline widget, which is used to show notifications. GDM used it for password related prompts. It actually relayed PAM messages to that widget.<p>We were doing mass installations backed by an LDAP server which had password policies, including expiration enabled.<p>That widget had a bug, prevented it displaying a new message when it was in the middle of an animation, which effectively ate messages related to LDAP (Your password will expire in X days, etc.).<p>Also we needed a keyboard selector in that window, which was absent.<p>I gave heads up to the GDM team, they sent a “go ahead” as a reply. I have written an elaborate patch, which they rejected and wanted a simpler one. I iterated the way they wanted, they said it passes the muster and will be merged.<p>Further couple of mails never answered. I’m basically ghosted.<p>But the merge never came, and I moved on.</div><br/><div id="39771134" class="c"><input type="checkbox" id="c-39771134" checked=""/><div class="controls bullet"><span class="by">baq</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39768391">parent</a><span>|</span><a href="#39771960">next</a><span>|</span><label class="collapse" for="c-39771134">[-]</label><label class="expand" for="c-39771134">[1 more]</label></div><br/><div class="children"><div class="content">This sort of thing happens <i>all the time</i> in big orgs which develop a single product internally with a closed source… there isn’t any fix for this part of human nature, apparently.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39771960" class="c"><input type="checkbox" id="c-39771960" checked=""/><div class="controls bullet"><span class="by">Zardoz84</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767951">parent</a><span>|</span><a href="#39768025">prev</a><span>|</span><a href="#39769812">next</a><span>|</span><label class="collapse" for="c-39771960">[-]</label><label class="expand" for="c-39771960">[2 more]</label></div><br/><div class="children"><div class="content">for me it&#x27;s a problem of the tool converting in place EXT to BTRFS. Not necessarily a problem of BTRFS.</div><br/><div id="39772148" class="c"><input type="checkbox" id="c-39772148" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39771960">parent</a><span>|</span><a href="#39769812">next</a><span>|</span><label class="collapse" for="c-39772148">[-]</label><label class="expand" for="c-39772148">[1 more]</label></div><br/><div class="children"><div class="content">I tried to say it’s a problem of BTRFS the project. Not BTRFS the file system.</div><br/></div></div></div></div></div></div><div id="39769812" class="c"><input type="checkbox" id="c-39769812" checked=""/><div class="controls bullet"><span class="by">noncoml</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767891">parent</a><span>|</span><a href="#39767951">prev</a><span>|</span><a href="#39767313">next</a><span>|</span><label class="collapse" for="c-39769812">[-]</label><label class="expand" for="c-39769812">[4 more]</label></div><br/><div class="children"><div class="content">&gt; You are as empowered to fix this as anybody else, if it presents a real problem for you.<p>I’m getting sick and tired of this argument. It’s very user unfriendly<p>Do you work in software? If yes, do you own a component? Have you tried using this argument with your colleagues that have no idea about your component?<p>Of course they theoretically are empowered to fix the bug, but that doesn’t make it easier. They may have no idea about how filesystem internal. Or they may be just users and have no programming background at all</div><br/><div id="39773488" class="c"><input type="checkbox" id="c-39773488" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39769812">parent</a><span>|</span><a href="#39767313">next</a><span>|</span><label class="collapse" for="c-39773488">[-]</label><label class="expand" for="c-39773488">[3 more]</label></div><br/><div class="children"><div class="content">It&#x27;s not unfriendly, it&#x27;s just how it is. The fact you&#x27;re comparing it to industry shows you don&#x27;t get it.<p>Open source doesn&#x27;t work for you. You can&#x27;t demand that it do things you want: you have to push and justify them yourself, and hopefully you find other people along the way who want the same things and can help you.<p>I taught myself to program as a teenager trying to fix bugs in Linux. If I could do it, anybody can. That&#x27;s what makes it empowering.</div><br/><div id="39774171" class="c"><input type="checkbox" id="c-39774171" checked=""/><div class="controls bullet"><span class="by">mardifoufs</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39773488">parent</a><span>|</span><a href="#39775180">next</a><span>|</span><label class="collapse" for="c-39774171">[-]</label><label class="expand" for="c-39774171">[1 more]</label></div><br/><div class="children"><div class="content">Well I think you&#x27;re completely right, in a way. But I also don&#x27;t see the problem with people telling other people to not use the software or to complain about it. They are totally in their right to complain about stuff. Now obviously if the complaining involves requiring people to work for some feature you want, that&#x27;s entitled and wack. Same goes for throwing a fit because maintainers went for systemd instead of your own favorite init system.<p>But  being open source doesn&#x27;t mean people shouldn&#x27;t or can&#x27;t just say &quot;this is bad&quot; or &quot;don&#x27;t use x&quot; or even &quot;this X feature doesn&#x27;t work when using Y&quot; (now If what they are saying isn&#x27;t true, sure we should call them out)<p>It&#x27;s normal and in fact I think it should be encouraged, as not everyone can be aware of potential problems they could have with a piece of OSS that is already known in some obscure dev mailing list. The more people are informed and aware of potential issues, the less they will be surprised and complain about it when they start using it.<p>(Fwiw I love btrfs, and I think it&#x27;s very reliable)</div><br/></div></div><div id="39775180" class="c"><input type="checkbox" id="c-39775180" checked=""/><div class="controls bullet"><span class="by">noncoml</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39773488">parent</a><span>|</span><a href="#39774171">prev</a><span>|</span><a href="#39767313">next</a><span>|</span><label class="collapse" for="c-39775180">[-]</label><label class="expand" for="c-39775180">[1 more]</label></div><br/><div class="children"><div class="content">Read the thread again. No one asked anyone to work for free.<p>Please don’t put words in other peoples mouth.</div><br/></div></div></div></div></div></div></div></div><div id="39767313" class="c"><input type="checkbox" id="c-39767313" checked=""/><div class="controls bullet"><span class="by">cesarb</span><span>|</span><a href="#39766978">parent</a><span>|</span><a href="#39767891">prev</a><span>|</span><a href="#39767016">next</a><span>|</span><label class="collapse" for="c-39767313">[-]</label><label class="expand" for="c-39767313">[11 more]</label></div><br/><div class="children"><div class="content">&gt; deleting files will not free any space.<p>Does a rebalance fix it? I have once (and only once, back when it was new) hit a &quot;out of disk space&quot; situation with btrfs, and IIRC rebalancing was enough to fix it.<p>&gt; for a common use case<p>It might have been a common use case back when btrfs was new (though I doubt it, most users of btrfs probably created the filesystem from scratch even back then), but I doubt it&#x27;s a common use case nowadays.</div><br/><div id="39767496" class="c"><input type="checkbox" id="c-39767496" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767313">parent</a><span>|</span><a href="#39770682">next</a><span>|</span><label class="collapse" for="c-39767496">[-]</label><label class="expand" for="c-39767496">[6 more]</label></div><br/><div class="children"><div class="content">From my perspective, A filesystem is a <i>critical infrastructure</i> in an OS, and failing here and there and not fixing these bugs because they&#x27;re not common is not acceptable.<p>Same for the RAID5&#x2F;6 bugs in BTRFS. What&#x27;s their solution? A simple warning in the docs:<p>&gt; RAID5&#x2F;6 has known problems and should not be used in production. [0]<p>Also the CLI <i>discourages you</i> from creating these things. Brilliant.<p>This is why I don&#x27;t use BTRFS anywhere. An FS shall be bulletproof. Errors must only cause from hardware problems. Not random bugs in a filesystem.<p>[0]: <a href="https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;mkfs.btrfs.html#multiple-devices" rel="nofollow">https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;mkfs.btrfs.html#multi...</a></div><br/><div id="39767699" class="c"><input type="checkbox" id="c-39767699" checked=""/><div class="controls bullet"><span class="by">chronid</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767496">parent</a><span>|</span><a href="#39768205">next</a><span>|</span><label class="collapse" for="c-39767699">[-]</label><label class="expand" for="c-39767699">[4 more]</label></div><br/><div class="children"><div class="content">Machines die. Hardware has bugs, or is broken. Things just bork. It&#x27;s a fact of life.<p>Would I build a file storage system around btrfs? No - without proper redundancy at least. But I&#x27;m told at least Synology does.<p>I&#x27;m pretty sure there&#x27;s plenty of cases where it&#x27;s perfectly usable - the feature set it has today is plenty useful and the worst case scenario is an host reimage.<p>I can live with that. applications will generally break production ten billion times before btrfs does.</div><br/><div id="39767819" class="c"><input type="checkbox" id="c-39767819" checked=""/><div class="controls bullet"><span class="by">bayindirh</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767699">parent</a><span>|</span><a href="#39769966">next</a><span>|</span><label class="collapse" for="c-39767819">[-]</label><label class="expand" for="c-39767819">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Machines dies. Hardware has bugs, or is broken. Things just bork. It&#x27;s a fact of life.<p>I know, I&#x27;m a sysadmin. I care for hardware, mend it, heal it, and sometimes donate, cann-bird or bury it. I&#x27;m used to it.<p>&gt; worst case scenario is an host reimage...<p>While hosting PBs of data on it? No, thanks.<p>&gt; Would I build a file storage system around btrfs? No - without proper redundancy at least.<p>Everything is <i>easy</i> for small n. When you store 20TB on 4x5TB drives, everything can be done. When you have a &gt;5PB of storage on racks, you need at least a copy of that system running hot-standby. That&#x27;s not cheap in any sense.<p>Instead, I&#x27;d use ZFS, Lustre, anything, but not BTRFS.<p>&gt; I can live with that - applications will generally break production ten billion times before btrfs does.<p>In our case, no. Our systems doesn&#x27;t stop because a daemon decided to stop because a server among many fried itself.</div><br/><div id="39775109" class="c"><input type="checkbox" id="c-39775109" checked=""/><div class="controls bullet"><span class="by">chronid</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767819">parent</a><span>|</span><a href="#39769966">next</a><span>|</span><label class="collapse" for="c-39775109">[-]</label><label class="expand" for="c-39775109">[1 more]</label></div><br/><div class="children"><div class="content">I have worked on and around systems with an order of magnitude more data and a single node failing did not matter. We weren&#x27;t using btrfs anyway (for data drives) and it definitely was not cheap. But storage never is.<p>But again, most systems are not like that. Kubernetes cluster nodes? Reimage at will. Compute nodes for vms backed by SAN? Reimage at will. Btrfs can actually make that reimage faster and it&#x27;s pretty reliable on a single flash drive so why not?</div><br/></div></div></div></div><div id="39769966" class="c"><input type="checkbox" id="c-39769966" checked=""/><div class="controls bullet"><span class="by">wongarsu</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767699">parent</a><span>|</span><a href="#39767819">prev</a><span>|</span><a href="#39768205">next</a><span>|</span><label class="collapse" for="c-39769966">[-]</label><label class="expand" for="c-39769966">[1 more]</label></div><br/><div class="children"><div class="content">My impression of btrfs is that it&#x27;s very useful and stable if you stay away from the sharp edges. Until you run into some random scenario that leads you to an unrecoverable file system.<p>But it has been that way for now 14 years. Sure, there are far fewer sharp edges now than there were back then. For a host you can just reimage it&#x27;s fine, for a well-tested fairly restricted system it&#x27;s fine. I stay far away from it for personal computers and my home-built NAS, because just about any other fs seems to be more stable.</div><br/></div></div></div></div><div id="39768205" class="c"><input type="checkbox" id="c-39768205" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767496">parent</a><span>|</span><a href="#39767699">prev</a><span>|</span><a href="#39770682">next</a><span>|</span><label class="collapse" for="c-39768205">[-]</label><label class="expand" for="c-39768205">[1 more]</label></div><br/><div class="children"><div class="content">You do you.<p>Personally, btrfs just works and the features are worth it.<p>Btrfs raid always gets brought up in these discussions, but you can just not use it. The reality is that it didn&#x27;t have a commercial backer until now with Western Digital.</div><br/></div></div></div></div><div id="39770682" class="c"><input type="checkbox" id="c-39770682" checked=""/><div class="controls bullet"><span class="by">chasil</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767313">parent</a><span>|</span><a href="#39767496">prev</a><span>|</span><a href="#39769100">next</a><span>|</span><label class="collapse" for="c-39770682">[-]</label><label class="expand" for="c-39770682">[2 more]</label></div><br/><div class="children"><div class="content">A rebalance means that every file on the filesystem will be rewritten.<p>This is drastic, and I&#x27;d rather perform such an operation on an image copy.<p>This is one case where ZFS is absolutely superior; if a drive goes offline, and is returned to a set at a later date, the resilver only touches the changed&#x2F;needed blocks. Btrfs forces the entire filesystem to be rewritten in a rebalance, which is much more drastic.<p>I am very willing to allow ZFS mirrors to be degraded; I would never, ever let this happen to btrfs if at all avoidable.</div><br/><div id="39771016" class="c"><input type="checkbox" id="c-39771016" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39770682">parent</a><span>|</span><a href="#39769100">next</a><span>|</span><label class="collapse" for="c-39771016">[-]</label><label class="expand" for="c-39771016">[1 more]</label></div><br/><div class="children"><div class="content">The desired &quot;compress every file&quot; operation will also cause every file on the filesystem to be rewritten though ...</div><br/></div></div></div></div><div id="39769100" class="c"><input type="checkbox" id="c-39769100" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767313">parent</a><span>|</span><a href="#39770682">prev</a><span>|</span><a href="#39767421">next</a><span>|</span><label class="collapse" for="c-39769100">[-]</label><label class="expand" for="c-39769100">[1 more]</label></div><br/><div class="children"><div class="content">There’s literally no way I could migrate my NAS other than through an in-place FS conversion since it’s &gt;&gt;50% full.<p>The same probably applies to may consumer devices.</div><br/></div></div><div id="39767421" class="c"><input type="checkbox" id="c-39767421" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#39766978">root</a><span>|</span><a href="#39767313">parent</a><span>|</span><a href="#39769100">prev</a><span>|</span><a href="#39767016">next</a><span>|</span><label class="collapse" for="c-39767421">[-]</label><label class="expand" for="c-39767421">[1 more]</label></div><br/><div class="children"><div class="content">&gt; It might have been a common use case back when btrfs was new (though I doubt it, most users of btrfs probably created the filesystem from scratch even back then), but I doubt it&#x27;s a common use case nowadays.<p>It&#x27;s perhaps not as common as it once was, but you&#x27;d expect it to be common enough to work, and not some obscure corner case.</div><br/></div></div></div></div></div></div><div id="39767016" class="c"><input type="checkbox" id="c-39767016" checked=""/><div class="controls bullet"><span class="by">zaggynl</span><span>|</span><a href="#39766978">prev</a><span>|</span><a href="#39767228">next</a><span>|</span><label class="collapse" for="c-39767016">[-]</label><label class="expand" for="c-39767016">[1 more]</label></div><br/><div class="children"><div class="content">For what it&#x27;s worth, I&#x27;m happy with using Btrfs on OpenSUSE Tumbleweed and the provided tooling like snapper and restoring Btrfs snapshots from grub, saved me a few times.<p>SSD used: Samsung SSD 970 PRO 1T, same installation since 2020-05-02.</div><br/></div></div><div id="39767228" class="c"><input type="checkbox" id="c-39767228" checked=""/><div class="controls bullet"><span class="by">applied_heat</span><span>|</span><a href="#39767016">prev</a><span>|</span><a href="#39767332">next</a><span>|</span><label class="collapse" for="c-39767228">[-]</label><label class="expand" for="c-39767228">[2 more]</label></div><br/><div class="children"><div class="content">Btrfs seems to work perfectly well in synology NAS. It must be some other combination of options or functions in use from what is available in synology that garners the bad reputation</div><br/><div id="39767990" class="c"><input type="checkbox" id="c-39767990" checked=""/><div class="controls bullet"><span class="by">gh02t</span><span>|</span><a href="#39767228">parent</a><span>|</span><a href="#39767332">next</a><span>|</span><label class="collapse" for="c-39767990">[-]</label><label class="expand" for="c-39767990">[1 more]</label></div><br/><div class="children"><div class="content">Synology uses BTRFS weirdly, on top of dmraid, which negates the most well-known BTRFS bugs in their RAID5&#x2F;6 implementation*. Best I can tell they also have some custom modifications in their implementation as well, though it&#x27;s hard to find much info on it.<p>* FWIW, I used native BTRFS RAID5 for years and never had an issue but that&#x27;s just anecdata</div><br/></div></div></div></div><div id="39767332" class="c"><input type="checkbox" id="c-39767332" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767228">prev</a><span>|</span><a href="#39766885">next</a><span>|</span><label class="collapse" for="c-39767332">[-]</label><label class="expand" for="c-39767332">[30 more]</label></div><br/><div class="children"><div class="content">This bug is very very rare in practice: all my dev and testing machines run btrfs, and I haven&#x27;t hit it once in 100+ machine-hours of running on 6.8-rc.<p>The actual patch is buried at the end the article: <a href="https:&#x2F;&#x2F;lore.kernel.org&#x2F;linux-btrfs&#x2F;1ca6e688950ee82b1526bb3098852af99b75e6ba.1710551459.git.tavianator@tavianator.com&#x2F;" rel="nofollow">https:&#x2F;&#x2F;lore.kernel.org&#x2F;linux-btrfs&#x2F;1ca6e688950ee82b1526bb30...</a></div><br/><div id="39769201" class="c"><input type="checkbox" id="c-39769201" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">parent</a><span>|</span><a href="#39767390">next</a><span>|</span><label class="collapse" for="c-39769201">[-]</label><label class="expand" for="c-39769201">[22 more]</label></div><br/><div class="children"><div class="content">100 error-free machine hours isn’t exactly evidence of anything when it comes to FS bugs, though.</div><br/><div id="39769603" class="c"><input type="checkbox" id="c-39769603" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769201">parent</a><span>|</span><a href="#39767390">next</a><span>|</span><label class="collapse" for="c-39769603">[-]</label><label class="expand" for="c-39769603">[21 more]</label></div><br/><div class="children"><div class="content">Of course it is: it&#x27;s evidence the average person will never hit this bug. Statistics, and all that.<p>Having worked on huge deployments of Linux servers before, I can tell you that modelling race condition bugs as having a uniform random chance of happening per unit time is <i>shockingly</i> predictive. But it&#x27;s not proof, obviously.</div><br/><div id="39769704" class="c"><input type="checkbox" id="c-39769704" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769603">parent</a><span>|</span><a href="#39769823">next</a><span>|</span><label class="collapse" for="c-39769704">[-]</label><label class="expand" for="c-39769704">[16 more]</label></div><br/><div class="children"><div class="content">&gt; modelling race condition bugs as having a uniform random chance of happening per unit time is shockingly predictive<p>I don&#x27;t generally disagree with that methodology, but 100 hours is just not a lot of time.<p>If you have a condition that takes, on average, 1000 hours to occur, you have a 9 in 10 chance of missing it based on 100 error-free hours observed, and yet it will still affect nearly 100% of all of your users after a bit more than a month!<p>For file systems, the aim should be (much more than) five nines, not nine fives.</div><br/><div id="39771903" class="c"><input type="checkbox" id="c-39771903" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769704">parent</a><span>|</span><a href="#39769848">next</a><span>|</span><label class="collapse" for="c-39771903">[-]</label><label class="expand" for="c-39771903">[2 more]</label></div><br/><div class="children"><div class="content">You edited this in after I replied, or maybe I missed it:<p>&gt; If you have a condition that takes, on average, 1000 hours to occur, you have a 9 in 10 chance of missing it based on 100 error-free hours observed, and yet it will still affect nearly 100% of all of your users after a bit more than a month!<p>I understand the point you&#x27;re trying to make here, but 1000 is just an incredibly unrealistically small number if we&#x27;re modelling bugs like that. The real number might be on the order of millions. The effect you&#x27;re describing in real life might take decades: weeks is unrealistic.</div><br/><div id="39772231" class="c"><input type="checkbox" id="c-39772231" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39771903">parent</a><span>|</span><a href="#39769848">next</a><span>|</span><label class="collapse" for="c-39772231">[-]</label><label class="expand" for="c-39772231">[1 more]</label></div><br/><div class="children"><div class="content">I agree that a realistic error rate for this particular bug is much lower than 1 in 1000 hours (or it would have long been caught by others).<p>But that makes your evidence of 100 error-free hours <i>even less useful</i> to make any predictions about stability!</div><br/></div></div></div></div><div id="39769848" class="c"><input type="checkbox" id="c-39769848" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769704">parent</a><span>|</span><a href="#39771903">prev</a><span>|</span><a href="#39769823">next</a><span>|</span><label class="collapse" for="c-39769848">[-]</label><label class="expand" for="c-39769848">[13 more]</label></div><br/><div class="children"><div class="content">&gt; If you have a condition that takes, on average, 1000 hours to occur, you have a 9 in 10 chance of missing it based on 100 error-free hours observed<p>Yes. Which means 9&#x2F;10 users who used their machines 100 or fewer hours on the new kernel will never hit the hypothetical bug. Thank you for proving my point!<p>I&#x27;m not a filesystem developer, I&#x27;m a user: as a user, I don&#x27;t care about the long tail, I only care about the average case as it relates to my deployment size. As you correctly point out, my deployment is of negligible size, and the long tail is far far beyond my reach.<p>Aside: your hypothetical event has a 0.1% chance of happening each hour. That means it has a 99.9% chance of not happening each hour. The odds it doesn&#x27;t happen after 100 hours is 0.999^100, or 90.5%. I think you know that, I just don&#x27;t want a casual reader to infer it&#x27;s 90% because 1-(100&#x2F;1000) is 0.9.</div><br/><div id="39769965" class="c"><input type="checkbox" id="c-39769965" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769848">parent</a><span>|</span><a href="#39770326">next</a><span>|</span><label class="collapse" for="c-39769965">[-]</label><label class="expand" for="c-39769965">[10 more]</label></div><br/><div class="children"><div class="content">&gt; Which means 9&#x2F;10 users who used their machines 100 or fewer hours on the new kernel will never hit the bug.<p>No, that&#x27;s not how probabilities work at all for a bug that happens with uniform probability (i.e. <i>not</i> bugs that deterministically happen after n hours since boot). If you have millions of users, some of them will hit it within hours or even minutes after boot!<p>&gt; As you correctly point out, my deployment is of negligible size, and the long tail is far far beyond my reach.<p>So you don&#x27;t expect to accrue on the order of 1000 machine-hours in your deployment? That&#x27;s only a month for a single machine, or half a week for 10. That would be way too much for me even for my home server RPi, let alone anything that holds customer data.<p>&gt; I&#x27;m not a filesystem developer, I&#x27;m a user: I don&#x27;t care about the long tail, I only care about the average case as it relates to my deployment size.<p>Yes, but unfortunately you seem to either have the math completely wrong or I&#x27;m not understanding your deployment properly.</div><br/><div id="39771556" class="c"><input type="checkbox" id="c-39771556" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769965">parent</a><span>|</span><a href="#39771411">next</a><span>|</span><label class="collapse" for="c-39771556">[-]</label><label class="expand" for="c-39771556">[8 more]</label></div><br/><div class="children"><div class="content">&gt; So you don&#x27;t expect to accrue on the order of 1000 machine-hours in your deployment?<p>The 1000 number came from you. I have no idea where you got it from. I suspect the &quot;real number&quot; is several orders of magnitude higher, but I have no idea, and it&#x27;s sort of artificial in the first place.<p>My overarching point is that mine is such a vanishingly small portion of the universe of machines running btrfs that I am virtually guaranteed that bugs will be found and fixed before they affect me, exactly as happened here. Unless you run a rather large business, that&#x27;s probably true for you too.<p>The filesystem with the most users has the least bugs. Nothing with the feature set of btrfs has even 1% the real world deployment footprint it does.<p>&gt; If you have millions of users, some of them will hit it within hours or even minutes after boot!<p>This is weirdly sensationalist: I don&#x27;t get it. Nobody dies when their filesystem gets corrupted. Nobody even loses money, unless they&#x27;ve been negligent. At worst it&#x27;s a nuisance to restore a backup.</div><br/><div id="39771603" class="c"><input type="checkbox" id="c-39771603" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39771556">parent</a><span>|</span><a href="#39774916">next</a><span>|</span><label class="collapse" for="c-39771603">[-]</label><label class="expand" for="c-39771603">[6 more]</label></div><br/><div class="children"><div class="content">&gt; The 1000 number came from you. I have no idea where you got it from,<p>It&#x27;s an arbitrary example of an error rate you&#x27;d have a 90% chance of missing in your sample size of 100 machine-hours, yet much too high for almost any meaningful application.<p>I have no idea what the actual error rate of that btrfs bug is; my only point is that your original assertion of &quot;I&#x27;ve experienced 100 error-free hours, so this is a non-issue for me and my users&quot; is a non sequitur.<p>&gt; This is weirdly sensationalist: I don&#x27;t get it. Nobody dies when their filesystem gets corrupted. Nobody even loses money, unless they&#x27;ve been negligent.<p>I don&#x27;t know what to say to that other than that I wish I had your optimism on reliable system design practices across various industries.<p>Maybe there&#x27;s a parallel universe where people treat every file system as having an error rate of something like &quot;data corruption&#x2F;loss once every four days&quot;, but it&#x27;s not the one I&#x27;m familiar with.<p>For better or worse, the bar for file system reliability is much, much, much, much higher than anything you could reasonably produce empirical data for unless you&#x27;re operating at Google&#x2F;AWS etc. scale.</div><br/><div id="39772112" class="c"><input type="checkbox" id="c-39772112" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39771603">parent</a><span>|</span><a href="#39774916">next</a><span>|</span><label class="collapse" for="c-39772112">[-]</label><label class="expand" for="c-39772112">[5 more]</label></div><br/><div class="children"><div class="content">&gt; &quot;I&#x27;ve experienced 100 error-free hours, so this is a non-issue for me and my users&quot;<p>It&#x27;s a statement of fact: it has been a non-issue for me. If you&#x27;re like me, it&#x27;s statistically reasonable to assume it will be a non-issue for you too. Also, no users, just me. &quot;Proabably okay&quot; is more than good enough for me, and I&#x27;m sure many people have similar requirements (clearly not you).<p>I have no optimism, just no empathy for the negligent: I learned my lesson with backups a long time ago. Some people blame the filesystem instead of their backup practices when their data is corrupted, but I think that&#x27;s naive. The filesystem did you a favor, fix your shit. Next time it will be your NAS power supply frying your storage.<p>It&#x27;s also a double edged sword: the more reliable a filesystem is, the longer users can get away without backups before being bitten, and the greater their ultimate loss will be.</div><br/><div id="39772171" class="c"><input type="checkbox" id="c-39772171" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39772112">parent</a><span>|</span><a href="#39774916">next</a><span>|</span><label class="collapse" for="c-39772171">[-]</label><label class="expand" for="c-39772171">[4 more]</label></div><br/><div class="children"><div class="content">&gt; It&#x27;s a statement of fact: it has been a non-issue for me.<p>Yes...<p>&gt; If you&#x27;re like me, it&#x27;s statistically reasonable to assume it will be a non-issue for you too.<p>No! This simply does not follow from the first statement, statistically or otherwise.<p>You and I might or might not be fine; you having been fine for 100 hours on the same configuration just offers next-to-zero predictive power for that.</div><br/><div id="39772230" class="c"><input type="checkbox" id="c-39772230" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39772171">parent</a><span>|</span><a href="#39774916">next</a><span>|</span><label class="collapse" for="c-39772230">[-]</label><label class="expand" for="c-39772230">[3 more]</label></div><br/><div class="children"><div class="content">&gt; No! This simply does not follow from the first statement, statistically or otherwise.<p>&gt; You and I might or might not be fine; you having been fine for 100 hours on the same configuration just offers next-to-zero predictive power for that.<p>You&#x27;re missing the forest for the trees here.<p>It is predictive <i>ON AVERAGE</i>. I don&#x27;t care about the worst case like you do: I only care about the <i>expected case</i>. If I died when my filesystem got corrupted... I would hope it&#x27;s obvious I wouldn&#x27;t approach it this way.<p>Adding to this: my laptop has this btrfs bug right now. I&#x27;m not going to do anything about it, because it&#x27;s not worth 20 minutes of my time to rebuild my kernel for a bug that is unlikely to bite before I get the fix in 6.9-rc1, and would only cost me 30 minutes of time in the worst case if it did.<p>I&#x27;ll update if it bites me. I&#x27;ve bet on much worse poker hands :)</div><br/><div id="39772487" class="c"><input type="checkbox" id="c-39772487" checked=""/><div class="controls bullet"><span class="by">lxgr</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39772230">parent</a><span>|</span><a href="#39774911">next</a><span>|</span><label class="collapse" for="c-39772487">[-]</label><label class="expand" for="c-39772487">[1 more]</label></div><br/><div class="children"><div class="content">Well, from your data (100 error-free hours, sample size 1) alone, we can only conclude this: “The bug probably happens less frequently than every few hours”.<p>Is that reliable enough for you? Great! Is that “very rare”? Absolutely not for almost any type of user&#x2F;scenario I can imagine.<p>If you’re making any statistical arguments beyond that data, or are implying more data than that, please provide either, otherwise this will lead nowhere.</div><br/></div></div><div id="39774911" class="c"><input type="checkbox" id="c-39774911" checked=""/><div class="controls bullet"><span class="by">Dylan16807</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39772230">parent</a><span>|</span><a href="#39772487">prev</a><span>|</span><a href="#39774916">next</a><span>|</span><label class="collapse" for="c-39774911">[-]</label><label class="expand" for="c-39774911">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I only care about the expected case.<p>The expected case after surviving a hundred hours is that you&#x27;re likely to survive another hundred.<p>Which is a completely useless promise.<p>That piece of data doesn&#x27;t let you predict anything at reasonable time scales for an OS install.<p>You can&#x27;t squeeze more implications out of such a small sample.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39774916" class="c"><input type="checkbox" id="c-39774916" checked=""/><div class="controls bullet"><span class="by">bmicraft</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39771556">parent</a><span>|</span><a href="#39771603">prev</a><span>|</span><a href="#39771411">next</a><span>|</span><label class="collapse" for="c-39774916">[-]</label><label class="expand" for="c-39774916">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Nothing with the feature set of btrfs has even 1% the real world deployment footprint it does.<p>So you haven&#x27;t heard of zfs then?</div><br/></div></div></div></div></div></div><div id="39770326" class="c"><input type="checkbox" id="c-39770326" checked=""/><div class="controls bullet"><span class="by">kbolino</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769848">parent</a><span>|</span><a href="#39769965">prev</a><span>|</span><a href="#39771060">next</a><span>|</span><label class="collapse" for="c-39770326">[-]</label><label class="expand" for="c-39770326">[1 more]</label></div><br/><div class="children"><div class="content">A single 9 in reliability over 100 hours would be colossally bad for a filesystem. For the average office user, 100 hours is not even a month&#x27;s worth of daily use.<p>Even as an anecdote this is completely useless. A couple thousand hours and dozens of mount&#x2F;unmount cycles would just be a good start.</div><br/></div></div><div id="39771060" class="c"><input type="checkbox" id="c-39771060" checked=""/><div class="controls bullet"><span class="by">paulddraper</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769848">parent</a><span>|</span><a href="#39770326">prev</a><span>|</span><a href="#39769823">next</a><span>|</span><label class="collapse" for="c-39771060">[-]</label><label class="expand" for="c-39771060">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Yes. Which means 9&#x2F;10 users who used their machines 100 or fewer hours on the new kernel will never hit the hypothetical bug. Thank you for proving my point!<p>So....that&#x27;s really bad.</div><br/></div></div></div></div></div></div><div id="39769823" class="c"><input type="checkbox" id="c-39769823" checked=""/><div class="controls bullet"><span class="by">BenjiWiebe</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769603">parent</a><span>|</span><a href="#39769704">prev</a><span>|</span><a href="#39775110">next</a><span>|</span><label class="collapse" for="c-39769823">[-]</label><label class="expand" for="c-39769823">[1 more]</label></div><br/><div class="children"><div class="content">If I&#x27;m running btrfs on my NAS, that&#x27;s only ~4 days of runtime. If there&#x27;s a bug that trashes the filesystem every month on average, that&#x27;s really bad and yet is very unlikely to get caught in 4 days of running.</div><br/></div></div><div id="39775110" class="c"><input type="checkbox" id="c-39775110" checked=""/><div class="controls bullet"><span class="by">kalleboo</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769603">parent</a><span>|</span><a href="#39769823">prev</a><span>|</span><a href="#39769818">next</a><span>|</span><label class="collapse" for="c-39775110">[-]</label><label class="expand" for="c-39775110">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve been running a public file server[0] on a 1994 vintage PowerBook 540c running Macintosh System 7.5 using the HFS file system on an SD card (via a SCSI2SD adapter) for like 400 hours straight this month, with zero issues.<p>Not once would I even insinuate that after my 400 hours of experience, HFS is a file system people should rely on.<p>100 hours says nothing. When I read your comment I just assumed that you had typoed 100 machine-years (as in running a server farm) as that would have been far more relevant.<p>[0] Participating in the MARCHintosh GlobalTalk worldwide AppleTalk network full of vintage computers and emulators</div><br/></div></div><div id="39769818" class="c"><input type="checkbox" id="c-39769818" checked=""/><div class="controls bullet"><span class="by">7bit</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769603">parent</a><span>|</span><a href="#39775110">prev</a><span>|</span><a href="#39771033">next</a><span>|</span><label class="collapse" for="c-39769818">[-]</label><label class="expand" for="c-39769818">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Of course it is: it&#x27;s evidence the average person will never hit this bug. Statistics, and all that.<p>Anecdotal statistics maybe.</div><br/></div></div><div id="39771033" class="c"><input type="checkbox" id="c-39771033" checked=""/><div class="controls bullet"><span class="by">valicord</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769603">parent</a><span>|</span><a href="#39769818">prev</a><span>|</span><a href="#39767390">next</a><span>|</span><label class="collapse" for="c-39771033">[-]</label><label class="expand" for="c-39771033">[1 more]</label></div><br/><div class="children"><div class="content">You do understand that 100 hours is not even 5 days, right?</div><br/></div></div></div></div></div></div><div id="39767390" class="c"><input type="checkbox" id="c-39767390" checked=""/><div class="controls bullet"><span class="by">tavianator</span><span>|</span><a href="#39767332">parent</a><span>|</span><a href="#39769201">prev</a><span>|</span><a href="#39766885">next</a><span>|</span><label class="collapse" for="c-39767390">[-]</label><label class="expand" for="c-39767390">[7 more]</label></div><br/><div class="children"><div class="content">Do they run btrfs on top of dm-crypt?  I suspect it&#x27;s impossible to reproduce on a regular block device.</div><br/><div id="39767631" class="c"><input type="checkbox" id="c-39767631" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39767390">parent</a><span>|</span><a href="#39767410">next</a><span>|</span><label class="collapse" for="c-39767631">[-]</label><label class="expand" for="c-39767631">[5 more]</label></div><br/><div class="children"><div class="content">Did this ever trip any of the debugging ASSERT stuff for you? I&#x27;m  really curious if some more generic debugging instrument might be able to flag this failure mode more explicitly, it&#x27;s far from the first ABA problem with -&gt;bflags.<p>Also, if you don&#x27;t mind sharing your kconfig that would be interesting to see too.</div><br/><div id="39768135" class="c"><input type="checkbox" id="c-39768135" checked=""/><div class="controls bullet"><span class="by">tavianator</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39767631">parent</a><span>|</span><a href="#39767410">next</a><span>|</span><label class="collapse" for="c-39768135">[-]</label><label class="expand" for="c-39768135">[4 more]</label></div><br/><div class="children"><div class="content">No, but I may have been missing some debugging CONFIGs.  I was just using the stock Arch kconfig.<p>I did submit a patch to add a WARN_ON() for this case: <a href="https:&#x2F;&#x2F;lore.kernel.org&#x2F;linux-btrfs&#x2F;d4a055317bdb8ecbd7e6d9bdb5ebb074fa93f7f8.1710769876.git.tavianator@tavianator.com&#x2F;" rel="nofollow">https:&#x2F;&#x2F;lore.kernel.org&#x2F;linux-btrfs&#x2F;d4a055317bdb8ecbd7e6d9bd...</a><p>But to catch the general class of bugs you&#x27;d need something like KCSAN.  I did try that but the kernel is not KCSAN-clean so it was hard to know if any reports were relevant.</div><br/><div id="39769370" class="c"><input type="checkbox" id="c-39769370" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39768135">parent</a><span>|</span><a href="#39767410">next</a><span>|</span><label class="collapse" for="c-39769370">[-]</label><label class="expand" for="c-39769370">[3 more]</label></div><br/><div class="children"><div class="content">The WARN is great.<p>Something as general as KCSAN isn&#x27;t necessary: it&#x27;s a classic ABA problem, double checking the -&gt;bflags value on transitions is sufficient to catch it. Like a lockdep-style thing where *_bit() are optionally replaced by helpers that check the current value and WARN if the transition is unexpected.<p>Using the event numbering from your patch description, such a thing would have flagged seeing UPTODATE at (2). But the space of invalid transitions is is much larger than the space of valid ones, which is why I think it might help catch other future bugs sooner.<p>Dunno if it&#x27;s actually worth it, but I definitely recall bugs of this flavor in the past. It&#x27;ll take some work to unearth them all, alas...</div><br/><div id="39769872" class="c"><input type="checkbox" id="c-39769872" checked=""/><div class="controls bullet"><span class="by">tavianator</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769370">parent</a><span>|</span><a href="#39767410">next</a><span>|</span><label class="collapse" for="c-39769872">[-]</label><label class="expand" for="c-39769872">[2 more]</label></div><br/><div class="children"><div class="content">I like that idea, but it isn&#x27;t really compatible with my fix.  `bflags` still makes the same transitions, I just skip the actual read in the `UPTODATE | READING` case.</div><br/><div id="39770336" class="c"><input type="checkbox" id="c-39770336" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39769872">parent</a><span>|</span><a href="#39767410">next</a><span>|</span><label class="collapse" for="c-39770336">[-]</label><label class="expand" for="c-39770336">[1 more]</label></div><br/><div class="children"><div class="content">I think after your fix the set of valid states in that spot would just include UPTODATE. But this is all very poorly thought out on my part...</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39767410" class="c"><input type="checkbox" id="c-39767410" checked=""/><div class="controls bullet"><span class="by">jcalvinowens</span><span>|</span><a href="#39767332">root</a><span>|</span><a href="#39767390">parent</a><span>|</span><a href="#39767631">prev</a><span>|</span><a href="#39766885">next</a><span>|</span><label class="collapse" for="c-39767410">[-]</label><label class="expand" for="c-39767410">[1 more]</label></div><br/><div class="children"><div class="content">Yes, most of them do, precisely because I&#x27;m trying to catch more bugs :)</div><br/></div></div></div></div></div></div><div id="39766885" class="c"><input type="checkbox" id="c-39766885" checked=""/><div class="controls bullet"><span class="by">Daunk</span><span>|</span><a href="#39767332">prev</a><span>|</span><a href="#39766881">next</a><span>|</span><label class="collapse" for="c-39766885">[-]</label><label class="expand" for="c-39766885">[11 more]</label></div><br/><div class="children"><div class="content">I recently tried (for the first time) Btrfs on my low-end laptop (no snapshots), and I was surprised to see that the laptop ran even worse than it usually does! Turns out there was something like a &quot;btrfs-cleaner&quot; (or similar) running in the background, eating up almost all the CPU at all time. After about 2 days I jumped over to ext4 and everything ran just fine.</div><br/><div id="39770582" class="c"><input type="checkbox" id="c-39770582" checked=""/><div class="controls bullet"><span class="by">mritzmann</span><span>|</span><a href="#39766885">parent</a><span>|</span><a href="#39767898">next</a><span>|</span><label class="collapse" for="c-39770582">[-]</label><label class="expand" for="c-39770582">[1 more]</label></div><br/><div class="children"><div class="content">Had a similar problem but can&#x27;t remember the Btrfs process. Anyway, after I switched off Btrfs quotas, everything was fine.</div><br/></div></div><div id="39767898" class="c"><input type="checkbox" id="c-39767898" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#39766885">parent</a><span>|</span><a href="#39770582">prev</a><span>|</span><a href="#39767434">next</a><span>|</span><label class="collapse" for="c-39767898">[-]</label><label class="expand" for="c-39767898">[2 more]</label></div><br/><div class="children"><div class="content">&gt; I recently tried Btrfs on my low-end laptop (no snapshots)<p>Do snapshots degrade the performance of btrfs?</div><br/><div id="39773925" class="c"><input type="checkbox" id="c-39773925" checked=""/><div class="controls bullet"><span class="by">j16sdiz</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39767898">parent</a><span>|</span><a href="#39767434">next</a><span>|</span><label class="collapse" for="c-39773925">[-]</label><label class="expand" for="c-39773925">[1 more]</label></div><br/><div class="children"><div class="content">No noticeably.
you see the difference when enabling CoW though</div><br/></div></div></div></div><div id="39767434" class="c"><input type="checkbox" id="c-39767434" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#39766885">parent</a><span>|</span><a href="#39767898">prev</a><span>|</span><a href="#39768778">next</a><span>|</span><label class="collapse" for="c-39767434">[-]</label><label class="expand" for="c-39767434">[3 more]</label></div><br/><div class="children"><div class="content">Interesting that the &#x27;cleaner&#x27; doesn&#x27;t run as nice?</div><br/><div id="39770714" class="c"><input type="checkbox" id="c-39770714" checked=""/><div class="controls bullet"><span class="by">rcthompson</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39767434">parent</a><span>|</span><a href="#39768778">next</a><span>|</span><label class="collapse" for="c-39770714">[-]</label><label class="expand" for="c-39770714">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m pretty sure it&#x27;s a kernel thread, not a process, since it&#x27;s part of the filesystem. So it can&#x27;t be renice&#x27;d.</div><br/><div id="39773807" class="c"><input type="checkbox" id="c-39773807" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39770714">parent</a><span>|</span><a href="#39768778">next</a><span>|</span><label class="collapse" for="c-39773807">[-]</label><label class="expand" for="c-39773807">[1 more]</label></div><br/><div class="children"><div class="content">Oh, that&#x27;s annoying.  I wonder if there&#x27;s a way with kernel configs etc to only run that thread when there&#x27;s nothing better to do?  Sounds like something someone would have thought of in general for background house keeping?</div><br/></div></div></div></div></div></div><div id="39768778" class="c"><input type="checkbox" id="c-39768778" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#39766885">parent</a><span>|</span><a href="#39767434">prev</a><span>|</span><a href="#39766881">next</a><span>|</span><label class="collapse" for="c-39768778">[-]</label><label class="expand" for="c-39768778">[4 more]</label></div><br/><div class="children"><div class="content">What was your workload? Do you have quotas enabled? Compression? Are you running OpenSuse by any chance?</div><br/><div id="39770114" class="c"><input type="checkbox" id="c-39770114" checked=""/><div class="controls bullet"><span class="by">Daunk</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39768778">parent</a><span>|</span><a href="#39766881">next</a><span>|</span><label class="collapse" for="c-39770114">[-]</label><label class="expand" for="c-39770114">[3 more]</label></div><br/><div class="children"><div class="content">Workload was literally zero, I just logged into XFCE and could barely do anything for 2 days straight. No quotas and no compression, but it was indeed openSUSE!</div><br/><div id="39770373" class="c"><input type="checkbox" id="c-39770373" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39770114">parent</a><span>|</span><a href="#39766881">next</a><span>|</span><label class="collapse" for="c-39770373">[-]</label><label class="expand" for="c-39770373">[2 more]</label></div><br/><div class="children"><div class="content">That explains it, because openSUSE uses snapshots and quotas by default. It creates a snapshot before and one after every package manager interaction and cleans up old snapshots once per day.<p>Unfortunately, deleting snapshots with quotas is an expensive operation that needs to rescan some structures to keep the quota information consistent and that is what you&#x27;re seeing.</div><br/><div id="39770480" class="c"><input type="checkbox" id="c-39770480" checked=""/><div class="controls bullet"><span class="by">Daunk</span><span>|</span><a href="#39766885">root</a><span>|</span><a href="#39770373">parent</a><span>|</span><a href="#39766881">next</a><span>|</span><label class="collapse" for="c-39770480">[-]</label><label class="expand" for="c-39770480">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m not sure that&#x27;s correct. When you install openSUSE (this was a clean install) there&#x27;s a checkbox that asks if you want snapshots, which I did not enable. But either way, a fresh openSUSE install with XFCE on Btrfs rendering the  computer unusable for, at least, 2 days is not okay in my book, even if snapshots were enabled.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39766881" class="c"><input type="checkbox" id="c-39766881" checked=""/><div class="controls bullet"><span class="by">e145bc455f1</span><span>|</span><a href="#39766885">prev</a><span>|</span><a href="#39767253">next</a><span>|</span><label class="collapse" for="c-39766881">[-]</label><label class="expand" for="c-39766881">[17 more]</label></div><br/><div class="children"><div class="content">Just last week my btrfs filesystem got irrecoverably corrupted. This is like the fourth time it has happened to me in the last 10 years. Do not use it in consumer grade hardware. Compared to this, ext4 is rock solid. It was even able to survive me accidentally passing the currently running host&#x27;s hard disk to a VM guest, which booted from it.</div><br/><div id="39767639" class="c"><input type="checkbox" id="c-39767639" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39771132">next</a><span>|</span><label class="collapse" for="c-39767639">[-]</label><label class="expand" for="c-39767639">[1 more]</label></div><br/><div class="children"><div class="content">&gt; It was even able to survive me accidentally passing the currently running host&#x27;s hard disk to a VM guest, which booted from it.<p>I have also done this, and was also happy that the only corruption was to a handful of unimportant log files.    Part of a robust filesystem is that when the user does something stupid, the blast radius is small.<p>Other less-smart filesystems could easily have said &quot;root of btree version mismatch, deleting bad btree node, deleting a bunch of now unused btree nodes, your filesystem is now empty, have a nice day&quot;.</div><br/></div></div><div id="39771132" class="c"><input type="checkbox" id="c-39771132" checked=""/><div class="controls bullet"><span class="by">gmokki</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39767639">prev</a><span>|</span><a href="#39767399">next</a><span>|</span><label class="collapse" for="c-39771132">[-]</label><label class="expand" for="c-39771132">[2 more]</label></div><br/><div class="children"><div class="content">I have had same btrfs filesystem in use for 15+ years, with 6 disks of various sizes. And all hardware components changed at least once during the fileystsen lifetime.<p>Worst corruption was when one DIMM started corrupting data. As a result computer kept crashing and eventually refused to mount because of btrfs checksum mismatches.<p>Fix was to buy new HW. Then run btrfs filesystem repairs, which failed at some point but at least got the filesystem running as long as I did not touch the most corrupted locations, luckily it was RAID1 so most checksums had a correct value on another disk.
Unfortunately the checksum tree had on two locations corruption on both copies.
I had to open the raw disks with hex editor and change the offending byte to correct value, after which the filesystem has been running again smoothly for 5 years.<p>And to find the location to modify on the disks I built a custom kernel that printed the expected value and absolute disk position when it detected the specific corruption. Plus had to ask a friend to double check my changes since I did not have any backups.</div><br/><div id="39771511" class="c"><input type="checkbox" id="c-39771511" checked=""/><div class="controls bullet"><span class="by">matja</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39771132">parent</a><span>|</span><a href="#39767399">next</a><span>|</span><label class="collapse" for="c-39771511">[-]</label><label class="expand" for="c-39771511">[1 more]</label></div><br/><div class="children"><div class="content">&gt; running again smoothly for 5 years<p>So did you bite the bullet and get ECC, or are you just waiting for the next corruption caused by memory errors? :)</div><br/></div></div></div></div><div id="39767399" class="c"><input type="checkbox" id="c-39767399" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39771132">prev</a><span>|</span><a href="#39773638">next</a><span>|</span><label class="collapse" for="c-39767399">[-]</label><label class="expand" for="c-39767399">[7 more]</label></div><br/><div class="children"><div class="content">&gt;  last week my btrfs filesystem got irrecoverably corrupted.<p>This is 2 bugs really.    1, the file system got corrupted.   2, tooling didn&#x27;t exist to automatically scan through the disk data structures and recover as much of your drive as possible from whatever fragments of metadata and data were left.<p>For 2, it should happen by default.    Most users don&#x27;t want a &#x27;disk is corrupt, refusing to mount&#x27; error.   Most users want any errors to auto-correct if possible and get on with their day.  Keep a recovery logfile with all the info needed to reverse any repairs for that small percentage of users who want to use a hex editor to dive into data corruption by hand.</div><br/><div id="39768615" class="c"><input type="checkbox" id="c-39768615" checked=""/><div class="controls bullet"><span class="by">TillE</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39767399">parent</a><span>|</span><a href="#39770683">next</a><span>|</span><label class="collapse" for="c-39768615">[-]</label><label class="expand" for="c-39768615">[1 more]</label></div><br/><div class="children"><div class="content">Yeah the last time I had a btrfs volume die, there were a few troubleshooting&#x2F;recovery steps on the wiki which I dutifully followed. Complete failure, no data recoverable. The last step was &quot;I dunno, go ask someone on IRC.&quot; Great.<p>It&#x27;s understandable that corruption can happen due to bugs or hardware failure or user insanity, but my experience was that the recovery tools are useless, and that&#x27;s a big problem.</div><br/></div></div><div id="39770683" class="c"><input type="checkbox" id="c-39770683" checked=""/><div class="controls bullet"><span class="by">rcthompson</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39767399">parent</a><span>|</span><a href="#39768615">prev</a><span>|</span><a href="#39767782">next</a><span>|</span><label class="collapse" for="c-39770683">[-]</label><label class="expand" for="c-39770683">[1 more]</label></div><br/><div class="children"><div class="content">Writing to a corrupted filesystem by default is bad design. The corruption could be caused by a hardware problem that is exacerbated by further writes, leading to additional data loss.</div><br/></div></div><div id="39767782" class="c"><input type="checkbox" id="c-39767782" checked=""/><div class="controls bullet"><span class="by">mrob</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39767399">parent</a><span>|</span><a href="#39770683">prev</a><span>|</span><a href="#39773638">next</a><span>|</span><label class="collapse" for="c-39767782">[-]</label><label class="expand" for="c-39767782">[4 more]</label></div><br/><div class="children"><div class="content">Where is that log file supposed to be stored? It can&#x27;t be on the same filesystem it was created for or it negates the purpose of its creation.</div><br/><div id="39768451" class="c"><input type="checkbox" id="c-39768451" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39767782">parent</a><span>|</span><a href="#39773638">next</a><span>|</span><label class="collapse" for="c-39768451">[-]</label><label class="expand" for="c-39768451">[3 more]</label></div><br/><div class="children"><div class="content">If I were designing it, the recovery process would:<p>* scan through the whole disk and, for every sector, decide if it is &quot;definitely free space (part of the free space table, not referenced by any metadata)&quot;, &quot;definitely metadata&#x2F;file data&quot;, &quot;unknown&#x2F;unsure (ie. perhaps referenced by some dangling metadata&#x2F;an old version of some tree nodes)&quot;.<p>* I would then make a new file containing a complete image of the whole filesystem pre-repair, but leaving out the &#x27;definitely free space&#x27; parts.<p>* such a file takes nearly zero space, considering btrfs&#x27;s copy-on-write and sparse-file abilities.<p>* I would then repair the filesystem to make everything consistent.   The pre-repair file would still be available for any tooling wanting to see what the filesystem looked like before it was repaired.  You could even loopmount it or try other repair options on it.<p>* I would probably encourage distros to auto-delete this recovery file if disk space is low&#x2F;after some time, since otherwise the recovery image will end up pinning user data to using up disk space for years and users will be unhappy.<p>The above fails in only one case:   Free space on the drive is very low.   In that case, I would probably just do the repairs in-RAM and mount the filesystem readonly, and have a link to a wiki page on possible manual repair routes.</div><br/><div id="39774140" class="c"><input type="checkbox" id="c-39774140" checked=""/><div class="controls bullet"><span class="by">j16sdiz</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39768451">parent</a><span>|</span><a href="#39773638">next</a><span>|</span><label class="collapse" for="c-39774140">[-]</label><label class="expand" for="c-39774140">[2 more]</label></div><br/><div class="children"><div class="content">&gt;The above fails in only one case: Free space on the drive is very low.<p>No.
Most of the block will be marked as unsure in first step -- because most of them had been used before thanks to CoW</div><br/><div id="39775197" class="c"><input type="checkbox" id="c-39775197" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39774140">parent</a><span>|</span><a href="#39773638">next</a><span>|</span><label class="collapse" for="c-39775197">[-]</label><label class="expand" for="c-39775197">[1 more]</label></div><br/><div class="children"><div class="content">A heuristic could be written like &#x27;protect the latest version of each node, plus 2 prior versions, but anything older you find, treat it as free apace&#x27;.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="39773638" class="c"><input type="checkbox" id="c-39773638" checked=""/><div class="controls bullet"><span class="by">thequux</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39767399">prev</a><span>|</span><a href="#39768291">next</a><span>|</span><label class="collapse" for="c-39773638">[-]</label><label class="expand" for="c-39773638">[1 more]</label></div><br/><div class="children"><div class="content">Huh. I&#x27;ve been running btrfs on a number of systems for probably 12 years at this point. One array in particular was 12TiB of raw storage used for storing VM images in heavy use. Each disk had ~9 years of spindle-on time before I happened to look closely at the SMART output and realized that they were all ST3000DM001&#x27;s and promptly swapped them all out. The only issue I&#x27;ve ever run into is running out of metadata chunks and needing to rebalance, and that was just once.</div><br/></div></div><div id="39768291" class="c"><input type="checkbox" id="c-39768291" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39773638">prev</a><span>|</span><a href="#39774512">next</a><span>|</span><label class="collapse" for="c-39768291">[-]</label><label class="expand" for="c-39768291">[1 more]</label></div><br/><div class="children"><div class="content">Best send a bugreport to the btrfs mailing list at linux-btrfs@vger.kernel.org.<p>If possible include the last kernel log entries before it corrupted. Include kernel version, drive model and drive firmware version.</div><br/></div></div><div id="39774512" class="c"><input type="checkbox" id="c-39774512" checked=""/><div class="controls bullet"><span class="by">champtar</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39768291">prev</a><span>|</span><a href="#39772456">next</a><span>|</span><label class="collapse" for="c-39774512">[-]</label><label class="expand" for="c-39774512">[1 more]</label></div><br/><div class="children"><div class="content">Bad DIMM is a thing, even more so on consumer HW that lack ECC. I recommend you run memtest</div><br/></div></div><div id="39772456" class="c"><input type="checkbox" id="c-39772456" checked=""/><div class="controls bullet"><span class="by">matheusmoreira</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39774512">prev</a><span>|</span><a href="#39770238">next</a><span>|</span><label class="collapse" for="c-39772456">[-]</label><label class="expand" for="c-39772456">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Compared to this, ext4 is rock solid.<p>Ext4 is the most reliable file system I have ever used. Just works and has never failed on me, not even once. No idea why btrfs can&#x27;t match its quality despite over a decade of development.</div><br/></div></div><div id="39770238" class="c"><input type="checkbox" id="c-39770238" checked=""/><div class="controls bullet"><span class="by">riku_iki</span><span>|</span><a href="#39766881">parent</a><span>|</span><a href="#39772456">prev</a><span>|</span><a href="#39767253">next</a><span>|</span><label class="collapse" for="c-39770238">[-]</label><label class="expand" for="c-39770238">[2 more]</label></div><br/><div class="children"><div class="content">how do you know it was issue with FS and not actual hardware&#x2F;disk?..</div><br/><div id="39772282" class="c"><input type="checkbox" id="c-39772282" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#39766881">root</a><span>|</span><a href="#39770238">parent</a><span>|</span><a href="#39767253">next</a><span>|</span><label class="collapse" for="c-39772282">[-]</label><label class="expand" for="c-39772282">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, that&#x27;s the fun part of the ext&#x2F;btrfs corruption posts. If you got repeating corruption on btrfs on the same drive but not on ext, how do you know it&#x27;s not just a drive failure that ext is not able to notice? What would happen if you tried ext with dm-integrity?</div><br/></div></div></div></div></div></div><div id="39770048" class="c"><input type="checkbox" id="c-39770048" checked=""/><div class="controls bullet"><span class="by">apitman</span><span>|</span><a href="#39767253">prev</a><span>|</span><a href="#39766723">next</a><span>|</span><label class="collapse" for="c-39770048">[-]</label><label class="expand" for="c-39770048">[10 more]</label></div><br/><div class="children"><div class="content">I really wish you could use custom filesystems such as btrfs with WSL2. I don&#x27;t think there&#x27;s currently any way to do snapshotting, which means you can never be sure a backup taken within WSL is corrupt.</div><br/><div id="39771155" class="c"><input type="checkbox" id="c-39771155" checked=""/><div class="controls bullet"><span class="by">cogman10</span><span>|</span><a href="#39770048">parent</a><span>|</span><a href="#39771622">next</a><span>|</span><label class="collapse" for="c-39771155">[-]</label><label class="expand" for="c-39771155">[2 more]</label></div><br/><div class="children"><div class="content">You can, it&#x27;s just a bit of a pain.<p><a href="https:&#x2F;&#x2F;blog.bryanroessler.com&#x2F;2020-12-14-btrfs-on-wsl2&#x2F;" rel="nofollow">https:&#x2F;&#x2F;blog.bryanroessler.com&#x2F;2020-12-14-btrfs-on-wsl2&#x2F;</a></div><br/><div id="39772486" class="c"><input type="checkbox" id="c-39772486" checked=""/><div class="controls bullet"><span class="by">apitman</span><span>|</span><a href="#39770048">root</a><span>|</span><a href="#39771155">parent</a><span>|</span><a href="#39771622">next</a><span>|</span><label class="collapse" for="c-39772486">[-]</label><label class="expand" for="c-39772486">[1 more]</label></div><br/><div class="children"><div class="content">Nice. Unfortunately for my use case I can&#x27;t use physical storage devices. I need a something similar to a qcow2 that can be created and completely managed by my app.</div><br/></div></div></div></div><div id="39771622" class="c"><input type="checkbox" id="c-39771622" checked=""/><div class="controls bullet"><span class="by">mappu</span><span>|</span><a href="#39770048">parent</a><span>|</span><a href="#39771155">prev</a><span>|</span><a href="#39770661">next</a><span>|</span><label class="collapse" for="c-39771622">[-]</label><label class="expand" for="c-39771622">[3 more]</label></div><br/><div class="children"><div class="content">Hope that <a href="https:&#x2F;&#x2F;github.com&#x2F;veeam&#x2F;blksnap&#x2F;issues&#x2F;2">https:&#x2F;&#x2F;github.com&#x2F;veeam&#x2F;blksnap&#x2F;issues&#x2F;2</a> becomes available soon. It&#x27;s on v7 of posting to linux-block and will make snapshotting available for all block devices.</div><br/><div id="39772559" class="c"><input type="checkbox" id="c-39772559" checked=""/><div class="controls bullet"><span class="by">apitman</span><span>|</span><a href="#39770048">root</a><span>|</span><a href="#39771622">parent</a><span>|</span><a href="#39770661">next</a><span>|</span><label class="collapse" for="c-39772559">[-]</label><label class="expand" for="c-39772559">[2 more]</label></div><br/><div class="children"><div class="content">This is the first I&#x27;ve heard of blksnap. Looks very interesting. There&#x27;s not much documentation in the repo. Am I understanding correctly that if I were to build a custom WSL kernel with those patches, I would be able to do snapshotting in WSL today?<p>Can you give or link to a brief description of how blksnap works?</div><br/><div id="39773814" class="c"><input type="checkbox" id="c-39773814" checked=""/><div class="controls bullet"><span class="by">mappu</span><span>|</span><a href="#39770048">root</a><span>|</span><a href="#39772559">parent</a><span>|</span><a href="#39770661">next</a><span>|</span><label class="collapse" for="c-39773814">[-]</label><label class="expand" for="c-39773814">[1 more]</label></div><br/><div class="children"><div class="content">You could do block device snapshotting today if you build your block devices on top of LVM. You can also somewhat do it with fsfreeze and remounting your mount point on top of a dm-snapshot target.<p>Blksnap is better because it does not require setup in advance like LVM, and it does not require interrupting any live users like fsfreeze. It &quot;should&quot; just work with the live block device within the WSL distro.<p>LWN covered the v1 posting, which is a good start: <a href="https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;914031&#x2F;" rel="nofollow">https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;914031&#x2F;</a><p>This is all somewhat future-looking, and if you only want file-level snapshotting instead of block-level, it&#x27;s probably easier to try and get btrfs&#x2F;bcachefs&#x2F;nilfs2 instead. My WSL2 on Windows 11 shows btrfs present inside &#x2F;proc&#x2F;filesystems.</div><br/></div></div></div></div></div></div><div id="39770661" class="c"><input type="checkbox" id="c-39770661" checked=""/><div class="controls bullet"><span class="by">aseipp</span><span>|</span><a href="#39770048">parent</a><span>|</span><a href="#39771622">prev</a><span>|</span><a href="#39770590">next</a><span>|</span><label class="collapse" for="c-39770661">[-]</label><label class="expand" for="c-39770661">[1 more]</label></div><br/><div class="children"><div class="content">Hell, even just being able to use XFS would be an improvement, because ext4 has painful degradation scenarios when you hit cases like exhausting the inode count.<p>(Somewhat related, but there has been a WIP 6.1 kernel for WSL2 &quot;in preview&quot; for a while now... I wonder why it hasn&#x27;t become the default considering both it and 5.12 are LTS... For filesystems like btrfs I often want a newer kernel to pick up every bugfix.)</div><br/></div></div><div id="39770590" class="c"><input type="checkbox" id="c-39770590" checked=""/><div class="controls bullet"><span class="by">chasil</span><span>|</span><a href="#39770048">parent</a><span>|</span><a href="#39770661">prev</a><span>|</span><a href="#39772038">next</a><span>|</span><label class="collapse" for="c-39770590">[-]</label><label class="expand" for="c-39770590">[2 more]</label></div><br/><div class="children"><div class="content">Can this be used? I knew ReactOS would use it natively.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;maharmstone&#x2F;btrfs">https:&#x2F;&#x2F;github.com&#x2F;maharmstone&#x2F;btrfs</a></div><br/><div id="39772574" class="c"><input type="checkbox" id="c-39772574" checked=""/><div class="controls bullet"><span class="by">apitman</span><span>|</span><a href="#39770048">root</a><span>|</span><a href="#39770590">parent</a><span>|</span><a href="#39772038">next</a><span>|</span><label class="collapse" for="c-39772574">[-]</label><label class="expand" for="c-39772574">[1 more]</label></div><br/><div class="children"><div class="content">Maybe that could be adapted, but I don&#x27;t think it would solve my problem currently. Basically I want to be able to do btrfs snapshots from within my WSL distros, so that I can run restic or similar on the snapshots.</div><br/></div></div></div></div></div></div><div id="39766723" class="c"><input type="checkbox" id="c-39766723" checked=""/><div class="controls bullet"><span class="by">throw0101d</span><span>|</span><a href="#39770048">prev</a><span>|</span><a href="#39767193">next</a><span>|</span><label class="collapse" for="c-39766723">[-]</label><label class="expand" for="c-39766723">[33 more]</label></div><br/><div class="children"><div class="content">Given that (Open)ZFS[1] is quite mature, and Bcachefs[2] seems to be gaining popularity, how much of a future does Btrfs have?<p>[1] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;ZFS" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;ZFS</a><p>[2] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Bcachefs" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Bcachefs</a></div><br/><div id="39768356" class="c"><input type="checkbox" id="c-39768356" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#39766723">parent</a><span>|</span><a href="#39767297">next</a><span>|</span><label class="collapse" for="c-39768356">[-]</label><label class="expand" for="c-39768356">[2 more]</label></div><br/><div class="children"><div class="content">I fully expect bcachefs will initially hit similar issues like btrfs.<p>Until now (bcachefs has been merged) it has only been used by people running custom kernels. As more people try it, it will hit more and more drives with buggy firmware and whatnot.</div><br/><div id="39772308" class="c"><input type="checkbox" id="c-39772308" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39768356">parent</a><span>|</span><a href="#39767297">next</a><span>|</span><label class="collapse" for="c-39772308">[-]</label><label class="expand" for="c-39772308">[1 more]</label></div><br/><div class="children"><div class="content">They&#x27;re in a slightly different position though. Bcache itself has existed for many years and has been used in production. Bcachefs changes it quite a bit, but I wouldn&#x27;t expect any basic issues we&#x27;ve seen elsewhere.</div><br/></div></div></div></div><div id="39767297" class="c"><input type="checkbox" id="c-39767297" checked=""/><div class="controls bullet"><span class="by">bhaney</span><span>|</span><a href="#39766723">parent</a><span>|</span><a href="#39768356">prev</a><span>|</span><a href="#39766758">next</a><span>|</span><label class="collapse" for="c-39767297">[-]</label><label class="expand" for="c-39767297">[1 more]</label></div><br/><div class="children"><div class="content">As a heavy btrfs user, I do expect bcachefs to fully replace it eventually. But that&#x27;s still many years off.</div><br/></div></div><div id="39766758" class="c"><input type="checkbox" id="c-39766758" checked=""/><div class="controls bullet"><span class="by">opengears</span><span>|</span><a href="#39766723">parent</a><span>|</span><a href="#39767297">prev</a><span>|</span><a href="#39766936">next</a><span>|</span><label class="collapse" for="c-39766758">[-]</label><label class="expand" for="c-39766758">[26 more]</label></div><br/><div class="children"><div class="content">I big future (unless ZFS licensing incompatibility is solved)</div><br/><div id="39766980" class="c"><input type="checkbox" id="c-39766980" checked=""/><div class="controls bullet"><span class="by">throw0101d</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766758">parent</a><span>|</span><a href="#39766872">next</a><span>|</span><label class="collapse" for="c-39766980">[-]</label><label class="expand" for="c-39766980">[5 more]</label></div><br/><div class="children"><div class="content">Why would Btrfs have a big(ger) future than Bcachefs when the latter seems to have the same functionality and less &#x27;historical baggage&#x27;†?<p>I remember when Btrfs was initially released (I was doing Solaris sysadmining, and it was billed as &quot;ZFS for Linux&quot;), and yet here we are all these years later and it still seems to be &#x27;meh&#x27;.<p>† E.g., RAID5+ that&#x27;s less likely to eat data:<p>* <a href="https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;btrfs-man5.html#raid56-status-and-recommended-practices" rel="nofollow">https:&#x2F;&#x2F;btrfs.readthedocs.io&#x2F;en&#x2F;latest&#x2F;btrfs-man5.html#raid5...</a><p>* <a href="https:&#x2F;&#x2F;bcachefs.org&#x2F;ErasureCoding&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bcachefs.org&#x2F;ErasureCoding&#x2F;</a>  &#x2F; <a href="https:&#x2F;&#x2F;github.com&#x2F;koverstreet&#x2F;bcachefs&#x2F;issues&#x2F;657">https:&#x2F;&#x2F;github.com&#x2F;koverstreet&#x2F;bcachefs&#x2F;issues&#x2F;657</a></div><br/><div id="39767571" class="c"><input type="checkbox" id="c-39767571" checked=""/><div class="controls bullet"><span class="by">bhaney</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766980">parent</a><span>|</span><a href="#39766872">next</a><span>|</span><label class="collapse" for="c-39767571">[-]</label><label class="expand" for="c-39767571">[4 more]</label></div><br/><div class="children"><div class="content">By the time future-bcachefs has feature parity with present-btrfs, who knows what more will be in future-btrfs?<p>For your specific example, bcachefs&#x27;s erasure coding is very experimental and currently pretty much unusable, while btrfs is actively working towards fixing the raid56 write hole with the recent addition of the raid-stripe-tree. By the time bcachefs has a trustworthy parity profile, btrfs&#x27;s <i>may</i> be just as good.</div><br/><div id="39768330" class="c"><input type="checkbox" id="c-39768330" checked=""/><div class="controls bullet"><span class="by">throw0101d</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767571">parent</a><span>|</span><a href="#39768095">next</a><span>|</span><label class="collapse" for="c-39768330">[-]</label><label class="expand" for="c-39768330">[2 more]</label></div><br/><div class="children"><div class="content">&gt; <i>For your specific example</i><p>My specific example says that the bcachefs are &quot;actively working towards fixing the raid56 write hole&quot; as well—or rather, their way of doing things doesn&#x27;t have one in the first place.</div><br/><div id="39771004" class="c"><input type="checkbox" id="c-39771004" checked=""/><div class="controls bullet"><span class="by">bhaney</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39768330">parent</a><span>|</span><a href="#39768095">next</a><span>|</span><label class="collapse" for="c-39771004">[-]</label><label class="expand" for="c-39771004">[1 more]</label></div><br/><div class="children"><div class="content">&gt; bcachefs are &quot;actively working towards fixing the raid56 write hole&quot; as well<p>Yep, that&#x27;s my point. Neither btrfs nor bcachefs have a write-hole-less parity raid profile implementation yet, and both are working towards one. We don&#x27;t know if one will be finished and battle tested significantly before the other, or if one will prove to be more performant or reliable. Just have to wait and see.</div><br/></div></div></div></div><div id="39768095" class="c"><input type="checkbox" id="c-39768095" checked=""/><div class="controls bullet"><span class="by">curt15</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767571">parent</a><span>|</span><a href="#39768330">prev</a><span>|</span><a href="#39766872">next</a><span>|</span><label class="collapse" for="c-39768095">[-]</label><label class="expand" for="c-39768095">[1 more]</label></div><br/><div class="children"><div class="content">Bcachefs has not advertised erasure coding as production ready only to renege on that claim later. So nobody has been unwittingly burned yet.</div><br/></div></div></div></div></div></div><div id="39766872" class="c"><input type="checkbox" id="c-39766872" checked=""/><div class="controls bullet"><span class="by">maxloh</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766758">parent</a><span>|</span><a href="#39766980">prev</a><span>|</span><a href="#39766820">next</a><span>|</span><label class="collapse" for="c-39766872">[-]</label><label class="expand" for="c-39766872">[13 more]</label></div><br/><div class="children"><div class="content">GPL only forbids ZFS to be distributed alongside Linux, it doesn&#x27;t prevent users from installing it manually. (IANAL)</div><br/><div id="39767760" class="c"><input type="checkbox" id="c-39767760" checked=""/><div class="controls bullet"><span class="by">vladvasiliu</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766872">parent</a><span>|</span><a href="#39767594">next</a><span>|</span><label class="collapse" for="c-39767760">[-]</label><label class="expand" for="c-39767760">[3 more]</label></div><br/><div class="children"><div class="content">In addition to what mustache_kimono said, there apparently seem to be issues with kernel functions moving  &#x2F; changing and breaking ZFS which then needs a while to catch up. For the latest reoccurrence of this, see <a href="https:&#x2F;&#x2F;github.com&#x2F;openzfs&#x2F;zfs&#x2F;pull&#x2F;15931">https:&#x2F;&#x2F;github.com&#x2F;openzfs&#x2F;zfs&#x2F;pull&#x2F;15931</a> for Linux 6.8 compatibility.<p>There&#x27;s also the fact that not everything is OOB compatible with ZFS. For example, newer versions of systemd have been able to use the TPM to unlock drives encrypted with LUKS. AFAIK it doesn&#x27;t work with ZFS.<p>I use ZFS on my daily driver Linux box and mostly love it, but as long as these things happen, I can see why people may want to try to find an in-kernel solution. I personally use Arch so expect for bleeding edge updates to not work perfectly right away. But I recall seeing folks complaining about issues on Fedora, too, which I expect to be a bit more conservative than Arch.</div><br/><div id="39768327" class="c"><input type="checkbox" id="c-39768327" checked=""/><div class="controls bullet"><span class="by">didntcheck</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767760">parent</a><span>|</span><a href="#39767594">next</a><span>|</span><label class="collapse" for="c-39768327">[-]</label><label class="expand" for="c-39768327">[2 more]</label></div><br/><div class="children"><div class="content">LUKS and the associated systemd hook shouldn&#x27;t care about the filesystem, right? It&#x27;s just block layer<p>But presumably you meant native ZFS encryption, which unfortunately is considered to be somewhat experimental and neglected, as I understand. Which surprised me, since I thought data at rest encryption would be pretty important for an &quot;enterprise&quot; filesystem<p>Still, apparently lots of people successfully run ZFS on LUKS. It does mean you don&#x27;t get zero-trust zfs send backups, but apparently that&#x27;s where a lot of the bugs have been anyway</div><br/><div id="39768443" class="c"><input type="checkbox" id="c-39768443" checked=""/><div class="controls bullet"><span class="by">vladvasiliu</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39768327">parent</a><span>|</span><a href="#39767594">next</a><span>|</span><label class="collapse" for="c-39768443">[-]</label><label class="expand" for="c-39768443">[1 more]</label></div><br/><div class="children"><div class="content">Yes, I was talking about ZFS native encryption.<p>&gt; But presumably you meant native ZFS encryption, which unfortunately is considered to be somewhat experimental and neglected, as I understand. Which surprised me, since I thought data at rest encryption would be pretty important for an &quot;enterprise&quot; filesystem.<p>Yeah, I&#x27;ve happened about someone saying something similar, but I&#x27;ve never seen anything about that from &quot;official&quot; sources. Wouldn&#x27;t mind a link or something if you have one on hand. But there is the fact that this encryption scheme seems limited when compared to LUKS: there&#x27;s no support for multiple passphrases or using anything more convenient, like say, a U2F token.<p>&gt; Still, apparently lots of people successfully run ZFS on LUKS. It does mean you don&#x27;t get zero-trust zfs send backups, but apparently that&#x27;s where a lot of the bugs have been anyway<p>I&#x27;d say I&#x27;m one of those people, never had any issue with this in ~ten years of use. And, indeed, the main reason for using this on my laptop is being able to send the snapshots around without having to deal with another tool for managing encryption. Also, on my servers on which I run RAIDZ, having to configure LUKS on top of each drive is a PITA.</div><br/></div></div></div></div></div></div><div id="39767594" class="c"><input type="checkbox" id="c-39767594" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766872">parent</a><span>|</span><a href="#39767760">prev</a><span>|</span><a href="#39767133">next</a><span>|</span><label class="collapse" for="c-39767594">[-]</label><label class="expand" for="c-39767594">[8 more]</label></div><br/><div class="children"><div class="content">&gt; GPL only forbids ZFS to be distributed alongside Linux<p>But does it even do that?  You might be surprised when&#x2F;if you read a little more widely.  Position of OpenZFS project[0] is which I find persuasive (my emphasis added):<p><pre><code>    In the case of the Linux Kernel, this prevents us from distributing OpenZFS as part of the Linux Kernel binary. *However, there is nothing in either license that prevents distributing it in the form of a binary module* or in the form of source code.
</code></pre>
[0]: <a href="https:&#x2F;&#x2F;openzfs.github.io&#x2F;openzfs-docs&#x2F;License.html" rel="nofollow">https:&#x2F;&#x2F;openzfs.github.io&#x2F;openzfs-docs&#x2F;License.html</a><p>You might see also:<p>[1]: <a href="https:&#x2F;&#x2F;www.networkworld.com&#x2F;article&#x2F;836039&#x2F;smb-encouraging-closed-source-modules-part-1-copyright-and-software.html" rel="nofollow">https:&#x2F;&#x2F;www.networkworld.com&#x2F;article&#x2F;836039&#x2F;smb-encouraging-...</a><p>[2]: <a href="https:&#x2F;&#x2F;law.resource.org&#x2F;pub&#x2F;us&#x2F;case&#x2F;reporter&#x2F;F2&#x2F;977&#x2F;977.F2d.1510.92-15655.html" rel="nofollow">https:&#x2F;&#x2F;law.resource.org&#x2F;pub&#x2F;us&#x2F;case&#x2F;reporter&#x2F;F2&#x2F;977&#x2F;977.F2d...</a></div><br/><div id="39767658" class="c"><input type="checkbox" id="c-39767658" checked=""/><div class="controls bullet"><span class="by">lmz</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767594">parent</a><span>|</span><a href="#39767133">next</a><span>|</span><label class="collapse" for="c-39767658">[-]</label><label class="expand" for="c-39767658">[7 more]</label></div><br/><div class="children"><div class="content">It doesn&#x27;t matter what the project thinks as long as there is code owned by Oracle in the FS.</div><br/><div id="39767689" class="c"><input type="checkbox" id="c-39767689" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767658">parent</a><span>|</span><a href="#39767133">next</a><span>|</span><label class="collapse" for="c-39767689">[-]</label><label class="expand" for="c-39767689">[6 more]</label></div><br/><div class="children"><div class="content">&gt; It doesn&#x27;t matter what the project thinks as long as there is code owned by Oracle in the FS.<p>Might we agree then that the only thing that really matters is the law?  And we should ignore other opinions <i>cough</i>like from the FSF&#x2F;the SFC<i>cough</i> which don&#x27;t make reference to the law?  Or which ignore long held copyright law principles, like fair use?<p>Please take a look at the case law.  The so far theoretical claim of OpenZFS&#x2F;Linux incompatibility is especially <i>weak</i> re: a binary kernel module.</div><br/><div id="39769578" class="c"><input type="checkbox" id="c-39769578" checked=""/><div class="controls bullet"><span class="by">wtallis</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767689">parent</a><span>|</span><a href="#39767133">next</a><span>|</span><label class="collapse" for="c-39769578">[-]</label><label class="expand" for="c-39769578">[5 more]</label></div><br/><div class="children"><div class="content">What matters in practice isn&#x27;t the law, but how much trouble Oracle could cause should the lawnmower veer in that direction. Even a complete rewrite of ZFS would have some risk associated with it given Oracle&#x27;s history.</div><br/><div id="39771391" class="c"><input type="checkbox" id="c-39771391" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39769578">parent</a><span>|</span><a href="#39767133">next</a><span>|</span><label class="collapse" for="c-39771391">[-]</label><label class="expand" for="c-39771391">[4 more]</label></div><br/><div class="children"><div class="content">&gt; What matters in practice isn&#x27;t the law, but how much trouble Oracle could cause should the lawnmower veer in that direction.<p>Veer in what direction?  The current state of affairs re: Canonical and Oracle is a ZFS binary kernel module shipped with the Linux kernel.  Canonical has <i>literally</i> done the thing that which you are speculating is impermissible.  And, for 8 years, Oracle has done nothing.  Oracle&#x27;s attorneys have even publicly disagreed <i>with the SFC</i> that a ZFS binary kernel module violates the GPL or the CDDL.[0]<p>Given this state of affairs, the level of legal certainty re: this question is far greater than the legal certainty we have re: pretty much any other open IP question in tech.<p>What matters is practice, is that you stop your&#x2F;the SFC&#x27;s&#x2F;the FSF&#x27;s torrent of FUD.<p>&gt; Even a complete rewrite of ZFS would have some risk associated with it given Oracle&#x27;s history.<p>I&#x27;d ask &quot;How?&quot;, but it&#x27;d be another torrent of &quot;What if...&quot;s.<p>[0]: <a href="https:&#x2F;&#x2F;youtu.be&#x2F;PFMPjt_RgXA?t=2260" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;PFMPjt_RgXA?t=2260</a></div><br/><div id="39774138" class="c"><input type="checkbox" id="c-39774138" checked=""/><div class="controls bullet"><span class="by">wtallis</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39771391">parent</a><span>|</span><a href="#39772369">next</a><span>|</span><label class="collapse" for="c-39774138">[-]</label><label class="expand" for="c-39774138">[2 more]</label></div><br/><div class="children"><div class="content">I said that what matters is not the law, to which you responded by doubling down on your argument about what the law says, accused me of disagreeing with you on an issue I did not take a position on, and then went for the personal attacks.<p>In case my lawnmower reference confused you enough that you were unable to make an appropriate response to the point I <i>actually made</i>, I&#x27;ll try to state it a bit more clearly:<p>It <i>does not matter</i> how confident you are that Oracle would eventually lose a lawsuit over using or distributing ZFS with the Linux kernel. If Oracle decides to attempt to exert control over ZFS and interfere with the use or distribution of ZFS with Linux, they have ample resources to make a lot of very expensive trouble for various users and organizations. Oracle&#x27;s history—most importantly, their history vs Google re Java in Android—means it would not be much of a stretch for them to decide to start behaving like The SCO Group. I do not think this risk is large. But I do think it is a real risk that a cautious Linux distro can reasonably be worried about.<p>If you truly believe that Oracle&#x27;s lack of action thus far against ZFS on Linux and their public statements of their beliefs about the effects of the CDDL and GPL would prevent them from <i>starting shit</i>, then you are simply wrong about how our legal system works, and there are plenty of examples. The things you point to to bolster your arguments about what the law says are things that would make it hard for Oracle to win a lawsuit on its merits, but the eventual judgement is hardly the only thing that matters when assessing a legal risk—<i>especially</i> if your pockets are not as deep as Oracle&#x27;s.</div><br/><div id="39774806" class="c"><input type="checkbox" id="c-39774806" checked=""/><div class="controls bullet"><span class="by">mustache_kimono</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39774138">parent</a><span>|</span><a href="#39772369">next</a><span>|</span><label class="collapse" for="c-39774806">[-]</label><label class="expand" for="c-39774806">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I do not think this risk is large. But I do think it is a real risk that a cautious Linux distro can reasonably be worried about.<p>The 2nd or 3rd most commercially important Linux distro has been using ZFS since 2016.<p>&gt; If you truly believe that Oracle&#x27;s lack of action thus far against ZFS on Linux and their public statements of their beliefs about the effects of the CDDL and GPL would prevent them from starting shit<p>I understand the argument &quot;Oracle might do something&quot;, plus spooky magic fingers and creepy noises, all too well.  Except it&#x27;s not actually an argument.  It might be best described as a boogeyman, sent to frighten little children into not running ZFS.<p>My point was:  I think it&#x27;s time for you to get over sleeping with the light on.<p>In 2000, we called this FUD when Microsoft did this.  In 2024, we should know better, even when you&#x27;re fronting for the FSF or the SFC.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div id="39766820" class="c"><input type="checkbox" id="c-39766820" checked=""/><div class="controls bullet"><span class="by">maxloh</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766758">parent</a><span>|</span><a href="#39766872">prev</a><span>|</span><a href="#39766936">next</a><span>|</span><label class="collapse" for="c-39766820">[-]</label><label class="expand" for="c-39766820">[7 more]</label></div><br/><div class="children"><div class="content">Maybe replace Oracle-owned code with a clean room implementation?</div><br/><div id="39767151" class="c"><input type="checkbox" id="c-39767151" checked=""/><div class="controls bullet"><span class="by">arp242</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766820">parent</a><span>|</span><a href="#39767325">next</a><span>|</span><label class="collapse" for="c-39767151">[-]</label><label class="expand" for="c-39767151">[4 more]</label></div><br/><div class="children"><div class="content">They did that. It&#x27;s called &quot;btrfs&quot;.<p>A stable clean-room ZFS with on-disk compatibility would be a huge task. How long did stable NTFS write capability take? And NTFS is a much simpler filesystem. It would also be a huge waste of time given that btrfs and bcachefs exist, and that ZFS is fine to use license-wise – it&#x27;s just distribution that&#x27;s a tad awkward (but not overly so).</div><br/><div id="39769277" class="c"><input type="checkbox" id="c-39769277" checked=""/><div class="controls bullet"><span class="by">rascul</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39767151">parent</a><span>|</span><a href="#39767325">next</a><span>|</span><label class="collapse" for="c-39769277">[-]</label><label class="expand" for="c-39769277">[3 more]</label></div><br/><div class="children"><div class="content">Interesting to note here that btrfs came from Oracle.</div><br/><div id="39769935" class="c"><input type="checkbox" id="c-39769935" checked=""/><div class="controls bullet"><span class="by">tadfisher</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39769277">parent</a><span>|</span><a href="#39767325">next</a><span>|</span><label class="collapse" for="c-39769935">[-]</label><label class="expand" for="c-39769935">[2 more]</label></div><br/><div class="children"><div class="content">&quot;Chris Mason is the founding developer of btrfs, which he began working on in 2007 while working at Oracle. This leads many people to believe that btrfs is an Oracle project—it is not. The project belonged to Mason, not to his employer, and it remains a community project unencumbered by corporate ownership to this day.&quot;<p><a href="https:&#x2F;&#x2F;arstechnica.com&#x2F;gadgets&#x2F;2021&#x2F;09&#x2F;examining-btrfs-linuxs-perpetually-half-finished-filesystem&#x2F;" rel="nofollow">https:&#x2F;&#x2F;arstechnica.com&#x2F;gadgets&#x2F;2021&#x2F;09&#x2F;examining-btrfs-linu...</a></div><br/><div id="39775651" class="c"><input type="checkbox" id="c-39775651" checked=""/><div class="controls bullet"><span class="by">chungy</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39769935">parent</a><span>|</span><a href="#39767325">next</a><span>|</span><label class="collapse" for="c-39775651">[-]</label><label class="expand" for="c-39775651">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s countered by btrfs&#x27;s source code always beginning with &quot;Copyright (C) 2007 Oracle.&quot;<p>Maybe it was Mason&#x27;s pet project within the company, but there is no ambiguity that Oracle owns it. It is an Oracle project.</div><br/></div></div></div></div></div></div></div></div><div id="39767325" class="c"><input type="checkbox" id="c-39767325" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766820">parent</a><span>|</span><a href="#39767151">prev</a><span>|</span><a href="#39766969">next</a><span>|</span><label class="collapse" for="c-39767325">[-]</label><label class="expand" for="c-39767325">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think that would work; all of the changes since the fork are also CDDL and they aren&#x27;t owned by any one entity&#x2F;person. (IANAL)</div><br/></div></div><div id="39766969" class="c"><input type="checkbox" id="c-39766969" checked=""/><div class="controls bullet"><span class="by">DaSHacka</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766820">parent</a><span>|</span><a href="#39767325">prev</a><span>|</span><a href="#39766936">next</a><span>|</span><label class="collapse" for="c-39766969">[-]</label><label class="expand" for="c-39766969">[1 more]</label></div><br/><div class="children"><div class="content">Would you not basically be starting over at that point, though?</div><br/></div></div></div></div></div></div><div id="39766936" class="c"><input type="checkbox" id="c-39766936" checked=""/><div class="controls bullet"><span class="by">e145bc455f1</span><span>|</span><a href="#39766723">parent</a><span>|</span><a href="#39766758">prev</a><span>|</span><a href="#39767193">next</a><span>|</span><label class="collapse" for="c-39766936">[-]</label><label class="expand" for="c-39766936">[3 more]</label></div><br/><div class="children"><div class="content">When can we expect debian to ship Bcachefs?</div><br/><div id="39767050" class="c"><input type="checkbox" id="c-39767050" checked=""/><div class="controls bullet"><span class="by">throw0101d</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766936">parent</a><span>|</span><a href="#39767155">next</a><span>|</span><label class="collapse" for="c-39767050">[-]</label><label class="expand" for="c-39767050">[1 more]</label></div><br/><div class="children"><div class="content">Bcachefs is in the Linux 6.7 kernel, and that is available in Debian <i>unstable</i> and <i>experimental</i>:<p>* <a href="https:&#x2F;&#x2F;packages.debian.org&#x2F;search?keywords=linux-image-6.7" rel="nofollow">https:&#x2F;&#x2F;packages.debian.org&#x2F;search?keywords=linux-image-6.7</a><p>* Search &quot;6.7.1-1~exp1&quot;: <a href="https:&#x2F;&#x2F;metadata.ftp-master.debian.org&#x2F;changelogs&#x2F;&#x2F;main&#x2F;l&#x2F;linux&#x2F;linux_6.7.4-1~exp1_changelog" rel="nofollow">https:&#x2F;&#x2F;metadata.ftp-master.debian.org&#x2F;changelogs&#x2F;&#x2F;main&#x2F;l&#x2F;li...</a></div><br/></div></div><div id="39767155" class="c"><input type="checkbox" id="c-39767155" checked=""/><div class="controls bullet"><span class="by">candiddevmike</span><span>|</span><a href="#39766723">root</a><span>|</span><a href="#39766936">parent</a><span>|</span><a href="#39767050">prev</a><span>|</span><a href="#39767193">next</a><span>|</span><label class="collapse" for="c-39767155">[-]</label><label class="expand" for="c-39767155">[1 more]</label></div><br/><div class="children"><div class="content">Bcachefs is not a drop-in replacement for btrfs yet.  It&#x27;s still missing critical things like scrub:<p><a href="https:&#x2F;&#x2F;bcachefs.org&#x2F;Roadmap&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bcachefs.org&#x2F;Roadmap&#x2F;</a></div><br/></div></div></div></div></div></div><div id="39767193" class="c"><input type="checkbox" id="c-39767193" checked=""/><div class="controls bullet"><span class="by">west0n</span><span>|</span><a href="#39766723">prev</a><span>|</span><a href="#39767071">next</a><span>|</span><label class="collapse" for="c-39767193">[-]</label><label class="expand" for="c-39767193">[12 more]</label></div><br/><div class="children"><div class="content">The vast majority of databases currently recommend using XFS.</div><br/><div id="39767513" class="c"><input type="checkbox" id="c-39767513" checked=""/><div class="controls bullet"><span class="by">londons_explore</span><span>|</span><a href="#39767193">parent</a><span>|</span><a href="#39767219">next</a><span>|</span><label class="collapse" for="c-39767513">[-]</label><label class="expand" for="c-39767513">[2 more]</label></div><br/><div class="children"><div class="content">All modern databases do large block streaming appending writes, and small random reads, usually of just a handful of files.<p>It ought to be easy to design a filesystem which can have pretty much zero overhead for those two operations.    I&#x27;m kinda disappointed that every filesystem doesn&#x27;t perform identically for the database workload.<p>I totally understand that different file systems would do different tradeoffs affecting directory listing, tiny file creation&#x2F;deletion, traversing deep directory trees, etc.   But random reads of a huge file ought to perform near identically to the underlying storage medium.</div><br/><div id="39768113" class="c"><input type="checkbox" id="c-39768113" checked=""/><div class="controls bullet"><span class="by">rubiquity</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767513">parent</a><span>|</span><a href="#39767219">next</a><span>|</span><label class="collapse" for="c-39768113">[-]</label><label class="expand" for="c-39768113">[1 more]</label></div><br/><div class="children"><div class="content">What you’re describing is basically ext4. I do know there are some proprietary databases that use raw block devices. The downside being that you also need to make your own user space utilities for inspecting and managing it.</div><br/></div></div></div></div><div id="39767219" class="c"><input type="checkbox" id="c-39767219" checked=""/><div class="controls bullet"><span class="by">west0n</span><span>|</span><a href="#39767193">parent</a><span>|</span><a href="#39767513">prev</a><span>|</span><a href="#39767071">next</a><span>|</span><label class="collapse" for="c-39767219">[-]</label><label class="expand" for="c-39767219">[9 more]</label></div><br/><div class="children"><div class="content">I&#x27;m very curious if there are any databases running in production environments on Btrfs or ZFS.</div><br/><div id="39767398" class="c"><input type="checkbox" id="c-39767398" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767219">parent</a><span>|</span><a href="#39770742">next</a><span>|</span><label class="collapse" for="c-39767398">[-]</label><label class="expand" for="c-39767398">[6 more]</label></div><br/><div class="children"><div class="content">It wasn&#x27;t a company you&#x27;ve heard of, but I can absolutely tell you that there are:) We <i>really</i> benefited from compressing our postgres databases; not only did it save space, but in some cases it actually improved throughput because data could be read and uncompressed faster than the disks were physically capable of.<p>Edit: Also there was a time when it was normal for databases to be running on Solaris, in which case ZFS is expected; my recollection is that Sun even marketed how great of a combination that was.</div><br/><div id="39769735" class="c"><input type="checkbox" id="c-39769735" checked=""/><div class="controls bullet"><span class="by">dfox</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767398">parent</a><span>|</span><a href="#39767459">next</a><span>|</span><label class="collapse" for="c-39769735">[-]</label><label class="expand" for="c-39769735">[1 more]</label></div><br/><div class="children"><div class="content">Sun marketed the combination of PostgreSQL and ZFS quite heavily. But IIRC most of the success stories they presented involved what was decidedly non-OLTP read heavy workload with somewhat ridiculously large databases. One of the case studies even involved using PostgreSQL on ZFS as an archival layer for Oracle, with the observation that what is a large Oracle database is medium-sized one for PostgreSQL (and probably even more so if it is read mostly and on ZFS).<p>Sunhad some recommendations for tuning PostgreSQL performance on ZFS, but the recommendations seemed weird or even wrong for OLTP on top of CoW filesystem (I assume that these recommendations were meant for the above mentioned DWH&#x2F;archival scenarios).</div><br/></div></div><div id="39767459" class="c"><input type="checkbox" id="c-39767459" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767398">parent</a><span>|</span><a href="#39769735">prev</a><span>|</span><a href="#39770742">next</a><span>|</span><label class="collapse" for="c-39767459">[-]</label><label class="expand" for="c-39767459">[4 more]</label></div><br/><div class="children"><div class="content">Interesting.  The compression options that postgres offers itself were not enough?</div><br/><div id="39767697" class="c"><input type="checkbox" id="c-39767697" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767459">parent</a><span>|</span><a href="#39771492">next</a><span>|</span><label class="collapse" for="c-39767697">[-]</label><label class="expand" for="c-39767697">[2 more]</label></div><br/><div class="children"><div class="content">It went the other way; we were using ZFS to protect against data errors, then found that it did compression as well. But looking now, the only native postgres options I see are TOAST, which seems to only work for certain data types in the database, and WAL compression (that&#x27;s only existed since pg 15), so unless I&#x27;ve missed something I would tend to say yes it&#x27;s far superior to the native options.</div><br/><div id="39773786" class="c"><input type="checkbox" id="c-39773786" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767697">parent</a><span>|</span><a href="#39771492">next</a><span>|</span><label class="collapse" for="c-39773786">[-]</label><label class="expand" for="c-39773786">[1 more]</label></div><br/><div class="children"><div class="content">I mostly only looked into the options offered by MariaDB a while ago, and they seemed quite neat.  I had just assumed that postgres was at least on par.<p>Thanks for reporting!</div><br/></div></div></div></div><div id="39771492" class="c"><input type="checkbox" id="c-39771492" checked=""/><div class="controls bullet"><span class="by">riku_iki</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767459">parent</a><span>|</span><a href="#39767697">prev</a><span>|</span><a href="#39770742">next</a><span>|</span><label class="collapse" for="c-39771492">[-]</label><label class="expand" for="c-39771492">[1 more]</label></div><br/><div class="children"><div class="content">postgres allows to compress only large text and blob column values.</div><br/></div></div></div></div></div></div><div id="39770742" class="c"><input type="checkbox" id="c-39770742" checked=""/><div class="controls bullet"><span class="by">chasil</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767219">parent</a><span>|</span><a href="#39767398">prev</a><span>|</span><a href="#39772414">next</a><span>|</span><label class="collapse" for="c-39770742">[-]</label><label class="expand" for="c-39770742">[1 more]</label></div><br/><div class="children"><div class="content">Only 12 pages. Oracle database on ZFS best practices.<p><a href="https:&#x2F;&#x2F;www.oracle.com&#x2F;technetwork&#x2F;server-storage&#x2F;solaris10&#x2F;config-solaris-zfs-wp-167894.pdf" rel="nofollow">https:&#x2F;&#x2F;www.oracle.com&#x2F;technetwork&#x2F;server-storage&#x2F;solaris10&#x2F;...</a></div><br/></div></div><div id="39772414" class="c"><input type="checkbox" id="c-39772414" checked=""/><div class="controls bullet"><span class="by">dilyevsky</span><span>|</span><a href="#39767193">root</a><span>|</span><a href="#39767219">parent</a><span>|</span><a href="#39770742">prev</a><span>|</span><a href="#39767071">next</a><span>|</span><label class="collapse" for="c-39772414">[-]</label><label class="expand" for="c-39772414">[1 more]</label></div><br/><div class="children"><div class="content">afaik meta (who are very large btrfs user) do not use it with mysql but do use it with rocksdb backends.<p>i think you can tweak it to make high random write load less painful but it generally will struggle with that.</div><br/></div></div></div></div></div></div><div id="39767071" class="c"><input type="checkbox" id="c-39767071" checked=""/><div class="controls bullet"><span class="by">xyzzy_plugh</span><span>|</span><a href="#39767193">prev</a><span>|</span><a href="#39768756">next</a><span>|</span><label class="collapse" for="c-39767071">[-]</label><label class="expand" for="c-39767071">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;m so sad. I was in the btrfs corner for over a decade, and it saddens me to say that ZFS has won. But it has.<p>And ZFS is actually good. I&#x27;m happy with it. I don&#x27;t think about it. I&#x27;ve moved on.<p>Sorry, btrfs, but I don&#x27;t think it&#x27;s ever going to work out between us. Maybe in a different life.</div><br/><div id="39771252" class="c"><input type="checkbox" id="c-39771252" checked=""/><div class="controls bullet"><span class="by">doublepg23</span><span>|</span><a href="#39767071">parent</a><span>|</span><a href="#39774209">next</a><span>|</span><label class="collapse" for="c-39771252">[-]</label><label class="expand" for="c-39771252">[1 more]</label></div><br/><div class="children"><div class="content">I’m personally cheering for Bcachefs now.</div><br/></div></div><div id="39774209" class="c"><input type="checkbox" id="c-39774209" checked=""/><div class="controls bullet"><span class="by">mardifoufs</span><span>|</span><a href="#39767071">parent</a><span>|</span><a href="#39771252">prev</a><span>|</span><a href="#39772498">next</a><span>|</span><label class="collapse" for="c-39774209">[-]</label><label class="expand" for="c-39774209">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I&#x27;m so sad. I was in the btrfs corner for over a decade, and it saddens me to say that ZFS has won. But it has.<p>&gt; And ZFS is actually good. I&#x27;m happy with it. I don&#x27;t think about it. I&#x27;ve moved on.<p>&gt; Sorry, btrfs, but I don&#x27;t think it&#x27;s ever going to work out between us. Maybe in a different life.<p>ZFS has had a worse bug not even 4 months ago. They are both very good filesystems, bugs happen</div><br/></div></div><div id="39772498" class="c"><input type="checkbox" id="c-39772498" checked=""/><div class="controls bullet"><span class="by">matheusmoreira</span><span>|</span><a href="#39767071">parent</a><span>|</span><a href="#39774209">prev</a><span>|</span><a href="#39768756">next</a><span>|</span><label class="collapse" for="c-39772498">[-]</label><label class="expand" for="c-39772498">[1 more]</label></div><br/><div class="children"><div class="content">What saddens me is the fact they <i>still</i> haven&#x27;t managed to put ZFS into the Linux kernel tree because of licensing nonsense.</div><br/></div></div></div></div><div id="39768756" class="c"><input type="checkbox" id="c-39768756" checked=""/><div class="controls bullet"><span class="by">cies</span><span>|</span><a href="#39767071">prev</a><span>|</span><a href="#39773385">next</a><span>|</span><label class="collapse" for="c-39768756">[-]</label><label class="expand" for="c-39768756">[2 more]</label></div><br/><div class="children"><div class="content">I had my &#x2F;home on a subvolume (great as the sub and super share the same space).<p>When I wanted to reinstall I naively thought I could format the root super volume and keep &#x2F;home subvolume -- but this was impossible: I had to format &#x2F;home as well according to the OpenSUSE Tumbleweed installer.<p>Major problem for me. I now have separate root (btrfs) and home (ext4) partitions.</div><br/><div id="39769734" class="c"><input type="checkbox" id="c-39769734" checked=""/><div class="controls bullet"><span class="by">stryan</span><span>|</span><a href="#39768756">parent</a><span>|</span><a href="#39773385">next</a><span>|</span><label class="collapse" for="c-39769734">[-]</label><label class="expand" for="c-39769734">[1 more]</label></div><br/><div class="children"><div class="content">You can do it but it&#x27;s not a very happy path. Easiest way is probably to map the old home subvolume into a different path and either re-label the subvolumes once you&#x27;re installed or just copy everything over.<p>Separate BTRFS root and ext4 home partitions is either the default filesystem layout now if you&#x27;re not doing FDE or the second recommended one.</div><br/></div></div></div></div><div id="39767727" class="c"><input type="checkbox" id="c-39767727" checked=""/><div class="controls bullet"><span class="by">TZubiri</span><span>|</span><a href="#39773385">prev</a><span>|</span><a href="#39767637">next</a><span>|</span><label class="collapse" for="c-39767727">[-]</label><label class="expand" for="c-39767727">[1 more]</label></div><br/><div class="children"><div class="content">reminder that btrfs stands for butter filesystem and not better filesystem</div><br/></div></div><div id="39767637" class="c"><input type="checkbox" id="c-39767637" checked=""/><div class="controls bullet"><span class="by">streb-lo</span><span>|</span><a href="#39767727">prev</a><span>|</span><a href="#39767364">next</a><span>|</span><label class="collapse" for="c-39767637">[-]</label><label class="expand" for="c-39767637">[6 more]</label></div><br/><div class="children"><div class="content">As someone who uses a rolling release, I use btrfs because I don&#x27;t want to deal with keeping ZFS up to date.<p>It&#x27;s been really good for me.  And btrbk is the best backup solution I&#x27;ve had on Linux, btrfs send&#x2F;receive is a lot faster than rsync even when sending non-incremental snapshots.</div><br/><div id="39770000" class="c"><input type="checkbox" id="c-39770000" checked=""/><div class="controls bullet"><span class="by">kccqzy</span><span>|</span><a href="#39767637">parent</a><span>|</span><a href="#39771453">next</a><span>|</span><label class="collapse" for="c-39770000">[-]</label><label class="expand" for="c-39770000">[1 more]</label></div><br/><div class="children"><div class="content">Same here: I use a rolling release and btrfs. Personally I really enjoy btrfs&#x27;s snapshot feature. Most of the time when I need backups it&#x27;s not because of a hardware failure but because of a fat finger mistake where I rm&#x27;ed a file I need. Periodic snapshots completely solved that problem for me.<p>(Of course, backing up to another disk is absolutely still needed, but you probably need it less than you think.)</div><br/></div></div><div id="39771453" class="c"><input type="checkbox" id="c-39771453" checked=""/><div class="controls bullet"><span class="by">matja</span><span>|</span><a href="#39767637">parent</a><span>|</span><a href="#39770000">prev</a><span>|</span><a href="#39771776">next</a><span>|</span><label class="collapse" for="c-39771453">[-]</label><label class="expand" for="c-39771453">[2 more]</label></div><br/><div class="children"><div class="content">&gt; I don&#x27;t want to deal with keeping ZFS up to date<p>That&#x27;s what DKMS is for, which most distros use for ZFS.  Install and forget.</div><br/><div id="39771546" class="c"><input type="checkbox" id="c-39771546" checked=""/><div class="controls bullet"><span class="by">streb-lo</span><span>|</span><a href="#39767637">root</a><span>|</span><a href="#39771453">parent</a><span>|</span><a href="#39771776">next</a><span>|</span><label class="collapse" for="c-39771546">[-]</label><label class="expand" for="c-39771546">[1 more]</label></div><br/><div class="children"><div class="content">I think the larger issue is that openzfs doesn&#x27;t move in sync with the kernel so you have to check <a href="https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;openzfs&#x2F;zfs&#x2F;master&#x2F;META" rel="nofollow">https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;openzfs&#x2F;zfs&#x2F;master&#x2F;META</a> to make sure you can actually upgrade each time.  On a rolling distro this is a pretty common breakage AFAIK.  It&#x27;s not the end of the world, but it is annoying.</div><br/></div></div></div></div><div id="39771776" class="c"><input type="checkbox" id="c-39771776" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#39767637">parent</a><span>|</span><a href="#39771453">prev</a><span>|</span><a href="#39772026">next</a><span>|</span><label class="collapse" for="c-39771776">[-]</label><label class="expand" for="c-39771776">[1 more]</label></div><br/><div class="children"><div class="content">Depends on the rolling release; some distros specifically provide a kernel package that is still rolling, but is also always the latest version compatible with ZFS.</div><br/></div></div></div></div></div></div></div></div></div></body></html>