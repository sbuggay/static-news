<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1700470865350" as="style"/><link rel="stylesheet" href="styles.css?v=1700470865350"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.evanjones.ca/setenv-is-not-thread-safe.html">Setenv Is Not Thread Safe and C Doesn&#x27;t Want to Fix It</a> <span class="domain">(<a href="https://www.evanjones.ca">www.evanjones.ca</a>)</span></div><div class="subtext"><span>r4um</span> | <span>39 comments</span></div><br/><div><div id="38345094" class="c"><input type="checkbox" id="c-38345094" checked=""/><div class="controls bullet"><span class="by">Galanwe</span><span>|</span><a href="#38344083">next</a><span>|</span><label class="collapse" for="c-38345094">[-]</label><label class="expand" for="c-38345094">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t quite get why this is a problem per se.<p>I mean, the environment is just a chunk of memory made available to the process by the OS. It is no more, no less thread safe than any other chunk of memory.<p>Why would the libc need to protect it more than any other memory location?</div><br/></div></div><div id="38344083" class="c"><input type="checkbox" id="c-38344083" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#38345094">prev</a><span>|</span><a href="#38344224">next</a><span>|</span><label class="collapse" for="c-38344083">[-]</label><label class="expand" for="c-38344083">[9 more]</label></div><br/><div class="children"><div class="content">&gt; This is a list of some uses of environment variables from fairly widely used libraries and services. This shows that environment variables are pretty widely used.<p>Widely used, yes.  Used as in read.  Why do any of these need to change at runtime?  And if they do - why are they environment variables?<p>(NB: starting a new process is not &quot;at runtime&quot;)</div><br/><div id="38345027" class="c"><input type="checkbox" id="c-38345027" checked=""/><div class="controls bullet"><span class="by">dmytroi</span><span>|</span><a href="#38344083">parent</a><span>|</span><a href="#38344909">next</a><span>|</span><label class="collapse" for="c-38345027">[-]</label><label class="expand" for="c-38345027">[1 more]</label></div><br/><div class="children"><div class="content">Mostly integration, for example some library can only be configured via env variables, but a developer might want to configure it from with-in the app it&#x27;s integrated into and used from.<p>Also, few weeks ago I found a use for them when trying to pass configuration from Java&#x2F;Kotlin to C++ library to be used during static constructors (invoked during dlopen) on Android, because at that phase native code cannot call back to JVM.</div><br/></div></div><div id="38344909" class="c"><input type="checkbox" id="c-38344909" checked=""/><div class="controls bullet"><span class="by">oefrha</span><span>|</span><a href="#38344083">parent</a><span>|</span><a href="#38345027">prev</a><span>|</span><a href="#38344298">next</a><span>|</span><label class="collapse" for="c-38344909">[-]</label><label class="expand" for="c-38344909">[1 more]</label></div><br/><div class="children"><div class="content">Have you ever exported anything in a shell script? Sure you can keep the necessary changes in local state and pass those to execve(2)&#x2F;execvpe(3), and that would be safe AFAIK, but setenv(3) is there and more convenient if you&#x27;re unaware of the hidden dangers. Also that doesn&#x27;t work for PATH in execvp&#x2F;execvpe, which is read from the current process; how do you change search paths for execvp without setenv?<p>Edit: I just realized macOS&#x2F;FreeBSD has execvP() that allows passing a custom search path, so PATH is now safe, but without a -e variant, everything else is again unsafe.</div><br/></div></div><div id="38344298" class="c"><input type="checkbox" id="c-38344298" checked=""/><div class="controls bullet"><span class="by">withinboredom</span><span>|</span><a href="#38344083">parent</a><span>|</span><a href="#38344909">prev</a><span>|</span><a href="#38344224">next</a><span>|</span><label class="collapse" for="c-38344298">[-]</label><label class="expand" for="c-38344298">[6 more]</label></div><br/><div class="children"><div class="content">Changing the env during runtime is actually quite handy for debugging and forcing the program into specific states.<p>Other than that, it can also be handy in k8s with a VPA. You get more&#x2F;less memory and then update the env to reflect that. Your service picks up the env change and updates the runtime.<p>IIRC, there is&#x2F;was some way to listen to those changes in C#, and automatically update runtime settings.</div><br/><div id="38344363" class="c"><input type="checkbox" id="c-38344363" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#38344083">root</a><span>|</span><a href="#38344298">parent</a><span>|</span><a href="#38344940">next</a><span>|</span><label class="collapse" for="c-38344363">[-]</label><label class="expand" for="c-38344363">[3 more]</label></div><br/><div class="children"><div class="content">&gt; Other than that, it can also be handy in k8s with a VPA. You get more&#x2F;less memory and then update the env to reflect that. Your service picks up the env change and updates the runtime.<p>You… can&#x27;t change the env from outside the process…<p>are you saying this is used by disjoint components within a single process?  Or is this just a misunderstanding?</div><br/><div id="38344515" class="c"><input type="checkbox" id="c-38344515" checked=""/><div class="controls bullet"><span class="by">withinboredom</span><span>|</span><a href="#38344083">root</a><span>|</span><a href="#38344363">parent</a><span>|</span><a href="#38344940">next</a><span>|</span><label class="collapse" for="c-38344515">[-]</label><label class="expand" for="c-38344515">[2 more]</label></div><br/><div class="children"><div class="content">You can spawn as many processes as you want in a container, did you not know that?<p>But you only need access to the &#x2F;proc&#x2F;pid directory to change another processes env.</div><br/><div id="38344558" class="c"><input type="checkbox" id="c-38344558" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#38344083">root</a><span>|</span><a href="#38344515">parent</a><span>|</span><a href="#38344940">next</a><span>|</span><label class="collapse" for="c-38344558">[-]</label><label class="expand" for="c-38344558">[1 more]</label></div><br/><div class="children"><div class="content">&gt; But you only need access to the &#x2F;proc&#x2F;pid directory to change another processes env.<p>&#x2F;proc&#x2F;$pid&#x2F;environ is not writable<p>(and as a matter of fact, due to how the environment works, it cannot be writable.)</div><br/></div></div></div></div></div></div><div id="38344940" class="c"><input type="checkbox" id="c-38344940" checked=""/><div class="controls bullet"><span class="by">riffraff</span><span>|</span><a href="#38344083">root</a><span>|</span><a href="#38344298">parent</a><span>|</span><a href="#38344363">prev</a><span>|</span><a href="#38344473">next</a><span>|</span><label class="collapse" for="c-38344940">[-]</label><label class="expand" for="c-38344940">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Changing the env during runtime is actually quite handy for debugging and forcing the program into specific states.<p>Wait, why would this need to happen at runtime? I have used env cars a lot to trigger specific cases but why would you want to do this while the process is running from within the process itself?<p>If you control the process you can start it with the right env to begin with, no?</div><br/></div></div><div id="38344473" class="c"><input type="checkbox" id="c-38344473" checked=""/><div class="controls bullet"><span class="by">rewmie</span><span>|</span><a href="#38344083">root</a><span>|</span><a href="#38344298">parent</a><span>|</span><a href="#38344940">prev</a><span>|</span><a href="#38344224">next</a><span>|</span><label class="collapse" for="c-38344473">[-]</label><label class="expand" for="c-38344473">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Changing the env during runtime is actually quite handy for debugging and forcing the program into specific states.<p>Most debuggers nowadays support altering variables at runtime after hitting breakpoints. In the meantime this was the very first time I ever heard anyone even considering changing env vars at runtime, let alone use it to debug stuff. Sounds like an ass-backwards way of going about debugging.</div><br/></div></div></div></div></div></div><div id="38344224" class="c"><input type="checkbox" id="c-38344224" checked=""/><div class="controls bullet"><span class="by">pitdicker</span><span>|</span><a href="#38344083">prev</a><span>|</span><a href="#38343877">next</a><span>|</span><label class="collapse" for="c-38344224">[-]</label><label class="expand" for="c-38344224">[1 more]</label></div><br/><div class="children"><div class="content">This also caused a lot of trouble for time libraries in Rust. The two foundational libraries, chrono and time, rely on localtime_r to get the local time instead of the clock value in UTC. localtime_r reads the TZ environment variable (and optionally others like TZ_DIR). Rust declares it safe to modify the environment, while POSIX declares it unsafe.<p>CVE-2020-26235, RUSTSEC-2020-0071 and RUSTSEC-2020-0159 where opened against the crates. That left the Rust ecosystem with a pretty much unsolvable issue for many months. Chrono went with the solution to parse the timezone database of the OS natively and read the environment using the Rust locks. Time tries to detect if the libc version has thread-safety guarantees to access the environment, and otherwise panics if there are multiple threads.<p>More reading: <a href="https:&#x2F;&#x2F;docs.rs&#x2F;chrono&#x2F;latest&#x2F;chrono&#x2F;#security-advisories" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.rs&#x2F;chrono&#x2F;latest&#x2F;chrono&#x2F;#security-advisories</a></div><br/></div></div><div id="38343877" class="c"><input type="checkbox" id="c-38343877" checked=""/><div class="controls bullet"><span class="by">DangerousDoctor</span><span>|</span><a href="#38344224">prev</a><span>|</span><a href="#38343925">next</a><span>|</span><label class="collapse" for="c-38343877">[-]</label><label class="expand" for="c-38343877">[9 more]</label></div><br/><div class="children"><div class="content">The essential problem is that there is no thread-safe way to implement this while maintaining backwards compatibility -- applications can alter the environment block by changing the environ global pointer, applications can also alter the environment block by replacing individual pointers in the environ array, applications can also alter the environment block by altering the strings pointed to by the individual members of the environ array, applications can also alter the environment block by using setenv&#x2F;putenv&#x2F;etc.<p>Inserting a mutex into the setenv&#x2F;getenv&#x2F;etc. functions is pointless because applications are explicitly allowed to modify the environ pointer and array directly without any locking.</div><br/><div id="38343991" class="c"><input type="checkbox" id="c-38343991" checked=""/><div class="controls bullet"><span class="by">jcelerier</span><span>|</span><a href="#38343877">parent</a><span>|</span><a href="#38344176">next</a><span>|</span><label class="collapse" for="c-38343991">[-]</label><label class="expand" for="c-38343991">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Inserting a mutex into the setenv&#x2F;getenv&#x2F;etc. functions is pointless because applications are explicitly allowed to modify the environ pointer and array directly without any locking.<p>by that logic mutex themselves are pointless because nothing ever forces you to use them, even in memory-safe languages you can still access &#x2F;dev&#x2F;mem and change bytes? It&#x27;s stil a useful thing to have.</div><br/><div id="38344205" class="c"><input type="checkbox" id="c-38344205" checked=""/><div class="controls bullet"><span class="by">PhilipRoman</span><span>|</span><a href="#38343877">root</a><span>|</span><a href="#38343991">parent</a><span>|</span><a href="#38344176">next</a><span>|</span><label class="collapse" for="c-38344205">[-]</label><label class="expand" for="c-38344205">[1 more]</label></div><br/><div class="children"><div class="content">The difference is that modifying the environ pointer is explicitly supported behaviour in the standard, poking through &#x2F;dev&#x2F;mem is not.<p>Although I guess a middle ground solution wouldn&#x27;t be too bad either - most programs don&#x27;t modify environ directly, so POSIX could offer thread safety for the functions and make multithreading through &quot;environ&quot; UB. This is already kind of explained in the standard:<p><a href="https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799.2018edition&#x2F;functions&#x2F;environ.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799.2018edition...</a></div><br/></div></div></div></div><div id="38344176" class="c"><input type="checkbox" id="c-38344176" checked=""/><div class="controls bullet"><span class="by">atoav</span><span>|</span><a href="#38343877">parent</a><span>|</span><a href="#38343991">prev</a><span>|</span><a href="#38343941">next</a><span>|</span><label class="collapse" for="c-38344176">[-]</label><label class="expand" for="c-38344176">[1 more]</label></div><br/><div class="children"><div class="content">Another problem is that it is hard to reason about security in a C program if all environment variables could change at all times.<p>If we are talking about the C application deciding when it wants to rescan the environment that is something different, but if your environment can change potentially before and after you check it this opens you up for a heap of new attacks.</div><br/></div></div><div id="38343941" class="c"><input type="checkbox" id="c-38343941" checked=""/><div class="controls bullet"><span class="by">forrestthewoods</span><span>|</span><a href="#38343877">parent</a><span>|</span><a href="#38344176">prev</a><span>|</span><a href="#38343925">next</a><span>|</span><label class="collapse" for="c-38343941">[-]</label><label class="expand" for="c-38343941">[5 more]</label></div><br/><div class="children"><div class="content">Yup. It&#x27;s a bad, broken, and unfixable API.<p>The world really needs a new C standard library that doesn&#x27;t suck.</div><br/><div id="38344613" class="c"><input type="checkbox" id="c-38344613" checked=""/><div class="controls bullet"><span class="by">rewmie</span><span>|</span><a href="#38343877">root</a><span>|</span><a href="#38343941">parent</a><span>|</span><a href="#38344089">next</a><span>|</span><label class="collapse" for="c-38344613">[-]</label><label class="expand" for="c-38344613">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Yup. It&#x27;s a bad, broken, and unfixable API.<p>Is it, though?<p>The only argument I see is that an API can be misused. There are ergonomics debates we can have about it, but a user intentionally abusing an API wanting to do something that&#x27;s completely wrong is hardly indication the API is broken.</div><br/><div id="38344837" class="c"><input type="checkbox" id="c-38344837" checked=""/><div class="controls bullet"><span class="by">forrestthewoods</span><span>|</span><a href="#38343877">root</a><span>|</span><a href="#38344613">parent</a><span>|</span><a href="#38344089">next</a><span>|</span><label class="collapse" for="c-38344837">[-]</label><label class="expand" for="c-38344837">[1 more]</label></div><br/><div class="children"><div class="content">Exposing global mutable access to something and providing no thread safe version counts as broken in my book. Your book may differ.<p>A good API would probably only allow constant access. If mutation is for some reason deemed necessary then it should be through a separate set API and the return results of get should be guaranteed safe.</div><br/></div></div></div></div><div id="38344089" class="c"><input type="checkbox" id="c-38344089" checked=""/><div class="controls bullet"><span class="by">eviks</span><span>|</span><a href="#38343877">root</a><span>|</span><a href="#38343941">parent</a><span>|</span><a href="#38344613">prev</a><span>|</span><a href="#38343925">next</a><span>|</span><label class="collapse" for="c-38344089">[-]</label><label class="expand" for="c-38344089">[2 more]</label></div><br/><div class="children"><div class="content">Or transition to post-C</div><br/><div id="38344240" class="c"><input type="checkbox" id="c-38344240" checked=""/><div class="controls bullet"><span class="by">xxs</span><span>|</span><a href="#38343877">root</a><span>|</span><a href="#38344089">parent</a><span>|</span><a href="#38343925">next</a><span>|</span><label class="collapse" for="c-38344240">[-]</label><label class="expand" for="c-38344240">[1 more]</label></div><br/><div class="children"><div class="content">Java has System.getenv()... and it&#x27;s an unmodifiable Map&lt;String, String&gt;. The real culprit it&#x27;s the attempt to modify it, not C.</div><br/></div></div></div></div></div></div></div></div><div id="38343925" class="c"><input type="checkbox" id="c-38343925" checked=""/><div class="controls bullet"><span class="by">xxs</span><span>|</span><a href="#38343877">prev</a><span>|</span><a href="#38345003">next</a><span>|</span><label class="collapse" for="c-38343925">[-]</label><label class="expand" for="c-38343925">[1 more]</label></div><br/><div class="children"><div class="content">The described problem (thread safety) for a global configuration seems mostly a misunderstanding by the author.<p>The usual case for modifying a global state is: modify once, then proceed (e.g. start new threads). Even if all the calls become thread safe, the behavior would be inconsistent, still.</div><br/></div></div><div id="38345003" class="c"><input type="checkbox" id="c-38345003" checked=""/><div class="controls bullet"><span class="by">usrbinbash</span><span>|</span><a href="#38343925">prev</a><span>|</span><a href="#38344903">next</a><span>|</span><label class="collapse" for="c-38345003">[-]</label><label class="expand" for="c-38345003">[1 more]</label></div><br/><div class="children"><div class="content">&gt; C Doesn&#x27;t Want to Fix It<p>Or: C knows that <i>it doesn&#x27;t need fixing.</i><p>How often do I need to `setenv()` anything? The answer is &quot;Never&quot; in the vast majority of programs, because ENVVRS are usually read rather than set. For the vast majority of the small amount of programs that actually need to use `setenv()`, the answer is: &quot;Maybe once or twice during the entire lifetime of the process&quot;.<p>&gt; It has wasted thousands of hours of people&#x27;s time, either debugging the problems, or debating what to do about it.<p>Source?</div><br/></div></div><div id="38344903" class="c"><input type="checkbox" id="c-38344903" checked=""/><div class="controls bullet"><span class="by">yason</span><span>|</span><a href="#38345003">prev</a><span>|</span><a href="#38342883">next</a><span>|</span><label class="collapse" for="c-38344903">[-]</label><label class="expand" for="c-38344903">[1 more]</label></div><br/><div class="children"><div class="content">Come on! Of all C&#x2F;Posix thread-safety issues in circulation this can plausibly be considered the most moot one.<p>Environment variables are not meant to be an inter-thread communication channel and the documentation that points out setenv() is not thread-safe is very much a fair shot.<p>You rarely, if ever, need to setenv() anything maybe unless you&#x27;re a shell. For spawning children execve() already takes an envp parameter. For debugging I think I&#x27;ve mostly set in-process environment variables manually from gdb.<p>Further, because environment variables are an interface between the process and its environment you typically read environment variables at start and cache the parsed values in some internal location. If you need to change that global state on the go you should do it using your own internal variables instead of recycling it through the environment and having the program threads repeatedly getenv() the updated values.</div><br/></div></div><div id="38342883" class="c"><input type="checkbox" id="c-38342883" checked=""/><div class="controls bullet"><span class="by">turtleyacht</span><span>|</span><a href="#38344903">prev</a><span>|</span><a href="#38344793">next</a><span>|</span><label class="collapse" for="c-38342883">[-]</label><label class="expand" for="c-38342883">[2 more]</label></div><br/><div class="children"><div class="content"><i>Should</i> apps orchestrate a super-global lock of a foreign namespace?<p>An environment variable&#x27;s value, for a running process, is just what it is: an initial value from outside.<p>Adding complexity around it smells like an attempt to control a distributed mutex, like checking an API for real-time value changes in a while loop across several instances of the same app.<p>I thought there would be alternatives to this, like pubsub, Kafka, or other asynchronous event handling.<p>Imagine having to test an app for its ability to handle safe read-write of OS-level state. It&#x27;s definitionally bankrupt: not really a unit, not easy to set up quickly, and not isolated.</div><br/><div id="38343987" class="c"><input type="checkbox" id="c-38343987" checked=""/><div class="controls bullet"><span class="by">xxs</span><span>|</span><a href="#38342883">parent</a><span>|</span><a href="#38344793">next</a><span>|</span><label class="collapse" for="c-38343987">[-]</label><label class="expand" for="c-38343987">[1 more]</label></div><br/><div class="children"><div class="content">&gt;Imagine having to test an app for its ability to handle safe read-write of OS-level state. I<p>Also it should be able to handle invariants as modifying multiple variables is not an atomic process, either.</div><br/></div></div></div></div><div id="38344793" class="c"><input type="checkbox" id="c-38344793" checked=""/><div class="controls bullet"><span class="by">Someone</span><span>|</span><a href="#38342883">prev</a><span>|</span><a href="#38343884">next</a><span>|</span><label class="collapse" for="c-38344793">[-]</label><label class="expand" for="c-38344793">[1 more]</label></div><br/><div class="children"><div class="content">I may misunderstand what “Extension to the ISO C standard” can mean, but <i>getenv</i> isn’t thread-safe, either.<p><a href="https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;9699919799&#x2F;</a>:<p><i>“The getenv() function need not be thread-safe”</i><p>I expect most if not all implementations are more robust.</div><br/></div></div><div id="38343884" class="c"><input type="checkbox" id="c-38343884" checked=""/><div class="controls bullet"><span class="by">krackers</span><span>|</span><a href="#38344793">prev</a><span>|</span><a href="#38344283">next</a><span>|</span><label class="collapse" for="c-38343884">[-]</label><label class="expand" for="c-38343884">[1 more]</label></div><br/><div class="children"><div class="content">Cool, ever since that rachelbythebay article [1] I was wondering how different libcs handle the issue! Nice to see that someone else confirming the behavior of apple&#x27;c libc. It&#x27;s not mentioned in the article, but while apple&#x27;s libc seems to suffer from the use-after-free issue, if I&#x27;m reading it right it does seem to have locking for setenv&#x2F;getenv [3]<p>[1] <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=37908655">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=37908655</a>
[2] <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=37952916">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=37952916</a>
[3] <a href="https:&#x2F;&#x2F;github.com&#x2F;apple-open-source-mirror&#x2F;Libc&#x2F;blob&#x2F;master&#x2F;stdlib&#x2F;FreeBSD&#x2F;getenv.c">https:&#x2F;&#x2F;github.com&#x2F;apple-open-source-mirror&#x2F;Libc&#x2F;blob&#x2F;master...</a></div><br/></div></div><div id="38344283" class="c"><input type="checkbox" id="c-38344283" checked=""/><div class="controls bullet"><span class="by">vintermann</span><span>|</span><a href="#38343884">prev</a><span>|</span><a href="#38344030">next</a><span>|</span><label class="collapse" for="c-38344283">[-]</label><label class="expand" for="c-38344283">[2 more]</label></div><br/><div class="children"><div class="content">Using environment variables for global mutable state isn&#x27;t exactly good practice, is it?<p>I can&#x27;t think of any time I had wanted to do that.<p>What exactly are the programs that break if this changes?</div><br/><div id="38344418" class="c"><input type="checkbox" id="c-38344418" checked=""/><div class="controls bullet"><span class="by">okr</span><span>|</span><a href="#38344283">parent</a><span>|</span><a href="#38344030">next</a><span>|</span><label class="collapse" for="c-38344418">[-]</label><label class="expand" for="c-38344418">[1 more]</label></div><br/><div class="children"><div class="content">I can think of using libraries, that get their config through environment variables. So you start your program, modify environment, and then start up the rest.</div><br/></div></div></div></div><div id="38344030" class="c"><input type="checkbox" id="c-38344030" checked=""/><div class="controls bullet"><span class="by">rpcope1</span><span>|</span><a href="#38344283">prev</a><span>|</span><a href="#38343817">next</a><span>|</span><label class="collapse" for="c-38344030">[-]</label><label class="expand" for="c-38344030">[1 more]</label></div><br/><div class="children"><div class="content">I wonder if you could work around this by using LD_PRELOAD to load in a shim around get_env and set_env. You&#x27;d still have the problem of environ potentially getting mutated, but it very well may solve the problem if it&#x27;s limited to those two functions.</div><br/></div></div><div id="38343817" class="c"><input type="checkbox" id="c-38343817" checked=""/><div class="controls bullet"><span class="by">grandinj</span><span>|</span><a href="#38344030">prev</a><span>|</span><a href="#38343803">next</a><span>|</span><label class="collapse" for="c-38343817">[-]</label><label class="expand" for="c-38343817">[4 more]</label></div><br/><div class="children"><div class="content">The right thing to do is to create a new thread safe api and implement that and then standardize it. Hard but very unsexy work.</div><br/><div id="38343930" class="c"><input type="checkbox" id="c-38343930" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#38343817">parent</a><span>|</span><a href="#38343929">next</a><span>|</span><label class="collapse" for="c-38343930">[-]</label><label class="expand" for="c-38343930">[2 more]</label></div><br/><div class="children"><div class="content">The person who fixed this would be incredibly sexy in my book. Though, that probably tells you more about my own sexiness than it invalidates your comment.</div><br/><div id="38343965" class="c"><input type="checkbox" id="c-38343965" checked=""/><div class="controls bullet"><span class="by">xxs</span><span>|</span><a href="#38343817">root</a><span>|</span><a href="#38343930">parent</a><span>|</span><a href="#38343929">next</a><span>|</span><label class="collapse" for="c-38343965">[-]</label><label class="expand" for="c-38343965">[1 more]</label></div><br/><div class="children"><div class="content">The sexy part is more like having an extremely brushed&#x2F;retouched image in a magazine - it&#x27;s not real.</div><br/></div></div></div></div><div id="38343929" class="c"><input type="checkbox" id="c-38343929" checked=""/><div class="controls bullet"><span class="by">xxs</span><span>|</span><a href="#38343817">parent</a><span>|</span><a href="#38343930">prev</a><span>|</span><a href="#38343803">next</a><span>|</span><label class="collapse" for="c-38343929">[-]</label><label class="expand" for="c-38343929">[1 more]</label></div><br/><div class="children"><div class="content">The right thing is not to modify a global state once you have started all the threads. If you need to do that, use your own data structures. The case of getaddrinfo - would need a copy of the entire env. in a thread safe manner, then return the result. That would pretty much apply to anything that uses env</div><br/></div></div></div></div><div id="38343803" class="c"><input type="checkbox" id="c-38343803" checked=""/><div class="controls bullet"><span class="by">pjmlp</span><span>|</span><a href="#38343817">prev</a><span>|</span><a href="#38343798">next</a><span>|</span><label class="collapse" for="c-38343803">[-]</label><label class="expand" for="c-38343803">[2 more]</label></div><br/><div class="children"><div class="content">WG14 also doesn&#x27;t want to provide safer string and array manipulation libraries for decades, even Dennis Ritchie failed to get fat pointers into ISO C, why should fixing this be any different?</div><br/><div id="38344497" class="c"><input type="checkbox" id="c-38344497" checked=""/><div class="controls bullet"><span class="by">raverbashing</span><span>|</span><a href="#38343803">parent</a><span>|</span><a href="#38343798">next</a><span>|</span><label class="collapse" for="c-38344497">[-]</label><label class="expand" for="c-38344497">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, at this point the languages and OSs should (IMHO) be distancing them from the multiple craziness of the committee</div><br/></div></div></div></div><div id="38343798" class="c"><input type="checkbox" id="c-38343798" checked=""/><div class="controls bullet"><span class="by">Khelavaster</span><span>|</span><a href="#38343803">prev</a><span>|</span><label class="collapse" for="c-38343798">[-]</label><label class="expand" for="c-38343798">[2 more]</label></div><br/><div class="children"><div class="content">Slap a mutex on that beast!<p>This is expected behavior for setting a GLOBAL variable without a lock on the memoryspace..</div><br/><div id="38343843" class="c"><input type="checkbox" id="c-38343843" checked=""/><div class="controls bullet"><span class="by">krackers</span><span>|</span><a href="#38343798">parent</a><span>|</span><label class="collapse" for="c-38343843">[-]</label><label class="expand" for="c-38343843">[1 more]</label></div><br/><div class="children"><div class="content">You can&#x27;t guarantee that whatever libraries you pull in use the same mutex as you though.</div><br/></div></div></div></div></div></div></div></div></div></body></html>