<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1684400451676" as="style"/><link rel="stylesheet" href="styles.css?v=1684400451676"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/AdmTal/PostgreSQL-Query-Lock-Explainer">Show HN: Postgres query lock explainer</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>admtal</span> | <span>14 comments</span></div><br/><div><div id="35982701" class="c"><input type="checkbox" id="c-35982701" checked=""/><div class="controls bullet"><span class="by">fovc</span><span>|</span><a href="#35982670">next</a><span>|</span><label class="collapse" for="c-35982701">[-]</label><label class="expand" for="c-35982701">[4 more]</label></div><br/><div class="children"><div class="content">It would be nice if you added a how it works section to the readme. Knowing that it does `begin; ${query}; rollback;` under the hood is important. The example with truncate in fact made me think the opposite was true, since truncate violates MVCC and cannot be rolled back.<p>I’m often worrying about locks in migrations that could be long running, so executing the query to figure out the locks defeats the purpose. Or at least I need to know to use a test DB.</div><br/><div id="35985390" class="c"><input type="checkbox" id="c-35985390" checked=""/><div class="controls bullet"><span class="by">mad0</span><span>|</span><a href="#35982701">parent</a><span>|</span><a href="#35984344">next</a><span>|</span><label class="collapse" for="c-35985390">[-]</label><label class="expand" for="c-35985390">[1 more]</label></div><br/><div class="children"><div class="content">Maybe emitting a warning would be good. I&#x27;m no DBA so remembering all operations that cannot be rolledback might be tough. (Though maybe I should know all of them if they aren&#x27;t rollbackable :P )</div><br/></div></div><div id="35984344" class="c"><input type="checkbox" id="c-35984344" checked=""/><div class="controls bullet"><span class="by">LunaSea</span><span>|</span><a href="#35982701">parent</a><span>|</span><a href="#35985390">prev</a><span>|</span><a href="#35983678">next</a><span>|</span><label class="collapse" for="c-35984344">[-]</label><label class="expand" for="c-35984344">[1 more]</label></div><br/><div class="children"><div class="content">As far as I know, truncate can be rolled back but it is also visible, even before the transaction is commited, to other transactions that started before:<p><a href="https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;sql-truncate.html" rel="nofollow">https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;sql-truncate.html</a></div><br/></div></div><div id="35983678" class="c"><input type="checkbox" id="c-35983678" checked=""/><div class="controls bullet"><span class="by">admtal</span><span>|</span><a href="#35982701">parent</a><span>|</span><a href="#35984344">prev</a><span>|</span><a href="#35982670">next</a><span>|</span><label class="collapse" for="c-35983678">[-]</label><label class="expand" for="c-35983678">[1 more]</label></div><br/><div class="children"><div class="content">Great suggestion, thank you!<p>Done - <a href="https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;commit&#x2F;da1c5fcfe7b1d5f8755c0203ad66ea0e3828c00f">https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;co...</a></div><br/></div></div></div></div><div id="35982670" class="c"><input type="checkbox" id="c-35982670" checked=""/><div class="controls bullet"><span class="by">efxhoy</span><span>|</span><a href="#35982701">prev</a><span>|</span><a href="#35983084">next</a><span>|</span><label class="collapse" for="c-35982670">[-]</label><label class="expand" for="c-35982670">[3 more]</label></div><br/><div class="children"><div class="content">Neat tool!<p>I prefer using environment variables for my connection info to avoid passwords in my shell history or plaintext config files. The standard[1] ones from libpq work in psycopg2 if you pass an empty connection string. Then you can keep them in the environment variables or do<p><pre><code>    PGHOST=db.company.com PGUSER=postgres PGPORT=5432 PGDATABASE=postgres pg_explain_locks --query &quot;SELECT id FROM table&quot;
</code></pre>
[1] <a href="https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;libpq-envars.html" rel="nofollow">https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;libpq-envars.html</a></div><br/><div id="35983839" class="c"><input type="checkbox" id="c-35983839" checked=""/><div class="controls bullet"><span class="by">thwarted</span><span>|</span><a href="#35982670">parent</a><span>|</span><a href="#35983084">next</a><span>|</span><label class="collapse" for="c-35983839">[-]</label><label class="expand" for="c-35983839">[2 more]</label></div><br/><div class="children"><div class="content">Even with that command line, shell history needs to be  disabled, or the shell needs to be configured to filter when it saves history (for example, the bash ignorespace HISTCONTROL option is useful here).  This is, of course, shell specific.</div><br/><div id="35984224" class="c"><input type="checkbox" id="c-35984224" checked=""/><div class="controls bullet"><span class="by">0xbadcafebee</span><span>|</span><a href="#35982670">root</a><span>|</span><a href="#35983839">parent</a><span>|</span><a href="#35983084">next</a><span>|</span><label class="collapse" for="c-35984224">[-]</label><label class="expand" for="c-35984224">[1 more]</label></div><br/><div class="children"><div class="content">Actually they didn&#x27;t pass a password so there&#x27;s nothing secret in the shell history that needs hiding. You can also set the password as an environment variable in a file and load it at runtime. The benefit there is that if you use a shell script to load your settings before running your application, you have a universal method of setting and passing variables, because the script can call any program to retrieve the password in any way, and then pass the value via environment variable. Bonus that any application-deploying tools can now override the value too.<p>Security concerns around env vars being visible in process lists are mostly red herrings. If you can list the processes you&#x27;ve already got a memory leak, RCE, etc. Even if you can get the password it should be impossible to connect to the database from anywhere other than the application anyway. If you can read memory and connect to a database from where an application is running, you&#x27;ve got bigger problems.</div><br/></div></div></div></div></div></div><div id="35983084" class="c"><input type="checkbox" id="c-35983084" checked=""/><div class="controls bullet"><span class="by">hn92726819</span><span>|</span><a href="#35982670">prev</a><span>|</span><a href="#35983392">next</a><span>|</span><label class="collapse" for="c-35983084">[-]</label><label class="expand" for="c-35983084">[3 more]</label></div><br/><div class="children"><div class="content">Not a postgres expert, but it looks like this is checked by <i>executing</i> the query: <a href="https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;blob&#x2F;master&#x2F;pg_explain_locks.py#L60">https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;bl...</a><p>Doesn&#x27;t this mean that checking the locks in a query like:<p><pre><code>    Delete from t;commit
</code></pre>
Would kill everything? Or any query that can&#x27;t be transactional.</div><br/><div id="35983197" class="c"><input type="checkbox" id="c-35983197" checked=""/><div class="controls bullet"><span class="by">admtal</span><span>|</span><a href="#35983084">parent</a><span>|</span><a href="#35983392">next</a><span>|</span><label class="collapse" for="c-35983197">[-]</label><label class="expand" for="c-35983197">[2 more]</label></div><br/><div class="children"><div class="content">The command won&#x27;t work if you include &quot;commit&quot; in the input :)</div><br/><div id="35985231" class="c"><input type="checkbox" id="c-35985231" checked=""/><div class="controls bullet"><span class="by">runeks</span><span>|</span><a href="#35983084">root</a><span>|</span><a href="#35983197">parent</a><span>|</span><a href="#35983392">next</a><span>|</span><label class="collapse" for="c-35985231">[-]</label><label class="expand" for="c-35985231">[1 more]</label></div><br/><div class="children"><div class="content">Link to relevant source code: <a href="https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;blob&#x2F;da1c5fcfe7b1d5f8755c0203ad66ea0e3828c00f&#x2F;pg_explain_locks.py#L148-L153">https:&#x2F;&#x2F;github.com&#x2F;AdmTal&#x2F;PostgreSQL-Query-Lock-Explainer&#x2F;bl...</a></div><br/></div></div></div></div></div></div><div id="35983392" class="c"><input type="checkbox" id="c-35983392" checked=""/><div class="controls bullet"><span class="by">irrational</span><span>|</span><a href="#35983084">prev</a><span>|</span><a href="#35982215">next</a><span>|</span><label class="collapse" for="c-35983392">[-]</label><label class="expand" for="c-35983392">[1 more]</label></div><br/><div class="children"><div class="content">If the query causes a trigger to fire, will any additional locks that are created by the trigger(s) (that is, any functions called by the triggers) be noted?</div><br/></div></div><div id="35982215" class="c"><input type="checkbox" id="c-35982215" checked=""/><div class="controls bullet"><span class="by">miohtama</span><span>|</span><a href="#35983392">prev</a><span>|</span><label class="collapse" for="c-35982215">[-]</label><label class="expand" for="c-35982215">[2 more]</label></div><br/><div class="children"><div class="content">Related to this: would anyone know how to figure out which 1) applications and 2) queries where holidng locks after a dead lock happened, post mortem? As the default PSQL deadlock log output is very sparse to the point being useless.</div><br/><div id="35982785" class="c"><input type="checkbox" id="c-35982785" checked=""/><div class="controls bullet"><span class="by">dboreham</span><span>|</span><a href="#35982215">parent</a><span>|</span><label class="collapse" for="c-35982785">[-]</label><label class="expand" for="c-35982785">[1 more]</label></div><br/><div class="children"><div class="content">The deadlocking pids will be logged and then if you have&#x2F;had query logging turned on you can see what the pids were executing prior to that. Tracing back to the application involves using the available logged information: client IP, client name (possibly just the default from the pq driver, so the same everywhere), content of the actual query.</div><br/></div></div></div></div></div></div></div></div></div></body></html>