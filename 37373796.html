<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1693818074588" as="style"/><link rel="stylesheet" href="styles.css?v=1693818074588"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://nomad.foo/blog/cola">Cola: A text CRDT for real-time collaborative editing</a> <span class="domain">(<a href="https://nomad.foo">nomad.foo</a>)</span></div><div class="subtext"><span>homarp</span> | <span>36 comments</span></div><br/><div><div id="37378509" class="c"><input type="checkbox" id="c-37378509" checked=""/><div class="controls bullet"><span class="by">czx111331</span><span>|</span><a href="#37374730">next</a><span>|</span><label class="collapse" for="c-37378509">[-]</label><label class="expand" for="c-37378509">[1 more]</label></div><br/><div class="children"><div class="content">Nice work! However, it doesn&#x27;t seem like a fair benchmark. It doesn&#x27;t calculate and store the ops, nor does it store the actual text. To build a text CRDT with delta updates support upon it, users must store OpID =&gt; Text in an extra structure, which isn&#x27;t cheap.</div><br/></div></div><div id="37374730" class="c"><input type="checkbox" id="c-37374730" checked=""/><div class="controls bullet"><span class="by">danbruc</span><span>|</span><a href="#37378509">prev</a><span>|</span><a href="#37375104">next</a><span>|</span><label class="collapse" for="c-37374730">[-]</label><label class="expand" for="c-37374730">[3 more]</label></div><br/><div class="children"><div class="content">I would guess a G-tree is still a B-tree with additional parent pointers, the fact that it is stored in an array is a matter of representation but does not fundamentally change the structure. This still stores pointers, they are just in units of the node size instead of bytes and relative to the first array element instead of the beginning of the address space. A complete binary tree stored in a array without any explicit references, i.e. an implicit representation with the children of the node at index x stored at indices 2x + 1 and 2x + 2, is still referred to as a binary tree, just with an implicit representation.</div><br/><div id="37377867" class="c"><input type="checkbox" id="c-37377867" checked=""/><div class="controls bullet"><span class="by">dgb23</span><span>|</span><a href="#37374730">parent</a><span>|</span><a href="#37375104">next</a><span>|</span><label class="collapse" for="c-37377867">[-]</label><label class="expand" for="c-37377867">[2 more]</label></div><br/><div class="children"><div class="content">It’s useful to talk about representation though. Especially in a language that nudges you away from absolute references towards relative, self managed ones.<p>A quite clever representation of a tree that I read about is to store nodes in DFS order in a flat array. Given that it’s read only and the readers want to traverse it depth first anyway, this can be quite efficient. S-expressions and HTML come to mind.</div><br/><div id="37378041" class="c"><input type="checkbox" id="c-37378041" checked=""/><div class="controls bullet"><span class="by">danbruc</span><span>|</span><a href="#37374730">root</a><span>|</span><a href="#37377867">parent</a><span>|</span><a href="#37375104">next</a><span>|</span><label class="collapse" for="c-37378041">[-]</label><label class="expand" for="c-37378041">[1 more]</label></div><br/><div class="children"><div class="content">My point was not that it might not be important, just that you probably do not want to assign a new name to a data structure just because you use a different representation. If the implementation would have been in a different language, then adding parent pointers into the B-tree would have been less of a concern and the representation with an array would maybe never have come up. It would be weird to say that this CRDT is based on a B-Tree with parent pointers, unless you implement it in Rust, then it is based on a G-tree.</div><br/></div></div></div></div></div></div><div id="37375104" class="c"><input type="checkbox" id="c-37375104" checked=""/><div class="controls bullet"><span class="by">jitl</span><span>|</span><a href="#37374730">prev</a><span>|</span><a href="#37377969">next</a><span>|</span><label class="collapse" for="c-37375104">[-]</label><label class="expand" for="c-37375104">[4 more]</label></div><br/><div class="children"><div class="content">This doesn’t appear to support rich text formatting ranges like bold, italic, etc - unless I’m missing something in the API. AFAIK Peritext is still the state of the art in rich text CRDT algorithms <a href="https:&#x2F;&#x2F;www.inkandswitch.com&#x2F;peritext&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.inkandswitch.com&#x2F;peritext&#x2F;</a><p>I’d love to see this build the rich text stuff from the Peritext algorithm.</div><br/><div id="37378503" class="c"><input type="checkbox" id="c-37378503" checked=""/><div class="controls bullet"><span class="by">filleokus</span><span>|</span><a href="#37375104">parent</a><span>|</span><a href="#37376688">next</a><span>|</span><label class="collapse" for="c-37378503">[-]</label><label class="expand" for="c-37378503">[1 more]</label></div><br/><div class="children"><div class="content">As a somewhat interested observer of the CRDT space, I always wondered if it would be possible to create a more general purpose &quot;structured data&quot; CRDT. I.e that the user define a model&#x2F;schema to describe semantically valid states. If you just merge e.g JSON you might end up in a state that&#x27;s syntactically valid, but doesn&#x27;t make any sense.<p>Similar how the Pretext algorithm know that bold&#x2F;italic&#x2F;underlining operations are additive while highlighting colouring is not, I&#x27;m thinking the user could control the schema to declare that &quot;state: notStarted&quot; and &quot;completionDate: 2023-09-04&quot; is incompatible</div><br/></div></div></div></div><div id="37377969" class="c"><input type="checkbox" id="c-37377969" checked=""/><div class="controls bullet"><span class="by">gyulai</span><span>|</span><a href="#37375104">prev</a><span>|</span><a href="#37374141">next</a><span>|</span><label class="collapse" for="c-37377969">[-]</label><label class="expand" for="c-37377969">[3 more]</label></div><br/><div class="children"><div class="content">Just a nitpick &#x2F; editorial suggestion:  The acronym &quot;CRDT&quot; is not extremely common, and never defined in the document.  Such things trigger my obsessive personality streak hard and maybe others&#x27; too.  Thankfully, Wikipedia gave me the answer, assuming this is about conflict-free replicated data types.</div><br/><div id="37378067" class="c"><input type="checkbox" id="c-37378067" checked=""/><div class="controls bullet"><span class="by">creshal</span><span>|</span><a href="#37377969">parent</a><span>|</span><a href="#37374141">next</a><span>|</span><label class="collapse" for="c-37378067">[-]</label><label class="expand" for="c-37378067">[2 more]</label></div><br/><div class="children"><div class="content">&gt;  and never defined in the document.<p>From the document&#x27;s first part:<p>&gt; A Conflict-free Replicated Data Type, or CRDT, is an umbrella term for any data structure that can be replicated and modified concurrently across multiple sites, and is guaranteed to converge without the need for a central authority to coordinate the changes.</div><br/><div id="37378114" class="c"><input type="checkbox" id="c-37378114" checked=""/><div class="controls bullet"><span class="by">gyulai</span><span>|</span><a href="#37377969">root</a><span>|</span><a href="#37378067">parent</a><span>|</span><a href="#37374141">next</a><span>|</span><label class="collapse" for="c-37378114">[-]</label><label class="expand" for="c-37378114">[1 more]</label></div><br/><div class="children"><div class="content">Sorry about that.  I saw the title, didn&#x27;t know what CRDT meant, and clicked through to the document specifically to find out, not particularly wanting to read the article.  I was then scan-reading and missed it.  I must say in my defense, though, that the convention is to define an acronym when it&#x27;s first used, excluding the title, and the definition is only at the fourth use excluding the title and first section heading.</div><br/></div></div></div></div></div></div><div id="37374141" class="c"><input type="checkbox" id="c-37374141" checked=""/><div class="controls bullet"><span class="by">matlin</span><span>|</span><a href="#37377969">prev</a><span>|</span><a href="#37378497">next</a><span>|</span><label class="collapse" for="c-37374141">[-]</label><label class="expand" for="c-37374141">[2 more]</label></div><br/><div class="children"><div class="content">Any comparisons to Automerge or Y.js&#x2F;Yrs regarding performance or features?</div><br/><div id="37374221" class="c"><input type="checkbox" id="c-37374221" checked=""/><div class="controls bullet"><span class="by">jayunit</span><span>|</span><a href="#37374141">parent</a><span>|</span><a href="#37378497">next</a><span>|</span><label class="collapse" for="c-37374221">[-]</label><label class="expand" for="c-37374221">[1 more]</label></div><br/><div class="children"><div class="content">The “third part” of the post starts with “I’ve benchmarked cola against 3 other CRDTs implemented in Rust: diamond-types, automerge and yrs.” This cola library appears to perform favorably in operation speed.<p>I’d be curious to know about memory usage, too.</div><br/></div></div></div></div><div id="37377516" class="c"><input type="checkbox" id="c-37377516" checked=""/><div class="controls bullet"><span class="by">sureglymop</span><span>|</span><a href="#37378497">prev</a><span>|</span><a href="#37377565">next</a><span>|</span><label class="collapse" for="c-37377516">[-]</label><label class="expand" for="c-37377516">[2 more]</label></div><br/><div class="children"><div class="content">Does anyone know if there is an easy way to enable collaborative editing of a form in the browser?
Say two people open the same page&#x2F;form. Now they should be able to see which form field the other person is currently editing and for text form fields a text CRDT should be used.
I tried to implement something like this with Yjs but unfortunately it was quite hard and didn&#x27;t work well.</div><br/><div id="37377749" class="c"><input type="checkbox" id="c-37377749" checked=""/><div class="controls bullet"><span class="by">jakelazaroff</span><span>|</span><a href="#37377516">parent</a><span>|</span><a href="#37377565">next</a><span>|</span><label class="collapse" for="c-37377749">[-]</label><label class="expand" for="c-37377749">[1 more]</label></div><br/><div class="children"><div class="content">Why didn’t Yjs work? It seems like it would be perfect for that.</div><br/></div></div></div></div><div id="37377565" class="c"><input type="checkbox" id="c-37377565" checked=""/><div class="controls bullet"><span class="by">orlp</span><span>|</span><a href="#37377516">prev</a><span>|</span><a href="#37374800">next</a><span>|</span><label class="collapse" for="c-37377565">[-]</label><label class="expand" for="c-37377565">[3 more]</label></div><br/><div class="children"><div class="content">&gt; The solution is surprisingly simple: we can store every node in a dynamic array, (a Vec in Rust) and use indices into this vector to refer to other nodes. This solves the ownership problem because the vector now owns all the nodes. And by simply storing the index of the parent in every node we can navigate the tree in both directions without having to use any unsafe code.<p>&gt; This all hinges on the assumption that once we’ve inserted a node into the vector its index never changes. Inserting new nodes doesn’t cause any issues: we just append them to the end. Removing a node however would be doubly bad: not only is it a linear operation (because we’re now using a vector instead of a tree), but it would also invalidate all the indices of the nodes that come after it.<p>If you use my crate slotmap (<a href="https:&#x2F;&#x2F;docs.rs&#x2F;slotmap&#x2F;latest&#x2F;slotmap&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.rs&#x2F;slotmap&#x2F;latest&#x2F;slotmap&#x2F;</a>) you can support deletions without worrying about indices shifting or &#x27;indices&#x27; (slotmap calls them keys) ever pointing at different values, as the keys in slotmap also come with a version number.</div><br/><div id="37378109" class="c"><input type="checkbox" id="c-37378109" checked=""/><div class="controls bullet"><span class="by">Kinrany</span><span>|</span><a href="#37377565">parent</a><span>|</span><a href="#37377820">next</a><span>|</span><label class="collapse" for="c-37378109">[-]</label><label class="expand" for="c-37378109">[1 more]</label></div><br/><div class="children"><div class="content">Would it work in a CRDT context, where ordering is hard and so versions could only be local?</div><br/></div></div></div></div><div id="37374800" class="c"><input type="checkbox" id="c-37374800" checked=""/><div class="controls bullet"><span class="by">gjvc</span><span>|</span><a href="#37377565">prev</a><span>|</span><a href="#37378093">next</a><span>|</span><label class="collapse" for="c-37374800">[-]</label><label class="expand" for="c-37374800">[5 more]</label></div><br/><div class="children"><div class="content">not to be confused with Ian Piumarta&#x27;s work of the same name:<p><a href="https:&#x2F;&#x2F;www.piumarta.com&#x2F;software&#x2F;cola&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.piumarta.com&#x2F;software&#x2F;cola&#x2F;</a><p><a href="https:&#x2F;&#x2F;citeseerx.ist.psu.edu&#x2F;viewdoc&#x2F;download;jsessionid=9149D20D0473AF4774EFD4EE622ADB8F?doi=10.1.1.657.3052&amp;rep=rep1&amp;type=pdf" rel="nofollow noreferrer">https:&#x2F;&#x2F;citeseerx.ist.psu.edu&#x2F;viewdoc&#x2F;download;jsessionid=91...</a></div><br/><div id="37376648" class="c"><input type="checkbox" id="c-37376648" checked=""/><div class="controls bullet"><span class="by">zX41ZdbW</span><span>|</span><a href="#37374800">parent</a><span>|</span><a href="#37376196">next</a><span>|</span><label class="collapse" for="c-37376648">[-]</label><label class="expand" for="c-37376648">[1 more]</label></div><br/><div class="children"><div class="content">Or Cache Oblivious Lookahead Arrays which considered to be an alternative to MergeTree (LSM), but not used anymore: <a href="https:&#x2F;&#x2F;github.com&#x2F;giannitedesco&#x2F;cola">https:&#x2F;&#x2F;github.com&#x2F;giannitedesco&#x2F;cola</a></div><br/></div></div><div id="37376196" class="c"><input type="checkbox" id="c-37376196" checked=""/><div class="controls bullet"><span class="by">beanjuiceII</span><span>|</span><a href="#37374800">parent</a><span>|</span><a href="#37376648">prev</a><span>|</span><a href="#37375036">next</a><span>|</span><label class="collapse" for="c-37376196">[-]</label><label class="expand" for="c-37376196">[2 more]</label></div><br/><div class="children"><div class="content">also its written in rust, not to be confused with <a href="https:&#x2F;&#x2F;rust.facepunch.com&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;rust.facepunch.com&#x2F;</a></div><br/><div id="37377886" class="c"><input type="checkbox" id="c-37377886" checked=""/><div class="controls bullet"><span class="by">dgb23</span><span>|</span><a href="#37374800">root</a><span>|</span><a href="#37376196">parent</a><span>|</span><a href="#37375036">next</a><span>|</span><label class="collapse" for="c-37377886">[-]</label><label class="expand" for="c-37377886">[1 more]</label></div><br/><div class="children"><div class="content">I’m fighting the urge to expand on this joke but this isn’t reddit.</div><br/></div></div></div></div><div id="37375036" class="c"><input type="checkbox" id="c-37375036" checked=""/><div class="controls bullet"><span class="by">satvikpendem</span><span>|</span><a href="#37374800">parent</a><span>|</span><a href="#37376196">prev</a><span>|</span><a href="#37378093">next</a><span>|</span><label class="collapse" for="c-37375036">[-]</label><label class="expand" for="c-37375036">[1 more]</label></div><br/><div class="children"><div class="content">Or coda.io, a Notion clone style app.</div><br/></div></div></div></div><div id="37378093" class="c"><input type="checkbox" id="c-37378093" checked=""/><div class="controls bullet"><span class="by">_pferreir_</span><span>|</span><a href="#37374800">prev</a><span>|</span><a href="#37377407">next</a><span>|</span><label class="collapse" for="c-37378093">[-]</label><label class="expand" for="c-37378093">[1 more]</label></div><br/><div class="children"><div class="content">Certificate seems broken?</div><br/></div></div><div id="37377407" class="c"><input type="checkbox" id="c-37377407" checked=""/><div class="controls bullet"><span class="by">PeterStuer</span><span>|</span><a href="#37378093">prev</a><span>|</span><a href="#37374604">next</a><span>|</span><label class="collapse" for="c-37377407">[-]</label><label class="expand" for="c-37377407">[1 more]</label></div><br/><div class="children"><div class="content">I might give this a try for a project that Etherpad and Word could not handle.</div><br/></div></div><div id="37374604" class="c"><input type="checkbox" id="c-37374604" checked=""/><div class="controls bullet"><span class="by">canadiantim</span><span>|</span><a href="#37377407">prev</a><span>|</span><a href="#37376340">next</a><span>|</span><label class="collapse" for="c-37374604">[-]</label><label class="expand" for="c-37374604">[3 more]</label></div><br/><div class="children"><div class="content">Is this something I can use eg with tiptap&#x2F;prosemirror or some other text editor to add CRDT-based collaborative editing?</div><br/><div id="37375594" class="c"><input type="checkbox" id="c-37375594" checked=""/><div class="controls bullet"><span class="by">h1fra</span><span>|</span><a href="#37374604">parent</a><span>|</span><a href="#37374879">next</a><span>|</span><label class="collapse" for="c-37375594">[-]</label><label class="expand" for="c-37375594">[1 more]</label></div><br/><div class="children"><div class="content">I believe prosemirror and tiptap (built on top of prosemirror) has builtin support for Y.js</div><br/></div></div><div id="37374879" class="c"><input type="checkbox" id="c-37374879" checked=""/><div class="controls bullet"><span class="by">teaearlgraycold</span><span>|</span><a href="#37374604">parent</a><span>|</span><a href="#37375594">prev</a><span>|</span><a href="#37376340">next</a><span>|</span><label class="collapse" for="c-37374879">[-]</label><label class="expand" for="c-37374879">[1 more]</label></div><br/><div class="children"><div class="content">I don’t think it’s made to support WASM. You’d also need a compatibility shim to get it to act like a Y Doc.</div><br/></div></div></div></div><div id="37376340" class="c"><input type="checkbox" id="c-37376340" checked=""/><div class="controls bullet"><span class="by">chaosprint</span><span>|</span><a href="#37374604">prev</a><span>|</span><a href="#37375821">next</a><span>|</span><label class="collapse" for="c-37376340">[-]</label><label class="expand" for="c-37376340">[1 more]</label></div><br/><div class="children"><div class="content">looks very promising. can&#x27;t wait to use it for glicol</div><br/></div></div><div id="37375821" class="c"><input type="checkbox" id="c-37375821" checked=""/><div class="controls bullet"><span class="by">pmarreck</span><span>|</span><a href="#37376340">prev</a><span>|</span><a href="#37373806">next</a><span>|</span><label class="collapse" for="c-37375821">[-]</label><label class="expand" for="c-37375821">[4 more]</label></div><br/><div class="children"><div class="content">Since it assumes all connected clients will receive all edits, why not just include a hash of the expected existing state of the text data before the offset and insertion&#x2F;deletion&#x2F;replacement instructions? That way, edits are more or less guaranteed to only be applied to appropriate states, and further changes can be accumulated in a dictionary with the hash key being the hash of the state of the data it’s expected to be applied to<p>Granted, that’s a lot of hash operations being redundantly computed from the same data, but it is trivial to understand and implement</div><br/><div id="37376160" class="c"><input type="checkbox" id="c-37376160" checked=""/><div class="controls bullet"><span class="by">fastball</span><span>|</span><a href="#37375821">parent</a><span>|</span><a href="#37373806">next</a><span>|</span><label class="collapse" for="c-37376160">[-]</label><label class="expand" for="c-37376160">[3 more]</label></div><br/><div class="children"><div class="content">Because asynchronous edits would never be applied with that system.<p>If I make local edits to a document and you make remote edits to a document, the hash for your &quot;expected state&quot; will never match my document&#x27;s state in the future because I have already made local changes.<p>Yes, CRDTs require all clients receive all edits in order to guarantee convergence, but the updates <i>not needing to be applied in a certain order</i> (which is what you are proposing) is an important property for real-world distributed use-cases.</div><br/><div id="37377763" class="c"><input type="checkbox" id="c-37377763" checked=""/><div class="controls bullet"><span class="by">jakelazaroff</span><span>|</span><a href="#37375821">root</a><span>|</span><a href="#37376160">parent</a><span>|</span><a href="#37376338">next</a><span>|</span><label class="collapse" for="c-37377763">[-]</label><label class="expand" for="c-37377763">[1 more]</label></div><br/><div class="children"><div class="content">That’s only the case for CmRDTs, right? AFAIK CvRDTs (which send the whole state with every request) don’t impose any constraints on message order.</div><br/></div></div></div></div></div></div><div id="37373806" class="c"><input type="checkbox" id="c-37373806" checked=""/><div class="controls bullet"><span class="by">homarp</span><span>|</span><a href="#37375821">prev</a><span>|</span><label class="collapse" for="c-37373806">[-]</label><label class="expand" for="c-37373806">[1 more]</label></div><br/><div class="children"><div class="content">written in Rust :)<p><a href="https:&#x2F;&#x2F;github.com&#x2F;nomad&#x2F;cola">https:&#x2F;&#x2F;github.com&#x2F;nomad&#x2F;cola</a> - MIT licensed</div><br/></div></div></div></div></div></div></div></body></html>