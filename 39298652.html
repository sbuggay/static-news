<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1707382873907" as="style"/><link rel="stylesheet" href="styles.css?v=1707382873907"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://engineering.fb.com/2024/02/07/production-engineering/simple-precision-time-protocol-sptp-meta/">Simple Precision Time Protocol at Meta</a> <span class="domain">(<a href="https://engineering.fb.com">engineering.fb.com</a>)</span></div><div class="subtext"><span>atg_abhishek</span> | <span>20 comments</span></div><br/><div><div id="39299686" class="c"><input type="checkbox" id="c-39299686" checked=""/><div class="controls bullet"><span class="by">mlichvar</span><span>|</span><a href="#39299191">next</a><span>|</span><label class="collapse" for="c-39299686">[-]</label><label class="expand" for="c-39299686">[2 more]</label></div><br/><div class="children"><div class="content">To me that looks like they are reinventing NTP, but not addressing all the issues of PTP.<p>A big problem with the PTP unicast mode is an almost infinite traffic amplification (useful for DDoS attacks). The server is basically a programmable packet generator. Never expose unicast PTP to internet. In SPTP that seems to be no longer the case (the server is stateless), but there is still the follow up message causing a 2:1 amplification. I think something like the NTP interleaved mode would be better.<p>It seems they didn&#x27;t replace the PTP offset calculation assuming a constant delay (broadcast model). That doesn&#x27;t work well when the distribution of the delay is not symmetric, e.g. errors in hardware timestamping on the NIC are sensitive to network load. They would need to measure the actual error of the clock to see that (the graphs in the article seem to show only the offset measured by SPTP itself, a common issue when improvements in time synchronization are demonstrated).<p>I think a better solution taking advantage of existing PTP support in hardware is to encapsulate NTP messages in PTP packets. NICs and switches&#x2F;routers see PTP packets, so they provide highly accurate timestamps and corrections, but the measurements and their processing can be full-featured NTP, keeping all its advantages like resiliency and security. There is an IETF draft specifying that:<p><a href="https:&#x2F;&#x2F;datatracker.ietf.org&#x2F;doc&#x2F;draft-ietf-ntp-over-ptp&#x2F;" rel="nofollow">https:&#x2F;&#x2F;datatracker.ietf.org&#x2F;doc&#x2F;draft-ietf-ntp-over-ptp&#x2F;</a><p>An experimental support for NTP-over-PTP is included in the latest chrony release. In my tests with switches that work as one-step transparent clocks the accuracy is same as with PTP (linuxptp).</div><br/><div id="39299797" class="c"><input type="checkbox" id="c-39299797" checked=""/><div class="controls bullet"><span class="by">bux93</span><span>|</span><a href="#39299686">parent</a><span>|</span><a href="#39299191">next</a><span>|</span><label class="collapse" for="c-39299797">[-]</label><label class="expand" for="c-39299797">[1 more]</label></div><br/><div class="children"><div class="content">I listened to a fascinating podcast from Jane Street on their solution.
Pasted the relevant part<p><a href="https:&#x2F;&#x2F;signalsandthreads.com&#x2F;clock-synchronization&#x2F;" rel="nofollow">https:&#x2F;&#x2F;signalsandthreads.com&#x2F;clock-synchronization&#x2F;</a>
--quote
&quot;So, we’re trying to build a proof of concept. At the end of the day, we sort of figured, “All right. We have these GPS appliances.” We talked about hardware timestamping before on the GPS appliances, and how they can’t hardware timestamp the NTP packets, so that’s problematic. We thought, “How can we move time from the GPS appliances off into the rest of the network?” And so we decided that we could use PTP to move time from the GPS appliances to a set of Linux machines, and then on those Linux machines we could leverage things, like hardware timestamping, and the NTP interleaved mode to move the time from those machines onto machines further downstream.<p>The NTP interleaved mode, just to give a short overview of what that means… when you send a packet if you get it hardware timestamps on transmission the way you use that hardware timestamp is you get it kind of looped back to you as an application. So I transmit a packet, I get that hardware timestamp after the packet’s already gone out the door. That’s not super useful from an NTP point of view, because really you wanted the other side to receive that hardware timestamp, and so the interleaved mode is sort of a special way in which you can run NTP and that when you transmit your next NTP packet you send that hardware timestamp that you got for the previous transmission, and then the other side, each side can use those. I don’t want to get into too much of the details of how that works, but it allows you to get more accuracy and to leverage those hardware timestamps on transmission.&quot;
-- end quote</div><br/></div></div></div></div><div id="39299191" class="c"><input type="checkbox" id="c-39299191" checked=""/><div class="controls bullet"><span class="by">kristopolous</span><span>|</span><a href="#39299686">prev</a><span>|</span><label class="collapse" for="c-39299191">[-]</label><label class="expand" for="c-39299191">[17 more]</label></div><br/><div class="children"><div class="content">Facebook continues to follow the Yahoo and AOL trajectory of exceptional and generous engineering contributions amidst an increasingly disliked suite of commercial offerings.<p>Reminds me of a project idea where you list out all the big companies that have GitHub projects like Comcast, Walmart, Verizon, Target and even <a href="https:&#x2F;&#x2F;github.com&#x2F;mcdcorp">https:&#x2F;&#x2F;github.com&#x2F;mcdcorp</a></div><br/><div id="39299271" class="c"><input type="checkbox" id="c-39299271" checked=""/><div class="controls bullet"><span class="by">ldjkfkdsjnv</span><span>|</span><a href="#39299191">parent</a><span>|</span><a href="#39299564">next</a><span>|</span><label class="collapse" for="c-39299271">[-]</label><label class="expand" for="c-39299271">[7 more]</label></div><br/><div class="children"><div class="content">Actually think that behind the scenes facebook is rapidly innovating on ai and integrating it into its ad targeting. Mets is on fire</div><br/><div id="39299289" class="c"><input type="checkbox" id="c-39299289" checked=""/><div class="controls bullet"><span class="by">KevinAgain</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299271">parent</a><span>|</span><a href="#39299767">next</a><span>|</span><label class="collapse" for="c-39299289">[-]</label><label class="expand" for="c-39299289">[3 more]</label></div><br/><div class="children"><div class="content">Sounds squarely within the &quot;increasingly disliked suite of commercial offerings&quot;</div><br/><div id="39299769" class="c"><input type="checkbox" id="c-39299769" checked=""/><div class="controls bullet"><span class="by">nuthje</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299289">parent</a><span>|</span><a href="#39299496">next</a><span>|</span><label class="collapse" for="c-39299769">[-]</label><label class="expand" for="c-39299769">[1 more]</label></div><br/><div class="children"><div class="content">Their commercial offering is advertisement, which seems to be liked.</div><br/></div></div><div id="39299496" class="c"><input type="checkbox" id="c-39299496" checked=""/><div class="controls bullet"><span class="by">omeze</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299289">parent</a><span>|</span><a href="#39299769">prev</a><span>|</span><a href="#39299767">next</a><span>|</span><label class="collapse" for="c-39299496">[-]</label><label class="expand" for="c-39299496">[1 more]</label></div><br/><div class="children"><div class="content">Instagram and Whatsapp? Even Quest as a platform has tens of millions. All of these are still up and to the right in terms of user numbers and revenue</div><br/></div></div></div></div><div id="39299767" class="c"><input type="checkbox" id="c-39299767" checked=""/><div class="controls bullet"><span class="by">daavidhauser</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299271">parent</a><span>|</span><a href="#39299289">prev</a><span>|</span><a href="#39299781">next</a><span>|</span><label class="collapse" for="c-39299767">[-]</label><label class="expand" for="c-39299767">[1 more]</label></div><br/><div class="children"><div class="content">+1</div><br/></div></div><div id="39299781" class="c"><input type="checkbox" id="c-39299781" checked=""/><div class="controls bullet"><span class="by">zer00eyz</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299271">parent</a><span>|</span><a href="#39299767">prev</a><span>|</span><a href="#39299560">next</a><span>|</span><label class="collapse" for="c-39299781">[-]</label><label class="expand" for="c-39299781">[1 more]</label></div><br/><div class="children"><div class="content">&gt;&gt; innovating on ai and integrating it into its ad targeting.<p>Summer child.<p>No one who has add space to sell wants an efficient, accurate market. Those inefficiencies create competition, create volume create profit for those with ad space to sell.<p>The ad market had more effective targeting and better ROI 10 years ago than it does today.<p>Go and try to run a CPA campaign at any cost... you can&#x27;t. It&#x27;s all display add&#x27;s CPM garbage, carpet bomb for pennies.</div><br/></div></div><div id="39299560" class="c"><input type="checkbox" id="c-39299560" checked=""/><div class="controls bullet"><span class="by">te_chris</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299271">parent</a><span>|</span><a href="#39299781">prev</a><span>|</span><a href="#39299564">next</a><span>|</span><label class="collapse" for="c-39299560">[-]</label><label class="expand" for="c-39299560">[1 more]</label></div><br/><div class="children"><div class="content">Meanwhile high earning millennials quit instagram because the product mostly sucks. Hell of a cathedral they’re building though.</div><br/></div></div></div></div><div id="39299564" class="c"><input type="checkbox" id="c-39299564" checked=""/><div class="controls bullet"><span class="by">sirpunch</span><span>|</span><a href="#39299191">parent</a><span>|</span><a href="#39299271">prev</a><span>|</span><a href="#39299239">next</a><span>|</span><label class="collapse" for="c-39299564">[-]</label><label class="expand" for="c-39299564">[3 more]</label></div><br/><div class="children"><div class="content">This HN bandwagon again. Meta has had an astounding yoy growth. Did you even see their Q4 report.</div><br/><div id="39299611" class="c"><input type="checkbox" id="c-39299611" checked=""/><div class="controls bullet"><span class="by">test6554</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299564">parent</a><span>|</span><a href="#39299684">next</a><span>|</span><label class="collapse" for="c-39299611">[-]</label><label class="expand" for="c-39299611">[1 more]</label></div><br/><div class="children"><div class="content">If they are relying on headset sales… competition is about to heat up. Ive been waiting for anyone but meta to come out with a decent, affordable kit and I think were almost there.</div><br/></div></div><div id="39299684" class="c"><input type="checkbox" id="c-39299684" checked=""/><div class="controls bullet"><span class="by">sofixa</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299564">parent</a><span>|</span><a href="#39299611">prev</a><span>|</span><a href="#39299239">next</a><span>|</span><label class="collapse" for="c-39299684">[-]</label><label class="expand" for="c-39299684">[1 more]</label></div><br/><div class="children"><div class="content">YoY growth and quarterly earnings report don&#x27;t give you a full picture of how much a company is liked and how well it is actually performing for the medium&#x2F;long term.<p>GE and Boeing also had amazing YoY growth and great quarterly reports, until the underlying dumpster fire they were nurturing for years exploded in their faces and now they don&#x27;t have growth nor profits anymore.</div><br/></div></div></div></div><div id="39299239" class="c"><input type="checkbox" id="c-39299239" checked=""/><div class="controls bullet"><span class="by">lukevp</span><span>|</span><a href="#39299191">parent</a><span>|</span><a href="#39299564">prev</a><span>|</span><label class="collapse" for="c-39299239">[-]</label><label class="expand" for="c-39299239">[6 more]</label></div><br/><div class="children"><div class="content">What did yahoo and AOL contribute?</div><br/><div id="39299491" class="c"><input type="checkbox" id="c-39299491" checked=""/><div class="controls bullet"><span class="by">speedgoose</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299239">parent</a><span>|</span><a href="#39299310">next</a><span>|</span><label class="collapse" for="c-39299491">[-]</label><label class="expand" for="c-39299491">[1 more]</label></div><br/><div class="children"><div class="content">Yahoo had YUI which fell out of fashion.<p><a href="https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;YUI_Library" rel="nofollow">https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;YUI_Library</a></div><br/></div></div><div id="39299310" class="c"><input type="checkbox" id="c-39299310" checked=""/><div class="controls bullet"><span class="by">ralph84</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299239">parent</a><span>|</span><a href="#39299491">prev</a><span>|</span><a href="#39299623">next</a><span>|</span><label class="collapse" for="c-39299310">[-]</label><label class="expand" for="c-39299310">[1 more]</label></div><br/><div class="children"><div class="content">Hadoop, AOLserver, early support for Mozilla</div><br/></div></div><div id="39299623" class="c"><input type="checkbox" id="c-39299623" checked=""/><div class="controls bullet"><span class="by">fragmede</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299239">parent</a><span>|</span><a href="#39299310">prev</a><span>|</span><a href="#39299422">next</a><span>|</span><label class="collapse" for="c-39299623">[-]</label><label class="expand" for="c-39299623">[1 more]</label></div><br/><div class="children"><div class="content">yahoo pipes</div><br/></div></div><div id="39299422" class="c"><input type="checkbox" id="c-39299422" checked=""/><div class="controls bullet"><span class="by">therein</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299239">parent</a><span>|</span><a href="#39299623">prev</a><span>|</span><label class="collapse" for="c-39299422">[-]</label><label class="expand" for="c-39299422">[2 more]</label></div><br/><div class="children"><div class="content">Apache Traffic Server, AOLserver (no idea why I used this a long time ago)</div><br/><div id="39299702" class="c"><input type="checkbox" id="c-39299702" checked=""/><div class="controls bullet"><span class="by">bemusedthrow75</span><span>|</span><a href="#39299191">root</a><span>|</span><a href="#39299422">parent</a><span>|</span><label class="collapse" for="c-39299702">[-]</label><label class="expand" for="c-39299702">[1 more]</label></div><br/><div class="children"><div class="content">AOLServer was interesting, yeah. A useful counterpoint to Netscape Application Server, and quite influential over mod_perl and PHP.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>