<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718182855991" as="style"/><link rel="stylesheet" href="styles.css?v=1718182855991"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://frereit.de/aes_gcm/">AES-GCM and breaking it on nonce reuse</a> <span class="domain">(<a href="https://frereit.de">frereit.de</a>)</span></div><div class="subtext"><span>_tk_</span> | <span>17 comments</span></div><br/><div><div id="40654464" class="c"><input type="checkbox" id="c-40654464" checked=""/><div class="controls bullet"><span class="by">WantonQuantum</span><span>|</span><a href="#40655566">next</a><span>|</span><label class="collapse" for="c-40654464">[-]</label><label class="expand" for="c-40654464">[2 more]</label></div><br/><div class="children"><div class="content">&quot;At first glance, this seems fine, but it is not. If an attacker knows the plaintext p1 and the ciphertext c1, then they can compute the keystream by XORing p1 and c1 together&quot;<p>Also, if the attacker only has c1 and c2, if the nonce is reused then c1 xor c2 will be the same as p1 xor p2. In most cases, two plaintexts xored with each other are trivial to decode.</div><br/><div id="40655572" class="c"><input type="checkbox" id="c-40655572" checked=""/><div class="controls bullet"><span class="by">Raed667</span><span>|</span><a href="#40654464">parent</a><span>|</span><a href="#40655566">next</a><span>|</span><label class="collapse" for="c-40655572">[-]</label><label class="expand" for="c-40655572">[1 more]</label></div><br/><div class="children"><div class="content">I made an entire &quot;game&quot; based on this concept (AES CTR though)  <a href="https:&#x2F;&#x2F;aes-cpa.fly.dev&#x2F;" rel="nofollow">https:&#x2F;&#x2F;aes-cpa.fly.dev&#x2F;</a></div><br/></div></div></div></div><div id="40655566" class="c"><input type="checkbox" id="c-40655566" checked=""/><div class="controls bullet"><span class="by">bux93</span><span>|</span><a href="#40654464">prev</a><span>|</span><a href="#40654633">next</a><span>|</span><label class="collapse" for="c-40655566">[-]</label><label class="expand" for="c-40655566">[1 more]</label></div><br/><div class="children"><div class="content">I dunno, nonce means number-used-once, it should be kinda obvious that it should be used only once?</div><br/></div></div><div id="40654633" class="c"><input type="checkbox" id="c-40654633" checked=""/><div class="controls bullet"><span class="by">e____g</span><span>|</span><a href="#40655566">prev</a><span>|</span><a href="#40654181">next</a><span>|</span><label class="collapse" for="c-40654633">[-]</label><label class="expand" for="c-40654633">[4 more]</label></div><br/><div class="children"><div class="content">It&#x27;s worth mentioning AES-GCM-SIV[1], which is the fix for this issue.<p>[1] <a href="https:&#x2F;&#x2F;www.rfc-editor.org&#x2F;rfc&#x2F;rfc8452.html" rel="nofollow">https:&#x2F;&#x2F;www.rfc-editor.org&#x2F;rfc&#x2F;rfc8452.html</a></div><br/><div id="40655079" class="c"><input type="checkbox" id="c-40655079" checked=""/><div class="controls bullet"><span class="by">notfed</span><span>|</span><a href="#40654633">parent</a><span>|</span><a href="#40654935">next</a><span>|</span><label class="collapse" for="c-40655079">[-]</label><label class="expand" for="c-40655079">[1 more]</label></div><br/><div class="children"><div class="content">The &quot;fix&quot; is to use a nonce misuse resistant cipher, of which AES-GCM-SIV is one.<p>But, AES-GCM-SIV requires two passes over the data, which isn&#x27;t always ideal.<p>The goal of the CAESAR competition [1] was essentially to find alternatives. Whether that goal has been met is a bit unclear at the moment.<p>[1] <a href="https:&#x2F;&#x2F;competitions.cr.yp.to&#x2F;caesar-submissions.html" rel="nofollow">https:&#x2F;&#x2F;competitions.cr.yp.to&#x2F;caesar-submissions.html</a></div><br/></div></div><div id="40654935" class="c"><input type="checkbox" id="c-40654935" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#40654633">parent</a><span>|</span><a href="#40655079">prev</a><span>|</span><a href="#40654181">next</a><span>|</span><label class="collapse" for="c-40654935">[-]</label><label class="expand" for="c-40654935">[2 more]</label></div><br/><div class="children"><div class="content">The alternative, which I prefer, is an XGCM-like construction that just gives you a large enough nonce to comfortably use random nonces.</div><br/><div id="40655083" class="c"><input type="checkbox" id="c-40655083" checked=""/><div class="controls bullet"><span class="by">dontdoxxme</span><span>|</span><a href="#40654633">root</a><span>|</span><a href="#40654935">parent</a><span>|</span><a href="#40654181">next</a><span>|</span><label class="collapse" for="c-40655083">[-]</label><label class="expand" for="c-40655083">[1 more]</label></div><br/><div class="children"><div class="content">+1, soatok has a write-up of how that works: <a href="https:&#x2F;&#x2F;soatok.blog&#x2F;2022&#x2F;12&#x2F;21&#x2F;extending-the-aes-gcm-nonce-without-nightmare-fuel&#x2F;" rel="nofollow">https:&#x2F;&#x2F;soatok.blog&#x2F;2022&#x2F;12&#x2F;21&#x2F;extending-the-aes-gcm-nonce-w...</a><p>...a variant on that is DNDK-GCM in draft at <a href="https:&#x2F;&#x2F;datatracker.ietf.org&#x2F;doc&#x2F;draft-gueron-cfrg-dndkgcm&#x2F;" rel="nofollow">https:&#x2F;&#x2F;datatracker.ietf.org&#x2F;doc&#x2F;draft-gueron-cfrg-dndkgcm&#x2F;</a> and a recent presentation: <a href="https:&#x2F;&#x2F;youtu.be&#x2F;GsFO4ZQlYS8" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;GsFO4ZQlYS8</a> (this is Shay Gueron who worked on AES-GCM-SIV too).</div><br/></div></div></div></div></div></div><div id="40654181" class="c"><input type="checkbox" id="c-40654181" checked=""/><div class="controls bullet"><span class="by">jas-</span><span>|</span><a href="#40654633">prev</a><span>|</span><a href="#40655681">next</a><span>|</span><label class="collapse" for="c-40654181">[-]</label><label class="expand" for="c-40654181">[8 more]</label></div><br/><div class="children"><div class="content">Great post! Thanks for taking the time to put this up.<p>What do you think the ratios are regarding improper use of nonce with this mode?<p>Most implementations that I am familiar with intentionally generate a random nonce to help lower the percentage of app devs doing this very thing</div><br/><div id="40655285" class="c"><input type="checkbox" id="c-40655285" checked=""/><div class="controls bullet"><span class="by">whs</span><span>|</span><a href="#40654181">parent</a><span>|</span><a href="#40654380">next</a><span>|</span><label class="collapse" for="c-40655285">[-]</label><label class="expand" for="c-40655285">[1 more]</label></div><br/><div class="children"><div class="content">My company need deterministic encryption to search encrypted data.<p>Turns out the people who wrote the in house Go library didn&#x27;t have any idea. There is no non-deterministic encryption function because that might be too complicated for non-senior engineers (afterall they wrote most of the actual application) to correctly choose.<p>The first version use AES-CFB. There&#x27;s no authentication. It&#x27;s probably copy pasted from a public Gist and nobody ever commented on it that it is insecure. I wonder if it was actually intended to be the non-deterministic version, but the higher level wrappers do not wrap this function so people didn&#x27;t actually use it.<p>The second version use AES-GCM with nonce derived from the key and AD. Since nobody understand why AD is needed, AD is always nil. Essentially there&#x27;s ever one nonce.<p>I think the problem is that many senior engineers know that encryption use &quot;AES&quot; library but the Go standard library doesn&#x27;t tell you how to use it securely.<p>Surprisingly this mistake also happen in our Java stack that was written by a different team. A senior engineer did notice and quietly moved away from the vulnerable version without telling the Go version.<p>I wrote a POC to decrypt data of the Go version, then wrote the third version, perhaps it will be open source soon. The new library only implement envelope key management, encrypted string wrapper and ORM integration. The rest is Google&#x27;s Tink.</div><br/></div></div><div id="40654380" class="c"><input type="checkbox" id="c-40654380" checked=""/><div class="controls bullet"><span class="by">tadfisher</span><span>|</span><a href="#40654181">parent</a><span>|</span><a href="#40655285">prev</a><span>|</span><a href="#40654832">next</a><span>|</span><label class="collapse" for="c-40654380">[-]</label><label class="expand" for="c-40654380">[1 more]</label></div><br/><div class="children"><div class="content">Correct. GCM is an improvement over ECB and CBC; it doesn&#x27;t magically transform a symmetric algorithm into an asymmetric one. So most libraries are going to focus on the use cases where symmetric crypto makes sense, which are single-party scenarios such as disk storage. Google&#x27;s Tink library, for example, completely hides the nonce parameter from its API.</div><br/></div></div><div id="40654832" class="c"><input type="checkbox" id="c-40654832" checked=""/><div class="controls bullet"><span class="by">denimnerd42</span><span>|</span><a href="#40654181">parent</a><span>|</span><a href="#40654380">prev</a><span>|</span><a href="#40654365">next</a><span>|</span><label class="collapse" for="c-40654832">[-]</label><label class="expand" for="c-40654832">[1 more]</label></div><br/><div class="children"><div class="content">The problem with a random nonce is that most implementations also use a nonce of 12 bytes which under some use cases might not be enough before you repeat a nonce. So to remedy this they suggest using a counter but this could be hard to implement.<p>When I use AES-GCM I just use a bigger nonce and use a random one.<p>Last time I used AES-GCM I had a really hard time getting the person writing the other end to not re-use nonces.</div><br/></div></div><div id="40654365" class="c"><input type="checkbox" id="c-40654365" checked=""/><div class="controls bullet"><span class="by">gnabgib</span><span>|</span><a href="#40654181">parent</a><span>|</span><a href="#40654832">prev</a><span>|</span><a href="#40655681">next</a><span>|</span><label class="collapse" for="c-40654365">[-]</label><label class="expand" for="c-40654365">[4 more]</label></div><br/><div class="children"><div class="content">I think the writer is @frereit, they submitted 2 days ago <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40623885">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=40623885</a></div><br/><div id="40654570" class="c"><input type="checkbox" id="c-40654570" checked=""/><div class="controls bullet"><span class="by">frereit</span><span>|</span><a href="#40654181">root</a><span>|</span><a href="#40654365">parent</a><span>|</span><a href="#40655681">next</a><span>|</span><label class="collapse" for="c-40654570">[-]</label><label class="expand" for="c-40654570">[3 more]</label></div><br/><div class="children"><div class="content">Yes, I am, but unfortunately I do not think I can provide any answers here. A quick internet search reveals some CVEs for nonce reuse.<p>If I had to, based on absolutely nothing but a gut feeling, guess, I&#x27;d think this may appear more frequently in IoT devices, where AES-GCM is attractive because of its speed, but randomness is sometimes in low supply?</div><br/><div id="40655039" class="c"><input type="checkbox" id="c-40655039" checked=""/><div class="controls bullet"><span class="by">frippertronics</span><span>|</span><a href="#40654181">root</a><span>|</span><a href="#40654570">parent</a><span>|</span><a href="#40655681">next</a><span>|</span><label class="collapse" for="c-40655039">[-]</label><label class="expand" for="c-40655039">[2 more]</label></div><br/><div class="children"><div class="content">AES-GCM is also used in the Bluetooth Low Energy protocol, which is commonly used for IoT-purposes. As a result it’s more often than not available as a hardware-accelerated peripheral, saving both time and power. There’s also hardware-RNG available in those cases.<p>I think one reason nonce-reuse is a problem in IoT is lack of experience and awareness. Up until relatively recently a lot of embedded development was constrained to just offline devices, so cryptography wasn’t really required.</div><br/><div id="40655877" class="c"><input type="checkbox" id="c-40655877" checked=""/><div class="controls bullet"><span class="by">ctz</span><span>|</span><a href="#40654181">root</a><span>|</span><a href="#40655039">parent</a><span>|</span><a href="#40655681">next</a><span>|</span><label class="collapse" for="c-40655877">[-]</label><label class="expand" for="c-40655877">[1 more]</label></div><br/><div class="children"><div class="content">BLE uses AES-CCM.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="40655681" class="c"><input type="checkbox" id="c-40655681" checked=""/><div class="controls bullet"><span class="by">commandersaki</span><span>|</span><a href="#40654181">prev</a><span>|</span><label class="collapse" for="c-40655681">[-]</label><label class="expand" for="c-40655681">[1 more]</label></div><br/><div class="children"><div class="content">Excellent article was a very insightful read.</div><br/></div></div></div></div></div></div></div></body></html>