<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1735894856013" as="style"/><link rel="stylesheet" href="styles.css?v=1735894856013"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://byroot.github.io/ruby/json/2024/12/29/optimizing-ruby-json-part-4.html">Optimizing Ruby&#x27;s JSON, Part 4</a> <span class="domain">(<a href="https://byroot.github.io">byroot.github.io</a>)</span></div><div class="subtext"><span>jeremy_k</span> | <span>17 comments</span></div><br/><div><div id="42580810" class="c"><input type="checkbox" id="c-42580810" checked=""/><div class="controls bullet"><span class="by">LukeShu</span><span>|</span><a href="#42583285">next</a><span>|</span><label class="collapse" for="c-42580810">[-]</label><label class="expand" for="c-42580810">[3 more]</label></div><br/><div class="children"><div class="content">Very glad to see the work that byroot is doing as the new ruby-json maintainer!<p>Since I was mentioned by name in part 3, perhaps I can provide some interesting commentary:<p><i>&gt; All this code had recently been rewritten pretty much from scratch by Luke Shumaker ... While this code is very clean and generic, with a good separation of the multiple levels of abstractions, such as bytes and codepoints, that would make it very easy to extend the escaping logic, it isn’t taking advantage of many assumptions convert_UTF8_to_JSON could make to take shortcuts.</i><p>My rewritten version was already slightly faster than the original version, so I didn&#x27;t feel the need to spend more time optimizing it, at least until the simple version got merged; which I had no idea when that&#x27;d be because of silence from the then-maintainer. Every optimization would be an opportunity for more pain when rebasing away merge-conflicts; which was already painful enough the 2 times I had to do it while waiting for a reply.<p><i>&gt; One of these for instance is that there’s no point validating the UTF-8 encoding because Ruby did it for us and it’s impossible to end up inside convert_UTF8_to_JSON with invalid UTF-8.</i><p>I don&#x27;t care to dig through the history to see exactly what changed when, but: At the time I wrote it, the unit tests told me that wasn&#x27;t true; if I omitted the checks for invalid UTF-8, then the tests failed.<p><i>&gt; Another is that there are only two multi-byte characters we care about, and both start with the same 0xE2 byte, so the decoding into codepoints is a bit superfluous. ... we can re-use Mame’s lookup table, but with a twist.</i><p>I noted in the original PR description that I thought a lookup table would be faster than my decoder.  I didn&#x27;t use a lookup table myself (1) to keep the initial version simple to make code-review simple to increase likelihood that it got merged, and (2) the old proprietary CVTUTF code used a lookup table, and because I was so familiar with the CVTUTF code, I didn&#x27;t feel comfortable being the one to to re-add a lookup table. Glad to see that my suspicion was correct and that someone else did the work!</div><br/><div id="42581097" class="c"><input type="checkbox" id="c-42581097" checked=""/><div class="controls bullet"><span class="by">JohnBooty</span><span>|</span><a href="#42580810">parent</a><span>|</span><a href="#42582338">next</a><span>|</span><label class="collapse" for="c-42581097">[-]</label><label class="expand" for="c-42581097">[1 more]</label></div><br/><div class="children"><div class="content">Thanks so much for your work, and also thanks for some insight into choices you made.<p>I&#x27;m not familiar with the internals of the JSON gem, but in general... yeah, it&#x27;s funny right? PRs are almost never ideal. Always some compromise based on time available, code review considerations, etc.<p>Everything you said makes a lot of sense!</div><br/></div></div><div id="42582338" class="c"><input type="checkbox" id="c-42582338" checked=""/><div class="controls bullet"><span class="by">matheusmoreira</span><span>|</span><a href="#42580810">parent</a><span>|</span><a href="#42581097">prev</a><span>|</span><a href="#42583285">next</a><span>|</span><label class="collapse" for="c-42582338">[-]</label><label class="expand" for="c-42582338">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for your work. I understand why you tried to keep it simple. Getting ignored or rejected by a maintainer is one of the least fun things I&#x27;ve ever experienced. Takes real skill to get something merged in, and not just technical skill.</div><br/></div></div></div></div><div id="42583285" class="c"><input type="checkbox" id="c-42583285" checked=""/><div class="controls bullet"><span class="by">cannibalXxx</span><span>|</span><a href="#42580810">prev</a><span>|</span><a href="#42581021">next</a><span>|</span><label class="collapse" for="c-42583285">[-]</label><label class="expand" for="c-42583285">[1 more]</label></div><br/><div class="children"><div class="content">If you&#x27;re just starting out in this language, here&#x27;s a list that will help you with that [0] <a href="https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=453" rel="nofollow">https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=453</a>, [1] <a href="https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=457" rel="nofollow">https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=457</a> [2] <a href="https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=565" rel="nofollow">https:&#x2F;&#x2F;chat-to.dev&#x2F;post?id=565</a></div><br/></div></div><div id="42581021" class="c"><input type="checkbox" id="c-42581021" checked=""/><div class="controls bullet"><span class="by">anitil</span><span>|</span><a href="#42583285">prev</a><span>|</span><a href="#42582365">next</a><span>|</span><label class="collapse" for="c-42581021">[-]</label><label class="expand" for="c-42581021">[1 more]</label></div><br/><div class="children"><div class="content">This was really enjoyable to read - I really enjoy this kind of in-the-weeds optimisation and the author explains it all really well. I was surprised at how much Oj was willing to put on the stack! But my background is embedded and so large stack allocations have ruined my day more than once</div><br/></div></div><div id="42582365" class="c"><input type="checkbox" id="c-42582365" checked=""/><div class="controls bullet"><span class="by">meisel</span><span>|</span><a href="#42581021">prev</a><span>|</span><a href="#42583128">next</a><span>|</span><label class="collapse" for="c-42582365">[-]</label><label class="expand" for="c-42582365">[1 more]</label></div><br/><div class="children"><div class="content">Would allocating a 640-byte string initially really be the right tradeoff? It seems like it could result in a lot of memory overhead if many small strings are created that don’t need that space. But it does save a copy at least<p>As for the int-to-string function, using the division result to do a faster modulus (eg with the div function) and possibly a lookup table seem like they’d help (there must be some good open source libraries focused on this to look at).</div><br/></div></div><div id="42583128" class="c"><input type="checkbox" id="c-42583128" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#42582365">prev</a><span>|</span><a href="#42580656">next</a><span>|</span><label class="collapse" for="c-42583128">[-]</label><label class="expand" for="c-42583128">[1 more]</label></div><br/><div class="children"><div class="content">Man, if I had a nickel every time I saw an itoa&#x2F;ltoa&#x2F;lltoa implementation that doesn&#x27;t work on the most negative number I&#x27;d have about $10 or so, I think.<p>The annyoing thing about it is that all the workarounds I know about are really ain&#x27;t that pretty:<p>1. You can hard-code the check against it and return a hardcoded string representation of it:<p><pre><code>    if (number == -9223372036854775808) return &quot;-9223372036854775808&quot;;
</code></pre>
By the way, &quot;(number &amp;&amp; (number == -number))&quot; condition doesn&#x27;t work so don&#x27;t try to be too smart about it: just compare against INT_MIN&#x2F;LONG_MIN&#x2F;etc.<p>2. You can widen the numeric type, and do the conversion in the larger integer width, but it doesn&#x27;t really work for intmax_t and it&#x27;s, of course, is slower. Alternatively, you can perform only the first iteration in the widened arithmetic, and do the rest in the original width, but this leads to some code duplication.<p>2a. You can do<p><pre><code>    unsigned unumber = number;
    if (number &lt; 0) unumber = -unumber;
</code></pre>
and convert the unsigned number instead. Again, you can chose to do only the first iteration in the unsigned, on platforms where unsigned multiplication&#x2F;division is slower than signed ones. Oh, and again, beware that &quot;unsigned unumber = number &lt; 0 ? -number : number&quot; way of conversion doesn&#x27;t work.<p>3. You can, instead of turning the negative numbers into positive ones and working with the positive numbers, do the opposite: turn positive numbers into negative ones and work exclusively with the negative numbers. Such conversion is safe, and division in C is required to truncate to zero, so it all works out fine except for the fact that the remainders will be negative; you&#x27;ll have to deal with that.<p>But yeah, converting integers into strings is surprisingly slow; not as slow as converting floats, but still very noticeable. Maybe BCDs weren&#x27;t such a silly idea, after all...</div><br/></div></div><div id="42580656" class="c"><input type="checkbox" id="c-42580656" checked=""/><div class="controls bullet"><span class="by">echelon</span><span>|</span><a href="#42583128">prev</a><span>|</span><a href="#42580654">next</a><span>|</span><label class="collapse" for="c-42580656">[-]</label><label class="expand" for="c-42580656">[4 more]</label></div><br/><div class="children"><div class="content">I haven&#x27;t seen this many Ruby posts on HN since 2012.<p>We&#x27;ve had a few months of pretty regular Ruby posts now, and the last week has had one almost every single day.<p>I&#x27;m not a regular Rubyist, but I&#x27;m glad to see the language getting more attention.</div><br/><div id="42580885" class="c"><input type="checkbox" id="c-42580885" checked=""/><div class="controls bullet"><span class="by">mberning</span><span>|</span><a href="#42580656">parent</a><span>|</span><a href="#42580654">next</a><span>|</span><label class="collapse" for="c-42580885">[-]</label><label class="expand" for="c-42580885">[3 more]</label></div><br/><div class="children"><div class="content">Agree. I am ready for a Ruby renaissance that is not so heavily focused on rails. I have built quite a few standalone utilities in ruby over the years and it’s a joy compared many other languages and ecosystems.</div><br/><div id="42582281" class="c"><input type="checkbox" id="c-42582281" checked=""/><div class="controls bullet"><span class="by">matheusmoreira</span><span>|</span><a href="#42580656">root</a><span>|</span><a href="#42580885">parent</a><span>|</span><a href="#42580654">next</a><span>|</span><label class="collapse" for="c-42582281">[-]</label><label class="expand" for="c-42582281">[2 more]</label></div><br/><div class="children"><div class="content">I wonder what prompted this renaissance. Always loved the language, never cared much about Rails. For a long time it seemed like Ruby was never going to catch up to Python and JavaScript which are the default languages everybody uses. Now every other day I see some awesome Ruby news about how it&#x27;s getting better and faster. Not that I&#x27;m not complaining.</div><br/><div id="42582720" class="c"><input type="checkbox" id="c-42582720" checked=""/><div class="controls bullet"><span class="by">kenhwang</span><span>|</span><a href="#42580656">root</a><span>|</span><a href="#42582281">parent</a><span>|</span><a href="#42580654">next</a><span>|</span><label class="collapse" for="c-42582720">[-]</label><label class="expand" for="c-42582720">[1 more]</label></div><br/><div class="children"><div class="content">Seems like the next generation of programmers has relearned the lessons of poor package management and ecosystem fragmentation, and that it wasn&#x27;t worth giving up for a slightly simpler or slightly faster language.<p>Also, ruby did get a lot faster in the last couple years, which inspires people to want to help make it even faster. When someone finds gold, everyone else rushes in to look for more.</div><br/></div></div></div></div></div></div></div></div><div id="42580654" class="c"><input type="checkbox" id="c-42580654" checked=""/><div class="controls bullet"><span class="by">akdas</span><span>|</span><a href="#42580656">prev</a><span>|</span><a href="#42581594">next</a><span>|</span><label class="collapse" for="c-42580654">[-]</label><label class="expand" for="c-42580654">[1 more]</label></div><br/><div class="children"><div class="content">I recommend reading the previous 3 parts too, plus I&#x27;m looking forward to the next parts. I love that it goes into details and very clearly explains the problems and solutions, at least if you&#x27;re familiar with C and know some things about compiler implementations.</div><br/></div></div><div id="42581594" class="c"><input type="checkbox" id="c-42581594" checked=""/><div class="controls bullet"><span class="by">Lammy</span><span>|</span><a href="#42580654">prev</a><span>|</span><a href="#42581475">next</a><span>|</span><label class="collapse" for="c-42581594">[-]</label><label class="expand" for="c-42581594">[1 more]</label></div><br/><div class="children"><div class="content">This makes me want to re-compare REXML and ox (from the same author as oj) which I use heavily.</div><br/></div></div><div id="42581475" class="c"><input type="checkbox" id="c-42581475" checked=""/><div class="controls bullet"><span class="by">dudeinjapan</span><span>|</span><a href="#42581594">prev</a><span>|</span><a href="#42580839">next</a><span>|</span><label class="collapse" for="c-42581475">[-]</label><label class="expand" for="c-42581475">[2 more]</label></div><br/><div class="children"><div class="content">Whats the reason for not merging&#x2F;using Oj as the Ruby core JSON library?</div><br/><div id="42581552" class="c"><input type="checkbox" id="c-42581552" checked=""/><div class="controls bullet"><span class="by">milofeynman</span><span>|</span><a href="#42581475">parent</a><span>|</span><a href="#42580839">next</a><span>|</span><label class="collapse" for="c-42581552">[-]</label><label class="expand" for="c-42581552">[1 more]</label></div><br/><div class="children"><div class="content">Kind of answered in part 1 intro: <a href="https:&#x2F;&#x2F;byroot.github.io&#x2F;ruby&#x2F;json&#x2F;2024&#x2F;12&#x2F;15&#x2F;optimizing-ruby-json-part-1.html" rel="nofollow">https:&#x2F;&#x2F;byroot.github.io&#x2F;ruby&#x2F;json&#x2F;2024&#x2F;12&#x2F;15&#x2F;optimizing-rub...</a></div><br/></div></div></div></div></div></div></div></div></div></body></html>