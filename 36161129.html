<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1685869262139" as="style"/><link rel="stylesheet" href="styles.css?v=1685869262139"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://lukemerrick.com/posts/intro_to_julox.html">Building a Lox Interpreter in Julia</a> <span class="domain">(<a href="https://lukemerrick.com">lukemerrick.com</a>)</span></div><div class="subtext"><span>lukemerrick</span> | <span>23 comments</span></div><br/><div><div id="36161130" class="c"><input type="checkbox" id="c-36161130" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36163271">next</a><span>|</span><label class="collapse" for="c-36161130">[-]</label><label class="expand" for="c-36161130">[19 more]</label></div><br/><div class="children"><div class="content">Disclaimer: I wrote this blog post. If this were an &quot;Ask HN&quot; post, though, the question would be &quot;What next after reading Crafting Interpreters?&quot; I have only done the tree-walk interpreter half of the book, but I&#x27;m already excited to move beyond Lox, and I&#x27;m curious to hear what others have done in this situation.</div><br/><div id="36181316" class="c"><input type="checkbox" id="c-36181316" checked=""/><div class="controls bullet"><span class="by">TwentyPosts</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36180425">next</a><span>|</span><label class="collapse" for="c-36181316">[-]</label><label class="expand" for="c-36181316">[2 more]</label></div><br/><div class="children"><div class="content">Personally, I found &quot;Writing an Interpreter in Go&quot; better than &quot;Crafting Interpreters&quot;. It has a follow-up book titled &quot;Writing a Compiler in Go&quot;, which (similar to Crafting Interpreter&#x27;s second half) implements a virtual machine. The books take a lot of inspiration from Crafting Interpreters.<p>If this sounds at all appealing to you, I would check it out. I found Monkey so far somewhat more compelling than Lox (might be personal preference, though), and I thought the exposition (and code quality) was overall better. Go is also very easy to pick up.</div><br/><div id="36183822" class="c"><input type="checkbox" id="c-36183822" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36181316">parent</a><span>|</span><a href="#36180425">next</a><span>|</span><label class="collapse" for="c-36183822">[-]</label><label class="expand" for="c-36183822">[1 more]</label></div><br/><div class="children"><div class="content">Thank you for the tip! Getting to implement a different language from Lox feels like a nice way to cut down on the tedium.</div><br/></div></div></div></div><div id="36180425" class="c"><input type="checkbox" id="c-36180425" checked=""/><div class="controls bullet"><span class="by">flofriday</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36181316">prev</a><span>|</span><a href="#36183276">next</a><span>|</span><label class="collapse" for="c-36180425">[-]</label><label class="expand" for="c-36180425">[1 more]</label></div><br/><div class="children"><div class="content">I continued by taking a compilers and a interpreters course at my university. In the interpreters course a friend and I desinged a new language and implemented it.
It turns out designing a language is pretty hard, but it was quite fun and am proud of the project. Also I really wanted to implement a typechecker, so we did that too.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;flofriday&#x2F;Moose">https:&#x2F;&#x2F;github.com&#x2F;flofriday&#x2F;Moose</a></div><br/></div></div><div id="36183276" class="c"><input type="checkbox" id="c-36183276" checked=""/><div class="controls bullet"><span class="by">mollerhoj</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36180425">prev</a><span>|</span><a href="#36179523">next</a><span>|</span><label class="collapse" for="c-36183276">[-]</label><label class="expand" for="c-36183276">[2 more]</label></div><br/><div class="children"><div class="content">I really wish Bob would write a “Crafting Type Checkers” sequel.</div><br/><div id="36183442" class="c"><input type="checkbox" id="c-36183442" checked=""/><div class="controls bullet"><span class="by">nextaccountic</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36183276">parent</a><span>|</span><a href="#36179523">next</a><span>|</span><label class="collapse" for="c-36183442">[-]</label><label class="expand" for="c-36183442">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s Types and Programming Languages by Benjamin Pierce</div><br/></div></div></div></div><div id="36179523" class="c"><input type="checkbox" id="c-36179523" checked=""/><div class="controls bullet"><span class="by">borodi</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36183276">prev</a><span>|</span><a href="#36183291">next</a><span>|</span><label class="collapse" for="c-36179523">[-]</label><label class="expand" for="c-36179523">[1 more]</label></div><br/><div class="children"><div class="content">You can try and build your own toy language for fun, or try to compile lox to some assembly&#x2F;llvm ir.<p>Another option is to try and contribute to an existing language (Julia ;) ).</div><br/></div></div><div id="36183291" class="c"><input type="checkbox" id="c-36183291" checked=""/><div class="controls bullet"><span class="by">xgdgsc</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36179523">prev</a><span>|</span><a href="#36180938">next</a><span>|</span><label class="collapse" for="c-36183291">[-]</label><label class="expand" for="c-36183291">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;github.com&#x2F;tshort&#x2F;StaticCompiler.jl&#x2F;issues&#x2F;59">https:&#x2F;&#x2F;github.com&#x2F;tshort&#x2F;StaticCompiler.jl&#x2F;issues&#x2F;59</a> Would working on this feasible?</div><br/></div></div><div id="36180938" class="c"><input type="checkbox" id="c-36180938" checked=""/><div class="controls bullet"><span class="by">endgame</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36183291">prev</a><span>|</span><a href="#36180319">next</a><span>|</span><label class="collapse" for="c-36180938">[-]</label><label class="expand" for="c-36180938">[1 more]</label></div><br/><div class="children"><div class="content">I just finished the bytecode interpreter side, and I have similar questions. The next areas of interest for me are reasonable AST representations in C and learning how to translate a semantics from a PL paper to a runtime. Anyone have any recommendations?</div><br/></div></div><div id="36180319" class="c"><input type="checkbox" id="c-36180319" checked=""/><div class="controls bullet"><span class="by">kwertzzz</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36180938">prev</a><span>|</span><a href="#36180819">next</a><span>|</span><label class="collapse" for="c-36180319">[-]</label><label class="expand" for="c-36180319">[5 more]</label></div><br/><div class="children"><div class="content">I am wondering why the julia lox interpreter is so slow. Could it be that there is a lot of type unstable code or could it be an issue with julia&#x27;s garbage collector? (I can relate to the comment that it is quite hard to find usable information from julia&#x27;s profiler).</div><br/><div id="36180961" class="c"><input type="checkbox" id="c-36180961" checked=""/><div class="controls bullet"><span class="by">adgjlsfhk1</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36180319">parent</a><span>|</span><a href="#36180819">next</a><span>|</span><label class="collapse" for="c-36180961">[-]</label><label class="expand" for="c-36180961">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;m pretty sure it is type instability. The faster way to do this would be with something like <a href="https:&#x2F;&#x2F;github.com&#x2F;YingboMa&#x2F;Unityper.jl">https:&#x2F;&#x2F;github.com&#x2F;YingboMa&#x2F;Unityper.jl</a> which would fix that. The problem with profiling unstable code in Julia is that it makes everything slow so the profiler will just show a big mess of everything being slow. We do need better resources, but I have no idea what they would like like.</div><br/><div id="36183748" class="c"><input type="checkbox" id="c-36183748" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36180961">parent</a><span>|</span><a href="#36181395">next</a><span>|</span><label class="collapse" for="c-36183748">[-]</label><label class="expand" for="c-36183748">[1 more]</label></div><br/><div class="children"><div class="content">I actually played with Unityper.jl and SumTypes.jl, but my conclusion was that if I was going to depart from dispatch on Julia types in my code, I might as well just stick to an untyped tree, since either way I&#x27;d have to have a single `evaluate` function for interpreting any kind of node.<p>Reconsidering now, it seems that there might be benefits beyond type dispatch to having a typed syntax tree, so maybe I&#x27;ll give that a shot as a next step!</div><br/></div></div><div id="36181395" class="c"><input type="checkbox" id="c-36181395" checked=""/><div class="controls bullet"><span class="by">nsajko</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36180961">parent</a><span>|</span><a href="#36183748">prev</a><span>|</span><a href="#36180819">next</a><span>|</span><label class="collapse" for="c-36181395">[-]</label><label class="expand" for="c-36181395">[2 more]</label></div><br/><div class="children"><div class="content">What do you mean by &quot;We do need better resources&quot;?</div><br/><div id="36183215" class="c"><input type="checkbox" id="c-36183215" checked=""/><div class="controls bullet"><span class="by">adgjlsfhk1</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36181395">parent</a><span>|</span><a href="#36180819">next</a><span>|</span><label class="collapse" for="c-36183215">[-]</label><label class="expand" for="c-36183215">[1 more]</label></div><br/><div class="children"><div class="content">There currently don&#x27;t exist great tools to figure out why type unstable code is slow. @code_warntype and Cthulhu can help find type stability problems, but they&#x27;re pretty hard to use for newer users (or big functions)</div><br/></div></div></div></div></div></div></div></div><div id="36180819" class="c"><input type="checkbox" id="c-36180819" checked=""/><div class="controls bullet"><span class="by">erichocean</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36180319">prev</a><span>|</span><a href="#36179667">next</a><span>|</span><label class="collapse" for="c-36180819">[-]</label><label class="expand" for="c-36180819">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;d do the second half of the book, it&#x27;s got plenty of important techniques that aren&#x27;t taught in the first half.<p>Once you&#x27;ve done that, you can see how it&#x27;s done &quot;for real&quot; in a production setting by reading the source code to Wren (by the same author). [0]<p>Wren&#x27;s implementation maps very closely to the C implementation of Lox.<p>At that point, you&#x27;re ready to do your own language. As far as compilation techniques go, you&#x27;ll still be missing the &quot;middle-end&quot; of the compiler, which uses an SSA IR. I don&#x27;t recommend implementing this yourself, I&#x27;d look into MLIR (from the LLVM project) if you want to actually work on the middle-end. You can create one or more dialects that are unique to your language, and implement your own compiler transformations. There are lots of existing papers and projects on GitHub demonstrating doing so.<p>[0] <a href="https:&#x2F;&#x2F;wren.io&#x2F;" rel="nofollow">https:&#x2F;&#x2F;wren.io&#x2F;</a></div><br/><div id="36183777" class="c"><input type="checkbox" id="c-36183777" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36180819">parent</a><span>|</span><a href="#36181480">next</a><span>|</span><label class="collapse" for="c-36183777">[-]</label><label class="expand" for="c-36183777">[1 more]</label></div><br/><div class="children"><div class="content">Thank you for the suggestions! I was actually just searching about MLIR today after reading some Julia language community discussions on the new Mojo language that uses MLIR.</div><br/></div></div><div id="36181480" class="c"><input type="checkbox" id="c-36181480" checked=""/><div class="controls bullet"><span class="by">cdcarter</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36180819">parent</a><span>|</span><a href="#36183777">prev</a><span>|</span><a href="#36179667">next</a><span>|</span><label class="collapse" for="c-36181480">[-]</label><label class="expand" for="c-36181480">[2 more]</label></div><br/><div class="children"><div class="content">I agree on the suggestion to do part two, it&#x27;s where things get really fun!<p>One thing you can do with the finished Lox (or Monkey, if you prefer WACIG) before going into the world of intermediate representations is implementing a peephole optimizer. You look for reducible patterns in the bytecode, and replace them with optimized bytecode. You can also look for certain patterns and replace naive implementations with native builtins&#x2F;intrinsics. You can work with the raw bytes of the bytecode, so you don&#x27;t need to introduce an IR just yet.<p>The Apex compiler at Salesforce does a vast majority of its optimizations as peeps.<p>EDIT: I _just_ wrote another comment to someone asking similar questions a few days ago. Here&#x27;s a link to the parent question, check out my thoughts as well as others in the thread. <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36119915" rel="nofollow">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36119915</a></div><br/><div id="36183808" class="c"><input type="checkbox" id="c-36183808" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36161130">root</a><span>|</span><a href="#36181480">parent</a><span>|</span><a href="#36179667">next</a><span>|</span><label class="collapse" for="c-36183808">[-]</label><label class="expand" for="c-36183808">[1 more]</label></div><br/><div class="children"><div class="content">Wow, the whole concept of a peephole optimizer is a bit mind blowing to me. I&#x27;m appreciating all the reasons to power through to writing a bytecode VM as the next step.<p>I&#x27;m not sure how far down the compiler I actually will enjoy going vs. exploring ideas around type systems, linters, etc. up near the AST level, but if I do venture down this advice will certainly come in handy!</div><br/></div></div></div></div></div></div><div id="36179667" class="c"><input type="checkbox" id="c-36179667" checked=""/><div class="controls bullet"><span class="by">latenightcoding</span><span>|</span><a href="#36161130">parent</a><span>|</span><a href="#36180819">prev</a><span>|</span><a href="#36163271">next</a><span>|</span><label class="collapse" for="c-36179667">[-]</label><label class="expand" for="c-36179667">[1 more]</label></div><br/><div class="children"><div class="content">a fast lisp interpreter&#x2F;compiler?</div><br/></div></div></div></div><div id="36163271" class="c"><input type="checkbox" id="c-36163271" checked=""/><div class="controls bullet"><span class="by">sundarurfriend</span><span>|</span><a href="#36161130">prev</a><span>|</span><a href="#36181246">next</a><span>|</span><label class="collapse" for="c-36163271">[-]</label><label class="expand" for="c-36163271">[2 more]</label></div><br/><div class="children"><div class="content">I thought working with the lossless syntax tree was the key to Rust&#x27;s pin-point precise error messages. How does rust-analyzer get and print the specific point of error if it throws away the non-essential information before that stage? I suppose the position information is stored along with the Error nodes, in the original parsing?</div><br/><div id="36178230" class="c"><input type="checkbox" id="c-36178230" checked=""/><div class="controls bullet"><span class="by">lukemerrick</span><span>|</span><a href="#36163271">parent</a><span>|</span><a href="#36181246">next</a><span>|</span><label class="collapse" for="c-36178230">[-]</label><label class="expand" for="c-36178230">[1 more]</label></div><br/><div class="children"><div class="content">In general, if you keep the source code positions of every nontrivial token, and you keep the raw source code, then yeah you can print out those pretty specific point error messages regardless of whether you keep your trees lossless. Also, if you want to include filename in your messages (perhaps because unlike Lox your language supports imports), then you&#x27;ll need more than just lossless trees to store the necessary information.<p>I&#x27;m not sure exactly how Rust and rust-analyzer keep track of the info necessary to their excellent error messages and diagnostics, but I wouldn&#x27;t be surprised if pinpoint messages were not the primary motivation for rust-analyzer to do lossless parsing.</div><br/></div></div></div></div><div id="36181246" class="c"><input type="checkbox" id="c-36181246" checked=""/><div class="controls bullet"><span class="by">yeison</span><span>|</span><a href="#36163271">prev</a><span>|</span><label class="collapse" for="c-36181246">[-]</label><label class="expand" for="c-36181246">[1 more]</label></div><br/><div class="children"><div class="content">Now we need a cream cheese interpreter and we&#x27;ll be all set.</div><br/></div></div></div></div></div></div></div></body></html>