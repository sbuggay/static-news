<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1725872472874" as="style"/><link rel="stylesheet" href="styles.css?v=1725872472874"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://tookmund.com/2024/09/hibernation-preparation">Linux&#x27;s Bedtime Routine</a>Â <span class="domain">(<a href="https://tookmund.com">tookmund.com</a>)</span></div><div class="subtext"><span>JNRowe</span> | <span>12 comments</span></div><br/><div><div id="41485100" class="c"><input type="checkbox" id="c-41485100" checked=""/><div class="controls bullet"><span class="by">nyanpasu64</span><span>|</span><a href="#41484722">next</a><span>|</span><label class="collapse" for="c-41485100">[-]</label><label class="expand" for="c-41485100">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve done some digging in Linux power management a while ago, while debugging a (not-fully-fixed) Linux AMDGPU dGPU crash on low memory (<a href="https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;drm&#x2F;amd&#x2F;-&#x2F;issues&#x2F;2362" rel="nofollow">https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;drm&#x2F;amd&#x2F;-&#x2F;issues&#x2F;2362</a>). Along the way, I discovered that you can hibernate <i>both</i> through &#x2F;sys&#x2F;power&#x2F;disk, and the userland snapshot&#x2F;hibernate&#x2F;suspend interface (<a href="https:&#x2F;&#x2F;docs.kernel.org&#x2F;power&#x2F;userland-swsusp.html" rel="nofollow">https:&#x2F;&#x2F;docs.kernel.org&#x2F;power&#x2F;userland-swsusp.html</a>, snapshot_ioctl()). IIRC these two mechanisms go along quite different codepaths internally.<p>The specific crash bug I encountered was because Linux calls pm_restrict_gfp_mask() to prevent swapping to disk, <i>before</i> dpm_prepare() (the first opportunity for a GPU driver to backup VRAM to system RAM before the PCIe GPU is shut down and VRAM is lost). So if you don&#x27;t have enough free system RAM to hold all VRAM, the sleep is aborted midway through (waking the system) or produces a failed memory allocation later during sleep or resume (often resulting in undefined system state, halted network or USB controllers, or worst yet a halted NVMe controller resulting in the system running around like a headless chicken unable to load data from disk or <i>even log data to the journal</i>). I&#x27;m wondering if this was a deliberate decision or an unforeseen interaction between suspend-time GFP masks and GPU drivers.<p>It seems Nvidia can&#x27;t reliably backup VRAM either without being informed by systemd prior to the kernel initiating suspend (<a href="https:&#x2F;&#x2F;download.nvidia.com&#x2F;XFree86&#x2F;Linux-x86_64&#x2F;560.35.03&#x2F;README&#x2F;powermanagement.html" rel="nofollow">https:&#x2F;&#x2F;download.nvidia.com&#x2F;XFree86&#x2F;Linux-x86_64&#x2F;560.35.03&#x2F;R...</a>).</div><br/><div id="41486256" class="c"><input type="checkbox" id="c-41486256" checked=""/><div class="controls bullet"><span class="by">nubinetwork</span><span>|</span><a href="#41485100">parent</a><span>|</span><a href="#41484722">next</a><span>|</span><label class="collapse" for="c-41486256">[-]</label><label class="expand" for="c-41486256">[1 more]</label></div><br/><div class="children"><div class="content">In a way, I&#x27;m not surprised... when I reboot my systemd-based servers, it almost seems like (based on speed) that it didn&#x27;t do anything to the running services and filesystems, and just tells the kernel to immediately reboot.</div><br/></div></div></div></div><div id="41484722" class="c"><input type="checkbox" id="c-41484722" checked=""/><div class="controls bullet"><span class="by">heavyset_go</span><span>|</span><a href="#41485100">prev</a><span>|</span><a href="#41485039">next</a><span>|</span><label class="collapse" for="c-41484722">[-]</label><label class="expand" for="c-41484722">[1 more]</label></div><br/><div class="children"><div class="content">This is a great write up that goes deeper than I expected it to. Glad to have seen it.</div><br/></div></div><div id="41485039" class="c"><input type="checkbox" id="c-41485039" checked=""/><div class="controls bullet"><span class="by">pino82</span><span>|</span><a href="#41484722">prev</a><span>|</span><label class="collapse" for="c-41485039">[-]</label><label class="expand" for="c-41485039">[8 more]</label></div><br/><div class="children"><div class="content">I just read the first few lines so far. They play around a lot with strings, compared to the fact that it&#x27;s not about word processing but power management.<p>I&#x27;m not a developer on this system level of things. When you usually try to write &#x27;nice&#x27; code, you are somewhat surprised about concerns like &quot;convert the last space to a newline&quot; there.<p>Yes, I know, everything is a file, and this is just the other side of this odd ancient paradigm.<p>To me it looks tedious. But, well, could be that this is just for me, because I&#x27;m not used to it. Maybe it&#x27;s not a problem at all once you are deeper inside it.<p>But even from a logical perspective, it is funny: There is a file that contains all available sleep modes. Once you write a particular one into the same file (let&#x27;s say you open it in a text editor and remove all states but one and then save), the system goes into that sleep mode.<p>Yes, I know, operating systems are different from a tiny web service in Python (and even there you start tricking around with weird http concepts instead)... It was just an observation.</div><br/><div id="41485158" class="c"><input type="checkbox" id="c-41485158" checked=""/><div class="controls bullet"><span class="by">telgareith</span><span>|</span><a href="#41485039">parent</a><span>|</span><a href="#41485140">next</a><span>|</span><label class="collapse" for="c-41485158">[-]</label><label class="expand" for="c-41485158">[6 more]</label></div><br/><div class="children"><div class="content">I&#x27;m not sure where you&#x27;re coming from here.<p>&quot;Everything is a file&quot; is literally part of the design philosophy.<p>Thats all it is: design philosophy. Well, besides improper string termination being the root of a staggering number of vulnerabilities.<p>There&#x27;s nothing keeping somebody in either windows or linux from writing kernel code&#x2F;drivers that takes syscalls instead of text, or text instead of syscalls. Except microsoft and the linux community would both decline to include it.</div><br/><div id="41485301" class="c"><input type="checkbox" id="c-41485301" checked=""/><div class="controls bullet"><span class="by">nyanpasu64</span><span>|</span><a href="#41485039">root</a><span>|</span><a href="#41485158">parent</a><span>|</span><a href="#41485315">next</a><span>|</span><label class="collapse" for="c-41485301">[-]</label><label class="expand" for="c-41485301">[1 more]</label></div><br/><div class="children"><div class="content">The funny thing is that Linux <i>does</i> have an alternative ioctl-based suspend interface (<a href="https:&#x2F;&#x2F;docs.kernel.org&#x2F;power&#x2F;userland-swsusp.html" rel="nofollow">https:&#x2F;&#x2F;docs.kernel.org&#x2F;power&#x2F;userland-swsusp.html</a>)... with an incompatible API and different purpose from the string-based one...</div><br/></div></div><div id="41485315" class="c"><input type="checkbox" id="c-41485315" checked=""/><div class="controls bullet"><span class="by">pino82</span><span>|</span><a href="#41485039">root</a><span>|</span><a href="#41485158">parent</a><span>|</span><a href="#41485301">prev</a><span>|</span><a href="#41485308">next</a><span>|</span><label class="collapse" for="c-41485315">[-]</label><label class="expand" for="c-41485315">[2 more]</label></div><br/><div class="children"><div class="content">At first glance, the Redmond philosophy looks better to me here. I know that they made a lot of marketing around it (files vs APIs). And parts of that is just marketing bs, but there is some truth imho. What is all the string overhead really for? Isn&#x27;t the client side equally tedious? You write e.g. weird shell scripts that sed&#x2F;awk&#x2F;grep some files from procfs or sysfs, spend a lot of time into string parsing, and then there are also corner cases where it fails (sometimes it&#x27;s enough to have a space in some file names). What do I actually get back from all that complexity? There is probably something; I just haven&#x27;t recognized it so far.<p>I&#x27;m asking that as a Linux-only-since-two-decades user btw.</div><br/><div id="41486360" class="c"><input type="checkbox" id="c-41486360" checked=""/><div class="controls bullet"><span class="by">ahartmetz</span><span>|</span><a href="#41485039">root</a><span>|</span><a href="#41485315">parent</a><span>|</span><a href="#41485308">next</a><span>|</span><label class="collapse" for="c-41486360">[-]</label><label class="expand" for="c-41486360">[1 more]</label></div><br/><div class="children"><div class="content">&gt; What do I actually get back from all that complexity?<p>Very easy experimentation &#x2F; exploration, extremely rapid prototyping and one-off scripts.<p>I have written a GUI program to show memory pages of a process using procfs, it was fine. About two days of effort to parse and piece together data from obscure procfs files. A well-documented API with example code would have been faster I guess, but a text format with minimal documentation is OK.</div><br/></div></div></div></div><div id="41485308" class="c"><input type="checkbox" id="c-41485308" checked=""/><div class="controls bullet"><span class="by">LegionMammal978</span><span>|</span><a href="#41485039">root</a><span>|</span><a href="#41485158">parent</a><span>|</span><a href="#41485315">prev</a><span>|</span><a href="#41485140">next</a><span>|</span><label class="collapse" for="c-41485308">[-]</label><label class="expand" for="c-41485308">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Except microsoft and the linux community would both decline to include it.<p>And yet the number of syscalls and ioctls expands nonetheless. E.g., in Linux, they just last year added the listmount() and statmount() syscalls, even though they return substantially the same information as &#x2F;proc&#x2F;self&#x2F;mountinfo, since the latter simply can&#x27;t be queried as flexibly.</div><br/><div id="41485321" class="c"><input type="checkbox" id="c-41485321" checked=""/><div class="controls bullet"><span class="by">pino82</span><span>|</span><a href="#41485039">root</a><span>|</span><a href="#41485308">parent</a><span>|</span><a href="#41485140">next</a><span>|</span><label class="collapse" for="c-41485321">[-]</label><label class="expand" for="c-41485321">[1 more]</label></div><br/><div class="children"><div class="content">Cooool! Thx! I recently searched precisely for that, but was unable to find anything.</div><br/></div></div></div></div></div></div><div id="41485140" class="c"><input type="checkbox" id="c-41485140" checked=""/><div class="controls bullet"><span class="by">pino82</span><span>|</span><a href="#41485039">parent</a><span>|</span><a href="#41485158">prev</a><span>|</span><label class="collapse" for="c-41485140">[-]</label><label class="expand" for="c-41485140">[1 more]</label></div><br/><div class="children"><div class="content">PS: Yes, I know, if it would be a web api, I&#x27;d need to do play the same games with strings there.<p>But there it&#x27;s at least obvious why it is needed (and it would also be less tedious in a modern scripting language, compared to dealing with string in raw C).<p>Again, I&#x27;m not really complaining. I&#x27;m just wondering whether one would still solve it in the same today in a brand new OS.</div><br/></div></div></div></div></div></div></div></div></div></body></html>