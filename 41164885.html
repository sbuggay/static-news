<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1722934862187" as="style"/><link rel="stylesheet" href="styles.css?v=1722934862187"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://sunshowers.io/posts/rustc-segfault-illumos/">Debugging a rustc segfault on Illumos</a> <span class="domain">(<a href="https://sunshowers.io">sunshowers.io</a>)</span></div><div class="subtext"><span>steveklabnik</span> | <span>26 comments</span></div><br/><div><div id="41168988" class="c"><input type="checkbox" id="c-41168988" checked=""/><div class="controls bullet"><span class="by">fch42</span><span>|</span><a href="#41164528">next</a><span>|</span><label class="collapse" for="c-41168988">[-]</label><label class="expand" for="c-41168988">[1 more]</label></div><br/><div class="children"><div class="content">Man this brings back so many memories :-)<p>Definitely a fun read. Debugging crashes has, in the last decade or so, become something a bit like a &quot;lost art&quot;. Noone looks at coredumps in the cloud ...<p>I don&#x27;t want to outdo you on Solaris debugging (plenty of old-time Solaris folks at Oxide who are totally capable to show how to get things like open files and their contents from a coredump, or how to configure the system to include those should it not be there ... etc ... etc ... Solaris has the best coredumps for all that&#x27;s worth ...).<p>A note on the fix side of things though, while adding pthread_get_attr_np() for stack location&#x2F;size gives Solaris the Linux interface, it already has its own for those - pthread_attr_getstack{size,addt}(), see <a href="https:&#x2F;&#x2F;docs.oracle.com&#x2F;cd&#x2F;E19455-01&#x2F;806-5257&#x2F;6je9h032l&#x2F;index.html" rel="nofollow">https:&#x2F;&#x2F;docs.oracle.com&#x2F;cd&#x2F;E19455-01&#x2F;806-5257&#x2F;6je9h032l&#x2F;inde...</a> - I happen to remember this because I used this decades ago somewhere in the Solaris name lookup code to choose at runtime between using alloca() and malloc() ... don&#x27;t ask. Those were different times.</div><br/></div></div><div id="41164528" class="c"><input type="checkbox" id="c-41164528" checked=""/><div class="controls bullet"><span class="by">bcantrill</span><span>|</span><a href="#41168988">prev</a><span>|</span><a href="#41166705">next</a><span>|</span><label class="collapse" for="c-41164528">[-]</label><label class="expand" for="c-41164528">[7 more]</label></div><br/><div class="children"><div class="content">I am (obviously?) biased, but this is a great read by Rain, as it takes the reader through not just some of the illumos tooling, but also how compilers need to bootstrap themselves -- and why heterogeneous platforms are important. (As Rain elaborates in the piece, this issue was seen on illumos, but is in fact lurking on other platforms.)</div><br/><div id="41166300" class="c"><input type="checkbox" id="c-41166300" checked=""/><div class="controls bullet"><span class="by">sctb</span><span>|</span><a href="#41164528">parent</a><span>|</span><a href="#41164600">next</a><span>|</span><label class="collapse" for="c-41166300">[-]</label><label class="expand" for="c-41166300">[2 more]</label></div><br/><div class="children"><div class="content">These are easily one of my favourite types of posts (and this one was particularly gratifying). I wish I could go down these rabbit holes every day!<p>&gt; [...] and why heterogeneous platforms are important<p>This prompts me to wonder vaguely whether there&#x27;s any untapped juice in fuzzing approaches that might be relevant here. As in, how much of the platform (including configuration and heuristics, and so on) could be fuzzed as program input?</div><br/><div id="41166464" class="c"><input type="checkbox" id="c-41166464" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41164528">root</a><span>|</span><a href="#41166300">parent</a><span>|</span><a href="#41164600">next</a><span>|</span><label class="collapse" for="c-41166464">[-]</label><label class="expand" for="c-41166464">[1 more]</label></div><br/><div class="children"><div class="content">Thank you, glad you appreciated the post! I love writing up debugging&#x2F;incident reports and this one was just really fun.<p>Regarding fuzzing... maybe? I&#x27;ve wondered that a couple of times myself but in reality there are really just a finite number of platforms, and so much of this is determined at compile time by library call availability. But I&#x27;m probably not thinking as deeply about this as someone could be, and I&#x27;d be interested to hear other folks&#x27; thoughts.</div><br/></div></div></div></div><div id="41164600" class="c"><input type="checkbox" id="c-41164600" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41164528">parent</a><span>|</span><a href="#41166300">prev</a><span>|</span><a href="#41166705">next</a><span>|</span><label class="collapse" for="c-41164600">[-]</label><label class="expand" for="c-41164600">[4 more]</label></div><br/><div class="children"><div class="content">Thanks for the kind words, Bryan! The illumos debugging tools continue to blow my mind.</div><br/><div id="41165927" class="c"><input type="checkbox" id="c-41165927" checked=""/><div class="controls bullet"><span class="by">neerajsi</span><span>|</span><a href="#41164528">root</a><span>|</span><a href="#41164600">parent</a><span>|</span><a href="#41166705">next</a><span>|</span><label class="collapse" for="c-41165927">[-]</label><label class="expand" for="c-41165927">[3 more]</label></div><br/><div class="children"><div class="content">It makes me wonder though if illumos is worth it for a relatively small company to maintain. This bug came out of the larger ecosystem not knowing what to do for a niche OS.</div><br/><div id="41166082" class="c"><input type="checkbox" id="c-41166082" checked=""/><div class="controls bullet"><span class="by">steveklabnik</span><span>|</span><a href="#41164528">root</a><span>|</span><a href="#41165927">parent</a><span>|</span><a href="#41166140">next</a><span>|</span><label class="collapse" for="c-41166082">[-]</label><label class="expand" for="c-41166082">[1 more]</label></div><br/><div class="children"><div class="content">What we&#x27;re doing inherently requires deep integration up and down the stack. We&#x27;d still have to be doing OS-level work even if we used another operating system. But then we&#x27;d be at the mercy of upstream of accepting patches, or keeping our own fork, and at that point, you&#x27;re basically at the same spot we are now, but with less overall control.<p>RFD 26 talked about the context around this choice: <a href="https:&#x2F;&#x2F;rfd.shared.oxide.computer&#x2F;rfd&#x2F;0026" rel="nofollow">https:&#x2F;&#x2F;rfd.shared.oxide.computer&#x2F;rfd&#x2F;0026</a><p>There&#x27;s a lot more to it than just this one thing I mentioned :)</div><br/></div></div><div id="41166140" class="c"><input type="checkbox" id="c-41166140" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41164528">root</a><span>|</span><a href="#41165927">parent</a><span>|</span><a href="#41166082">prev</a><span>|</span><a href="#41166705">next</a><span>|</span><label class="collapse" for="c-41166140">[-]</label><label class="expand" for="c-41166140">[1 more]</label></div><br/><div class="children"><div class="content">On top of what Steve said, illumos does support all of the required APIs here, but the Rust libc crate was just missing definitions for them. It&#x27;s not a tremendously exotic platform the way something like Haiku is.<p>Edit: also worth pointing out (again) that the bug actually exists everywhere -- it was just being masked on the other platforms.</div><br/></div></div></div></div></div></div></div></div><div id="41166705" class="c"><input type="checkbox" id="c-41166705" checked=""/><div class="controls bullet"><span class="by">deathanatos</span><span>|</span><a href="#41164528">prev</a><span>|</span><a href="#41168381">next</a><span>|</span><label class="collapse" for="c-41166705">[-]</label><label class="expand" for="c-41166705">[2 more]</label></div><br/><div class="children"><div class="content">(heavily paraphrasing)<p>&gt; <i>[the core dump is supposed to be in the CWD, and named core, but isn&#x27;t; what gives?]</i><p>Followed by,<p><pre><code>  $ find &#x2F; -name core -type f
</code></pre>
Is a sort of hilarious brute force solution. But it demonstrates a particular kind of problem, where<p><pre><code>  &#x2F;-- requires -- evidence
  |                   ^
  v                   |
  answer -- requires -&#x2F;
</code></pre>
These are pesky. The brute force search is a good idea, in that it breaks that cycle of almost needing to know the answer in order to discover it. (Unless you can surmise that the CWD is the crate dir, but let&#x27;s assume that we don&#x27;t want to depend on having such a moment of sheet &quot;eureka!&quot;.)<p>&gt; <i>But there are also other bits of evidence that this theory doesn’t explain, or even cuts against. (This is what makes post-mortem debugging exciting! There are often contradictory-seeming pieces of information that need to be explained.)</i><p>I wish more people appreciated this; too many people are apt to sweet such discrepancies under the rug. This post does a good job on not just following through on them, but also showing how figuring some of them out (&quot;why is our stack weird?&quot;) leads to the key insights: &quot;oh we&#x27;re using stacker and … $the_bug&quot;.<p>I do wonder how the author managed to notice that line in a 1.5k line stack trace, though. The &quot;abrupt&quot; address change would have probably gone unnoticed by me. (The only saving grace being a.) it&#x27;s close to the bottom b.) most of the rest is repetitive, an artifact of a recursive descent parser recursing, and if we just consider that repetition &quot;one chunk&quot;, it gets a lot smaller. I still dunno if I&#x27;d&#x27;ve seen it, though.)</div><br/><div id="41166756" class="c"><input type="checkbox" id="c-41166756" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41166705">parent</a><span>|</span><a href="#41168381">next</a><span>|</span><label class="collapse" for="c-41166756">[-]</label><label class="expand" for="c-41166756">[1 more]</label></div><br/><div class="children"><div class="content">It was actually my coworker Joshua who first noticed that, and then that dredged up a long-forgotten memory in me of having seen stacker on crates.io. Many eyes make bugs shallow!<p>Agree about the power of brute force solutions! When you&#x27;re struggling to get a foothold, those kinds of approaches are extremely helpful. For the cwd thing specifically, it was clear in hindsight, and I should have known about it (having written nextest which has to handle crate cwds carefully). But I don&#x27;t beat myself up too much over it, and now I know where to look next time this happens.</div><br/></div></div></div></div><div id="41168381" class="c"><input type="checkbox" id="c-41168381" checked=""/><div class="controls bullet"><span class="by">rnd0</span><span>|</span><a href="#41166705">prev</a><span>|</span><a href="#41167293">next</a><span>|</span><label class="collapse" for="c-41168381">[-]</label><label class="expand" for="c-41168381">[2 more]</label></div><br/><div class="children"><div class="content">Pleasantly surprised to see Illumos ...anywhere.</div><br/><div id="41168562" class="c"><input type="checkbox" id="c-41168562" checked=""/><div class="controls bullet"><span class="by">leoh</span><span>|</span><a href="#41168381">parent</a><span>|</span><a href="#41167293">next</a><span>|</span><label class="collapse" for="c-41168562">[-]</label><label class="expand" for="c-41168562">[1 more]</label></div><br/><div class="children"><div class="content">they really need a downloadable arm64 build</div><br/></div></div></div></div><div id="41167293" class="c"><input type="checkbox" id="c-41167293" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#41168381">prev</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41167293">[-]</label><label class="expand" for="c-41167293">[7 more]</label></div><br/><div class="children"><div class="content">To rustc not calling stacker enough&#x2F;at the right times, the behaviour on MSVC&#x2F;Windows is for the compiler to rely on hitting the OS&#x27;s guard page to extend the stack (rather than growing it yourself), but also for the compiler to emit a special routine in any function that uses more than a page of stack frame (to make sure the first thing the function does is poke every page in order, so the OS can grow the stack the right amount).</div><br/><div id="41167501" class="c"><input type="checkbox" id="c-41167501" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41167293">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41167501">[-]</label><label class="expand" for="c-41167501">[6 more]</label></div><br/><div class="children"><div class="content">I believe that&#x27;s how rustc works on all platforms. rustc&#x27;s soundness story depends on each call stack having one guard page, and ensuring that each time a frame is created every page gets poked at least once.</div><br/><div id="41167556" class="c"><input type="checkbox" id="c-41167556" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#41167293">root</a><span>|</span><a href="#41167501">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41167556">[-]</label><label class="expand" for="c-41167556">[5 more]</label></div><br/><div class="children"><div class="content">Oh, is stacker requesting stack growth that otherwise wouldn&#x27;t happen? I always just assume address space reservations are cheap&#x2F;free, and you can just mark a heap (hah) of space for your stacks. I guess it also has the behaviour that you&#x27;ll find out which programs are stack hogs earlier.</div><br/><div id="41167574" class="c"><input type="checkbox" id="c-41167574" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41167293">root</a><span>|</span><a href="#41167556">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41167574">[-]</label><label class="expand" for="c-41167574">[4 more]</label></div><br/><div class="children"><div class="content">Yes, stacker has to be called explicitly, and in the case of an arbitrarily recursive program at each N recursion levels -- it&#x27;s not something like a signal handler that sits in the background and gets activated when the thread runs out of stack space.</div><br/><div id="41167601" class="c"><input type="checkbox" id="c-41167601" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#41167293">root</a><span>|</span><a href="#41167574">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41167601">[-]</label><label class="expand" for="c-41167601">[3 more]</label></div><br/><div class="children"><div class="content">It&#x27;s funny the parallel of &quot;detect when the mapped stack region is exhausted, and map the next page&quot; and &quot;detect when the stack region is&#x2F;will exhaust, and reserve&#x2F;allocate another region&quot;</div><br/><div id="41168160" class="c"><input type="checkbox" id="c-41168160" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41167293">root</a><span>|</span><a href="#41167601">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41168160">[-]</label><label class="expand" for="c-41168160">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, I was thinking about that myself.<p>This post suggests that actually growing the stack automatically may just be very difficult with standard POSIX APIs: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36020073">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=36020073</a><p>The Rust runtime installs a SIGSEGV handler but it&#x27;s purely informative, and it can be overridden without affecting correctness.</div><br/><div id="41168666" class="c"><input type="checkbox" id="c-41168666" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#41167293">root</a><span>|</span><a href="#41168160">parent</a><span>|</span><a href="#41166754">next</a><span>|</span><label class="collapse" for="c-41168666">[-]</label><label class="expand" for="c-41168666">[1 more]</label></div><br/><div class="children"><div class="content">I took a brief look into Windows public API, even with a tight coupling between compiler&#x2F;toolchain &amp; OS they don&#x27;t offer a way to increase the region for a stack after a thread has been created.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div id="41166754" class="c"><input type="checkbox" id="c-41166754" checked=""/><div class="controls bullet"><span class="by">sbt567</span><span>|</span><a href="#41167293">prev</a><span>|</span><a href="#41163573">next</a><span>|</span><label class="collapse" for="c-41166754">[-]</label><label class="expand" for="c-41166754">[1 more]</label></div><br/><div class="children"><div class="content">Amazing read! This article beautifully guides you through each step and make sure you did get enough context for the next step. Bookmarking this!</div><br/></div></div><div id="41163573" class="c"><input type="checkbox" id="c-41163573" checked=""/><div class="controls bullet"><span class="by">jrpelkonen</span><span>|</span><a href="#41166754">prev</a><span>|</span><a href="#41166361">next</a><span>|</span><label class="collapse" for="c-41163573">[-]</label><label class="expand" for="c-41163573">[1 more]</label></div><br/><div class="children"><div class="content">This is a very interesting and thorough investigation. Highly recommended!</div><br/></div></div><div id="41166361" class="c"><input type="checkbox" id="c-41166361" checked=""/><div class="controls bullet"><span class="by">shrubble</span><span>|</span><a href="#41163573">prev</a><span>|</span><label class="collapse" for="c-41166361">[-]</label><label class="expand" for="c-41166361">[4 more]</label></div><br/><div class="children"><div class="content">Curious if truss , which was used, or Dtrace would give you the syscalls in a nicer format for this application?</div><br/><div id="41166461" class="c"><input type="checkbox" id="c-41166461" checked=""/><div class="controls bullet"><span class="by">sunshowers</span><span>|</span><a href="#41166361">parent</a><span>|</span><label class="collapse" for="c-41166461">[-]</label><label class="expand" for="c-41166461">[3 more]</label></div><br/><div class="children"><div class="content">DTrace allows a bunch of nicer filtering (for example by process name, or by function in call stack), but in this case truss was just a no-brainer. I&#x27;m not as comfortable with DTrace yet as I&#x27;d like to be!</div><br/><div id="41166507" class="c"><input type="checkbox" id="c-41166507" checked=""/><div class="controls bullet"><span class="by">shrubble</span><span>|</span><a href="#41166361">root</a><span>|</span><a href="#41166461">parent</a><span>|</span><label class="collapse" for="c-41166507">[-]</label><label class="expand" for="c-41166507">[2 more]</label></div><br/><div class="children"><div class="content">The truss tool has been around for about 30 years, so nothing wrong with sticking with the classics!</div><br/><div id="41166854" class="c"><input type="checkbox" id="c-41166854" checked=""/><div class="controls bullet"><span class="by">glandium</span><span>|</span><a href="#41166361">root</a><span>|</span><a href="#41166507">parent</a><span>|</span><label class="collapse" for="c-41166854">[-]</label><label class="expand" for="c-41166854">[1 more]</label></div><br/><div class="children"><div class="content">Implementation-wise, didn&#x27;t Solaris adopt dtruss (dtrace-based truss) as truss at some point (and thus Illumos)?</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>