<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1738659674228" as="style"/><link rel="stylesheet" href="styles.css?v=1738659674228"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://irreducible.io/blog/my-wasm-interpreter/">I Wrote a WebAssembly VM in C</a>Â <span class="domain">(<a href="https://irreducible.io">irreducible.io</a>)</span></div><div class="subtext"><span>irreducible</span> | <span>64 comments</span></div><br/><div><div id="42919825" class="c"><input type="checkbox" id="c-42919825" checked=""/><div class="controls bullet"><span class="by">davexunit</span><span>|</span><a href="#42919253">next</a><span>|</span><label class="collapse" for="c-42919825">[-]</label><label class="expand" for="c-42919825">[1 more]</label></div><br/><div class="children"><div class="content">This was a fun read! I wrote a Wasm interpreter in Scheme awhile back so it makes me happy to see more people writing their own. It is less difficult than you might think. I encourage others to give the spec a look and give it a try. No need to implement every instruction, just enough to have fun.</div><br/></div></div><div id="42919253" class="c"><input type="checkbox" id="c-42919253" checked=""/><div class="controls bullet"><span class="by">whizzter</span><span>|</span><a href="#42919825">prev</a><span>|</span><a href="#42928124">next</a><span>|</span><label class="collapse" for="c-42919253">[-]</label><label class="expand" for="c-42919253">[3 more]</label></div><br/><div class="children"><div class="content">One tip for the author from another one, the spec-test contains various weird forms of textual wasm that isn&#x27;t obvious how to compile but the wast2json converter can produce a simpler JSON desc accompanies by regular binary wasm files.</div><br/><div id="42919316" class="c"><input type="checkbox" id="c-42919316" checked=""/><div class="controls bullet"><span class="by">bhelx</span><span>|</span><a href="#42919253">parent</a><span>|</span><a href="#42928128">next</a><span>|</span><label class="collapse" for="c-42919316">[-]</label><label class="expand" for="c-42919316">[1 more]</label></div><br/><div class="children"><div class="content">Same tip here. We did this with Chicory: <a href="https:&#x2F;&#x2F;github.com&#x2F;dylibso&#x2F;chicory">https:&#x2F;&#x2F;github.com&#x2F;dylibso&#x2F;chicory</a><p>I&#x27;d follow on that, the earlier you can get this test-suite running the better for the iteration speed and correctness of your project.<p>It took a bit of time to make everything work, but once we did, we very quickly got to the point of running anything. The test-suite is certainly incomplete but gets you 95% there: <a href="https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;testsuite">https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;testsuite</a></div><br/></div></div><div id="42928128" class="c"><input type="checkbox" id="c-42928128" checked=""/><div class="controls bullet"><span class="by">_cogg</span><span>|</span><a href="#42919253">parent</a><span>|</span><a href="#42919316">prev</a><span>|</span><a href="#42928124">next</a><span>|</span><label class="collapse" for="c-42928128">[-]</label><label class="expand" for="c-42928128">[1 more]</label></div><br/><div class="children"><div class="content">Thank you! Not the author, but I&#x27;m also building a compiler. I&#x27;ve stumbled across these tests before and mostly just been irritated and confused about what to do with them.</div><br/></div></div></div></div><div id="42928124" class="c"><input type="checkbox" id="c-42928124" checked=""/><div class="controls bullet"><span class="by">doctor_radium</span><span>|</span><a href="#42919253">prev</a><span>|</span><a href="#42927093">next</a><span>|</span><label class="collapse" for="c-42928124">[-]</label><label class="expand" for="c-42928124">[1 more]</label></div><br/><div class="children"><div class="content">Newbie questions:<p>How do you debug an interpreter when you aren&#x27;t coding for it directly? How far does fuzzing strings of opcodes get you?<p>How much practical difference is there between a server side WASM engine and a browser-based one? How much work would be involved converting one to the other?</div><br/></div></div><div id="42927093" class="c"><input type="checkbox" id="c-42927093" checked=""/><div class="controls bullet"><span class="by">dapperdrake</span><span>|</span><a href="#42928124">prev</a><span>|</span><a href="#42919215">next</a><span>|</span><label class="collapse" for="c-42927093">[-]</label><label class="expand" for="c-42927093">[2 more]</label></div><br/><div class="children"><div class="content">Here is a more controversial point:
Are you interested in adding a preliminary tail-call instruction?<p>The WASM spec people rejected it for being too &quot;high-level&quot;.  But the C committee also rejected proposals from Dennis Ritchie.  My money is still on Ritchie.  Rob Pike&#x27;s money seems to be on Ritchie direction as well.  Otherwise, why create Golang?<p>Tail-calls are only high-level if calls are high-level.</div><br/><div id="42928157" class="c"><input type="checkbox" id="c-42928157" checked=""/><div class="controls bullet"><span class="by">tlively</span><span>|</span><a href="#42927093">parent</a><span>|</span><a href="#42919215">next</a><span>|</span><label class="collapse" for="c-42928157">[-]</label><label class="expand" for="c-42928157">[1 more]</label></div><br/><div class="children"><div class="content">The WebAssembly tail call proposal has been accepted, finished, and implemented for over two years now. <a href="https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;meetings&#x2F;blob&#x2F;main&#x2F;main&#x2F;2023&#x2F;CG-01-17.md">https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;meetings&#x2F;blob&#x2F;main&#x2F;main&#x2F;2023&#x2F;...</a></div><br/></div></div></div></div><div id="42919215" class="c"><input type="checkbox" id="c-42919215" checked=""/><div class="controls bullet"><span class="by">pcmoore</span><span>|</span><a href="#42927093">prev</a><span>|</span><a href="#42918980">next</a><span>|</span><label class="collapse" for="c-42919215">[-]</label><label class="expand" for="c-42919215">[1 more]</label></div><br/><div class="children"><div class="content">I found this article very interesting with regards direct WASM interpretation: <a href="https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2205.01183" rel="nofollow">https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2205.01183</a><p>I produced <a href="https:&#x2F;&#x2F;github.com&#x2F;peterseymour&#x2F;winter">https:&#x2F;&#x2F;github.com&#x2F;peterseymour&#x2F;winter</a> on the back of it and learnt WASM is not as simple as it should be.</div><br/></div></div><div id="42918980" class="c"><input type="checkbox" id="c-42918980" checked=""/><div class="controls bullet"><span class="by">syrusakbary</span><span>|</span><a href="#42919215">prev</a><span>|</span><a href="#42921917">next</a><span>|</span><label class="collapse" for="c-42918980">[-]</label><label class="expand" for="c-42918980">[14 more]</label></div><br/><div class="children"><div class="content">This is an interesting approach, great work!<p>For anyone that wants to check where the meat is at, is mostly in this file: <a href="https:&#x2F;&#x2F;github.com&#x2F;irrio&#x2F;semblance&#x2F;blob&#x2F;main&#x2F;src&#x2F;wrun.c">https:&#x2F;&#x2F;github.com&#x2F;irrio&#x2F;semblance&#x2F;blob&#x2F;main&#x2F;src&#x2F;wrun.c</a><p>Thinking out loud, I think it would have been a great idea to conform with the Wasm-C-API (<a href="https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;wasm-c-api">https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;wasm-c-api</a>) as a standard interface for the project (which most of the Wasm runtimes: Wasmer, V8, wasmi, etc. have adopted), as the API is already in C and it would make it easier to try for developers familiar with that API.<p>Note for the author: if you feel familiar enough with Wasm and you would like to contribute into Wasmer, we would also welcome any patches or improvements. Keep up the work work!</div><br/><div id="42919377" class="c"><input type="checkbox" id="c-42919377" checked=""/><div class="controls bullet"><span class="by">oguz-ismail</span><span>|</span><a href="#42918980">parent</a><span>|</span><a href="#42920929">next</a><span>|</span><label class="collapse" for="c-42919377">[-]</label><label class="expand" for="c-42919377">[7 more]</label></div><br/><div class="children"><div class="content">&gt; Wasmer<p>&gt; Installed-Size: 266 MB<p>What the hell</div><br/><div id="42919760" class="c"><input type="checkbox" id="c-42919760" checked=""/><div class="controls bullet"><span class="by">syrusakbary</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42919377">parent</a><span>|</span><a href="#42919901">next</a><span>|</span><label class="collapse" for="c-42919760">[-]</label><label class="expand" for="c-42919760">[5 more]</label></div><br/><div class="children"><div class="content">Indeed, we need to improve further the base binary size!<p>Most of the size comes from the LLVM backend, which is a bit heavy. Wasmer ships many backends by default, and if you were to use Wasmer headless that would be just a bit less than a Mb.<p>If you want, you can always customize the build with only the backends that you are interested in using.<p>Note: I&#x27;ve seen some builds of LLVM under 5-10Mb, but those require heavy customization. Is clear that we have still some work to do to reduce size on the general build!</div><br/><div id="42922868" class="c"><input type="checkbox" id="c-42922868" checked=""/><div class="controls bullet"><span class="by">CyberDildonics</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42919760">parent</a><span>|</span><a href="#42919901">next</a><span>|</span><label class="collapse" for="c-42922868">[-]</label><label class="expand" for="c-42922868">[4 more]</label></div><br/><div class="children"><div class="content">So you are shipping all of llvm?</div><br/><div id="42927048" class="c"><input type="checkbox" id="c-42927048" checked=""/><div class="controls bullet"><span class="by">dapperdrake</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42922868">parent</a><span>|</span><a href="#42919901">next</a><span>|</span><label class="collapse" for="c-42927048">[-]</label><label class="expand" for="c-42927048">[3 more]</label></div><br/><div class="children"><div class="content">Well, if you want to just-in-time compile, then it seems like a compiler is one way to go.<p>They are now in the size realm of Lisp and Smalltalk.  Forth may lean towards the lighter side.</div><br/><div id="42927208" class="c"><input type="checkbox" id="c-42927208" checked=""/><div class="controls bullet"><span class="by">CyberDildonics</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42927048">parent</a><span>|</span><a href="#42919901">next</a><span>|</span><label class="collapse" for="c-42927208">[-]</label><label class="expand" for="c-42927208">[2 more]</label></div><br/><div class="children"><div class="content">Lisp and Smalltalk are 266 MB?<p>tcc is 100KB<p><a href="https:&#x2F;&#x2F;www.bellard.org&#x2F;tcc&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.bellard.org&#x2F;tcc&#x2F;</a></div><br/><div id="42928233" class="c"><input type="checkbox" id="c-42928233" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42927208">parent</a><span>|</span><a href="#42919901">next</a><span>|</span><label class="collapse" for="c-42928233">[-]</label><label class="expand" for="c-42928233">[1 more]</label></div><br/><div class="children"><div class="content">TCC doesn&#x27;t do much optimization in turn, while commercial implementations of Lisp and Smalltalk are surely much larger than that.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="42920929" class="c"><input type="checkbox" id="c-42920929" checked=""/><div class="controls bullet"><span class="by">benatkin</span><span>|</span><a href="#42918980">parent</a><span>|</span><a href="#42919377">prev</a><span>|</span><a href="#42921917">next</a><span>|</span><label class="collapse" for="c-42920929">[-]</label><label class="expand" for="c-42920929">[6 more]</label></div><br/><div class="children"><div class="content">Um, the author is clearly familiar enough with Wasm, but probably knows enough to know to avoid a company that tried to trademark WebAssembly.<p>&gt; understandable concerns about the fact we, Wasmer, a VC-backed corporation, attempted to trademark the name of a non-profit organization, specifically WebAssembly<p>Acknowledgement of wrongdoing.</div><br/><div id="42924653" class="c"><input type="checkbox" id="c-42924653" checked=""/><div class="controls bullet"><span class="by">szundi</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42920929">parent</a><span>|</span><a href="#42921851">next</a><span>|</span><label class="collapse" for="c-42924653">[-]</label><label class="expand" for="c-42924653">[1 more]</label></div><br/><div class="children"><div class="content">Just for defensive purposes obviously</div><br/></div></div><div id="42921851" class="c"><input type="checkbox" id="c-42921851" checked=""/><div class="controls bullet"><span class="by">kowlo</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42920929">parent</a><span>|</span><a href="#42924653">prev</a><span>|</span><a href="#42923815">next</a><span>|</span><label class="collapse" for="c-42921851">[-]</label><label class="expand" for="c-42921851">[3 more]</label></div><br/><div class="children"><div class="content">I hadn&#x27;t heard about this - terrible.</div><br/><div id="42923843" class="c"><input type="checkbox" id="c-42923843" checked=""/><div class="controls bullet"><span class="by">arjvik</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42921851">parent</a><span>|</span><a href="#42923815">next</a><span>|</span><label class="collapse" for="c-42923843">[-]</label><label class="expand" for="c-42923843">[2 more]</label></div><br/><div class="children"><div class="content">Read the whole blogpost that quote was taken from:<p><a href="https:&#x2F;&#x2F;wasmer.io&#x2F;posts&#x2F;wasmer-and-trademarks-extended" rel="nofollow">https:&#x2F;&#x2F;wasmer.io&#x2F;posts&#x2F;wasmer-and-trademarks-extended</a><p>I don&#x27;t think this is as much of a smoking gun as it is made out to be.</div><br/><div id="42927034" class="c"><input type="checkbox" id="c-42927034" checked=""/><div class="controls bullet"><span class="by">dapperdrake</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42923843">parent</a><span>|</span><a href="#42923815">next</a><span>|</span><label class="collapse" for="c-42927034">[-]</label><label class="expand" for="c-42927034">[1 more]</label></div><br/><div class="children"><div class="content">Attention is all we need.</div><br/></div></div></div></div></div></div><div id="42923815" class="c"><input type="checkbox" id="c-42923815" checked=""/><div class="controls bullet"><span class="by">syrusakbary</span><span>|</span><a href="#42918980">root</a><span>|</span><a href="#42920929">parent</a><span>|</span><a href="#42921851">prev</a><span>|</span><a href="#42921917">next</a><span>|</span><label class="collapse" for="c-42923815">[-]</label><label class="expand" for="c-42923815">[1 more]</label></div><br/><div class="children"><div class="content">&quot;Mistakes teach us, forgiveness frees us&quot; - ChatGPT (o3-mini)<p><a href="https:&#x2F;&#x2F;wasmer.io&#x2F;posts&#x2F;wasmer-and-trademarks" rel="nofollow">https:&#x2F;&#x2F;wasmer.io&#x2F;posts&#x2F;wasmer-and-trademarks</a></div><br/></div></div></div></div></div></div><div id="42921917" class="c"><input type="checkbox" id="c-42921917" checked=""/><div class="controls bullet"><span class="by">abnercoimbre</span><span>|</span><a href="#42918980">prev</a><span>|</span><a href="#42918974">next</a><span>|</span><label class="collapse" for="c-42921917">[-]</label><label class="expand" for="c-42921917">[1 more]</label></div><br/><div class="children"><div class="content">Take a look at Orca [0] since I think you&#x27;d be a great contributor there.<p>[0] <a href="https:&#x2F;&#x2F;orca-app.dev" rel="nofollow">https:&#x2F;&#x2F;orca-app.dev</a></div><br/></div></div><div id="42918974" class="c"><input type="checkbox" id="c-42918974" checked=""/><div class="controls bullet"><span class="by">deivid</span><span>|</span><a href="#42921917">prev</a><span>|</span><a href="#42924474">next</a><span>|</span><label class="collapse" for="c-42918974">[-]</label><label class="expand" for="c-42918974">[1 more]</label></div><br/><div class="children"><div class="content">This is a really nice write up! It&#x27;s giving me motivation to go back to my WASM implementation</div><br/></div></div><div id="42924474" class="c"><input type="checkbox" id="c-42924474" checked=""/><div class="controls bullet"><span class="by">Jyaif</span><span>|</span><a href="#42918974">prev</a><span>|</span><a href="#42924198">next</a><span>|</span><label class="collapse" for="c-42924474">[-]</label><label class="expand" for="c-42924474">[1 more]</label></div><br/><div class="children"><div class="content">Regarding using WebAssembly as a plugin API, like for zed:<p>how do plugin developers debug their code?
Is there a way for them to do breakpoint debugging for example? What happens if their code crash, do they get a stacktrace?</div><br/></div></div><div id="42924198" class="c"><input type="checkbox" id="c-42924198" checked=""/><div class="controls bullet"><span class="by">UncleEntity</span><span>|</span><a href="#42924474">prev</a><span>|</span><a href="#42919834">next</a><span>|</span><label class="collapse" for="c-42924198">[-]</label><label class="expand" for="c-42924198">[1 more]</label></div><br/><div class="children"><div class="content">Heh, I also made the decision to focus on one project instead of hopping between new and shiny with the exception that I&#x27;m getting our AI overloads to do all the yak shaving -- which is frustrating to say the least...<p>--edit--<p>Oh, and I also was going to suggest using a library like libffi to make calls into C so you can do multiple arguments and whatnot.</div><br/></div></div><div id="42919834" class="c"><input type="checkbox" id="c-42919834" checked=""/><div class="controls bullet"><span class="by">greasy</span><span>|</span><a href="#42924198">prev</a><span>|</span><a href="#42918840">next</a><span>|</span><label class="collapse" for="c-42919834">[-]</label><label class="expand" for="c-42919834">[1 more]</label></div><br/><div class="children"><div class="content">This is awesome.</div><br/></div></div><div id="42918840" class="c"><input type="checkbox" id="c-42918840" checked=""/><div class="controls bullet"><span class="by">pdubroy</span><span>|</span><a href="#42919834">prev</a><span>|</span><a href="#42920712">next</a><span>|</span><label class="collapse" for="c-42918840">[-]</label><label class="expand" for="c-42918840">[35 more]</label></div><br/><div class="children"><div class="content">This is great! The WebAssembly Core Specification is actually quite readable, although some of the language can be a bit intimidating if you&#x27;re not used to reading programming language papers.<p>If anyone is looking for a slightly more accessible way to learn WebAssembly, you might enjoy WebAssembly from the Ground Up: <a href="https:&#x2F;&#x2F;wasmgroundup.com" rel="nofollow">https:&#x2F;&#x2F;wasmgroundup.com</a><p>(Disclaimer: I&#x27;m one of the authors)</div><br/><div id="42919763" class="c"><input type="checkbox" id="c-42919763" checked=""/><div class="controls bullet"><span class="by">amw-zero</span><span>|</span><a href="#42918840">parent</a><span>|</span><a href="#42928787">next</a><span>|</span><label class="collapse" for="c-42919763">[-]</label><label class="expand" for="c-42919763">[2 more]</label></div><br/><div class="children"><div class="content">I think it&#x27;s much better to just learn how to read inference rules. They&#x27;re actually quite simple, and are used ubiquitously to define PL semantics definitions.<p>Constraining this on &quot;that&#x27;s not an option&quot; is a big waste of time - learning this will open up all of the literature written on the subject.</div><br/><div id="42920640" class="c"><input type="checkbox" id="c-42920640" checked=""/><div class="controls bullet"><span class="by">shpongled</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919763">parent</a><span>|</span><a href="#42928787">next</a><span>|</span><label class="collapse" for="c-42920640">[-]</label><label class="expand" for="c-42920640">[1 more]</label></div><br/><div class="children"><div class="content">The WASM spec is so well defined presumably because Andreas Rossberg is the editor - and he did a bunch of PL research on extensions to Standard ML, which is famous for it&#x27;s specification!</div><br/></div></div></div></div><div id="42928787" class="c"><input type="checkbox" id="c-42928787" checked=""/><div class="controls bullet"><span class="by">crabmusket</span><span>|</span><a href="#42918840">parent</a><span>|</span><a href="#42919763">prev</a><span>|</span><a href="#42919188">next</a><span>|</span><label class="collapse" for="c-42928787">[-]</label><label class="expand" for="c-42928787">[2 more]</label></div><br/><div class="children"><div class="content">I bought the early access of your book a while ago and completed the first few chapters which were available. I found it a fantastic resource, and I was keen to continue but other responsibilities have gotten in the way since. I recommend it!</div><br/><div id="42929079" class="c"><input type="checkbox" id="c-42929079" checked=""/><div class="controls bullet"><span class="by">pdubroy</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42928787">parent</a><span>|</span><a href="#42919188">next</a><span>|</span><label class="collapse" for="c-42929079">[-]</label><label class="expand" for="c-42929079">[1 more]</label></div><br/><div class="children"><div class="content">Glad to hear!<p>If you haven&#x27;t looked at it in a while â we just published a draft of the final technical chapter, and are planning an official launch on March 4. So, might be a good time to dig back in :-)</div><br/></div></div></div></div><div id="42919188" class="c"><input type="checkbox" id="c-42919188" checked=""/><div class="controls bullet"><span class="by">veltas</span><span>|</span><a href="#42918840">parent</a><span>|</span><a href="#42928787">prev</a><span>|</span><a href="#42918866">next</a><span>|</span><label class="collapse" for="c-42919188">[-]</label><label class="expand" for="c-42919188">[3 more]</label></div><br/><div class="children"><div class="content">&gt; actually quite readable, although some of the language can be a bit intimidating if you&#x27;re not used to reading programming language papers<p>You&#x27;re more generous than me, I think it&#x27;s rubbish.<p>Would have been easier to read if they had written it more like an ISA manual.</div><br/><div id="42919851" class="c"><input type="checkbox" id="c-42919851" checked=""/><div class="controls bullet"><span class="by">mananaysiempre</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919188">parent</a><span>|</span><a href="#42919775">next</a><span>|</span><label class="collapse" for="c-42919851">[-]</label><label class="expand" for="c-42919851">[1 more]</label></div><br/><div class="children"><div class="content">You can understand the WASM spec in your sleep if youâve ever worked through a type-system paper from the last two decades (or a logic paper from even earlier I guess).<p>Granted, not many people have, but thereâs a reason why it makes sense for it to be written in that style: they want it to be very clear that the verification (typechecking, really) algorithm doesnât have any holes, and for that itâs reasonable to speak the language of the people who prove that type of thing for a living.<p>The WASM spec is also the ultimate authoritative reference for both programmers and implementers. Thatâs different from the goals of an ISA manual, which usually only targets programmers and just says âdonât do thatâ for certain dark corners of the (sole) implementation. (The RISC-V manual is atypical in this respect; still, I challenge you to describe e.g. which PC value the handler will see if the user code traps on a base RV32IMA system.)</div><br/></div></div><div id="42919775" class="c"><input type="checkbox" id="c-42919775" checked=""/><div class="controls bullet"><span class="by">amw-zero</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919188">parent</a><span>|</span><a href="#42919851">prev</a><span>|</span><a href="#42918866">next</a><span>|</span><label class="collapse" for="c-42919775">[-]</label><label class="expand" for="c-42919775">[1 more]</label></div><br/><div class="children"><div class="content">This is an opportunity to learn. The way WebAssembly is defined is the standard way PL semantics are defined.</div><br/></div></div></div></div><div id="42918866" class="c"><input type="checkbox" id="c-42918866" checked=""/><div class="controls bullet"><span class="by">MuffinFlavored</span><span>|</span><a href="#42918840">parent</a><span>|</span><a href="#42919188">prev</a><span>|</span><a href="#42919761">next</a><span>|</span><label class="collapse" for="c-42918866">[-]</label><label class="expand" for="c-42918866">[26 more]</label></div><br/><div class="children"><div class="content">I know one of WebAssembly&#x27;s biggest features by design is security &#x2F; &quot;sandbox&quot;.<p>But I&#x27;ve always gotten confused with... it is secure because by default it can&#x27;t do much.<p>I don&#x27;t quite understand how to view WebAssembly. You write in one language, it compiles things like basic math (nothing with network or filesystem) to another and it runs in an interpreter.<p>I feel like I have a severe lack&#x2F;misunderstanding. There&#x27;s a ton of hype for years, lots of investment... but it isn&#x27;t like any case where you want to add Lua to an app you can add WebAssembly&#x2F;vice versa?</div><br/><div id="42918979" class="c"><input type="checkbox" id="c-42918979" checked=""/><div class="controls bullet"><span class="by">jeroenhd</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42923268">next</a><span>|</span><label class="collapse" for="c-42918979">[-]</label><label class="expand" for="c-42918979">[9 more]</label></div><br/><div class="children"><div class="content">WebAssembly can communicate through buffers. WebAssembly can also import foreign functions (Javascript functions in the browser).<p>You can get output by reading the buffer at the end of execution&#x2F;when receiving callbacks. So, for instance, you pass a few frames worth of buffers to WASM, WASM renders pixels into the buffers, calls a callback, and the Javascript reads data from the buffer (sending it to a &lt;canvas&gt; or similar).<p>The benefit of WASM is that it can&#x27;t be very malicious by itself. It requires the runtime to provide it with exported functions and callbacks to do any file I&#x2F;O, network I&#x2F;O, or spawning new tasks. Lua and similar tools can go deep into the runtime they exist in, altering system state and messing with system memory if they want to, while WASM can only interact with the specific API surface you provide it.<p>That makes WASM less powerful, but more predictable, and in my opinion better for building integrations with as there is no risk of internal APIs being accessed (that you will be blamed for if they break in an update).</div><br/><div id="42919457" class="c"><input type="checkbox" id="c-42919457" checked=""/><div class="controls bullet"><span class="by">brabel</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918979">parent</a><span>|</span><a href="#42919091">next</a><span>|</span><label class="collapse" for="c-42919457">[-]</label><label class="expand" for="c-42919457">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Lua and similar tools can go deep into the runtime they exist in, altering system state and messing with system memory if they want to<p>That&#x27;s not correct, when you embed Lua you can choose which APIs are available, to make the full stdlib available you must explicitly call `luaL_openlibs` [1].<p>[1] <a href="https:&#x2F;&#x2F;www.lua.org&#x2F;manual&#x2F;5.3&#x2F;manual.html#luaL_openlibs" rel="nofollow">https:&#x2F;&#x2F;www.lua.org&#x2F;manual&#x2F;5.3&#x2F;manual.html#luaL_openlibs</a></div><br/></div></div><div id="42919091" class="c"><input type="checkbox" id="c-42919091" checked=""/><div class="controls bullet"><span class="by">panic</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918979">parent</a><span>|</span><a href="#42919457">prev</a><span>|</span><a href="#42925812">next</a><span>|</span><label class="collapse" for="c-42919091">[-]</label><label class="expand" for="c-42919091">[5 more]</label></div><br/><div class="children"><div class="content">I donât believe it is currently possible for a WebAssembly instance to access any buffer other than its own memory.  You have to copy data in and out.</div><br/><div id="42919536" class="c"><input type="checkbox" id="c-42919536" checked=""/><div class="controls bullet"><span class="by">deathanatos</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919091">parent</a><span>|</span><a href="#42919863">next</a><span>|</span><label class="collapse" for="c-42919536">[-]</label><label class="expand" for="c-42919536">[1 more]</label></div><br/><div class="children"><div class="content">The embedder could hand the module functions for manipulating external buffers via externrefs. (I&#x27;m not sure if that&#x27;s a good idea, or not, just that it <i>could</i>.)<p>But if the module wants to compute on the values in the buffer, at some level it would have to copy the data in&#x2F;out.</div><br/></div></div><div id="42919863" class="c"><input type="checkbox" id="c-42919863" checked=""/><div class="controls bullet"><span class="by">davexunit</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919091">parent</a><span>|</span><a href="#42919536">prev</a><span>|</span><a href="#42925812">next</a><span>|</span><label class="collapse" for="c-42919863">[-]</label><label class="expand" for="c-42919863">[3 more]</label></div><br/><div class="children"><div class="content">Use the GC instructions and you can freely share heap references amongst other modules and the host.</div><br/><div id="42919969" class="c"><input type="checkbox" id="c-42919969" checked=""/><div class="controls bullet"><span class="by">panic</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919863">parent</a><span>|</span><a href="#42925812">next</a><span>|</span><label class="collapse" for="c-42919969">[-]</label><label class="expand" for="c-42919969">[2 more]</label></div><br/><div class="children"><div class="content">How do you access the contents of a heap reference from JavaScript in order to âsend it to a &lt;canvas&gt; or similarâ?</div><br/><div id="42920038" class="c"><input type="checkbox" id="c-42920038" checked=""/><div class="controls bullet"><span class="by">davexunit</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919969">parent</a><span>|</span><a href="#42925812">next</a><span>|</span><label class="collapse" for="c-42920038">[-]</label><label class="expand" for="c-42920038">[1 more]</label></div><br/><div class="children"><div class="content">Assuming you&#x27;re talking about reading binary data like (array i8), the GC MVP doesn&#x27;t have a great answer right now. Have to call back into wasm to read the bytes. Something for the group to address in future proposals. Sharing between wasm modules is better right now.</div><br/></div></div></div></div></div></div></div></div><div id="42925812" class="c"><input type="checkbox" id="c-42925812" checked=""/><div class="controls bullet"><span class="by">westurner</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918979">parent</a><span>|</span><a href="#42919091">prev</a><span>|</span><a href="#42923268">next</a><span>|</span><label class="collapse" for="c-42925812">[-]</label><label class="expand" for="c-42925812">[2 more]</label></div><br/><div class="children"><div class="content">WASI Preview 1 and WASI Preview 2 can do file and network I&#x2F;O IIUC.<p>Re: tty support in container2wasm and fixed 80x25 due to lack of SIGWINCH support in WASI Preview 1: 
<a href="https:&#x2F;&#x2F;github.com&#x2F;ktock&#x2F;container2wasm&#x2F;issues&#x2F;146">https:&#x2F;&#x2F;github.com&#x2F;ktock&#x2F;container2wasm&#x2F;issues&#x2F;146</a><p>The File System Access API requires granting each app access to each folder.<p>jupyterlab-filesystem-access only works with Chromium based browsers, because FF doesn&#x27;t support the File System Access API: 
<a href="https:&#x2F;&#x2F;github.com&#x2F;jupyterlab-contrib&#x2F;jupyterlab-filesystem-access">https:&#x2F;&#x2F;github.com&#x2F;jupyterlab-contrib&#x2F;jupyterlab-filesystem-...</a><p>The File System Access API is useful for opening a local .ipynb and .csv with JupyterLite, which builds CPython for WASM as Pyodide.<p>There is a &quot;Direct Sockets API in Chrome 131&quot; but not in FF; so WebRTC and WebSocket relaying is unnecessary for WASM apps like WebVM: 
<a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42029188">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42029188</a></div><br/><div id="42925902" class="c"><input type="checkbox" id="c-42925902" checked=""/><div class="controls bullet"><span class="by">westurner</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42925812">parent</a><span>|</span><a href="#42923268">next</a><span>|</span><label class="collapse" for="c-42925902">[-]</label><label class="expand" for="c-42925902">[1 more]</label></div><br/><div class="children"><div class="content">WASI Preview 2:
<a href="https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;WASI&#x2F;blob&#x2F;main&#x2F;wasip2&#x2F;README.md">https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;WASI&#x2F;blob&#x2F;main&#x2F;wasip2&#x2F;README....</a> :<p>&gt; <i>wasi-io,
wasi-clocks, 
wasi-random, 
wasi-filesystem, 
wasi-sockets, 
wasi-cli, 
wasi-http</i></div><br/></div></div></div></div></div></div><div id="42923268" class="c"><input type="checkbox" id="c-42923268" checked=""/><div class="controls bullet"><span class="by">pizlonator</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42918979">prev</a><span>|</span><a href="#42919884">next</a><span>|</span><label class="collapse" for="c-42923268">[-]</label><label class="expand" for="c-42923268">[1 more]</label></div><br/><div class="children"><div class="content">&gt; But I&#x27;ve always gotten confused with... it is secure because by default it can&#x27;t do much.<p>Yes. Thatâs a super accurate description. Youâre not confused.<p>&gt; I don&#x27;t quite understand how to view WebAssembly. You write in one language, it compiles things like basic math (nothing with network or filesystem) to another and it runs in an interpreter.<p>Almost. Wasm is cheap to JIT compile and the resulting code is usually super efficient. Sometimes parity with native execution.<p>&gt; I feel like I have a severe lack&#x2F;misunderstanding. There&#x27;s a ton of hype for years, lots of investment... but it isn&#x27;t like any case where you want to add Lua to an app you can add WebAssembly&#x2F;vice versa?<p>Itâs definitely a case where the investment:utility ratio is high. ;-)<p>Hereâs the trade off between embedding Lua and embedding Wasm:<p>- Both have the problem that they are only as secure as the API you expose to the guest program. If you expose `rm -rf &#x2F;` to either Lua or Wasm, youâll have a bad time. And itâs surprisingly difficult to convince yourself that you didnât accidentally do that. Security is hard.<p>- Wasm is faster than Lua.<p>- Lua is a language for humans, no need for another language and compiler. That makes Lua a more natural choice for embedded scripting.<p>- Lua is object oriented, garbage collected, and has a very principled story for how that gets exposed to the host in a safe way. Wasm source languages are usually not GCâd. That means that if you want to expose object oriented API to the guest program, then itâll feel more natural to do that with Lua.<p>- The wasm security model is dead simple and doesnât (necessarily) rely on anything like GC, making it easier to convince yourself that the wasm implementation is free of security vulnerabilities. If you want a sandboxed execution environment then Wasm is better for that reason.</div><br/></div></div><div id="42919884" class="c"><input type="checkbox" id="c-42919884" checked=""/><div class="controls bullet"><span class="by">pdubroy</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42923268">prev</a><span>|</span><a href="#42922667">next</a><span>|</span><label class="collapse" for="c-42919884">[-]</label><label class="expand" for="c-42919884">[1 more]</label></div><br/><div class="children"><div class="content">You should check out the book :-)<p>We have a chapter called &quot;What Makes WebAssembly Safe?&quot; which covers the details. You can get a sneak peek here: <a href="https:&#x2F;&#x2F;bsky.app&#x2F;profile&#x2F;wasmgroundup.com&#x2F;post&#x2F;3lh2e4eiwnm2p" rel="nofollow">https:&#x2F;&#x2F;bsky.app&#x2F;profile&#x2F;wasmgroundup.com&#x2F;post&#x2F;3lh2e4eiwnm2p</a></div><br/></div></div><div id="42922667" class="c"><input type="checkbox" id="c-42922667" checked=""/><div class="controls bullet"><span class="by">Gupta2</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42919884">prev</a><span>|</span><a href="#42919111">next</a><span>|</span><label class="collapse" for="c-42922667">[-]</label><label class="expand" for="c-42922667">[3 more]</label></div><br/><div class="children"><div class="content">Speaking of WebAssembly security, is it vulnerable to Spectre&#x2F;CPU style attacks like those in JavaScript? (WASM without imported JS functions)</div><br/><div id="42924301" class="c"><input type="checkbox" id="c-42924301" checked=""/><div class="controls bullet"><span class="by">jeffparsons</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42922667">parent</a><span>|</span><a href="#42922969">next</a><span>|</span><label class="collapse" for="c-42924301">[-]</label><label class="expand" for="c-42924301">[1 more]</label></div><br/><div class="children"><div class="content">Yes, if you give the Wasm instance access to timers.</div><br/></div></div><div id="42922969" class="c"><input type="checkbox" id="c-42922969" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42922667">parent</a><span>|</span><a href="#42924301">prev</a><span>|</span><a href="#42919111">next</a><span>|</span><label class="collapse" for="c-42922969">[-]</label><label class="expand" for="c-42922969">[1 more]</label></div><br/><div class="children"><div class="content">Yes.</div><br/></div></div></div></div><div id="42919111" class="c"><input type="checkbox" id="c-42919111" checked=""/><div class="controls bullet"><span class="by">Karellen</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42922667">prev</a><span>|</span><a href="#42920181">next</a><span>|</span><label class="collapse" for="c-42919111">[-]</label><label class="expand" for="c-42919111">[6 more]</label></div><br/><div class="children"><div class="content">&gt; You write in one language<p>Not quite. Web assembly isn&#x27;t a source language, it&#x27;s a compiler target. So you should be able to write in C, Rust, Fortran, or Lua and compile any of those to WebAssembly.<p>Except that WebAssembly is a cross-platform assembly language&#x2F;machine code which is very similar to the native machine code of many&#x2F;most contemporary CPUs. This means a WebAssembly interpreter can be very straightforward, and could often translate one WebAssembly instruction to one native CPU instruction. Or rather, it can <i>compile</i> a stream of WebAssembly instructions almost one-to-one to native CPU instructions, which it can then execute directly.</div><br/><div id="42919183" class="c"><input type="checkbox" id="c-42919183" checked=""/><div class="controls bullet"><span class="by">whizzter</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919111">parent</a><span>|</span><a href="#42919350">next</a><span>|</span><label class="collapse" for="c-42919183">[-]</label><label class="expand" for="c-42919183">[4 more]</label></div><br/><div class="children"><div class="content">A JIT should be able to translate most arithmetic and binary instructions to single-opcodes, however anything involving memory and functions calls needs safety checks that becomes multi-instruction. branches could mostly be direct _unless_ the runtime has any kind of metering (it should) to stop eternal loops (if it also wants to be crash-safe even if it&#x27;s exploit safe).</div><br/><div id="42922004" class="c"><input type="checkbox" id="c-42922004" checked=""/><div class="controls bullet"><span class="by">kouteiheika</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919183">parent</a><span>|</span><a href="#42919350">next</a><span>|</span><label class="collapse" for="c-42922004">[-]</label><label class="expand" for="c-42922004">[3 more]</label></div><br/><div class="children"><div class="content">&gt; anything involving memory [..] needs safety checks that becomes multi-instruction<p>Not necessarily; on AMD64 you can do memory accesses in a single instruction relatively easily by using the CPU&#x27;s paging machinery for safety checks plus some clever use of address space.<p>&gt; branches could mostly be direct _unless_ the runtime has any kind of metering (it should) to stop eternal loops<p>Even with metering the branches would be direct, you&#x27;d just insert the metering code at the start of each basic block (so that&#x27;s two extra instructions at the start of each basic block). Or did you mean something else?</div><br/><div id="42922517" class="c"><input type="checkbox" id="c-42922517" checked=""/><div class="controls bullet"><span class="by">charleslmunger</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42922004">parent</a><span>|</span><a href="#42919350">next</a><span>|</span><label class="collapse" for="c-42922517">[-]</label><label class="expand" for="c-42922517">[2 more]</label></div><br/><div class="children"><div class="content">Metering also doesn&#x27;t require a branch if you implement it with page faults. See &quot;Implicit suspend checks&quot; in <a href="https:&#x2F;&#x2F;android-developers.googleblog.com&#x2F;2023&#x2F;11&#x2F;the-secret-to-androids-improved-memory-latest-android-runtime-update.html?m=1" rel="nofollow">https:&#x2F;&#x2F;android-developers.googleblog.com&#x2F;2023&#x2F;11&#x2F;the-secret...</a></div><br/><div id="42923389" class="c"><input type="checkbox" id="c-42923389" checked=""/><div class="controls bullet"><span class="by">kouteiheika</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42922517">parent</a><span>|</span><a href="#42919350">next</a><span>|</span><label class="collapse" for="c-42923389">[-]</label><label class="expand" for="c-42923389">[1 more]</label></div><br/><div class="children"><div class="content">Yep. That&#x27;s a nice trick; unfortunately it&#x27;s non-deterministic.</div><br/></div></div></div></div></div></div></div></div><div id="42919350" class="c"><input type="checkbox" id="c-42919350" checked=""/><div class="controls bullet"><span class="by">beardyw</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42919111">parent</a><span>|</span><a href="#42919183">prev</a><span>|</span><a href="#42920181">next</a><span>|</span><label class="collapse" for="c-42919350">[-]</label><label class="expand" for="c-42919350">[1 more]</label></div><br/><div class="children"><div class="content">Yes, interpretation on the fly was never its intention. The intention was to provide interpreted languages with a way to implement fast compiled functions.</div><br/></div></div></div></div><div id="42920181" class="c"><input type="checkbox" id="c-42920181" checked=""/><div class="controls bullet"><span class="by">coliveira</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42918866">parent</a><span>|</span><a href="#42919111">prev</a><span>|</span><a href="#42919761">next</a><span>|</span><label class="collapse" for="c-42920181">[-]</label><label class="expand" for="c-42920181">[5 more]</label></div><br/><div class="children"><div class="content">I think the biggest advantage of wasm in terms of security is that it doesn&#x27;t accept machine language written in the target machine, only in this artificial machine language. This means that it cannot encode arbitrary code that could be executed by the host machine. Everything it runs has necessarily to go through the wasm interpreter.</div><br/><div id="42922217" class="c"><input type="checkbox" id="c-42922217" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42920181">parent</a><span>|</span><a href="#42921471">next</a><span>|</span><label class="collapse" for="c-42922217">[-]</label><label class="expand" for="c-42922217">[1 more]</label></div><br/><div class="children"><div class="content">&gt; This means that it cannot encode arbitrary code that could be executed by the host machine.<p>But the host machine still can, so it&#x27;s not as big of advantage in that regard.  If you could somehow deliver a payload of native code and jump to it, it&#x27;d work just fine.  But the security you get is the fact that it&#x27;s really hard to do that because there&#x27;s no wasm instructions to jump to arbitrary memory locations (even if all the host ISAs do have those).  Having a VM alone doesn&#x27;t provide security against attacks.<p>It&#x27;s often the case that VMs are used with memory-safe languages and those languages&#x27; runtime bounds checks and other features are  what gives them safety moreso than their VM.  In fact, most bytecode languages provide a JIT (including some wasm deployments) so you&#x27;re actually running native code regardless.</div><br/></div></div><div id="42921471" class="c"><input type="checkbox" id="c-42921471" checked=""/><div class="controls bullet"><span class="by">hb-robo</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42920181">parent</a><span>|</span><a href="#42922217">prev</a><span>|</span><a href="#42919761">next</a><span>|</span><label class="collapse" for="c-42921471">[-]</label><label class="expand" for="c-42921471">[3 more]</label></div><br/><div class="children"><div class="content">That&#x27;s quite interesting. This is way outside of my wheelhouse - has this kind of approach been tried in other security contexts before? What would you even call that, virtualization?</div><br/><div id="42923097" class="c"><input type="checkbox" id="c-42923097" checked=""/><div class="controls bullet"><span class="by">dmitrygr</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42921471">parent</a><span>|</span><a href="#42922042">next</a><span>|</span><label class="collapse" for="c-42923097">[-]</label><label class="expand" for="c-42923097">[1 more]</label></div><br/><div class="children"><div class="content">The word is &quot;bytecode&quot; and the idea is as old as computing.</div><br/></div></div><div id="42922042" class="c"><input type="checkbox" id="c-42922042" checked=""/><div class="controls bullet"><span class="by">tubs</span><span>|</span><a href="#42918840">root</a><span>|</span><a href="#42921471">parent</a><span>|</span><a href="#42923097">prev</a><span>|</span><a href="#42919761">next</a><span>|</span><label class="collapse" for="c-42922042">[-]</label><label class="expand" for="c-42922042">[1 more]</label></div><br/><div class="children"><div class="content">Java.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="42920712" class="c"><input type="checkbox" id="c-42920712" checked=""/><div class="controls bullet"><span class="by">autumnlani</span><span>|</span><a href="#42918840">prev</a><span>|</span><label class="collapse" for="c-42920712">[-]</label><label class="expand" for="c-42920712">[1 more]</label></div><br/><div class="children"><div class="content">This is awesome. Nicely done</div><br/></div></div></div></div></div></div></div></body></html>