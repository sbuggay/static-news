<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1718787673584" as="style"/><link rel="stylesheet" href="styles.css?v=1718787673584"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://chickensoft.games/blog/serialization-for-csharp-games/">Serialization for C# Games</a> <span class="domain">(<a href="https://chickensoft.games">chickensoft.games</a>)</span></div><div class="subtext"><span>jolexxa</span> | <span>27 comments</span></div><br/><div><div id="40725602" class="c"><input type="checkbox" id="c-40725602" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#40723803">next</a><span>|</span><label class="collapse" for="c-40725602">[-]</label><label class="expand" for="c-40725602">[2 more]</label></div><br/><div class="children"><div class="content">If I learned one important lesson from writing savegame systems: don&#x27;t directly serialize your entire game state on the &quot;game object level&quot; (e.g. don&#x27;t create a savegame by running a serializer over your game object soup), instead decouple the saved data from your game logic internals, have a clear boundary between your game logic and the savegame-system, keep the saved state as minimal as possible, and reconstruct or default-initialize the rest of the data after loading saved state.<p>With that approach, a language-assisted serialization system also looses a lot of its appeal IMHO (although it can still be useful of course for describing the separate savegame data format).<p>Also: resist the architecture astronaut in you, especially savegame systems are a honey trap for overengineering ;)</div><br/><div id="40725867" class="c"><input type="checkbox" id="c-40725867" checked=""/><div class="controls bullet"><span class="by">smartis2812</span><span>|</span><a href="#40725602">parent</a><span>|</span><a href="#40723803">next</a><span>|</span><label class="collapse" for="c-40725867">[-]</label><label class="expand" for="c-40725867">[1 more]</label></div><br/><div class="children"><div class="content">True words. +1</div><br/></div></div></div></div><div id="40723803" class="c"><input type="checkbox" id="c-40723803" checked=""/><div class="controls bullet"><span class="by">LeonB</span><span>|</span><a href="#40725602">prev</a><span>|</span><a href="#40723705">next</a><span>|</span><label class="collapse" for="c-40723803">[-]</label><label class="expand" for="c-40723803">[7 more]</label></div><br/><div class="children"><div class="content">In my personal projects I’ve been using variations on the same simple code for saving&#x2F;loadings objects for a decade or so, and have very few problems. The heart of the code is this interface -<p><pre><code>    public interface IStashy&lt;K&gt;
    {
        void Save&lt;T&gt;(T t, K id);
        T Load&lt;T&gt;(K id);
        IEnumerable&lt;T&gt; LoadAll&lt;T&gt;();
        void Delete&lt;T&gt;(K id);
        K GetNewId&lt;T&gt;();
    }
</code></pre>
And implementations of that are very stable over time. Objects get serialized as json and stored in a folder named after their type.<p>There’s a small number of gotchas, for which I have well known work arounds:<p>- I generally won’t remove a property, but mark it as obsolete and stop using it.<p>- If I’ve added a new Boolean property, I’d tend to name it such that it defaults to false, or if it must default to true, have it stored in a nullable boolean, and if it loads as null (from an older instance of the type), set it to the default.<p>- some convenient types I want to use (as properties) are not serializable, so before saving I’ll copy their data into a serializable type, like an array of key values, then on loading rehydrate that to a dictionary. (I guess this is a harsh performance penalty if you’re doing a lot of it in a game)</div><br/><div id="40724689" class="c"><input type="checkbox" id="c-40724689" checked=""/><div class="controls bullet"><span class="by">LeonB</span><span>|</span><a href="#40723803">parent</a><span>|</span><a href="#40725405">next</a><span>|</span><label class="collapse" for="c-40724689">[-]</label><label class="expand" for="c-40724689">[1 more]</label></div><br/><div class="children"><div class="content">(Blogpost with an implementation of IStashy is here — <a href="https:&#x2F;&#x2F;secretgeek.net&#x2F;stashy_gist" rel="nofollow">https:&#x2F;&#x2F;secretgeek.net&#x2F;stashy_gist</a>)</div><br/></div></div><div id="40725405" class="c"><input type="checkbox" id="c-40725405" checked=""/><div class="controls bullet"><span class="by">spawarotti</span><span>|</span><a href="#40723803">parent</a><span>|</span><a href="#40724689">prev</a><span>|</span><a href="#40723948">next</a><span>|</span><label class="collapse" for="c-40725405">[-]</label><label class="expand" for="c-40725405">[2 more]</label></div><br/><div class="children"><div class="content">How do you deal with serializing properties &quot;by reference&quot;? E.g.,  if 3 objects reference object &quot;Foo&quot;, then Foo is serialized once instead of being duplicated in the json 3 times?</div><br/><div id="40725541" class="c"><input type="checkbox" id="c-40725541" checked=""/><div class="controls bullet"><span class="by">LeonB</span><span>|</span><a href="#40723803">root</a><span>|</span><a href="#40725405">parent</a><span>|</span><a href="#40723948">next</a><span>|</span><label class="collapse" for="c-40725541">[-]</label><label class="expand" for="c-40725541">[1 more]</label></div><br/><div class="children"><div class="content">It depends. I don’t tend to end up with deep object graphs that need to be saved&#x2F; reloaded.<p>It might be that we serialize foo and foo has a list of references to its 3 children. The “parent” reference from the child back to foo is marked as do not serialize; an “after rehydration” function on foo could then set the value each child’s parent reference.<p>But more often — say baz bar and bam reference foo — the speed at which baz changes is different to the speed at which foo changes. The reference to foo from Baz is marked do not serialize. Baz also has a property indicating the ID of Baz. (For IStashy&lt;K&gt; - K is the type used for the keys, the IDs; it might be a string or an int or a guid, I tend to use string. All objects in the system have the same kind of ID, and it is unique per type.)<p>Generally if cyclic data structures are possible then some part of the cycle will be marked as no serializable and I’ll keep a key reference adjacent to it.<p>Situations that triggers huge cascading saves — they’re kind of an anti pattern for how I work. If one little change changes everything then perhaps it can be calculated on the fly from a pure function, not persisted at all—  or perhaps there’s over-coupling etc.</div><br/></div></div></div></div><div id="40723948" class="c"><input type="checkbox" id="c-40723948" checked=""/><div class="controls bullet"><span class="by">nonethewiser</span><span>|</span><a href="#40723803">parent</a><span>|</span><a href="#40725405">prev</a><span>|</span><a href="#40723705">next</a><span>|</span><label class="collapse" for="c-40723948">[-]</label><label class="expand" for="c-40723948">[3 more]</label></div><br/><div class="children"><div class="content">&gt;  I generally won’t remove a property, but mark it as obsolete and stop using it.<p>Presumably because loading will break?<p>&gt; - If I’ve added a new Boolean property, I’d tend to name it such that it defaults to false, or if it must default to true, have it stored in a nullable boolean, and if it loads as null (from an older instance of the type), set it to the default.<p>Why?</div><br/><div id="40724106" class="c"><input type="checkbox" id="c-40724106" checked=""/><div class="controls bullet"><span class="by">eropple</span><span>|</span><a href="#40723803">root</a><span>|</span><a href="#40723948">parent</a><span>|</span><a href="#40723705">next</a><span>|</span><label class="collapse" for="c-40724106">[-]</label><label class="expand" for="c-40724106">[2 more]</label></div><br/><div class="children"><div class="content">`default(Boolean)` is false, so you can load an old object and it&#x27;ll substitute the default, rather than having to throw an error on a missing property. You could do the same with, say, a new Int32 field, so long as it should default to zero.<p>Similarly, `default(Nullable&lt;Boolean&gt;)` is (wait for it) null, so you can do &quot;oldVal ?? true&quot;.</div><br/><div id="40724461" class="c"><input type="checkbox" id="c-40724461" checked=""/><div class="controls bullet"><span class="by">LeonB</span><span>|</span><a href="#40723803">root</a><span>|</span><a href="#40724106">parent</a><span>|</span><a href="#40723705">next</a><span>|</span><label class="collapse" for="c-40724461">[-]</label><label class="expand" for="c-40724461">[1 more]</label></div><br/><div class="children"><div class="content">(I meant to respond to the gp comment here, soz. I agree with everything the parent comment says.)<p>&gt; Presumably because loading will break?<p>I think the object will still load ok, I’m not sure if it would break because it’s been so long since I was in a scenario where I wanted to really delete a property. Normally when I make it obsolete there is also some new property or properties that have replaced it. When loading the object, if the (now obsolete) property is not null, I translate its value into the new property&#x2F;ies (I.e., “migrate” it into the new properties), then null out the old property value, so that the migration only happens that one time.<p>I guess using something allegedly “simple”, over a long time, only appears simple because you will slowly internalise any idioms you’re using, and they don’t take much thought anymore.<p>Looking back — I’ve used this pattern for over 20 years, across various platforms. I’ve had a backing source that is anything from xml files to json to sqlite to in memory (for rapid tests) in a few languages. Things that seem natural or intuitive (to me) at this point are just habits that are rusted on, whether good or bad.<p>Sometimes I start building fast indexing systems on top of it, or archiving systems or record versioning… and the better tool would be to switch to a db or to a more full featured key value store. But it’s such a lot of fun!</div><br/></div></div></div></div></div></div></div></div><div id="40723705" class="c"><input type="checkbox" id="c-40723705" checked=""/><div class="controls bullet"><span class="by">interroboink</span><span>|</span><a href="#40723803">prev</a><span>|</span><a href="#40723737">next</a><span>|</span><label class="collapse" for="c-40723705">[-]</label><label class="expand" for="c-40723705">[4 more]</label></div><br/><div class="children"><div class="content">Sometimes, when battling these issues, I wish the Smalltalk-style approach[1][2] was more popular&#x2F;feasible. Basically, saving the entire state of the VM is a fundamental operation supported by the language. Only truly transient things like network connections require special effort.<p>There are some echoes of this with things like Lua&#x27;s Pluto&#x2F;Eris, or serializable continuations in other languages (eg: Perl&#x27;s Continuity).<p>It&#x27;s just such a pain to <i>thoroughly</i> handle that sort of stuff without language-level support. And doing a &quot;good enough&quot; approach with some rough edges is usually shippable, so it&#x27;s hard to build a critical mass of demand for such support. And even if there was, it&#x27;s very hard to add it to a language&#x2F;framework&#x2F;etc that wasn&#x27;t designed for it to begin with.<p>I&#x27;ve had a decent experience with &#x27;struct string&#x27; style approaches, like Lua&#x27;s string.pack() or Perl&#x27;s pack()[3]. It&#x27;s a little brittle, but extremely straightforward and &quot;not framework-y,&quot; which suits me. But it leaves out things like program execution state; it&#x27;s just for plain data.<p>[1] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Smalltalk#Image-based_persistence" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Smalltalk#Image-based_persiste...</a><p>[2] example of using this serializable statefulness for serving web apps: <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Seaside_(software)" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Seaside_(software)</a><p>[3] <a href="https:&#x2F;&#x2F;perldoc.perl.org&#x2F;functions&#x2F;pack" rel="nofollow">https:&#x2F;&#x2F;perldoc.perl.org&#x2F;functions&#x2F;pack</a></div><br/><div id="40725146" class="c"><input type="checkbox" id="c-40725146" checked=""/><div class="controls bullet"><span class="by">alexvitkov</span><span>|</span><a href="#40723705">parent</a><span>|</span><a href="#40724900">next</a><span>|</span><label class="collapse" for="c-40725146">[-]</label><label class="expand" for="c-40725146">[2 more]</label></div><br/><div class="children"><div class="content">A full memory dump for a game will nowadays often be multiple gigabytes, that&#x27;s a non-starter.<p>Even back in the day, Game Maker had a function to dump the state to disk that was intended for game saves. It sucked - turns out there&#x27;s a bunch of state that you don&#x27;t want in your savefile - keybinds, settings, even most game state actually.<p>Save state should be opt-in, not opt-out, and on top of that a VM&#x2F;memory dump makes it a very big pain to opt-out.</div><br/><div id="40725634" class="c"><input type="checkbox" id="c-40725634" checked=""/><div class="controls bullet"><span class="by">interroboink</span><span>|</span><a href="#40723705">root</a><span>|</span><a href="#40725146">parent</a><span>|</span><a href="#40724900">next</a><span>|</span><label class="collapse" for="c-40725634">[-]</label><label class="expand" for="c-40725634">[1 more]</label></div><br/><div class="children"><div class="content">All valid issues, to be sure. But I do think that a big chunk of the suckiness is poor tooling (lacking easier&#x2F;better ways to opt-out or customize various parts, for instance) rather than a conceptual problem. That&#x27;s why I feel like it would require a language to fully embrace it (kinda like Smalltalk did) rather than being a bolt-on feature. And for games it would likely need to be innately aware of GPU concerns, too.<p>On the flipside, there are (hopefully obvious) big advantages for the development process, when you can snapshot full states.<p>Of course, none of it matters if you actually need max performance — no AAA shooters would use it. But there are lots of not-performance-critical games which might benefit more from the better development experience at the expense of some performance. Perhaps point-and-click adventures, sidescrollers, shootemups, and such.<p>Anyway, just spitballing (:<p>I&#x27;m working on a game now that has almost no state, and I wish for a way to have that same freedom I feel in a more stateful traditional game, without having to muddy up everything with serialization interfaces et. al.</div><br/></div></div></div></div><div id="40724900" class="c"><input type="checkbox" id="c-40724900" checked=""/><div class="controls bullet"><span class="by">nox101</span><span>|</span><a href="#40723705">parent</a><span>|</span><a href="#40725146">prev</a><span>|</span><a href="#40723737">next</a><span>|</span><label class="collapse" for="c-40724900">[-]</label><label class="expand" for="c-40724900">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t, in fact I mostly hate serializations systems. IMO they lead to extremely long load times. It might be more work to put the data that actually needs to be saved into some binary blob but it&#x27;s the difference between a game that loads instantly and a game (like Source games) that takes 10-20 infuriating seconds per level every time you die.</div><br/></div></div></div></div><div id="40723737" class="c"><input type="checkbox" id="c-40723737" checked=""/><div class="controls bullet"><span class="by">kogir</span><span>|</span><a href="#40723705">prev</a><span>|</span><a href="#40723878">next</a><span>|</span><label class="collapse" for="c-40723737">[-]</label><label class="expand" for="c-40723737">[1 more]</label></div><br/><div class="children"><div class="content">This seems to cover many common pain points,  but I’ve written my fair share of .NET serializers and for anything I build now I’d just use protocol buffers. Robust support, handles versioning pretty well, and works cross platform.<p>I’d like to know their reasons for making yet another serializer vs just using pb or thrift.</div><br/></div></div><div id="40723878" class="c"><input type="checkbox" id="c-40723878" checked=""/><div class="controls bullet"><span class="by">isthiseasymode</span><span>|</span><a href="#40723737">prev</a><span>|</span><a href="#40723512">next</a><span>|</span><label class="collapse" for="c-40723878">[-]</label><label class="expand" for="c-40723878">[8 more]</label></div><br/><div class="children"><div class="content">Naive question: is there a reason why SQLite wouldn’t work for something like this?</div><br/><div id="40724018" class="c"><input type="checkbox" id="c-40724018" checked=""/><div class="controls bullet"><span class="by">jameshart</span><span>|</span><a href="#40723878">parent</a><span>|</span><a href="#40725627">next</a><span>|</span><label class="collapse" for="c-40724018">[-]</label><label class="expand" for="c-40724018">[3 more]</label></div><br/><div class="children"><div class="content">Well you still need to solve for what happens when a new version of your app (maybe with a new embedded version of SQLite) loads up an old data file saved by an old version of your app.<p>The old version might not contain all the tables you need, and the ones it has may not have the columns you expect. So you need to run some data migrations on the database. Now you no longer have a serialization problem but instead you have a schema versioning problem.</div><br/><div id="40725638" class="c"><input type="checkbox" id="c-40725638" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#40723878">root</a><span>|</span><a href="#40724018">parent</a><span>|</span><a href="#40724284">next</a><span>|</span><label class="collapse" for="c-40725638">[-]</label><label class="expand" for="c-40725638">[1 more]</label></div><br/><div class="children"><div class="content">&gt; instead you have a schema versioning problem<p>That same versioning problem also exists with other approaches. Having a versioned schema of the savegame format around for version migrations is generally a good idea.</div><br/></div></div><div id="40724284" class="c"><input type="checkbox" id="c-40724284" checked=""/><div class="controls bullet"><span class="by">cjonas</span><span>|</span><a href="#40723878">root</a><span>|</span><a href="#40724018">parent</a><span>|</span><a href="#40725638">prev</a><span>|</span><a href="#40725627">next</a><span>|</span><label class="collapse" for="c-40724284">[-]</label><label class="expand" for="c-40724284">[1 more]</label></div><br/><div class="children"><div class="content">Could solve this with a migration framework (I&#x27;m sure there is something for sqlLite).  I&#x27;ve also done something similar with object&#x2F;document storage. Store the version of the schema in the record and write a map function for each version from the previous.</div><br/></div></div></div></div><div id="40725627" class="c"><input type="checkbox" id="c-40725627" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#40723878">parent</a><span>|</span><a href="#40724018">prev</a><span>|</span><a href="#40724624">next</a><span>|</span><label class="collapse" for="c-40725627">[-]</label><label class="expand" for="c-40725627">[1 more]</label></div><br/><div class="children"><div class="content">We actually used SQLite in a couple of singleplayer RPGs (the Drakensang games).<p>The initial world state was baked into tables in an SQLite database file, and savegames were just mutated SQLite files (we kept a record of created, mutated and deleted database rows, and periodically flushed those changes into SQLite).<p>It worked well, but was overkill because we didn&#x27;t actually make use of any advanced SQL features (just simple search over an object-id column). It would have been easier to cut SQL out of the loop and just write a simple table-based persistency system.</div><br/></div></div><div id="40724624" class="c"><input type="checkbox" id="c-40724624" checked=""/><div class="controls bullet"><span class="by">nearbuy</span><span>|</span><a href="#40723878">parent</a><span>|</span><a href="#40725627">prev</a><span>|</span><a href="#40723972">next</a><span>|</span><label class="collapse" for="c-40724624">[-]</label><label class="expand" for="c-40724624">[1 more]</label></div><br/><div class="children"><div class="content">You could use it, but it&#x27;s not really solving the same problem.<p>For a game, you generally don&#x27;t need the relational database features. You aren&#x27;t doing queries. You just want to load an entire level into memory, or save an entire level. For the serialization and persistence aspect, I don&#x27;t see an advantage of SQLite over just calling JsonSerializer.Serialize().<p>The author&#x27;s system then adds a bunch of features like version tolerance, AOT compilation of class metadata for iOS, polymorphic serialization, support for List&lt;&gt; and Dictionary&lt;&gt;, integration with the Godot game engine, etc. As far as I know, SQLite doesn&#x27;t help you with any of that.<p>Anything that can write data to disk can ultimately save and load your game data; it&#x27;s just a question of how easily.</div><br/></div></div><div id="40723972" class="c"><input type="checkbox" id="c-40723972" checked=""/><div class="controls bullet"><span class="by">nonethewiser</span><span>|</span><a href="#40723878">parent</a><span>|</span><a href="#40724624">prev</a><span>|</span><a href="#40725031">next</a><span>|</span><label class="collapse" for="c-40723972">[-]</label><label class="expand" for="c-40723972">[1 more]</label></div><br/><div class="children"><div class="content">I wonder the same thing. Perhaps less portable? IE can&#x27;t package that up in a binary (I have absolutely no idea just spitballing)?<p>And very cursory search suggests maybe there is nothing to that guess: <a href="https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;golang&#x2F;comments&#x2F;tqffv2&#x2F;packaging_an_sql_database_in_a_go_binary&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;golang&#x2F;comments&#x2F;tqffv2&#x2F;packaging_an...</a><p>It&#x27;s an interesting question because I&#x27;ve run into some datascientists that were so used to working in memory with dataframes and similar that they moved mountains to do things like de-duplicate csv&#x27;s in memory (that they couldn&#x27;t all fit in at once) where-as they could have done so trivially with sqlite.</div><br/></div></div><div id="40725031" class="c"><input type="checkbox" id="c-40725031" checked=""/><div class="controls bullet"><span class="by">rishav_sharan</span><span>|</span><a href="#40723878">parent</a><span>|</span><a href="#40723972">prev</a><span>|</span><a href="#40723512">next</a><span>|</span><label class="collapse" for="c-40725031">[-]</label><label class="expand" for="c-40725031">[1 more]</label></div><br/><div class="children"><div class="content">For simpler games with simple state which can be expressed in relationships, it is definitely a good solution. However, as games get more complex, modeling the game state in just relations is harder. Its much simpler to model state in an object like structure. At least for me.</div><br/></div></div></div></div><div id="40723512" class="c"><input type="checkbox" id="c-40723512" checked=""/><div class="controls bullet"><span class="by">Madmallard</span><span>|</span><a href="#40723878">prev</a><span>|</span><label class="collapse" for="c-40723512">[-]</label><label class="expand" for="c-40723512">[4 more]</label></div><br/><div class="children"><div class="content">RunUO has an implementation of this and it&#x27;s like 25 years old but still worked really well</div><br/><div id="40723823" class="c"><input type="checkbox" id="c-40723823" checked=""/><div class="controls bullet"><span class="by">mentos</span><span>|</span><a href="#40723512">parent</a><span>|</span><a href="#40724550">next</a><span>|</span><label class="collapse" for="c-40723823">[-]</label><label class="expand" for="c-40723823">[2 more]</label></div><br/><div class="children"><div class="content">Wow clicked into the thread to see if anyone might mention RunUO :) it’s the only exposure I’ve had to serialization in C# I always wondered how it ranked compared to other approaches.</div><br/><div id="40724331" class="c"><input type="checkbox" id="c-40724331" checked=""/><div class="controls bullet"><span class="by">w-ll</span><span>|</span><a href="#40723512">root</a><span>|</span><a href="#40723823">parent</a><span>|</span><a href="#40724550">next</a><span>|</span><label class="collapse" for="c-40724331">[-]</label><label class="expand" for="c-40724331">[1 more]</label></div><br/><div class="children"><div class="content">As someone that also fell in love with C# with RunUO. I never actually looked at the Serialization at the time. Need to spend some time in RunUO or the fork soon.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;runuo&#x2F;runuo&#x2F;blob&#x2F;master&#x2F;Server&#x2F;Serialization.cs">https:&#x2F;&#x2F;github.com&#x2F;runuo&#x2F;runuo&#x2F;blob&#x2F;master&#x2F;Server&#x2F;Serializat...</a></div><br/></div></div></div></div><div id="40724550" class="c"><input type="checkbox" id="c-40724550" checked=""/><div class="controls bullet"><span class="by">sanex</span><span>|</span><a href="#40723512">parent</a><span>|</span><a href="#40723823">prev</a><span>|</span><label class="collapse" for="c-40724550">[-]</label><label class="expand" for="c-40724550">[1 more]</label></div><br/><div class="children"><div class="content">Ultima online solved all our problems 25 years ago.</div><br/></div></div></div></div></div></div></div></div></div></body></html>