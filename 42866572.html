<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1738227667500" as="style"/><link rel="stylesheet" href="styles.css?v=1738227667500"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://ebpf.foundation/case-study-bytedance-uses-ebpf-to-enhance-networking-performance/">Case Study: ByteDance Uses eBPF to Enhance Networking Performance</a>Â <span class="domain">(<a href="https://ebpf.foundation">ebpf.foundation</a>)</span></div><div class="subtext"><span>ChrisArchitect</span> | <span>18 comments</span></div><br/><div><div id="42869792" class="c"><input type="checkbox" id="c-42869792" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#42869496">next</a><span>|</span><label class="collapse" for="c-42869792">[-]</label><label class="expand" for="c-42869792">[11 more]</label></div><br/><div class="children"><div class="content">Netkit, which is what this is built on, is pretty neat. For transmitting packets from one container&#x2F;VM to another, the conventional solution is to give each its own veth device. When you do that, the kernel network stack, at like the broad logic level, is sort of oblivious to the fact that the devices aren&#x27;t real ethernet devices and don&#x27;t have to go through the ethernet motions to transact.<p>Netkit replaces that logic with a simple pairing of sending and receiving eBPF programs; it&#x27;s an eBPF cut-through for packet-level networking between networks that share a host kernel. It&#x27;s faster, and it&#x27;s simpler to reason about; the netkit.c code is pretty easy to read straight through.</div><br/><div id="42870666" class="c"><input type="checkbox" id="c-42870666" checked=""/><div class="controls bullet"><span class="by">charleslmunger</span><span>|</span><a href="#42869792">parent</a><span>|</span><a href="#42870776">next</a><span>|</span><label class="collapse" for="c-42870666">[-]</label><label class="expand" for="c-42870666">[5 more]</label></div><br/><div class="children"><div class="content">&gt;When you do that, the kernel network stack, at like the broad logic level, is sort of oblivious to the fact that the devices aren&#x27;t real ethernet devices and don&#x27;t have to go through the ethernet motions to transact.<p>Is that true even for virtio-net? I guess I just assumed all these virtual devices worked like virtiofs and had low overhead fast paths for host and guest communication.</div><br/><div id="42872502" class="c"><input type="checkbox" id="c-42872502" checked=""/><div class="controls bullet"><span class="by">XorNot</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42870666">parent</a><span>|</span><a href="#42870776">next</a><span>|</span><label class="collapse" for="c-42872502">[-]</label><label class="expand" for="c-42872502">[4 more]</label></div><br/><div class="children"><div class="content">Yeah this is a surprise to me too - my impression was things like loopback and virtio devices were used explicitly because they don&#x27;t pretend to ever be real devices, and thus bypass all the real device handling.<p>What additional overhead is cut out by the netkit approach?</div><br/><div id="42872912" class="c"><input type="checkbox" id="c-42872912" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42872502">parent</a><span>|</span><a href="#42870776">next</a><span>|</span><label class="collapse" for="c-42872912">[-]</label><label class="expand" for="c-42872912">[3 more]</label></div><br/><div class="children"><div class="content">Are you using virtual machines? They&#x27;re not.<p>The big win here as I understand it is that it gives you roughly the same efficient inter-device forwarding path that XDP gives you: you can bounce from one interface to another in eBPF without converting buffers back into skbuffs and snaking them through the stack again.</div><br/><div id="42874569" class="c"><input type="checkbox" id="c-42874569" checked=""/><div class="controls bullet"><span class="by">XorNot</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42872912">parent</a><span>|</span><a href="#42870776">next</a><span>|</span><label class="collapse" for="c-42874569">[-]</label><label class="expand" for="c-42874569">[2 more]</label></div><br/><div class="children"><div class="content">But in containers we use the &quot;veth&quot; devices, which aren&#x27;t even virtio and are only ever routed routed locally on the Linux kernel. So my question is, if this sort of optimization is possible, what does it sacrifice compared to veth to do it, given the constraints are (apparently) the same?</div><br/><div id="42874878" class="c"><input type="checkbox" id="c-42874878" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42874569">parent</a><span>|</span><a href="#42870776">next</a><span>|</span><label class="collapse" for="c-42874878">[-]</label><label class="expand" for="c-42874878">[1 more]</label></div><br/><div class="children"><div class="content">I assume the thing here is that veth simply doesn&#x27;t do it? We&#x27;re talking about a programmable fast path that bypasses the stack to get from interface A to interface B. For an ethernet interface, that&#x27;s what XDP does.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="42870776" class="c"><input type="checkbox" id="c-42870776" checked=""/><div class="controls bullet"><span class="by">lsnd-95</span><span>|</span><a href="#42869792">parent</a><span>|</span><a href="#42870666">prev</a><span>|</span><a href="#42875119">next</a><span>|</span><label class="collapse" for="c-42870776">[-]</label><label class="expand" for="c-42870776">[3 more]</label></div><br/><div class="children"><div class="content">It would be nice to see an implementation of TCP fusion (on Solaris) or SIO_LOOPBACK_FASTPATH (on Windows) for Linux.</div><br/><div id="42874449" class="c"><input type="checkbox" id="c-42874449" checked=""/><div class="controls bullet"><span class="by">sirjaz</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42870776">parent</a><span>|</span><a href="#42873264">next</a><span>|</span><label class="collapse" for="c-42874449">[-]</label><label class="expand" for="c-42874449">[1 more]</label></div><br/><div class="children"><div class="content">Someone on HN giving kudos to Windows for once. Has hell frozen over.</div><br/></div></div><div id="42873264" class="c"><input type="checkbox" id="c-42873264" checked=""/><div class="controls bullet"><span class="by">jiveturkey</span><span>|</span><a href="#42869792">root</a><span>|</span><a href="#42870776">parent</a><span>|</span><a href="#42874449">prev</a><span>|</span><a href="#42875119">next</a><span>|</span><label class="collapse" for="c-42873264">[-]</label><label class="expand" for="c-42873264">[1 more]</label></div><br/><div class="children"><div class="content">Came here to say the same. I&#x27;m glad linux is finally catching up to Solaris.</div><br/></div></div></div></div><div id="42875119" class="c"><input type="checkbox" id="c-42875119" checked=""/><div class="controls bullet"><span class="by">jigneshdarji91</span><span>|</span><a href="#42869792">parent</a><span>|</span><a href="#42870776">prev</a><span>|</span><a href="#42870092">next</a><span>|</span><label class="collapse" for="c-42875119">[-]</label><label class="expand" for="c-42875119">[1 more]</label></div><br/><div class="children"><div class="content">netkit.c: <a href="https:&#x2F;&#x2F;codebrowser.dev&#x2F;linux&#x2F;linux&#x2F;drivers&#x2F;net&#x2F;netkit.c.html" rel="nofollow">https:&#x2F;&#x2F;codebrowser.dev&#x2F;linux&#x2F;linux&#x2F;drivers&#x2F;net&#x2F;netkit.c.htm...</a></div><br/></div></div><div id="42870092" class="c"><input type="checkbox" id="c-42870092" checked=""/><div class="controls bullet"><span class="by">akamaka</span><span>|</span><a href="#42869792">parent</a><span>|</span><a href="#42875119">prev</a><span>|</span><a href="#42869496">next</a><span>|</span><label class="collapse" for="c-42870092">[-]</label><label class="expand" for="c-42870092">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for the clear explanation!</div><br/></div></div></div></div><div id="42869496" class="c"><input type="checkbox" id="c-42869496" checked=""/><div class="controls bullet"><span class="by">erulabs</span><span>|</span><a href="#42869792">prev</a><span>|</span><a href="#42871714">next</a><span>|</span><label class="collapse" for="c-42869496">[-]</label><label class="expand" for="c-42869496">[4 more]</label></div><br/><div class="children"><div class="content">I&#x27;d love to see a more complete picture of ByteDance&#x27;s TikTok infra. They released &quot;KubeAdmiral&quot; (1) so I&#x27;m assuming they&#x27;re using eBPF via a Kubernetes CNI, and I see ByteDance listed on Cilium&#x27;s github (2). They&#x27;re also using KubeRay (3) to orchestrate huge inference tasks. It&#x27;s annoying that a company I definitely do not want to work for has such an incredibly interesting infrastructure!<p>1. <a href="https:&#x2F;&#x2F;github.com&#x2F;kubewharf&#x2F;kubeadmiral">https:&#x2F;&#x2F;github.com&#x2F;kubewharf&#x2F;kubeadmiral</a><p>2. <a href="https:&#x2F;&#x2F;github.com&#x2F;cilium&#x2F;cilium&#x2F;blob&#x2F;main&#x2F;USERS.md">https:&#x2F;&#x2F;github.com&#x2F;cilium&#x2F;cilium&#x2F;blob&#x2F;main&#x2F;USERS.md</a><p>3. <a href="https:&#x2F;&#x2F;www.anyscale.com&#x2F;blog&#x2F;how-bytedance-scales-offline-inference-with-multi-modal-llms-to-200TB-data" rel="nofollow">https:&#x2F;&#x2F;www.anyscale.com&#x2F;blog&#x2F;how-bytedance-scales-offline-i...</a></div><br/><div id="42872771" class="c"><input type="checkbox" id="c-42872771" checked=""/><div class="controls bullet"><span class="by">dilyevsky</span><span>|</span><a href="#42869496">parent</a><span>|</span><a href="#42870279">next</a><span>|</span><label class="collapse" for="c-42872771">[-]</label><label class="expand" for="c-42872771">[1 more]</label></div><br/><div class="children"><div class="content">I also heard they replace k8s etcd with a shim [0] similar to kine because their clusters are so large.<p>[0] - <a href="https:&#x2F;&#x2F;github.com&#x2F;kubewharf&#x2F;kubebrain">https:&#x2F;&#x2F;github.com&#x2F;kubewharf&#x2F;kubebrain</a></div><br/></div></div><div id="42870279" class="c"><input type="checkbox" id="c-42870279" checked=""/><div class="controls bullet"><span class="by">koakuma-chan</span><span>|</span><a href="#42869496">parent</a><span>|</span><a href="#42872771">prev</a><span>|</span><a href="#42870806">next</a><span>|</span><label class="collapse" for="c-42870279">[-]</label><label class="expand" for="c-42870279">[1 more]</label></div><br/><div class="children"><div class="content">They also made monoio, an io-uring based async runtime for Rust: <a href="https:&#x2F;&#x2F;github.com&#x2F;bytedance&#x2F;monoio">https:&#x2F;&#x2F;github.com&#x2F;bytedance&#x2F;monoio</a></div><br/></div></div><div id="42870806" class="c"><input type="checkbox" id="c-42870806" checked=""/><div class="controls bullet"><span class="by">ddxv</span><span>|</span><a href="#42869496">parent</a><span>|</span><a href="#42870279">prev</a><span>|</span><a href="#42871714">next</a><span>|</span><label class="collapse" for="c-42870806">[-]</label><label class="expand" for="c-42870806">[1 more]</label></div><br/><div class="children"><div class="content">Here&#x27;s my list of the decompiled apps tools and business SDKs they are using:<p><a href="https:&#x2F;&#x2F;appgoblin.info&#x2F;apps&#x2F;com.zhiliaoapp.musically&#x2F;sdks" rel="nofollow">https:&#x2F;&#x2F;appgoblin.info&#x2F;apps&#x2F;com.zhiliaoapp.musically&#x2F;sdks</a></div><br/></div></div></div></div><div id="42871714" class="c"><input type="checkbox" id="c-42871714" checked=""/><div class="controls bullet"><span class="by">nighthawk454</span><span>|</span><a href="#42869496">prev</a><span>|</span><a href="#42875333">next</a><span>|</span><label class="collapse" for="c-42871714">[-]</label><label class="expand" for="c-42871714">[1 more]</label></div><br/><div class="children"><div class="content">&gt; eBPF is a technology that can run programs in a privileged context such as the operating system kernel. It is the successor to the Berkeley Packet Filter (BPF, with the &quot;e&quot; originally meaning &quot;extended&quot;) filtering mechanism in Linux and is also used in non-networking parts of the Linux kernel as well.<p>&gt; It is used to safely and efficiently extend the capabilities of the kernel at runtime without requiring changes to kernel source code or loading kernel modules. Safety is provided through an in-kernel verifier which performs static code analysis and rejects programs which crash, hang or otherwise interfere with the kernel negatively.<p><a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;EBPF?useskin=vector" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;EBPF?useskin=vector</a></div><br/></div></div><div id="42875333" class="c"><input type="checkbox" id="c-42875333" checked=""/><div class="controls bullet"><span class="by">throw78311</span><span>|</span><a href="#42871714">prev</a><span>|</span><label class="collapse" for="c-42875333">[-]</label><label class="expand" for="c-42875333">[1 more]</label></div><br/><div class="children"><div class="content">I guess this is why everything is under Federation&#x2F;default now, the old mess was annoying to work with.</div><br/></div></div></div></div></div></div></div></body></html>