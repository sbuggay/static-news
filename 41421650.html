<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1725267676795" as="style"/><link rel="stylesheet" href="styles.css?v=1725267676795"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://git.peppe.rs/languages/tbsp/">Tbsp – treesitter-based source processing language</a> <span class="domain">(<a href="https://git.peppe.rs">git.peppe.rs</a>)</span></div><div class="subtext"><span>hiyer</span> | <span>24 comments</span></div><br/><div><div id="41422824" class="c"><input type="checkbox" id="c-41422824" checked=""/><div class="controls bullet"><span class="by">fellowmartian</span><span>|</span><a href="#41423645">next</a><span>|</span><label class="collapse" for="c-41422824">[-]</label><label class="expand" for="c-41422824">[3 more]</label></div><br/><div class="children"><div class="content">This is great, and a step in the right direction. I wish tree-sitter had an official higher level API that allowed processing and pattern matching for use cases other than those required for text editors.<p>I’m currently using tree-sitter at work to build AST-based tools, as performance is amazing, even with huge codebases, but I’m finding it slightly frustrating to have to manually write recursive descent processors keyed by strings, with no compile time guarantees on the structure of the grammar.<p>This is compounded by the fact that grammars themselves don’t really follow any standard structure, some have named fields (presumably the ones created after GitHub contributed this feature), while others require hierarchical pattern matching.<p>I wish there existed a tool to consume a grammar and output a rust ADT that we can simply match on. This would at least save me from redundant error handling. I’d build one myself, but I’m that good at rust yet.</div><br/><div id="41423169" class="c"><input type="checkbox" id="c-41423169" checked=""/><div class="controls bullet"><span class="by">sweetgiorni</span><span>|</span><a href="#41422824">parent</a><span>|</span><a href="#41423163">next</a><span>|</span><label class="collapse" for="c-41423169">[-]</label><label class="expand" for="c-41423169">[1 more]</label></div><br/><div class="children"><div class="content">&gt; I wish tree-sitter had an official higher level API that allowed processing and pattern matching for use cases other than those required for text editors.<p>Is the pattern matching API not sufficiently high level? In my experience, it&#x27;s a huge improvement over implementing visitors for everything.<p><a href="https:&#x2F;&#x2F;tree-sitter.github.io&#x2F;tree-sitter&#x2F;using-parsers#pattern-matching-with-queries" rel="nofollow">https:&#x2F;&#x2F;tree-sitter.github.io&#x2F;tree-sitter&#x2F;using-parsers#patt...</a></div><br/></div></div><div id="41423163" class="c"><input type="checkbox" id="c-41423163" checked=""/><div class="controls bullet"><span class="by">CGamesPlay</span><span>|</span><a href="#41422824">parent</a><span>|</span><a href="#41423169">prev</a><span>|</span><a href="#41423645">next</a><span>|</span><label class="collapse" for="c-41423163">[-]</label><label class="expand" for="c-41423163">[1 more]</label></div><br/><div class="children"><div class="content">I’ve also encountered this problem using various tree-sitter grammars. I would love a data set that showed various implementations for different languages, along with some kind of consistent test coverage for each language that shows compatibility versus the compiler’s parser. And, of course, links to precompiled wasm modules. Basically, a tree-sitter package manager.</div><br/></div></div></div></div><div id="41423645" class="c"><input type="checkbox" id="c-41423645" checked=""/><div class="controls bullet"><span class="by">orra</span><span>|</span><a href="#41422824">prev</a><span>|</span><a href="#41423405">next</a><span>|</span><label class="collapse" for="c-41423645">[-]</label><label class="expand" for="c-41423645">[2 more]</label></div><br/><div class="children"><div class="content">Not a technical comment (as cool as this is), but I love the name.<p>We always say naming things is one of the hard parts of programming. They avoided the default option of something like tawk.</div><br/><div id="41423700" class="c"><input type="checkbox" id="c-41423700" checked=""/><div class="controls bullet"><span class="by">linguistics__</span><span>|</span><a href="#41423645">parent</a><span>|</span><a href="#41423405">next</a><span>|</span><label class="collapse" for="c-41423700">[-]</label><label class="expand" for="c-41423700">[1 more]</label></div><br/><div class="children"><div class="content">I mean I&#x27;ll be calling (pronouncing) it Tablespoon, that&#x27;s a great name:)</div><br/></div></div></div></div><div id="41423405" class="c"><input type="checkbox" id="c-41423405" checked=""/><div class="controls bullet"><span class="by">mingodad</span><span>|</span><a href="#41423645">prev</a><span>|</span><a href="#41421792">next</a><span>|</span><label class="collapse" for="c-41423405">[-]</label><label class="expand" for="c-41423405">[3 more]</label></div><br/><div class="children"><div class="content">For those that want to explore the grammars listed at <a href="https:&#x2F;&#x2F;github.com&#x2F;tree-sitter&#x2F;tree-sitter&#x2F;wiki&#x2F;List-of-parsers">https:&#x2F;&#x2F;github.com&#x2F;tree-sitter&#x2F;tree-sitter&#x2F;wiki&#x2F;List-of-pars...</a> in a more friendly railroad diagram format I made <a href="https:&#x2F;&#x2F;mingodad.github.io&#x2F;plgh&#x2F;json2ebnf.html" rel="nofollow">https:&#x2F;&#x2F;mingodad.github.io&#x2F;plgh&#x2F;json2ebnf.html</a> that reads the &quot;src&#x2F;grammar.json&quot; and try it&#x27;s best to generate an EBNF understood by (IPV6) <a href="https:&#x2F;&#x2F;www.bottlecaps.de&#x2F;rr&#x2F;ui" rel="nofollow">https:&#x2F;&#x2F;www.bottlecaps.de&#x2F;rr&#x2F;ui</a> or (IPV4) <a href="https:&#x2F;&#x2F;rr.red-dove.com&#x2F;ui" rel="nofollow">https:&#x2F;&#x2F;rr.red-dove.com&#x2F;ui</a> where we get a nice navigable railroad diagram (see <a href="https:&#x2F;&#x2F;github.com&#x2F;GuntherRademacher&#x2F;rr">https:&#x2F;&#x2F;github.com&#x2F;GuntherRademacher&#x2F;rr</a> for offline usage).</div><br/><div id="41423788" class="c"><input type="checkbox" id="c-41423788" checked=""/><div class="controls bullet"><span class="by">mickeyp</span><span>|</span><a href="#41423405">parent</a><span>|</span><a href="#41423551">next</a><span>|</span><label class="collapse" for="c-41423788">[-]</label><label class="expand" for="c-41423788">[1 more]</label></div><br/><div class="children"><div class="content">Impressive! The grammar.json file is just a little bit too underspecced to automate some things. Not to mention it&#x27;s self-referential. How did you deal with extras and other &#x27;specialisms&#x27; that are secretly hidden away in the C-level scanner and so on?<p>I ask because I wrote Combobulate [1], a structured editing and movement tool for Emacs using TS.<p>1: <a href="https:&#x2F;&#x2F;github.com&#x2F;mickeynp&#x2F;combobulate">https:&#x2F;&#x2F;github.com&#x2F;mickeynp&#x2F;combobulate</a></div><br/></div></div><div id="41423551" class="c"><input type="checkbox" id="c-41423551" checked=""/><div class="controls bullet"><span class="by">yaantc</span><span>|</span><a href="#41423405">parent</a><span>|</span><a href="#41423788">prev</a><span>|</span><a href="#41421792">next</a><span>|</span><label class="collapse" for="c-41423551">[-]</label><label class="expand" for="c-41423551">[1 more]</label></div><br/><div class="children"><div class="content">Hi, in case you&#x27;re not already aware of the name clash, there&#x27;s already a `rr` in the programming world. It&#x27;s &quot;record and replay&quot;: <a href="https:&#x2F;&#x2F;rr-project.org&#x2F;" rel="nofollow">https:&#x2F;&#x2F;rr-project.org&#x2F;</a>.<p>Very different, but a very fine tool tool too.</div><br/></div></div></div></div><div id="41421792" class="c"><input type="checkbox" id="c-41421792" checked=""/><div class="controls bullet"><span class="by">rtpg</span><span>|</span><a href="#41423405">prev</a><span>|</span><a href="#41422097">next</a><span>|</span><label class="collapse" for="c-41421792">[-]</label><label class="expand" for="c-41421792">[5 more]</label></div><br/><div class="children"><div class="content">So an awk but that knows how to walk structures instead of just lines. Excellent!<p>I&#x27;m a big fan of semgrep letting me query ASTs, this feels like something in a similar space. Down with lines, up with everything being trees!</div><br/><div id="41421901" class="c"><input type="checkbox" id="c-41421901" checked=""/><div class="controls bullet"><span class="by">pdimitar</span><span>|</span><a href="#41421792">parent</a><span>|</span><a href="#41422097">next</a><span>|</span><label class="collapse" for="c-41421901">[-]</label><label class="expand" for="c-41421901">[4 more]</label></div><br/><div class="children"><div class="content">Have you checked ast-grep and gritql?</div><br/><div id="41422063" class="c"><input type="checkbox" id="c-41422063" checked=""/><div class="controls bullet"><span class="by">normie3000</span><span>|</span><a href="#41421792">root</a><span>|</span><a href="#41421901">parent</a><span>|</span><a href="#41422097">next</a><span>|</span><label class="collapse" for="c-41422063">[-]</label><label class="expand" for="c-41422063">[3 more]</label></div><br/><div class="children"><div class="content">Are these alternatives to semgrep?</div><br/><div id="41422245" class="c"><input type="checkbox" id="c-41422245" checked=""/><div class="controls bullet"><span class="by">pdimitar</span><span>|</span><a href="#41421792">root</a><span>|</span><a href="#41422063">parent</a><span>|</span><a href="#41422097">next</a><span>|</span><label class="collapse" for="c-41422245">[-]</label><label class="expand" for="c-41422245">[2 more]</label></div><br/><div class="children"><div class="content">More or less, yes. CLI, offline, no need for a cloud account. Used ast-grep successfully to locate bad code blocks (dynamic typing, don&#x27;t even get me started) and also to replace them with others. Highly recommended.</div><br/><div id="41422288" class="c"><input type="checkbox" id="c-41422288" checked=""/><div class="controls bullet"><span class="by">dbaupp</span><span>|</span><a href="#41421792">root</a><span>|</span><a href="#41422245">parent</a><span>|</span><a href="#41422097">next</a><span>|</span><label class="collapse" for="c-41422288">[-]</label><label class="expand" for="c-41422288">[1 more]</label></div><br/><div class="children"><div class="content">Semgrep also a CLI, that can run offline and without a cloud account.<p>At work, we use it for enforcing a bunch of custom lint rules configured as a yaml file committed directly to our repo, entirely cloud-free.<p>(I may be overreading your comment as suggesting that these were reasons to use ast-grep over semgrep.)</div><br/></div></div></div></div></div></div></div></div></div></div><div id="41422097" class="c"><input type="checkbox" id="c-41422097" checked=""/><div class="controls bullet"><span class="by">MantisShrimp90</span><span>|</span><a href="#41421792">prev</a><span>|</span><a href="#41422207">next</a><span>|</span><label class="collapse" for="c-41422097">[-]</label><label class="expand" for="c-41422097">[1 more]</label></div><br/><div class="children"><div class="content">As someone writing a neovim plugin using treesitter thank you! Languages like this help leverage treesitter in more interesting ways whereas current apis are still a bit low-level</div><br/></div></div><div id="41422207" class="c"><input type="checkbox" id="c-41422207" checked=""/><div class="controls bullet"><span class="by">sramam</span><span>|</span><a href="#41422097">prev</a><span>|</span><a href="#41423164">next</a><span>|</span><label class="collapse" for="c-41422207">[-]</label><label class="expand" for="c-41422207">[2 more]</label></div><br/><div class="children"><div class="content">This is so cool.<p>Question (caveat: first export to treesitter and tools like this):
Is there a reason the example demonstrates the use of depth as a variable
instead of it being built in?<p>Nesting level of a particular &quot;type&quot; is general enough that it might be included OOTB.
What you want to do with this might be generalizable - 
for example instead of<p>```<p><pre><code>    enter section {
        depth += 1;
    }
    leave section {
        depth -= 1;
    }

    enter atx_heading {
        print(&quot;&lt;h&quot;);
        print(depth);
        print(&quot;&gt;&quot;);
    }
    leave atx_heading {
        print(&quot;&lt;&#x2F;h&quot;);
        print(depth);
        print(&quot;&gt;\n&quot;);
    }
</code></pre>
```<p>It could simply be:<p>```<p><pre><code>    enter atx_heading {
        print(&quot;&lt;h&quot;);
        print(depth);
        print(&quot;&gt;&quot;);
    }
    leave atx_heading {
        print(&quot;&lt;&#x2F;h&quot;);
        print(depth);
        print(&quot;&gt;\n&quot;);
    }
</code></pre>
```<p>So depth is always of the nested levels of the same node type, but available out of the box.
For markdown, it&#x27;s headings, sections and lists come to mind - but I might be wrong.<p>In any event, this looks really well thought-out and now to checkout the other tools mentioned in the comments.....</div><br/><div id="41422943" class="c"><input type="checkbox" id="c-41422943" checked=""/><div class="controls bullet"><span class="by">rtpg</span><span>|</span><a href="#41422207">parent</a><span>|</span><a href="#41423164">next</a><span>|</span><label class="collapse" for="c-41422943">[-]</label><label class="expand" for="c-41422943">[1 more]</label></div><br/><div class="children"><div class="content">The depth here can be context dependent. For example if you had a bunch of brackets and parens in your grammar, you might only care about paren depth. Or if your language had brackets and parens and function definitions, your &quot;expression depth&quot; might ignore function definitions (or even reset at a function definition boundary if you have inner functions!)</div><br/></div></div></div></div><div id="41423164" class="c"><input type="checkbox" id="c-41423164" checked=""/><div class="controls bullet"><span class="by">ashkankiani</span><span>|</span><a href="#41422207">prev</a><span>|</span><a href="#41422965">next</a><span>|</span><label class="collapse" for="c-41423164">[-]</label><label class="expand" for="c-41423164">[1 more]</label></div><br/><div class="children"><div class="content">Adding a way to query the path at the current node would let you skip out on doing stuff like keeping track of `in_section`.<p>I wonder if the `enter|exit ...` syntax might be too limiting but for a lot of stuff it seems nice and easy to reason about. Easier than tree-sitter&#x27;s own queries.<p>I think if you really wanted performance and whatnot, you might end up compiling the queries to another target and just reuse them.<p>I could see myself writing a lua DSL around compiling these kinds of queries `enter&#x2F;exit` stanzas or an SQL one too.</div><br/></div></div><div id="41422965" class="c"><input type="checkbox" id="c-41422965" checked=""/><div class="controls bullet"><span class="by">samgriesemer</span><span>|</span><a href="#41423164">prev</a><span>|</span><a href="#41423208">next</a><span>|</span><label class="collapse" for="c-41422965">[-]</label><label class="expand" for="c-41422965">[1 more]</label></div><br/><div class="children"><div class="content">The md-to-html demo is a good one, but worth mentioning that the Markdown parser[1] being used may not be suitable for more complex documents. From the README:<p>&gt; &quot;...it is not recommended to use this parser where correctness is important. The main goal for this parser is to provide syntactical information for syntax highlighting...&quot;<p>There&#x27;s also a separate block-level and inline parser, not sure how `tbsp` handles nested or multi-stage parsing.<p>[1]: <a href="https:&#x2F;&#x2F;github.com&#x2F;tree-sitter-grammars&#x2F;tree-sitter-markdown">https:&#x2F;&#x2F;github.com&#x2F;tree-sitter-grammars&#x2F;tree-sitter-markdown</a></div><br/></div></div><div id="41423208" class="c"><input type="checkbox" id="c-41423208" checked=""/><div class="controls bullet"><span class="by">azeirah</span><span>|</span><a href="#41422965">prev</a><span>|</span><a href="#41422443">next</a><span>|</span><label class="collapse" for="c-41423208">[-]</label><label class="expand" for="c-41423208">[1 more]</label></div><br/><div class="children"><div class="content">Awesome! I&#x27;d love to see this flourish.</div><br/></div></div><div id="41422443" class="c"><input type="checkbox" id="c-41422443" checked=""/><div class="controls bullet"><span class="by">toastal</span><span>|</span><a href="#41423208">prev</a><span>|</span><a href="#41421890">next</a><span>|</span><label class="collapse" for="c-41422443">[-]</label><label class="expand" for="c-41422443">[1 more]</label></div><br/><div class="children"><div class="content">Always kudos towards taking a self-hosted-forge approach</div><br/></div></div><div id="41421890" class="c"><input type="checkbox" id="c-41421890" checked=""/><div class="controls bullet"><span class="by">jpgvm</span><span>|</span><a href="#41422443">prev</a><span>|</span><label class="collapse" for="c-41421890">[-]</label><label class="expand" for="c-41421890">[3 more]</label></div><br/><div class="children"><div class="content">Maybe update the link to <a href="https:&#x2F;&#x2F;git.peppe.rs&#x2F;languages&#x2F;tbsp&#x2F;tree&#x2F;readme.txt" rel="nofollow">https:&#x2F;&#x2F;git.peppe.rs&#x2F;languages&#x2F;tbsp&#x2F;tree&#x2F;readme.txt</a>?</div><br/><div id="41421928" class="c"><input type="checkbox" id="c-41421928" checked=""/><div class="controls bullet"><span class="by">Terretta</span><span>|</span><a href="#41421890">parent</a><span>|</span><a href="#41422654">next</a><span>|</span><label class="collapse" for="c-41421928">[-]</label><label class="expand" for="c-41421928">[1 more]</label></div><br/><div class="children"><div class="content">Some might prefer <a href="https:&#x2F;&#x2F;git.peppe.rs&#x2F;languages&#x2F;tbsp&#x2F;about&#x2F;" rel="nofollow">https:&#x2F;&#x2F;git.peppe.rs&#x2F;languages&#x2F;tbsp&#x2F;about&#x2F;</a></div><br/></div></div><div id="41422654" class="c"><input type="checkbox" id="c-41422654" checked=""/><div class="controls bullet"><span class="by">barlog</span><span>|</span><a href="#41421890">parent</a><span>|</span><a href="#41421928">prev</a><span>|</span><label class="collapse" for="c-41422654">[-]</label><label class="expand" for="c-41422654">[1 more]</label></div><br/><div class="children"><div class="content">Is it formerly peppe.rs ?<p>Here is the new account and doc for tbsp below.<p><a href="https:&#x2F;&#x2F;oppi.li&#x2F;posts&#x2F;introducing_tablespoon&#x2F;" rel="nofollow">https:&#x2F;&#x2F;oppi.li&#x2F;posts&#x2F;introducing_tablespoon&#x2F;</a></div><br/></div></div></div></div></div></div></div></div></div></body></html>