<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1714122122619" as="style"/><link rel="stylesheet" href="styles.css?v=1714122122619"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.peerdb.io/how-can-we-make-pgdump-and-pgrestore-5-times-faster">Parallel Snapshotting: make pg_dump and pg_restore multi-threaded per table</a> <span class="domain">(<a href="https://blog.peerdb.io">blog.peerdb.io</a>)</span></div><div class="subtext"><span>spathak</span> | <span>10 comments</span></div><br/><div><div id="40164425" class="c"><input type="checkbox" id="c-40164425" checked=""/><div class="controls bullet"><span class="by">cswilliams</span><span>|</span><a href="#40162065">next</a><span>|</span><label class="collapse" for="c-40164425">[-]</label><label class="expand" for="c-40164425">[2 more]</label></div><br/><div class="children"><div class="content">Several years ago at a company I no longer work at, when we swapped from single-threaded pgdumps (from a replica) to multi-threaded pgdumps (-j flag), we occasionally saw some dumps which were &quot;inconsistent&quot;.  Not sure if that&#x27;s the best term for it, but we would occasionally get duplicate foreign key errors on pg_restore or even if pg_restore succeeded, sometimes primary key sequences would be less than the maximum id of our table (so new inserts would fail).  This was on standard postgres 13.3 (not aurora) on AWS RDS.  Nothing really noteworthy about our setup either that I can remember. 
I tried reporting it at the time on both the postgres mailing list and with AWS support and unfortunately both pointed fingers at the other and I eventually gave up since it was not easy to reproduce.  We unfortunately ended up having to go back to single threaded dumps which never produced any of these &quot;corrupt&quot; dumps but was obviously much slower.</div><br/><div id="40167029" class="c"><input type="checkbox" id="c-40167029" checked=""/><div class="controls bullet"><span class="by">lordgilman</span><span>|</span><a href="#40164425">parent</a><span>|</span><a href="#40162065">next</a><span>|</span><label class="collapse" for="c-40167029">[-]</label><label class="expand" for="c-40167029">[1 more]</label></div><br/><div class="children"><div class="content">I can’t speak specifically to duplicate foreign key errors but I possibly fixed that bug via a fix to parallel dump&#x2F;restore in the 12-13 era. It would manifest as a dump that would fail on restore with errors related to schema dependencies (trying to restore database objects out-of-order).</div><br/></div></div></div></div><div id="40162065" class="c"><input type="checkbox" id="c-40162065" checked=""/><div class="controls bullet"><span class="by">porsager</span><span>|</span><a href="#40164425">prev</a><span>|</span><label class="collapse" for="c-40162065">[-]</label><label class="expand" for="c-40162065">[7 more]</label></div><br/><div class="children"><div class="content">I was expecting to see <a href="https:&#x2F;&#x2F;github.com&#x2F;dimitri&#x2F;pgcopydb">https:&#x2F;&#x2F;github.com&#x2F;dimitri&#x2F;pgcopydb</a> when clicking this. How is this different?</div><br/><div id="40162954" class="c"><input type="checkbox" id="c-40162954" checked=""/><div class="controls bullet"><span class="by">saisrirampur</span><span>|</span><a href="#40162065">parent</a><span>|</span><a href="#40162577">next</a><span>|</span><label class="collapse" for="c-40162954">[-]</label><label class="expand" for="c-40162954">[3 more]</label></div><br/><div class="children"><div class="content">OP here. pgcopydb is also a great tool. It does pg_dump|pg_restore. It cannot multi-thread (parallelize) single table data migration</div><br/><div id="40164521" class="c"><input type="checkbox" id="c-40164521" checked=""/><div class="controls bullet"><span class="by">lmz</span><span>|</span><a href="#40162065">root</a><span>|</span><a href="#40162954">parent</a><span>|</span><a href="#40163151">next</a><span>|</span><label class="collapse" for="c-40164521">[-]</label><label class="expand" for="c-40164521">[1 more]</label></div><br/><div class="children"><div class="content">seems like it can parallelize to an extent: <a href="https:&#x2F;&#x2F;pgcopydb.readthedocs.io&#x2F;en&#x2F;latest&#x2F;concurrency.html#same-table-concurrency" rel="nofollow">https:&#x2F;&#x2F;pgcopydb.readthedocs.io&#x2F;en&#x2F;latest&#x2F;concurrency.html#s...</a></div><br/></div></div><div id="40163151" class="c"><input type="checkbox" id="c-40163151" checked=""/><div class="controls bullet"><span class="by">fyrn_</span><span>|</span><a href="#40162065">root</a><span>|</span><a href="#40162954">parent</a><span>|</span><a href="#40164521">prev</a><span>|</span><a href="#40162577">next</a><span>|</span><label class="collapse" for="c-40163151">[-]</label><label class="expand" for="c-40163151">[1 more]</label></div><br/><div class="children"><div class="content">It only uses pg_dump and pg_restore for transfer of the schema, the actual data transfer is a custom mechanism.</div><br/></div></div></div></div><div id="40162577" class="c"><input type="checkbox" id="c-40162577" checked=""/><div class="controls bullet"><span class="by">joevandyk</span><span>|</span><a href="#40162065">parent</a><span>|</span><a href="#40162954">prev</a><span>|</span><a href="#40162441">next</a><span>|</span><label class="collapse" for="c-40162577">[-]</label><label class="expand" for="c-40162577">[2 more]</label></div><br/><div class="children"><div class="content">does pgcopydb support copying a single table in multiple threads?</div><br/><div id="40167074" class="c"><input type="checkbox" id="c-40167074" checked=""/><div class="controls bullet"><span class="by">fyrn_</span><span>|</span><a href="#40162065">root</a><span>|</span><a href="#40162577">parent</a><span>|</span><a href="#40162441">next</a><span>|</span><label class="collapse" for="c-40167074">[-]</label><label class="expand" for="c-40167074">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;pgcopydb.readthedocs.io&#x2F;en&#x2F;latest&#x2F;concurrency.html#same-table-concurrency" rel="nofollow">https:&#x2F;&#x2F;pgcopydb.readthedocs.io&#x2F;en&#x2F;latest&#x2F;concurrency.html#s...</a></div><br/></div></div></div></div><div id="40162441" class="c"><input type="checkbox" id="c-40162441" checked=""/><div class="controls bullet"><span class="by">digger495</span><span>|</span><a href="#40162065">parent</a><span>|</span><a href="#40162577">prev</a><span>|</span><label class="collapse" for="c-40162441">[-]</label><label class="expand" for="c-40162441">[1 more]</label></div><br/><div class="children"><div class="content">Because this is advertising :)</div><br/></div></div></div></div></div></div></div></div></div></body></html>