<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1735203655002" as="style"/><link rel="stylesheet" href="styles.css?v=1735203655002"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://bernsteinbear.com/blog/cps/">Into CPS, Never to Return</a> <span class="domain">(<a href="https://bernsteinbear.com">bernsteinbear.com</a>)</span></div><div class="subtext"><span>g0xA52A2A</span> | <span>34 comments</span></div><br/><div><div id="42511024" class="c"><input type="checkbox" id="c-42511024" checked=""/><div class="controls bullet"><span class="by">upghost</span><span>|</span><a href="#42513351">next</a><span>|</span><label class="collapse" for="c-42511024">[-]</label><label class="expand" for="c-42511024">[10 more]</label></div><br/><div class="children"><div class="content">In case anyone is wondering, &quot;when would I EVER use this (in hand-written code)?&quot;, it&#x27;s a trick that makes DSL (domain specific language) and small language implementation much easier. A great reference for this is Peter Norvig&#x27;s Paradigms of Artificial Intelligence Programming, when he implements a subset of Prolog and bolsters the functionality using CPS[1].<p>The second, although more
obscure, is that you can use it in languages that do not have &quot;non-local exits&quot; to terminate a deeply nested computation early or return to an earlier point in the call stack.  For example, Clojure does not have nonlocal exits, as only the final form of the function is returned. However, using CPS, you can terminate the expression early and return to the original caller without executing the rest of the function. You probably only want to use this in specialized cases though or it may upset your team, they are tricky to debug.<p>Lastly and probably most controversially, you can make an extensible &quot;if&quot; statement using CPS if you are in a dynamic language and you have no other tools to do so. Admittedly I do sometimes use this in ClojureScript.  This allows you to write &quot;append only&quot; code without continually growing the &quot;cond&quot;. Again, most teams don&#x27;t like this, so it depends on the circumstances, but might be
nice to have in your back pocket if you need it.<p>[1]: <a href="https:&#x2F;&#x2F;github.com&#x2F;norvig&#x2F;paip-lisp&#x2F;blob&#x2F;main&#x2F;docs&#x2F;chapter12.md#compiling-logic-programs">https:&#x2F;&#x2F;github.com&#x2F;norvig&#x2F;paip-lisp&#x2F;blob&#x2F;main&#x2F;docs&#x2F;chapter12...</a></div><br/><div id="42512734" class="c"><input type="checkbox" id="c-42512734" checked=""/><div class="controls bullet"><span class="by">cryptonector</span><span>|</span><a href="#42511024">parent</a><span>|</span><a href="#42513072">next</a><span>|</span><label class="collapse" for="c-42512734">[-]</label><label class="expand" for="c-42512734">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve used something similar to CPS in async I&#x2F;O programs, where at each point that a function wants more I&#x2F;O it queues up a continuation for the event and then returns to the event loop.  This forces one to represent state in a compact way and to use very little stack space for state representation, all of which reduces per-client memory footprint a great deal.</div><br/><div id="42512850" class="c"><input type="checkbox" id="c-42512850" checked=""/><div class="controls bullet"><span class="by">upghost</span><span>|</span><a href="#42511024">root</a><span>|</span><a href="#42512734">parent</a><span>|</span><a href="#42513072">next</a><span>|</span><label class="collapse" for="c-42512850">[-]</label><label class="expand" for="c-42512850">[2 more]</label></div><br/><div class="children"><div class="content">hey that&#x27;s really clever. was this for open source or commercial? was it received well? what language? Very interesting technique</div><br/><div id="42513289" class="c"><input type="checkbox" id="c-42513289" checked=""/><div class="controls bullet"><span class="by">cryptonector</span><span>|</span><a href="#42511024">root</a><span>|</span><a href="#42512850">parent</a><span>|</span><a href="#42513072">next</a><span>|</span><label class="collapse" for="c-42513289">[-]</label><label class="expand" for="c-42513289">[1 more]</label></div><br/><div class="children"><div class="content">&gt; was this for open source or commercial?<p>Proprietary, though I have permission to open source it (but I need to make sure that $WORK picks a license for it).<p>This was specifically for a poor man&#x27;s Kafka as an HTTP server that implements &quot;tail -f&quot; semantics for GET when using `Range:` with the end offset left unspecified, and with `{URI, weak-ETag, offset}` resembling the Kafka `{topic, partition, offset}`.  Non-range requests end when EOF is reached in the file being fetched.  Range requests with the end offset specified end as soon as the requested range has been sent back.  Range requests with the end offset left unspecified do not end until the file is unlinked or renamed away, using inotify to detect those cases, and every time data is written to the file that data is immediately sent to the clients that are waiting &quot;at the tail&quot;.<p>The connection acceptor in the event loop creates a client record and queues reads to call the reader continuation which is just `{client, reader}`, then when a request is fully read the reader continuation will queue up a writer continuation to write the response, and so on.<p>The fact that the underlying abstraction is &quot;just a file&quot; makes this very easy to use because `write(2)` is how you publish data and `rename(2)` and `unlink(2)` is how you &quot;commit transactions&quot; &#x2F; roll logs in your application, and clients immediately find out.  All that completely asynchronously with how the data gets served.  You can even script an application, like using bash, since `echo foo &gt;&gt; some_file` is how you publish data.<p>It&#x27;s extremely useful.<p>&gt; what language?<p>C, specifically for Linux, using epoll and inotify.  The server is multi-processed, with each process single-threaded, and it spawns NPROC workers (or however many you specify).  But naturally this would work very well in Rust, C++, etc., and it could be multi-threaded instead of multi-processed.<p>&gt; Very interesting technique<p>It&#x27;s just C10K with a dash of CPS :)<p>In this particular program the sequence of events is pretty linear.  Since the progression is fairly linear all the continuation functions are one next to the other and one can just read them linearly.  This makes the code quite readable.</div><br/></div></div></div></div></div></div><div id="42513072" class="c"><input type="checkbox" id="c-42513072" checked=""/><div class="controls bullet"><span class="by">joe_the_user</span><span>|</span><a href="#42511024">parent</a><span>|</span><a href="#42512734">prev</a><span>|</span><a href="#42513287">next</a><span>|</span><label class="collapse" for="c-42513072">[-]</label><label class="expand" for="c-42513072">[2 more]</label></div><br/><div class="children"><div class="content"><i>In case anyone is wondering, &quot;when would I EVER use this (in hand-written code)?&quot;, it&#x27;s a trick that makes DSL (domain specific language) and small language implementation much easier.</i><p>Sure but that&#x27;s still saying &quot;this only gets used implementing a language&quot;. And that&#x27;s OK because the continuation construct (A half-executed function passed to another function, wtf) seems like something I&#x27;d be horrified to find in the code of a normal application.</div><br/><div id="42513575" class="c"><input type="checkbox" id="c-42513575" checked=""/><div class="controls bullet"><span class="by">codebje</span><span>|</span><a href="#42511024">root</a><span>|</span><a href="#42513072">parent</a><span>|</span><a href="#42513287">next</a><span>|</span><label class="collapse" for="c-42513575">[-]</label><label class="expand" for="c-42513575">[1 more]</label></div><br/><div class="children"><div class="content">Callbacks with closures are continuations with bad syntax. Admittedly one could call those horrifying without being accused widely of hyperbole, so it’s not a great counter to your point.</div><br/></div></div></div></div><div id="42513287" class="c"><input type="checkbox" id="c-42513287" checked=""/><div class="controls bullet"><span class="by">cma</span><span>|</span><a href="#42511024">parent</a><span>|</span><a href="#42513072">prev</a><span>|</span><a href="#42512246">next</a><span>|</span><label class="collapse" for="c-42513287">[-]</label><label class="expand" for="c-42513287">[1 more]</label></div><br/><div class="children"><div class="content">CPS continuation-passing style</div><br/></div></div><div id="42512246" class="c"><input type="checkbox" id="c-42512246" checked=""/><div class="controls bullet"><span class="by">Vetch</span><span>|</span><a href="#42511024">parent</a><span>|</span><a href="#42513287">prev</a><span>|</span><a href="#42511446">next</a><span>|</span><label class="collapse" for="c-42512246">[-]</label><label class="expand" for="c-42512246">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve also used it to make a function tail recursive, which is useful in languages with TCO.</div><br/><div id="42513596" class="c"><input type="checkbox" id="c-42513596" checked=""/><div class="controls bullet"><span class="by">codebje</span><span>|</span><a href="#42511024">root</a><span>|</span><a href="#42512246">parent</a><span>|</span><a href="#42511446">next</a><span>|</span><label class="collapse" for="c-42513596">[-]</label><label class="expand" for="c-42513596">[1 more]</label></div><br/><div class="children"><div class="content">If your continuation has no state to hold your recursion should already be tail called.<p>If it does have state, it’s probably a stack allocated closure…</div><br/></div></div></div></div><div id="42511446" class="c"><input type="checkbox" id="c-42511446" checked=""/><div class="controls bullet"><span class="by">remexre</span><span>|</span><a href="#42511024">parent</a><span>|</span><a href="#42512246">prev</a><span>|</span><a href="#42513351">next</a><span>|</span><label class="collapse" for="c-42511446">[-]</label><label class="expand" for="c-42511446">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s also really helpful with defunctionalization; search &quot;defunctionalize the continuation&quot; for stuff on that</div><br/></div></div></div></div><div id="42513351" class="c"><input type="checkbox" id="c-42513351" checked=""/><div class="controls bullet"><span class="by">purplesyringa</span><span>|</span><a href="#42511024">prev</a><span>|</span><a href="#42511433">next</a><span>|</span><label class="collapse" for="c-42513351">[-]</label><label class="expand" for="c-42513351">[1 more]</label></div><br/><div class="children"><div class="content">&gt; If you don’t want to do any of this trampoline stuff, you can also do the One Big Switch approach which stuffs each of the funs and conts into a case in a massive switch statement. Calls become gotos.<p>Just wanted to add that this is very similar to how async&#x2F;await JavaScript code was compiled for runtimes that didn&#x27;t support generators back in the day: <a href="http:&#x2F;&#x2F;facebook.github.io&#x2F;regenerator&#x2F;" rel="nofollow">http:&#x2F;&#x2F;facebook.github.io&#x2F;regenerator&#x2F;</a></div><br/></div></div><div id="42511433" class="c"><input type="checkbox" id="c-42511433" checked=""/><div class="controls bullet"><span class="by">childintime</span><span>|</span><a href="#42513351">prev</a><span>|</span><a href="#42512086">next</a><span>|</span><label class="collapse" for="c-42511433">[-]</label><label class="expand" for="c-42511433">[7 more]</label></div><br/><div class="children"><div class="content">The author references [scrapscript](<a href="https:&#x2F;&#x2F;scrapscript.org&#x2F;" rel="nofollow">https:&#x2F;&#x2F;scrapscript.org&#x2F;</a>), hopefully we&#x27;ll hear more about it.</div><br/><div id="42511808" class="c"><input type="checkbox" id="c-42511808" checked=""/><div class="controls bullet"><span class="by">tekknolagi</span><span>|</span><a href="#42511433">parent</a><span>|</span><a href="#42512768">next</a><span>|</span><label class="collapse" for="c-42511808">[-]</label><label class="expand" for="c-42511808">[1 more]</label></div><br/><div class="children"><div class="content">Now that I&#x27;m back at a computer:<p>* <a href="https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript&#x2F;</a><p>* <a href="https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript-baseline&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript-baseline&#x2F;</a><p>* <a href="https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript-tricks&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;scrapscript-tricks&#x2F;</a><p>* <a href="https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;type-inference&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;type-inference&#x2F;</a><p>* <a href="https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;row-poly&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bernsteinbear.com&#x2F;blog&#x2F;row-poly&#x2F;</a><p>and the repo for the main implementation: <a href="https:&#x2F;&#x2F;github.com&#x2F;tekknolagi&#x2F;scrapscript">https:&#x2F;&#x2F;github.com&#x2F;tekknolagi&#x2F;scrapscript</a></div><br/></div></div><div id="42512768" class="c"><input type="checkbox" id="c-42512768" checked=""/><div class="controls bullet"><span class="by">jalict</span><span>|</span><a href="#42511433">parent</a><span>|</span><a href="#42511808">prev</a><span>|</span><a href="#42511507">next</a><span>|</span><label class="collapse" for="c-42512768">[-]</label><label class="expand" for="c-42512768">[1 more]</label></div><br/><div class="children"><div class="content">Scripted Pipelines in Jenkins are also using CPS in Groovy!
<a href="https:&#x2F;&#x2F;plugins.jenkins.io&#x2F;workflow-cps&#x2F;#plugin-content-technical-design" rel="nofollow">https:&#x2F;&#x2F;plugins.jenkins.io&#x2F;workflow-cps&#x2F;#plugin-content-tech...</a></div><br/></div></div><div id="42511507" class="c"><input type="checkbox" id="c-42511507" checked=""/><div class="controls bullet"><span class="by">tekknolagi</span><span>|</span><a href="#42511433">parent</a><span>|</span><a href="#42512768">prev</a><span>|</span><a href="#42512086">next</a><span>|</span><label class="collapse" for="c-42511507">[-]</label><label class="expand" for="c-42511507">[4 more]</label></div><br/><div class="children"><div class="content">See my other blog posts and GitHub if you would like some more!</div><br/><div id="42512029" class="c"><input type="checkbox" id="c-42512029" checked=""/><div class="controls bullet"><span class="by">upghost</span><span>|</span><a href="#42511433">root</a><span>|</span><a href="#42511507">parent</a><span>|</span><a href="#42512086">next</a><span>|</span><label class="collapse" for="c-42512029">[-]</label><label class="expand" for="c-42512029">[3 more]</label></div><br/><div class="children"><div class="content">I realize this is something I should probably know but I&#x27;ve never been able to pin down a definition nor have I used a language with this feature -- could you maybe explain what a &quot;content addressable language&quot; is and why that is important? It seems like it&#x27;s <i>really</i> important but I have no idea why.  You explain it here[1] but it&#x27;s somewhat brief. I realize it probably should be self-evident why it&#x27;s important but it&#x27;s not clicking for me.<p>It&#x27;s somewhat like when Jack Skelington is trying to explain the meaning of Christmas to the residents of Halloween Town[2] and somehow it hasn&#x27;t stuck yet.<p>[1]: <a href="https:&#x2F;&#x2F;scrapscript.org&#x2F;#ContentAddressibleEverything" rel="nofollow">https:&#x2F;&#x2F;scrapscript.org&#x2F;#ContentAddressibleEverything</a><p>[2]: <a href="https:&#x2F;&#x2F;youtu.be&#x2F;l6QZUcRJw-A" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;l6QZUcRJw-A</a></div><br/><div id="42512224" class="c"><input type="checkbox" id="c-42512224" checked=""/><div class="controls bullet"><span class="by">tekknolagi</span><span>|</span><a href="#42511433">root</a><span>|</span><a href="#42512029">parent</a><span>|</span><a href="#42512086">next</a><span>|</span><label class="collapse" for="c-42512224">[-]</label><label class="expand" for="c-42512224">[2 more]</label></div><br/><div class="children"><div class="content">To be clear, I am not Taylor and I did not come up with scrapscript! That website belongs to him and I&#x27;m just a random guy on the internet who emailed him and built an implementation.<p>The way I think about it is kind of like software versions. Say you want to do some kind of reproducible software. You can write that your software depends on jazzinator==3.0.0 but that&#x27;s kind of unsatisfying because it relies either on tools or people to make sure that versions are immutable. It also relies on jazzinator to specify its own dependencies pretty strictly. So maybe you end up inventing the concept of a lockfile to partially solve that problem, but you still have the issue of relying on a third party to not change things up on you.<p><i>However</i>, if you can address a library by a name that is computed from its code (a hash), things get interesting. You end up with this tree&#x2F;DAG of dependencies where every dependency is immutable--you can&#x27;t change the code without also changing the name. It&#x27;s a Merkle DAG like Git. You do lose the ability to say things like &quot;above version 2.5&quot;... sort of.<p>If you also build a ref or tag system (similar to Git refs), you can kinda do normal style versioning on top of this content addressable world. But again, that relies on someone or something (maybe your hash-based store) to keep a map point-version names to hash names.<p>The other thing that&#x27;s interesting with scrapscript in particular is since everything is addressable, you can use (sort of implicitly import&#x2F;download) any value from any other program in a repository readable by you. But no scrapscript implementation fully does this yet, as far as I&#x27;m aware. For a fully working system, check out Unison.</div><br/><div id="42512280" class="c"><input type="checkbox" id="c-42512280" checked=""/><div class="controls bullet"><span class="by">upghost</span><span>|</span><a href="#42511433">root</a><span>|</span><a href="#42512224">parent</a><span>|</span><a href="#42512086">next</a><span>|</span><label class="collapse" for="c-42512280">[-]</label><label class="expand" for="c-42512280">[1 more]</label></div><br/><div class="children"><div class="content">Oh that is really fascinating, thank you. That has some really interesting implications for dependency management that I will have to think through. It sounds like that implies some really useful tree properties on dependency checking, like if the part of the program you are relying on matches a certain hash you don&#x27;t need to check down the chain because you can be sure the rest of the nodes are as you expect.<p>Much appreciated!</div><br/></div></div></div></div></div></div></div></div></div></div><div id="42512086" class="c"><input type="checkbox" id="c-42512086" checked=""/><div class="controls bullet"><span class="by">fovc</span><span>|</span><a href="#42511433">prev</a><span>|</span><a href="#42511170">next</a><span>|</span><label class="collapse" for="c-42512086">[-]</label><label class="expand" for="c-42512086">[1 more]</label></div><br/><div class="children"><div class="content">It’s also useful in typed languages to introduce an existentially quantified type</div><br/></div></div><div id="42511170" class="c"><input type="checkbox" id="c-42511170" checked=""/><div class="controls bullet"><span class="by">_zoltan_</span><span>|</span><a href="#42512086">prev</a><span>|</span><a href="#42512969">next</a><span>|</span><label class="collapse" for="c-42511170">[-]</label><label class="expand" for="c-42511170">[5 more]</label></div><br/><div class="children"><div class="content">I thought I&#x27;m going to read a piece about US&#x27;s Child Protective Services, and clicked. Was a letdown :-)</div><br/><div id="42511899" class="c"><input type="checkbox" id="c-42511899" checked=""/><div class="controls bullet"><span class="by">MobiusHorizons</span><span>|</span><a href="#42511170">parent</a><span>|</span><a href="#42511647">next</a><span>|</span><label class="collapse" for="c-42511899">[-]</label><label class="expand" for="c-42511899">[3 more]</label></div><br/><div class="children"><div class="content">I was pleased to see something properly technical, given that that is the supposed focus of this forum. I Hadn&#x27;t ever heard of CPS as an IR, only SSA, and it was very interesting to learn about it.</div><br/><div id="42512235" class="c"><input type="checkbox" id="c-42512235" checked=""/><div class="controls bullet"><span class="by">tekknolagi</span><span>|</span><a href="#42511170">root</a><span>|</span><a href="#42511899">parent</a><span>|</span><a href="#42513191">next</a><span>|</span><label class="collapse" for="c-42512235">[-]</label><label class="expand" for="c-42512235">[1 more]</label></div><br/><div class="children"><div class="content">Funnily enough, both CPS and SSA are US government services</div><br/></div></div><div id="42513191" class="c"><input type="checkbox" id="c-42513191" checked=""/><div class="controls bullet"><span class="by">cryptonector</span><span>|</span><a href="#42511170">root</a><span>|</span><a href="#42511899">parent</a><span>|</span><a href="#42512235">prev</a><span>|</span><a href="#42511647">next</a><span>|</span><label class="collapse" for="c-42513191">[-]</label><label class="expand" for="c-42513191">[1 more]</label></div><br/><div class="children"><div class="content">CPS is a predecessor technique to SSA, essentially.</div><br/></div></div></div></div><div id="42511647" class="c"><input type="checkbox" id="c-42511647" checked=""/><div class="controls bullet"><span class="by">TapamN</span><span>|</span><a href="#42511170">parent</a><span>|</span><a href="#42511899">prev</a><span>|</span><a href="#42512969">next</a><span>|</span><label class="collapse" for="c-42511647">[-]</label><label class="expand" for="c-42511647">[1 more]</label></div><br/><div class="children"><div class="content">I was hoping, but not expecting, for it to be about the Capcom arcade board.</div><br/></div></div></div></div><div id="42512969" class="c"><input type="checkbox" id="c-42512969" checked=""/><div class="controls bullet"><span class="by">yapyap</span><span>|</span><a href="#42511170">prev</a><span>|</span><a href="#42511250">next</a><span>|</span><label class="collapse" for="c-42512969">[-]</label><label class="expand" for="c-42512969">[1 more]</label></div><br/><div class="children"><div class="content">not gonna lie this title made me think this was gonna be some child protective services horror story or something</div><br/></div></div><div id="42511250" class="c"><input type="checkbox" id="c-42511250" checked=""/><div class="controls bullet"><span class="by">assbuttbuttass</span><span>|</span><a href="#42512969">prev</a><span>|</span><a href="#42510917">next</a><span>|</span><label class="collapse" for="c-42511250">[-]</label><label class="expand" for="c-42511250">[3 more]</label></div><br/><div class="children"><div class="content">CPS is a cool technique, and makes advanced constructs like call&#x2F;cc trivial to implement. Using CPS techniques in code can feel like magic.<p>But CPS isn&#x27;t really the state of the art for functional compilers anymore. It&#x27;s complex for a human to read and hard to optimize. Something like A-normal form is much easier to work with for a compiler intermediate representation<p><a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;A-normal_form" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;A-normal_form</a></div><br/><div id="42512270" class="c"><input type="checkbox" id="c-42512270" checked=""/><div class="controls bullet"><span class="by">Mathnerd314</span><span>|</span><a href="#42511250">parent</a><span>|</span><a href="#42510917">next</a><span>|</span><label class="collapse" for="c-42512270">[-]</label><label class="expand" for="c-42512270">[2 more]</label></div><br/><div class="children"><div class="content">If you think ANF is great then explain how to deal with the transformation from &quot;E (if x then a else b)&quot; to &quot;if x then E a else E b&quot;.</div><br/><div id="42513649" class="c"><input type="checkbox" id="c-42513649" checked=""/><div class="controls bullet"><span class="by">codebje</span><span>|</span><a href="#42511250">root</a><span>|</span><a href="#42512270">parent</a><span>|</span><a href="#42510917">next</a><span>|</span><label class="collapse" for="c-42513649">[-]</label><label class="expand" for="c-42513649">[1 more]</label></div><br/><div class="children"><div class="content">ANF transform will rewrite that to “let a0 = if x then an else b in E a0”.<p>This isn’t identical to floating the call to E inside the “if”, obviously, but would have (within predictable boundaries) the same performance. If this code went through LLVM to produce machine code I suspect it would wind up identical as LLVM will likely rewrite the duplicated call to be outside the “if”.</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>