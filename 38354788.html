<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1700557264901" as="style"/><link rel="stylesheet" href="styles.css?v=1700557264901"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://tailscale.com/blog/quic-udp-throughput/">Increasing QUIC and UDP Throughput over Tailscale</a> <span class="domain">(<a href="https://tailscale.com">tailscale.com</a>)</span></div><div class="subtext"><span>PaulHoule</span> | <span>26 comments</span></div><br/><div><div id="38357285" class="c"><input type="checkbox" id="c-38357285" checked=""/><div class="controls bullet"><span class="by">ultrahax</span><span>|</span><a href="#38359741">next</a><span>|</span><label class="collapse" for="c-38357285">[-]</label><label class="expand" for="c-38357285">[4 more]</label></div><br/><div class="children"><div class="content">Tangentially, I&#x27;ve faced some interesting challenges getting a multi-gigabit Wireguard VPN operating through my 2Gb Frontier connection.<p>My UDM Pro seems to top out around ~800mbit per UDP stream - pegged at 100% CPU on a single core. Likely it can&#x27;t keep up with the interrupt rate, given it&#x27;s ksoftirqd pegging it. Replaced UDM Pro with a pfsense machine.<p>Then I started getting 100% packet loss on the edge of Frontier&#x27;s network after a couple of minutes of sustained UDP near-line-rate throughput. In the end, after trying and failing to explain this to Frontier&#x27;s tech support, I reached out to their engineering management on LinkedIn, and got put in touch with the local NOC director. Turns out to be some intermediate hop is rebooting after a few mins, and they&#x27;re &quot;in contact with the manufacturer&quot;. Haven&#x27;t heard back in a few months.<p>tldr as &gt;1Gb connections become more ubiquitous, other bottlenecks will become apparent!</div><br/><div id="38357999" class="c"><input type="checkbox" id="c-38357999" checked=""/><div class="controls bullet"><span class="by">jjjjmoney</span><span>|</span><a href="#38357285">parent</a><span>|</span><a href="#38357829">next</a><span>|</span><label class="collapse" for="c-38357999">[-]</label><label class="expand" for="c-38357999">[2 more]</label></div><br/><div class="children"><div class="content">&gt; I reached out to their engineering management on LinkedIn, and got put in touch with the local NOC director.<p>I hate that this is a thing. I&#x27;m dealing with a similar potential issue on Charter Spectrum right now. Specifically it&#x27;s an issue that&#x27;s called out here <a href="https:&#x2F;&#x2F;blog.cloudflare.com&#x2F;ip-fragmentation-is-broken&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;blog.cloudflare.com&#x2F;ip-fragmentation-is-broken&#x2F;</a> (failing the IPv4 fragmentation test <a href="http:&#x2F;&#x2F;icmpcheck.popcount.org&#x2F;" rel="nofollow noreferrer">http:&#x2F;&#x2F;icmpcheck.popcount.org&#x2F;</a> ).<p>How on earth is one supposed to get past the front-line tech support in 2023?</div><br/><div id="38360220" class="c"><input type="checkbox" id="c-38360220" checked=""/><div class="controls bullet"><span class="by">thfuran</span><span>|</span><a href="#38357285">root</a><span>|</span><a href="#38357999">parent</a><span>|</span><a href="#38357829">next</a><span>|</span><label class="collapse" for="c-38360220">[-]</label><label class="expand" for="c-38360220">[1 more]</label></div><br/><div class="children"><div class="content">You&#x27;re not supposed to.</div><br/></div></div></div></div><div id="38357829" class="c"><input type="checkbox" id="c-38357829" checked=""/><div class="controls bullet"><span class="by">keep_reading</span><span>|</span><a href="#38357285">parent</a><span>|</span><a href="#38357999">prev</a><span>|</span><a href="#38359741">next</a><span>|</span><label class="collapse" for="c-38357829">[-]</label><label class="expand" for="c-38357829">[1 more]</label></div><br/><div class="children"><div class="content">Smells like Sandvine traffic shaper falling over or something.</div><br/></div></div></div></div><div id="38359741" class="c"><input type="checkbox" id="c-38359741" checked=""/><div class="controls bullet"><span class="by">remram</span><span>|</span><a href="#38357285">prev</a><span>|</span><a href="#38355400">next</a><span>|</span><label class="collapse" for="c-38359741">[-]</label><label class="expand" for="c-38359741">[2 more]</label></div><br/><div class="children"><div class="content">Tailscale uses a custom, userspace, Golang implementation of Wireguard instead of the kernel one? Why?</div><br/><div id="38359776" class="c"><input type="checkbox" id="c-38359776" checked=""/><div class="controls bullet"><span class="by">TheDong</span><span>|</span><a href="#38359741">parent</a><span>|</span><a href="#38355400">next</a><span>|</span><label class="collapse" for="c-38359776">[-]</label><label class="expand" for="c-38359776">[1 more]</label></div><br/><div class="children"><div class="content">Using the same code across more OSs than just linux seems nice.<p>Also, it&#x27;s based on code by the wireguard author: <a href="https:&#x2F;&#x2F;git.zx2c4.com&#x2F;wireguard-go" rel="nofollow noreferrer">https:&#x2F;&#x2F;git.zx2c4.com&#x2F;wireguard-go</a><p>They customized it some, but it&#x27;s all more or less upstream condoned code that Jason built.<p>Also, if you want to access your tailscale network, but don&#x27;t have permissions to create a tun or wg device, the fully userspace implementation can work in that situation, which seems like a nice property to have.</div><br/></div></div></div></div><div id="38355400" class="c"><input type="checkbox" id="c-38355400" checked=""/><div class="controls bullet"><span class="by">gorkish</span><span>|</span><a href="#38359741">prev</a><span>|</span><a href="#38355369">next</a><span>|</span><label class="collapse" for="c-38355400">[-]</label><label class="expand" for="c-38355400">[4 more]</label></div><br/><div class="children"><div class="content">GSO (Generic segmentation offload) is supported for UDP in the Linux kernel from 4.18 so I would assume these optimizations should be easily possible for the kernel driver as well and can take advantage of any drivers that pass the GSO down to the network hardware too.<p>Kinda weird optimization though; I&#x27;m not exactly sure why it works as well as it appears to; I am thinking that the gain may be far far less noticeable&#x2F;important at &lt;1gbps. This may be why there aren&#x27;t any benchmarks for lower end devices or bandwidth constrained paths.<p>On another front, I wonder would there be any advantage to encapsulating a native UDP protocol like wireguard in QUIC frames? Might this result in increased reliability and improved packet handling from firewalls and middleboxes?</div><br/><div id="38356576" class="c"><input type="checkbox" id="c-38356576" checked=""/><div class="controls bullet"><span class="by">stock_toaster</span><span>|</span><a href="#38355400">parent</a><span>|</span><a href="#38355874">next</a><span>|</span><label class="collapse" for="c-38356576">[-]</label><label class="expand" for="c-38356576">[1 more]</label></div><br/><div class="children"><div class="content"><p><pre><code>  &gt; GSO down to the network hardware too
</code></pre>
Isn&#x27;t the article specifically talking about tx-udp-segmentation in the tun driver though, and not the hardware nic adapter?<p>From the article:<p><pre><code>  &gt; The TUN driver support in v6.2 was the missing piece
  &gt; needed to improve UDP throughput over wireguard-go. With
  &gt; it toggled on, wireguard-go can receive “monster” UDP 
  &gt; datagrams from the kernel</code></pre></div><br/></div></div><div id="38355874" class="c"><input type="checkbox" id="c-38355874" checked=""/><div class="controls bullet"><span class="by">dan-robertson</span><span>|</span><a href="#38355400">parent</a><span>|</span><a href="#38356576">prev</a><span>|</span><a href="#38357395">next</a><span>|</span><label class="collapse" for="c-38355874">[-]</label><label class="expand" for="c-38355874">[1 more]</label></div><br/><div class="children"><div class="content">Wireguard udp packets are already pretty unstructured. The first four bytes are 4, 0, 0, 0. They have another 12 bytes of header and then encrypted data.</div><br/></div></div><div id="38357395" class="c"><input type="checkbox" id="c-38357395" checked=""/><div class="controls bullet"><span class="by">tomohawk</span><span>|</span><a href="#38355400">parent</a><span>|</span><a href="#38355874">prev</a><span>|</span><a href="#38355369">next</a><span>|</span><label class="collapse" for="c-38357395">[-]</label><label class="expand" for="c-38357395">[1 more]</label></div><br/><div class="children"><div class="content">GSO improves performance because you can send a ~64kB &quot;datagram&quot; through the stack, and then it will be split up either by the network card (if it supports GSO) or by the kernel.  This is a lot more efficient than sending a pile of 1500 byte packets through the stack.  It also saves a lot of context switches with the kernel.<p>By way of comparison, when you send data over TCP, the system call interface lets you write very large chunks, so a single system call can write gigabytes of data.</div><br/></div></div></div></div><div id="38355369" class="c"><input type="checkbox" id="c-38355369" checked=""/><div class="controls bullet"><span class="by">djha-skin</span><span>|</span><a href="#38355400">prev</a><span>|</span><a href="#38359635">next</a><span>|</span><label class="collapse" for="c-38355369">[-]</label><label class="expand" for="c-38355369">[3 more]</label></div><br/><div class="children"><div class="content">This is pretty cool, but I would have liked to see more benchmarks around phones to servers instead of Linux box to Linux box.<p>UDP and QUIC are most effective serving traffic from phones to servers, not from Linux box to Linux box.<p>Linux boxes are typically either servers or behind a corporate firewall as e.g user laptops such as the one I use at work. There are distinct disadvantages to running QUIC in that environment:<p>* UDP is often blocked by default by corporate firewalls.<p>* Having everything in user space means having to actually update the user software before getting a security patch deep in the transport layer. Compared with getting a kernel patch to fix a TCP vulnerability, which typically happens more often on a Linux box and is more stable than updating userspace software.<p>* TCP throughput in a data center or behind a corporate firewall is typically fast enough for most needs.<p>However, from a phone on a cell tower, QUIC starts to make sense:<p>* Having everything in user space means I can update for security patches every time I update the app, which is much more frequent than OS updates on for example Android.<p>* Having everything over UDP means I can get the usual non head of line blocking benefits so often touted, with top notch security as well.</div><br/><div id="38360693" class="c"><input type="checkbox" id="c-38360693" checked=""/><div class="controls bullet"><span class="by">FridgeSeal</span><span>|</span><a href="#38355369">parent</a><span>|</span><a href="#38356664">next</a><span>|</span><label class="collapse" for="c-38360693">[-]</label><label class="expand" for="c-38360693">[1 more]</label></div><br/><div class="children"><div class="content">&gt; UDP is often blocked by default by corporate firewalls.<p>I mean, that sounds a lot like a “them problem”. Kind of like the people that can’t use grpc because their silly corporate firewall MITM’s the encryption. The rest of us aren’t beholden to archaic IT decisions.<p>&gt; TCP throughput in a data center or behind a corporate firewall is typically fast enough for most needs<p>Yeah but if I <i>can</i> go even faster, why wouldn’t I? Quic gives per-sub-stream back pressure, out of the box that’s so useful! No HoL blocking, substreams, out-of-order reassembly, there’s so many neat features, why wouldn’t you want to use it, given the chance?<p>&gt; Having everything in user space…<p>Means we basically get “user space networking for the rest of us” and that we can run Quic implementations that fit our own applications requirements.</div><br/></div></div><div id="38356664" class="c"><input type="checkbox" id="c-38356664" checked=""/><div class="controls bullet"><span class="by">KMag</span><span>|</span><a href="#38355369">parent</a><span>|</span><a href="#38360693">prev</a><span>|</span><a href="#38359635">next</a><span>|</span><label class="collapse" for="c-38356664">[-]</label><label class="expand" for="c-38356664">[1 more]</label></div><br/><div class="children"><div class="content">Regarding kernel patches coming more often than userspace updates, presumably you mean in the context of random third-party apps not maintained as well as the major browsers.  That&#x27;s fair, but if QUIC becomes popular enough, I imagine we&#x27;ll see distros including QUIC dlls that these minor apps link against.</div><br/></div></div></div></div><div id="38359998" class="c"><input type="checkbox" id="c-38359998" checked=""/><div class="controls bullet"><span class="by">fulafel</span><span>|</span><a href="#38359635">prev</a><span>|</span><a href="#38356323">next</a><span>|</span><label class="collapse" for="c-38359998">[-]</label><label class="expand" for="c-38359998">[1 more]</label></div><br/><div class="children"><div class="content">I wonder what explains the large gap between Mellanox and AWS kernel wireguard performance (the original Go code has a much smaller difference so shouldn&#x27;t be just CPU speed difference).</div><br/></div></div><div id="38356323" class="c"><input type="checkbox" id="c-38356323" checked=""/><div class="controls bullet"><span class="by">dastbe</span><span>|</span><a href="#38359998">prev</a><span>|</span><a href="#38355208">next</a><span>|</span><label class="collapse" for="c-38356323">[-]</label><label class="expand" for="c-38356323">[1 more]</label></div><br/><div class="children"><div class="content">what’s the right way to interpret the last section on cpu utilization? i.e. now that you’re able to achieve 12.5gbps how much overhead is this at a machine level?<p>also was ena express used on the c6i.8xlarge? that should allow for getting past the ec2 single flow limits.</div><br/></div></div><div id="38355208" class="c"><input type="checkbox" id="c-38355208" checked=""/><div class="controls bullet"><span class="by">imperialdrive</span><span>|</span><a href="#38356323">prev</a><span>|</span><a href="#38356588">next</a><span>|</span><label class="collapse" for="c-38355208">[-]</label><label class="expand" for="c-38355208">[1 more]</label></div><br/><div class="children"><div class="content">Y&#x27;all are impressive—Kudos!</div><br/></div></div><div id="38356588" class="c"><input type="checkbox" id="c-38356588" checked=""/><div class="controls bullet"><span class="by">cmer</span><span>|</span><a href="#38355208">prev</a><span>|</span><a href="#38356734">next</a><span>|</span><label class="collapse" for="c-38356588">[-]</label><label class="expand" for="c-38356588">[7 more]</label></div><br/><div class="children"><div class="content">Off-topic: Tailscale seems like such a perfect acquisition target for Cloudflare. It seems like there&#x27;s perfect product and culture alignment. Amirite?</div><br/><div id="38356764" class="c"><input type="checkbox" id="c-38356764" checked=""/><div class="controls bullet"><span class="by">wmf</span><span>|</span><a href="#38356588">parent</a><span>|</span><a href="#38356823">next</a><span>|</span><label class="collapse" for="c-38356764">[-]</label><label class="expand" for="c-38356764">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think they want to be acquired and I&#x27;m not sure it&#x27;s healthy for everything to get sucked into Cloudflare either.</div><br/></div></div><div id="38356823" class="c"><input type="checkbox" id="c-38356823" checked=""/><div class="controls bullet"><span class="by">candiddevmike</span><span>|</span><a href="#38356588">parent</a><span>|</span><a href="#38356764">prev</a><span>|</span><a href="#38356908">next</a><span>|</span><label class="collapse" for="c-38356823">[-]</label><label class="expand" for="c-38356823">[1 more]</label></div><br/><div class="children"><div class="content">Cloudflare tunnels&#x2F;zero trust largely do the same thing as Tailscale. Yes there are some gaps but probably not acquisition worthy</div><br/></div></div><div id="38356908" class="c"><input type="checkbox" id="c-38356908" checked=""/><div class="controls bullet"><span class="by">neverrroot</span><span>|</span><a href="#38356588">parent</a><span>|</span><a href="#38356823">prev</a><span>|</span><a href="#38356990">next</a><span>|</span><label class="collapse" for="c-38356908">[-]</label><label class="expand" for="c-38356908">[1 more]</label></div><br/><div class="children"><div class="content">Hope not. CF is in the meantime too large 
 to really care about “retail” that much.</div><br/></div></div><div id="38356990" class="c"><input type="checkbox" id="c-38356990" checked=""/><div class="controls bullet"><span class="by">vluft</span><span>|</span><a href="#38356588">parent</a><span>|</span><a href="#38356908">prev</a><span>|</span><a href="#38356595">next</a><span>|</span><label class="collapse" for="c-38356990">[-]</label><label class="expand" for="c-38356990">[1 more]</label></div><br/><div class="children"><div class="content">I sure hope you are not.</div><br/></div></div><div id="38356692" class="c"><input type="checkbox" id="c-38356692" checked=""/><div class="controls bullet"><span class="by">dontdoxxme</span><span>|</span><a href="#38356588">parent</a><span>|</span><a href="#38356595">prev</a><span>|</span><a href="#38356734">next</a><span>|</span><label class="collapse" for="c-38356692">[-]</label><label class="expand" for="c-38356692">[1 more]</label></div><br/><div class="children"><div class="content">Not sure if serious. Tailscale is end to end encrypted.<p>Cloudflare is probably just this generation’s Crypto AG: <a href="https:&#x2F;&#x2F;www.agwa.name&#x2F;blog&#x2F;post&#x2F;cloudflare_ssl_added_and_removed_here" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.agwa.name&#x2F;blog&#x2F;post&#x2F;cloudflare_ssl_added_and_rem...</a></div><br/></div></div></div></div></div></div></div></div></div></body></html>