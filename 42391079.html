<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1734166872139" as="style"/><link rel="stylesheet" href="styles.css?v=1734166872139"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://oldbytes.space/@kenshirriff/113606898880486330">The Pentium FDIV bug, reverse-engineered</a> <span class="domain">(<a href="https://oldbytes.space">oldbytes.space</a>)</span></div><div class="subtext"><span>croes</span> | <span>30 comments</span></div><br/><div><div id="42413081" class="c"><input type="checkbox" id="c-42413081" checked=""/><div class="controls bullet"><span class="by">jghn</span><span>|</span><a href="#42412228">next</a><span>|</span><label class="collapse" for="c-42413081">[-]</label><label class="expand" for="c-42413081">[5 more]</label></div><br/><div class="children"><div class="content">An anecdote regarding this bug that always cracks me up. My college roommate showed up with a shiny new pentium machine that year, and kept bragging about how awesome it was. We used some math software called Maple that was pretty intensive for PCs at the time, and he thought he was cool because he could do his homework on his PC instead of on one of the unix machines in the lab.<p>Except that he kept getting wrong answers on his homework.<p>And then he realized that when he did it on one of the unix machines, he got correct answers.<p>And then a few months later he realized why ....</div><br/><div id="42413743" class="c"><input type="checkbox" id="c-42413743" checked=""/><div class="controls bullet"><span class="by">mleo</span><span>|</span><a href="#42413081">parent</a><span>|</span><a href="#42412228">next</a><span>|</span><label class="collapse" for="c-42413743">[-]</label><label class="expand" for="c-42413743">[4 more]</label></div><br/><div class="children"><div class="content">The mention of Maple brings back vivid memories of freshmen year of college when the math department decided to use the software as part of instruction and no one understood how to use it. There was a near revolt by the students.</div><br/><div id="42414069" class="c"><input type="checkbox" id="c-42414069" checked=""/><div class="controls bullet"><span class="by">kens</span><span>|</span><a href="#42413081">root</a><span>|</span><a href="#42413743">parent</a><span>|</span><a href="#42414091">next</a><span>|</span><label class="collapse" for="c-42414069">[-]</label><label class="expand" for="c-42414069">[1 more]</label></div><br/><div class="children"><div class="content">Coincidentally, I was a developer on Maple for a summer, working on definite integration and other things.</div><br/></div></div><div id="42414091" class="c"><input type="checkbox" id="c-42414091" checked=""/><div class="controls bullet"><span class="by">bee_rider</span><span>|</span><a href="#42413081">root</a><span>|</span><a href="#42413743">parent</a><span>|</span><a href="#42414069">prev</a><span>|</span><a href="#42412228">next</a><span>|</span><label class="collapse" for="c-42414091">[-]</label><label class="expand" for="c-42414091">[2 more]</label></div><br/><div class="children"><div class="content">And you know a week before the semester, the TA’s were given given a copy and told to figure it out.</div><br/><div id="42414382" class="c"><input type="checkbox" id="c-42414382" checked=""/><div class="controls bullet"><span class="by">WalterBright</span><span>|</span><a href="#42413081">root</a><span>|</span><a href="#42414091">parent</a><span>|</span><a href="#42412228">next</a><span>|</span><label class="collapse" for="c-42414382">[-]</label><label class="expand" for="c-42414382">[1 more]</label></div><br/><div class="children"><div class="content">&gt; were given given a copy and told to figure it out<p>Welcome to engineering. That&#x27;s what we do. It&#x27;s all we do.</div><br/></div></div></div></div></div></div></div></div><div id="42412228" class="c"><input type="checkbox" id="c-42412228" checked=""/><div class="controls bullet"><span class="by">molticrystal</span><span>|</span><a href="#42413081">prev</a><span>|</span><a href="#42412755">next</a><span>|</span><label class="collapse" for="c-42412228">[-]</label><label class="expand" for="c-42412228">[2 more]</label></div><br/><div class="children"><div class="content">The story was posted a couple days ago and ken left a couple comments there:
<a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42388455">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=42388455</a><p>I look forward to the promised proper write up that should be out soon.</div><br/><div id="42414178" class="c"><input type="checkbox" id="c-42414178" checked=""/><div class="controls bullet"><span class="by">pests</span><span>|</span><a href="#42412228">parent</a><span>|</span><a href="#42412755">next</a><span>|</span><label class="collapse" for="c-42414178">[-]</label><label class="expand" for="c-42414178">[1 more]</label></div><br/><div class="children"><div class="content">There is a certain theme of posts on HN where I am just certain the author is gonna be Ken and again not disappointed.</div><br/></div></div></div></div><div id="42412755" class="c"><input type="checkbox" id="c-42412755" checked=""/><div class="controls bullet"><span class="by">mega_dingus</span><span>|</span><a href="#42412228">prev</a><span>|</span><a href="#42412179">next</a><span>|</span><label class="collapse" for="c-42412755">[-]</label><label class="expand" for="c-42412755">[5 more]</label></div><br/><div class="children"><div class="content">Oh to remember mid-90s humor<p>How many Intel engineers does it take to change a light bulb? 0.99999999</div><br/><div id="42413501" class="c"><input type="checkbox" id="c-42413501" checked=""/><div class="controls bullet"><span class="by">zoky</span><span>|</span><a href="#42412755">parent</a><span>|</span><a href="#42412179">next</a><span>|</span><label class="collapse" for="c-42413501">[-]</label><label class="expand" for="c-42413501">[4 more]</label></div><br/><div class="children"><div class="content">Why didn’t Intel call the Pentium the 586? Because they added 486+100 on the first one they made and got 585.999999987.</div><br/><div id="42414147" class="c"><input type="checkbox" id="c-42414147" checked=""/><div class="controls bullet"><span class="by">Dalewyn</span><span>|</span><a href="#42412755">root</a><span>|</span><a href="#42413501">parent</a><span>|</span><a href="#42412179">next</a><span>|</span><label class="collapse" for="c-42414147">[-]</label><label class="expand" for="c-42414147">[3 more]</label></div><br/><div class="children"><div class="content">Amusing joke, but it actually is effectively called the 586 because the internal name is P5 and Penta from which Pentium is derived is 5.[1]<p>Incidentally, Pentium M to Intel Core through 16th gen Lunarrow Lake all identify as P6 (&quot;Family 6&quot;) for 686 because they are all based off of the Pentium 3.<p>[1]: <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Pentium_(original)" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Pentium_(original)</a></div><br/><div id="42414582" class="c"><input type="checkbox" id="c-42414582" checked=""/><div class="controls bullet"><span class="by">xattt</span><span>|</span><a href="#42412755">root</a><span>|</span><a href="#42414147">parent</a><span>|</span><a href="#42414579">next</a><span>|</span><label class="collapse" for="c-42414582">[-]</label><label class="expand" for="c-42414582">[1 more]</label></div><br/><div class="children"><div class="content">You’re missing the fact that Intel wanted to differentiate itself from the growing IA-32 clone chips from AMD and Cyrix. 586 couldn’t be trademarked, but Pentium could.</div><br/></div></div><div id="42414579" class="c"><input type="checkbox" id="c-42414579" checked=""/><div class="controls bullet"><span class="by">nayuki</span><span>|</span><a href="#42412755">root</a><span>|</span><a href="#42414147">parent</a><span>|</span><a href="#42414582">prev</a><span>|</span><a href="#42412179">next</a><span>|</span><label class="collapse" for="c-42414579">[-]</label><label class="expand" for="c-42414579">[1 more]</label></div><br/><div class="children"><div class="content">Also, as per the page:<p>&gt; Intel used the Pentium name instead of 586, because in 1991, it had lost a trademark dispute over the &quot;386&quot; trademark, when a judge ruled that the number was generic.</div><br/></div></div></div></div></div></div></div></div><div id="42412179" class="c"><input type="checkbox" id="c-42412179" checked=""/><div class="controls bullet"><span class="by">perdomon</span><span>|</span><a href="#42412755">prev</a><span>|</span><a href="#42412198">next</a><span>|</span><label class="collapse" for="c-42412179">[-]</label><label class="expand" for="c-42412179">[4 more]</label></div><br/><div class="children"><div class="content">This dude pulled out a microscope and said &quot;there&#x27;s your problem.&quot; Super impressive work. Really great micro-read.</div><br/><div id="42414512" class="c"><input type="checkbox" id="c-42414512" checked=""/><div class="controls bullet"><span class="by">sgerenser</span><span>|</span><a href="#42412179">parent</a><span>|</span><a href="#42412754">next</a><span>|</span><label class="collapse" for="c-42414512">[-]</label><label class="expand" for="c-42414512">[1 more]</label></div><br/><div class="children"><div class="content">I wonder what node generation doing this type of thing becomes impossible (due to features being too small to be visible with an optical microscope)? I would have guessed sometime before the first Pentium, but obviously not.</div><br/></div></div><div id="42412754" class="c"><input type="checkbox" id="c-42412754" checked=""/><div class="controls bullet"><span class="by">layer8</span><span>|</span><a href="#42412179">parent</a><span>|</span><a href="#42414512">prev</a><span>|</span><a href="#42412198">next</a><span>|</span><label class="collapse" for="c-42412754">[-]</label><label class="expand" for="c-42412754">[2 more]</label></div><br/><div class="children"><div class="content">To be fair, he knew what the problem was (errors in the lookup table) beforehand.</div><br/><div id="42414191" class="c"><input type="checkbox" id="c-42414191" checked=""/><div class="controls bullet"><span class="by">pests</span><span>|</span><a href="#42412179">root</a><span>|</span><a href="#42412754">parent</a><span>|</span><a href="#42412198">next</a><span>|</span><label class="collapse" for="c-42414191">[-]</label><label class="expand" for="c-42414191">[1 more]</label></div><br/><div class="children"><div class="content">It’s not like the microscope is going to show “a lookup table” though. You need to know how it was implemented in silicon, how transistors are integrated into the silicon, etc to even start identifying the actual physical mistake.</div><br/></div></div></div></div></div></div><div id="42412198" class="c"><input type="checkbox" id="c-42412198" checked=""/><div class="controls bullet"><span class="by">Cumpiler69</span><span>|</span><a href="#42412179">prev</a><span>|</span><a href="#42412492">next</a><span>|</span><label class="collapse" for="c-42412198">[-]</label><label class="expand" for="c-42412198">[8 more]</label></div><br/><div class="children"><div class="content">This is probably one of the reasons Intel went to a microcode architecture after.<p>I wonder how many yet to be discover silicone bugs are out there on modern chips?</div><br/><div id="42412511" class="c"><input type="checkbox" id="c-42412511" checked=""/><div class="controls bullet"><span class="by">Lammy</span><span>|</span><a href="#42412198">parent</a><span>|</span><a href="#42412588">next</a><span>|</span><label class="collapse" for="c-42412511">[-]</label><label class="expand" for="c-42412511">[1 more]</label></div><br/><div class="children"><div class="content">Older Intel CPUs were already using microcode. Intel went after NEC with a copyright case over 8086 microcode, and after AMD with a copyright case over 287&#x2F;386&#x2F;486 microcode:<p>- <a href="https:&#x2F;&#x2F;thechipletter.substack.com&#x2F;p&#x2F;intel-vs-nec-the-case-of-the-v20s" rel="nofollow">https:&#x2F;&#x2F;thechipletter.substack.com&#x2F;p&#x2F;intel-vs-nec-the-case-o...</a><p>- <a href="https:&#x2F;&#x2F;www.upi.com&#x2F;Archives&#x2F;1994&#x2F;03&#x2F;10&#x2F;Jury-backs-AMD-in-dispute-with-Intel&#x2F;8611763275600&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.upi.com&#x2F;Archives&#x2F;1994&#x2F;03&#x2F;10&#x2F;Jury-backs-AMD-in-di...</a><p>I would totally believe the FDIV bug is why Intel went to a <i>patchable</i> microcode architecture however. See “Intel P6 Microcode Can Be Patched  — Intel Discloses Details of Download Mechanism for Fixing CPU Bugs (1997)” <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=35934367">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=35934367</a></div><br/></div></div><div id="42412588" class="c"><input type="checkbox" id="c-42412588" checked=""/><div class="controls bullet"><span class="by">kens</span><span>|</span><a href="#42412198">parent</a><span>|</span><a href="#42412511">prev</a><span>|</span><a href="#42413777">next</a><span>|</span><label class="collapse" for="c-42412588">[-]</label><label class="expand" for="c-42412588">[1 more]</label></div><br/><div class="children"><div class="content">Intel used microcode starting with the 8086. However, patchable microcode wasn&#x27;t introduced until the Pentium Pro. The original purpose was for testing, being able to run special test microcode routines. But after the Pentium, Intel realized that being able to patch microcode was also good for fixing bugs in the field.</div><br/></div></div><div id="42413777" class="c"><input type="checkbox" id="c-42413777" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#42412198">parent</a><span>|</span><a href="#42412588">prev</a><span>|</span><a href="#42412460">next</a><span>|</span><label class="collapse" for="c-42413777">[-]</label><label class="expand" for="c-42413777">[1 more]</label></div><br/><div class="children"><div class="content">Look at how long the public errata lists are, and use that as a lower bound.<p>Related article: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=16058920">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=16058920</a></div><br/></div></div><div id="42412460" class="c"><input type="checkbox" id="c-42412460" checked=""/><div class="controls bullet"><span class="by">wmf</span><span>|</span><a href="#42412198">parent</a><span>|</span><a href="#42413777">prev</a><span>|</span><a href="#42412432">next</a><span>|</span><label class="collapse" for="c-42412460">[-]</label><label class="expand" for="c-42412460">[2 more]</label></div><br/><div class="children"><div class="content">They always used microcode: <a href="https:&#x2F;&#x2F;www.righto.com&#x2F;2022&#x2F;11&#x2F;how-8086-processors-microcode-engine.html" rel="nofollow">https:&#x2F;&#x2F;www.righto.com&#x2F;2022&#x2F;11&#x2F;how-8086-processors-microcode...</a><p>I&#x27;m not sure when Intel started supporting microcode updates but I think it was much later.</div><br/><div id="42414522" class="c"><input type="checkbox" id="c-42414522" checked=""/><div class="controls bullet"><span class="by">LukeShu</span><span>|</span><a href="#42412198">root</a><span>|</span><a href="#42412460">parent</a><span>|</span><a href="#42412432">next</a><span>|</span><label class="collapse" for="c-42414522">[-]</label><label class="expand" for="c-42414522">[1 more]</label></div><br/><div class="children"><div class="content">Microcode updates came the very next generation with the Pentium Pro.</div><br/></div></div></div></div><div id="42412432" class="c"><input type="checkbox" id="c-42412432" checked=""/><div class="controls bullet"><span class="by">KingLancelot</span><span>|</span><a href="#42412198">parent</a><span>|</span><a href="#42412460">prev</a><span>|</span><a href="#42412492">next</a><span>|</span><label class="collapse" for="c-42412432">[-]</label><label class="expand" for="c-42412432">[2 more]</label></div><br/><div class="children"><div class="content">Silicone is plastic, Silicon is the element.</div><br/><div id="42413095" class="c"><input type="checkbox" id="c-42413095" checked=""/><div class="controls bullet"><span class="by">jghn</span><span>|</span><a href="#42412198">root</a><span>|</span><a href="#42412432">parent</a><span>|</span><a href="#42412492">next</a><span>|</span><label class="collapse" for="c-42413095">[-]</label><label class="expand" for="c-42413095">[1 more]</label></div><br/><div class="children"><div class="content">Not according to General Beringer of NORAD! :) [1]<p>[1] <a href="https:&#x2F;&#x2F;youtu.be&#x2F;iRsycWRQrc8?t=82" rel="nofollow">https:&#x2F;&#x2F;youtu.be&#x2F;iRsycWRQrc8?t=82</a></div><br/></div></div></div></div></div></div><div id="42412492" class="c"><input type="checkbox" id="c-42412492" checked=""/><div class="controls bullet"><span class="by">Thaxll</span><span>|</span><a href="#42412198">prev</a><span>|</span><label class="collapse" for="c-42412492">[-]</label><label class="expand" for="c-42412492">[5 more]</label></div><br/><div class="children"><div class="content">So nowdays this table could have been fixed with a microcode update right?</div><br/><div id="42413363" class="c"><input type="checkbox" id="c-42413363" checked=""/><div class="controls bullet"><span class="by">phire</span><span>|</span><a href="#42412492">parent</a><span>|</span><a href="#42412542">next</a><span>|</span><label class="collapse" for="c-42413363">[-]</label><label class="expand" for="c-42413363">[3 more]</label></div><br/><div class="children"><div class="content">The table couldn&#x27;t be fixed. But it can be bypassed.<p>The microcode update would need to disable the entire FDIV instruction and re-implement it without using any floating point hardware at all, at least for the problematic devisors. It would be as slow as the software workarounds for the FDIV bug (average penalty for random divisors was apparently 50 cycles).<p>The main advantage of a microcode update is that all FDIVs are automatically intercepted system-wide, while the software workarounds needed to somehow find and replace all FDIVs in the target software. Some did it by recompiling, others scanned for FDIV instructions in machine code and replaced them; Both approaches were problematic and self-modifying code would be hard to catch.<p>A microcode update <i>&quot;might&quot;</i> have allowed Intel to argue their way out of an extensive recall. But 50 cycles on average is a massive performance hit, FDIV takes 19 cycles for single-precision.   
BTW, this microcode update would have killed performance in quake, which famously depended on floating point instructions (especially the expensive FDIV) running in parallel with integer instructions.</div><br/><div id="42414307" class="c"><input type="checkbox" id="c-42414307" checked=""/><div class="controls bullet"><span class="by">hakfoo</span><span>|</span><a href="#42412492">root</a><span>|</span><a href="#42413363">parent</a><span>|</span><a href="#42412542">next</a><span>|</span><label class="collapse" for="c-42414307">[-]</label><label class="expand" for="c-42414307">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s interesting that there&#x27;s no &quot;trap instruction&#x2F;sequence&quot; feature built into the CPU architecture.  That would presumably be valuable for auditing and debugging, or to create a custom instruction by trapping an otherwise unused bit sequence.</div><br/><div id="42415301" class="c"><input type="checkbox" id="c-42415301" checked=""/><div class="controls bullet"><span class="by">j16sdiz</span><span>|</span><a href="#42412492">root</a><span>|</span><a href="#42414307">parent</a><span>|</span><a href="#42412542">next</a><span>|</span><label class="collapse" for="c-42415301">[-]</label><label class="expand" for="c-42415301">[1 more]</label></div><br/><div class="children"><div class="content">&gt; create a custom instruction by trapping an otherwise unused bit sequence. ..<p>... until a new CPU support an instruction extension that use the same bit sequence.</div><br/></div></div></div></div></div></div><div id="42412542" class="c"><input type="checkbox" id="c-42412542" checked=""/><div class="controls bullet"><span class="by">jeffbee</span><span>|</span><a href="#42412492">parent</a><span>|</span><a href="#42413363">prev</a><span>|</span><label class="collapse" for="c-42412542">[-]</label><label class="expand" for="c-42412542">[1 more]</label></div><br/><div class="children"><div class="content">With a microcode update that ruins FDIV performance, sure. Even at that time there were CPUs still using microcoded division, like the AMD K5.</div><br/></div></div></div></div></div></div></div></div></div></body></html>