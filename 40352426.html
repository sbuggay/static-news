<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1715677264332" as="style"/><link rel="stylesheet" href="styles.css?v=1715677264332"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://qmacro.org/blog/posts/2024/05/13/using-arg-in-a-dockerfile-beware-the-gotcha/">Using ARG in a Dockerfile – beware the gotcha</a> <span class="domain">(<a href="https://qmacro.org">qmacro.org</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>11 comments</span></div><br/><div><div id="40352963" class="c"><input type="checkbox" id="c-40352963" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#40353011">next</a><span>|</span><label class="collapse" for="c-40352963">[-]</label><label class="expand" for="c-40352963">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Perhaps I should have read the entire reference document for all the Dockerfile instructions first.<p>I really, really hate to be &quot;that one guy&quot; (c) Rachel Kroll, but... if you&#x27;re about to use a large, old, complicated piece of software, the chances are very good that its developers have mental models about what is good software, and what is good documentation, and what is self-evident and what is not, that are very, <i>very</i> different from yours, especially if you&#x27;re a programmer and the piece of software is aimed at the sysadmins&#x2F;ops&#x2F;devops — so yes, read the whole docs. The things are not what you would hope they are.</div><br/></div></div><div id="40353011" class="c"><input type="checkbox" id="c-40353011" checked=""/><div class="controls bullet"><span class="by">hooby</span><span>|</span><a href="#40352963">prev</a><span>|</span><a href="#40352881">next</a><span>|</span><label class="collapse" for="c-40353011">[-]</label><label class="expand" for="c-40353011">[1 more]</label></div><br/><div class="children"><div class="content">So, each stage&#x2F;each FROM has it&#x27;s own scope basically. If you define an ARG in the global scope, you have to import it to the local scope before using it.<p>Not terribly unusual, but I wasn&#x27;t aware of it - so yeah, wouldn&#x27;t hurt if the docs for ARG mentioned it.<p>Maybe submitting a PR for an addition to the docs would help more people than writing a blog post about it?</div><br/></div></div><div id="40352881" class="c"><input type="checkbox" id="c-40352881" checked=""/><div class="controls bullet"><span class="by">miguelaeh</span><span>|</span><a href="#40353011">prev</a><span>|</span><a href="#40352671">next</a><span>|</span><label class="collapse" for="c-40352881">[-]</label><label class="expand" for="c-40352881">[6 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t see the gotcha, that&#x27;s how it is supposed to work. It&#x27;s just their purpose</div><br/><div id="40352990" class="c"><input type="checkbox" id="c-40352990" checked=""/><div class="controls bullet"><span class="by">Joker_vD</span><span>|</span><a href="#40352881">parent</a><span>|</span><a href="#40352921">next</a><span>|</span><label class="collapse" for="c-40352990">[-]</label><label class="expand" for="c-40352990">[2 more]</label></div><br/><div class="children"><div class="content">The gotcha is that users only read the smallest possible amount of docs (which is usually zero), at the most &quot;focused&quot; placed (e.g. the docs for exactly one command they suspect is misbehaving, not for all of the commands used in the script, and definitely not the intro into the docs where the concepts are explained), and the doc writers don&#x27;t bother to duplicate the information in all the relevant places.</div><br/><div id="40353034" class="c"><input type="checkbox" id="c-40353034" checked=""/><div class="controls bullet"><span class="by">resonious</span><span>|</span><a href="#40352881">root</a><span>|</span><a href="#40352990">parent</a><span>|</span><a href="#40352921">next</a><span>|</span><label class="collapse" for="c-40353034">[-]</label><label class="expand" for="c-40353034">[1 more]</label></div><br/><div class="children"><div class="content">This is true, and then they will complain about lack of or poor documentation.</div><br/></div></div></div></div><div id="40352921" class="c"><input type="checkbox" id="c-40352921" checked=""/><div class="controls bullet"><span class="by">BonusPlay</span><span>|</span><a href="#40352881">parent</a><span>|</span><a href="#40352990">prev</a><span>|</span><a href="#40352671">next</a><span>|</span><label class="collapse" for="c-40352921">[-]</label><label class="expand" for="c-40352921">[3 more]</label></div><br/><div class="children"><div class="content">The gotcha is that &quot;global&quot; args don&#x27;t propagate automatically to all stages (thin includes 1 stage builds).<p><i>I want this one arg in multiple stages, so I&#x27;ll declare it above everything</i> is the chain of thought.</div><br/><div id="40353016" class="c"><input type="checkbox" id="c-40353016" checked=""/><div class="controls bullet"><span class="by">koito17</span><span>|</span><a href="#40352881">root</a><span>|</span><a href="#40352921">parent</a><span>|</span><a href="#40352973">next</a><span>|</span><label class="collapse" for="c-40353016">[-]</label><label class="expand" for="c-40353016">[1 more]</label></div><br/><div class="children"><div class="content">I interpret each directive in a Dockerfile as creating a new layer of an image. So this ARG-before-FROM gotcha doesn&#x27;t feel like a gotcha to me, but rather, the consequence of literally interpreting &quot;ARG&quot; and not knowing the side-effects of a directive in a Dockerfile. (Yes, even WORKDIR, ENTRYPOINT, and related instructions create a layer, albeit a 0-byte one)</div><br/></div></div><div id="40352973" class="c"><input type="checkbox" id="c-40352973" checked=""/><div class="controls bullet"><span class="by">johanbcn</span><span>|</span><a href="#40352881">root</a><span>|</span><a href="#40352921">parent</a><span>|</span><a href="#40353016">prev</a><span>|</span><a href="#40352671">next</a><span>|</span><label class="collapse" for="c-40352973">[-]</label><label class="expand" for="c-40352973">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s explained on the official documentation:
<a href="https:&#x2F;&#x2F;docs.docker.com&#x2F;reference&#x2F;dockerfile&#x2F;#scope" rel="nofollow">https:&#x2F;&#x2F;docs.docker.com&#x2F;reference&#x2F;dockerfile&#x2F;#scope</a></div><br/></div></div></div></div></div></div><div id="40352671" class="c"><input type="checkbox" id="c-40352671" checked=""/><div class="controls bullet"><span class="by">imp0cat</span><span>|</span><a href="#40352881">prev</a><span>|</span><label class="collapse" for="c-40352671">[-]</label><label class="expand" for="c-40352671">[2 more]</label></div><br/><div class="children"><div class="content">tldr; ARG values are only valid in the build image, not anywhere else.<p>In a multistage build, they are only valid in the image that declared them (ie. they do not magically pass over to any other image).</div><br/><div id="40352920" class="c"><input type="checkbox" id="c-40352920" checked=""/><div class="controls bullet"><span class="by">a_t48</span><span>|</span><a href="#40352671">parent</a><span>|</span><label class="collapse" for="c-40352920">[-]</label><label class="expand" for="c-40352920">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s kind of funky when you use them in the names of stages, too. IIRC you have to declare them right above.</div><br/></div></div></div></div></div></div></div></div></div></body></html>