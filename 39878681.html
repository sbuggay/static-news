<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1711875653635" as="style"/><link rel="stylesheet" href="styles.css?v=1711875653635"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://gynvael.coldwind.pl/?lang=en&amp;id=782">Xz/liblzma: Bash-stage Obfuscation Explained</a> <span class="domain">(<a href="https://gynvael.coldwind.pl">gynvael.coldwind.pl</a>)</span></div><div class="subtext"><span>ecliptik</span> | <span>33 comments</span></div><br/><div><div id="39878833" class="c"><input type="checkbox" id="c-39878833" checked=""/><div class="controls bullet"><span class="by">politelemon</span><span>|</span><a href="#39880392">next</a><span>|</span><label class="collapse" for="c-39878833">[-]</label><label class="expand" for="c-39878833">[5 more]</label></div><br/><div class="children"><div class="content">Thanks the simplified explanation and noisy image comparison is quite appreciated. It gives me a good grasp of what people mean by the sophistication involved.<p>I also saw a comment on reddit mentioning that the &quot;sandboxing&quot; method was sabotaged with a dot. It&#x27;s on the line just after &quot;#include &lt;sys&#x2F;prctl.h&gt;&quot; you can see a dot all the way on the left.<p><a href="https:&#x2F;&#x2F;git.tukaani.org&#x2F;?p=xz.git;a=commitdiff;h=328c52da8a2bbb81307644efdb58db2c422d9ba7" rel="nofollow">https:&#x2F;&#x2F;git.tukaani.org&#x2F;?p=xz.git;a=commitdiff;h=328c52da8a2...</a><p><a href="https:&#x2F;&#x2F;old.reddit.com&#x2F;r&#x2F;linux&#x2F;comments&#x2F;1brhlur&#x2F;xz_utils_backdoor&#x2F;kx9b9wc&#x2F;" rel="nofollow">https:&#x2F;&#x2F;old.reddit.com&#x2F;r&#x2F;linux&#x2F;comments&#x2F;1brhlur&#x2F;xz_utils_bac...</a></div><br/><div id="39879862" class="c"><input type="checkbox" id="c-39879862" checked=""/><div class="controls bullet"><span class="by">temp12237792</span><span>|</span><a href="#39878833">parent</a><span>|</span><a href="#39880392">next</a><span>|</span><label class="collapse" for="c-39879862">[-]</label><label class="expand" for="c-39879862">[4 more]</label></div><br/><div class="children"><div class="content">OMG that&#x27;s evil. The diff just shows:<p><pre><code>  +
  +.
  +
</code></pre>
and the dot goes unnoticed</div><br/><div id="39880731" class="c"><input type="checkbox" id="c-39880731" checked=""/><div class="controls bullet"><span class="by">emmelaich</span><span>|</span><a href="#39878833">root</a><span>|</span><a href="#39879862">parent</a><span>|</span><a href="#39880509">next</a><span>|</span><label class="collapse" for="c-39880731">[-]</label><label class="expand" for="c-39880731">[2 more]</label></div><br/><div class="children"><div class="content">I wonder why they didn&#x27;t use a non-breaking space or similar.  I guess it&#x27;s possible a nbsp would stand out even more.</div><br/><div id="39881234" class="c"><input type="checkbox" id="c-39881234" checked=""/><div class="controls bullet"><span class="by">jetpks</span><span>|</span><a href="#39878833">root</a><span>|</span><a href="#39880731">parent</a><span>|</span><a href="#39880509">next</a><span>|</span><label class="collapse" for="c-39881234">[-]</label><label class="expand" for="c-39881234">[1 more]</label></div><br/><div class="children"><div class="content">the extra dot is easily hand waved away as a mistake. a non breaking space looks intentional.</div><br/></div></div></div></div><div id="39880509" class="c"><input type="checkbox" id="c-39880509" checked=""/><div class="controls bullet"><span class="by">cqqxo4zV46cp</span><span>|</span><a href="#39878833">root</a><span>|</span><a href="#39879862">parent</a><span>|</span><a href="#39880731">prev</a><span>|</span><a href="#39880392">next</a><span>|</span><label class="collapse" for="c-39880509">[-]</label><label class="expand" for="c-39880509">[1 more]</label></div><br/><div class="children"><div class="content">like a more (ostensibly) malicious “goto fail”</div><br/></div></div></div></div></div></div><div id="39880392" class="c"><input type="checkbox" id="c-39880392" checked=""/><div class="controls bullet"><span class="by">Martinussen</span><span>|</span><a href="#39878833">prev</a><span>|</span><a href="#39879030">next</a><span>|</span><label class="collapse" for="c-39880392">[-]</label><label class="expand" for="c-39880392">[9 more]</label></div><br/><div class="children"><div class="content">How on earth did any of this make it through a code review and get merged in? It seems absurdly careless, unless I am missing something.</div><br/><div id="39880838" class="c"><input type="checkbox" id="c-39880838" checked=""/><div class="controls bullet"><span class="by">plg94</span><span>|</span><a href="#39880392">parent</a><span>|</span><a href="#39880434">next</a><span>|</span><label class="collapse" for="c-39880838">[-]</label><label class="expand" for="c-39880838">[7 more]</label></div><br/><div class="children"><div class="content">the bad actor was a co-maintainer of the repo (and even more active than the original maintainer for quite some time) with full commit rights. This was strait committed to master, no PR and no review required.<p>edit: also this was heavily obfuscated in some binary files that were marked as test files (&quot;good&quot; and &quot;bad&quot; xz compressed test file). No way to spot this if you don&#x27;t know what you&#x27;re looking for.</div><br/><div id="39882088" class="c"><input type="checkbox" id="c-39882088" checked=""/><div class="controls bullet"><span class="by">jghn</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39880838">parent</a><span>|</span><a href="#39882169">next</a><span>|</span><label class="collapse" for="c-39882088">[-]</label><label class="expand" for="c-39882088">[1 more]</label></div><br/><div class="children"><div class="content">Not only were they a co-maintainer, but if you&#x27;re relying on code review to ensure correctness and security, you&#x27;ve already lost the battle.<p>Code reviews are more about education and de-siloing.</div><br/></div></div><div id="39882169" class="c"><input type="checkbox" id="c-39882169" checked=""/><div class="controls bullet"><span class="by">1letterunixname</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39880838">parent</a><span>|</span><a href="#39882088">prev</a><span>|</span><a href="#39881386">next</a><span>|</span><label class="collapse" for="c-39882169">[-]</label><label class="expand" for="c-39882169">[1 more]</label></div><br/><div class="children"><div class="content">This is the problem of projects that allow direct access and lack code review.</div><br/></div></div><div id="39881386" class="c"><input type="checkbox" id="c-39881386" checked=""/><div class="controls bullet"><span class="by">SV_BubbleTime</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39880838">parent</a><span>|</span><a href="#39882169">prev</a><span>|</span><a href="#39880434">next</a><span>|</span><label class="collapse" for="c-39881386">[-]</label><label class="expand" for="c-39881386">[4 more]</label></div><br/><div class="children"><div class="content">In addition… if your build system has things like this as OK:<p>&gt; xz -dc $top_srcdir&#x2F;tests&#x2F;files&#x2F;$p | eval $i | LC_ALL=C sed &quot;s&#x2F;\(.\)&#x2F;\1\n&#x2F;g&quot; | LC_ALL=C awk &#x27;BEGIN{FS=&quot;\n&quot;;RS=&quot;\n&quot;;ORS=&quot;&quot;;m=256;for(i=0;i&lt;m;i++){t[sprintf(&quot;x%c&quot;,i)]=i;c[i]=((i*7)+5)%m;}i=0;j=0;for(l=0;l&lt;8192;l++){i=(i+1)%m;a=c[i];j=(j+a)%m;c[i]=c[j];c[j]=a;}}{v=t[&quot;x&quot; (NF&lt;1?RS:$1)];i=(i+1)%m;a=c[i];j=<p>You should probably expect the potential for abuse?<p>We’re moving towards complexity that is outpacing human ability for any one person to understand, explain, and thus check an entire object.<p>And for what? Build efficiency? Making a “trick” thing? When was the project ever going to go back and make things simpler? (Never)</div><br/><div id="39881902" class="c"><input type="checkbox" id="c-39881902" checked=""/><div class="controls bullet"><span class="by">necubi</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39881386">parent</a><span>|</span><a href="#39882194">next</a><span>|</span><label class="collapse" for="c-39881902">[-]</label><label class="expand" for="c-39881902">[2 more]</label></div><br/><div class="children"><div class="content">I’m not sure why you’d say that we’re “moving towards” this sort of build system complexity.<p>This is 1990s autoconf bs that has not yet been excised from the Linux ecosystem. Every modern build system, even the really obtuse ones, are less insane than autoconf.<p>And the original purpose of this was not for efficiency, but to support a huge variety of target OSes&#x2F;distros&#x2F;architectures, most of which are no longer used in any real capacity.</div><br/><div id="39882450" class="c"><input type="checkbox" id="c-39882450" checked=""/><div class="controls bullet"><span class="by">ibotty</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39881902">parent</a><span>|</span><a href="#39882194">next</a><span>|</span><label class="collapse" for="c-39882450">[-]</label><label class="expand" for="c-39882450">[1 more]</label></div><br/><div class="children"><div class="content">This is not part of autotools output.  This is part of the backdoor.  Not arguing about autotools drawbacks though.</div><br/></div></div></div></div><div id="39882194" class="c"><input type="checkbox" id="c-39882194" checked=""/><div class="controls bullet"><span class="by">mrb</span><span>|</span><a href="#39880392">root</a><span>|</span><a href="#39881386">parent</a><span>|</span><a href="#39881902">prev</a><span>|</span><a href="#39880434">next</a><span>|</span><label class="collapse" for="c-39882194">[-]</label><label class="expand" for="c-39882194">[1 more]</label></div><br/><div class="children"><div class="content">To be clear: the build system did not use the code fragment you quoted. This complex awk code is a later stage of the backdoor.</div><br/></div></div></div></div></div></div><div id="39880434" class="c"><input type="checkbox" id="c-39880434" checked=""/><div class="controls bullet"><span class="by">asveikau</span><span>|</span><a href="#39880392">parent</a><span>|</span><a href="#39880838">prev</a><span>|</span><a href="#39879030">next</a><span>|</span><label class="collapse" for="c-39880434">[-]</label><label class="expand" for="c-39880434">[1 more]</label></div><br/><div class="children"><div class="content">The commit messages for the test files claim they used an RNG to generate them. The guy making the release tarball then put the final line in the right place without checking it in.</div><br/></div></div></div></div><div id="39879030" class="c"><input type="checkbox" id="c-39879030" checked=""/><div class="controls bullet"><span class="by">sega_sai</span><span>|</span><a href="#39880392">prev</a><span>|</span><a href="#39881774">next</a><span>|</span><label class="collapse" for="c-39879030">[-]</label><label class="expand" for="c-39879030">[5 more]</label></div><br/><div class="children"><div class="content">Did anyone search github yet for similar head | tail tricks ? I doubt it was invented just for this.</div><br/><div id="39881467" class="c"><input type="checkbox" id="c-39881467" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#39879030">parent</a><span>|</span><a href="#39879767">next</a><span>|</span><label class="collapse" for="c-39881467">[-]</label><label class="expand" for="c-39881467">[2 more]</label></div><br/><div class="children"><div class="content">It’s clever but not entirely novel, this is kind of the intended usecase for these</div><br/><div id="39881999" class="c"><input type="checkbox" id="c-39881999" checked=""/><div class="controls bullet"><span class="by">rmast</span><span>|</span><a href="#39879030">root</a><span>|</span><a href="#39881467">parent</a><span>|</span><a href="#39879767">next</a><span>|</span><label class="collapse" for="c-39881999">[-]</label><label class="expand" for="c-39881999">[1 more]</label></div><br/><div class="children"><div class="content">The use of head&#x2F;tail for deobfuscation also isn’t visible as plain text in the repository or release tarball, which makes searching for its use in other repositories more difficult (unless a less obfuscated version was tested elsewhere).</div><br/></div></div></div></div><div id="39879767" class="c"><input type="checkbox" id="c-39879767" checked=""/><div class="controls bullet"><span class="by">nabakin</span><span>|</span><a href="#39879030">parent</a><span>|</span><a href="#39881467">prev</a><span>|</span><a href="#39881774">next</a><span>|</span><label class="collapse" for="c-39879767">[-]</label><label class="expand" for="c-39879767">[2 more]</label></div><br/><div class="children"><div class="content">Opportunity to write a paper</div><br/><div id="39880866" class="c"><input type="checkbox" id="c-39880866" checked=""/><div class="controls bullet"><span class="by">rmast</span><span>|</span><a href="#39879030">root</a><span>|</span><a href="#39879767">parent</a><span>|</span><a href="#39881774">next</a><span>|</span><label class="collapse" for="c-39880866">[-]</label><label class="expand" for="c-39880866">[1 more]</label></div><br/><div class="children"><div class="content">Maybe some analysis of odd patterns in entropy of binary files committed to repositories could pick out some to look at a bit deeper?</div><br/></div></div></div></div></div></div><div id="39881774" class="c"><input type="checkbox" id="c-39881774" checked=""/><div class="controls bullet"><span class="by">marco_patino</span><span>|</span><a href="#39879030">prev</a><span>|</span><a href="#39882164">next</a><span>|</span><label class="collapse" for="c-39881774">[-]</label><label class="expand" for="c-39881774">[1 more]</label></div><br/><div class="children"><div class="content">Now the GitHub repo has been disabled by GitHub due to violation of GitHub&#x27;s terms. 
<a href="https:&#x2F;&#x2F;github.com&#x2F;tukaani-project&#x2F;xz">https:&#x2F;&#x2F;github.com&#x2F;tukaani-project&#x2F;xz</a></div><br/></div></div><div id="39882164" class="c"><input type="checkbox" id="c-39882164" checked=""/><div class="controls bullet"><span class="by">1letterunixname</span><span>|</span><a href="#39881774">prev</a><span>|</span><a href="#39880029">next</a><span>|</span><label class="collapse" for="c-39882164">[-]</label><label class="expand" for="c-39882164">[1 more]</label></div><br/><div class="children"><div class="content">Never allow complexity in code or so-called engineers who ask to merge tons of shitty code. Get rid of that shit and don&#x27;t trust committers blindly. Anyone who enables this crap is also a liability.</div><br/></div></div><div id="39880029" class="c"><input type="checkbox" id="c-39880029" checked=""/><div class="controls bullet"><span class="by">senoralligator</span><span>|</span><a href="#39882164">prev</a><span>|</span><a href="#39879891">next</a><span>|</span><label class="collapse" for="c-39880029">[-]</label><label class="expand" for="c-39880029">[2 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;github.com&#x2F;tukaani-project&#x2F;.github&#x2F;issues&#x2F;2">https:&#x2F;&#x2F;github.com&#x2F;tukaani-project&#x2F;.github&#x2F;issues&#x2F;2</a></div><br/><div id="39881756" class="c"><input type="checkbox" id="c-39881756" checked=""/><div class="controls bullet"><span class="by">mappu</span><span>|</span><a href="#39880029">parent</a><span>|</span><a href="#39879891">next</a><span>|</span><label class="collapse" for="c-39881756">[-]</label><label class="expand" for="c-39881756">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s quite funny - yes, not only is this a horrible wilful backdoor, it is also a GPL violation since the backdoor is a derived work without included source &#x2F; distributed not in &quot;the preferred form for modification&quot;.</div><br/></div></div></div></div><div id="39879891" class="c"><input type="checkbox" id="c-39879891" checked=""/><div class="controls bullet"><span class="by">jijijijij</span><span>|</span><a href="#39880029">prev</a><span>|</span><a href="#39878808">next</a><span>|</span><label class="collapse" for="c-39879891">[-]</label><label class="expand" for="c-39879891">[8 more]</label></div><br/><div class="children"><div class="content">How are the binary files passed to those stage-0 commands?</div><br/><div id="39880128" class="c"><input type="checkbox" id="c-39880128" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#39879891">parent</a><span>|</span><a href="#39878808">next</a><span>|</span><label class="collapse" for="c-39880128">[-]</label><label class="expand" for="c-39880128">[7 more]</label></div><br/><div class="children"><div class="content">They already exist in the source. They&#x27;re split in the compression test files themselves. (Unless you meant some other binaries?)</div><br/><div id="39880406" class="c"><input type="checkbox" id="c-39880406" checked=""/><div class="controls bullet"><span class="by">jijijijij</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39880128">parent</a><span>|</span><a href="#39878808">next</a><span>|</span><label class="collapse" for="c-39880406">[-]</label><label class="expand" for="c-39880406">[6 more]</label></div><br/><div class="children"><div class="content">Yeah, but how exactly are they passed to those commands? I don&#x27;t see&#x2F;understand that part. I don&#x27;t see the &quot;take this file here&quot; part.</div><br/><div id="39880528" class="c"><input type="checkbox" id="c-39880528" checked=""/><div class="controls bullet"><span class="by">chaosite</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39880406">parent</a><span>|</span><a href="#39878808">next</a><span>|</span><label class="collapse" for="c-39880528">[-]</label><label class="expand" for="c-39880528">[5 more]</label></div><br/><div class="children"><div class="content">That&#x27;s for 2 reasons:<p>1. It might not be there in the place where you&#x27;re looking. It exists in the m4 in the release tarballs, not in the git repo.<p>2. It&#x27;s highly obfuscated.</div><br/><div id="39880658" class="c"><input type="checkbox" id="c-39880658" checked=""/><div class="controls bullet"><span class="by">jijijijij</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39880528">parent</a><span>|</span><a href="#39881088">next</a><span>|</span><label class="collapse" for="c-39880658">[-]</label><label class="expand" for="c-39880658">[3 more]</label></div><br/><div class="children"><div class="content">No, as far as I understand the binary files must be pointed at here: &#x27;$gl_am_configmake&#x27; ... But I don&#x27;t see how.<p>This:  &#x27;gl_am_configmake=`grep -aErls &quot;#{4}[[:alnum:]]{5}#{4}$&quot; $srcdir&#x2F;`&#x27; seem to match the &#x27;####Hello####&#x27;, but, as far as I can see, that&#x27;s supposed to be the already converted script?! I presumed the <i>binary files</i> not to contain human readable strings, maybe that&#x27;s the whole confusion.</div><br/><div id="39881019" class="c"><input type="checkbox" id="c-39881019" checked=""/><div class="controls bullet"><span class="by">credulousperson</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39880658">parent</a><span>|</span><a href="#39881088">next</a><span>|</span><label class="collapse" for="c-39881019">[-]</label><label class="expand" for="c-39881019">[2 more]</label></div><br/><div class="children"><div class="content">Opening bad-3-corrupt_lzma2.xz in an editor reveals it indeed has the string ####Hello####. I don&#x27;t know enough about lzma compression streams to explain how this appears in the &quot;compressed&quot; version of the payload, but it does.</div><br/><div id="39881303" class="c"><input type="checkbox" id="c-39881303" checked=""/><div class="controls bullet"><span class="by">loeg</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39881019">parent</a><span>|</span><a href="#39881088">next</a><span>|</span><label class="collapse" for="c-39881303">[-]</label><label class="expand" for="c-39881303">[1 more]</label></div><br/><div class="children"><div class="content">I think part of it being a bad&#x2F;corrupt test case means it doesn&#x27;t have to be valid xz encoding.  But I don&#x27;t know if that even matters.</div><br/></div></div></div></div></div></div><div id="39881088" class="c"><input type="checkbox" id="c-39881088" checked=""/><div class="controls bullet"><span class="by">fomine3</span><span>|</span><a href="#39879891">root</a><span>|</span><a href="#39880528">parent</a><span>|</span><a href="#39880658">prev</a><span>|</span><a href="#39878808">next</a><span>|</span><label class="collapse" for="c-39881088">[-]</label><label class="expand" for="c-39881088">[1 more]</label></div><br/><div class="children"><div class="content">m4 is somewhat obfuscated by default, that&#x27;s a part of the problem IMO</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>