<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1714726863964" as="style"/><link rel="stylesheet" href="styles.css?v=1714726863964"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://kyju.org/blog/piccolo-a-stackless-lua-interpreter/">Piccolo – A Stackless Lua Interpreter</a> <span class="domain">(<a href="https://kyju.org">kyju.org</a>)</span></div><div class="subtext"><span>vvoruganti</span> | <span>24 comments</span></div><br/><div><div id="40245536" class="c"><input type="checkbox" id="c-40245536" checked=""/><div class="controls bullet"><span class="by">camgunz</span><span>|</span><a href="#40243131">next</a><span>|</span><label class="collapse" for="c-40245536">[-]</label><label class="expand" for="c-40245536">[1 more]</label></div><br/><div class="children"><div class="content">I really enjoyed the &quot;Zooming Out&quot; section, a lot of good food for thought in there.</div><br/></div></div><div id="40243131" class="c"><input type="checkbox" id="c-40243131" checked=""/><div class="controls bullet"><span class="by">10000truths</span><span>|</span><a href="#40245536">prev</a><span>|</span><a href="#40244030">next</a><span>|</span><label class="collapse" for="c-40243131">[-]</label><label class="expand" for="c-40243131">[2 more]</label></div><br/><div class="children"><div class="content">&gt; However, piccolo works very hard to guarantee that piccolo::Executor::step returns in a bounded amount of time, even without the cooperation of the running Lua code.<p>The issue is that there exist ways to make a single bytecode instruction take an unbounded amount of time to execute. For example, Lua&#x27;s &quot;string.find()&quot; is implemented in native code. The interpreter only sees a single OP_CALL opcode, so it will count it as 1 instruction executed. But the <i>actual</i> execution time of the native implementation of string.find() is dependent on its inputs, which are not only variable length strings, but can be maliciously crafted to run in exponential time. Here&#x27;s an example, shamelessly stolen from Mike Pall himself:<p><pre><code>  string.find(string.rep(&quot;a&quot;, 50), string.rep(&quot;a?&quot;, 50)..string.rep(&quot;a&quot;, 50))
</code></pre>
The only way to solve this is to track execution time <i>within</i> the native code as well (i.e. make them fuel-aware), and ensure that they abort immediately if they exhaust the fuel.</div><br/><div id="40243646" class="c"><input type="checkbox" id="c-40243646" checked=""/><div class="controls bullet"><span class="by">haileys</span><span>|</span><a href="#40243131">parent</a><span>|</span><a href="#40244030">next</a><span>|</span><label class="collapse" for="c-40243646">[-]</label><label class="expand" for="c-40243646">[1 more]</label></div><br/><div class="children"><div class="content"><i>&gt; The only way to solve this is to track execution time within the native code as well (i.e. make them fuel-aware), and ensure that they abort immediately if they exhaust the fuel.</i><p>You will find that this is precisely the approach Piccolo takes.</div><br/></div></div></div></div><div id="40244030" class="c"><input type="checkbox" id="c-40244030" checked=""/><div class="controls bullet"><span class="by">vvanders</span><span>|</span><a href="#40243131">prev</a><span>|</span><a href="#40240708">next</a><span>|</span><label class="collapse" for="c-40244030">[-]</label><label class="expand" for="c-40244030">[1 more]</label></div><br/><div class="children"><div class="content">&gt; ... and frankly I really like just plain vanilla Lua. I think it matches perfectly with Rust because they&#x27;re so different, I think having an Rust embedded language that frees you from even having to think about ownership is very powerful because it can be used for things where having to think about ownership can be more trouble than its worth. Let each language play to their strengths, and Rust and Lua in a lot of ways have complementary strengths.<p>Tons of awesome technical details in the post and I&#x27;ve always felt that Lua&#x27;s co-routines are incredibly undervalued. We used to run Lua in all sorts of crazy places and it really punches above its weight.<p>The above quote + zoom out at the end also makes some really good observations. Some of the most powerful systems I&#x27;ve worked on picked a couple core technologies that were complementary with good interop rather than a one-size fits all. Will be interesting to see where Piccolo goes.</div><br/></div></div><div id="40240708" class="c"><input type="checkbox" id="c-40240708" checked=""/><div class="controls bullet"><span class="by">wesamco</span><span>|</span><a href="#40244030">prev</a><span>|</span><a href="#40239817">next</a><span>|</span><label class="collapse" for="c-40240708">[-]</label><label class="expand" for="c-40240708">[1 more]</label></div><br/><div class="children"><div class="content">I love how there are many Piccolo REPLs embedded in the article and interleaved with the paragraphs.<p>Piccolo looks amazing, I got a perfect use case for it, and I&#x27;m excited for when I get the chance to use it, thank you for working on it.</div><br/></div></div><div id="40239817" class="c"><input type="checkbox" id="c-40239817" checked=""/><div class="controls bullet"><span class="by">rnmmrnm</span><span>|</span><a href="#40240708">prev</a><span>|</span><a href="#40240759">next</a><span>|</span><label class="collapse" for="c-40239817">[-]</label><label class="expand" for="c-40239817">[8 more]</label></div><br/><div class="children"><div class="content">A bit off topic: I just wrote a bunch of lua C debug api code  (lua_sethook) to pre-emptively run and context-switch multiple lua &quot;coroutines&quot; (well not so &quot;co&quot;).<p>Is this library offering a lua implementation more well-designed for this use-case? I got all this code to unload the coroutine stack to store and and reload it before continuing it later. Does having C bindings to this library makes sense?</div><br/><div id="40240101" class="c"><input type="checkbox" id="c-40240101" checked=""/><div class="controls bullet"><span class="by">interroboink</span><span>|</span><a href="#40239817">parent</a><span>|</span><a href="#40240052">next</a><span>|</span><label class="collapse" for="c-40240101">[-]</label><label class="expand" for="c-40240101">[4 more]</label></div><br/><div class="children"><div class="content">I think yes?<p>My understanding is that the &quot;stackless&quot; concept here means that it does not store its execution state in the &quot;C runtime stack&quot; (or Rust, in this case).<p>So, there is some blob of memory describing that info, managed by Piccolo, rather than it residing on the &quot;real&quot; OS execution stack.<p>In particular, for call chains like: Lua -&gt; C -&gt; Lua -&gt; C (or so), it is normally hard to save&#x2F;restore the &quot;C&quot; parts of that chain, since you need to peek into the not-normally-accessible and platform-specific C runtime stack details. I wonder: how are you doing it in your system?<p>In Piccolo, I imagine it would be easier, since even the &quot;-&gt; C -&gt;&quot; portions of the stack are being managed by Piccolo, not the base C runtime. I don&#x27;t know what the APIs to access that stuff actually look like, though.<p>Aside: have you looked at Pluto&#x2F;Eris for Lua serialization of coroutines?<p>----<p><i>EDIT</i> Yes, it seems like the section The &quot;Big Lie&quot; is right up your alley (:</div><br/><div id="40240374" class="c"><input type="checkbox" id="c-40240374" checked=""/><div class="controls bullet"><span class="by">rnmmrnm</span><span>|</span><a href="#40239817">root</a><span>|</span><a href="#40240101">parent</a><span>|</span><a href="#40240052">next</a><span>|</span><label class="collapse" for="c-40240374">[-]</label><label class="expand" for="c-40240374">[3 more]</label></div><br/><div class="children"><div class="content">Well the only thing that&#x27;s really itching me is the fact that the whole lua debug.* section is documented as<p>&gt;You should exert care when using this library. Several of its functions violate basic assumptions about Lua code (e.g., that variables local to a function cannot be accessed from outside; that userdata metatables cannot be changed by Lua code; that Lua programs do not crash) and therefore can compromise otherwise secure code
(from the manual)<p>kinda creeps me out.</div><br/><div id="40244543" class="c"><input type="checkbox" id="c-40244543" checked=""/><div class="controls bullet"><span class="by">Dylan16807</span><span>|</span><a href="#40239817">root</a><span>|</span><a href="#40240374">parent</a><span>|</span><a href="#40240052">next</a><span>|</span><label class="collapse" for="c-40244543">[-]</label><label class="expand" for="c-40244543">[2 more]</label></div><br/><div class="children"><div class="content">If you find a debugger that <i>can&#x27;t</i> ruin a function&#x27;s local variables then that debugger sucks.</div><br/><div id="40245006" class="c"><input type="checkbox" id="c-40245006" checked=""/><div class="controls bullet"><span class="by">rnmmrnm</span><span>|</span><a href="#40239817">root</a><span>|</span><a href="#40244543">parent</a><span>|</span><a href="#40240052">next</a><span>|</span><label class="collapse" for="c-40245006">[-]</label><label class="expand" for="c-40245006">[1 more]</label></div><br/><div class="children"><div class="content">obviously, but i&#x27;m not so keen to turn it into a pre-emptive scheduler either lol.</div><br/></div></div></div></div></div></div></div></div><div id="40240052" class="c"><input type="checkbox" id="c-40240052" checked=""/><div class="controls bullet"><span class="by">rnmmrnm</span><span>|</span><a href="#40239817">parent</a><span>|</span><a href="#40240101">prev</a><span>|</span><a href="#40240759">next</a><span>|</span><label class="collapse" for="c-40240052">[-]</label><label class="expand" for="c-40240052">[3 more]</label></div><br/><div class="children"><div class="content">reading beyond the first paragraphs, I see this practically what he advocates to do :P</div><br/><div id="40243290" class="c"><input type="checkbox" id="c-40243290" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#40239817">root</a><span>|</span><a href="#40240052">parent</a><span>|</span><a href="#40240759">next</a><span>|</span><label class="collapse" for="c-40243290">[-]</label><label class="expand" for="c-40243290">[2 more]</label></div><br/><div class="children"><div class="content">She, not he. kyren is a woman.</div><br/><div id="40243395" class="c"><input type="checkbox" id="c-40243395" checked=""/><div class="controls bullet"><span class="by">rnmmrnm</span><span>|</span><a href="#40239817">root</a><span>|</span><a href="#40243290">parent</a><span>|</span><a href="#40240759">next</a><span>|</span><label class="collapse" for="c-40243395">[-]</label><label class="expand" for="c-40243395">[1 more]</label></div><br/><div class="children"><div class="content">Terribly sorry!</div><br/></div></div></div></div></div></div></div></div><div id="40240759" class="c"><input type="checkbox" id="c-40240759" checked=""/><div class="controls bullet"><span class="by">jxyxfinite</span><span>|</span><a href="#40239817">prev</a><span>|</span><a href="#40239873">next</a><span>|</span><label class="collapse" for="c-40240759">[-]</label><label class="expand" for="c-40240759">[1 more]</label></div><br/><div class="children"><div class="content">Beautiful website! Would love to learn more about the stack</div><br/></div></div><div id="40239873" class="c"><input type="checkbox" id="c-40239873" checked=""/><div class="controls bullet"><span class="by">qudat</span><span>|</span><a href="#40240759">prev</a><span>|</span><a href="#40240677">next</a><span>|</span><label class="collapse" for="c-40239873">[-]</label><label class="expand" for="c-40239873">[1 more]</label></div><br/><div class="children"><div class="content">I love the design of the website, nice work!</div><br/></div></div><div id="40240677" class="c"><input type="checkbox" id="c-40240677" checked=""/><div class="controls bullet"><span class="by">klaussilveira</span><span>|</span><a href="#40239873">prev</a><span>|</span><a href="#40242879">next</a><span>|</span><label class="collapse" for="c-40240677">[-]</label><label class="expand" for="c-40240677">[5 more]</label></div><br/><div class="children"><div class="content">I wonder if a Rust reimplementation of Lua will, one day, be faster than LuaJIT.</div><br/><div id="40241425" class="c"><input type="checkbox" id="c-40241425" checked=""/><div class="controls bullet"><span class="by">PhilipRoman</span><span>|</span><a href="#40240677">parent</a><span>|</span><a href="#40240740">next</a><span>|</span><label class="collapse" for="c-40241425">[-]</label><label class="expand" for="c-40241425">[1 more]</label></div><br/><div class="children"><div class="content">Good point, it is well known that speed of machine code varies greatly depending on what language was used to generate it. Jokes aside, I really don&#x27;t see a point in this. The safety guarantees of Rust are thrown out of the window the second you call dynamically generated code.</div><br/></div></div><div id="40240740" class="c"><input type="checkbox" id="c-40240740" checked=""/><div class="controls bullet"><span class="by">animaomnium</span><span>|</span><a href="#40240677">parent</a><span>|</span><a href="#40241425">prev</a><span>|</span><a href="#40242356">next</a><span>|</span><label class="collapse" for="c-40240740">[-]</label><label class="expand" for="c-40240740">[2 more]</label></div><br/><div class="children"><div class="content">Clearly that isn&#x27;t the case, surely Mike Pall would have heard of it, when he brought back LuaJIT from the future, that is.</div><br/></div></div><div id="40242356" class="c"><input type="checkbox" id="c-40242356" checked=""/><div class="controls bullet"><span class="by">__s</span><span>|</span><a href="#40240677">parent</a><span>|</span><a href="#40240740">prev</a><span>|</span><a href="#40242879">next</a><span>|</span><label class="collapse" for="c-40242356">[-]</label><label class="expand" for="c-40242356">[1 more]</label></div><br/><div class="children"><div class="content">Not without being a JIT. See Cranelift. I&#x27;ve used it to make a Befunge JIT in Rust</div><br/></div></div></div></div><div id="40242879" class="c"><input type="checkbox" id="c-40242879" checked=""/><div class="controls bullet"><span class="by">alberth</span><span>|</span><a href="#40240677">prev</a><span>|</span><label class="collapse" for="c-40242879">[-]</label><label class="expand" for="c-40242879">[3 more]</label></div><br/><div class="children"><div class="content">Monospace font<p>Please don’t use monospaced fonts for long-form text.<p>It’s extremely different to read because your eye struggles to see the “shape” of each word, when everything is equally spaced apart.</div><br/><div id="40244959" class="c"><input type="checkbox" id="c-40244959" checked=""/><div class="controls bullet"><span class="by">anthk</span><span>|</span><a href="#40242879">parent</a><span>|</span><a href="#40244561">next</a><span>|</span><label class="collapse" for="c-40244959">[-]</label><label class="expand" for="c-40244959">[1 more]</label></div><br/><div class="children"><div class="content">As a Unifont user under UXTerm and reading RSS articles, news, chat, code and everything, I think having a good font size matters. WIth Unifont, start from 12pt and use multiples of 4: 16, 20, 24, 28, 32... until the font doesn&#x27;t look fuzzy and it perfectly suits your resolution&#x2F;DPI.<p>Also, as an European I used the read the Teletext (It was almost an electronic newspaper with national&#x2F;international news&#x2F;sport results&#x2F;weather forecasts and so on which worked accesing every page&#x2F;section by a 3 digit number) on a CRT TV just fine.</div><br/></div></div><div id="40244561" class="c"><input type="checkbox" id="c-40244561" checked=""/><div class="controls bullet"><span class="by">Dylan16807</span><span>|</span><a href="#40242879">parent</a><span>|</span><a href="#40244959">prev</a><span>|</span><label class="collapse" for="c-40244561">[-]</label><label class="expand" for="c-40244561">[1 more]</label></div><br/><div class="children"><div class="content">Citation needed.</div><br/></div></div></div></div></div></div></div></div></div></body></html>