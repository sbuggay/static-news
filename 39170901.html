<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1706518866943" as="style"/><link rel="stylesheet" href="styles.css?v=1706518866943"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://nullprogram.com/blog/2024/01/28/">Two handy GDB breakpoint tricks</a> <span class="domain">(<a href="https://nullprogram.com">nullprogram.com</a>)</span></div><div class="subtext"><span>goranmoomin</span> | <span>16 comments</span></div><br/><div><div id="39173055" class="c"><input type="checkbox" id="c-39173055" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#39173014">next</a><span>|</span><label class="collapse" for="c-39173055">[-]</label><label class="expand" for="c-39173055">[3 more]</label></div><br/><div class="children"><div class="content">Don&#x27;t mess around with silly tricks like that. Do it the proper way:<p><pre><code>    #include &lt;signal.h&gt;
    
    int main()
    {
        signal(SIGTRAP, SIG_IGN);
        raise(SIGTRAP);
    }
</code></pre>
When outside a debugger, the `raise`d signal will be ignored (of course, if you <i>want</i> a coredump you can remove the `signal` line).<p>When inside a debugger, requests to ignore `SIGTRAP` have no effect, unlike other signals. That&#x27;s because this is <i>literally what `SIGTRAP` is for</i>.</div><br/><div id="39173195" class="c"><input type="checkbox" id="c-39173195" checked=""/><div class="controls bullet"><span class="by">dundarious</span><span>|</span><a href="#39173055">parent</a><span>|</span><a href="#39173495">next</a><span>|</span><label class="collapse" for="c-39173195">[-]</label><label class="expand" for="c-39173195">[1 more]</label></div><br/><div class="children"><div class="content">Yes, although for usage in an assertion like in TFA, you <i>want</i> SIGTRAP outside of a debugger to cause a core dump, which is the default, so you must not SIG_IGN it.<p>In priority order:<p>- msvc: __debugbreak()<p>- clang: __builtin_debugtrap()<p>- linux (and probably some other posix-ish systems): raise(SIGTRAP)<p>- gcc x86: asm(&quot;int3; nop&quot;)<p>- otherwise: you&#x27;re out of luck, just abort()&#x2F;__builtin_trap()</div><br/></div></div><div id="39173495" class="c"><input type="checkbox" id="c-39173495" checked=""/><div class="controls bullet"><span class="by">fulafel</span><span>|</span><a href="#39173055">parent</a><span>|</span><a href="#39173195">prev</a><span>|</span><a href="#39173014">next</a><span>|</span><label class="collapse" for="c-39173495">[-]</label><label class="expand" for="c-39173495">[1 more]</label></div><br/><div class="children"><div class="content">What if you&#x27;re a library and don&#x27;t want to alter global signal handling?</div><br/></div></div></div></div><div id="39173014" class="c"><input type="checkbox" id="c-39173014" checked=""/><div class="controls bullet"><span class="by">gumby</span><span>|</span><a href="#39173055">prev</a><span>|</span><a href="#39173501">next</a><span>|</span><label class="collapse" for="c-39173014">[-]</label><label class="expand" for="c-39173014">[1 more]</label></div><br/><div class="children"><div class="content">These actually are quite useful tricks, and simple too.<p>Usually articles with a title like this just find something in the documentation that the author hadn’t known, but I do often read them in the hope they’ll be like this.</div><br/></div></div><div id="39173501" class="c"><input type="checkbox" id="c-39173501" checked=""/><div class="controls bullet"><span class="by">ratmice</span><span>|</span><a href="#39173014">prev</a><span>|</span><a href="#39173174">next</a><span>|</span><label class="collapse" for="c-39173501">[-]</label><label class="expand" for="c-39173501">[1 more]</label></div><br/><div class="children"><div class="content">Instead of using labels (e.g. to avoid unused_label) and because labels are most commonly used as the target of a goto.<p>gdb also supports `break -probe foo:bar` when placing some `DTRACE_PROBE(foo, bar)` at the appropriate line.  I think this is likely preferable to `break func:label` now.</div><br/></div></div><div id="39173174" class="c"><input type="checkbox" id="c-39173174" checked=""/><div class="controls bullet"><span class="by">setheron</span><span>|</span><a href="#39173501">prev</a><span>|</span><a href="#39172605">next</a><span>|</span><label class="collapse" for="c-39173174">[-]</label><label class="expand" for="c-39173174">[1 more]</label></div><br/><div class="children"><div class="content">CosmopolitanC has this cool feature that launches gdb immediately and execs it.</div><br/></div></div><div id="39172605" class="c"><input type="checkbox" id="c-39172605" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#39173174">prev</a><span>|</span><a href="#39174107">next</a><span>|</span><label class="collapse" for="c-39172605">[-]</label><label class="expand" for="c-39172605">[2 more]</label></div><br/><div class="children"><div class="content">I sometimes used a placeholder function call to make it easier to place a breakpoint. Of course it shouldn&#x27;t be ever inlined.</div><br/><div id="39172650" class="c"><input type="checkbox" id="c-39172650" checked=""/><div class="controls bullet"><span class="by">gregfjohnson</span><span>|</span><a href="#39172605">parent</a><span>|</span><a href="#39174107">next</a><span>|</span><label class="collapse" for="c-39172650">[-]</label><label class="expand" for="c-39172650">[1 more]</label></div><br/><div class="children"><div class="content">Same.  I typically define a function &quot;void bp1(){}&quot; in a common utility file, put &quot;bp1();&quot; where I need a breakpoint, and &quot;b bp1&quot; in gdb.  Hacky, sure, but really convenient.</div><br/></div></div></div></div><div id="39174107" class="c"><input type="checkbox" id="c-39174107" checked=""/><div class="controls bullet"><span class="by">matheusmoreira</span><span>|</span><a href="#39172605">prev</a><span>|</span><a href="#39172587">next</a><span>|</span><label class="collapse" for="c-39174107">[-]</label><label class="expand" for="c-39174107">[1 more]</label></div><br/><div class="children"><div class="content">&gt; As far as I know there is no ARM equivalent compatible with GDB<p>Sad... This would&#x27;ve made debugging much more ergonomic on my phone.</div><br/></div></div><div id="39172587" class="c"><input type="checkbox" id="c-39172587" checked=""/><div class="controls bullet"><span class="by">amluto</span><span>|</span><a href="#39174107">prev</a><span>|</span><a href="#39172206">next</a><span>|</span><label class="collapse" for="c-39172587">[-]</label><label class="expand" for="c-39172587">[1 more]</label></div><br/><div class="children"><div class="content">&gt; On x86 it inserts an int3 instruction, which fires an interrupt, trapping in the attached debugger, or otherwise abnormally terminating the program. Because it’s an interrupt, it’s expected that the program might continue.<p>In x86 lingo, it’s a trap, and calling it an interrupt misses the point. int3 is a “software interrupt,” but the vector 3 is universally configured by kernels as a “trap” (by setting the appropriate mode in the IDT).  So the instruction completes, IP is incremented, and the kernel is notified.<p>FRED tidies this all up. The kernel is notified that the event occurred <i>and</i> is given the length of the offending instruction.<p>&gt; However, regardless of how you get an int3 in your program, GDB does not currently understand it.<p>GDB can’t really do better. If you have:<p><pre><code>    jnz 1f
    int3
    1: [non-error case here]
</code></pre>
Then all gdb knows is that IP points to 1.  The issue may not be as bad with the int3 out of line:<p><pre><code>    jnz 2f
    1: [non-error case here]
    
    2: int3
    jmp 1b &lt;— GDB sees this
</code></pre>
Then at least GDB knows what’s up. But that jmp may be omitted if gcc thinks that the instruction after int3 is unreachable.<p>Maybe a future FRED-requiring debug API could report the address of the offending int3 and GDB could use it. But ptrace is awful, gdb is awful, and I’m not convinced this will happen.</div><br/></div></div><div id="39172206" class="c"><input type="checkbox" id="c-39172206" checked=""/><div class="controls bullet"><span class="by">thrtythreeforty</span><span>|</span><a href="#39172587">prev</a><span>|</span><label class="collapse" for="c-39172206">[-]</label><label class="expand" for="c-39172206">[5 more]</label></div><br/><div class="children"><div class="content">What&#x27;s the equivalent of int3 on an ARM machine? Is there any attempt to provide a header that &quot;does the right thing&quot; on a wide variety of platforms?</div><br/><div id="39172273" class="c"><input type="checkbox" id="c-39172273" checked=""/><div class="controls bullet"><span class="by">dooglius</span><span>|</span><a href="#39172206">parent</a><span>|</span><label class="collapse" for="c-39172273">[-]</label><label class="expand" for="c-39172273">[4 more]</label></div><br/><div class="children"><div class="content">TFA says<p>&gt; As far as I know there is no ARM equivalent compatible with GDB (or even LLDB). The closest instruction, brk #0x1, does not behave as needed.<p>But doesn&#x27;t elaborate on why</div><br/><div id="39172450" class="c"><input type="checkbox" id="c-39172450" checked=""/><div class="controls bullet"><span class="by">zyedidia</span><span>|</span><a href="#39172206">root</a><span>|</span><a href="#39172273">parent</a><span>|</span><label class="collapse" for="c-39172450">[-]</label><label class="expand" for="c-39172450">[3 more]</label></div><br/><div class="children"><div class="content">The reason is because the ARM `brk #0x1` instruction doesn&#x27;t set the exception return address to the next instruction, so the debugger will just return to the breakpoint when it tries to resume, instead of running the next instruction. Recent versions of LLDB will recognize `brk #0xf000` and automatically step over it when returning, but I don&#x27;t think GDB does this. With GDB you would have to run something manually like `jump *($pc + 4)` to resume at the next instruction. Clang&#x27;s `__builtin_debugtrap()` will generate `brk #0xf000` automatically.</div><br/><div id="39173574" class="c"><input type="checkbox" id="c-39173574" checked=""/><div class="controls bullet"><span class="by">zootboy</span><span>|</span><a href="#39172206">root</a><span>|</span><a href="#39172450">parent</a><span>|</span><label class="collapse" for="c-39173574">[-]</label><label class="expand" for="c-39173574">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve been using this macro with GCC &#x2F; GDB for years without running into the issue you&#x27;re describing:<p>#define DEBUG_BREAK() do{__asm__(&quot;BKPT&quot;);} while(0)<p>I can continue just fine with it. Granted, this is on the various Cortex M0&#x2F;M3&#x2F;M4 chips, so I can&#x27;t say for sure if it works on any of the bigger, fancier ARMs.</div><br/><div id="39174028" class="c"><input type="checkbox" id="c-39174028" checked=""/><div class="controls bullet"><span class="by">zyedidia</span><span>|</span><a href="#39172206">root</a><span>|</span><a href="#39173574">parent</a><span>|</span><label class="collapse" for="c-39174028">[-]</label><label class="expand" for="c-39174028">[1 more]</label></div><br/><div class="children"><div class="content">I think it&#x27;s a difference between ARMv8 and ARMv6&#x2F;7 (I believe BKPT on ARMv6&#x2F;7 sets the exception return address to `addr(instruction)+4`).</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>