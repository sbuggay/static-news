<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1720688470030" as="style"/><link rel="stylesheet" href="styles.css?v=1720688470030"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://substack.wasteman.codes/p/engineering-principles-and-best-practices">Engineering principles for building financial systems</a>Â <span class="domain">(<a href="https://substack.wasteman.codes">substack.wasteman.codes</a>)</span></div><div class="subtext"><span>KothuRoti</span> | <span>19 comments</span></div><br/><div><div id="40934091" class="c"><input type="checkbox" id="c-40934091" checked=""/><div class="controls bullet"><span class="by">Terr_</span><span>|</span><a href="#40934721">next</a><span>|</span><label class="collapse" for="c-40934091">[-]</label><label class="expand" for="c-40934091">[5 more]</label></div><br/><div class="children"><div class="content">&gt; Use consistent rounding methodologies<p>This may also mean promoting them to a named part of the business-domain in code, with their own functions, unit-tests, stuff like &quot;fetch Rounding Strategy Suite by country code&quot;,  etc.<p>&gt; Use integer representations of time. This one is a little controversial but I stand by it. There are so many libraries in different technologies that parse timestamps into objects, and they all do them differently. Avoid this headache and just use integers. Unix timestamp, or even integer based UTC datetimes work perfectly fine.<p>Warning: This only works for times that are either firmly in the past or which represent a future delay-offset which is totally under your own exclusive control.<p>For example, suppose your company has a 48 hour cancellation policy. You can probably compute a future timestamp and use that, it won&#x27;t depend on whether a customer is about to hit a DST transition or leap-seconds or whatever. nsition.<p>In contrast, the nation of Ruritania may have their tax year ending at December 30th 17:30 Ruritania Time, but you don&#x27;t <i>reeeeealy</i> know how many seconds from now that will happen: Tomorrow the Ruritania congress may pass a law altering their tax-schedule or their entire national time-keeping. This means your underlying source-of-truth needs to be the <i>matching conditions</i>, and that often means storing the time-zone.</div><br/><div id="40934295" class="c"><input type="checkbox" id="c-40934295" checked=""/><div class="controls bullet"><span class="by">szundi</span><span>|</span><a href="#40934091">parent</a><span>|</span><a href="#40934299">next</a><span>|</span><label class="collapse" for="c-40934295">[-]</label><label class="expand" for="c-40934295">[2 more]</label></div><br/><div class="children"><div class="content">I like this answer as usually the world changes that cannot be easily ported to code makes software shit at the end.</div><br/><div id="40934363" class="c"><input type="checkbox" id="c-40934363" checked=""/><div class="controls bullet"><span class="by">Terr_</span><span>|</span><a href="#40934091">root</a><span>|</span><a href="#40934295">parent</a><span>|</span><a href="#40934299">next</a><span>|</span><label class="collapse" for="c-40934363">[-]</label><label class="expand" for="c-40934363">[1 more]</label></div><br/><div class="children"><div class="content">I like to quip that many hard technical-problems are actually three business-problems in a trenchcoat.<p>In this case, the technical outgrowth might be heroic over-weekend crunch: Write some code that finds every affected timestamp in the DB, reconstructs the various code-chains that created them, divines an &quot;original meaning&quot;, calculates the difference, and somehow apply changes in a way that doesn&#x27;t make auditors angry or lock a key table for and hour or leads to data-corruption from race conditions...</div><br/></div></div></div></div><div id="40934299" class="c"><input type="checkbox" id="c-40934299" checked=""/><div class="controls bullet"><span class="by">bigiain</span><span>|</span><a href="#40934091">parent</a><span>|</span><a href="#40934295">prev</a><span>|</span><a href="#40934721">next</a><span>|</span><label class="collapse" for="c-40934299">[-]</label><label class="expand" for="c-40934299">[2 more]</label></div><br/><div class="children"><div class="content">Also:<p>&gt; Granularity of your financial amounts should ...<p>... comply with relevant regulations.<p>I worked on a gambling webapp a long time back - we were bound by government regulations on gambling licences to perform all calculations at a precision of one ten thousandth of a cent, and were only permitted to round to cents once at the very end just before displaying a dollar amount to a person.<p>(This suited me down to the ground because I pointed out to everybody that Javascript couldn&#x27;t be guaranteed to treat numbers and calculations in a way that would keep the regulators auditors happy, and managed to push _every_ calculation involving dollar amounts off to the Java backend team.)<p>We also used integer UTC milliseconds for time, so we&#x27;d have good enough for the auditors timestamps showing who placed a valid bet at (say) 12:34:59.9997 and who else place an invalid bet at 12:35:00.0003 for a wager with a cut off time of 12:35. (We asked for and got a ruling from the regulators that the time that mattered was the time the API call was processed by the backend, since network latencies between the webapp and the backend platform were impossible to predict. I have no idea if the backend had millisecond accurate time, that wasn&#x27;t my problem and I _so_ didn&#x27;t want to have them make it my problem by asking the question.)</div><br/><div id="40934373" class="c"><input type="checkbox" id="c-40934373" checked=""/><div class="controls bullet"><span class="by">Terr_</span><span>|</span><a href="#40934091">root</a><span>|</span><a href="#40934299">parent</a><span>|</span><a href="#40934721">next</a><span>|</span><label class="collapse" for="c-40934373">[-]</label><label class="expand" for="c-40934373">[1 more]</label></div><br/><div class="children"><div class="content">&gt; We asked for and got a ruling from the regulators that the time that mattered was the time the API call was processed by the backend<p>I haven&#x27;t been in that situation, but I imagine I would reach for a &quot;what if it was snail-mail&quot; analogy. &quot;It&#x27;s dangerous to honor whatever time the bettor wrote by hand, the postmark-time may not be fair if the mailman got delayed because of a half-illegible address or random USPS delays... So how about we go for when it was actually delivered to us?&quot;</div><br/></div></div></div></div></div></div><div id="40934721" class="c"><input type="checkbox" id="c-40934721" checked=""/><div class="controls bullet"><span class="by">noelwelsh</span><span>|</span><a href="#40934091">prev</a><span>|</span><a href="#40934233">next</a><span>|</span><label class="collapse" for="c-40934721">[-]</label><label class="expand" for="c-40934721">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Use integer representations of time<p>This sounds like a type system issue (and the linked Etsy post is also a type system issue), or more precisely languages &#x2F; systems with a loose type system where you can just pretend a time is a number without having to explicitly say what that number means.<p>Conventions are good, but (real) type systems are better because they check everything every time.</div><br/></div></div><div id="40934233" class="c"><input type="checkbox" id="c-40934233" checked=""/><div class="controls bullet"><span class="by">JetSetIlly</span><span>|</span><a href="#40934721">prev</a><span>|</span><a href="#40934456">next</a><span>|</span><label class="collapse" for="c-40934233">[-]</label><label class="expand" for="c-40934233">[3 more]</label></div><br/><div class="children"><div class="content">Good summary but the article doesn&#x27;t mention the engineering of the user interface. In this field of accountancy, I think the UI is an engineering problem at least as important as anything else mentioned in the article.<p>As someone who works in accountancy (as a bookkeeper&#x2F;accountant) I have to be brutally honest and say that I&#x27;ve been very disappointed in the UI of all the accounting software packages I&#x27;ve used. None of them give me the immediacy or simplicity of a well organised filing cabinet, they really don&#x27;t.<p>I&#x27;m not sure what a good solution would look like, but I can&#x27;t help thinking that making the double-entry system more visible and apparent to the user would be a good start.</div><br/><div id="40934400" class="c"><input type="checkbox" id="c-40934400" checked=""/><div class="controls bullet"><span class="by">Ratelman</span><span>|</span><a href="#40934233">parent</a><span>|</span><a href="#40934356">next</a><span>|</span><label class="collapse" for="c-40934400">[-]</label><label class="expand" for="c-40934400">[1 more]</label></div><br/><div class="children"><div class="content">As someone not in accountancy but having worked in corporate and been forced to work on accounting software for managing budgets, approving transactions etc. - you have really gotten the short end of the stick from general usability perspective.  There are so many things that don&#x27;t make sense - even for the accountants that use the system on day-to-day basis - they have workarounds for (what I would consider) the most basic of things (or over-complicated solutions for something basic like manager approvals for logging expenses - why do I have to click through several screens that don&#x27;t follow any sort of clear, logical flow).  And it&#x27;s so embedded in an organization - that you can rest assured once that client is signed up they&#x27;re not switching that system.  Same for HR software...</div><br/></div></div><div id="40934356" class="c"><input type="checkbox" id="c-40934356" checked=""/><div class="controls bullet"><span class="by">jsnk</span><span>|</span><a href="#40934233">parent</a><span>|</span><a href="#40934400">prev</a><span>|</span><a href="#40934456">next</a><span>|</span><label class="collapse" for="c-40934356">[-]</label><label class="expand" for="c-40934356">[1 more]</label></div><br/><div class="children"><div class="content">This was the same perspective i had as an engineer working on a finance problem for accountants and sales. So i would build a nice reporting tool that had modern ui. The people liked it at first but they always regress to spreadsheet. They just ask me to export the data in spreadsheet.</div><br/></div></div></div></div><div id="40934456" class="c"><input type="checkbox" id="c-40934456" checked=""/><div class="controls bullet"><span class="by">rwieruch</span><span>|</span><a href="#40934233">prev</a><span>|</span><a href="#40934729">next</a><span>|</span><label class="collapse" for="c-40934456">[-]</label><label class="expand" for="c-40934456">[1 more]</label></div><br/><div class="children"><div class="content">Related [0], but one week ago I have written about my experiences using TypeScript for an invoicing system, if anyone is interested. It&#x27;s especially about rounding errors and how to prevent them. Since then we have created hundreds of invoices (and cancellations) and everything worked as expected with minor hiccups in between.<p>[0] <a href="https:&#x2F;&#x2F;www.robinwieruch.de&#x2F;javascript-rounding-errors&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.robinwieruch.de&#x2F;javascript-rounding-errors&#x2F;</a></div><br/></div></div><div id="40934729" class="c"><input type="checkbox" id="c-40934729" checked=""/><div class="controls bullet"><span class="by">mgaunard</span><span>|</span><a href="#40934456">prev</a><span>|</span><a href="#40934545">next</a><span>|</span><label class="collapse" for="c-40934729">[-]</label><label class="expand" for="c-40934729">[1 more]</label></div><br/><div class="children"><div class="content">Representing prices is difficult because a lot of financial instruments have widely different values and price increments.<p>Decimal floating-point gives you the range to cover everything but is generally very inefficient to process.<p>What you usually want is fixed-point decimal, with the caveat that the scaling factor will be different per asset.</div><br/></div></div><div id="40934545" class="c"><input type="checkbox" id="c-40934545" checked=""/><div class="controls bullet"><span class="by">alphalima</span><span>|</span><a href="#40934729">prev</a><span>|</span><a href="#40934684">next</a><span>|</span><label class="collapse" for="c-40934545">[-]</label><label class="expand" for="c-40934545">[1 more]</label></div><br/><div class="children"><div class="content">On the best practices, as noted by others, there are probably classes in your standard lib&#x2F; commons lib that cover this stuff better than storing in integers (e.g. BigDecimal in Java and Python Decimal have precision and rounding mode concepts built in).<p>Something I&#x27;ve found valuable is on is managing euler units&#x2F;ratios (e.g.  proportions 10^1, percentages 10^-2, basis points 10^-4) . Enforcing a standard that all interchange, data storage has either the same scale, _or is stored with its scale (and not in the name)_ will reduce errors hugely significantly.</div><br/></div></div><div id="40934684" class="c"><input type="checkbox" id="c-40934684" checked=""/><div class="controls bullet"><span class="by">0wis</span><span>|</span><a href="#40934545">prev</a><span>|</span><a href="#40934200">next</a><span>|</span><label class="collapse" for="c-40934684">[-]</label><label class="expand" for="c-40934684">[1 more]</label></div><br/><div class="children"><div class="content">Another good engineering principle is to write a lot of tests. I know it is a basic rule of engineering but it is not always followed.<p>However, beware as the result of your test will also be seen by auditors, so if you refactor a system, it is better to have a write&#x2F;solve approach than write all your tests firsts and solve them afterwards.</div><br/></div></div><div id="40934200" class="c"><input type="checkbox" id="c-40934200" checked=""/><div class="controls bullet"><span class="by">Galanwe</span><span>|</span><a href="#40934684">prev</a><span>|</span><a href="#40933269">next</a><span>|</span><label class="collapse" for="c-40934200">[-]</label><label class="expand" for="c-40934200">[4 more]</label></div><br/><div class="children"><div class="content">I wouldn&#x27;t endorse many of the things stated there. A lot of the points are inaccurate or straight up misleading.<p>&gt; The three main goals of your accounting system are to be (1) Accurate, (2) Auditable and (3) Timely.<p>You forgot &quot;consistent&quot;, which is very different from &quot;accurate&quot;. Most financial transactions have multiple time dimensions: a trade is requested, booked, filled, matched, reconciliated, paid, settled at different times. These times often don&#x27;t even follow a perfectly logical order (you can request and fill a trade and book it an hour later). These time dimensions are often why there are multiple, layered, ledgers to store transactions. An accounting system needs to provide consistent views that depend on the dimension you want to look at (e.g. a trade that is filled but not settled counts for front office accounting, not for back office accounting).<p>&gt; If there is an event that occurred but is not in the financial record, than the system is not complete.<p>The base assumption of every (working) accounting system I have worked with is the reverse. There WILL be transactions that flow through the system in an untimely manner, your system needs to handle that, thus the need for multiple layers of ledgers, and the necessity to batch reconciliation processes between these layers.<p>You will book trades after they are filled. You will pay materials before inputing the bill. Etc.<p>&gt; If you are only working with dollars, representing values in cents might be sufficient. If you are a global business, prefer micros or a DECIMAL(19, 4).<p>If you are a global business only working with euro and dollar maybe. Otherwise most FX markets quote to 8 decimals, and that&#x27;s not counting swaps. I would recommend using at least 8 decimal places for storage.<p>&gt; Delay currency conversion as long as you can. Preemptively converting currencies can cause loss of precision.<p>No! Delay currency conversion _until conversion occurs_! An accounting system does not convert currencies at will. There is no dollar equivalent to euro, you either have dollars or euro. And it&#x27;s not a matter of rounding errors, cash management is part of legal and accounting duties.</div><br/><div id="40934669" class="c"><input type="checkbox" id="c-40934669" checked=""/><div class="controls bullet"><span class="by">blowski</span><span>|</span><a href="#40934200">parent</a><span>|</span><a href="#40934237">next</a><span>|</span><label class="collapse" for="c-40934669">[-]</label><label class="expand" for="c-40934669">[1 more]</label></div><br/><div class="children"><div class="content">Seems to be like you&#x27;re in violent agreement with the OP on all those points, just phrasing the same truth differently.</div><br/></div></div><div id="40934237" class="c"><input type="checkbox" id="c-40934237" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#40934200">parent</a><span>|</span><a href="#40934669">prev</a><span>|</span><a href="#40934673">next</a><span>|</span><label class="collapse" for="c-40934237">[-]</label><label class="expand" for="c-40934237">[1 more]</label></div><br/><div class="children"><div class="content">If you are only doing accounting (and not like high frequency trading), you can even consider using arbitrary precision rational numbers internally.  They are most likely fast enough.<p>However, similar to what you suggested about currency conversion, your business logic might already dictate to you exactly what kind of precision and rounding rules you should be using; and deviating from that might cause havoc.</div><br/></div></div><div id="40934673" class="c"><input type="checkbox" id="c-40934673" checked=""/><div class="controls bullet"><span class="by">tomnipotent</span><span>|</span><a href="#40934200">parent</a><span>|</span><a href="#40934237">prev</a><span>|</span><a href="#40933269">next</a><span>|</span><label class="collapse" for="c-40934673">[-]</label><label class="expand" for="c-40934673">[1 more]</label></div><br/><div class="children"><div class="content">&gt; You forgot &quot;consistent&quot;<p>I once had an auditor tell me that the books are allowed to be wrong, but should be wrong consistently. I&#x27;ve even run into the timestamp issue, which generally turned out to be a non-issue unless the wrong date was used (like order date vs. shipping date for revenue recognition) or a considerable number of errors caused dates to end up in a different reporting period. If you&#x27;re dates are consistently a few hours off, then they&#x27;ll be consistently off across reporting period boundaries and that can easily be explained to an auditor.<p>&gt; the necessity to batch reconciliation processes between these layers<p>I&#x27;ve never seen a reporting period closed without accountants making journal entries for manual adjustments. These can often be material changes.<p>&gt; An accounting system does not convert currencies at will<p>This is correct, but for internal reporting you might need to. An accountant and cash flow will capture the important conversion rate when the funds are expatriated, but your finance dashboard showing sales in euros will have an executive that wants to see it in US dollars. It&#x27;s impractical to use the conversion rate from the transfer that could happen weeks or months after the reporting period, so you come to a compromise of using a X-day FX moving average that&#x27;s &quot;close enough&quot; and everyone&#x27;s happy. What goes in your 10-K&#x2F;Q will be a different story.</div><br/></div></div></div></div><div id="40933269" class="c"><input type="checkbox" id="c-40933269" checked=""/><div class="controls bullet"><span class="by">ricericebaby</span><span>|</span><a href="#40934200">prev</a><span>|</span><label class="collapse" for="c-40933269">[-]</label><label class="expand" for="c-40933269">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;ll have this saved for the day IRS comes knocking</div><br/></div></div></div></div></div></div></div></body></html>