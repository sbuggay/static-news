<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1693213263719" as="style"/><link rel="stylesheet" href="styles.css?v=1693213263719"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="http://hkopp.github.io/2023/08/the-ptrace-anti-re-trick">The Ptrace Anti-RE Trick</a>Â <span class="domain">(<a href="http://hkopp.github.io">hkopp.github.io</a>)</span></div><div class="subtext"><span>hkopp</span> | <span>25 comments</span></div><br/><div><div id="37288323" class="c"><input type="checkbox" id="c-37288323" checked=""/><div class="controls bullet"><span class="by">aetherspawn</span><span>|</span><a href="#37288945">next</a><span>|</span><label class="collapse" for="c-37288323">[-]</label><label class="expand" for="c-37288323">[6 more]</label></div><br/><div class="children"><div class="content">We used to place an INT3 vectored exception handler on function entry points and do everything interesting inside the exception handler. This made the execution stack basically invisible to every debugger since it doesn&#x27;t debug exception handlers. You can enable&#x2F;disable interrupts and tracing and whatever you need to do inside the exception handler to guarantee that nobody can see what you are doing and&#x2F;or verify that no other program has registered another exception handler before doing anything interesting.<p>If you need to hook functions in third party software, this trick can be used to hook the function without modifying any of the functions code. All you need to do is modify some pointer used by the function to zero, and it will raise an exception as soon as something like p-&gt; is executed on that pointer, then your exception handler can execute whatever code you need (i.e. write over stack, write to memory, exfiltrate handles) and on exit all you need to do is restore the correct register containing the pointer and wind back the execution counter by the size of the de-reference instruction.<p>Please don&#x27;t use this knowledge to hurt people ...</div><br/><div id="37288916" class="c"><input type="checkbox" id="c-37288916" checked=""/><div class="controls bullet"><span class="by">15155</span><span>|</span><a href="#37288323">parent</a><span>|</span><a href="#37288705">next</a><span>|</span><label class="collapse" for="c-37288916">[-]</label><label class="expand" for="c-37288916">[2 more]</label></div><br/><div class="children"><div class="content">How is the VEH target not immediately visible during static analysis?</div><br/><div id="37289817" class="c"><input type="checkbox" id="c-37289817" checked=""/><div class="controls bullet"><span class="by">aetherspawn</span><span>|</span><a href="#37288323">root</a><span>|</span><a href="#37288916">parent</a><span>|</span><a href="#37288705">next</a><span>|</span><label class="collapse" for="c-37289817">[-]</label><label class="expand" for="c-37289817">[1 more]</label></div><br/><div class="children"><div class="content">The VEH target is visible if you know where to look. You can use something like Themida to virtualize&#x2F;obsfucate the VEH if you really need the VEH to be encrypted.<p>It&#x27;s actually not so easy to find the VEH because if you are injecting the VEH into a third party process from another process, then not only does the VEH not exist during static analysis of the binary at rest, but its program address changes on each execution. Moreover, the VEH can be encrypted at rest before it is injected into the second process.</div><br/></div></div></div></div><div id="37288705" class="c"><input type="checkbox" id="c-37288705" checked=""/><div class="controls bullet"><span class="by">harryfyx</span><span>|</span><a href="#37288323">parent</a><span>|</span><a href="#37288916">prev</a><span>|</span><a href="#37288945">next</a><span>|</span><label class="collapse" for="c-37288705">[-]</label><label class="expand" for="c-37288705">[3 more]</label></div><br/><div class="children"><div class="content">Do you mean using this trick in malware?</div><br/><div id="37289251" class="c"><input type="checkbox" id="c-37289251" checked=""/><div class="controls bullet"><span class="by">bubblematrix</span><span>|</span><a href="#37288323">root</a><span>|</span><a href="#37288705">parent</a><span>|</span><a href="#37289906">next</a><span>|</span><label class="collapse" for="c-37289251">[-]</label><label class="expand" for="c-37289251">[1 more]</label></div><br/><div class="children"><div class="content">No he is referring to happyware.</div><br/></div></div><div id="37289906" class="c"><input type="checkbox" id="c-37289906" checked=""/><div class="controls bullet"><span class="by">aetherspawn</span><span>|</span><a href="#37288323">root</a><span>|</span><a href="#37288705">parent</a><span>|</span><a href="#37289251">prev</a><span>|</span><a href="#37288945">next</a><span>|</span><label class="collapse" for="c-37289906">[-]</label><label class="expand" for="c-37289906">[1 more]</label></div><br/><div class="children"><div class="content">Actually our competitor was reverse engineering our LOB app and we used this to protect trade secrets.</div><br/></div></div></div></div></div></div><div id="37288945" class="c"><input type="checkbox" id="c-37288945" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#37288323">prev</a><span>|</span><a href="#37287555">next</a><span>|</span><label class="collapse" for="c-37288945">[-]</label><label class="expand" for="c-37288945">[1 more]</label></div><br/><div class="children"><div class="content">This &quot;self-debugging&quot; technique is common in the Windows world too:<p><a href="http:&#x2F;&#x2F;profile.maff1t.com&#x2F;AntiDebugging&#x2F;" rel="nofollow noreferrer">http:&#x2F;&#x2F;profile.maff1t.com&#x2F;AntiDebugging&#x2F;</a><p>Interestingly enough, VirtualBox does this too, and they call it &quot;hardening&quot;, but IMHO it&#x27;s quite an unexpected and hostile behaviour which is more characteristic of malware.</div><br/></div></div><div id="37287555" class="c"><input type="checkbox" id="c-37287555" checked=""/><div class="controls bullet"><span class="by">josephcsible</span><span>|</span><a href="#37288945">prev</a><span>|</span><a href="#37288436">next</a><span>|</span><label class="collapse" for="c-37287555">[-]</label><label class="expand" for="c-37287555">[10 more]</label></div><br/><div class="children"><div class="content">Thankfully this is easy to circumvent: have your debugger catch the ptrace syscall and lie about the result. Also, if antivirus programs haven&#x27;t already added a signature for any programs that do that, they should.</div><br/><div id="37287944" class="c"><input type="checkbox" id="c-37287944" checked=""/><div class="controls bullet"><span class="by">adtac</span><span>|</span><a href="#37287555">parent</a><span>|</span><a href="#37287746">next</a><span>|</span><label class="collapse" for="c-37287944">[-]</label><label class="expand" for="c-37287944">[4 more]</label></div><br/><div class="children"><div class="content">The malware will then rely on actual ptrace behaviour as a check. You could instead use seccomp_unotif and let the target ptrace itself as much as it wants: <a href="https:&#x2F;&#x2F;man.archlinux.org&#x2F;man&#x2F;seccomp_unotify.2.en" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.archlinux.org&#x2F;man&#x2F;seccomp_unotify.2.en</a></div><br/><div id="37288718" class="c"><input type="checkbox" id="c-37288718" checked=""/><div class="controls bullet"><span class="by">harryfyx</span><span>|</span><a href="#37287555">root</a><span>|</span><a href="#37287944">parent</a><span>|</span><a href="#37287746">next</a><span>|</span><label class="collapse" for="c-37288718">[-]</label><label class="expand" for="c-37288718">[3 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know reverse engineering. But, I guess the ultimate solution would be running a custom OS to fake ptrace results in the kernel level?</div><br/><div id="37291036" class="c"><input type="checkbox" id="c-37291036" checked=""/><div class="controls bullet"><span class="by">pizzapim</span><span>|</span><a href="#37287555">root</a><span>|</span><a href="#37288718">parent</a><span>|</span><a href="#37290956">next</a><span>|</span><label class="collapse" for="c-37291036">[-]</label><label class="expand" for="c-37291036">[1 more]</label></div><br/><div class="children"><div class="content">Another way is to load a eBPF program or kernel module for this purpose.</div><br/></div></div><div id="37290956" class="c"><input type="checkbox" id="c-37290956" checked=""/><div class="controls bullet"><span class="by">scandinavian</span><span>|</span><a href="#37287555">root</a><span>|</span><a href="#37288718">parent</a><span>|</span><a href="#37291036">prev</a><span>|</span><a href="#37287746">next</a><span>|</span><label class="collapse" for="c-37290956">[-]</label><label class="expand" for="c-37290956">[1 more]</label></div><br/><div class="children"><div class="content">You can just use LD_PRELOAD to load your own version of ptrace. Not as stealthy though.</div><br/></div></div></div></div></div></div><div id="37287746" class="c"><input type="checkbox" id="c-37287746" checked=""/><div class="controls bullet"><span class="by">lapcat</span><span>|</span><a href="#37287555">parent</a><span>|</span><a href="#37287944">prev</a><span>|</span><a href="#37290998">next</a><span>|</span><label class="collapse" for="c-37287746">[-]</label><label class="expand" for="c-37287746">[3 more]</label></div><br/><div class="children"><div class="content">&gt; Thankfully this is easy to circumvent: have your debugger catch the ptrace syscall and lie about the result.<p>Yeah, Apple iTunes did that IIRC, and it was super easy to bypass.</div><br/><div id="37289305" class="c"><input type="checkbox" id="c-37289305" checked=""/><div class="controls bullet"><span class="by">sjtgraham</span><span>|</span><a href="#37287555">root</a><span>|</span><a href="#37287746">parent</a><span>|</span><a href="#37290998">next</a><span>|</span><label class="collapse" for="c-37289305">[-]</label><label class="expand" for="c-37289305">[2 more]</label></div><br/><div class="children"><div class="content">On Apple platforms ptrace supports an additional flag &quot;PT_DENY_ATTACH&quot;, which is what iTunes uses. It causes the target process to exit.</div><br/><div id="37289382" class="c"><input type="checkbox" id="c-37289382" checked=""/><div class="controls bullet"><span class="by">lapcat</span><span>|</span><a href="#37287555">root</a><span>|</span><a href="#37289305">parent</a><span>|</span><a href="#37290998">next</a><span>|</span><label class="collapse" for="c-37289382">[-]</label><label class="expand" for="c-37289382">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, that&#x27;s it. Also DVD Player, for example. Pretty trivial to work around.</div><br/></div></div></div></div></div></div><div id="37288863" class="c"><input type="checkbox" id="c-37288863" checked=""/><div class="controls bullet"><span class="by">MuffinFlavored</span><span>|</span><a href="#37287555">parent</a><span>|</span><a href="#37290998">prev</a><span>|</span><a href="#37288436">next</a><span>|</span><label class="collapse" for="c-37288863">[-]</label><label class="expand" for="c-37288863">[1 more]</label></div><br/><div class="children"><div class="content">&gt; have your debugger catch the ptrace syscall<p>Cat + mouse: Have your program catch any signals&#x2F;stops (which debuggers do on Linux when they attach I believe)</div><br/></div></div></div></div><div id="37288436" class="c"><input type="checkbox" id="c-37288436" checked=""/><div class="controls bullet"><span class="by">maffydub</span><span>|</span><a href="#37287555">prev</a><span>|</span><a href="#37289206">next</a><span>|</span><label class="collapse" for="c-37288436">[-]</label><label class="expand" for="c-37288436">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve seen this used preemptively - have the process ptrace itself on startup (and then do nothing with it) to make it impossible (or at least far-from-trivial) for other interested parties to ptrace it.</div><br/><div id="37291025" class="c"><input type="checkbox" id="c-37291025" checked=""/><div class="controls bullet"><span class="by">complex_exp</span><span>|</span><a href="#37288436">parent</a><span>|</span><a href="#37289206">next</a><span>|</span><label class="collapse" for="c-37291025">[-]</label><label class="expand" for="c-37291025">[1 more]</label></div><br/><div class="children"><div class="content">You can just patch the call then, right? I.e. turn it into NOPs</div><br/></div></div></div></div><div id="37289206" class="c"><input type="checkbox" id="c-37289206" checked=""/><div class="controls bullet"><span class="by">jepler</span><span>|</span><a href="#37288436">prev</a><span>|</span><a href="#37289951">next</a><span>|</span><label class="collapse" for="c-37289206">[-]</label><label class="expand" for="c-37289206">[2 more]</label></div><br/><div class="children"><div class="content">In an old $DAY_JOB I used a variant of this as a way to make certain internal errors execute a breakpoint when debugged, and generate an error log if not debugged. iirc this did not happen until after an error had already occurred, so it was not very useful as anti-RE.</div><br/><div id="37289232" class="c"><input type="checkbox" id="c-37289232" checked=""/><div class="controls bullet"><span class="by">tlb</span><span>|</span><a href="#37289206">parent</a><span>|</span><a href="#37289951">next</a><span>|</span><label class="collapse" for="c-37289232">[-]</label><label class="expand" for="c-37289232">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m curious what the context is where you can&#x27;t just set a breakpoint on the logging function.</div><br/></div></div></div></div><div id="37289951" class="c"><input type="checkbox" id="c-37289951" checked=""/><div class="controls bullet"><span class="by">Cloudef</span><span>|</span><a href="#37289206">prev</a><span>|</span><a href="#37290339">next</a><span>|</span><label class="collapse" for="c-37289951">[-]</label><label class="expand" for="c-37289951">[1 more]</label></div><br/><div class="children"><div class="content">Some android malware also checks TracerPid in &#x2F;proc&#x2F;*&#x2F;status
<a href="https:&#x2F;&#x2F;github.com&#x2F;Cloudef&#x2F;android2gnulinux&#x2F;blob&#x2F;master&#x2F;src&#x2F;libc-antiantidebug.c">https:&#x2F;&#x2F;github.com&#x2F;Cloudef&#x2F;android2gnulinux&#x2F;blob&#x2F;master&#x2F;src&#x2F;...</a></div><br/></div></div><div id="37290339" class="c"><input type="checkbox" id="c-37290339" checked=""/><div class="controls bullet"><span class="by">badrabbit</span><span>|</span><a href="#37289951">prev</a><span>|</span><a href="#37287987">next</a><span>|</span><label class="collapse" for="c-37290339">[-]</label><label class="expand" for="c-37290339">[1 more]</label></div><br/><div class="children"><div class="content">Windows also has many similar evasion techniques, like checking if there is a top level exception handler. I use scyllahide, but even on gdb you can break at ptrace and patch it or for automated analysis, just flag anything that used ptrace but isn&#x27;t a debugger and run it in a sandbox without ptracing it. Audit subsystem might be enough.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;x64dbg&#x2F;ScyllaHide">https:&#x2F;&#x2F;github.com&#x2F;x64dbg&#x2F;ScyllaHide</a></div><br/></div></div><div id="37287987" class="c"><input type="checkbox" id="c-37287987" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#37290339">prev</a><span>|</span><label class="collapse" for="c-37287987">[-]</label><label class="expand" for="c-37287987">[1 more]</label></div><br/><div class="children"><div class="content">There are also differences in the handling of `SIGTRAP`. For a serious use, this can implement `breakpoint()` function.</div><br/></div></div></div></div></div></div></div></body></html>