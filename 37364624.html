<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1693731658834" as="style"/><link rel="stylesheet" href="styles.css?v=1693731658834"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://rodrigodd.github.io/2023/09/02/gameroy-jit.html">GameRoy: JIT Compilation in High-Accuracy Game Boy Emulation</a> <span class="domain">(<a href="https://rodrigodd.github.io">rodrigodd.github.io</a>)</span></div><div class="subtext"><span>rodrigodd</span> | <span>14 comments</span></div><br/><div><div id="37367787" class="c"><input type="checkbox" id="c-37367787" checked=""/><div class="controls bullet"><span class="by">Twirrim</span><span>|</span><a href="#37368536">next</a><span>|</span><label class="collapse" for="c-37367787">[-]</label><label class="expand" for="c-37367787">[3 more]</label></div><br/><div class="children"><div class="content">One &quot;cheap&quot; performance boost you could probably get is replacing your HashMaps with FxHashMap, <a href="https:&#x2F;&#x2F;docs.rs&#x2F;fxhash&#x2F;latest&#x2F;fxhash&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.rs&#x2F;fxhash&#x2F;latest&#x2F;fxhash&#x2F;</a>, which uses a much cheaper&#x2F;faster, but also not cryptographically secure, hashing algorithm.  For these purposes, I doubt the hashing algorithm weakness would be an issue.</div><br/><div id="37368443" class="c"><input type="checkbox" id="c-37368443" checked=""/><div class="controls bullet"><span class="by">Traubenfuchs</span><span>|</span><a href="#37367787">parent</a><span>|</span><a href="#37368536">next</a><span>|</span><label class="collapse" for="c-37368443">[-]</label><label class="expand" for="c-37368443">[2 more]</label></div><br/><div class="children"><div class="content">Why the hell would a HashMap use a cryptographically secure hash?</div><br/><div id="37368573" class="c"><input type="checkbox" id="c-37368573" checked=""/><div class="controls bullet"><span class="by">kaba0</span><span>|</span><a href="#37367787">root</a><span>|</span><a href="#37368443">parent</a><span>|</span><a href="#37368536">next</a><span>|</span><label class="collapse" for="c-37368573">[-]</label><label class="expand" for="c-37368573">[1 more]</label></div><br/><div class="children"><div class="content">I believe rust’s hashmap does have an implementation that is immune to timing-based attacks and that does have a performance cost. Maybe that’s what parent mixed it up with.</div><br/></div></div></div></div></div></div><div id="37368536" class="c"><input type="checkbox" id="c-37368536" checked=""/><div class="controls bullet"><span class="by">brandonpelfrey</span><span>|</span><a href="#37367787">prev</a><span>|</span><a href="#37367815">next</a><span>|</span><label class="collapse" for="c-37368536">[-]</label><label class="expand" for="c-37368536">[1 more]</label></div><br/><div class="children"><div class="content">Very nice! I&#x27;ve been working on a Dreamcast emulator for a long time and a lot of the issues you mentioned around deterministic behavior echoed. Schedulers are fantastic, and we landed on the same concept.<p>You mentioned that you do a hash map look for each (bank,addr) key. Suggestion which helped us: have this point to an Netey which contains the JIT code but also an index&#x2F;pointer into the next block which executed last time you executed this block. You can do a simple check to see if this is still valid and fall back to the hashmap lookup.  If you&#x27;re careful about code invalidation (not an issue with ROM) then this can help skip the next lookup.<p>Congrats!</div><br/></div></div><div id="37367815" class="c"><input type="checkbox" id="c-37367815" checked=""/><div class="controls bullet"><span class="by">ndesaulniers</span><span>|</span><a href="#37368536">prev</a><span>|</span><a href="#37366226">next</a><span>|</span><label class="collapse" for="c-37367815">[-]</label><label class="expand" for="c-37367815">[2 more]</label></div><br/><div class="children"><div class="content">I feel like I&#x27;ve seen the trick of estimating upcoming interrupts before somewhere...was it mednafen or higan?<p>Anyways cool post!<p>How come you don&#x27;t consider conditional branches to be terminating instructions of your basic blocks?</div><br/><div id="37368379" class="c"><input type="checkbox" id="c-37368379" checked=""/><div class="controls bullet"><span class="by">variadix</span><span>|</span><a href="#37367815">parent</a><span>|</span><a href="#37366226">next</a><span>|</span><label class="collapse" for="c-37368379">[-]</label><label class="expand" for="c-37368379">[1 more]</label></div><br/><div class="children"><div class="content">QEMU does something like this in TCG code when running in icount mode.</div><br/></div></div></div></div><div id="37366226" class="c"><input type="checkbox" id="c-37366226" checked=""/><div class="controls bullet"><span class="by">tom_</span><span>|</span><a href="#37367815">prev</a><span>|</span><a href="#37366433">next</a><span>|</span><label class="collapse" for="c-37366226">[-]</label><label class="expand" for="c-37366226">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve thought of doing one of these for my favourite 8-bit computer, though never actually got round to actually trying it.<p>How wide is a bank number? Even if it&#x27;s the full 8 bits, that&#x27;s only 24 bits, which is nothing these days. 64 MB for the full table, assuming 32 bits is enough to cover every offset into the JIT buffer. (Assuming max 4 GB of JIT&#x27;d code. If that isn&#x27;t, perhaps 40 bits would be? 128 MB table, max 1 TByte of JIT&#x27;d code.) Would you need a hash table rather than an array?</div><br/><div id="37367044" class="c"><input type="checkbox" id="c-37367044" checked=""/><div class="controls bullet"><span class="by">rodrigodd</span><span>|</span><a href="#37366226">parent</a><span>|</span><a href="#37366433">next</a><span>|</span><label class="collapse" for="c-37367044">[-]</label><label class="expand" for="c-37367044">[1 more]</label></div><br/><div class="children"><div class="content">The maximum supported size is 512 banks, so 25 bits. But searching now, I don&#x27;t think there are any games bigger than 1 MiB in size (64 banks), so 22 bits, or just 16 MiB or 32 MiB of lookup table. Yeah, maybe it is not so bad to replace the HashMap with an array, especially when I am losing a significant amount of time doing HashMap look ups already.<p>But of course I would like to avoid using that amount of memory if possible. Maybe I will also take a look at perfect hash mapping someday.</div><br/></div></div></div></div><div id="37366433" class="c"><input type="checkbox" id="c-37366433" checked=""/><div class="controls bullet"><span class="by">tester756</span><span>|</span><a href="#37366226">prev</a><span>|</span><label class="collapse" for="c-37366433">[-]</label><label class="expand" for="c-37366433">[5 more]</label></div><br/><div class="children"><div class="content">It looks simple &amp; short, but on the other hand I&#x27;ve checked the repo and it has 1k commits, so probably not THAT simple<p>I have some small, 4fun experience with compilers and I do wonder - how people start with game emulators? what are the basic concepts? what is the easiest hello-world game to start w&#x2F;?</div><br/><div id="37366748" class="c"><input type="checkbox" id="c-37366748" checked=""/><div class="controls bullet"><span class="by">khedoros1</span><span>|</span><a href="#37366433">parent</a><span>|</span><a href="#37366504">next</a><span>|</span><label class="collapse" for="c-37366748">[-]</label><label class="expand" for="c-37366748">[1 more]</label></div><br/><div class="children"><div class="content">&gt; how people start with game emulators?<p>I had some Computer Organization and Architecture classes in university, and a previously-existing burning desire to understand emulation. I decided that the NES would be a good target; it was the oldest game hardware that I had personal interest in. In 2008, I found as much info as I could about how to structure an emulator, and technical documents about the NES, and started building. I got something basic working in a couple months, and came back to it every couple of years, either to add functionality or experiment with optimizations.<p>&gt; what are the basic concepts?<p>A CPU goes through a repeating fetch-&gt;decode-&gt;execute loop, and mostly communicates with the rest of the system over a &quot;bus&quot;, which has some number of address lines (in the NES, 16 address lines provide access to 2^16 or 65,536 addresses), some number of data lines (in the NES, 8 lines for 8-bit values), and some number of control lines (read&#x2F;write, ready, and others that vary system-to-system). Different devices are connected at different address ranges. They could be RAM, ROM, I&#x2F;O hardware, etc. So when a CPU is booting, the system is usually designed to expose some ROM at the first address the CPU fetches from.<p>&gt; what is the easiest hello-world game to start w&#x2F;?<p>Chip-8, probably. Space Invaders is a good one too; simple, but using a CPU related to those in a lot of other systems, and a bit less of a toy-scale system than Chip-8.</div><br/></div></div><div id="37366504" class="c"><input type="checkbox" id="c-37366504" checked=""/><div class="controls bullet"><span class="by">zeta0134</span><span>|</span><a href="#37366433">parent</a><span>|</span><a href="#37366748">prev</a><span>|</span><label class="collapse" for="c-37366504">[-]</label><label class="expand" for="c-37366504">[3 more]</label></div><br/><div class="children"><div class="content">The typical hello world is actually a CHIP 8 emulator, which is a type of VM that ran on an old calculator, the specifics of which elude me. It&#x27;s got a tiny memory space, simple instructions and a handful of features, so it&#x27;s the sort of thing you can get up and &quot;running&quot; with minimal effort. It lets you explore the high level concepts involved in running a &quot;guest&quot; system on some hosts, and tickles the challenge of synchronizing the timing and dealing with video and sound, without being overwhelming the way a physical console can be.</div><br/><div id="37366525" class="c"><input type="checkbox" id="c-37366525" checked=""/><div class="controls bullet"><span class="by">tester756</span><span>|</span><a href="#37366433">root</a><span>|</span><a href="#37366504">parent</a><span>|</span><label class="collapse" for="c-37366525">[-]</label><label class="expand" for="c-37366525">[2 more]</label></div><br/><div class="children"><div class="content">Calculator sounds like a great idea! thanks</div><br/><div id="37366776" class="c"><input type="checkbox" id="c-37366776" checked=""/><div class="controls bullet"><span class="by">khedoros1</span><span>|</span><a href="#37366433">root</a><span>|</span><a href="#37366525">parent</a><span>|</span><label class="collapse" for="c-37366776">[-]</label><label class="expand" for="c-37366776">[1 more]</label></div><br/><div class="children"><div class="content">&quot;Calculator&quot; doesn&#x27;t quite cover it. CHIP-8 was developed to run on the COSMAC VIP home computer, and later similar ones like the Telmac 1800, which were shipped as kits for users to build at home.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></body></html>