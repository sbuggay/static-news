<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1708938059326" as="style"/><link rel="stylesheet" href="styles.css?v=1708938059326"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://astrid.tech/2024/02/24/0/conda-recipe-selector-abuse/">Abusing Conda&#x27;s Turing-Complete YAML Comments</a> <span class="domain">(<a href="https://astrid.tech">astrid.tech</a>)</span></div><div class="subtext"><span>bo0tzz</span> | <span>24 comments</span></div><br/><div><div id="39506366" class="c"><input type="checkbox" id="c-39506366" checked=""/><div class="controls bullet"><span class="by">hmry</span><span>|</span><a href="#39506548">next</a><span>|</span><label class="collapse" for="c-39506366">[-]</label><label class="expand" for="c-39506366">[4 more]</label></div><br/><div class="children"><div class="content">&quot;Turing-complete comments&quot; is the scariest phrase I&#x27;ve read in a while</div><br/><div id="39508680" class="c"><input type="checkbox" id="c-39508680" checked=""/><div class="controls bullet"><span class="by">ipsum2</span><span>|</span><a href="#39506366">parent</a><span>|</span><a href="#39507245">next</a><span>|</span><label class="collapse" for="c-39508680">[-]</label><label class="expand" for="c-39508680">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s less scary and more informative if the title said &quot;executes arbitrary python&quot; instead.</div><br/></div></div><div id="39507245" class="c"><input type="checkbox" id="c-39507245" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#39506366">parent</a><span>|</span><a href="#39508680">prev</a><span>|</span><a href="#39506548">next</a><span>|</span><label class="collapse" for="c-39507245">[-]</label><label class="expand" for="c-39507245">[2 more]</label></div><br/><div class="children"><div class="content">Removing YAML made it less scary.</div><br/><div id="39508240" class="c"><input type="checkbox" id="c-39508240" checked=""/><div class="controls bullet"><span class="by">oynqr</span><span>|</span><a href="#39506366">root</a><span>|</span><a href="#39507245">parent</a><span>|</span><a href="#39506548">next</a><span>|</span><label class="collapse" for="c-39508240">[-]</label><label class="expand" for="c-39508240">[1 more]</label></div><br/><div class="children"><div class="content">Would adding XML make it worse?</div><br/></div></div></div></div></div></div><div id="39506548" class="c"><input type="checkbox" id="c-39506548" checked=""/><div class="controls bullet"><span class="by">tru3_power</span><span>|</span><a href="#39506366">prev</a><span>|</span><a href="#39506556">next</a><span>|</span><label class="collapse" for="c-39506548">[-]</label><label class="expand" for="c-39506548">[2 more]</label></div><br/><div class="children"><div class="content">MySQL actually supports something similar (see executable comments using &#x2F;*! MySQL-specific code *&#x2F;). I found this out during an assessment once and was shocked to see it lol.<p><a href="https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;8.0&#x2F;en&#x2F;comments.html" rel="nofollow">https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;8.0&#x2F;en&#x2F;comments.html</a></div><br/><div id="39507940" class="c"><input type="checkbox" id="c-39507940" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#39506548">parent</a><span>|</span><a href="#39506556">next</a><span>|</span><label class="collapse" for="c-39507940">[-]</label><label class="expand" for="c-39507940">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s more like a conditional comment, which is a rather common strategy for backward compatibility. Conda&#x27;s comment is entirely separate from the configuration language itself, which is not even Turing-complete.</div><br/></div></div></div></div><div id="39506556" class="c"><input type="checkbox" id="c-39506556" checked=""/><div class="controls bullet"><span class="by">JonChesterfield</span><span>|</span><a href="#39506548">prev</a><span>|</span><a href="#39507445">next</a><span>|</span><label class="collapse" for="c-39506556">[-]</label><label class="expand" for="c-39506556">[6 more]</label></div><br/><div class="children"><div class="content">12 billion downloads sounds like a lot for a packaging tool that calls eval on bytes found in yaml comments.</div><br/><div id="39507893" class="c"><input type="checkbox" id="c-39507893" checked=""/><div class="controls bullet"><span class="by">pavon</span><span>|</span><a href="#39506556">parent</a><span>|</span><a href="#39507424">next</a><span>|</span><label class="collapse" for="c-39507893">[-]</label><label class="expand" for="c-39507893">[2 more]</label></div><br/><div class="children"><div class="content">The more popular alternative to conda is pip&#x2F;venv, which also executes arbitrary python code in setup.py.</div><br/><div id="39508603" class="c"><input type="checkbox" id="c-39508603" checked=""/><div class="controls bullet"><span class="by">akx</span><span>|</span><a href="#39506556">root</a><span>|</span><a href="#39507893">parent</a><span>|</span><a href="#39507424">next</a><span>|</span><label class="collapse" for="c-39508603">[-]</label><label class="expand" for="c-39508603">[1 more]</label></div><br/><div class="children"><div class="content">Which is one reason why setup.py is on its way out. More often than not you&#x27;ll just download a prebuilt wheel with pip anyway.</div><br/></div></div></div></div><div id="39507424" class="c"><input type="checkbox" id="c-39507424" checked=""/><div class="controls bullet"><span class="by">nurtbo</span><span>|</span><a href="#39506556">parent</a><span>|</span><a href="#39507893">prev</a><span>|</span><a href="#39507445">next</a><span>|</span><label class="collapse" for="c-39507424">[-]</label><label class="expand" for="c-39507424">[3 more]</label></div><br/><div class="children"><div class="content">What’s the difference between putting it in the yaml file vs putting it in the uploaded built conda package? Isn’t it the same risk profile?<p>Is there some way that new recipes are auto-parsed by every client?</div><br/><div id="39508497" class="c"><input type="checkbox" id="c-39508497" checked=""/><div class="controls bullet"><span class="by">Someone</span><span>|</span><a href="#39506556">root</a><span>|</span><a href="#39507424">parent</a><span>|</span><a href="#39507451">next</a><span>|</span><label class="collapse" for="c-39508497">[-]</label><label class="expand" for="c-39508497">[1 more]</label></div><br/><div class="children"><div class="content">A yaml editor that does syntax coloring and wants to gray out lines that aren’t relevant to the current build might execute the code, but I hope they would at least sandbox that and, preferably opt out of supporting the full ’feature’, too.</div><br/></div></div><div id="39507451" class="c"><input type="checkbox" id="c-39507451" checked=""/><div class="controls bullet"><span class="by">doctorpangloss</span><span>|</span><a href="#39506556">root</a><span>|</span><a href="#39507424">parent</a><span>|</span><a href="#39508497">prev</a><span>|</span><a href="#39507445">next</a><span>|</span><label class="collapse" for="c-39507451">[-]</label><label class="expand" for="c-39507451">[1 more]</label></div><br/><div class="children"><div class="content">You’re right.<p>But the dysfunction in Python packaging is nothing new. Everything with adoption appeals to the lowest common denominator.<p>Another POV is that “code conductors” have always vastly outnumbered actual programmers, but now that Python is ChatGPT’s expertise, does packaging matter? People will use whatever packages the LLM’s really cool notebook interface ships with, and nothing more. The environment doesn’t even have access to the Internet, and yet: here we are. The next 20 million Python developers - almost outnumbering all professional programmer combined - are going to get away with literally never installing a package.</div><br/></div></div></div></div></div></div><div id="39507445" class="c"><input type="checkbox" id="c-39507445" checked=""/><div class="controls bullet"><span class="by">hexane360</span><span>|</span><a href="#39506556">prev</a><span>|</span><a href="#39504320">next</a><span>|</span><label class="collapse" for="c-39507445">[-]</label><label class="expand" for="c-39507445">[1 more]</label></div><br/><div class="children"><div class="content">Meanwhile, there&#x27;s still no support for dependency specifiers&#x2F;environment markers (PEP 508&#x2F;PEP 345) in environment.yml files, and the documentation is VERY sparse about what <i>is</i> supported: <a href="https:&#x2F;&#x2F;conda.io&#x2F;projects&#x2F;conda&#x2F;en&#x2F;latest&#x2F;user-guide&#x2F;tasks&#x2F;manage-environments.html#creating-an-environment-file-manually" rel="nofollow">https:&#x2F;&#x2F;conda.io&#x2F;projects&#x2F;conda&#x2F;en&#x2F;latest&#x2F;user-guide&#x2F;tasks&#x2F;m...</a><p>At least they support ~=3.9 and &gt;=1,&lt;3 comparisons (although this is undocumented as far as I can tell.</div><br/></div></div><div id="39504320" class="c"><input type="checkbox" id="c-39504320" checked=""/><div class="controls bullet"><span class="by">ghuntley</span><span>|</span><a href="#39507445">prev</a><span>|</span><a href="#39506089">next</a><span>|</span><label class="collapse" for="c-39504320">[-]</label><label class="expand" for="c-39504320">[9 more]</label></div><br/><div class="children"><div class="content">Another entry for <a href="https:&#x2F;&#x2F;noyaml.com" rel="nofollow">https:&#x2F;&#x2F;noyaml.com</a></div><br/><div id="39504390" class="c"><input type="checkbox" id="c-39504390" checked=""/><div class="controls bullet"><span class="by">woodruffw</span><span>|</span><a href="#39504320">parent</a><span>|</span><a href="#39506089">next</a><span>|</span><label class="collapse" for="c-39504390">[-]</label><label class="expand" for="c-39504390">[8 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think this really has anything to do with YAML; Conda appears to have defined a bespoke semi-DSL in comments rather than encoding it in YAML itself. They could have done this in any configuration language that supports comments. That doesn&#x27;t make it any less cursed, of course.<p>(If I&#x27;m reading this correctly, they may have their own &quot;YAML&quot; parser entirely -- multiple keys with different values shouldn&#x27;t be distinctly represent-able in a normal YAML document, at least not after parsing.)</div><br/><div id="39508918" class="c"><input type="checkbox" id="c-39508918" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39504390">parent</a><span>|</span><a href="#39504761">next</a><span>|</span><label class="collapse" for="c-39508918">[-]</label><label class="expand" for="c-39508918">[1 more]</label></div><br/><div class="children"><div class="content">I think you&#x27;re technically correct, but in practice you do see these misguided templating ideas seem to be almost universally YAML and Python.<p>I&#x27;ve never seen someone try to template JSON or XML like this. About the closest is HTML templating but even that is not really the best way these days.</div><br/></div></div><div id="39504761" class="c"><input type="checkbox" id="c-39504761" checked=""/><div class="controls bullet"><span class="by">anamexis</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39504390">parent</a><span>|</span><a href="#39508918">prev</a><span>|</span><a href="#39507468">next</a><span>|</span><label class="collapse" for="c-39504761">[-]</label><label class="expand" for="c-39504761">[2 more]</label></div><br/><div class="children"><div class="content">&gt; (If I&#x27;m reading this correctly, they may have their own &quot;YAML&quot; parser entirely -- multiple keys with different values shouldn&#x27;t be distinctly represent-able in a normal YAML document, at least not after parsing.)<p>I don&#x27;t think they have their own YAML parser - the preprocessor just strips out lines whose magic comments return False.</div><br/><div id="39504863" class="c"><input type="checkbox" id="c-39504863" checked=""/><div class="controls bullet"><span class="by">woodruffw</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39504761">parent</a><span>|</span><a href="#39507468">next</a><span>|</span><label class="collapse" for="c-39504863">[-]</label><label class="expand" for="c-39504863">[1 more]</label></div><br/><div class="children"><div class="content">I can&#x27;t tell if that&#x27;s better or worse :-)</div><br/></div></div></div></div><div id="39507468" class="c"><input type="checkbox" id="c-39507468" checked=""/><div class="controls bullet"><span class="by">sapling-ginger</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39504390">parent</a><span>|</span><a href="#39504761">prev</a><span>|</span><a href="#39506089">next</a><span>|</span><label class="collapse" for="c-39507468">[-]</label><label class="expand" for="c-39507468">[4 more]</label></div><br/><div class="children"><div class="content">&gt; in any configuration language that supports comments<p>Notably, not JSON. In fact JSON doesn&#x27;t support comment specifically to prevent this. And YAML was created specifically to add comments to JSON, in violation of this precaution. So YAML can eat the lunch that it serve itself.</div><br/><div id="39507978" class="c"><input type="checkbox" id="c-39507978" checked=""/><div class="controls bullet"><span class="by">woodruffw</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39507468">parent</a><span>|</span><a href="#39507808">next</a><span>|</span><label class="collapse" for="c-39507978">[-]</label><label class="expand" for="c-39507978">[1 more]</label></div><br/><div class="children"><div class="content">I have seen plenty of JSON applications abuse the &quot;$&quot; key namespace for comments. JSON Schema, for example, uses `$comment`[1]. So no, I don&#x27;t think this is a shingle that can be uniquely hung around YAML&#x27;s neck.<p>The Norway problem, anchors &amp; references, infinite ways to begin a multi-line string, on the other hand, are all legitimate grievances that are somewhat unique to YAML.<p>Edit: And note: what makes this hack bizarre is that they <i>chose</i> to do it in comments, despite YAML having ample syntax for an inline dictionary or whatever else. YAML offers all kinds of exquisitely complicated ropes to hang yourself with, and they chose plain old boring comments!<p>[1]: <a href="https:&#x2F;&#x2F;json-schema.org&#x2F;understanding-json-schema&#x2F;reference&#x2F;comments" rel="nofollow">https:&#x2F;&#x2F;json-schema.org&#x2F;understanding-json-schema&#x2F;reference&#x2F;...</a></div><br/></div></div><div id="39507808" class="c"><input type="checkbox" id="c-39507808" checked=""/><div class="controls bullet"><span class="by">devsda</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39507468">parent</a><span>|</span><a href="#39507978">prev</a><span>|</span><a href="#39507775">next</a><span>|</span><label class="collapse" for="c-39507808">[-]</label><label class="expand" for="c-39507808">[1 more]</label></div><br/><div class="children"><div class="content">&gt; In fact JSON doesn&#x27;t support comment specifically to prevent this.<p>They were mainly concerned about interoperability but partially yes.<p>Source: <a href="https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20190112173904&#x2F;https:&#x2F;&#x2F;plus.google.com&#x2F;118095276221607585885&#x2F;posts&#x2F;RK8qyGVaGSr" rel="nofollow">https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20190112173904&#x2F;https:&#x2F;&#x2F;plus.goog...</a></div><br/></div></div><div id="39507775" class="c"><input type="checkbox" id="c-39507775" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#39504320">root</a><span>|</span><a href="#39507468">parent</a><span>|</span><a href="#39507808">prev</a><span>|</span><a href="#39506089">next</a><span>|</span><label class="collapse" for="c-39507775">[-]</label><label class="expand" for="c-39507775">[1 more]</label></div><br/><div class="children"><div class="content">You can exploit any ambiguity besides from comments. JSON in particular doesn&#x27;t fully forbid duplicate keys in objects (though many implementations do reject them), and I think they were already abused as comments in the past. And you can always use special keys like `$when` (a la MongoDB) to add turing completeness, so even that point is moot.</div><br/></div></div></div></div></div></div></div></div><div id="39506089" class="c"><input type="checkbox" id="c-39506089" checked=""/><div class="controls bullet"><span class="by">tetris11</span><span>|</span><a href="#39504320">prev</a><span>|</span><label class="collapse" for="c-39506089">[-]</label><label class="expand" for="c-39506089">[1 more]</label></div><br/><div class="children"><div class="content">conda recipes are becoming full of gunk with time, since there is now a bot that auto-updates your recipes.<p>You can view the PR and it waits for you to review and merge the changes to the YAML, but my god those diffs are becoming harder to grok.</div><br/></div></div></div></div></div></div></div></body></html>