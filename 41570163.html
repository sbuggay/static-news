<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1726650078032" as="style"/><link rel="stylesheet" href="styles.css?v=1726650078032"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://jeremymorrell.dev/blog/minimal-js-tracing/">OpenTelemetry Tracing in &lt; 200 lines of code</a> <span class="domain">(<a href="https://jeremymorrell.dev">jeremymorrell.dev</a>)</span></div><div class="subtext"><span>masterj</span> | <span>22 comments</span></div><br/><div><div id="41573012" class="c"><input type="checkbox" id="c-41573012" checked=""/><div class="controls bullet"><span class="by">Ciantic</span><span>|</span><a href="#41573813">next</a><span>|</span><label class="collapse" for="c-41573012">[-]</label><label class="expand" for="c-41573012">[8 more]</label></div><br/><div class="children"><div class="content">The utility of tracing is great, I&#x27;ve been using Azure Application Insights with NodeJS (and of course in .NET). This is relatively simple because it monkey patches itself everywhere if you go through the &quot;classic&quot; SDK route. Then adding your own data to logs is just a few simple functions trackTrace, trackException, trackEvent, etc.<p>However, if you want to figure out how it works you might be scared, it is not lightweight. I just spent a few days digging through the Azure Application Insights NodeJS code base which integrates with OpenTelemetry packages. It&#x27;s an utter mess, a huge amount of abstractions. Adding it to the project brought 100 MB and around 40 extra packages.</div><br/><div id="41576029" class="c"><input type="checkbox" id="c-41576029" checked=""/><div class="controls bullet"><span class="by">the_duke</span><span>|</span><a href="#41573012">parent</a><span>|</span><a href="#41574614">next</a><span>|</span><label class="collapse" for="c-41576029">[-]</label><label class="expand" for="c-41576029">[2 more]</label></div><br/><div class="children"><div class="content">This isn&#x27;t just a problem in JS.<p>In every language I looked the otel libraries were a bloated, over-abstracted and resource-hungry mess.<p>I think that&#x27;s partially because it is actually difficult and complex to implement, and partially because the implementations are often written by devs without a long history of implementing similar systems.</div><br/><div id="41576286" class="c"><input type="checkbox" id="c-41576286" checked=""/><div class="controls bullet"><span class="by">snuxoll</span><span>|</span><a href="#41573012">root</a><span>|</span><a href="#41576029">parent</a><span>|</span><a href="#41574614">next</a><span>|</span><label class="collapse" for="c-41576286">[-]</label><label class="expand" for="c-41576286">[1 more]</label></div><br/><div class="children"><div class="content">The .net implementation is about as clean as it can get, but a lot of that has to do with Microsoft caring very deeply about this kind of performance data for a very long time (thus having the entire System.Diagnostics namespace).<p>There’s certainly some abstraction that is gratuitous still, but it’s better than most of the architect astronaut code I’ve seen targeting the CLR.</div><br/></div></div></div></div><div id="41574614" class="c"><input type="checkbox" id="c-41574614" checked=""/><div class="controls bullet"><span class="by">chucklenorris</span><span>|</span><a href="#41573012">parent</a><span>|</span><a href="#41576029">prev</a><span>|</span><a href="#41575998">next</a><span>|</span><label class="collapse" for="c-41574614">[-]</label><label class="expand" for="c-41574614">[2 more]</label></div><br/><div class="children"><div class="content">Yes, this is exactly my impression too.. the code for opentelemetry-js is over engineered and adds a scary amount of dependency code. There are quite a bunch of libraries which I&#x27;m not sure what they do and in which scenarios I might need them. The documentation is not very helpful either. I look forward to someone implementing a opentelemetry-nano package with only the minimum stuff needed and allow me to choose extra support for my dependencies or an easy way of adding my own wrappers.</div><br/><div id="41576325" class="c"><input type="checkbox" id="c-41576325" checked=""/><div class="controls bullet"><span class="by">pimeys</span><span>|</span><a href="#41573012">root</a><span>|</span><a href="#41574614">parent</a><span>|</span><a href="#41575998">next</a><span>|</span><label class="collapse" for="c-41576325">[-]</label><label class="expand" for="c-41576325">[1 more]</label></div><br/><div class="children"><div class="content">Also badly documented. If you try to implement something non-standard with it, good luck. I once needed to write code where trace started in node an continued inside a node api native library. Getting these two traces to connect must be one of the most frustrating things I&#x27;ve worked on.<p>At least on the Rust side you have types to help you out, but it is still quite complex and the crates have bugs open for years, impossible to solve with the current architecture.</div><br/></div></div></div></div><div id="41575998" class="c"><input type="checkbox" id="c-41575998" checked=""/><div class="controls bullet"><span class="by">lastartes</span><span>|</span><a href="#41573012">parent</a><span>|</span><a href="#41574614">prev</a><span>|</span><a href="#41574770">next</a><span>|</span><label class="collapse" for="c-41575998">[-]</label><label class="expand" for="c-41575998">[1 more]</label></div><br/><div class="children"><div class="content">I had a lot of fun wading through that mess in the past trying to determine why something wasn&#x27;t working. A fun fact that I just learned is that the node sdk is now just a shim over <a href="https:&#x2F;&#x2F;www.npmjs.com&#x2F;package&#x2F;@azure&#x2F;monitor-opentelemetry" rel="nofollow">https:&#x2F;&#x2F;www.npmjs.com&#x2F;package&#x2F;@azure&#x2F;monitor-opentelemetry</a>. It seems like the future is just using that package directly which hopefully improves the situation. One benefit is you can extend it with OTel instrumentation packages.</div><br/></div></div><div id="41574770" class="c"><input type="checkbox" id="c-41574770" checked=""/><div class="controls bullet"><span class="by">wordofx</span><span>|</span><a href="#41573012">parent</a><span>|</span><a href="#41575998">prev</a><span>|</span><a href="#41573813">next</a><span>|</span><label class="collapse" for="c-41574770">[-]</label><label class="expand" for="c-41574770">[2 more]</label></div><br/><div class="children"><div class="content">What’s your plans for applications insights sunsetting?</div><br/><div id="41574979" class="c"><input type="checkbox" id="c-41574979" checked=""/><div class="controls bullet"><span class="by">MuffinFlavored</span><span>|</span><a href="#41573012">root</a><span>|</span><a href="#41574770">parent</a><span>|</span><a href="#41573813">next</a><span>|</span><label class="collapse" for="c-41574979">[-]</label><label class="expand" for="c-41574979">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;azure.microsoft.com&#x2F;en-us&#x2F;updates&#x2F;we-re-retiring-classic-application-insights-on-29-february-2024&#x2F;" rel="nofollow">https:&#x2F;&#x2F;azure.microsoft.com&#x2F;en-us&#x2F;updates&#x2F;we-re-retiring-cla...</a><p>Do you have a link for what you are speaking of?</div><br/></div></div></div></div></div></div><div id="41573813" class="c"><input type="checkbox" id="c-41573813" checked=""/><div class="controls bullet"><span class="by">krashidov</span><span>|</span><a href="#41573012">prev</a><span>|</span><a href="#41573009">next</a><span>|</span><label class="collapse" for="c-41573813">[-]</label><label class="expand" for="c-41573813">[5 more]</label></div><br/><div class="children"><div class="content">It&#x27;s so easy in node. I miss node.<p>Setting this up in the mess that is Python&#x2F;Gunicorn&#x2F;asgi&#x2F;wsgi&#x2F;celery&#x2F;Django has not been as easy</div><br/><div id="41577136" class="c"><input type="checkbox" id="c-41577136" checked=""/><div class="controls bullet"><span class="by">rtpg</span><span>|</span><a href="#41573813">parent</a><span>|</span><a href="#41574789">next</a><span>|</span><label class="collapse" for="c-41577136">[-]</label><label class="expand" for="c-41577136">[1 more]</label></div><br/><div class="children"><div class="content">Honeycombs old tooling for Python was miles better than the Otel nonsense. Embarrassing to see so many companies drop their well designed libs for Otel instead of something like wrapping Otel so that their better libs can still be used at the top level</div><br/></div></div><div id="41574789" class="c"><input type="checkbox" id="c-41574789" checked=""/><div class="controls bullet"><span class="by">tempest_</span><span>|</span><a href="#41573813">parent</a><span>|</span><a href="#41577136">prev</a><span>|</span><a href="#41575061">next</a><span>|</span><label class="collapse" for="c-41574789">[-]</label><label class="expand" for="c-41574789">[2 more]</label></div><br/><div class="children"><div class="content">Sentry has been nice.<p>I do not know what unholy monkey patching they do with that sentry_sdk.init call and I try not to think about it but for web apps it is fire and forget.</div><br/><div id="41576881" class="c"><input type="checkbox" id="c-41576881" checked=""/><div class="controls bullet"><span class="by">krashidov</span><span>|</span><a href="#41573813">root</a><span>|</span><a href="#41574789">parent</a><span>|</span><a href="#41575061">next</a><span>|</span><label class="collapse" for="c-41576881">[-]</label><label class="expand" for="c-41576881">[1 more]</label></div><br/><div class="children"><div class="content">hmm do you use Sentry for logging? We use sentry as well but only for errors. Also the trace ids don&#x27;t match with the logging traces so I have to fix that too</div><br/></div></div></div></div><div id="41575061" class="c"><input type="checkbox" id="c-41575061" checked=""/><div class="controls bullet"><span class="by">viraptor</span><span>|</span><a href="#41573813">parent</a><span>|</span><a href="#41574789">prev</a><span>|</span><a href="#41573009">next</a><span>|</span><label class="collapse" for="c-41575061">[-]</label><label class="expand" for="c-41575061">[1 more]</label></div><br/><div class="children"><div class="content">You can do almost 1:1 the same thing (compared to the post) in Python and use it as a wsgi&#x2F;whatever middleware. It&#x27;s really not any different. The callback changes to a resource manager, but that&#x27;s about it.</div><br/></div></div></div></div><div id="41573009" class="c"><input type="checkbox" id="c-41573009" checked=""/><div class="controls bullet"><span class="by">thewisenerd</span><span>|</span><a href="#41573813">prev</a><span>|</span><a href="#41573196">next</a><span>|</span><label class="collapse" for="c-41573009">[-]</label><label class="expand" for="c-41573009">[2 more]</label></div><br/><div class="children"><div class="content">the &quot;true spec is the data&quot; is very powerful.<p>for example, we translate our loosely OTEL-based telemetry into a format which was consumable by any otel collector.<p>shim a few fields, et voila! can be read by Jaeger-UI. free trace tree visualization.</div><br/><div id="41574830" class="c"><input type="checkbox" id="c-41574830" checked=""/><div class="controls bullet"><span class="by">alisonatwork</span><span>|</span><a href="#41573009">parent</a><span>|</span><a href="#41573196">next</a><span>|</span><label class="collapse" for="c-41574830">[-]</label><label class="expand" for="c-41574830">[1 more]</label></div><br/><div class="children"><div class="content">I agree. The hardest work on OpenTelemetry (and OpenCensus&#x2F;OpenTracing before it) was looking at all the different vendors and trying to come up with a common set of semantic conventions[0].<p>If your team is new to metrics or tracing - or even just structured logging - it&#x27;s worth to start adding fields in the general structure of the otel semantic conventions, because then whichever third party service you eventually decide to push to, it won&#x27;t take much of a shim to adapt your data to get there. And if you just stick with JSON logs pushed to ELK (or whatever) you at least build up a useful set of fields to query on.<p>[0] <a href="https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;concepts&#x2F;semantic-conventions&#x2F;" rel="nofollow">https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;concepts&#x2F;semantic-conventions&#x2F;</a></div><br/></div></div></div></div><div id="41573196" class="c"><input type="checkbox" id="c-41573196" checked=""/><div class="controls bullet"><span class="by">h1fra</span><span>|</span><a href="#41573009">prev</a><span>|</span><a href="#41574903">next</a><span>|</span><label class="collapse" for="c-41573196">[-]</label><label class="expand" for="c-41573196">[5 more]</label></div><br/><div class="children"><div class="content">I have one biff against otel, it&#x27;s not possible to stream a trace. You have to build a big object in memory that is not suitable for a long-running process. And because of that it&#x27;s not possible to start it somewhere and finish it somewhere else</div><br/><div id="41573406" class="c"><input type="checkbox" id="c-41573406" checked=""/><div class="controls bullet"><span class="by">thephyber</span><span>|</span><a href="#41573196">parent</a><span>|</span><a href="#41573438">next</a><span>|</span><label class="collapse" for="c-41573406">[-]</label><label class="expand" for="c-41573406">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m under the impression this is wrong. A trace is made from one or more spans. So long as the context is propagated[1] from one service to another, any number of spans referring to the same trace can be generated anywhere at any time. The trace+spans don&#x27;t have to be created in the order of a stack.<p>[1] <a href="https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;concepts&#x2F;context-propagation&#x2F;" rel="nofollow">https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;concepts&#x2F;context-propagation&#x2F;</a></div><br/><div id="41573539" class="c"><input type="checkbox" id="c-41573539" checked=""/><div class="controls bullet"><span class="by">phillipcarter</span><span>|</span><a href="#41573196">root</a><span>|</span><a href="#41573406">parent</a><span>|</span><a href="#41573438">next</a><span>|</span><label class="collapse" for="c-41573539">[-]</label><label class="expand" for="c-41573539">[1 more]</label></div><br/><div class="children"><div class="content">This is correct. Traces are made up of spans that can be created within the same process, different processes, different machines, etc. and all emitted asynchronously.</div><br/></div></div></div></div><div id="41573438" class="c"><input type="checkbox" id="c-41573438" checked=""/><div class="controls bullet"><span class="by">eterm</span><span>|</span><a href="#41573196">parent</a><span>|</span><a href="#41573406">prev</a><span>|</span><a href="#41574939">next</a><span>|</span><label class="collapse" for="c-41573438">[-]</label><label class="expand" for="c-41573438">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think that&#x27;s a limitation of the specification. You can create spans and emit events for those spans without holding objects in memory.</div><br/></div></div><div id="41574939" class="c"><input type="checkbox" id="c-41574939" checked=""/><div class="controls bullet"><span class="by">malkia</span><span>|</span><a href="#41573196">parent</a><span>|</span><a href="#41573438">prev</a><span>|</span><a href="#41574903">next</a><span>|</span><label class="collapse" for="c-41574939">[-]</label><label class="expand" for="c-41574939">[1 more]</label></div><br/><div class="children"><div class="content">There is no concept of streaming trace. You are propagating a random ID, and expect other NODES (yours, or outside of your control) to re-emit these, and if need to create new ones.<p>The agreement is that these nodes would either emit all these events to (eventually) a common place (push), or something is going to gather them (pull).<p>I think at Google, some of these used to be still on the machines, and the tools would pull them directly, and back then it was possible to mark certain for preservance (that was long time ago - 2014, so I&#x27;m sure things have changed).<p>Also I was on the over-excited edge, because I was not aware what was this, but I was on call (a small team in ads), and had to page up to the Bigtable&#x2F;Megastore or was it Spanner team, and they simply asked me to bump some tracing bits up for like 30 seconds, then something magically showed up - and I was - wtf!<p>I think it was then it clicked with me how useful this is, .... but also how much wasteful (in terms of resources) it could be if you don&#x27;t end up looking there.</div><br/></div></div></div></div><div id="41574903" class="c"><input type="checkbox" id="c-41574903" checked=""/><div class="controls bullet"><span class="by">caseyw</span><span>|</span><a href="#41573196">prev</a><span>|</span><label class="collapse" for="c-41574903">[-]</label><label class="expand" for="c-41574903">[1 more]</label></div><br/><div class="children"><div class="content">OpenTelemetry (OTel) and the OpenTelemetry Protocol (OTLP) are immensely powerful tools. The ability to emit telemetry data from any source, coupled with a receiver that can sample, filter, pipe, and potentially reshape the data to suit any need, is a game changer. This flexibility revolutionizes how we approach observability and monitoring across diverse systems.</div><br/></div></div></div></div></div></div></div></body></html>