<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1714381266442" as="style"/><link rel="stylesheet" href="styles.css?v=1714381266442"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://postgres.ai/blog/20220525-common-db-schema-change-mistakes">Common DB schema change mistakes in Postgres</a> <span class="domain">(<a href="https://postgres.ai">postgres.ai</a>)</span></div><div class="subtext"><span>thunderbong</span> | <span>27 comments</span></div><br/><div><div id="40194575" class="c"><input type="checkbox" id="c-40194575" checked=""/><div class="controls bullet"><span class="by">zer00eyz</span><span>|</span><a href="#40194973">next</a><span>|</span><label class="collapse" for="c-40194575">[-]</label><label class="expand" for="c-40194575">[17 more]</label></div><br/><div class="children"><div class="content">I like Postgres, a lot.<p>Most of the things in this article are avoidable, and good to keep an eye out for.<p>But let&#x27;s be clear we&#x27;re not talking about the worst part of Postgres: roles. There is a ton of power there, it would be amazing to use it. Making it work feels like black magic. Every bit of the interface around it just seems like esoteric incantations that may or may not do what you expect. It&#x27;s a terrible way to manage something so important.<p>THe manual for this section is, thin. It gives you an idea of how things should work, maybe, in a narrow use case. The problem is when they dont your going to spend time doing a lot of trial and error to figure out what you did wrong, and likely not have a clue as to how to do it right. And may god have mercy on your soul if you want to migrate a db with complex user permissions.<p>I need to sit down with it for a month and write &quot;cookbook&quot;. If one person uses it and goes to bed that night without crying them selves to sleep it will have been worth it.</div><br/><div id="40195682" class="c"><input type="checkbox" id="c-40195682" checked=""/><div class="controls bullet"><span class="by">WinDoctor</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40196058">next</a><span>|</span><label class="collapse" for="c-40195682">[-]</label><label class="expand" for="c-40195682">[1 more]</label></div><br/><div class="children"><div class="content">I agree with the sentiment that IAM in PostgreSQL is complex.<p>What makes it complex is that there are 3 layers of objects (Database, Schema, Tables) and also implicit grants given to DB object owners<p>To be able to select from a table you need:<p>* CONNECT on the Database<p>* USAGE on the Schema (Given implicitly to schema owner)<p>* SELECT on the Table (Given implicitly to table owner)<p>To see these privileges we need to understand acl entries of this format<p>`grantee=privilege-abbreviation[<i>]&#x2F;grantor:`<p>* Use \l+ to see privileges of Database<p>* Use \dn+ to see privileges of Schemas<p>* Use \dp+ to see privileges of Tables<p>Privileges are seen [here](<a href="https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;ddl-priv.html" rel="nofollow">https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;ddl-priv.html</a>)<p>e.g. in the following example user has been given all permissions by postgres role<p>`user=arwdDxt&#x2F;postgres`<p>If the “grantee” column is empty for a given object, it means the object has default owner privileges (all privileges) or it can mean privileges to PUBLIC role (every role that exists)<p>`=r&#x2F;postgres`</i><p>Also it&#x27;s confusing when Public schema is used. You have CREATE permission on schema so when the tables are created with the same user you select data with and you have owner permissions out of the box.</div><br/></div></div><div id="40196058" class="c"><input type="checkbox" id="c-40196058" checked=""/><div class="controls bullet"><span class="by">hnben</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40195682">prev</a><span>|</span><a href="#40194694">next</a><span>|</span><label class="collapse" for="c-40196058">[-]</label><label class="expand" for="c-40196058">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Making it work feels like black magic.<p>Can confirm. Last year I implemented a simple postgREST server with rowlevel security. (The postgREST logs are really good. With cookbook and all)<p>The path there was somewhat difficult, but once it worked, it was truly magical. And the mechanisms involved were quite simple even.</div><br/></div></div><div id="40194694" class="c"><input type="checkbox" id="c-40194694" checked=""/><div class="controls bullet"><span class="by">dewey</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40196058">prev</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40194694">[-]</label><label class="expand" for="c-40194694">[10 more]</label></div><br/><div class="children"><div class="content">I’d read that. Role management for me often involves a lot of guessing and too often roles end up with too many permissions because of that.</div><br/><div id="40195733" class="c"><input type="checkbox" id="c-40195733" checked=""/><div class="controls bullet"><span class="by">WinDoctor</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40194694">parent</a><span>|</span><a href="#40194762">next</a><span>|</span><label class="collapse" for="c-40195733">[-]</label><label class="expand" for="c-40195733">[1 more]</label></div><br/><div class="children"><div class="content">Here&#x27;s your cookbook: <a href="https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;78401179&#x2F;how-do-postgresql-permissions-work-permissions-needed-to-select-from-table" rel="nofollow">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;78401179&#x2F;how-do-postgres...</a></div><br/></div></div><div id="40194762" class="c"><input type="checkbox" id="c-40194762" checked=""/><div class="controls bullet"><span class="by">yen223</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40194694">parent</a><span>|</span><a href="#40195733">prev</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40194762">[-]</label><label class="expand" for="c-40194762">[8 more]</label></div><br/><div class="children"><div class="content">Hah, role management for us is &quot;create a role for migrations, and a role to do db things, and enforce auth entirely in the web app&quot;<p>I suspect we aren&#x27;t alone</div><br/><div id="40194881" class="c"><input type="checkbox" id="c-40194881" checked=""/><div class="controls bullet"><span class="by">jzelinskie</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40194762">parent</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40194881">[-]</label><label class="expand" for="c-40194881">[7 more]</label></div><br/><div class="children"><div class="content">This is a fairly sane place to be in terms of bang for your buck. It&#x27;s easy to find yourself in a place where authorization data and logic span multiple services and at that point having everything deeply siloed into Postgres might be a doozy. That being said, there are plenty of times that&#x27;ll never be the case and you should try to lean on the abstractions that work best for you.</div><br/><div id="40195723" class="c"><input type="checkbox" id="c-40195723" checked=""/><div class="controls bullet"><span class="by">ludston</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40194881">parent</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40195723">[-]</label><label class="expand" for="c-40195723">[6 more]</label></div><br/><div class="children"><div class="content">Roles are for services not for users. If you have a read-only Web api then it makes sense to use a read-only role regardless of which user is using it.</div><br/><div id="40195769" class="c"><input type="checkbox" id="c-40195769" checked=""/><div class="controls bullet"><span class="by">WinDoctor</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195723">parent</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40195769">[-]</label><label class="expand" for="c-40195769">[5 more]</label></div><br/><div class="children"><div class="content">Everything in PostgreSQL is a role.<p>It&#x27;s just named such that when a ROLE allows `login` it&#x27;s considered a user</div><br/><div id="40195924" class="c"><input type="checkbox" id="c-40195924" checked=""/><div class="controls bullet"><span class="by">orthoxerox</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195769">parent</a><span>|</span><a href="#40195874">next</a><span>|</span><label class="collapse" for="c-40195924">[-]</label><label class="expand" for="c-40195924">[1 more]</label></div><br/><div class="children"><div class="content">Someone was feeling very clever when they came up with this idea.</div><br/></div></div><div id="40195874" class="c"><input type="checkbox" id="c-40195874" checked=""/><div class="controls bullet"><span class="by">skissane</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195769">parent</a><span>|</span><a href="#40195924">prev</a><span>|</span><a href="#40195932">next</a><span>|</span><label class="collapse" for="c-40195874">[-]</label><label class="expand" for="c-40195874">[2 more]</label></div><br/><div class="children"><div class="content">This is part of what many people find so confusing. In most systems “role” is a group (or something closely resembling a group), not a user. The weird terminology confuses beginners</div><br/><div id="40195975" class="c"><input type="checkbox" id="c-40195975" checked=""/><div class="controls bullet"><span class="by">WinDoctor</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195874">parent</a><span>|</span><a href="#40195932">next</a><span>|</span><label class="collapse" for="c-40195975">[-]</label><label class="expand" for="c-40195975">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a bit confusing and legacy.<p>All roles function like you would expect groups to function<p>A role that is not allowed to login is a `group`.<p>While the CREATE USER and CREATE GROUP commands still exist, they are simply aliases for CREATE ROLE.</div><br/></div></div></div></div><div id="40195932" class="c"><input type="checkbox" id="c-40195932" checked=""/><div class="controls bullet"><span class="by">cqqxo4zV46cp</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195769">parent</a><span>|</span><a href="#40195874">prev</a><span>|</span><a href="#40195223">next</a><span>|</span><label class="collapse" for="c-40195932">[-]</label><label class="expand" for="c-40195932">[1 more]</label></div><br/><div class="children"><div class="content">To me, the comment you are replying to is saying that you should^ DIFFERENTIATE roles by service, not ‘end user’.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="40195223" class="c"><input type="checkbox" id="c-40195223" checked=""/><div class="controls bullet"><span class="by">egeozcan</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40194694">prev</a><span>|</span><a href="#40195099">next</a><span>|</span><label class="collapse" for="c-40195223">[-]</label><label class="expand" for="c-40195223">[1 more]</label></div><br/><div class="children"><div class="content">Even the docs of postgrest, which relies on roles for auth, seems to be not very detailed: <a href="https:&#x2F;&#x2F;postgrest.org&#x2F;en&#x2F;v12&#x2F;explanations&#x2F;db_authz.html" rel="nofollow">https:&#x2F;&#x2F;postgrest.org&#x2F;en&#x2F;v12&#x2F;explanations&#x2F;db_authz.html</a><p>Interesting. If you are serious about writing a cookbook for postgres roles, and open something like a kickstarter, I&#x27;ll be one of the first to pledge!</div><br/></div></div><div id="40195099" class="c"><input type="checkbox" id="c-40195099" checked=""/><div class="controls bullet"><span class="by">futureduck</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40195223">prev</a><span>|</span><a href="#40195354">next</a><span>|</span><label class="collapse" for="c-40195099">[-]</label><label class="expand" for="c-40195099">[1 more]</label></div><br/><div class="children"><div class="content">I have seen what you have seen (did several &quot;serious&quot; things using postgrest).<p>edit: i mean yes, we need that cookbook real bad</div><br/></div></div><div id="40195354" class="c"><input type="checkbox" id="c-40195354" checked=""/><div class="controls bullet"><span class="by">7bit</span><span>|</span><a href="#40194575">parent</a><span>|</span><a href="#40195099">prev</a><span>|</span><a href="#40194973">next</a><span>|</span><label class="collapse" for="c-40195354">[-]</label><label class="expand" for="c-40195354">[2 more]</label></div><br/><div class="children"><div class="content">I recently had to rename an app I was developing. That included the linux user account under which the service ran, and therefore the postgres user.<p>I don&#x27;t remember all the details, but I had to also rename the postgres user and role, which seemed a simple thing to do. But for some reason renaming the user didn&#x27;t include the permissions on the database. I was left with a very confusing state of working table access and denied record access. I decided to backup the data, dropp the database and do an import that didn&#x27;t include any permissions.<p>That simple thing turned out a complete shit show and I blame Postgres for making something so simple so complex.</div><br/><div id="40195945" class="c"><input type="checkbox" id="c-40195945" checked=""/><div class="controls bullet"><span class="by">cqqxo4zV46cp</span><span>|</span><a href="#40194575">root</a><span>|</span><a href="#40195354">parent</a><span>|</span><a href="#40194973">next</a><span>|</span><label class="collapse" for="c-40195945">[-]</label><label class="expand" for="c-40195945">[1 more]</label></div><br/><div class="children"><div class="content">I never use system accounts for Postgres auth. It feels like coupling that won’t do anything good for most people most of the time, and will only bite you in the ass when you don’t expect it to.</div><br/></div></div></div></div></div></div><div id="40194973" class="c"><input type="checkbox" id="c-40194973" checked=""/><div class="controls bullet"><span class="by">Ozzie_osman</span><span>|</span><a href="#40194575">prev</a><span>|</span><a href="#40194891">next</a><span>|</span><label class="collapse" for="c-40194973">[-]</label><label class="expand" for="c-40194973">[5 more]</label></div><br/><div class="children"><div class="content">If you are running schema migrations in production, use &quot;lock_timeout&quot;. Even seemingly-benign modifications like dropping a table (with foreign keys) or dropping a foreign key, which are generally quick and may run nearly-instantaneously when you&#x27;re testing them, may end up hitting a lock conflict on a heavily-used production database (with existing transactions, with an autovacuum, etc). That ALTER is then waiting on the first transaction&#x27;s lock, but it has acquired an ACCESS EXCLUSIVE lock, meaning no queries can run against the locked table.<p>If you&#x27;re doing any postgres at scale, it&#x27;s just a matter of time until you hit one of these conflicts. &quot;lock_timeout&quot; will just cause the migration to fail after the timeout, rather than just blocking all other queries.</div><br/><div id="40195488" class="c"><input type="checkbox" id="c-40195488" checked=""/><div class="controls bullet"><span class="by">kroolik</span><span>|</span><a href="#40194973">parent</a><span>|</span><a href="#40195881">next</a><span>|</span><label class="collapse" for="c-40195488">[-]</label><label class="expand" for="c-40195488">[1 more]</label></div><br/><div class="children"><div class="content">&#x27;statement_timeout&#x27; includes lock timeout and lets you better estimate the impact on hot tables. When you set the timeout to 5s, you know the downtime will be max 5s total, and transactions will continue afterwards. With lock timeout, you dont control how long the part after the lock will take - may be fast, may be slow, due to concurrent traffic, for example.</div><br/></div></div><div id="40195881" class="c"><input type="checkbox" id="c-40195881" checked=""/><div class="controls bullet"><span class="by">incorrecthorse</span><span>|</span><a href="#40194973">parent</a><span>|</span><a href="#40195488">prev</a><span>|</span><a href="#40195425">next</a><span>|</span><label class="collapse" for="c-40195881">[-]</label><label class="expand" for="c-40195881">[1 more]</label></div><br/><div class="children"><div class="content">Excellent advice.<p>On the technical side, I believed waiting was due to the lock queue rather that having acquired an ACCESS EXCLUSIVE lock. The ALTER is specifically _waiting_ for any lock lower than ACCESS EXCLUSIVE to be release.</div><br/></div></div><div id="40195425" class="c"><input type="checkbox" id="c-40195425" checked=""/><div class="controls bullet"><span class="by">glenjamin</span><span>|</span><a href="#40194973">parent</a><span>|</span><a href="#40195881">prev</a><span>|</span><a href="#40194891">next</a><span>|</span><label class="collapse" for="c-40195425">[-]</label><label class="expand" for="c-40195425">[2 more]</label></div><br/><div class="children"><div class="content">Related to this, there is quite a large variation across Postgres versions about whether a particular DML query will take an exclusive lock or not.<p>Is there a good way to analyse a query and be informed of what sort of lock it will take?<p>I’ve always resorted to re-reading docs when I’m unsure.</div><br/><div id="40195494" class="c"><input type="checkbox" id="c-40195494" checked=""/><div class="controls bullet"><span class="by">kroolik</span><span>|</span><a href="#40194973">root</a><span>|</span><a href="#40195425">parent</a><span>|</span><a href="#40194891">next</a><span>|</span><label class="collapse" for="c-40195494">[-]</label><label class="expand" for="c-40195494">[1 more]</label></div><br/><div class="children"><div class="content">For me the best way is testing it locally, side-by-side, with two transactions. You dont need any data for this.<p>After some experience, you start to see the reasons for locks and how they will impact you.<p>Or read the docs.</div><br/></div></div></div></div></div></div><div id="40194891" class="c"><input type="checkbox" id="c-40194891" checked=""/><div class="controls bullet"><span class="by">scraplab</span><span>|</span><a href="#40194973">prev</a><span>|</span><a href="#40195501">next</a><span>|</span><label class="collapse" for="c-40194891">[-]</label><label class="expand" for="c-40194891">[1 more]</label></div><br/><div class="children"><div class="content">I refer to Fly.io’s guide to Safe Migrations in Ecto (Elixir’s DB adapter) multiple times a week. It’s a very useful quick reference to check whether you can get away with a basic migration or if something more involved is required.<p><a href="https:&#x2F;&#x2F;fly.io&#x2F;phoenix-files&#x2F;safe-ecto-migrations&#x2F;">https:&#x2F;&#x2F;fly.io&#x2F;phoenix-files&#x2F;safe-ecto-migrations&#x2F;</a></div><br/></div></div><div id="40195501" class="c"><input type="checkbox" id="c-40195501" checked=""/><div class="controls bullet"><span class="by">saddist0</span><span>|</span><a href="#40194891">prev</a><span>|</span><a href="#40195217">next</a><span>|</span><label class="collapse" for="c-40195501">[-]</label><label class="expand" for="c-40195501">[1 more]</label></div><br/><div class="children"><div class="content">Another common mistake I have seen: duplicating tables without the indexes.<p>This is not how it works, period.<p><pre><code>    CREATE TABLE &lt;abcv2&gt; SELECT * FROM &lt;abc&gt; WHERE &lt;&gt;
</code></pre>
People do it all the time, either to create a backup table, or deleting data in bulk, etc.</div><br/></div></div><div id="40195217" class="c"><input type="checkbox" id="c-40195217" checked=""/><div class="controls bullet"><span class="by">fabianlindfors</span><span>|</span><a href="#40195501">prev</a><span>|</span><a href="#40195766">next</a><span>|</span><label class="collapse" for="c-40195217">[-]</label><label class="expand" for="c-40195217">[1 more]</label></div><br/><div class="children"><div class="content">These pitfalls are one reasons why I built Reshape [0], which aims to automate zero-downtime schema migrations.<p>I can’t say it avoids all of them but we are working on a new product that would. If you are interested in this space (and Postgres specifically), I’d love to hear from you: fabian@reshapedb.com<p>[0] <a href="https:&#x2F;&#x2F;github.com&#x2F;fabianlindfors&#x2F;reshape">https:&#x2F;&#x2F;github.com&#x2F;fabianlindfors&#x2F;reshape</a></div><br/></div></div></div></div></div></div></div></body></html>