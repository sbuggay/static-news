<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1721725254542" as="style"/><link rel="stylesheet" href="styles.css?v=1721725254542"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/codr7/sharpl">Show HN: Lisp in C#</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>codr7</span> | <span>20 comments</span></div><br/><div><div id="41042326" class="c"><input type="checkbox" id="c-41042326" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41043038">next</a><span>|</span><label class="collapse" for="c-41042326">[-]</label><label class="expand" for="c-41042326">[10 more]</label></div><br/><div class="children"><div class="content">Author here.<p>I&#x27;m afraid I&#x27;ve been out of the C# loop too long to know what&#x27;s fast and what isn&#x27;t these days.<p>Now that maybe I have the attention of some serious C# nerds, any assistance in making this thing run faster would be much appreciated.<p>It&#x27;s not terrible atm, given a managed host language, but I&#x27;m sure there are plenty of knobs left to turn.<p>See the benchmarks section in the README for more info, and the same benchmarks ported to Python in python&#x2F;fib.py.<p>Oh, and there&#x27;s some undocumented yet potentially useful stuff in &#x2F;Libs; strings, terminal control and IO mainly.</div><br/><div id="41042941" class="c"><input type="checkbox" id="c-41042941" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41042326">parent</a><span>|</span><a href="#41042434">next</a><span>|</span><label class="collapse" for="c-41042941">[-]</label><label class="expand" for="c-41042941">[1 more]</label></div><br/><div class="children"><div class="content">By all means, keep them coming people :)<p>We just roughly doubled the speed by changing one line of code, that means there&#x27;s plenty more fun before it gets really tricky.<p>My issue isn&#x27;t really profiling, its not knowing enough about the platform to do anything constructive with the hot spots.</div><br/></div></div><div id="41042434" class="c"><input type="checkbox" id="c-41042434" checked=""/><div class="controls bullet"><span class="by">neonsunset</span><span>|</span><a href="#41042326">parent</a><span>|</span><a href="#41042941">prev</a><span>|</span><a href="#41043038">next</a><span>|</span><label class="collapse" for="c-41042434">[-]</label><label class="expand" for="c-41042434">[8 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;github.com&#x2F;codr7&#x2F;sharpl&#x2F;pull&#x2F;1">https:&#x2F;&#x2F;github.com&#x2F;codr7&#x2F;sharpl&#x2F;pull&#x2F;1</a><p>Was: 686 98 1195<p>Now: 226 79 293 (with net9.0 preview: 201 70 269, another release another free &gt;10%)<p>The reason for such a significant difference is that `ArrayStack&lt;(int, int)&gt;` only implements `IEnumerable&lt;T&gt;`, which prevented the Enumerable.Last(stack) call from seeing that the type has an indexer which can be used to quickly access the last element instead of traversing it in its entirety.<p>Now, it still requires JIT (or, in this case, compiler back-end and ILC) to reason about the actual type of ArrayStack to optimize away type tests, inline Last() call and devirtualize indexer access, but the better option is simply replacing it with just [^1] which does the same on any <i>indexable</i> type.<p>Generally speaking, it&#x27;s recommended to use out of box collections whenever appropriate like Stack, List, etc. which already implement all the necessary interfaces which the standard library takes advantage of unless there&#x27;s a specific need to do otherwise.<p>Also, it is always nice to have .net&#x27;s aot emit &quot;canonical&quot; native binaries, so it took me about 45s to find the bottleneck by bumping up the numbers in benchmarks.sl and clicking &quot;Sample&quot; in macOS&#x27;s Activity Monitor.<p>All in all, the code in the project is terse and thanks for showcasing it!</div><br/><div id="41042485" class="c"><input type="checkbox" id="c-41042485" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042434">parent</a><span>|</span><a href="#41043475">next</a><span>|</span><label class="collapse" for="c-41042485">[-]</label><label class="expand" for="c-41042485">[5 more]</label></div><br/><div class="children"><div class="content">Nice work, thanks!<p>I&#x27;ll have a look later, the only part I didn&#x27;t get was [^1], could you elaborate?<p>About the ArrayStack, I wanted a stack backed by a fixed array, because my suspicion was using a fixed array for fundamental collections would be faster. Hence the VM.Config object to set the max sizes.<p>There is also a DynamicArrayStack that supports reallocation, which is currently used by OrderedMap.<p>The plan is to eventually benchmark the alternatives, but start with the simplest thing that could possibly work.</div><br/><div id="41042532" class="c"><input type="checkbox" id="c-41042532" checked=""/><div class="controls bullet"><span class="by">neonsunset</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042485">parent</a><span>|</span><a href="#41043475">next</a><span>|</span><label class="collapse" for="c-41042532">[-]</label><label class="expand" for="c-41042532">[4 more]</label></div><br/><div class="children"><div class="content">Here, calling `.Last()` on `ArrayStack&lt;T&gt;` traverses it from the start. `.Last()` is a static extension method defined on `System.Linq.Enumerable` class and has a signature `static T Last&lt;T&gt;(this IEnumerable&lt;T&gt; source)`.<p>Internally, `.Last()` will try to optimize for the common cases where a type implements `IList&lt;T&gt;` and uses an indexer to simply get the last element. However, because ArrayStack&lt;T&gt; does not implement IList&lt;T&gt;, .Last() does not know that this is possible, therefore costs O(n) as noted above.<p>Instead, we can simply use an index operator `[^1]` which gets the first element from end, which is short-hand for `[stack.Count - 1]`.<p>Other than that, it’s a good idea to lean towards out-of-box tools to avoid investing effort into reinventing another language within C# and use spans for slicing data types - you almost never need to call methods like Array.ConstrainedCopy - this is something quite ancient. The idiomatic way of copying a portion of array today is `source.AsSpan(start, length).CopyTo(dest)`, slicing destination as well if you need so. The prime slice types in .NET are Span&lt;T&gt; and ReadOnlySpan&lt;T&gt;, and can wrap memory of any origin.</div><br/><div id="41042545" class="c"><input type="checkbox" id="c-41042545" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042532">parent</a><span>|</span><a href="#41043475">next</a><span>|</span><label class="collapse" for="c-41042545">[-]</label><label class="expand" for="c-41042545">[3 more]</label></div><br/><div class="children"><div class="content">Just the kind of information&#x2F;expertise I was looking for, awesome!</div><br/><div id="41042577" class="c"><input type="checkbox" id="c-41042577" checked=""/><div class="controls bullet"><span class="by">zebracanevra</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042545">parent</a><span>|</span><a href="#41042707">next</a><span>|</span><label class="collapse" for="c-41042577">[-]</label><label class="expand" for="c-41042577">[1 more]</label></div><br/><div class="children"><div class="content">And you can find that specilisation here: <a href="https:&#x2F;&#x2F;source.dot.net&#x2F;#System.Linq&#x2F;System&#x2F;Linq&#x2F;Last.cs,80" rel="nofollow">https:&#x2F;&#x2F;source.dot.net&#x2F;#System.Linq&#x2F;System&#x2F;Linq&#x2F;Last.cs,80</a></div><br/></div></div><div id="41042707" class="c"><input type="checkbox" id="c-41042707" checked=""/><div class="controls bullet"><span class="by">neonsunset</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042545">parent</a><span>|</span><a href="#41042577">prev</a><span>|</span><a href="#41043475">next</a><span>|</span><label class="collapse" for="c-41042707">[-]</label><label class="expand" for="c-41042707">[1 more]</label></div><br/><div class="children"><div class="content">Thank you too!</div><br/></div></div></div></div></div></div></div></div><div id="41043475" class="c"><input type="checkbox" id="c-41043475" checked=""/><div class="controls bullet"><span class="by">adzm</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41042434">parent</a><span>|</span><a href="#41042485">prev</a><span>|</span><a href="#41043038">next</a><span>|</span><label class="collapse" for="c-41043475">[-]</label><label class="expand" for="c-41043475">[2 more]</label></div><br/><div class="children"><div class="content">Alternatively ArrayStack could be modified to implement IList right?</div><br/><div id="41043494" class="c"><input type="checkbox" id="c-41043494" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41042326">root</a><span>|</span><a href="#41043475">parent</a><span>|</span><a href="#41043038">next</a><span>|</span><label class="collapse" for="c-41043494">[-]</label><label class="expand" for="c-41043494">[1 more]</label></div><br/><div class="children"><div class="content">Right, already tried that; Last() is still slightly slower (I guess because of more layers of indirection).</div><br/></div></div></div></div></div></div></div></div><div id="41043038" class="c"><input type="checkbox" id="c-41043038" checked=""/><div class="controls bullet"><span class="by">davidelettieri</span><span>|</span><a href="#41042326">prev</a><span>|</span><a href="#41043046">next</a><span>|</span><label class="collapse" for="c-41043038">[-]</label><label class="expand" for="c-41043038">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s worth mentioning <a href="https:&#x2F;&#x2F;github.com&#x2F;IronScheme&#x2F;IronScheme">https:&#x2F;&#x2F;github.com&#x2F;IronScheme&#x2F;IronScheme</a></div><br/><div id="41043120" class="c"><input type="checkbox" id="c-41043120" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41043038">parent</a><span>|</span><a href="#41043046">next</a><span>|</span><label class="collapse" for="c-41043120">[-]</label><label class="expand" for="c-41043120">[1 more]</label></div><br/><div class="children"><div class="content">Right, I recognize the name.<p>Curious though, I&#x27;m pretty sure it emits MSIL rather than its own bytecode like sharpl? So that would be one difference, in most cases an advantage because of performance.<p>The other obvious difference is I&#x27;m not aiming for any standards, quite the contrary; this is about being so fed up with the alternatives (including Scheme) that spending the rest of my life getting it just right looks like a reasonable deal.</div><br/></div></div></div></div><div id="41043046" class="c"><input type="checkbox" id="c-41043046" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41043038">prev</a><span>|</span><a href="#41042493">next</a><span>|</span><label class="collapse" for="c-41043046">[-]</label><label class="expand" for="c-41043046">[1 more]</label></div><br/><div class="children"><div class="content">If only we could get a tiny Lisp loving push from the HN crew, wink, nudge.<p>I don&#x27;t much like the odds of Lisp vs. Nintendo hardware  kickstarters.</div><br/></div></div><div id="41042493" class="c"><input type="checkbox" id="c-41042493" checked=""/><div class="controls bullet"><span class="by">keithnz</span><span>|</span><a href="#41043046">prev</a><span>|</span><a href="#41041683">next</a><span>|</span><label class="collapse" for="c-41042493">[-]</label><label class="expand" for="c-41042493">[3 more]</label></div><br/><div class="children"><div class="content">years ago someone posted <a href="http:&#x2F;&#x2F;norvig.com&#x2F;lispy.html" rel="nofollow">http:&#x2F;&#x2F;norvig.com&#x2F;lispy.html</a> here on HN<p>I wrote a lisp in C# based on that, it was only a 100+ ish lines of code.  It was a great way to get into Lisp.</div><br/><div id="41043724" class="c"><input type="checkbox" id="c-41043724" checked=""/><div class="controls bullet"><span class="by">dualogy</span><span>|</span><a href="#41042493">parent</a><span>|</span><a href="#41043597">next</a><span>|</span><label class="collapse" for="c-41043724">[-]</label><label class="expand" for="c-41043724">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s also Make-A-Lisp and, unlike most write-you-a-lisp&#x2F;scheme-s out there, that one also covers TCO interpretation, quasiquotation&#x2F;unquote for macros and their expansion, and goes up to self-hosting: <a href="https:&#x2F;&#x2F;github.com&#x2F;kanaka&#x2F;mal&#x2F;">https:&#x2F;&#x2F;github.com&#x2F;kanaka&#x2F;mal&#x2F;</a><p>I just went through it over 2-3 days, great practice IMHO to do once in your life from start to finish: <a href="https:&#x2F;&#x2F;github.com&#x2F;metaleap&#x2F;go-lisp">https:&#x2F;&#x2F;github.com&#x2F;metaleap&#x2F;go-lisp</a></div><br/></div></div><div id="41043597" class="c"><input type="checkbox" id="c-41043597" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41042493">parent</a><span>|</span><a href="#41043724">prev</a><span>|</span><a href="#41041683">next</a><span>|</span><label class="collapse" for="c-41043597">[-]</label><label class="expand" for="c-41043597">[1 more]</label></div><br/><div class="children"><div class="content">Yes, I am aware.<p>I started out designing Forth interpreters, actually calculators and template engines, but Forth was a natural progression.<p>My design differs a lot from idiomatic Lisp implementations (likewise Forth), and I do sometimes wonder what it would look like if you started in that end and worked your way towards supporting all the features of sharpl.</div><br/></div></div></div></div><div id="41041683" class="c"><input type="checkbox" id="c-41041683" checked=""/><div class="controls bullet"><span class="by">Zambyte</span><span>|</span><a href="#41042493">prev</a><span>|</span><a href="#41041666">next</a><span>|</span><label class="collapse" for="c-41041683">[-]</label><label class="expand" for="c-41041683">[2 more]</label></div><br/><div class="children"><div class="content">Cool! I didn&#x27;t get a chance to run it but I dug around the code a little bit. I noticed there is a Macro class, but no mention of macros in the README. Are macros working?</div><br/><div id="41041708" class="c"><input type="checkbox" id="c-41041708" checked=""/><div class="controls bullet"><span class="by">codr7</span><span>|</span><a href="#41041683">parent</a><span>|</span><a href="#41041666">next</a><span>|</span><label class="collapse" for="c-41041708">[-]</label><label class="expand" for="c-41041708">[1 more]</label></div><br/><div class="children"><div class="content">Within the host language for now, they more or less just need to be plugged in.<p>So far there has been no shortage of more important features at the scale of programs it&#x27;s currently viable for.</div><br/></div></div></div></div></div></div></div></div></div></body></html>