<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1727168471114" as="style"/><link rel="stylesheet" href="styles.css?v=1727168471114"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://matklad.github.io/2024/09/32/-what-is-io-uring.html">What Is Io_uring?</a> <span class="domain">(<a href="https://matklad.github.io">matklad.github.io</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>13 comments</span></div><br/><div><div id="41633748" class="c"><input type="checkbox" id="c-41633748" checked=""/><div class="controls bullet"><span class="by">jclulow</span><span>|</span><a href="#41633714">next</a><span>|</span><label class="collapse" for="c-41633748">[-]</label><label class="expand" for="c-41633748">[3 more]</label></div><br/><div class="children"><div class="content">This article, and indeed much of the discourse about the facility out in the wild, could really use some expansion on at least these two points:<p>&gt; The application submits several syscalls by writing their codes &amp; arguments to a lock-free shared-memory ring buffer.<p>That&#x27;s not all, though, right?  Unless you&#x27;re using the dubious kernel-driven polling thread, which I gather is uncommon, you _also_ have to make a submit system call of some kind after you&#x27;ve finished appending stuff to your submit queue.  Otherwise, how would the kernel know you&#x27;d done it?<p>&gt; The kernel reads the syscalls from this shared memory and executes them at its own pace.<p>I think this leaves out most of the interesting information about how it actually works in practice.  Some system calls are not especially asynchronous: they perform some amount of work that isn&#x27;t asynchronously submitted to some hardware in quite the same way as, say, a disk write may be.  What thread is actually performing that work?  Does it occur immediately during the submit system call, and is completed by the time that call returns?  Is some other thread co-opted to perform the work?  Whose scheduling quantum is consumed by this?<p>Without concrete answers that succinctly describe this behaviour it feels impossible to see beyond the hype and get to the actual trade-offs being made.</div><br/><div id="41633919" class="c"><input type="checkbox" id="c-41633919" checked=""/><div class="controls bullet"><span class="by">Tuna-Fish</span><span>|</span><a href="#41633748">parent</a><span>|</span><a href="#41633714">next</a><span>|</span><label class="collapse" for="c-41633919">[-]</label><label class="expand" for="c-41633919">[2 more]</label></div><br/><div class="children"><div class="content">&gt; That&#x27;s not all, though, right? Unless you&#x27;re using the dubious kernel-driven polling thread, which I gather is uncommon, you _also_ have to make a submit system call of some kind after you&#x27;ve finished appending stuff to your submit queue. Otherwise, how would the kernel know you&#x27;d done it?<p>Correct, the &quot;check for new entries&quot; system call is called <i>io_uring_enter()</i>. (0)<p>&gt;  Some system calls are not especially asynchronous: they perform some amount of work that isn&#x27;t asynchronously submitted to some hardware in quite the same way as, say, a disk write may be. What thread is actually performing that work? Does it occur immediately during the submit system call, and is completed by the time that call returns? Is some other thread co-opted to perform the work?<p>A kernel thread. The submit system call can be optionally made to wait for completion, but by default it will always immediately return.<p>&gt; Whose scheduling quantum is consumed by this?<p>That&#x27;s a good question. The IO scheduler correctly sees them as belonging to the submitting thread, but if you issue a bunch of computation-heavy syscalls, I would not be surprised if they were not correctly accounted for.<p>(0) <a href="https:&#x2F;&#x2F;unixism.net&#x2F;loti&#x2F;ref-iouring&#x2F;io_uring_enter.html#c.io_uring_enter" rel="nofollow">https:&#x2F;&#x2F;unixism.net&#x2F;loti&#x2F;ref-iouring&#x2F;io_uring_enter.html#c.i...</a></div><br/></div></div></div></div><div id="41633714" class="c"><input type="checkbox" id="c-41633714" checked=""/><div class="controls bullet"><span class="by">larsrc</span><span>|</span><a href="#41633748">prev</a><span>|</span><a href="#41633922">next</a><span>|</span><label class="collapse" for="c-41633714">[-]</label><label class="expand" for="c-41633714">[3 more]</label></div><br/><div class="children"><div class="content">This bit is unfortunate, I hope it improves: &quot;You might want to avoid io_uring [if] you want to use features with a good security track record.&quot;<p>At least he&#x27;s clear about it.</div><br/><div id="41634362" class="c"><input type="checkbox" id="c-41634362" checked=""/><div class="controls bullet"><span class="by">landr0id</span><span>|</span><a href="#41633714">parent</a><span>|</span><a href="#41633922">next</a><span>|</span><label class="collapse" for="c-41634362">[-]</label><label class="expand" for="c-41634362">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m kind of curious what Alex meant by this, as the security problems relating to io_uring are, to my knowledge, unrelated to the user-space program. It makes sense if you want to disable the feature in your own kernel or remove potential sandbox escape attack surface, but it&#x27;s like saying &quot;You might want to avoid win32k if you want to use features with a good security track record&quot; (and I know this is kind of apples to oranges but you get the point).</div><br/><div id="41634391" class="c"><input type="checkbox" id="c-41634391" checked=""/><div class="controls bullet"><span class="by">FridgeSeal</span><span>|</span><a href="#41633714">root</a><span>|</span><a href="#41634362">parent</a><span>|</span><a href="#41633922">next</a><span>|</span><label class="collapse" for="c-41634391">[-]</label><label class="expand" for="c-41634391">[1 more]</label></div><br/><div class="children"><div class="content">IIUC io_uring surfaced a bunch of pre-existing-but-rarely-hit code paths that had issues, which was widely taken to mean “io_uring has issues”. Google also disabled it on all machines in GCP, not clear if Google disabled it because of the same issues, or some other thing. The aforementioned issues have been fixed.</div><br/></div></div></div></div></div></div><div id="41633922" class="c"><input type="checkbox" id="c-41633922" checked=""/><div class="controls bullet"><span class="by">watt</span><span>|</span><a href="#41633714">prev</a><span>|</span><a href="#41633610">next</a><span>|</span><label class="collapse" for="c-41633922">[-]</label><label class="expand" for="c-41633922">[2 more]</label></div><br/><div class="children"><div class="content">io_uring also caused a ton of problems for our containers in Kubernetes when Node 20 had enabled it by default. They scrambled and turned it off by default in <a href="https:&#x2F;&#x2F;github.com&#x2F;nodejs&#x2F;node&#x2F;commit&#x2F;686da19abb">https:&#x2F;&#x2F;github.com&#x2F;nodejs&#x2F;node&#x2F;commit&#x2F;686da19abb</a></div><br/><div id="41634308" class="c"><input type="checkbox" id="c-41634308" checked=""/><div class="controls bullet"><span class="by">clhodapp</span><span>|</span><a href="#41633922">parent</a><span>|</span><a href="#41633610">next</a><span>|</span><label class="collapse" for="c-41634308">[-]</label><label class="expand" for="c-41634308">[1 more]</label></div><br/><div class="children"><div class="content">That sounds like a dubious integration contract for initialization between libuv and node, not an issue with io_uring.<p>I would assume the same thing would happen if they used traditional Posix APIs to open file handles before dropping their privileges.</div><br/></div></div></div></div><div id="41633610" class="c"><input type="checkbox" id="c-41633610" checked=""/><div class="controls bullet"><span class="by">v3gas</span><span>|</span><a href="#41633922">prev</a><span>|</span><label class="collapse" for="c-41633610">[-]</label><label class="expand" for="c-41633610">[4 more]</label></div><br/><div class="children"><div class="content">&gt; Oct 2, 2024<p>From the future!</div><br/><div id="41633644" class="c"><input type="checkbox" id="c-41633644" checked=""/><div class="controls bullet"><span class="by">Brajeshwar</span><span>|</span><a href="#41633610">parent</a><span>|</span><a href="#41633629">next</a><span>|</span><label class="collapse" for="c-41633644">[-]</label><label class="expand" for="c-41633644">[2 more]</label></div><br/><div class="children"><div class="content">Nice! I think he had a post marked for the future (the 32nd of September ), but his tool somehow published that;<p><pre><code>  https:&#x2F;&#x2F;github.com&#x2F;matklad&#x2F;matklad.github.io&#x2F;blob&#x2F;master&#x2F;content&#x2F;posts&#x2F;2024-09-32--what-is-io-uring.dj</code></pre></div><br/><div id="41633701" class="c"><input type="checkbox" id="c-41633701" checked=""/><div class="controls bullet"><span class="by">kzrdude</span><span>|</span><a href="#41633610">root</a><span>|</span><a href="#41633644">parent</a><span>|</span><a href="#41633629">next</a><span>|</span><label class="collapse" for="c-41633701">[-]</label><label class="expand" for="c-41633701">[1 more]</label></div><br/><div class="children"><div class="content">Published already on 32nd september, wonderful.</div><br/></div></div></div></div><div id="41633629" class="c"><input type="checkbox" id="c-41633629" checked=""/><div class="controls bullet"><span class="by">boarush</span><span>|</span><a href="#41633610">parent</a><span>|</span><a href="#41633644">prev</a><span>|</span><label class="collapse" for="c-41633629">[-]</label><label class="expand" for="c-41633629">[1 more]</label></div><br/><div class="children"><div class="content">I wonder if matklad has their scheduled blogs after penning them down?</div><br/></div></div></div></div></div></div></div></div></div></body></html>