<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1708678853457" as="style"/><link rel="stylesheet" href="styles.css?v=1708678853457"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.hanselman.com/blog/the-code-worked-differently-when-the-moon-was-full">The code worked differently when the moon was full (2021)</a> <span class="domain">(<a href="https://www.hanselman.com">www.hanselman.com</a>)</span></div><div class="subtext"><span>asicsp</span> | <span>18 comments</span></div><br/><div><div id="39477090" class="c"><input type="checkbox" id="c-39477090" checked=""/><div class="controls bullet"><span class="by">pacaro</span><span>|</span><a href="#39478026">next</a><span>|</span><label class="collapse" for="c-39477090">[-]</label><label class="expand" for="c-39477090">[4 more]</label></div><br/><div class="children"><div class="content">In the mid 90s I worked for a small ISV that wrote at GIS that ran on windows 3.1 (a 32 bit operating system that ran 16 bit processes (that could have 32 bit code segments))<p>One of our customer required perfect uptime, which was a problem with the GetTickCount wraparound described here<p>Our solution was to run under NuMega SoftICE [1] and once a month, or so, dispatch an engineer to the customer to simultaneously patch the kernel value for the tick count and also the expected value in our software (and also clean up various handle based cruft)<p>This worked for years. Unfortunately the engineer in question was also an alcoholic, so a particularly spectacular bender spoiled an approx 3 year uptime<p>[1] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;SoftICE" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;SoftICE</a></div><br/><div id="39477233" class="c"><input type="checkbox" id="c-39477233" checked=""/><div class="controls bullet"><span class="by">bruce511</span><span>|</span><a href="#39477090">parent</a><span>|</span><a href="#39478026">next</a><span>|</span><label class="collapse" for="c-39477233">[-]</label><label class="expand" for="c-39477233">[3 more]</label></div><br/><div class="children"><div class="content">&gt;&gt; One of our customer required perfect uptime<p>In all honesty, these are the kind of clients I politely point at someone else. They seldom have the resources to fund the requirement, and one absurd requirement leads to another.<p>I&#x27;m sure they had good reason, and good on you for pulling it off, but trying to keep Windows 3.1 up for multiple years sounds like a risky task to take on. Who knew there wasn&#x27;t another time-sensitive bug in there that kicked in at say 365 days?<p>To be fair the insane requirements I&#x27;ve come across are just delusional so they&#x27;re easy to walk away from.</div><br/><div id="39477499" class="c"><input type="checkbox" id="c-39477499" checked=""/><div class="controls bullet"><span class="by">ponderings</span><span>|</span><a href="#39477090">root</a><span>|</span><a href="#39477233">parent</a><span>|</span><a href="#39477939">next</a><span>|</span><label class="collapse" for="c-39477499">[-]</label><label class="expand" for="c-39477499">[1 more]</label></div><br/><div class="children"><div class="content">Twice I chat with someone who worked exclusively with customers no one else wants. One just grinds them down into a normal project, the other transparently charges what is reasonable for the unreasonable. $5000 for the first chat 24&#x2F;7, for that money he explains how it is normally done, what it costs and what it costs to meet the insane requirements. If they chose normality he doesn&#x27;t want the job.</div><br/></div></div><div id="39477939" class="c"><input type="checkbox" id="c-39477939" checked=""/><div class="controls bullet"><span class="by">pacaro</span><span>|</span><a href="#39477090">root</a><span>|</span><a href="#39477233">parent</a><span>|</span><a href="#39477499">prev</a><span>|</span><a href="#39478026">next</a><span>|</span><label class="collapse" for="c-39477939">[-]</label><label class="expand" for="c-39477939">[1 more]</label></div><br/><div class="children"><div class="content">We had a CEO who would sign up just about anyone as a customer. He nearly destroyed the company a few years before I joined by underbidding on a contract that they were completely unqualified to fulfill. Software failed and people died (a government inquiry was scathing about the company&#x27;s unsuitability for the contract but did ultimately exonerate them w.r.t. the fatalities). Lessons were not learned.</div><br/></div></div></div></div></div></div><div id="39478026" class="c"><input type="checkbox" id="c-39478026" checked=""/><div class="controls bullet"><span class="by">darekkay</span><span>|</span><a href="#39477090">prev</a><span>|</span><a href="#39477905">next</a><span>|</span><label class="collapse" for="c-39478026">[-]</label><label class="expand" for="c-39478026">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s a repo from danluu, collecting such debugging stories [1]. I&#x27;ve had my own peculiar bug: &quot;Script crashes before 10 a.m.&quot; [2]<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;danluu&#x2F;debugging-stories">https:&#x2F;&#x2F;github.com&#x2F;danluu&#x2F;debugging-stories</a><p>[2] <a href="https:&#x2F;&#x2F;darekkay.com&#x2F;blog&#x2F;script-crashes-before-10&#x2F;" rel="nofollow">https:&#x2F;&#x2F;darekkay.com&#x2F;blog&#x2F;script-crashes-before-10&#x2F;</a></div><br/></div></div><div id="39477905" class="c"><input type="checkbox" id="c-39477905" checked=""/><div class="controls bullet"><span class="by">omoikane</span><span>|</span><a href="#39478026">prev</a><span>|</span><a href="#39478240">next</a><span>|</span><label class="collapse" for="c-39477905">[-]</label><label class="expand" for="c-39477905">[1 more]</label></div><br/><div class="children"><div class="content">The bug depends on system clock, but it&#x27;s a bit of a stretch to say that it depends on moon phase.<p>Unless they were using that system to play NetHack:<p><a href="https:&#x2F;&#x2F;nethackwiki.com&#x2F;wiki&#x2F;Time#Moon_phase_and_date" rel="nofollow">https:&#x2F;&#x2F;nethackwiki.com&#x2F;wiki&#x2F;Time#Moon_phase_and_date</a></div><br/></div></div><div id="39478240" class="c"><input type="checkbox" id="c-39478240" checked=""/><div class="controls bullet"><span class="by">vishnuharidas</span><span>|</span><a href="#39477905">prev</a><span>|</span><a href="#39476336">next</a><span>|</span><label class="collapse" for="c-39478240">[-]</label><label class="expand" for="c-39478240">[1 more]</label></div><br/><div class="children"><div class="content">Another interesting debugging story - <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=32709045">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=32709045</a></div><br/></div></div><div id="39476336" class="c"><input type="checkbox" id="c-39476336" checked=""/><div class="controls bullet"><span class="by">Const-me</span><span>|</span><a href="#39478240">prev</a><span>|</span><a href="#39476944">next</a><span>|</span><label class="collapse" for="c-39476336">[-]</label><label class="expand" for="c-39476336">[2 more]</label></div><br/><div class="children"><div class="content">Interesting bug, but I don’t like the fix.<p>Most computers are 64 bits for decades now. It takes same resources to add&#x2F;subtract&#x2F;compare int64 compared to int32. No reason to use 32-bit integers for time, when I write C++ I use GetTickCount64() API introduced in Vista.<p>The C# equivalent is Environment.TickCount64, but there’s no need because unlike many other languages, C# standard library comes with a good support for dates, times, and time intervals. Instead of integers for elapsedInterval and requiredInterval variables, I prefer TimeSpan type. Safer, more readable, and potentially higher resolution because TimeSpan keeps int64 number of 100 nanoseconds ticks.</div><br/><div id="39477605" class="c"><input type="checkbox" id="c-39477605" checked=""/><div class="controls bullet"><span class="by">samplatt</span><span>|</span><a href="#39476336">parent</a><span>|</span><a href="#39476944">next</a><span>|</span><label class="collapse" for="c-39477605">[-]</label><label class="expand" for="c-39477605">[1 more]</label></div><br/><div class="children"><div class="content">&gt;Most computers are 64 bits for decades now.<p>Desktops and laptops and servers, sure. There&#x27;s an awful lot of 32bit processors in industrial controllers.</div><br/></div></div></div></div><div id="39476944" class="c"><input type="checkbox" id="c-39476944" checked=""/><div class="controls bullet"><span class="by">Miiko</span><span>|</span><a href="#39476336">prev</a><span>|</span><a href="#39477608">next</a><span>|</span><label class="collapse" for="c-39476944">[-]</label><label class="expand" for="c-39476944">[2 more]</label></div><br/><div class="children"><div class="content">I strongly believe that &quot;having the two fields get initialized to Environment.TickCount&quot; is the correct fix and using unsigned arithmetic is just a workaround. If you save the time of some event in some field, you either need to initialize that field with current time, or have special processing of &quot;value not set&quot; everywhere it is used, otherwise you&#x27;re almost guaranteed to have some hard to debug problem somewhere in the long run.</div><br/><div id="39477840" class="c"><input type="checkbox" id="c-39477840" checked=""/><div class="controls bullet"><span class="by">moi2388</span><span>|</span><a href="#39476944">parent</a><span>|</span><a href="#39477608">next</a><span>|</span><label class="collapse" for="c-39477840">[-]</label><label class="expand" for="c-39477840">[1 more]</label></div><br/><div class="children"><div class="content">I agree</div><br/></div></div></div></div><div id="39477608" class="c"><input type="checkbox" id="c-39477608" checked=""/><div class="controls bullet"><span class="by">riffraff</span><span>|</span><a href="#39476944">prev</a><span>|</span><a href="#39476070">next</a><span>|</span><label class="collapse" for="c-39477608">[-]</label><label class="expand" for="c-39477608">[1 more]</label></div><br/><div class="children"><div class="content">I thought this was a reference to the old &quot;phase of the moon&quot; bug entry in the Jargon file[0] and it was very confusing to see it marked 2021. Still, good bug!<p>0: <a href="http:&#x2F;&#x2F;www.catb.org&#x2F;jargon&#x2F;html&#x2F;P&#x2F;phase-of-the-moon.html" rel="nofollow">http:&#x2F;&#x2F;www.catb.org&#x2F;jargon&#x2F;html&#x2F;P&#x2F;phase-of-the-moon.html</a></div><br/></div></div><div id="39476070" class="c"><input type="checkbox" id="c-39476070" checked=""/><div class="controls bullet"><span class="by">mynegation</span><span>|</span><a href="#39477608">prev</a><span>|</span><a href="#39476216">next</a><span>|</span><label class="collapse" for="c-39476070">[-]</label><label class="expand" for="c-39476070">[2 more]</label></div><br/><div class="children"><div class="content">“int currentTimeMs” - whoa, I wish the compiler stop me there.</div><br/><div id="39476437" class="c"><input type="checkbox" id="c-39476437" checked=""/><div class="controls bullet"><span class="by">Dwedit</span><span>|</span><a href="#39476070">parent</a><span>|</span><a href="#39476216">next</a><span>|</span><label class="collapse" for="c-39476437">[-]</label><label class="expand" for="c-39476437">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, you pretty much need to treat a millisecond timestamp as an opaque value, only using the Int you get when you subtract two of them.  Doing that completely avoids the issues from timestamps being negative or wrapping around.<p>I&#x27;ve seen games that crash if your timestamps were negative.  So if your computer has been on for a while, and a game isn&#x27;t running properly, reboot.</div><br/></div></div></div></div><div id="39476216" class="c"><input type="checkbox" id="c-39476216" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#39476070">prev</a><span>|</span><a href="#39476023">next</a><span>|</span><label class="collapse" for="c-39476216">[-]</label><label class="expand" for="c-39476216">[1 more]</label></div><br/><div class="children"><div class="content"><i>currentTimeMs is Environment.TickCount, which in this case happens to be negative.</i><p>It&#x27;s worth noting that GetTickCount() is documented as returning an <i>unsigned</i> count, and unless you really need to time intervals &gt; ~49 days to millisecond accuracy, everything works as expected with modulo arithmetic.<p>Windows&#x27; AppVerifier has an option that causes GTC to rollover much sooner, specifically to test for such bugs.</div><br/></div></div><div id="39476023" class="c"><input type="checkbox" id="c-39476023" checked=""/><div class="controls bullet"><span class="by">bombcar</span><span>|</span><a href="#39476216">prev</a><span>|</span><a href="#39475595">next</a><span>|</span><label class="collapse" for="c-39476023">[-]</label><label class="expand" for="c-39476023">[1 more]</label></div><br/><div class="children"><div class="content">Someone somewhere had a QA list of things to check&#x2F;correlate, and one of them was - failure after 49 days.</div><br/></div></div><div id="39475595" class="c"><input type="checkbox" id="c-39475595" checked=""/><div class="controls bullet"><span class="by">sealeck</span><span>|</span><a href="#39476023">prev</a><span>|</span><label class="collapse" for="c-39475595">[-]</label><label class="expand" for="c-39475595">[1 more]</label></div><br/><div class="children"><div class="content">Cool case! Always really interesting to read about other people&#x27;s debugging cases and strategies. I can also 100% recommend <a href="https:&#x2F;&#x2F;www.whyprogramsfail.com&#x2F;" rel="nofollow">https:&#x2F;&#x2F;www.whyprogramsfail.com&#x2F;</a>, a book which looks at the theory behind writing correct software.</div><br/></div></div></div></div></div></div></div></body></html>