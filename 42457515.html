<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1734598860864" as="style"/><link rel="stylesheet" href="styles.css?v=1734598860864"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://greptime.com/blogs/2024-05-07-error-rust">Error Stacking in Rust</a> <span class="domain">(<a href="https://greptime.com">greptime.com</a>)</span></div><div class="subtext"><span>samanthasu</span> | <span>26 comments</span></div><br/><div><div id="42459642" class="c"><input type="checkbox" id="c-42459642" checked=""/><div class="controls bullet"><span class="by">exDM69</span><span>|</span><a href="#42459616">next</a><span>|</span><label class="collapse" for="c-42459642">[-]</label><label class="expand" for="c-42459642">[1 more]</label></div><br/><div class="children"><div class="content">Why does adding `backtrace` to thiserror&#x2F;anyhow require adding debug symbols?<p>You&#x27;ll certainly need it if you want to have human readable source code locations, but doesn&#x27;t it work with addresses only? Can&#x27;t you split off the debug symbols and then use `addr2line` to resolve source code locations when you get error messages from end users running release builds?</div><br/></div></div><div id="42459616" class="c"><input type="checkbox" id="c-42459616" checked=""/><div class="controls bullet"><span class="by">lilyball</span><span>|</span><a href="#42459642">prev</a><span>|</span><a href="#42458193">next</a><span>|</span><label class="collapse" for="c-42459616">[-]</label><label class="expand" for="c-42459616">[2 more]</label></div><br/><div class="children"><div class="content">&gt; <i>Then, to be able to translate the stack pointer we will need to include a large debuginfo in our binary. In GreptimeDB, this means increasing the binary size by &gt;700MB (4x compared to 170MB without debuginfo).</i><p>Surely that&#x27;s comparing full debuginfo, right? Backtraces just need symbols, not full debuginfo, and there&#x27;s no way the symbols are 4x the size of the binary.</div><br/><div id="42459655" class="c"><input type="checkbox" id="c-42459655" checked=""/><div class="controls bullet"><span class="by">dwattttt</span><span>|</span><a href="#42459616">parent</a><span>|</span><a href="#42458193">next</a><span>|</span><label class="collapse" for="c-42459655">[-]</label><label class="expand" for="c-42459655">[1 more]</label></div><br/><div class="children"><div class="content">There&#x27;s also split-debuginfo, which allows emission of debug info into a separate file, rather than needing to distribute it in the binary. Then they could capture stack traces, and resolve the symbols later if necessary. That would also address their concern about how long it takes to capture a stack trace, because just gathering the addresses themselves is quick.</div><br/></div></div></div></div><div id="42458193" class="c"><input type="checkbox" id="c-42458193" checked=""/><div class="controls bullet"><span class="by">namjh</span><span>|</span><a href="#42459616">prev</a><span>|</span><a href="#42459473">next</a><span>|</span><label class="collapse" for="c-42458193">[-]</label><label class="expand" for="c-42458193">[2 more]</label></div><br/><div class="children"><div class="content">&gt; Consequently, this also means you cannot define two error variants from the same source type. Considering you are performing some I&#x2F;O operations, you won&#x27;t know whether an error is generated in the write path or the read path. This is also an important reason we don&#x27;t use thiserror: the context is blurred in type.<p>This is true only if you add #[from] attribute to a variant. Implementing std::convert::From is completely optional. Personally I don&#x27;t prefer it too as it ambiguates the context. I only use it for &quot;trivially&quot; wrapped errors like eyre::Report.</div><br/><div id="42459269" class="c"><input type="checkbox" id="c-42459269" checked=""/><div class="controls bullet"><span class="by">skavi</span><span>|</span><a href="#42458193">parent</a><span>|</span><a href="#42459473">next</a><span>|</span><label class="collapse" for="c-42459269">[-]</label><label class="expand" for="c-42459269">[1 more]</label></div><br/><div class="children"><div class="content">Yup. I absolutely would throw `#[from]` on everything when I started using thiserror, but now only do so in incredibly obvious cases like<p><pre><code>  enum CarWontMove {
      EngineTroubles(EngineTroubles),
      WheelsFellOff(WheelsFellOff),
  }
</code></pre>
Even then, there’s often some additional context you can affix at that higher level.</div><br/></div></div></div></div><div id="42459473" class="c"><input type="checkbox" id="c-42459473" checked=""/><div class="controls bullet"><span class="by">joshka</span><span>|</span><a href="#42458193">prev</a><span>|</span><a href="#42458229">next</a><span>|</span><label class="collapse" for="c-42459473">[-]</label><label class="expand" for="c-42459473">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s technically feasible to add SpanTrace support to thiserror fairly easily (30 mins work - Issue: <a href="https:&#x2F;&#x2F;github.com&#x2F;dtolnay&#x2F;thiserror&#x2F;issues&#x2F;400">https:&#x2F;&#x2F;github.com&#x2F;dtolnay&#x2F;thiserror&#x2F;issues&#x2F;400</a>, PR: <a href="https:&#x2F;&#x2F;github.com&#x2F;dtolnay&#x2F;thiserror&#x2F;pull&#x2F;401">https:&#x2F;&#x2F;github.com&#x2F;dtolnay&#x2F;thiserror&#x2F;pull&#x2F;401</a>). This would solve part of the problem in a way that is meaningfully good for that side of the ecosystem. I suspect you could probably do something similar for Snafu</div><br/></div></div><div id="42458229" class="c"><input type="checkbox" id="c-42458229" checked=""/><div class="controls bullet"><span class="by">shepmaster</span><span>|</span><a href="#42459473">prev</a><span>|</span><a href="#42458422">next</a><span>|</span><label class="collapse" for="c-42458229">[-]</label><label class="expand" for="c-42458229">[1 more]</label></div><br/><div class="children"><div class="content">Hey all, I’m the author of SNAFU (mentioned in the article). I’m off to bed now, but I’d be happy to try and answer any questions people might have sometime tomorrow.<p>I’m glad to see SNAFU was useful to others!</div><br/></div></div><div id="42458422" class="c"><input type="checkbox" id="c-42458422" checked=""/><div class="controls bullet"><span class="by">Sytten</span><span>|</span><a href="#42458229">prev</a><span>|</span><a href="#42458055">next</a><span>|</span><label class="collapse" for="c-42458422">[-]</label><label class="expand" for="c-42458422">[3 more]</label></div><br/><div class="children"><div class="content">What is really annoying with thiserror is the wizard refusal to give us an easy way to print the error chain. No I dont want to convert it to anyhow just to print the error...</div><br/><div id="42458491" class="c"><input type="checkbox" id="c-42458491" checked=""/><div class="controls bullet"><span class="by">lumost</span><span>|</span><a href="#42458422">parent</a><span>|</span><a href="#42458055">next</a><span>|</span><label class="collapse" for="c-42458491">[-]</label><label class="expand" for="c-42458491">[2 more]</label></div><br/><div class="children"><div class="content">Rust is full of these, I’ve found the community simply falls back on user error to understand rust when vexed by in my opinion basic software operations.<p>As someone who works extensively in cpp&#x2F;java&#x2F;python. I want so much to love rust, but unfortunately I haven’t found it to be productive after 6+ side projects.</div><br/><div id="42458591" class="c"><input type="checkbox" id="c-42458591" checked=""/><div class="controls bullet"><span class="by">nixpulvis</span><span>|</span><a href="#42458422">root</a><span>|</span><a href="#42458491">parent</a><span>|</span><a href="#42458055">next</a><span>|</span><label class="collapse" for="c-42458591">[-]</label><label class="expand" for="c-42458591">[1 more]</label></div><br/><div class="children"><div class="content">Rust&#x27;s community is slightly more fragmented than it should be. The community being built while the language was changing so dramatically (e.g. async) didn&#x27;t help, but it also is part of what lead to Rust in the first place.<p>But it&#x27;s still somewhat young, lots of stuff is being built. So some of the lack of productivity probably just comes from not knowing the right stacks yet.</div><br/></div></div></div></div></div></div><div id="42458055" class="c"><input type="checkbox" id="c-42458055" checked=""/><div class="controls bullet"><span class="by">gfreezy</span><span>|</span><a href="#42458422">prev</a><span>|</span><a href="#42458823">next</a><span>|</span><label class="collapse" for="c-42458055">[-]</label><label class="expand" for="c-42458055">[1 more]</label></div><br/><div class="children"><div class="content"><p><pre><code>    async fn handle_request(req: Request) -&gt; Result&lt;Output&gt; {
        let msg = decode_msg(&amp;req.msg).context(DecodeMessage)?; &#x2F;&#x2F; propagate error with new stack and context
        verify_msg(&amp;msg)?; &#x2F;&#x2F; pass error to the caller directly
        process_msg(msg).await? &#x2F;&#x2F; pass error to the caller directly
    }

    async fn decode_msg(msg: &amp;RawMessage) -&gt; Result&lt;Message&gt; {
        serde_json::from_slice(&amp;msg).context(SerdeJson) &#x2F;&#x2F; propagate error with new stack and context
    }

</code></pre>
how to capture the virtual stack when `verify_msg` returns an error? Do you have some lint to make sure every error is attached with a context?</div><br/></div></div><div id="42458823" class="c"><input type="checkbox" id="c-42458823" checked=""/><div class="controls bullet"><span class="by">zote</span><span>|</span><a href="#42458055">prev</a><span>|</span><a href="#42457516">next</a><span>|</span><label class="collapse" for="c-42458823">[-]</label><label class="expand" for="c-42458823">[1 more]</label></div><br/><div class="children"><div class="content">URL changed, I think: <a href="https:&#x2F;&#x2F;greptime.com&#x2F;blogs&#x2F;2024-05-07-rust-error-handling" rel="nofollow">https:&#x2F;&#x2F;greptime.com&#x2F;blogs&#x2F;2024-05-07-rust-error-handling</a></div><br/></div></div><div id="42457516" class="c"><input type="checkbox" id="c-42457516" checked=""/><div class="controls bullet"><span class="by">samanthasu</span><span>|</span><a href="#42458823">prev</a><span>|</span><a href="#42458200">next</a><span>|</span><label class="collapse" for="c-42457516">[-]</label><label class="expand" for="c-42457516">[1 more]</label></div><br/><div class="children"><div class="content">A good error report is not only about how it gets constructed, but what is more important, to tell what human can understand from its cause and trace. 
In this example, we analyzed and showed how to design stacked errors and what should be considered in this process.</div><br/></div></div><div id="42458200" class="c"><input type="checkbox" id="c-42458200" checked=""/><div class="controls bullet"><span class="by">dgfitz</span><span>|</span><a href="#42457516">prev</a><span>|</span><label class="collapse" for="c-42458200">[-]</label><label class="expand" for="c-42458200">[12 more]</label></div><br/><div class="children"><div class="content">Rust is such a powerful yet completely disgusting language. I’m teaching myself rust out of spite at this point.<p>Everything about the syntax of the language is awful.</div><br/><div id="42458407" class="c"><input type="checkbox" id="c-42458407" checked=""/><div class="controls bullet"><span class="by">GrantMoyer</span><span>|</span><a href="#42458200">parent</a><span>|</span><a href="#42458249">next</a><span>|</span><label class="collapse" for="c-42458407">[-]</label><label class="expand" for="c-42458407">[8 more]</label></div><br/><div class="children"><div class="content">This seems to be a fairly common sentiment. I consider Rust&#x27;s syntax fairly consistent and elegant for a curly brace language, but evidently I have some blind spots. What quibbles do you have with Rust&#x27;s syntax?</div><br/><div id="42458421" class="c"><input type="checkbox" id="c-42458421" checked=""/><div class="controls bullet"><span class="by">akira2501</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42458407">parent</a><span>|</span><a href="#42458249">next</a><span>|</span><label class="collapse" for="c-42458421">[-]</label><label class="expand" for="c-42458421">[7 more]</label></div><br/><div class="children"><div class="content">The explosion of single character sigils and the taint of C++&#x27;s template syntax.</div><br/><div id="42459666" class="c"><input type="checkbox" id="c-42459666" checked=""/><div class="controls bullet"><span class="by">littlestymaar</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42458421">parent</a><span>|</span><a href="#42459130">next</a><span>|</span><label class="collapse" for="c-42459666">[-]</label><label class="expand" for="c-42459666">[1 more]</label></div><br/><div class="children"><div class="content">&gt; and the taint of C++&#x27;s template syntax.<p>Interestingly enough, nobody says that when talking about TypeScript…</div><br/></div></div><div id="42459130" class="c"><input type="checkbox" id="c-42459130" checked=""/><div class="controls bullet"><span class="by">maxk42</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42458421">parent</a><span>|</span><a href="#42459666">prev</a><span>|</span><a href="#42458505">next</a><span>|</span><label class="collapse" for="c-42459130">[-]</label><label class="expand" for="c-42459130">[4 more]</label></div><br/><div class="children"><div class="content">The only single-character sigils I can think of are &#x27;&amp;&#x27;, &#x27;*&#x27;, &#x27;\&#x27;&#x27;, and maybe &#x27;?&#x27;.  Am I missing any?</div><br/><div id="42459604" class="c"><input type="checkbox" id="c-42459604" checked=""/><div class="controls bullet"><span class="by">akira2501</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42459130">parent</a><span>|</span><a href="#42459198">next</a><span>|</span><label class="collapse" for="c-42459604">[-]</label><label class="expand" for="c-42459604">[1 more]</label></div><br/><div class="children"><div class="content">I kinda feel like macros!() should count.</div><br/></div></div><div id="42459198" class="c"><input type="checkbox" id="c-42459198" checked=""/><div class="controls bullet"><span class="by">recursivecaveat</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42459130">parent</a><span>|</span><a href="#42459604">prev</a><span>|</span><a href="#42459442">next</a><span>|</span><label class="collapse" for="c-42459198">[-]</label><label class="expand" for="c-42459198">[1 more]</label></div><br/><div class="children"><div class="content">The &#x27; for lifetimes as well.</div><br/></div></div><div id="42459442" class="c"><input type="checkbox" id="c-42459442" checked=""/><div class="controls bullet"><span class="by">troupo</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42459130">parent</a><span>|</span><a href="#42459198">prev</a><span>|</span><a href="#42458505">next</a><span>|</span><label class="collapse" for="c-42459442">[-]</label><label class="expand" for="c-42459442">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s probably the explosion of those characters and punctuation characters like in this example: <a href="https:&#x2F;&#x2F;x.com&#x2F;AndersonAndrue&#x2F;status&#x2F;1864457598629540348" rel="nofollow">https:&#x2F;&#x2F;x.com&#x2F;AndersonAndrue&#x2F;status&#x2F;1864457598629540348</a><p>To quote Tsoding, <a href="https:&#x2F;&#x2F;x.com&#x2F;tsoding&#x2F;status&#x2F;1832631084888080750" rel="nofollow">https:&#x2F;&#x2F;x.com&#x2F;tsoding&#x2F;status&#x2F;1832631084888080750</a>: &quot;Rust is a very safe, unergonomic language with annoying community and atrocious syntax. Which is somehow surprisingly miles better than modern C++.&quot;</div><br/></div></div></div></div><div id="42458505" class="c"><input type="checkbox" id="c-42458505" checked=""/><div class="controls bullet"><span class="by">Vecr</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42458421">parent</a><span>|</span><a href="#42459130">prev</a><span>|</span><a href="#42458249">next</a><span>|</span><label class="collapse" for="c-42458505">[-]</label><label class="expand" for="c-42458505">[1 more]</label></div><br/><div class="children"><div class="content">What&#x27;s mandated to be a single character? I&#x27;m not sure what the popular style is today.</div><br/></div></div></div></div></div></div><div id="42458249" class="c"><input type="checkbox" id="c-42458249" checked=""/><div class="controls bullet"><span class="by">jtrueb</span><span>|</span><a href="#42458200">parent</a><span>|</span><a href="#42458407">prev</a><span>|</span><a href="#42458246">next</a><span>|</span><label class="collapse" for="c-42458249">[-]</label><label class="expand" for="c-42458249">[1 more]</label></div><br/><div class="children"><div class="content">Which statically typed language do you find most agreeable?<p>Same question for any language.</div><br/></div></div><div id="42458246" class="c"><input type="checkbox" id="c-42458246" checked=""/><div class="controls bullet"><span class="by">speed_spread</span><span>|</span><a href="#42458200">parent</a><span>|</span><a href="#42458249">prev</a><span>|</span><label class="collapse" for="c-42458246">[-]</label><label class="expand" for="c-42458246">[2 more]</label></div><br/><div class="children"><div class="content">Rust&#x27;s syntax is largely irrelevant to its purpose. If you don&#x27;t see the need for it, might as well learn something else.</div><br/><div id="42458595" class="c"><input type="checkbox" id="c-42458595" checked=""/><div class="controls bullet"><span class="by">more-nitor</span><span>|</span><a href="#42458200">root</a><span>|</span><a href="#42458246">parent</a><span>|</span><label class="collapse" for="c-42458595">[-]</label><label class="expand" for="c-42458595">[1 more]</label></div><br/><div class="children"><div class="content">idk if its about a few syntax, then it&#x27;s possible to make a temp proc-macro for those</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>