<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1696150859561" as="style"/><link rel="stylesheet" href="styles.css?v=1696150859561"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://nullprogram.com/blog/2023/09/30/">An easy-to-implement, arena-friendly hash map</a> <span class="domain">(<a href="https://nullprogram.com">nullprogram.com</a>)</span></div><div class="subtext"><span>grep_it</span> | <span>3 comments</span></div><br/><div><div id="37721534" class="c"><input type="checkbox" id="c-37721534" checked=""/><div class="controls bullet"><span class="by">fovc</span><span>|</span><a href="#37723601">next</a><span>|</span><label class="collapse" for="c-37721534">[-]</label><label class="expand" for="c-37721534">[1 more]</label></div><br/><div class="children"><div class="content">IIRC, NRK started down this path because normal hash tables without free leak memory on every resize.<p>The original series of articles had me thinking about how to implement the normal hash table without leaking. I think it’s possible:<p>First consider a hash table using linear probing with a dedicated arena (restriction will be lifted later). That means memory can grow for free. However, resizing is still tricky because we need to rehash in place while ensuring we don’t “strand” any entries. This can be accomplished by iterating through the hash table entries in order, but starting at an empty entry and looping around. (Proof left as an exercise for the reader)<p>So now we have a hash table that can use realloc to grow. How to generalize for arenas? The key is that the HT will maintain a page map of sorts. The first page is of size M, the second is of size M, and thereafter they’ll be of size 2^n * M. Basically on each resize we double the total capacity by adding a new page. Since the pages are of variable width, though, how to map indexes to pages quickly? The key is to use ffs or ctz to get a rounded log2.</div><br/></div></div><div id="37723601" class="c"><input type="checkbox" id="c-37723601" checked=""/><div class="controls bullet"><span class="by">hnrj95</span><span>|</span><a href="#37721534">prev</a><span>|</span><label class="collapse" for="c-37723601">[-]</label><label class="expand" for="c-37723601">[1 more]</label></div><br/><div class="children"><div class="content">Great article, but slight issue. The iteration expression shifts left by 2, effectively limiting the height of the tree to 32. You probably want a rotation instead; otherwise you’ll be locked into child 0 from depth 32 down. I suppose with a good hash the manifestation would be rare.</div><br/></div></div></div></div></div></div></div></body></html>