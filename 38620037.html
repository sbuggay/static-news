<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1702458075824" as="style"/><link rel="stylesheet" href="styles.css?v=1702458075824"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://blog.llvm.org/posts/2023-12-07-tools-for-learning-llvm-tablegen/">Tools for Learning LLVM TableGen</a> <span class="domain">(<a href="https://blog.llvm.org">blog.llvm.org</a>)</span></div><div class="subtext"><span>matt_d</span> | <span>16 comments</span></div><br/><div><div id="38622198" class="c"><input type="checkbox" id="c-38622198" checked=""/><div class="controls bullet"><span class="by">CalChris</span><span>|</span><a href="#38621461">next</a><span>|</span><label class="collapse" for="c-38622198">[-]</label><label class="expand" for="c-38622198">[2 more]</label></div><br/><div class="children"><div class="content">TableGen factors out a lot of detail, out of the code and into a collection of tables of records which are then processed into .inc files by TableGen backends.<p>Emphasis on <i>factors out</i> as in even if the result is eye wateringly complex, it&#x27;s much better that that complexity is in another declarative file. This factoring also allows reuse by other tools like debuggers and linkers.<p>Emphasis on <i>a lot of detail</i> because 500,000 lines of instruction, register, scheduling, ... information is encoding a lot of detail. Processed, <i>--print-records</i> generates 87M bytes of text just for the X86 backend.<p>Take the simple BPF backend. It has 5 TableGen files:<p><pre><code>  BPF.td
  BPFInstrFormats.td
  BPFInstrInfo.td
  BPFRegisterInfo.td
  BPFCallingConv.td
</code></pre>
TableGen streams these files and processes the unloveable TableGen language over them producing a collection of records. The backend&#x27;s CMakeFile.txt tells TableGen to generate .inc include files. Each of these <i>-gen</i> flags invokes a TableGen backend to generate a specific include.<p><pre><code>  tablegen(LLVM BPFGenAsmMatcher.inc -gen-asm-matcher)
  tablegen(LLVM BPFGenAsmWriter.inc -gen-asm-writer)
  tablegen(LLVM BPFGenCallingConv.inc -gen-callingconv)
  tablegen(LLVM BPFGenDAGISel.inc -gen-dag-isel)
  tablegen(LLVM BPFGenDisassemblerTables.inc -gen-disassembler)
  tablegen(LLVM BPFGenInstrInfo.inc -gen-instr-info)
  tablegen(LLVM BPFGenMCCodeEmitter.inc -gen-emitter)
  tablegen(LLVM BPFGenRegisterInfo.inc -gen-register-info)
  tablegen(LLVM BPFGenSubtargetInfo.inc -gen-subtarget)
</code></pre>
So here&#x27;s the deal. Yeah, TableGen is ungainly but then the problem that it solves is truly massive. If you were to redo it now with what we know now, the architecture would be very similar and the language would be only slightly better. TableGen solves a really hard problem, maybe not perfectly but well.</div><br/><div id="38623071" class="c"><input type="checkbox" id="c-38623071" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#38622198">parent</a><span>|</span><a href="#38621461">next</a><span>|</span><label class="collapse" for="c-38623071">[-]</label><label class="expand" for="c-38623071">[1 more]</label></div><br/><div class="children"><div class="content">I wonder if that could have been achieved without an actual DSL. TableGen ultimately produces definitions for record types and a list of fully expanded records in those types, but those &quot;types&quot; don&#x27;t have to be actual types during the generation phase---you can instead have a generic associative array that gets validated when every record has been generated. A distinction between `class` and `multiclass` can be removed by using an ordinary function that can generate one or more records. So I feel that everything can be done without the DSL, except for a bit nicer syntax.</div><br/></div></div></div></div><div id="38621461" class="c"><input type="checkbox" id="c-38621461" checked=""/><div class="controls bullet"><span class="by">j2kun</span><span>|</span><a href="#38622198">prev</a><span>|</span><a href="#38621176">next</a><span>|</span><label class="collapse" for="c-38621461">[-]</label><label class="expand" for="c-38621461">[1 more]</label></div><br/><div class="children"><div class="content">I found TableGen frustrating when I first started working with MLIR, in part because I expected it to be a layer of abstraction, but it very much is not. It is (in MLIR) mainly convenience tool for autogenerating boilerplate code. Once I realized that and got used to looking at the generated code, it became much easier.</div><br/></div></div><div id="38621176" class="c"><input type="checkbox" id="c-38621176" checked=""/><div class="controls bullet"><span class="by">UncleOxidant</span><span>|</span><a href="#38621461">prev</a><span>|</span><a href="#38620388">next</a><span>|</span><label class="collapse" for="c-38621176">[-]</label><label class="expand" for="c-38621176">[2 more]</label></div><br/><div class="children"><div class="content">Kind of surprised to see an article about TableGen hit #1 on  HN. TableGen is pretty arcane. I had some dealings with it in about 2016 while creating a backend for compiler targeting a new processor architecture. It was very poorly documented then - mostly you looked at what other people had done with other architectures and tried to fit that into what was needed for your new architecture. Anyway, I guess I&#x27;d be surprised if even 1,000 people in the world needed to actually do much with TableGen.</div><br/><div id="38621239" class="c"><input type="checkbox" id="c-38621239" checked=""/><div class="controls bullet"><span class="by">matt_d</span><span>|</span><a href="#38621176">parent</a><span>|</span><a href="#38620388">next</a><span>|</span><label class="collapse" for="c-38621239">[-]</label><label class="expand" for="c-38621239">[1 more]</label></div><br/><div class="children"><div class="content">FWIW, its use has grown over time, with new applications most significantly including MLIR (Multi-Level IR compiler framework, which allows you to define your own intermediate representations as well as compiler passes operating on them), <a href="https:&#x2F;&#x2F;mlir.llvm.org&#x2F;docs&#x2F;DefiningDialects&#x2F;Operations&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;mlir.llvm.org&#x2F;docs&#x2F;DefiningDialects&#x2F;Operations&#x2F;</a><p>The docs have been improving, <a href="https:&#x2F;&#x2F;llvm.org&#x2F;docs&#x2F;TableGen&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;llvm.org&#x2F;docs&#x2F;TableGen&#x2F;</a><p>I also like these resources:<p>Lessons in TableGen
FOSDEM 2019; Nicolai Hähnle
<a href="https:&#x2F;&#x2F;fosdem.org&#x2F;2019&#x2F;schedule&#x2F;event&#x2F;llvm_tablegen&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;fosdem.org&#x2F;2019&#x2F;schedule&#x2F;event&#x2F;llvm_tablegen&#x2F;</a><p>- What has TableGen ever done for us?, <a href="http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-1-what-has-tablegen-ever-done.html" rel="nofollow noreferrer">http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-1-what-has-tab...</a>
- Functional Programming, <a href="http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-2-functional-programming.html" rel="nofollow noreferrer">http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-2-functional-p...</a>
- Bits, <a href="http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-3-bits.html" rel="nofollow noreferrer">http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;02&#x2F;tablegen-3-bits.html</a>
- Resolving variables, <a href="http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;03&#x2F;tablegen-4-resolving-variables.html" rel="nofollow noreferrer">http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;03&#x2F;tablegen-4-resolving-va...</a>
- DAGs, <a href="http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;03&#x2F;tablegen-5-dags.html" rel="nofollow noreferrer">http:&#x2F;&#x2F;nhaehnle.blogspot.com&#x2F;2018&#x2F;03&#x2F;tablegen-5-dags.html</a></div><br/></div></div></div></div><div id="38620388" class="c"><input type="checkbox" id="c-38620388" checked=""/><div class="controls bullet"><span class="by">fooker</span><span>|</span><a href="#38621176">prev</a><span>|</span><a href="#38621708">next</a><span>|</span><label class="collapse" for="c-38620388">[-]</label><label class="expand" for="c-38620388">[7 more]</label></div><br/><div class="children"><div class="content">TableGen has been the most annoying part of working with LLVM, it is unfortunate thy doubled down on it for MLIR.<p>If you want to generate code, define a better language and write a good compiler.<p>TableGen tries to be similar to C++, but is different enough that it is annoying.<p>And god help you if something goes wrong, error messages are straight up misleading.</div><br/><div id="38621668" class="c"><input type="checkbox" id="c-38621668" checked=""/><div class="controls bullet"><span class="by">jcranmer</span><span>|</span><a href="#38620388">parent</a><span>|</span><a href="#38621198">next</a><span>|</span><label class="collapse" for="c-38621668">[-]</label><label class="expand" for="c-38621668">[2 more]</label></div><br/><div class="children"><div class="content">TableGen isn&#x27;t trying to be similar to C++, it&#x27;s trying to be a language that makes it easy to specify highly redundant data tables.<p>Now, when you&#x27;re writing an LLVM backend, these tables are immediately consumed by another tool that tries to write a very complex state machine based on these tables, and the formats of the tables that said tool expects is essentially undocumented and confusing, and the error messages tend to range from confusing to, well, straight up misleading. But technically that&#x27;s not the fault of TableGen, that&#x27;s the fault of that TableGen-based tool.</div><br/><div id="38623687" class="c"><input type="checkbox" id="c-38623687" checked=""/><div class="controls bullet"><span class="by">fooker</span><span>|</span><a href="#38620388">root</a><span>|</span><a href="#38621668">parent</a><span>|</span><a href="#38621198">next</a><span>|</span><label class="collapse" for="c-38623687">[-]</label><label class="expand" for="c-38623687">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t doubt the &#x27;what&#x27;, clearly it&#x27;s needed.<p>My point was about the &#x27;how&#x27;. See the following example code from the manual and tell me it doesn&#x27;t resemble C++ if you squint.<p>class PersonName&lt;string name&gt; {  
  assert ...
  string Name = name;  
}<p>class Person&lt;string name, int age&gt; : PersonName&lt;name&gt; {  
  assert ...
  int Age = age;  
}<p>def Rec20 : Person&lt;&quot;Donald Knuth&quot;, 60&gt; {  
  ...
}</div><br/></div></div></div></div><div id="38621198" class="c"><input type="checkbox" id="c-38621198" checked=""/><div class="controls bullet"><span class="by">UncleOxidant</span><span>|</span><a href="#38620388">parent</a><span>|</span><a href="#38621668">prev</a><span>|</span><a href="#38621447">next</a><span>|</span><label class="collapse" for="c-38621198">[-]</label><label class="expand" for="c-38621198">[2 more]</label></div><br/><div class="children"><div class="content">&gt; TableGen tries to be similar to C++, but is different enough that it is annoying.<p>It seemed to me that TableGen was trying to be a pure functional language more like Haskell than C++.</div><br/><div id="38621351" class="c"><input type="checkbox" id="c-38621351" checked=""/><div class="controls bullet"><span class="by">fooker</span><span>|</span><a href="#38620388">root</a><span>|</span><a href="#38621198">parent</a><span>|</span><a href="#38621447">next</a><span>|</span><label class="collapse" for="c-38621351">[-]</label><label class="expand" for="c-38621351">[1 more]</label></div><br/><div class="children"><div class="content">trying is the keyword here!</div><br/></div></div></div></div><div id="38621447" class="c"><input type="checkbox" id="c-38621447" checked=""/><div class="controls bullet"><span class="by">j2kun</span><span>|</span><a href="#38620388">parent</a><span>|</span><a href="#38621198">prev</a><span>|</span><a href="#38621708">next</a><span>|</span><label class="collapse" for="c-38621447">[-]</label><label class="expand" for="c-38621447">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s not entirely doubled down on. There is work on IRDL, a domain-specific language for dialect definitions, and PDL, a language for pattern definitions. In theory, those could replace tablegen one day. I haven&#x27;t looked into either too deeply, though.</div><br/><div id="38623659" class="c"><input type="checkbox" id="c-38623659" checked=""/><div class="controls bullet"><span class="by">fooker</span><span>|</span><a href="#38620388">root</a><span>|</span><a href="#38621447">parent</a><span>|</span><a href="#38621708">next</a><span>|</span><label class="collapse" for="c-38623659">[-]</label><label class="expand" for="c-38623659">[1 more]</label></div><br/><div class="children"><div class="content">These are research projects you don&#x27;t want to touch for anything other than publishing papers until they are adopted by $BIGCO and has ~5 man years of engineering effort.</div><br/></div></div></div></div></div></div><div id="38621708" class="c"><input type="checkbox" id="c-38621708" checked=""/><div class="controls bullet"><span class="by">fearthetelomere</span><span>|</span><a href="#38620388">prev</a><span>|</span><a href="#38620629">next</a><span>|</span><label class="collapse" for="c-38621708">[-]</label><label class="expand" for="c-38621708">[2 more]</label></div><br/><div class="children"><div class="content">As I know nothing about TableGen, can someone explain when you would reach for this tool? Perhaps even links to simple examples?</div><br/><div id="38621853" class="c"><input type="checkbox" id="c-38621853" checked=""/><div class="controls bullet"><span class="by">UncleOxidant</span><span>|</span><a href="#38621708">parent</a><span>|</span><a href="#38620629">next</a><span>|</span><label class="collapse" for="c-38621853">[-]</label><label class="expand" for="c-38621853">[1 more]</label></div><br/><div class="children"><div class="content">Unless you&#x27;re making an LLVM&#x2F;MLIR compiler backend you&#x27;re not going to be reaching for this tool.</div><br/></div></div></div></div><div id="38620629" class="c"><input type="checkbox" id="c-38620629" checked=""/><div class="controls bullet"><span class="by">neverrroot</span><span>|</span><a href="#38621708">prev</a><span>|</span><label class="collapse" for="c-38620629">[-]</label><label class="expand" for="c-38620629">[1 more]</label></div><br/><div class="children"><div class="content">Good all-round post, I know TG is not easy, but it’s quite powerful and I’d rather use it instead of something else that lacks.</div><br/></div></div></div></div></div></div></div></body></html>