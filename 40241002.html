<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1714726863964" as="style"/><link rel="stylesheet" href="styles.css?v=1714726863964"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://sigma-star.at/blog/2024/02/exit0-code-injection/">Pseudo Graceful Process Termination Through Code Injection</a> <span class="domain">(<a href="https://sigma-star.at">sigma-star.at</a>)</span></div><div class="subtext"><span>Deeg9rie9usi</span> | <span>11 comments</span></div><br/><div><div id="40243765" class="c"><input type="checkbox" id="c-40243765" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#40241794">next</a><span>|</span><label class="collapse" for="c-40243765">[-]</label><label class="expand" for="c-40243765">[1 more]</label></div><br/><div class="children"><div class="content"><i>how can we build a tool to stop a process forcefully but make it look like a successful termination? As far as I know, Linux doesn’t provide an API to perform such a kill.</i><p>Interestingly, Windows does:<p><a href="https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;processthreadsapi&#x2F;nf-processthreadsapi-terminateprocess" rel="nofollow">https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;processt...</a></div><br/></div></div><div id="40241794" class="c"><input type="checkbox" id="c-40241794" checked=""/><div class="controls bullet"><span class="by">senkora</span><span>|</span><a href="#40243765">prev</a><span>|</span><a href="#40241819">next</a><span>|</span><label class="collapse" for="c-40241794">[-]</label><label class="expand" for="c-40241794">[5 more]</label></div><br/><div class="children"><div class="content">This is cute, but why not just do this with gdb? All-stop mode is on by default so it will stop all threads when you attach, and then you can simply invoke the exit_group() syscall.<p><pre><code>    tty1$ .&#x2F;program
    
    tty2$ gdb attach $(ps aux | grep program | head -1 | awk &#x27;{ print $2 }&#x27;)
    Attaching to process 708267
    [New LWP 708268]
    [New LWP 708269]
    [New LWP 708270]
    [New LWP 708271]
    [Thread debugging using libthread_db enabled]
    Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.
    0x00007f00b1633117 in ?? () from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6
    
    (gdb) p (long)syscall(231, 0)
    [Thread 0x7f00565e6640 (LWP 708271) exited]
    [Thread 0x7f005a5e8640 (LWP 708270) exited]
    [Thread 0x7f005ade9640 (LWP 708269) exited]
    [Thread 0x7f005d5ee640 (LWP 708268) exited]
    [Inferior 1 (process 708267) exited normally]
    The program being debugged exited while in a function called from GDB.
    Evaluation of the expression containing the function
    (syscall) will be abandoned.
    (gdb) quit
    
    tty1$ echo $?
    0</code></pre></div><br/><div id="40242174" class="c"><input type="checkbox" id="c-40242174" checked=""/><div class="controls bullet"><span class="by">moyix</span><span>|</span><a href="#40241794">parent</a><span>|</span><a href="#40241877">next</a><span>|</span><label class="collapse" for="c-40242174">[-]</label><label class="expand" for="c-40242174">[3 more]</label></div><br/><div class="children"><div class="content">syscall is only available if gdb is able to resolve libc. So for example this won’t work to stop a process running in a container, since gdb won’t be able to see the libc in the container’s filesystem. I did make my own variant using gdb, though, nicely explained here: <a href="https:&#x2F;&#x2F;thomasw.dev&#x2F;post&#x2F;killbutmakeitlooklikeanaccident&#x2F;" rel="nofollow">https:&#x2F;&#x2F;thomasw.dev&#x2F;post&#x2F;killbutmakeitlooklikeanaccident&#x2F;</a></div><br/><div id="40245155" class="c"><input type="checkbox" id="c-40245155" checked=""/><div class="controls bullet"><span class="by">gdgghhhhh</span><span>|</span><a href="#40241794">root</a><span>|</span><a href="#40242174">parent</a><span>|</span><a href="#40242270">next</a><span>|</span><label class="collapse" for="c-40245155">[-]</label><label class="expand" for="c-40245155">[1 more]</label></div><br/><div class="children"><div class="content">Since you are writing to the location where rip is pointing to, you need to rewind to the beginning of the page first. Otherwise the program will crash if you&#x27;re unlucky and rip is currently exactly at the end of an executable mapping. Low chance, but still...</div><br/></div></div><div id="40242270" class="c"><input type="checkbox" id="c-40242270" checked=""/><div class="controls bullet"><span class="by">senkora</span><span>|</span><a href="#40241794">root</a><span>|</span><a href="#40242174">parent</a><span>|</span><a href="#40245155">prev</a><span>|</span><a href="#40241877">next</a><span>|</span><label class="collapse" for="c-40242270">[-]</label><label class="expand" for="c-40242270">[1 more]</label></div><br/><div class="children"><div class="content">Nice! Even better.</div><br/></div></div></div></div><div id="40241877" class="c"><input type="checkbox" id="c-40241877" checked=""/><div class="controls bullet"><span class="by">dnuoftondnammoc</span><span>|</span><a href="#40241794">parent</a><span>|</span><a href="#40242174">prev</a><span>|</span><a href="#40241819">next</a><span>|</span><label class="collapse" for="c-40241877">[-]</label><label class="expand" for="c-40241877">[1 more]</label></div><br/><div class="children"><div class="content">I guess one goal of the experiment was understanding and learning how to do it by hand (in C) instead of relying on gdb.</div><br/></div></div></div></div><div id="40241819" class="c"><input type="checkbox" id="c-40241819" checked=""/><div class="controls bullet"><span class="by">albertzeyer</span><span>|</span><a href="#40241794">prev</a><span>|</span><a href="#40241763">next</a><span>|</span><label class="collapse" for="c-40241819">[-]</label><label class="expand" for="c-40241819">[3 more]</label></div><br/><div class="children"><div class="content">&gt; However, what if the need arises to forcefully terminate a process, disguising it as a successful exit? ... Since the parent process would detect the non-zero exit code, there was a high likelihood of making things worse.<p>I&#x27;m still trying to imagine what situation that is. I still cannot think about any real case where this is something you need.<p>If there is, I guess this is a very rare case? As it was already commented, I guess just gdb then?<p>But the technical details on how they do it are interesting nevertheless.</div><br/><div id="40242018" class="c"><input type="checkbox" id="c-40242018" checked=""/><div class="controls bullet"><span class="by">gdgghhhhh</span><span>|</span><a href="#40241819">parent</a><span>|</span><a href="#40241923">next</a><span>|</span><label class="collapse" for="c-40242018">[-]</label><label class="expand" for="c-40242018">[1 more]</label></div><br/><div class="children"><div class="content">One use case I have faced more than once are stuck processes in legacy build systems. For example, generating docs takes ages. Just killing the generator process will fail the build because the parent will notice. And since the build system is buggy&#x2F;old, restarting the build will start from zero.</div><br/></div></div></div></div><div id="40241763" class="c"><input type="checkbox" id="c-40241763" checked=""/><div class="controls bullet"><span class="by">remram</span><span>|</span><a href="#40241819">prev</a><span>|</span><label class="collapse" for="c-40241763">[-]</label><label class="expand" for="c-40241763">[1 more]</label></div><br/><div class="children"><div class="content">Using gdb is probably easier.</div><br/></div></div></div></div></div></div></div></body></html>