<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1698915667480" as="style"/><link rel="stylesheet" href="styles.css?v=1698915667480"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/Manawyrm/nvme-int13h-optionrom">Boot legacy PCs from NVMe storage</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>wmlive</span> | <span>21 comments</span></div><br/><div><div id="38105965" class="c"><input type="checkbox" id="c-38105965" checked=""/><div class="controls bullet"><span class="by">RulerOf</span><span>|</span><a href="#38105390">next</a><span>|</span><label class="collapse" for="c-38105965">[-]</label><label class="expand" for="c-38105965">[5 more]</label></div><br/><div class="children"><div class="content">This is a really interesting approach, as embedding into an option ROM means you could potentially flash it into a modded BIOS.<p>My preferred method to boot NVMe on a legacy system though is to boot tianocore UEFI with an NVME module in it[1]. This is a UEFI firmware that you can chainload from a legacy bios. Extremely good compatibility this way, and a great option for any system with an unused usb header.<p>1: <a href="https:&#x2F;&#x2F;winraid.level1techs.com&#x2F;t&#x2F;guide-nvme-boot-for-systems-with-legacy-bios-and-uefi-board-duet-refind&#x2F;32251" rel="nofollow noreferrer">https:&#x2F;&#x2F;winraid.level1techs.com&#x2F;t&#x2F;guide-nvme-boot-for-system...</a></div><br/><div id="38106211" class="c"><input type="checkbox" id="c-38106211" checked=""/><div class="controls bullet"><span class="by">undersuit</span><span>|</span><a href="#38105965">parent</a><span>|</span><a href="#38109963">next</a><span>|</span><label class="collapse" for="c-38106211">[-]</label><label class="expand" for="c-38106211">[3 more]</label></div><br/><div class="children"><div class="content">I knew that you could boot an &quot;EFI bios&quot; from experience with rEFIt from my time as a Mac Admin, so when I got my rEFInd USB drive working with a NVME drive on a pci-e adapter I was ecstatic until a month later when the USB drive failed and I forgot everything I had done.<p>Make backups of that USB drive or yeah it would be super cool if you could leverage the bios chip on a motherboard.</div><br/><div id="38106809" class="c"><input type="checkbox" id="c-38106809" checked=""/><div class="controls bullet"><span class="by">Tijdreiziger</span><span>|</span><a href="#38105965">root</a><span>|</span><a href="#38106211">parent</a><span>|</span><a href="#38109963">next</a><span>|</span><label class="collapse" for="c-38106809">[-]</label><label class="expand" for="c-38106809">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, I have one of the rare old laptops (HP ZBook G2) that has a PCIe M.2 slot for storage drives, but no support for NVMe booting.<p>This means that the only M.2 drives it’ll boot from are non-NVMe PCIe drives, which were actually made as an HP OEM part (Z Turbo Drive) for this specific model of laptop, but are otherwise nonexistent.<p>It would be really nice if I could somehow add NVMe support to the laptop’s UEFI, but AFAIK there are no existing solutions for this, other than chainloading from a second drive.<p>The subsequent model (ZBook G3) actually does support NVMe, but HP never backported that support to the G2&#x2F;G1 (of course, according to them, if you simply use the specified OEM parts there’s no problem…). Oh well, 2.5” SATA drives work just fine for such an old beast.</div><br/><div id="38107626" class="c"><input type="checkbox" id="c-38107626" checked=""/><div class="controls bullet"><span class="by">RulerOf</span><span>|</span><a href="#38105965">root</a><span>|</span><a href="#38106809">parent</a><span>|</span><a href="#38109963">next</a><span>|</span><label class="collapse" for="c-38107626">[-]</label><label class="expand" for="c-38107626">[1 more]</label></div><br/><div class="children"><div class="content">Definitely an interesting problem.<p>If you&#x27;re interested in going down the rabbit hole, some light googling suggests that HP uses an AMI BIOS. You might be able to mod it: <a href="https:&#x2F;&#x2F;winraid.level1techs.com&#x2F;t&#x2F;howto-get-full-nvme-support-for-all-systems-with-an-ami-uefi-bios&#x2F;30901" rel="nofollow noreferrer">https:&#x2F;&#x2F;winraid.level1techs.com&#x2F;t&#x2F;howto-get-full-nvme-suppor...</a></div><br/></div></div></div></div></div></div><div id="38109963" class="c"><input type="checkbox" id="c-38109963" checked=""/><div class="controls bullet"><span class="by">josteink</span><span>|</span><a href="#38105965">parent</a><span>|</span><a href="#38106211">prev</a><span>|</span><a href="#38105390">next</a><span>|</span><label class="collapse" for="c-38109963">[-]</label><label class="expand" for="c-38109963">[1 more]</label></div><br/><div class="children"><div class="content">&gt; My preferred method to boot NVMe on a legacy system though is to boot tianocore UEFI with an NVME module in it[1]. This is a UEFI firmware that you can chainload from a legacy bios.<p>If you already have UEFI, but no NVMe support all you need to do is boot into a UEFI shell-script (it’s a thing) which 1. loads a NVMe module (which you’ll need to provide, get it from tianocore), 2. does a device probe and 3. chain boots from the NVMe drive.<p>It’s not too much work to get going, barely a few megabytes and any old USB stick you have should make do without causing the USB stick to wear out because it won’t have to endure bootloader updates in the booted OS (which may happen if you put your whole &#x2F;boot on the USB drive).</div><br/></div></div></div></div><div id="38105390" class="c"><input type="checkbox" id="c-38105390" checked=""/><div class="controls bullet"><span class="by">icu</span><span>|</span><a href="#38105965">prev</a><span>|</span><a href="#38107011">next</a><span>|</span><label class="collapse" for="c-38105390">[-]</label><label class="expand" for="c-38105390">[6 more]</label></div><br/><div class="children"><div class="content">You can do this with Linux easily as long as your bios allows you to boot from USB.  Just put &#x2F;boot on the USB and everything else on the NVMe (via PCI Express to NVMe card).  This trick has allowed me to save several old PCs and use them as home servers and for my home lab.</div><br/><div id="38106742" class="c"><input type="checkbox" id="c-38106742" checked=""/><div class="controls bullet"><span class="by">Havoc</span><span>|</span><a href="#38105390">parent</a><span>|</span><a href="#38107011">next</a><span>|</span><label class="collapse" for="c-38106742">[-]</label><label class="expand" for="c-38106742">[5 more]</label></div><br/><div class="children"><div class="content">&gt; Just put &#x2F;boot on the USB and everything else on the NVMe<p>Hold up - that works? I’ve got a SBC device that has to boot off sd card but has ssd attached.<p>Any pointers as to where I could read up more on how to split a fs system like that? I can copy files easily enough but presumably needs so additional magic to link&#x2F;integrate it</div><br/><div id="38107139" class="c"><input type="checkbox" id="c-38107139" checked=""/><div class="controls bullet"><span class="by">jakogut</span><span>|</span><a href="#38105390">root</a><span>|</span><a href="#38106742">parent</a><span>|</span><a href="#38108553">next</a><span>|</span><label class="collapse" for="c-38107139">[-]</label><label class="expand" for="c-38107139">[1 more]</label></div><br/><div class="children"><div class="content">Believe it or not, you don&#x27;t even need a physical disk to boot at all (on many systems).<p>The first step in the boot process is loading the boot firmware. On a BIOS&#x2F;UEFI PC, this gives you Preboot Execution Environment (PXE) [0]. Raspberry Pi boards have something similar since the Pi 3, though it&#x27;s not exactly PXE. Network booting allows you to setup a DHCP server in a way that automatically serves the machine a kernel, initramfs, and cmdline over the network. You can run a full Linux that way, though you probably want to switch_root [1] to another filesystem that has a block device backing it with more storage, for practical purposes. This is what most initramfs images do.<p>Once the machine can automatically retrieve those three, you&#x27;re set. The initramfs can be built with whatever binaries, firmware, and kernel modules you need to initialize the network and set up an NBD or NFS share. Add `root=&#x2F;dev&#x2F;nbd0` or whatever, and you&#x27;re running over the network.<p>Same concept applies to booting with a split boot partition. The boot partition contains the kernel, initramfs, and bootloader, along with the boot configuration. The kernel cmdline specifies which disk contains the root filesystem. It need not be on the same disk as the kernel, or even on the same machine.<p>[0] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Preboot_Execution_Environment" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Preboot_Execution_Environment</a><p>[1] <a href="https:&#x2F;&#x2F;landley.net&#x2F;writing&#x2F;rootfs-programming.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;landley.net&#x2F;writing&#x2F;rootfs-programming.html</a></div><br/></div></div><div id="38108553" class="c"><input type="checkbox" id="c-38108553" checked=""/><div class="controls bullet"><span class="by">numpad0</span><span>|</span><a href="#38105390">root</a><span>|</span><a href="#38106742">parent</a><span>|</span><a href="#38107139">prev</a><span>|</span><a href="#38107582">next</a><span>|</span><label class="collapse" for="c-38108553">[-]</label><label class="expand" for="c-38108553">[1 more]</label></div><br/><div class="children"><div class="content">Possibly you may be get by installing normally on NVMe; `cp -R &#x2F;mnt&#x2F;nvme0p1&#x2F;boot &#x2F;mnt&#x2F;mmcblk0p1&#x2F;boot`; `sudo reboot`. There shall be requisite kernel modules and &#x2F;etc&#x2F;fstab inside initramfs to find `nvme0` and chroot into it.<p>It ultimately should not matter how Kernel + initramfs finds itself on RAM, or whether it was loaded from what it thinks it was loaded from. Kernel is just a baremetal program, and BIOS&#x2F;firmware is just the least elaborate tool to make Kernel appear on RAM.</div><br/></div></div><div id="38107582" class="c"><input type="checkbox" id="c-38107582" checked=""/><div class="controls bullet"><span class="by">michrassena</span><span>|</span><a href="#38105390">root</a><span>|</span><a href="#38106742">parent</a><span>|</span><a href="#38108553">prev</a><span>|</span><a href="#38107011">next</a><span>|</span><label class="collapse" for="c-38107582">[-]</label><label class="expand" for="c-38107582">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m doing something similar with the VisionFive 2, boot is on the SD card, the NVME does the rest.</div><br/><div id="38108093" class="c"><input type="checkbox" id="c-38108093" checked=""/><div class="controls bullet"><span class="by">snvzz</span><span>|</span><a href="#38105390">root</a><span>|</span><a href="#38107582">parent</a><span>|</span><a href="#38107011">next</a><span>|</span><label class="collapse" for="c-38108093">[-]</label><label class="expand" for="c-38108093">[1 more]</label></div><br/><div class="children"><div class="content">Note that current u-boot (latest official fw release, u-boot patches already upstreamed) can boot straight from NVME.</div><br/></div></div></div></div></div></div></div></div><div id="38107011" class="c"><input type="checkbox" id="c-38107011" checked=""/><div class="controls bullet"><span class="by">neilv</span><span>|</span><a href="#38105390">prev</a><span>|</span><a href="#38106410">next</a><span>|</span><label class="collapse" for="c-38107011">[-]</label><label class="expand" for="c-38107011">[1 more]</label></div><br/><div class="children"><div class="content">Their example of a ThinkPad T43 is an interesting choice, because it was a rare model that used a problematic SATA-PATA bridge kludge for storage.<p><a href="https:&#x2F;&#x2F;www.thinkwiki.org&#x2F;wiki&#x2F;Problem_with_non-ThinkPad_hard_disks" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.thinkwiki.org&#x2F;wiki&#x2F;Problem_with_non-ThinkPad_har...</a><p>It couldn&#x27;t even take a proper hard drive when new, 18 years ago, but now it can boot from NVMe.</div><br/></div></div><div id="38106410" class="c"><input type="checkbox" id="c-38106410" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#38107011">prev</a><span>|</span><a href="#38082939">next</a><span>|</span><label class="collapse" for="c-38106410">[-]</label><label class="expand" for="c-38106410">[2 more]</label></div><br/><div class="children"><div class="content">Looks like an interesting project, but upon seeing that screenshot and this...<p><i>It&#x27;s a heavily modified version of iPXE (which usually allows for booting from the network), but instead of the network, this code uses a port of the SeaBIOS NVMe implementation to talk to a local NVMe drive.</i><p>I can&#x27;t help but feel like that&#x27;s a very roundabout way of doing it (especially the fact that it seems to be manual?); after all, the BIOS Boot Specification exists and it&#x27;s what lets PCs boot from things like SCSI and other block devices.</div><br/><div id="38106701" class="c"><input type="checkbox" id="c-38106701" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#38106410">parent</a><span>|</span><a href="#38082939">next</a><span>|</span><label class="collapse" for="c-38106701">[-]</label><label class="expand" for="c-38106701">[1 more]</label></div><br/><div class="children"><div class="content">Assuming the NVMe manufacturers neglected to support the BIOS Boot Specification themselves, you&#x27;ve got to put some code into your option rom... And it may as well be a modified iPXE that has NVMe support? iPXE can be scripted it you want the whole process automated, but maybe that doesn&#x27;t make as nice of a demo?</div><br/></div></div></div></div><div id="38082939" class="c"><input type="checkbox" id="c-38082939" checked=""/><div class="controls bullet"><span class="by">wmlive</span><span>|</span><a href="#38106410">prev</a><span>|</span><a href="#38107065">next</a><span>|</span><label class="collapse" for="c-38082939">[-]</label><label class="expand" for="c-38082939">[1 more]</label></div><br/><div class="children"><div class="content">»This project allows old x86 computers using a classic BIOS to boot from modern NVMe storage attached via PCI(e). It&#x27;s a heavily modified version of iPXE (which usually allows for booting from the network), but instead of the network, this code uses a port of the SeaBIOS NVMe implementation to talk to a local NVMe drive.«</div><br/></div></div><div id="38107065" class="c"><input type="checkbox" id="c-38107065" checked=""/><div class="controls bullet"><span class="by">sheepscreek</span><span>|</span><a href="#38082939">prev</a><span>|</span><a href="#38105394">next</a><span>|</span><label class="collapse" for="c-38107065">[-]</label><label class="expand" for="c-38107065">[1 more]</label></div><br/><div class="children"><div class="content">Using network boot to inject a custom loader is ingenious! Was literally faced with this today. My AMD motherboard circa 2012 did not recognize the PCIe NVMe SSD. It was rather slow on this PC for some reason anyway (yes, I did my due diligence). Ended up putting it in a laptop which was thankfully able to muster a higher throughput.</div><br/></div></div><div id="38105394" class="c"><input type="checkbox" id="c-38105394" checked=""/><div class="controls bullet"><span class="by">dmw_ng</span><span>|</span><a href="#38107065">prev</a><span>|</span><a href="#38107850">next</a><span>|</span><label class="collapse" for="c-38105394">[-]</label><label class="expand" for="c-38105394">[3 more]</label></div><br/><div class="children"><div class="content">More interested in how the PCIe breakout board being used works.. is there some kind of bridge to a mini PCI slot?</div><br/><div id="38109450" class="c"><input type="checkbox" id="c-38109450" checked=""/><div class="controls bullet"><span class="by">snvzz</span><span>|</span><a href="#38105394">parent</a><span>|</span><a href="#38105791">next</a><span>|</span><label class="collapse" for="c-38109450">[-]</label><label class="expand" for="c-38109450">[1 more]</label></div><br/><div class="children"><div class="content">Explaining Computers covered them in a recent video[0].<p>0. <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=Ktqa11VT1xI">https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=Ktqa11VT1xI</a></div><br/></div></div><div id="38105791" class="c"><input type="checkbox" id="c-38105791" checked=""/><div class="controls bullet"><span class="by">rzzzt</span><span>|</span><a href="#38105394">parent</a><span>|</span><a href="#38109450">prev</a><span>|</span><a href="#38107850">next</a><span>|</span><label class="collapse" for="c-38105791">[-]</label><label class="expand" for="c-38105791">[1 more]</label></div><br/><div class="children"><div class="content">The &quot;classic&quot; ones have a small adapter inside the computer case (this can be ExpressCard, a mini PCIe or an M.2 plug). They&#x27;ll use either HDMI or USB 3 connectors and cabling as these can maintain reasonable signal integrity; this plugs in to the regular sized PCIe slot on the outside. There&#x27;s also a barrel jack and&#x2F;or a PCIe PSU connector on them for power.<p>I don&#x27;t think there&#x27;s any smartness hiding inside of these, the connector and number of conductors will limit you to a ×2 or ×4 connection anyways.</div><br/></div></div></div></div></div></div></div></div></div></body></html>