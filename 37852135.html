<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1697101265565" as="style"/><link rel="stylesheet" href="styles.css?v=1697101265565"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.tumfatig.net/2023/using-openbsd-relayd8-as-an-application-layer-gateway/">Using OpenBSD Relayd(8) as an Application Layer Gateway</a> <span class="domain">(<a href="https://www.tumfatig.net">www.tumfatig.net</a>)</span></div><div class="subtext"><span>zdw</span> | <span>12 comments</span></div><br/><div><div id="37852614" class="c"><input type="checkbox" id="c-37852614" checked=""/><div class="controls bullet"><span class="by">mbakke</span><span>|</span><a href="#37854132">next</a><span>|</span><label class="collapse" for="c-37852614">[-]</label><label class="expand" for="c-37852614">[2 more]</label></div><br/><div class="children"><div class="content">For those of us not currently at an OpenBSD console, the man pages can be browsed on-line here:<p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;man8&#x2F;relayd.8" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;man8&#x2F;relayd.8</a><p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;man8&#x2F;relayctl.8" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;man8&#x2F;relayctl.8</a><p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;man5&#x2F;relayd.conf.5" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;man5&#x2F;relayd.conf.5</a><p>Side note, I haven&#x27;t heard failover used in the context of kicking unhealthy backends before. Failover is typically something that would be implemented with carp(4) (aka VRRP, but with support for active&#x2F;active setups) on two different machines running relayd.<p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;man4&#x2F;carp.4" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;man4&#x2F;carp.4</a><p>Nothing beats the sheer elegance of OpenBSD for networking tasks. :-)</div><br/><div id="37854538" class="c"><input type="checkbox" id="c-37854538" checked=""/><div class="controls bullet"><span class="by">implements</span><span>|</span><a href="#37852614">parent</a><span>|</span><a href="#37854132">next</a><span>|</span><label class="collapse" for="c-37854538">[-]</label><label class="expand" for="c-37854538">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Side note, I haven&#x27;t heard failover used in the context of kicking unhealthy backends before …<p>In OpenBSD “Failover” also appears in “Trunking a Wireless Adapter”:<p><a href="https:&#x2F;&#x2F;www.openbsd.org&#x2F;faq&#x2F;faq6.html#Wireless" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.openbsd.org&#x2F;faq&#x2F;faq6.html#Wireless</a><p>“The trunk is set up in failover mode, so either interface can be used. If both are available, it will prefer the bge0 port, since that is the first one added to the trunk device.“</div><br/></div></div></div></div><div id="37854132" class="c"><input type="checkbox" id="c-37854132" checked=""/><div class="controls bullet"><span class="by">jsiepkes</span><span>|</span><a href="#37852614">prev</a><span>|</span><a href="#37854148">next</a><span>|</span><label class="collapse" for="c-37854132">[-]</label><label class="expand" for="c-37854132">[1 more]</label></div><br/><div class="children"><div class="content">Relayd is really great! Especially in combination with OpenBSD and CARP.<p>The original author of relayd also made a Rust prototype: <a href="https:&#x2F;&#x2F;github.com&#x2F;reyk&#x2F;relayd-rs">https:&#x2F;&#x2F;github.com&#x2F;reyk&#x2F;relayd-rs</a><p>One thing to note about relayd is that it only resolves names (DNS) at startup. Meaning if the name of a host changes you will need to reload relayd.</div><br/></div></div><div id="37854148" class="c"><input type="checkbox" id="c-37854148" checked=""/><div class="controls bullet"><span class="by">wejick</span><span>|</span><a href="#37854132">prev</a><span>|</span><a href="#37853819">next</a><span>|</span><label class="collapse" for="c-37854148">[-]</label><label class="expand" for="c-37854148">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m interested to understand whether it&#x27;s thread, process or singlethread event loop based. And maybe other architectural nuance that set relayd apart for example with nginx.</div><br/></div></div><div id="37853819" class="c"><input type="checkbox" id="c-37853819" checked=""/><div class="controls bullet"><span class="by">1vuio0pswjnm7</span><span>|</span><a href="#37854148">prev</a><span>|</span><a href="#37853146">next</a><span>|</span><label class="collapse" for="c-37853819">[-]</label><label class="expand" for="c-37853819">[1 more]</label></div><br/><div class="children"><div class="content">Control over deleting and adding HTTP headers is a nice feature.</div><br/></div></div><div id="37853146" class="c"><input type="checkbox" id="c-37853146" checked=""/><div class="controls bullet"><span class="by">ggm</span><span>|</span><a href="#37853819">prev</a><span>|</span><a href="#37853409">next</a><span>|</span><label class="collapse" for="c-37853146">[-]</label><label class="expand" for="c-37853146">[5 more]</label></div><br/><div class="children"><div class="content">Unless I am mistaken it&#x27;s &quot;credentialless&quot; forwarding. I couldn&#x27;t see any directive which would make the relay check user, its the IP routing mechanism to make something &quot;inside&quot; visible &quot;outside&quot; with loadshare, failover, test-before-connect, but not &quot;gate keep&quot;<p>an ssh -D  SOCKS5 tunnel requires you to present credentials on the jump host. This daemon bypasses that need. (happy to be corrected. I&#x27;d love to be wrong)</div><br/><div id="37854594" class="c"><input type="checkbox" id="c-37854594" checked=""/><div class="controls bullet"><span class="by">somat</span><span>|</span><a href="#37853146">parent</a><span>|</span><a href="#37853807">next</a><span>|</span><label class="collapse" for="c-37854594">[-]</label><label class="expand" for="c-37854594">[1 more]</label></div><br/><div class="children"><div class="content">I am not exactly sure what you want(Auth in the relayd process?) however you do mention ssh so I present you authpf.<p><a href="http:&#x2F;&#x2F;man.openbsd.org&#x2F;authpf" rel="nofollow noreferrer">http:&#x2F;&#x2F;man.openbsd.org&#x2F;authpf</a><p>Update: I think strictly speaking auth is outside the scope of relayd, but looking at the docs, I bet I could wire something together around having specific cookies or other headers.<p><pre><code>  match request type cookie &quot;ident&quot; value &quot;hashed password&quot;
</code></pre>
or<p><pre><code>  match request header &quot;Authorization&quot; value &quot;Basic dXNlcm5hbWU6dGhpcyBpcyBzZWNyZXQK&quot;
</code></pre>
The above will not work by the way, last time I used relayd I found it to be one of the few openbsd programs where I had a hard time thinking the same way as it&#x27;s author. That is, The syntax made my head hurt. I got it working but it was a chore. I think it is more that it ends up being a very complicated domain than poor syntax.</div><br/></div></div><div id="37853807" class="c"><input type="checkbox" id="c-37853807" checked=""/><div class="controls bullet"><span class="by">pseudostem</span><span>|</span><a href="#37853146">parent</a><span>|</span><a href="#37854594">prev</a><span>|</span><a href="#37853409">next</a><span>|</span><label class="collapse" for="c-37853807">[-]</label><label class="expand" for="c-37853807">[3 more]</label></div><br/><div class="children"><div class="content">Not sure about now, but at least a couple of years ago it didn&#x27;t support SNI either.<p>What I love about openBSD documentation is that if it&#x27;s not there in the docs, one can be sure that it doesn&#x27;t exist.</div><br/><div id="37854856" class="c"><input type="checkbox" id="c-37854856" checked=""/><div class="controls bullet"><span class="by">bxrt</span><span>|</span><a href="#37853146">root</a><span>|</span><a href="#37853807">parent</a><span>|</span><a href="#37853908">next</a><span>|</span><label class="collapse" for="c-37854856">[-]</label><label class="expand" for="c-37854856">[1 more]</label></div><br/><div class="children"><div class="content">SNI support was added with &quot;tls keypair&quot; option in OpenBSD 6.6: <a href="https:&#x2F;&#x2F;marc.info&#x2F;?l=openbsd-cvs&amp;m=155931636824866&amp;w=2" rel="nofollow noreferrer">https:&#x2F;&#x2F;marc.info&#x2F;?l=openbsd-cvs&amp;m=155931636824866&amp;w=2</a></div><br/></div></div><div id="37853908" class="c"><input type="checkbox" id="c-37853908" checked=""/><div class="controls bullet"><span class="by">ggm</span><span>|</span><a href="#37853146">root</a><span>|</span><a href="#37853807">parent</a><span>|</span><a href="#37854856">prev</a><span>|</span><a href="#37853409">next</a><span>|</span><label class="collapse" for="c-37853908">[-]</label><label class="expand" for="c-37853908">[1 more]</label></div><br/><div class="children"><div class="content">Yes, after &quot;its rock solid and they fix bugs, real bugs, especially security bugs FAST&quot; the docs are consistent. It&#x27;s amazing.</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>