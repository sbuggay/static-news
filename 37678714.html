<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1695891663104" as="style"/><link rel="stylesheet" href="styles.css?v=1695891663104"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://mwl.io/archives/23127">OpenBSD PF versus FreeBSD PF</a> <span class="domain">(<a href="https://mwl.io">mwl.io</a>)</span></div><div class="subtext"><span>zdw</span> | <span>61 comments</span></div><br/><div><div id="37679524" class="c"><input type="checkbox" id="c-37679524" checked=""/><div class="controls bullet"><span class="by">drewg123</span><span>|</span><a href="#37682742">next</a><span>|</span><label class="collapse" for="c-37679524">[-]</label><label class="expand" for="c-37679524">[24 more]</label></div><br/><div class="children"><div class="content">And if you&#x27;re using FreeBSD with a fast NIC, look into the pfilctl command and use a &quot;head&quot; input hook into your NIC driver&#x27;s  ethernet input handling routine. Doing this allows the firewall input checks to happen early, before the packet has been received into the network stack, while its still in DMA-mapped, driver-owned buffers.  If the firewall decides a packet is to be dropped, the NIC can recycle the buffer with minimal overhead (skips DMA-unmap, buffer free, ethernet input into the IP stack, and the replacement buffer alloc, DMA map).<p>This allows for <i>very</i> fast dropping of DOS flood attacks.  I&#x27;ve tested this using ipfw up to screening and dropping several 10s of millions of packets on 2014 era Xeons with minimal impact to traffic serving.   I wrote a paper about this for a conf. that was cancelled due to COVID.  I really need to re-submit it someplace.<p>This works for Mellanox, Chelsio, and NICs that use iflib (ix, ixl, igb, bnxt, and more that I&#x27;m forgetting).</div><br/><div id="37680116" class="c"><input type="checkbox" id="c-37680116" checked=""/><div class="controls bullet"><span class="by">brynet</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37679831">next</a><span>|</span><label class="collapse" for="c-37680116">[-]</label><label class="expand" for="c-37680116">[3 more]</label></div><br/><div class="children"><div class="content">&gt; This allows for very fast dropping of DOS flood attacks.<p>OpenBSD has something very close to that w&#x2F; bpf(4) BIOCGFILDROP filter &quot;drop&quot;.<p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;bpf#BIOCGFILDROP" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;bpf#BIOCGFILDROP</a><p><a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;tcpdump#B" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;tcpdump#B</a><p><a href="https:&#x2F;&#x2F;marc.info&#x2F;?l=openbsd-tech&amp;m=155228135415650&amp;w=2" rel="nofollow noreferrer">https:&#x2F;&#x2F;marc.info&#x2F;?l=openbsd-tech&amp;m=155228135415650&amp;w=2</a></div><br/><div id="37681694" class="c"><input type="checkbox" id="c-37681694" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680116">parent</a><span>|</span><a href="#37680446">next</a><span>|</span><label class="collapse" for="c-37681694">[-]</label><label class="expand" for="c-37681694">[1 more]</label></div><br/><div class="children"><div class="content">I think that&#x27;s pretty different. It&#x27;s less processing, but still copies packet off nic.</div><br/></div></div></div></div><div id="37679831" class="c"><input type="checkbox" id="c-37679831" checked=""/><div class="controls bullet"><span class="by">digitalsushi</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37680116">prev</a><span>|</span><a href="#37679912">next</a><span>|</span><label class="collapse" for="c-37679831">[-]</label><label class="expand" for="c-37679831">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m picturing that scene a few episodes into the soul art anime - I barely remember it but the main character was so overpowered, he was standing there absorbing a full barrage from a much lower ranked opponent flooding him with punches and kicks; the main character&#x27;s health regenerated so quickly that the attack didn&#x27;t have effects.<p>In 2014 I was working on a hardware appliance for a company that has something to do with packet capture, and I found an intel driver that implemented a ring buffer on a 1 gigabit Ethernet adapter that allowed me to capture line rate without dropping a single packet over the course of hours; prior to this the adapter was barely able to capture 90% of the packets. I remember marveling at the design that must have gone into it, and here too to your description of this performance improvement.<p>I miss that stuff. Thanks for sharing,</div><br/></div></div><div id="37679912" class="c"><input type="checkbox" id="c-37679912" checked=""/><div class="controls bullet"><span class="by">bravetraveler</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37679831">prev</a><span>|</span><a href="#37679870">next</a><span>|</span><label class="collapse" for="c-37679912">[-]</label><label class="expand" for="c-37679912">[16 more]</label></div><br/><div class="children"><div class="content">This is awesome to see [as a mostly-Linux person] - people have managed to impress the sentiment on me that the BSDs are well-suited for networking.<p>I never quite &#x27;got it&#x27; - this helps. Are you aware of similar tweaks in Linux land, by chance?<p>I consider myself reasonably well-experienced as a systems administrator... but can&#x27;t quite recall stumbling across anything quite like this.</div><br/><div id="37680257" class="c"><input type="checkbox" id="c-37680257" checked=""/><div class="controls bullet"><span class="by">ADSSDA</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37679912">parent</a><span>|</span><a href="#37680002">next</a><span>|</span><label class="collapse" for="c-37680257">[-]</label><label class="expand" for="c-37680257">[13 more]</label></div><br/><div class="children"><div class="content">IMO Linux is significantly better than the *BSDs at this particular use case.<p>Check out <a href="https:&#x2F;&#x2F;blog.cloudflare.com&#x2F;l4drop-xdp-ebpf-based-ddos-mitigations&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;blog.cloudflare.com&#x2F;l4drop-xdp-ebpf-based-ddos-mitig...</a><p>and:<p><a href="https:&#x2F;&#x2F;github.com&#x2F;xdp-project&#x2F;xdp-tools">https:&#x2F;&#x2F;github.com&#x2F;xdp-project&#x2F;xdp-tools</a></div><br/><div id="37680305" class="c"><input type="checkbox" id="c-37680305" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680257">parent</a><span>|</span><a href="#37680945">next</a><span>|</span><label class="collapse" for="c-37680305">[-]</label><label class="expand" for="c-37680305">[8 more]</label></div><br/><div class="children"><div class="content">But don’t have to cobble together a bunch of arcane iptables commands and then combine bpf and other userland tools … when one can just use the clean syntax of PF especially for home use that’s a clear win.</div><br/><div id="37680390" class="c"><input type="checkbox" id="c-37680390" checked=""/><div class="controls bullet"><span class="by">ADSSDA</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680305">parent</a><span>|</span><a href="#37681075">next</a><span>|</span><label class="collapse" for="c-37680390">[-]</label><label class="expand" for="c-37680390">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve used both extensively and I find eBPF+iptables (and sometimes nft) significantly more flexible and easier to use in the real world (not just simple examples) than PF. <i>shrug</i></div><br/><div id="37682047" class="c"><input type="checkbox" id="c-37682047" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680390">parent</a><span>|</span><a href="#37681075">next</a><span>|</span><label class="collapse" for="c-37682047">[-]</label><label class="expand" for="c-37682047">[1 more]</label></div><br/><div class="children"><div class="content">Do you have a sample or blogpost of how your setup looks? I’m keen to see how folks are using eBPF in the personal firewall space</div><br/></div></div></div></div><div id="37681075" class="c"><input type="checkbox" id="c-37681075" checked=""/><div class="controls bullet"><span class="by">throw0101a</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680305">parent</a><span>|</span><a href="#37680390">prev</a><span>|</span><a href="#37681244">next</a><span>|</span><label class="collapse" for="c-37681075">[-]</label><label class="expand" for="c-37681075">[2 more]</label></div><br/><div class="children"><div class="content">&gt; <i>But don’t have to cobble together a bunch of arcane iptables commands</i><p>If you did manage to figure out the <i>iptables</i> commands you now have to change them over to <i>nftables</i>. :)</div><br/><div id="37681916" class="c"><input type="checkbox" id="c-37681916" checked=""/><div class="controls bullet"><span class="by">carlhjerpe</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37681075">parent</a><span>|</span><a href="#37681244">next</a><span>|</span><label class="collapse" for="c-37681916">[-]</label><label class="expand" for="c-37681916">[1 more]</label></div><br/><div class="children"><div class="content">No, iptables is a perfectly functional nftables frontend</div><br/></div></div></div></div><div id="37681244" class="c"><input type="checkbox" id="c-37681244" checked=""/><div class="controls bullet"><span class="by">systems_glitch</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680305">parent</a><span>|</span><a href="#37681075">prev</a><span>|</span><a href="#37680945">next</a><span>|</span><label class="collapse" for="c-37681244">[-]</label><label class="expand" for="c-37681244">[3 more]</label></div><br/><div class="children"><div class="content">Not having to manage two rulesets -- one for IPv4 and one for IPv6 -- is pretty well a killer feature in my mind.</div><br/><div id="37681549" class="c"><input type="checkbox" id="c-37681549" checked=""/><div class="controls bullet"><span class="by">nolist_policy</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37681244">parent</a><span>|</span><a href="#37680945">next</a><span>|</span><label class="collapse" for="c-37681549">[-]</label><label class="expand" for="c-37681549">[2 more]</label></div><br/><div class="children"><div class="content">nftables is now almost 10 years old! It&#x27;s time to forget the bad experiences with iptables.</div><br/><div id="37684328" class="c"><input type="checkbox" id="c-37684328" checked=""/><div class="controls bullet"><span class="by">systems_glitch</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37681549">parent</a><span>|</span><a href="#37680945">next</a><span>|</span><label class="collapse" for="c-37684328">[-]</label><label class="expand" for="c-37684328">[1 more]</label></div><br/><div class="children"><div class="content">I have -- I let the OpenBSD firewalls take care of it :P<p>Seriously though it&#x27;s something I need to get familiar with, I do still have plenty of Linux boxes that face the public Internet and are currently dependent on iptables&#x2F;ip6tables rulesets. The problem is I&#x27;m currently masking that pain with Ansible.</div><br/></div></div></div></div></div></div></div></div><div id="37680945" class="c"><input type="checkbox" id="c-37680945" checked=""/><div class="controls bullet"><span class="by">diogenes4</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680257">parent</a><span>|</span><a href="#37680305">prev</a><span>|</span><a href="#37680002">next</a><span>|</span><label class="collapse" for="c-37680945">[-]</label><label class="expand" for="c-37680945">[4 more]</label></div><br/><div class="children"><div class="content">Linux certainly offers much better functionality overall but the tooling for this is a poorly documented and inconsistent nightmare.</div><br/><div id="37681308" class="c"><input type="checkbox" id="c-37681308" checked=""/><div class="controls bullet"><span class="by">ilyt</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680945">parent</a><span>|</span><a href="#37681328">next</a><span>|</span><label class="collapse" for="c-37681308">[-]</label><label class="expand" for="c-37681308">[2 more]</label></div><br/><div class="children"><div class="content">There is definite lack of a declarative tool that glues it all.<p>Typical hardware switches and routers just have one (sometimes expanded by includes&#x2F;macros but still) config syntax to control every part of networking stack.<p>So you can configure interface and set its vlans all in one place instead of creating a dozen of ethX.Y devices then crerating a bunch of brY bridges and then attaching the interfaces to them<p>In linux instead you&#x27;d be using iproute2 set of tools to configure interfaces and static routing, iptables for IP ACLs, ebtables for ethernet ACLs (or now nftables I guess), without any tool to apply&#x2F;revert  changes at once<p>Many tried doing that but IMO haven&#x27;t seen anything good.<p>Many also try to &quot;simplify&quot; iptables and all it ends up is me being annoyed coz I know which iptables commands I need to run but I need to translate it back into &quot;higher&quot; level config syntax. One exception being ferm ( <a href="http:&#x2F;&#x2F;ferm.foo-projects.org&#x2F;" rel="nofollow noreferrer">http:&#x2F;&#x2F;ferm.foo-projects.org&#x2F;</a> ), because it keeps iptables-like keywords just expands on that, but it is iptables only and kinda superseded by nftables syntax anyway.</div><br/><div id="37682180" class="c"><input type="checkbox" id="c-37682180" checked=""/><div class="controls bullet"><span class="by">epcoa</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37681308">parent</a><span>|</span><a href="#37681328">next</a><span>|</span><label class="collapse" for="c-37682180">[-]</label><label class="expand" for="c-37682180">[1 more]</label></div><br/><div class="children"><div class="content">iptables&#x2F;ebtables is deprecated even in RHEL. While people are free to continue not to transition to nftables complaining about problems with iptables after a decade of its replacement is a bit silly.</div><br/></div></div></div></div><div id="37681328" class="c"><input type="checkbox" id="c-37681328" checked=""/><div class="controls bullet"><span class="by">chasil</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680945">parent</a><span>|</span><a href="#37681308">prev</a><span>|</span><a href="#37680002">next</a><span>|</span><label class="collapse" for="c-37681328">[-]</label><label class="expand" for="c-37681328">[1 more]</label></div><br/><div class="children"><div class="content">I would trade firewalld for pf in an instant.</div><br/></div></div></div></div></div></div><div id="37680002" class="c"><input type="checkbox" id="c-37680002" checked=""/><div class="controls bullet"><span class="by">epcoa</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37679912">parent</a><span>|</span><a href="#37680257">prev</a><span>|</span><a href="#37679870">next</a><span>|</span><label class="collapse" for="c-37680002">[-]</label><label class="expand" for="c-37680002">[2 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Express_Data_Path" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Express_Data_Path</a></div><br/><div id="37680311" class="c"><input type="checkbox" id="c-37680311" checked=""/><div class="controls bullet"><span class="by">bravetraveler</span><span>|</span><a href="#37679524">root</a><span>|</span><a href="#37680002">parent</a><span>|</span><a href="#37679870">next</a><span>|</span><label class="collapse" for="c-37680311">[-]</label><label class="expand" for="c-37680311">[1 more]</label></div><br/><div class="children"><div class="content">Thank you, I&#x27;ve heard of {e,}BPF but not so much applications - thank you again!<p>Makes sense why I haven&#x27;t seen it, came out around the time I joined $CurrentEmployer, and we&#x27;re stuck a couple decades behind.</div><br/></div></div></div></div></div></div><div id="37679870" class="c"><input type="checkbox" id="c-37679870" checked=""/><div class="controls bullet"><span class="by">jpk</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37679912">prev</a><span>|</span><a href="#37682034">next</a><span>|</span><label class="collapse" for="c-37679870">[-]</label><label class="expand" for="c-37679870">[1 more]</label></div><br/><div class="children"><div class="content">Would love to watch that talk (so please re-submit it somewhere!), but in lieu of that, is the paper available anywhere?</div><br/></div></div><div id="37682034" class="c"><input type="checkbox" id="c-37682034" checked=""/><div class="controls bullet"><span class="by">datadeft</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37679870">prev</a><span>|</span><a href="#37680276">next</a><span>|</span><label class="collapse" for="c-37682034">[-]</label><label class="expand" for="c-37682034">[1 more]</label></div><br/><div class="children"><div class="content">This sounds nice for a specific case when you are not dealing with bandwidth based DOS.</div><br/></div></div><div id="37680276" class="c"><input type="checkbox" id="c-37680276" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#37679524">parent</a><span>|</span><a href="#37682034">prev</a><span>|</span><a href="#37682742">next</a><span>|</span><label class="collapse" for="c-37680276">[-]</label><label class="expand" for="c-37680276">[1 more]</label></div><br/><div class="children"><div class="content">I had no idea! This is really cool. Have you by chance a blog about it?</div><br/></div></div></div></div><div id="37682742" class="c"><input type="checkbox" id="c-37682742" checked=""/><div class="controls bullet"><span class="by">manifoldgeo</span><span>|</span><a href="#37679524">prev</a><span>|</span><a href="#37682374">next</a><span>|</span><label class="collapse" for="c-37682742">[-]</label><label class="expand" for="c-37682742">[1 more]</label></div><br/><div class="children"><div class="content">Michael W. Lucas is such a good author, and I just wanted to give a shout-out: &quot;TLS Mastery&quot; opened my eyes to the world of TLS &#x2F; SSL certs in an understandable way that used interactive examples on Linux.</div><br/></div></div><div id="37682374" class="c"><input type="checkbox" id="c-37682374" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#37682742">prev</a><span>|</span><a href="#37679545">next</a><span>|</span><label class="collapse" for="c-37682374">[-]</label><label class="expand" for="c-37682374">[1 more]</label></div><br/><div class="children"><div class="content">For a bit of context regarding some of the &quot;unfixed&quot; issues in FreeBSD, some of it comes down to different security contexts. In openbsd, pf is pretty much root only, and root -&gt; kernel escalation isn&#x27;t a big deal. There&#x27;s a bug, it gets fixed, but no hoopla. Easy to miss if you&#x27;re not paying close attention. Maybe fixed incidentally as part of a refactor.<p>But FreeBSD also has jails&#x2F;vnet, which makes root -&gt; kernel escalation a lot more spicy. Eventually the bug gets found, some years later, although not really the result of negligence.</div><br/></div></div><div id="37679545" class="c"><input type="checkbox" id="c-37679545" checked=""/><div class="controls bullet"><span class="by">wkat4242</span><span>|</span><a href="#37682374">prev</a><span>|</span><a href="#37679044">next</a><span>|</span><label class="collapse" for="c-37679545">[-]</label><label class="expand" for="c-37679545">[10 more]</label></div><br/><div class="children"><div class="content">And then there&#x27;s macOS pf too. Also different again!</div><br/><div id="37679950" class="c"><input type="checkbox" id="c-37679950" checked=""/><div class="controls bullet"><span class="by">cyberpunk</span><span>|</span><a href="#37679545">parent</a><span>|</span><a href="#37681334">next</a><span>|</span><label class="collapse" for="c-37679950">[-]</label><label class="expand" for="c-37679950">[8 more]</label></div><br/><div class="children"><div class="content">I&#x27;m sure i read on a comment here recently that the latest macos is using a recent openbsd pf? As quite a heavy user of freebsd pf, I wonder if anyone knows more details on that?</div><br/><div id="37681537" class="c"><input type="checkbox" id="c-37681537" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37679950">parent</a><span>|</span><a href="#37680137">next</a><span>|</span><label class="collapse" for="c-37681537">[-]</label><label class="expand" for="c-37681537">[1 more]</label></div><br/><div class="children"><div class="content">I haven&#x27;t looked in a while, but an update would be nice. When I was looking at it in the last couple years, many things in the networking stack were unchanged since the late 90s&#x2F;early 2000s, so macos didn&#x27;t have syn flood protection built in, and while the macos pf had synflood stuff, it only works if the macos host is strictly a firewall, using the syn protection for traffic where macos is an endpoint results in no connectivity.<p>If they pulled in a more recent pf from either OpenBSD or more current FreeBSD would be welcome. (And you know, a recent tcp stack would be nice too; although they&#x27;ve added in things like MPTCP that they&#x27;d need to port forward by 20+ years)</div><br/></div></div><div id="37680137" class="c"><input type="checkbox" id="c-37680137" checked=""/><div class="controls bullet"><span class="by">nvy</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37679950">parent</a><span>|</span><a href="#37681537">prev</a><span>|</span><a href="#37681334">next</a><span>|</span><label class="collapse" for="c-37680137">[-]</label><label class="expand" for="c-37680137">[6 more]</label></div><br/><div class="children"><div class="content">On my mbp, the man page for `pfctl` contains the following:<p>&gt;HISTORY<p>&gt;     The pfctl program and the packet filter mechanism first appeared in OpenBSD 3.0.</div><br/><div id="37680243" class="c"><input type="checkbox" id="c-37680243" checked=""/><div class="controls bullet"><span class="by">yakubin</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37680137">parent</a><span>|</span><a href="#37681334">next</a><span>|</span><label class="collapse" for="c-37680243">[-]</label><label class="expand" for="c-37680243">[5 more]</label></div><br/><div class="children"><div class="content">The same is in the current manpage on OpenBSD: &lt;<a href="https:&#x2F;&#x2F;man.openbsd.org&#x2F;pfctl" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.openbsd.org&#x2F;pfctl</a>&gt;. The next line is more telling though:<p>&gt; July 1, 2007<p>Although I&#x27;m running Monterey, so maybe it&#x27;s updated in more recent versions of MacOS.</div><br/><div id="37680553" class="c"><input type="checkbox" id="c-37680553" checked=""/><div class="controls bullet"><span class="by">nvy</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37680243">parent</a><span>|</span><a href="#37681334">next</a><span>|</span><label class="collapse" for="c-37680553">[-]</label><label class="expand" for="c-37680553">[4 more]</label></div><br/><div class="children"><div class="content">Mine doesn&#x27;t have a date at the bottom, just a macOS version number.</div><br/><div id="37682391" class="c"><input type="checkbox" id="c-37682391" checked=""/><div class="controls bullet"><span class="by">wkat4242</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37680553">parent</a><span>|</span><a href="#37682099">next</a><span>|</span><label class="collapse" for="c-37682391">[-]</label><label class="expand" for="c-37682391">[2 more]</label></div><br/><div class="children"><div class="content">Still 2007 here in macOS Sonoma 14.0<p>I&#x27;m just super surprised it&#x27;s there at all considering no rules are defined by the OS, and nobody uses it anymore because all the firewall vendors moved over to system extensions.</div><br/><div id="37686943" class="c"><input type="checkbox" id="c-37686943" checked=""/><div class="controls bullet"><span class="by">arghnoname</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37682391">parent</a><span>|</span><a href="#37682099">next</a><span>|</span><label class="collapse" for="c-37686943">[-]</label><label class="expand" for="c-37686943">[1 more]</label></div><br/><div class="children"><div class="content">when I use pfctl on macOS I see apple defined anchors.</div><br/></div></div></div></div><div id="37682099" class="c"><input type="checkbox" id="c-37682099" checked=""/><div class="controls bullet"><span class="by">nvy</span><span>|</span><a href="#37679545">root</a><span>|</span><a href="#37680553">parent</a><span>|</span><a href="#37682391">prev</a><span>|</span><a href="#37681334">next</a><span>|</span><label class="collapse" for="c-37682099">[-]</label><label class="expand" for="c-37682099">[1 more]</label></div><br/><div class="children"><div class="content">edit: never mind, it does</div><br/></div></div></div></div></div></div></div></div></div></div><div id="37681334" class="c"><input type="checkbox" id="c-37681334" checked=""/><div class="controls bullet"><span class="by">chasil</span><span>|</span><a href="#37679545">parent</a><span>|</span><a href="#37679950">prev</a><span>|</span><a href="#37679044">next</a><span>|</span><label class="collapse" for="c-37681334">[-]</label><label class="expand" for="c-37681334">[1 more]</label></div><br/><div class="children"><div class="content">Solaris also uses pf as the native firewall, iirc.</div><br/></div></div></div></div><div id="37679044" class="c"><input type="checkbox" id="c-37679044" checked=""/><div class="controls bullet"><span class="by">jayp1418</span><span>|</span><a href="#37679545">prev</a><span>|</span><a href="#37679001">next</a><span>|</span><label class="collapse" for="c-37679044">[-]</label><label class="expand" for="c-37679044">[3 more]</label></div><br/><div class="children"><div class="content">Also don&#x27;t forget NetBSD &#x27;s npf</div><br/><div id="37680804" class="c"><input type="checkbox" id="c-37680804" checked=""/><div class="controls bullet"><span class="by">idatum</span><span>|</span><a href="#37679044">parent</a><span>|</span><a href="#37679001">next</a><span>|</span><label class="collapse" for="c-37680804">[-]</label><label class="expand" for="c-37680804">[2 more]</label></div><br/><div class="children"><div class="content">I wanted to use npf but I couldn&#x27;t figure out how to implement NAT64. The syntax looked nice though.</div><br/><div id="37681269" class="c"><input type="checkbox" id="c-37681269" checked=""/><div class="controls bullet"><span class="by">systems_glitch</span><span>|</span><a href="#37679044">root</a><span>|</span><a href="#37680804">parent</a><span>|</span><a href="#37679001">next</a><span>|</span><label class="collapse" for="c-37681269">[-]</label><label class="expand" for="c-37681269">[1 more]</label></div><br/><div class="children"><div class="content">Juuuust different enough to be aggravating :P<p>Check the &#x2F;etc&#x2F;examples stuff for the best docs on `npf`. Most of what I found online was outdated or just plain wrong.</div><br/></div></div></div></div></div></div><div id="37679001" class="c"><input type="checkbox" id="c-37679001" checked=""/><div class="controls bullet"><span class="by">tiffanyh</span><span>|</span><a href="#37679044">prev</a><span>|</span><a href="#37679041">next</a><span>|</span><label class="collapse" for="c-37679001">[-]</label><label class="expand" for="c-37679001">[13 more]</label></div><br/><div class="children"><div class="content">Don&#x27;t forget DragonflyBSD version of PF.<p>They look an old version of OpenBSD PF and updated it to be multithreaded.<p>I could be mistaken, but I believe both FreeBSD PF &amp; OpenBSD PF are still single threaded.<p><a href="https:&#x2F;&#x2F;man.dragonflybsd.org&#x2F;?command=pf&amp;section=4" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.dragonflybsd.org&#x2F;?command=pf&amp;section=4</a></div><br/><div id="37679395" class="c"><input type="checkbox" id="c-37679395" checked=""/><div class="controls bullet"><span class="by">darkhelmet</span><span>|</span><a href="#37679001">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37679395">[-]</label><label class="expand" for="c-37679395">[6 more]</label></div><br/><div class="children"><div class="content">DragonFly and FreeBSD have radically different ideas on how multithreading should work. (Understatement of the century right there!)<p>FWIW the threading in the network stack is one of the original major divergences between Open&#x2F;FreeBSD PF.  The way FreeBSD&#x27;s PF works is within the context of FreeBSD&#x27;s threaded network stack.  FreeBSD PF is not &quot;single threaded&quot; in the way it used to mean.<p>I would <i>really</i> like to have the modern PF syntax&#x2F;structure from OpenBSD in FreeBSD though.  The unified rdr&#x2F;nat&#x2F;pass&#x2F;block mechanism in OpenBSD is so much cleaner and nicer to work with.</div><br/><div id="37679549" class="c"><input type="checkbox" id="c-37679549" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37679395">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37679549">[-]</label><label class="expand" for="c-37679549">[5 more]</label></div><br/><div class="children"><div class="content"><i>DragonFly and FreeBSD have radically different ideas on how multithreading should work. (Understatement of the century right there!)</i><p>To elaborate for people who don&#x27;t know the history: Disagreement about how multithreading should work are why Matt got booted from the FreeBSD project and started DragonFly.</div><br/><div id="37680065" class="c"><input type="checkbox" id="c-37680065" checked=""/><div class="controls bullet"><span class="by">darkhelmet</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37679549">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37680065">[-]</label><label class="expand" for="c-37680065">[4 more]</label></div><br/><div class="children"><div class="content">It&#x27;s not that simple.  Disagreements are one thing, but the real reason was the conflict and drama that happened when things didn&#x27;t go his way.  The threading approach just happened to be a really good trigger for those conflicts.<p>Conflicting personalities makes resolving technical disagreements so much harder.</div><br/><div id="37680453" class="c"><input type="checkbox" id="c-37680453" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37680065">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37680453">[-]</label><label class="expand" for="c-37680453">[3 more]</label></div><br/><div class="children"><div class="content">I was being euphemistic.  It was a &quot;doesn&#x27;t play well with others&quot; issue, but it came to the fore with SMP.</div><br/><div id="37683406" class="c"><input type="checkbox" id="c-37683406" checked=""/><div class="controls bullet"><span class="by">bch</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37680453">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37683406">[-]</label><label class="expand" for="c-37683406">[2 more]</label></div><br/><div class="children"><div class="content">Playing well obviously important (and I wasn’t involved, have no other insight), but do you know if the poor showing for fbsd 5.x correspond w the disagreements?</div><br/><div id="37683595" class="c"><input type="checkbox" id="c-37683595" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37683406">parent</a><span>|</span><a href="#37679401">next</a><span>|</span><label class="collapse" for="c-37683595">[-]</label><label class="expand" for="c-37683595">[1 more]</label></div><br/><div class="children"><div class="content">FreeBSD 5.x was a very stressful time -- bringing full SMP to the entire kernel was a massive technical challenge, and it didn&#x27;t help that a lot of the people who were expecting to work on it lost their jobs during the dot com crash.<p>5.x was a poor vintage because making the kernel SMP was hard, and social issues became problematic because SMP was hard, but Matt&#x27;s departure was neither the result or cause of FreeBSD 5.x having issues.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div><div id="37679401" class="c"><input type="checkbox" id="c-37679401" checked=""/><div class="controls bullet"><span class="by">dmm</span><span>|</span><a href="#37679001">parent</a><span>|</span><a href="#37679395">prev</a><span>|</span><a href="#37679036">next</a><span>|</span><label class="collapse" for="c-37679401">[-]</label><label class="expand" for="c-37679401">[3 more]</label></div><br/><div class="children"><div class="content">FreeBSD pf has been multithreaded for a long time. The FreeBSD 11 pf(4) man page from 2013 specifically says so[1].<p>[1] <a href="https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=pf&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+11.0-RELEASE&amp;arch=default&amp;format=html#end" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=pf&amp;apropos=0&amp;sekti...</a></div><br/><div id="37680200" class="c"><input type="checkbox" id="c-37680200" checked=""/><div class="controls bullet"><span class="by">Lammy</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37679401">parent</a><span>|</span><a href="#37679036">next</a><span>|</span><label class="collapse" for="c-37680200">[-]</label><label class="expand" for="c-37680200">[2 more]</label></div><br/><div class="children"><div class="content">&quot;SMP&quot; might be a more useful search term. You&#x27;re correct on the timeframe — merged into HEAD in 2012 <a href="https:&#x2F;&#x2F;lists.freebsd.org&#x2F;pipermail&#x2F;freebsd-pf&#x2F;2012-September&#x2F;006740.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;lists.freebsd.org&#x2F;pipermail&#x2F;freebsd-pf&#x2F;2012-Septembe...</a><p>I&#x27;m not an OpenBSD user but it sounds like this changed recently in OpenBSD-land as well, because the &quot;Will multiple processors help?&quot; FAQ entry disappeared some time between January and March 2023: <a href="https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20230112170731&#x2F;https:&#x2F;&#x2F;www.openbsd.org&#x2F;faq&#x2F;pf&#x2F;perf.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;web.archive.org&#x2F;web&#x2F;20230112170731&#x2F;https:&#x2F;&#x2F;www.openb...</a></div><br/><div id="37680338" class="c"><input type="checkbox" id="c-37680338" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37680200">parent</a><span>|</span><a href="#37679036">next</a><span>|</span><label class="collapse" for="c-37680338">[-]</label><label class="expand" for="c-37680338">[1 more]</label></div><br/><div class="children"><div class="content">I didn’t know this but it makes sense. Either way for most of the use cases (homelabs on residential internet speeds) either FBSD or OpenBSD’s PF will perform just swimmingly.</div><br/></div></div></div></div></div></div><div id="37679036" class="c"><input type="checkbox" id="c-37679036" checked=""/><div class="controls bullet"><span class="by">postmodest</span><span>|</span><a href="#37679001">parent</a><span>|</span><a href="#37679401">prev</a><span>|</span><a href="#37679041">next</a><span>|</span><label class="collapse" for="c-37679036">[-]</label><label class="expand" for="c-37679036">[3 more]</label></div><br/><div class="children"><div class="content">The only advantage I can see to MT PF would be multiple NICs. And even then they have to be really beefy NICs</div><br/><div id="37679501" class="c"><input type="checkbox" id="c-37679501" checked=""/><div class="controls bullet"><span class="by">smashed</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37679036">parent</a><span>|</span><a href="#37679041">next</a><span>|</span><label class="collapse" for="c-37679501">[-]</label><label class="expand" for="c-37679501">[2 more]</label></div><br/><div class="children"><div class="content">From what I understand, modern NICs have multiple Rx&#x2F;tx queues and thus the work of sending and receiving can be assigned to different kernel threads.<p>The number of queues will vary according to the specific NIC chip.</div><br/><div id="37683545" class="c"><input type="checkbox" id="c-37683545" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#37679001">root</a><span>|</span><a href="#37679501">parent</a><span>|</span><a href="#37679041">next</a><span>|</span><label class="collapse" for="c-37683545">[-]</label><label class="expand" for="c-37683545">[1 more]</label></div><br/><div class="children"><div class="content">I was going to say something similar.<p>Multiqueue NICs do great work on networking loads when you have 1 core per NIC queue; and you can eliminate or at least reduce cross-core communication for most of the work.<p>It&#x27;s not complex firewalling, but I did some HAProxy stuff in tcp mode, and the throughput available when running without queue alignment was miniscule compared to the throughput available when properly aligned. Firewalling has the benefit that queue alignment should happen automagically, because of where it runs. If you&#x27;re doing a lot of processing in userspace, it makes a lot less of a difference, but on a very lightweight application, there was no point in using more cores than nic queues, because cross-core communication was too slow.</div><br/></div></div></div></div></div></div></div></div><div id="37679041" class="c"><input type="checkbox" id="c-37679041" checked=""/><div class="controls bullet"><span class="by">josteink</span><span>|</span><a href="#37679001">prev</a><span>|</span><a href="#37682256">next</a><span>|</span><label class="collapse" for="c-37679041">[-]</label><label class="expand" for="c-37679041">[7 more]</label></div><br/><div class="children"><div class="content">&gt; And the PF syntax is the most approachable in all of open source Unix.<p>As someone not deeply into the BSDs and who has never tried pf, I would love to see this claim illustrated with a few examples.<p>Are there any “definitive” or authoritative beginner guides for those merely curious, but without a production system to test on?</div><br/><div id="37679245" class="c"><input type="checkbox" id="c-37679245" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#37679041">parent</a><span>|</span><a href="#37679329">next</a><span>|</span><label class="collapse" for="c-37679245">[-]</label><label class="expand" for="c-37679245">[1 more]</label></div><br/><div class="children"><div class="content">Find your favorite topic in <a href="https:&#x2F;&#x2F;www.openbsd.org&#x2F;faq&#x2F;pf&#x2F;index.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.openbsd.org&#x2F;faq&#x2F;pf&#x2F;index.html</a> and compare to how you&#x27;d do it in your favorite firewall.</div><br/></div></div><div id="37679329" class="c"><input type="checkbox" id="c-37679329" checked=""/><div class="controls bullet"><span class="by">voytec</span><span>|</span><a href="#37679041">parent</a><span>|</span><a href="#37679245">prev</a><span>|</span><a href="#37679165">next</a><span>|</span><label class="collapse" for="c-37679329">[-]</label><label class="expand" for="c-37679329">[2 more]</label></div><br/><div class="children"><div class="content">&gt; And the PF syntax is the most approachable in all of open source Unix.<p>I actually find ipfw(8) [0] syntax more human-friendly.<p>[0] <a href="https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=ipfw&amp;sektion=8&amp;format=html" rel="nofollow noreferrer">https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=ipfw&amp;sektion=8&amp;for...</a></div><br/><div id="37680514" class="c"><input type="checkbox" id="c-37680514" checked=""/><div class="controls bullet"><span class="by">stock_toaster</span><span>|</span><a href="#37679041">root</a><span>|</span><a href="#37679329">parent</a><span>|</span><a href="#37679165">next</a><span>|</span><label class="collapse" for="c-37680514">[-]</label><label class="expand" for="c-37680514">[1 more]</label></div><br/><div class="children"><div class="content">I wish dragonflyBSD’s ipfw3 would get ported to freeBSD.</div><br/></div></div></div></div><div id="37679165" class="c"><input type="checkbox" id="c-37679165" checked=""/><div class="controls bullet"><span class="by">i_am_a_peasant</span><span>|</span><a href="#37679041">parent</a><span>|</span><a href="#37679329">prev</a><span>|</span><a href="#37679169">next</a><span>|</span><label class="collapse" for="c-37679165">[-]</label><label class="expand" for="c-37679165">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;d go for the handbook in that case:<p><a href="https:&#x2F;&#x2F;docs.freebsd.org&#x2F;en&#x2F;books&#x2F;handbook&#x2F;firewalls&#x2F;#firewalls-pf" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.freebsd.org&#x2F;en&#x2F;books&#x2F;handbook&#x2F;firewalls&#x2F;#firewa...</a></div><br/></div></div><div id="37679169" class="c"><input type="checkbox" id="c-37679169" checked=""/><div class="controls bullet"><span class="by">nesarkvechnep</span><span>|</span><a href="#37679041">parent</a><span>|</span><a href="#37679165">prev</a><span>|</span><a href="#37680194">next</a><span>|</span><label class="collapse" for="c-37679169">[-]</label><label class="expand" for="c-37679169">[1 more]</label></div><br/><div class="children"><div class="content">Get yourself “The Book of PF” and get to work.</div><br/></div></div><div id="37680194" class="c"><input type="checkbox" id="c-37680194" checked=""/><div class="controls bullet"><span class="by">fragmede</span><span>|</span><a href="#37679041">parent</a><span>|</span><a href="#37679169">prev</a><span>|</span><a href="#37682256">next</a><span>|</span><label class="collapse" for="c-37680194">[-]</label><label class="expand" for="c-37680194">[1 more]</label></div><br/><div class="children"><div class="content">Explore in the direction you want to go:<p><a href="https:&#x2F;&#x2F;chat.openai.com&#x2F;share&#x2F;e1e2a207-5fb4-4f12-9f3c-7850ffa7445f" rel="nofollow noreferrer">https:&#x2F;&#x2F;chat.openai.com&#x2F;share&#x2F;e1e2a207-5fb4-4f12-9f3c-7850ff...</a></div><br/></div></div></div></div></div></div></div></div></div></body></html>