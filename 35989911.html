<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1684486857597" as="style"/><link rel="stylesheet" href="styles.css?v=1684486857597"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://who.ldelossa.is/posts/unit-testing-ebpf/">Unit Testing eBPF Programs</a>Â <span class="domain">(<a href="https://who.ldelossa.is">who.ldelossa.is</a>)</span></div><div class="subtext"><span>ldelossa</span> | <span>11 comments</span></div><br/><div><div id="35990726" class="c"><input type="checkbox" id="c-35990726" checked=""/><div class="controls bullet"><span class="by">tyoma</span><span>|</span><a href="#35994235">next</a><span>|</span><label class="collapse" for="c-35990726">[-]</label><label class="expand" for="c-35990726">[1 more]</label></div><br/><div class="children"><div class="content">This past summer one of the Trail of Bits interns worked on a project to test BPF programs from userspace, independent of kernel version: <a href="https:&#x2F;&#x2F;blog.trailofbits.com&#x2F;2023&#x2F;01&#x2F;19&#x2F;ebpf-verifier-harness&#x2F;" rel="nofollow">https:&#x2F;&#x2F;blog.trailofbits.com&#x2F;2023&#x2F;01&#x2F;19&#x2F;ebpf-verifier-harnes...</a><p>It is still very much a proof of concept but could be a starting point to make future BPF testing easier.</div><br/></div></div><div id="35994235" class="c"><input type="checkbox" id="c-35994235" checked=""/><div class="controls bullet"><span class="by">eyakubovich</span><span>|</span><a href="#35990726">prev</a><span>|</span><a href="#35990302">next</a><span>|</span><label class="collapse" for="c-35994235">[-]</label><label class="expand" for="c-35994235">[1 more]</label></div><br/><div class="children"><div class="content">In my experience, the hardest part of developing with eBPF is dealing with the multiple kernel versions and configurations that the target machines may have. It&#x27;s a challenge not only because eBPF features were added gradually but because the internal data structures are not stable. While CO-RE finally makes it possible to be offset agnostic and allows for dealing with things like missing struct members, it&#x27;s still very much a game of finding out when the code is deployed in the wild. Unit testing is important but I long for a way to easily test across a large matrix of kernel versions&#x2F;configs (here at EdgeBit, we would be happy to pay for such a service).</div><br/></div></div><div id="35990302" class="c"><input type="checkbox" id="c-35990302" checked=""/><div class="controls bullet"><span class="by">danobi</span><span>|</span><a href="#35994235">prev</a><span>|</span><a href="#35996587">next</a><span>|</span><label class="collapse" for="c-35990302">[-]</label><label class="expand" for="c-35990302">[2 more]</label></div><br/><div class="children"><div class="content">BPF_PROG_RUN is great but unfortunately depends on the running kernel version. To that end, I wrote `vmtest` (<a href="https:&#x2F;&#x2F;dxuuu.xyz&#x2F;vmtest.html" rel="nofollow">https:&#x2F;&#x2F;dxuuu.xyz&#x2F;vmtest.html</a>) which is designed for the BPF_PROG_RUN use case.</div><br/><div id="35991957" class="c"><input type="checkbox" id="c-35991957" checked=""/><div class="controls bullet"><span class="by">rapidlua</span><span>|</span><a href="#35990302">parent</a><span>|</span><a href="#35996587">next</a><span>|</span><label class="collapse" for="c-35991957">[-]</label><label class="expand" for="c-35991957">[1 more]</label></div><br/><div class="children"><div class="content">Thank you for bpftrace! It was a vital aid for kernel spelunking. Very excited to see vmtest. I did a similar tool in the past [1] but never achieved this level of polish.<p>[1] <a href="https:&#x2F;&#x2F;github.com&#x2F;mejedi&#x2F;vmwrap">https:&#x2F;&#x2F;github.com&#x2F;mejedi&#x2F;vmwrap</a></div><br/></div></div></div></div><div id="35996587" class="c"><input type="checkbox" id="c-35996587" checked=""/><div class="controls bullet"><span class="by">alexeldeib</span><span>|</span><a href="#35990302">prev</a><span>|</span><a href="#35990590">next</a><span>|</span><label class="collapse" for="c-35996587">[-]</label><label class="expand" for="c-35996587">[1 more]</label></div><br/><div class="children"><div class="content">Beyond the content, kudos to the author for crisply and clearly laying out the intent of the article and prerequisites, referring to prior art for larger questions. Really enjoy the style.</div><br/></div></div><div id="35990590" class="c"><input type="checkbox" id="c-35990590" checked=""/><div class="controls bullet"><span class="by">ranting-moth</span><span>|</span><a href="#35996587">prev</a><span>|</span><a href="#35993716">next</a><span>|</span><label class="collapse" for="c-35990590">[-]</label><label class="expand" for="c-35990590">[3 more]</label></div><br/><div class="children"><div class="content">Pardon my ignorance, is clang needed to build eBPF programs like it says in the article?</div><br/><div id="35992534" class="c"><input type="checkbox" id="c-35992534" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#35990590">parent</a><span>|</span><a href="#35990754">next</a><span>|</span><label class="collapse" for="c-35992534">[-]</label><label class="expand" for="c-35992534">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a C compiler with an eBPF backend, but if you wanted to compile from a different language, or had a different C compiler with an eBPF backend (like GCC), you could do that. `libpcap` contains a surprisingly sophisticated compiler for filter expressions (to cBPF, which is JIT&#x27;d to eBPF; compiling to cBPF is in some ways more impressive given its limitations).</div><br/></div></div><div id="35990754" class="c"><input type="checkbox" id="c-35990754" checked=""/><div class="controls bullet"><span class="by">unmole</span><span>|</span><a href="#35990590">parent</a><span>|</span><a href="#35992534">prev</a><span>|</span><a href="#35993716">next</a><span>|</span><label class="collapse" for="c-35990754">[-]</label><label class="expand" for="c-35990754">[1 more]</label></div><br/><div class="children"><div class="content">One could always write the eBPF assembly by hand. I ended up doing that a few years ago when clang didn&#x27;t yet have eBPF support. Would not recommend.</div><br/></div></div></div></div><div id="35993716" class="c"><input type="checkbox" id="c-35993716" checked=""/><div class="controls bullet"><span class="by">hugatest</span><span>|</span><a href="#35990590">prev</a><span>|</span><label class="collapse" for="c-35993716">[-]</label><label class="expand" for="c-35993716">[2 more]</label></div><br/><div class="children"><div class="content">If your unit test needs root privileges, then it&#x27;s not really a unit test in all but very few exceptional cases. It means you are interacting with the actually running kernel, which means you are integration testing, not unit testing.</div><br/><div id="35996791" class="c"><input type="checkbox" id="c-35996791" checked=""/><div class="controls bullet"><span class="by">tptacek</span><span>|</span><a href="#35993716">parent</a><span>|</span><label class="collapse" for="c-35996791">[-]</label><label class="expand" for="c-35996791">[1 more]</label></div><br/><div class="children"><div class="content">Who cares?</div><br/></div></div></div></div></div></div></div></div></div></body></html>