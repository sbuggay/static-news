<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1706000462890" as="style"/><link rel="stylesheet" href="styles.css?v=1706000462890"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://www.matheusmoreira.com/articles/self-contained-lone-lisp-applications">Self-contained Linux applications with lone Lisp</a>Â <span class="domain">(<a href="https://www.matheusmoreira.com">www.matheusmoreira.com</a>)</span></div><div class="subtext"><span>goranmoomin</span> | <span>7 comments</span></div><br/><div><div id="39099138" class="c"><input type="checkbox" id="c-39099138" checked=""/><div class="controls bullet"><span class="by">electroly</span><span>|</span><a href="#39099074">next</a><span>|</span><label class="collapse" for="c-39099138">[-]</label><label class="expand" for="c-39099138">[5 more]</label></div><br/><div class="children"><div class="content">Good persistence in finding a good solution, but I wish the author found a solution that didn&#x27;t involve mold. I&#x27;m in the same situation; I have a programming language that builds self-contained executables by bundling bytecode with a prebuilt interpreter. But I&#x27;m not nearly as smart as the author, so I link a fixed multi-megabyte chunk of sentinel bytes into the interpreter (using xxd to produce a literal array in a .c file) and at embed time I search for the bytes and overwrite them in-place. This works for executables on any platform and doesn&#x27;t require a special linker, but the hardcoded limit (and wasted space when you come under the limit) is undesirable.</div><br/><div id="39100633" class="c"><input type="checkbox" id="c-39100633" checked=""/><div class="controls bullet"><span class="by">regularfry</span><span>|</span><a href="#39099138">parent</a><span>|</span><a href="#39100336">next</a><span>|</span><label class="collapse" for="c-39100633">[-]</label><label class="expand" for="c-39100633">[2 more]</label></div><br/><div class="children"><div class="content">If you&#x27;re happy with a compile and link step, you can embed arbitrary data at link time with an ordinary linker by making yourself a linkable object with objcopy(1). I&#x27;ve played with it in the past as a way to embed an sqlite database into a ruby interpreter, which lets you do funky things like reimplementing `require` to read from the embedded database.</div><br/><div id="39100678" class="c"><input type="checkbox" id="c-39100678" checked=""/><div class="controls bullet"><span class="by">electroly</span><span>|</span><a href="#39099138">root</a><span>|</span><a href="#39100633">parent</a><span>|</span><a href="#39100336">next</a><span>|</span><label class="collapse" for="c-39100678">[-]</label><label class="expand" for="c-39100678">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s a possibility. It&#x27;s not unreasonable for me to ship builds of objcopy and lld that I can run at embed time. An immediate difficulty is that I support Windows and macOS, so I need a solution for PE and Mach-O executables too. I think a solution probably exists but I may need a separate solution for each platform. Embedding resources into binaries is pretty easy, it&#x27;s just a matter of how to do it without shipping an entire C toolchain to users of my language.</div><br/></div></div></div></div><div id="39100336" class="c"><input type="checkbox" id="c-39100336" checked=""/><div class="controls bullet"><span class="by">pitherpather</span><span>|</span><a href="#39099138">parent</a><span>|</span><a href="#39100633">prev</a><span>|</span><a href="#39099074">next</a><span>|</span><label class="collapse" for="c-39100336">[-]</label><label class="expand" for="c-39100336">[2 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know how clean or simple or portable you wish your build environment to be, but would it be worth embedding at compile-time?<p>Thinking of the general need in these situations to produce a custom-named interpreter&#x2F;executable, could it be worth accessing the program name itself to find a paired source file? E.g., in invoking .&#x2F;foo2.o it would look for .&#x2F;foo2.code -- a two-file distribution allowing to double-click on the executable??<p>Could there be a non-unicode flag at the end of a special elf file which allows arbitrary unicode data to be concatenated after that? I.e., an agreed loader-ignore-hereafter convention or similar? (Asking with no knowledge of ELF internals, besides hints given in the OP.)</div><br/><div id="39100594" class="c"><input type="checkbox" id="c-39100594" checked=""/><div class="controls bullet"><span class="by">electroly</span><span>|</span><a href="#39099138">root</a><span>|</span><a href="#39100336">parent</a><span>|</span><a href="#39099074">next</a><span>|</span><label class="collapse" for="c-39100594">[-]</label><label class="expand" for="c-39100594">[1 more]</label></div><br/><div class="children"><div class="content">Using two files would definitely work and, honestly, be a lot simpler. But it&#x27;s a neat trick to make it a single file. For my toy language, it mostly serves to hide the fact that I&#x27;m not really compiling to native. People won&#x27;t ask questions if it&#x27;s a single executable that file(1) says is a statically linked binary.<p>Appending to the end of the ELF file does work. It won&#x27;t mess anything up because your bytes will be outside of any ELF section. You can insert a known sentinel string and then search for it at runtime. The main problem is that you have to open your own executable file up for reading so you can locate the data at the end, and on Linux that requires having &#x2F;proc, AFAIK. The nice thing about these other techniques is we&#x27;re not assuming anything about the filesystem we&#x27;re in. In a chroot environment you might not have &#x2F;proc.</div><br/></div></div></div></div></div></div><div id="39099074" class="c"><input type="checkbox" id="c-39099074" checked=""/><div class="controls bullet"><span class="by">pitherpather</span><span>|</span><a href="#39099138">prev</a><span>|</span><label class="collapse" for="c-39099074">[-]</label><label class="expand" for="c-39099074">[1 more]</label></div><br/><div class="children"><div class="content">&gt; In this article I will demonstrate this capability [lisp code directly embedded], explain how it works and the journey to implementing it. Every script bundling tool I&#x27;ve ever seen unpacks the code to some file system location and then reads it back in. I came up with a different solution.<p>&gt; The lone-embed tool copies the lisp code into the ELF and then creates a LOAD segment for it. Linux then maps in the embedded code automatically at load time before the interpreter has even started.<p>And the discussion which follows I found very informative.</div><br/></div></div></div></div></div></div></div></body></html>