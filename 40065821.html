<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1713430860368" as="style"/><link rel="stylesheet" href="styles.css?v=1713430860368"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/mitchellh/libxev">libxev: A cross-platform, high-performance event loop</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>tosh</span> | <span>27 comments</span></div><br/><div><div id="40068570" class="c"><input type="checkbox" id="c-40068570" checked=""/><div class="controls bullet"><span class="by">mitchellh</span><span>|</span><a href="#40069457">next</a><span>|</span><label class="collapse" for="c-40068570">[-]</label><label class="expand" for="c-40068570">[8 more]</label></div><br/><div class="children"><div class="content">This is my project.<p>I use it as the core cross-platform event loop layer for my terminal (<a href="https:&#x2F;&#x2F;mitchellh.com&#x2F;ghostty" rel="nofollow">https:&#x2F;&#x2F;mitchellh.com&#x2F;ghostty</a>). I still consider libxev an early, unstable project but the terminal has been in use by hundreds to now over a thousand beta testers daily for over a year now so at least for that use case its very stable. :) I know of others using it in production shipped software, but use it at your own risk.<p>As background, my terminal previously used libuv (the Node.js core event loop library), and I think libuv is a great project! I still have those Zig bindings available (archived) if anyone is interested: <a href="https:&#x2F;&#x2F;github.com&#x2F;mitchellh&#x2F;zig-libuv">https:&#x2F;&#x2F;github.com&#x2F;mitchellh&#x2F;zig-libuv</a><p>The main issue I had personally with libuv was that I was noticing performance jitter due to heap allocations. libxev&#x27;s main design goal was to be allocation-free, and it is. The caller is responsible for allocating all the memory libxev needs (however it decides to do that!) and passing it to libxev. There were some additional things I wanted: more direct access to mach ports on macOS, io_uring on Linux (although I think libuv can use io_uring now), etc. But more carefully controlling memory allocation was the big one.<p>And it worked! Under heavy IO load in my terminal project, p90 performance roughly matched libuv but my p99 performance was much, much better. Like, 10x or more better. I don&#x27;t have those numbers in front of me anymore to back that up and my terminal project hasn&#x27;t built with libuv in a very long time. But I consider the project a success for my use case.<p>You&#x27;re probably better off using libuv (i.e. the Node loop, not my project) for your own project. But, the main takeaway I&#x27;d give people is: don&#x27;t be afraid to reimplement this kind of stuff for you. A purpose-built event loop isn&#x27;t that complicated, and if your software isn&#x27;t even cross-platform, it&#x27;s really not complicated.</div><br/><div id="40069803" class="c"><input type="checkbox" id="c-40069803" checked=""/><div class="controls bullet"><span class="by">mattgreenrocks</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40070878">next</a><span>|</span><label class="collapse" for="c-40069803">[-]</label><label class="expand" for="c-40069803">[1 more]</label></div><br/><div class="children"><div class="content">Very nice! TBH, libuv sometimes felt like it is popular because it&#x27;s popular rather than sheer technical prowess. I was never comfortable with how much allocation is done by it, and I don&#x27;t always find how it deals with platform primitives as useful as I&#x27;d like.<p>&gt; don&#x27;t be afraid to reimplement this kind of stuff for you. A purpose-built event loop isn&#x27;t that complicated,<p>Amen. There&#x27;s no need to view the event loop as mysterious. It&#x27;s just a while loop that is constantly coordinating IO.</div><br/></div></div><div id="40070878" class="c"><input type="checkbox" id="c-40070878" checked=""/><div class="controls bullet"><span class="by">password4321</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40069803">prev</a><span>|</span><a href="#40069048">next</a><span>|</span><label class="collapse" for="c-40070878">[-]</label><label class="expand" for="c-40070878">[1 more]</label></div><br/><div class="children"><div class="content">&gt; <i>libxev&#x27;s main design goal was to be allocation-free</i><p>Maybe &quot;allocation-free&quot; should be in the GitHub project description instead of or in addition to &quot;high performance&quot;.</div><br/></div></div><div id="40069048" class="c"><input type="checkbox" id="c-40069048" checked=""/><div class="controls bullet"><span class="by">samsquire</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40070878">prev</a><span>|</span><a href="#40071064">next</a><span>|</span><label class="collapse" for="c-40069048">[-]</label><label class="expand" for="c-40069048">[2 more]</label></div><br/><div class="children"><div class="content">Thank for you for sharing.<p>What do you think are the next steps for a next generation event loop?<p>I&#x27;ve been experimenting with barriers&#x2F;phasers, LMAX Disruptors and my own lock free algorithms.<p>I think some form of multithreaded structured concurrency with coroutines and io_uring.<p>I&#x27;ve been experimenting with decoupling the making sending and recv independently parallel with multiple io_urings &quot;split parallel io&quot; - so you can process incoming traffic separately from the stream that generates data to send. Generating sends is unblocked by receive parsing and vice versa.<p>Interested in seastar and reactors.</div><br/><div id="40070936" class="c"><input type="checkbox" id="c-40070936" checked=""/><div class="controls bullet"><span class="by">password4321</span><span>|</span><a href="#40068570">root</a><span>|</span><a href="#40069048">parent</a><span>|</span><a href="#40071064">next</a><span>|</span><label class="collapse" for="c-40070936">[-]</label><label class="expand" for="c-40070936">[1 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Data_Plane_Development_Kit" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Data_Plane_Development_Kit</a></div><br/></div></div></div></div><div id="40071064" class="c"><input type="checkbox" id="c-40071064" checked=""/><div class="controls bullet"><span class="by">keepamovin</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40069048">prev</a><span>|</span><a href="#40068719">next</a><span>|</span><label class="collapse" for="c-40071064">[-]</label><label class="expand" for="c-40071064">[1 more]</label></div><br/><div class="children"><div class="content"><i>Three, I wanted an event loop library that could build to WebAssembly (both WASI and freestanding) and that didn&#x27;t really fit well into the goals of API style of existing libraries without bringing in something super heavy like Emscripten.</i><p>This is a cool motivation!<p>Could you drop this into Node to make Node<i>ex</i> ? A kind of experimental allocation-free Node that somehow carves out the allocations into another layer (admittedly still within the node c code)?</div><br/></div></div><div id="40068719" class="c"><input type="checkbox" id="c-40068719" checked=""/><div class="controls bullet"><span class="by">ajoseps</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40071064">prev</a><span>|</span><a href="#40069740">next</a><span>|</span><label class="collapse" for="c-40068719">[-]</label><label class="expand" for="c-40068719">[1 more]</label></div><br/><div class="children"><div class="content">I saw ghostty and thought, “isn’t that the terminal written by the guy who cofounded hashicorp?”. I really enjoy your ghostty blog posts and will be checking out libxev!</div><br/></div></div><div id="40069740" class="c"><input type="checkbox" id="c-40069740" checked=""/><div class="controls bullet"><span class="by">adonese</span><span>|</span><a href="#40068570">parent</a><span>|</span><a href="#40068719">prev</a><span>|</span><a href="#40069457">next</a><span>|</span><label class="collapse" for="c-40069740">[-]</label><label class="expand" for="c-40069740">[1 more]</label></div><br/><div class="children"><div class="content">(Off topic) but any chance you might include me in the ghostty private testers? (adonese@nil.sd)</div><br/></div></div></div></div><div id="40069457" class="c"><input type="checkbox" id="c-40069457" checked=""/><div class="controls bullet"><span class="by">Jarred</span><span>|</span><a href="#40068570">prev</a><span>|</span><a href="#40070097">next</a><span>|</span><label class="collapse" for="c-40069457">[-]</label><label class="expand" for="c-40069457">[3 more]</label></div><br/><div class="children"><div class="content">We copied libxev&#x27;s code for the timer heap implementation in Bun for setTimeout &amp; setInterval, and it was a ~6x throughput improvement[0] on Linux compared to our previous implementation.<p>[0]: <a href="https:&#x2F;&#x2F;twitter.com&#x2F;jarredsumner&#x2F;status&#x2F;1736741811039899871" rel="nofollow">https:&#x2F;&#x2F;twitter.com&#x2F;jarredsumner&#x2F;status&#x2F;1736741811039899871</a></div><br/><div id="40069817" class="c"><input type="checkbox" id="c-40069817" checked=""/><div class="controls bullet"><span class="by">hinkley</span><span>|</span><a href="#40069457">parent</a><span>|</span><a href="#40070097">next</a><span>|</span><label class="collapse" for="c-40069817">[-]</label><label class="expand" for="c-40069817">[2 more]</label></div><br/><div class="children"><div class="content">Why do you suppose node is still 50% faster on this benchmark? v8 trickery or something in the library differences?</div><br/><div id="40069940" class="c"><input type="checkbox" id="c-40069940" checked=""/><div class="controls bullet"><span class="by">Jarred</span><span>|</span><a href="#40069457">root</a><span>|</span><a href="#40069817">parent</a><span>|</span><a href="#40070097">next</a><span>|</span><label class="collapse" for="c-40069940">[-]</label><label class="expand" for="c-40069940">[1 more]</label></div><br/><div class="children"><div class="content">The timer heap currently lives on a different thread instead of the main thread, which means timers have to be allocated and scheduled separately for each one. Scheduling things to other threads is expensive. The reason it works this way isn&#x27;t good and we will fix it but haven&#x27;t prioritized it yet</div><br/></div></div></div></div></div></div><div id="40070097" class="c"><input type="checkbox" id="c-40070097" checked=""/><div class="controls bullet"><span class="by">eqvinox</span><span>|</span><a href="#40069457">prev</a><span>|</span><a href="#40069796">next</a><span>|</span><label class="collapse" for="c-40070097">[-]</label><label class="expand" for="c-40070097">[1 more]</label></div><br/><div class="children"><div class="content">As someone maintaining a project with its own event loop: don&#x27;t do it in larger projects.<p>The problem is that you&#x27;ll start having dependencies on external libraries. And when those then need event loop integration, things get messy. We&#x27;ve introduced bugs before, caused by subtle differences in semantics. (Like: does write imply read? Are events disarmed while running? What about errors?)<p>If the lib and event loop are reasonably popular, someone else probably has integrated them before. Or the lib supports the event loop natively (or uses libverto.) Either saves you some trouble.<p>Also: please add libverto support for your event loop :)
<a href="https:&#x2F;&#x2F;github.com&#x2F;latchset&#x2F;libverto">https:&#x2F;&#x2F;github.com&#x2F;latchset&#x2F;libverto</a></div><br/></div></div><div id="40069796" class="c"><input type="checkbox" id="c-40069796" checked=""/><div class="controls bullet"><span class="by">hinkley</span><span>|</span><a href="#40070097">prev</a><span>|</span><a href="#40068090">next</a><span>|</span><label class="collapse" for="c-40069796">[-]</label><label class="expand" for="c-40069796">[1 more]</label></div><br/><div class="children"><div class="content">I was going to say, &quot;I wonder if Bun.js would&#x2F;could use this&quot; but it looks like Jarred Sumner has been cherry-picking bits of libxev for at least six months.</div><br/></div></div><div id="40068090" class="c"><input type="checkbox" id="c-40068090" checked=""/><div class="controls bullet"><span class="by">jpgvm</span><span>|</span><a href="#40069796">prev</a><span>|</span><a href="#40068292">next</a><span>|</span><label class="collapse" for="c-40068090">[-]</label><label class="expand" for="c-40068090">[1 more]</label></div><br/><div class="children"><div class="content">Completion based cross-platform I&#x2F;O? Sign me up.</div><br/></div></div><div id="40068292" class="c"><input type="checkbox" id="c-40068292" checked=""/><div class="controls bullet"><span class="by">dsp_person</span><span>|</span><a href="#40068090">prev</a><span>|</span><a href="#40068333">next</a><span>|</span><label class="collapse" for="c-40068292">[-]</label><label class="expand" for="c-40068292">[1 more]</label></div><br/><div class="children"><div class="content">Can this be used to make something that feels like Qt&#x27;s signals and slots?</div><br/></div></div><div id="40068333" class="c"><input type="checkbox" id="c-40068333" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#40068292">prev</a><span>|</span><a href="#40069295">next</a><span>|</span><label class="collapse" for="c-40068333">[-]</label><label class="expand" for="c-40068333">[3 more]</label></div><br/><div class="children"><div class="content">on MacOS are kqueue and libdispatch&#x2F;grand central dispatch doing different things?</div><br/><div id="40069918" class="c"><input type="checkbox" id="c-40069918" checked=""/><div class="controls bullet"><span class="by">0x457</span><span>|</span><a href="#40068333">parent</a><span>|</span><a href="#40069295">next</a><span>|</span><label class="collapse" for="c-40069918">[-]</label><label class="expand" for="c-40069918">[2 more]</label></div><br/><div class="children"><div class="content">libdispatch&#x2F;GCD is a task scheduler built on top of kqueue. It&#x27;s meant for moving things away from the main UI thread without thinking how often you do that.</div><br/><div id="40070230" class="c"><input type="checkbox" id="c-40070230" checked=""/><div class="controls bullet"><span class="by">gigatexal</span><span>|</span><a href="#40068333">root</a><span>|</span><a href="#40069918">parent</a><span>|</span><a href="#40069295">next</a><span>|</span><label class="collapse" for="c-40070230">[-]</label><label class="expand" for="c-40070230">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for clarifying!</div><br/></div></div></div></div></div></div><div id="40069295" class="c"><input type="checkbox" id="c-40069295" checked=""/><div class="controls bullet"><span class="by">jauntywundrkind</span><span>|</span><a href="#40068333">prev</a><span>|</span><a href="#40067662">next</a><span>|</span><label class="collapse" for="c-40069295">[-]</label><label class="expand" for="c-40069295">[1 more]</label></div><br/><div class="children"><div class="content">io_uring support is obviously great &amp; excellent, fulfills the &quot;high performance&quot; part well. brought an immediately smile to my face.<p>i was <i>not</i> expecting &quot;Wasm + WASI&quot; support at all. that&#x27;s very cool. implementation is wasi_poll.zig (<a href="https:&#x2F;&#x2F;github.com&#x2F;mitchellh&#x2F;libxev&#x2F;blob&#x2F;main&#x2F;src&#x2F;backend&#x2F;wasi_poll.zig">https:&#x2F;&#x2F;github.com&#x2F;mitchellh&#x2F;libxev&#x2F;blob&#x2F;main&#x2F;src&#x2F;backend&#x2F;wa...</a>). not to be unkind, but this makes me wonder very much if WASI is already missing the mark, if polling is the solution offered.<p>gotta say, this is some very understandable clean code. further enhancing my sense that i really ought be playing with zig.</div><br/></div></div></div></div></div></div></div></body></html>