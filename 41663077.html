<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1727427659444" as="style"/><link rel="stylesheet" href="styles.css?v=1727427659444"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://allthingsopen.org/articles/noisy-zfs-disks">Why are my ZFS disks so noisy?</a> <span class="domain">(<a href="https://allthingsopen.org">allthingsopen.org</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>21 comments</span></div><br/><div><div id="41667593" class="c"><input type="checkbox" id="c-41667593" checked=""/><div class="controls bullet"><span class="by">paol</span><span>|</span><a href="#41666870">next</a><span>|</span><label class="collapse" for="c-41667593">[-]</label><label class="expand" for="c-41667593">[4 more]</label></div><br/><div class="children"><div class="content">I know the article is just using the noise thing as an excuse to deep dive into zfs and proxmox, which is cool, but if what you really care about is reducing noise I thought I&#x27;d leave some practical advice here:<p>1. Most hard drive noise is caused by mechanical vibrations being transmitted to the chassis the drive is mounted on.<p>2. Consequently the most effective way to reduce noise is to reduce the mechanical coupling in the drive mounting mechanism. Having the drives in a noise-isolating case is helpful too, but only as a secondary improvement. Optimizing the drive mounting should really be the first priority.<p>3. If space isn&#x27;t a concern the optimal thing is to have a large case (like an ATX or larger) with a large number of HDD bays. The mounting should use soft rubber or silicon grommets. Some mounting systems can work with just the grommets, but systems that use screws are ok too as long as the screw couples to the grommet not the chassis. In a good case like this any number of hard drives can be made essentially inaudible.<p>4. If space is a concern, a special purpose &quot;NAS like&quot; case (example: the Jonsbo N line of cases) can approach the size of consumer NAS boxes. The lack of space makes optimal accoustics difficult, but it will still be a 10x improvement over typical consumers NASes.<p>5. Lastly what you <i>shouldn&#x27;t</i> ever do is get one of those consumers NAS boxes. They are made with no concern for noise at all, and manufacturing cheapness constraints tend to make them literally pessimal at it. I had a QNAP I got rid of that couldn&#x27;t have been more effective at amplifying drive noise if it had been designed for that on purpose.</div><br/><div id="41667659" class="c"><input type="checkbox" id="c-41667659" checked=""/><div class="controls bullet"><span class="by">cjs_ac</span><span>|</span><a href="#41667593">parent</a><span>|</span><a href="#41667648">next</a><span>|</span><label class="collapse" for="c-41667659">[-]</label><label class="expand" for="c-41667659">[1 more]</label></div><br/><div class="children"><div class="content">To add to this, I mounted an HDD to a case using motherboard standoffs in a place that was obviously intended for SSDs. Not only was it very loud, the resonance between the disk and the case also broke the disk after six months.</div><br/></div></div><div id="41667648" class="c"><input type="checkbox" id="c-41667648" checked=""/><div class="controls bullet"><span class="by">naming_the_user</span><span>|</span><a href="#41667593">parent</a><span>|</span><a href="#41667659">prev</a><span>|</span><a href="#41666870">next</a><span>|</span><label class="collapse" for="c-41667648">[-]</label><label class="expand" for="c-41667648">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, the article title seemed kind of weird to me. I have a ZFS NAS, it&#x27;s just a bunch of drives in an ATX case with (what I&#x27;d considered to nowadays be) the standard rubber grommets.<p>I mean, you can hear it, but it&#x27;s mostly just the fans and drives spinning, it&#x27;s not loud at all.<p>The recommendations seem reasonable but for noise? If it&#x27;s noisy probably something is wrong I think.</div><br/><div id="41667807" class="c"><input type="checkbox" id="c-41667807" checked=""/><div class="controls bullet"><span class="by">nicolaslem</span><span>|</span><a href="#41667593">root</a><span>|</span><a href="#41667648">parent</a><span>|</span><a href="#41666870">next</a><span>|</span><label class="collapse" for="c-41667807">[-]</label><label class="expand" for="c-41667807">[1 more]</label></div><br/><div class="children"><div class="content">I totally understand the article title, I have a ZFS NAS that makes the same kind of noise as described there. Roughly every five seconds the drives make sound that is different from the background hum of a running computer. In a calm environment this is very distracting. I even had a guest sleeping in an adjacent room complain about it once.</div><br/></div></div></div></div></div></div><div id="41666870" class="c"><input type="checkbox" id="c-41666870" checked=""/><div class="controls bullet"><span class="by">hamandcheese</span><span>|</span><a href="#41667593">prev</a><span>|</span><a href="#41667596">next</a><span>|</span><label class="collapse" for="c-41666870">[-]</label><label class="expand" for="c-41666870">[13 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t know if this exists or not, but I&#x27;d like to try something like a fuse filesystem which can transparently copy a file to a fast scratch SSD when it is first accessed.<p>I have a somewhat large zfs array and it makes consistent noise as I stream videos from it. The streaming is basically a steady trickle compared to what the array is capable of. I&#x27;d rather incur all the noise up front, as fast as possible, then continue the stream from a silent SSD.</div><br/><div id="41667103" class="c"><input type="checkbox" id="c-41667103" checked=""/><div class="controls bullet"><span class="by">Mayzie</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667058">next</a><span>|</span><label class="collapse" for="c-41667103">[-]</label><label class="expand" for="c-41667103">[2 more]</label></div><br/><div class="children"><div class="content">&gt; I don&#x27;t know if this exists or not, but I&#x27;d like to try something like a fuse filesystem which can transparently copy a file to a fast scratch SSD when it is first accessed.<p>You may be interested in checking out bcache[1] or bcachefs[2].<p>[1] <a href="https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;latest&#x2F;admin-guide&#x2F;bcache.html" rel="nofollow">https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;latest&#x2F;admin-guide&#x2F;bcache.ht...</a><p>[2] <a href="https:&#x2F;&#x2F;bcachefs.org&#x2F;" rel="nofollow">https:&#x2F;&#x2F;bcachefs.org&#x2F;</a></div><br/><div id="41667205" class="c"><input type="checkbox" id="c-41667205" checked=""/><div class="controls bullet"><span class="by">theblazehen</span><span>|</span><a href="#41666870">root</a><span>|</span><a href="#41667103">parent</a><span>|</span><a href="#41667058">next</a><span>|</span><label class="collapse" for="c-41667205">[-]</label><label class="expand" for="c-41667205">[1 more]</label></div><br/><div class="children"><div class="content">lvm-cache works as well, if you&#x27;re already using LVM.<p><a href="https:&#x2F;&#x2F;github.com&#x2F;45Drives&#x2F;autotier">https:&#x2F;&#x2F;github.com&#x2F;45Drives&#x2F;autotier</a> is exactly what they were asking for as well</div><br/></div></div></div></div><div id="41667058" class="c"><input type="checkbox" id="c-41667058" checked=""/><div class="controls bullet"><span class="by">3np</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667103">prev</a><span>|</span><a href="#41667773">next</a><span>|</span><label class="collapse" for="c-41667058">[-]</label><label class="expand" for="c-41667058">[1 more]</label></div><br/><div class="children"><div class="content">It may not be 100% what you&#x27;re looking for and will probably not make your drives <i>silent</i> while streaming  but putting L2ARC on that SSD and tweaking prefetch might get you a good way there.<p>Another much simpler filesystem-agnostic alternative would be to copy it over to the SSD with a script and commence streaming from there. You&#x27;ll have to wait for the entire file to copy for the stream to start, though. I think some streaming servers may actually support this natively if you mount &#x2F;var and&#x2F;or &#x2F;var&#x2F;tmp on the faster drive and configure it to utilize it as a &quot;cache&quot;.</div><br/></div></div><div id="41667773" class="c"><input type="checkbox" id="c-41667773" checked=""/><div class="controls bullet"><span class="by">anotherhue</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667058">prev</a><span>|</span><a href="#41667029">next</a><span>|</span><label class="collapse" for="c-41667773">[-]</label><label class="expand" for="c-41667773">[1 more]</label></div><br/><div class="children"><div class="content">mpv has --cache-size (or something) that you can set at a few GB. If you run out of ram it should swap to your ssd.<p>Edit: demuxer-max-bytes=2147483647</div><br/></div></div><div id="41667029" class="c"><input type="checkbox" id="c-41667029" checked=""/><div class="controls bullet"><span class="by">spockz</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667773">prev</a><span>|</span><a href="#41666976">next</a><span>|</span><label class="collapse" for="c-41667029">[-]</label><label class="expand" for="c-41667029">[1 more]</label></div><br/><div class="children"><div class="content">Just to test whether your OS setup etc is already up to par, try reading the whole file, eg by calculating the hash with something like `md5` (yes md5 is not secure I know.). This should put the file mostly in the os cache. But with video files being able to hit more than 50GiB in size these days, you need quite a lot of RAM to keep it all in cache.
Maybe you can setting the SSD as a scratch disk for swap? I’m not sure how&#x2F;if you can tweak what it is used for.<p>As a sibling says, ZFS should support this pretty transparently.</div><br/></div></div><div id="41666976" class="c"><input type="checkbox" id="c-41666976" checked=""/><div class="controls bullet"><span class="by">toast0</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667029">prev</a><span>|</span><a href="#41667233">next</a><span>|</span><label class="collapse" for="c-41666976">[-]</label><label class="expand" for="c-41666976">[2 more]</label></div><br/><div class="children"><div class="content">If you&#x27;ve got enough ram, you might be able to tune prefetching to prefetch the whole file? Although, I&#x27;m not sure how tunable that actually is.</div><br/><div id="41667166" class="c"><input type="checkbox" id="c-41667166" checked=""/><div class="controls bullet"><span class="by">iforgotpassword</span><span>|</span><a href="#41666870">root</a><span>|</span><a href="#41666976">parent</a><span>|</span><a href="#41667233">next</a><span>|</span><label class="collapse" for="c-41667166">[-]</label><label class="expand" for="c-41667166">[1 more]</label></div><br/><div class="children"><div class="content">Yes, I think nowadays you do this with<p><pre><code>  blockdev --setra &lt;num_sectors&gt; &#x2F;dev&#x2F;sdX
</code></pre>
But I feel like there was a sysctl for this too in the past. I used it back in the day to make the HDD in my laptop spin down immediately after a new song started playing in rhythmbox by setting it to 16MB.</div><br/></div></div></div></div><div id="41667233" class="c"><input type="checkbox" id="c-41667233" checked=""/><div class="controls bullet"><span class="by">dialup_sounds</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41666976">prev</a><span>|</span><a href="#41666993">next</a><span>|</span><label class="collapse" for="c-41667233">[-]</label><label class="expand" for="c-41667233">[1 more]</label></div><br/><div class="children"><div class="content">Reminded of this -- ZFS on Apple&#x27;s Fusion Drive<p><a href="http:&#x2F;&#x2F;jolly.jinx.de&#x2F;teclog&#x2F;2012.10.31.02-fusion-drive-loose-ends.html" rel="nofollow">http:&#x2F;&#x2F;jolly.jinx.de&#x2F;teclog&#x2F;2012.10.31.02-fusion-drive-loose...</a></div><br/></div></div><div id="41666993" class="c"><input type="checkbox" id="c-41666993" checked=""/><div class="controls bullet"><span class="by">hnlmorg</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667233">prev</a><span>|</span><a href="#41667185">next</a><span>|</span><label class="collapse" for="c-41666993">[-]</label><label class="expand" for="c-41666993">[1 more]</label></div><br/><div class="children"><div class="content">Not aware of anything that directly matches your description, however all major operating systems do cache filesystem object in RAM. So if you pre-read the file, then it should be read back from cache when you come to stream it.<p>Additionally, ZFS supports using SSDs to supplement the cache.</div><br/></div></div><div id="41667185" class="c"><input type="checkbox" id="c-41667185" checked=""/><div class="controls bullet"><span class="by">naming_the_user</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41666993">prev</a><span>|</span><a href="#41667662">next</a><span>|</span><label class="collapse" for="c-41667185">[-]</label><label class="expand" for="c-41667185">[2 more]</label></div><br/><div class="children"><div class="content">Depending on the file-size I wonder if it&#x27;d be better to just prefetch the entire file into RAM.</div><br/><div id="41667226" class="c"><input type="checkbox" id="c-41667226" checked=""/><div class="controls bullet"><span class="by">fsckboy</span><span>|</span><a href="#41666870">root</a><span>|</span><a href="#41667185">parent</a><span>|</span><a href="#41667662">next</a><span>|</span><label class="collapse" for="c-41667226">[-]</label><label class="expand" for="c-41667226">[1 more]</label></div><br/><div class="children"><div class="content">good idea, but that&#x27;s not his problem. he needs a media player that will sprint through to the end of the file when he first opens it. They don&#x27;t do that cuz they figure they might be streaming from the net so why tax <i>that</i> part of the sytem.</div><br/></div></div></div></div><div id="41667662" class="c"><input type="checkbox" id="c-41667662" checked=""/><div class="controls bullet"><span class="by">nicman23</span><span>|</span><a href="#41666870">parent</a><span>|</span><a href="#41667185">prev</a><span>|</span><a href="#41667596">next</a><span>|</span><label class="collapse" for="c-41667662">[-]</label><label class="expand" for="c-41667662">[1 more]</label></div><br/><div class="children"><div class="content">i mean you can do that with a simple wrapper<p>have a ssd ie mounted in &#x2F;tmp&#x2F;movies<p>and create a script in .bin&#x2F; (or whatever)<p>#!&#x2F;bin&#x2F;sh<p>tmp_m=&quot;&#x2F;tmp&#x2F;movies&#x2F;$(mktemp -d)&quot;<p>cp &quot;$@&quot; $tmp_m<p>mpv $tmp_m<p>rm $tmp_m<p>please note i have not tried the script but it probably works</div><br/></div></div></div></div><div id="41667364" class="c"><input type="checkbox" id="c-41667364" checked=""/><div class="controls bullet"><span class="by">Maledictus</span><span>|</span><a href="#41667596">prev</a><span>|</span><label class="collapse" for="c-41667364">[-]</label><label class="expand" for="c-41667364">[2 more]</label></div><br/><div class="children"><div class="content">I expected a way to find out what the heck the system is sending to those disks.
Like per process and what the the Kernel&#x2F;ZFS is adding.</div><br/><div id="41667527" class="c"><input type="checkbox" id="c-41667527" checked=""/><div class="controls bullet"><span class="by">M95D</span><span>|</span><a href="#41667364">parent</a><span>|</span><label class="collapse" for="c-41667527">[-]</label><label class="expand" for="c-41667527">[1 more]</label></div><br/><div class="children"><div class="content">It can be done with CONFIG_DM_LOG_WRITES and another set of drives, but AFAIK, it needs to be set up before (or more exactly <i>under</i>) zfs.</div><br/></div></div></div></div></div></div></div></div></div></body></html>